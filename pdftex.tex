\pdfmapline{cmr10    TeXGyrePagella-Regular   "encqcs     ReEncodeFont    "   < my-q-cs.enc   <qplr.pfb}
\pdfmapline{logo10   Logo10   <   logo10.pfb}
\pdfmapline{cmtex10  CMTEX10  <   cmtex10.pfb}
\pdfmapline{cmr9     CMR9     <   cmr9.pfb}
\pdfmapline{cmtt10   CMTT10   <   cmtt10.pfb}
\pdfmapline{cmex10   GCMEX10   <   cmex10.pfb}
\pdfmapline{cmmi7    GCMMI7    <   cmmi7.pfb}
\pdfmapline{cmsy7    GCMSY7    <   cmsy7.pfb}
\pdfmapline{cmr7     GCMR7     <   cmr7.pfb}
\pdfmapline{cmmi10   GCMMI10   <   cmmi10.pfb}
\pdfmapline{cmti10   GCMTI10   <   cmti10.pfb}
\pdfmapline{cmsl10   GCMSL10   <   cmsl10.pfb}
\pdfmapline{cmbx10   GCMBX10   <   cmbx10.pfb}
\pdfmapline{cmr8     GCMR8     <   cmr8.pfb}
\pdfmapline{cmsy10   GCMSY10   <   cmsy10.pfb}
\pdfmapline{xbmc10   XBMC10    <   xbmc10.pfb}


\input pdfwebmac


% Copyright 1996-2024 Han Th\^e\llap{\raise 0.5ex\hbox{\'{}}} Th\`anh,
% <thanh@pdftex.org>

% This file is part of pdfTeX.

% pdfTeX is free software; you can redistribute it and/or modify it under the
% terms of the GNU General Public License as published by the Free Software
% Foundation; either version 2 of the License, or (at your option) any later
% version.

% pdfTeX is distributed in the hope that it will be useful, but WITHOUT ANY
% WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
% A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

% You should have received a copy of the GNU General Public License along with
% this program.  If not, see <http://www.gnu.org/licenses/>.

% e-TeX is copyright (C) 1999-2015 by P. Breitenlohner (1994,98 by the NTS
% team); all rights are reserved. Copying of this file is authorized only if
% (1) you are P. Breitenlohner, or if (2) you make absolutely no changes to
% your copy. (Programs such as TIE allow the application of several change
% files to tex.web; the master files tex.web and etex.ch should stay intact.)

% See etex_gen.tex for hints on how to install this program.
% And see etripman.tex for details about how to validate it.

% This program is directly derived from Donald E. Knuth's TeX;
% the change history which follows and the reward offered for finders of
% bugs refer specifically to TeX; they should not be taken as referring
% to e-TeX, although the change history is relevant in that it
% demonstrates the evolutionary path followed.  This program is not TeX;
% that name is reserved strictly for the program which is the creation
% and sole responsibility of Professor Knuth.

% Version 0 was released in September 1982 after it passed a variety of tests.
% Version 1 was released in November 1983 after thorough testing.
% Version 1.1 fixed ``disappearing font identifiers'' et alia (July 1984).
% Version 1.2 allowed `0' in response to an error, et alia (October 1984).
% Version 1.3 made memory allocation more flexible and local (November 1984).
% Version 1.4 fixed accents right after line breaks, et alia (April 1985).
% Version 1.5 fixed \the\toks after other expansion in \edefs (August 1985).
% Version 2.0 (almost identical to 1.5) corresponds to "Volume B" (April 1986).
% Version 2.1 corrected anomalies in discretionary breaks (January 1987).
% Version 2.2 corrected "(Please type...)" with null \endlinechar (April 1987).
% Version 2.3 avoided incomplete page in premature termination (August 1987).
% Version 2.4 fixed \noaligned rules in indented displays (August 1987).
% Version 2.5 saved cur_order when expanding tokens (September 1987).
% Version 2.6 added 10sp slop when shipping leaders (November 1987).
% Version 2.7 improved rounding of negative-width characters (November 1987).
% Version 2.8 fixed weird bug if no \patterns are used (December 1987).
% Version 2.9 made \csname\endcsname's "relax" local (December 1987).
% Version 2.91 fixed \outer\def\a0{}\a\a bug (April 1988).
% Version 2.92 fixed \patterns, also file names with complex macros (May 1988).
% Version 2.93 fixed negative halving in allocator when mem_min<0 (June 1988).
% Version 2.94 kept open_log_file from calling fatal_error (November 1988).
% Version 2.95 solved that problem a better way (December 1988).
% Version 2.96 corrected bug in "Infinite shrinkage" recovery (January 1989).
% Version 2.97 corrected blunder in creating 2.95 (February 1989).
% Version 2.98 omitted save_for_after at outer level (March 1989).
% Version 2.99 caught $$\begingroup\halign..$$ (June 1989).
% Version 2.991 caught .5\ifdim.6... (June 1989).
% Version 2.992 introduced major changes for 8-bit extensions (September 1989).
% Version 2.993 fixed a save_stack synchronization bug et alia (December 1989).
% Version 3.0 fixed unusual displays; was more \output robust (March 1990).
% Version 3.1 fixed nullfont, disabled \write{\the\prevgraf} (September 1990).
% Version 3.14 fixed unprintable font names and corrected typos (March 1991).
% Version 3.141 more of same; reconstituted ligatures better (March 1992).
% Version 3.1415 preserved nonexplicit kerns, tidied up (February 1993).
% Version 3.14159 allowed fontmemsize to change; bulletproofing (March 1995).
% Version 3.141592 fixed \xleaders, glueset, weird alignments (December 2002).
% Version 3.1415926 was a general cleanup with minor fixes (February 2008).
% Version 3.14159265 was similar (January 2014).
% Version 3.141592653 was similar but more extensive (January 2021).

% A preliminary version of TeX--XeT was released in April 1992.
% TeX--XeT version 1.0 was released in June 1992,
%   version 1.1 prevented arith overflow in glue computation (Oct 1992).
% A preliminary e-TeX version 0.95 was operational in March 1994.
% Version 1.0beta was released in May 1995.
% Version 1.01beta fixed bugs in just_copy and every_eof (December 1995).
% Version 1.02beta allowed 256 mark classes (March 1996).
% Version 1.1 changed \group{type,level} -> \currentgroup{type,level},
%             first public release (October 1996).
% Version 2.0 development was started in March 1997;
%             fixed a ligature-\beginR bug in January 1998;
%             was released in March 1998.
% Version 2.1 fixed a \marks bug (when min_halfword<>0) (January 1999).
% Version 2.2 development was started in Feb 2003; released in Oct 2004.
%             fixed a bug in sparse array handling (0=>null), Jun 2002;
%             fixed a bug in \lastnodetype (cur_val=>cur_val_level)
%                 reported by Hartmut Henkel <hartmut_henkel@gmx.de>,
%                 fix by Fabrice Popineau <Fabrice.Popineau@supelec.fr>,
%                 Jan 2004;
%             another bug in sparse array handling (cur_ptr=>cur_chr)
%                 reported by Taco Hoekwater <taco@elvenkind.com>, Jul 2004;
%             fixed a sparse array reference count bug (\let,\futurelet),
%                 fix by Bernd Raichle <berd@dante.de>, Aug 2004;
%             reorganized handling of banner, additional token list and
%                 integer parameters, and similar in order to reduce the
%                 interference between eTeX, pdfTeX, and web2c change files.
%             adapted to tex.web 3.141592, revised glue rounding for mixed
%                 direction typesetting;
%             fixed a bug in the revised glue rounding code, detected by
%                 Tigran Aivazian <tigran@aivazian.fsnet.co.uk>, Oct 2004.
% Version 2.3 development was started in Feb 2008; released in Apr 2011.
%             fixed a bug in hyph_code handling (\savinghyphcodes)
%                 reported by Vladimir Volovich <vvv@vsu.ru>, Feb 2008.
%             fixed the error messages for improper use of \protected,
%                 reported by Heiko Oberdiek
%                 <heiko.oberdiek@googlemail.com>, May 2010.
%             some rearrangements to reduce interferences between
%                 e-TeX and pTeX, in part suggested by Hironori Kitagawa
%                 <h_kitagawa2001@yahoo.co.jp>, Mar 2011.
% Version 2.4 fixed an uninitialized line number bug, released in May 2012.
% Version 2.5 development was started in Aug 2012; released in Feb 2013.
%             better tracing of font definitions, reported by
%                 Bruno Le Floch <blflatex@gmail.com>, Jul 2012.
% Version 2.6 development was started in Mar 2013; released in ??? 201?.
%             enable hyphenation of text between \beginL and \endL or
%                 between \beginR and \endR, problem reported by
%                 Vafa Khalighi <vafalgk@gmail.com>, Nov 2013.
%             better handling of right-to-left text -- to be done.

% Although considerable effort has been expended to make the e-TeX program
% correct and reliable, no warranty is implied; the author disclaims any
% obligation or liability for damages, including but not limited to
% special, indirect, or consequential damages arising out of or in
% connection with the use or performance of this software. This work has
% been a ``labor of love'' and the author hopes that users enjoy it.

% Here is TeX material that gets inserted after \input webmac
\def\hang{\hangindent 3em\noindent\ignorespaces}
\def\hangg#1 {\hang\hbox{#1 }}
\def\textindent#1{\hangindent2.5em\noindent\hbox to2.5em{\hss#1 }\ignorespaces}
\font\ninerm=cmr9
\let\mc=\ninerm % medium caps for names like SAIL
\def\eTeX{$\varepsilon$-\TeX}
\font\revrm=xbmc10 % for right-to-left text
% to generate xbmc10 (i.e., reflected cmbx10) use a file
% xbmc10.mf containing:
%+++++++++++++++++++++++++++++++++++++++++++++++++
%     if unknown cmbase: input cmbase fi
%     extra_endchar := extra_endchar &
%       "currentpicture:=currentpicture " &
%       "reflectedabout((.5[l,r],0),(.5[l,r],1));";
%     input cmbx10
%+++++++++++++++++++++++++++++++++++++++++++++++++
\ifx\beginL\undefined % this is TeX
  \def\XeT{X\kern-.125em\lower.5ex\hbox{E}\kern-.1667emT}
  \def\TeXeT{\TeX-\hbox{\revrm \XeT}}   % for TeX-XeT
  \def\TeXXeT{\TeX-\hbox{\revrm -\XeT}} % for TeX--XeT
\else
  \ifx\eTeXversion\undefined % this is \TeXeT
    \def\TeXeT{\TeX-{\revrm\beginR\TeX\endR}}   % for TeX-XeT
    \def\TeXXeT{\TeX-{\revrm\beginR\TeX-\endR}} % for TeX--XeT
  \else % this is \eTeX
    \def\TeXeT{\TeX-{\TeXXeTstate=1\revrm\beginR\TeX\endR}}   % for TeX-XeT
    \def\TeXXeT{\TeX-{\TeXXeTstate=1\revrm\beginR\TeX-\endR}} % for TeX--XeT
  \fi
\fi
\def\PASCAL{Pascal}
\def\pdfTeX{pdf\TeX}
\def\pdfeTeX{pdf\eTeX}
\def\PDF{PDF}
\def\ph{\hbox{Pascal-H}}
\def\pct!{{\char`\%}} % percent sign in ordinary text
\def\grp{\.{\char'173...\char'175}}
\font\logo=logo10 % font used for the METAFONT logo
\def\MF{{\logo META}\-{\logo FONT}}
\def\<#1>{$\langle#1\rangle$}
\def\section{\mathhexbox278}

\def\(#1){} % this is used to make section names sort themselves better
\def\9#1{} % this is used for sort keys in the index via @:sort key}{entry@>

\outer\def\N#1. \[#2]#3.{\MN#1.\vfil\eject % begin starred section
  \def\rhead{PART #2:\uppercase{#3}} % define running headline
  \message{*\modno} % progress report
  \edef\next{\write\cont{\Z{\?#2]#3}{\modno}{\the\pageno}}}\next
  \ifon\startsection{\bf\ignorespaces#3.\quad}\ignorespaces}
\let\?=\relax % we want to be able to \write a \?

\def\title{\pdfTeX}
% system dependent redefinitions of \title should come later
% and should use:
%    \toks0=\expandafter{\title}
%    \edef\title{...\the\toks0...}
\let\maybe=\iftrue % print only changed modules
\def\topofcontents{\hsize 5.5in
  \vglue 0pt plus 1fil minus 1.5in
  \def\?##1]{\hbox to 1in{\hfil##1.\ }}
  }
\def\botofcontents{\vskip 0pt plus 1fil minus 1.5in}
\pageno=3
\def\glob{13} % this should be the section number of "<Global...>"
\def\gglob{20, 26} % this should be the next two sections of "<Global...>"


\N1.  \[1] Introduction.
This is \eTeX, a program derived from and extending the capabilities of
\TeX, a document compiler intended to produce typesetting of high
quality.
The \PASCAL\ program that follows is the definition of \TeX82, a standard
version of \TeX\ that is designed to be highly portable so that identical
output
will be obtainable on a great variety of computers.

The main purpose of the following program is to explain the algorithms of \TeX\
as clearly as possible. As a result, the program will not necessarily be very
efficient when a particular \PASCAL\ compiler has translated it into a
particular machine language. However, the program has been written so that it
can be tuned to run efficiently in a wide variety of operating environments
by making comparatively few changes. Such flexibility is possible because
the documentation that follows is written in the \.{WEB} language, which is
at a higher level than \PASCAL; the preprocessing step that converts \.{WEB}
to \PASCAL\ is able to introduce most of the necessary refinements.
Semi-automatic translation to other languages is also feasible, because the
program below does not make extensive use of features that are peculiar to
\PASCAL.

A large piece of software like \TeX\ has inherent complexity that cannot
be reduced below a certain level of difficulty, although each individual
part is fairly simple by itself. The \.{WEB} language is intended to make
the algorithms as readable as possible, by reflecting the way the
individual program pieces fit together and by providing the
cross-references that connect different parts. Detailed comments about
what is going on, and about why things were done in certain ways, have
been liberally sprinkled throughout the program.  These comments explain
features of the implementation, but they rarely attempt to explain the
\TeX\ language itself, since the reader is supposed to be familiar with
{\sl The \TeX book}.

\fi

\M2. The present implementation has a long ancestry, beginning in the summer
of~1977, when Michael~F. Plass and Frank~M. Liang designed and coded
a prototype
based on some specifications that the author had made in May of that year.
This original proto\TeX\ included macro definitions and elementary
manipulations on boxes and glue, but it did not have line-breaking,
page-breaking, mathematical formulas, alignment routines, error recovery,
or the present semantic nest; furthermore,
it used character lists instead of token lists, so that a control sequence
like \.{\\halign} was represented by a list of seven characters. A
complete version of \TeX\ was designed and coded by the author in late
1977 and early 1978; that program, like its prototype, was written in the
{\mc SAIL} language, for which an excellent debugging system was
available. Preliminary plans to convert the {\mc SAIL} code into a form
somewhat like the present ``web'' were developed by Luis Trabb~Pardo and
the author at the beginning of 1979, and a complete implementation was
created by Ignacio~A. Zabala in 1979 and 1980. The \TeX82 program, which
was written by the author during the latter part of 1981 and the early
part of 1982, also incorporates ideas from the 1979 implementation of
\TeX\ in {\mc MESA} that was written by Leonidas Guibas, Robert Sedgewick,
and Douglas Wyatt at the Xerox Palo Alto Research Center.  Several hundred
refinements were introduced into \TeX82 based on the experiences gained with
the original implementations, so that essentially every part of the system
has been substantially improved. After the appearance of ``Version 0'' in
September 1982, this program benefited greatly from the comments of
many other people, notably David~R. Fuchs and Howard~W. Trickey.
A final revision in September 1989 extended the input character set to
eight-bit codes and introduced the ability to hyphenate words from
different languages, based on some ideas of Michael~J. Ferguson.

No doubt there still is plenty of room for improvement, but the author
is firmly committed to keeping \TeX82 ``frozen'' from now on; stability
and reliability are to be its main virtues.

On the other hand, the \.{WEB} description can be extended without changing
the core of \TeX82 itself, and the program has been designed so that such
extensions are not extremely difficult to make.
The \\{banner} string defined here should be changed whenever \TeX\
undergoes any modifications, so that it will be clear which version of
\TeX\ might be the guilty party when a problem arises.

This program contains code for various features extending \TeX,
therefore this program is called `\eTeX' and not
`\TeX'; the official name `\TeX' by itself is reserved
for software systems that are fully compatible with each other.
A special test suite called the ``\.{TRIP} test'' is available for
helping to determine whether a particular implementation deserves to be
known as `\TeX' [cf.~Stanford Computer Science report CS1027,
November 1984].

A similar test suite called the ``\.{e-TRIP} test'' is available for
helping to determine whether a particular implementation deserves to be
known as `\eTeX'.

\Y\P\D \37$\\{eTeX\_version}=2$\C{ \.{\\eTeXversion} }\par
\P\D \37$\\{eTeX\_revision}\S\.{".6"}$\C{ \.{\\eTeXrevision} }\par
\P\D \37$\\{eTeX\_version\_string}\S\.{\'-2.6\'}$\C{current \eTeX\ version}\Y%
\par
\P\D \37$\\{eTeX\_banner}\S\.{\'This\ is\ e-TeX,\ Version\ 3.141592653\'},\39%
\\{eTeX\_version\_string}$\C{printed when \eTeX\ starts}\Y\par
\P\D \37$\\{pdftex\_version}\S140$\C{ \.{\\pdftexversion} }\par
\P\D \37$\\{pdftex\_revision}\S\.{"26"}$\C{ \.{\\pdftexrevision} }\par
\P\D \37$\\{pdftex\_version\_string}\S\.{\'-1.40.26\'}$\C{current \pdfTeX\
version}\Y\par
\P\D \37$\\{pdfTeX\_banner}\S\.{\'This\ is\ pdfTeX,\ Version\ 3.141592653\'},%
\39\\{eTeX\_version\_string},\39\\{pdftex\_version\_string}$\C{printed when %
\pdfTeX\ starts}\Y\par
\P\D \37$\\{TeX\_banner}\S\.{\'This\ is\ TeX,\ Version\ 3.141592653\'}$%
\C{printed when \TeX\ starts}\Y\par
\P\D \37$\\{banner}\S\\{pdfTeX\_banner}$\Y\par
\P\D \37$\\{TEX}\S\\{PDFTEX}$\C{change program name into \\{PDFTEX}}\Y\par
\P\D \37$\\{TeXXeT\_code}=0$\C{the \TeXXeT\ feature is optional}\Y\par
\P\D \37$\\{eTeX\_states}=1$\C{number of \eTeX\ state variables in \\{eqtb}}\par
\fi

\M3. Different \PASCAL s have slightly different conventions, and the present
program expresses \TeX\ in terms of the \PASCAL\ that was
available to the author in 1982. Constructions that apply to
this particular compiler, which we shall call \ph, should help the
reader see how to make an appropriate interface for other systems
if necessary. (\ph\ is Charles Hedrick's modification of a compiler
for the DECsystem-10 that was originally developed at the University of
Hamburg; cf.\ {\sl Software---Practice and Experience \bf6} (1976),
29--42. The \TeX\ program below is intended to be adaptable, without
extensive changes, to most other versions of \PASCAL, so it does not fully
use the admirable features of \ph. Indeed, a conscious effort has been
made here to avoid using several idiosyncratic features of standard
\PASCAL\ itself, so that most of the code can be translated mechanically
into other high-level languages. For example, the `\&{with}' and `\\{new}'
features are not used, nor are pointer types, set types, or enumerated
scalar types; there are no `\&{var}' parameters, except in the case of files
--- \eTeX, however, does use `\&{var}' parameters for the \\{reverse} function;
there are no tag fields on variant records; there are no assignments
$\\{real}\K\\{integer}$; no procedures are declared local to other procedures.)

The portions of this program that involve system-dependent code, where
changes might be necessary because of differences between \PASCAL\ compilers
and/or differences between
operating systems, can be identified by looking at the sections whose
numbers are listed under `system dependencies' in the index. Furthermore,
the index entries for `dirty \PASCAL' list all places where the restrictions
of \PASCAL\ have not been followed perfectly, for one reason or another.

Incidentally, \PASCAL's standard \\{round} function can be problematical,
because it disagrees with the IEEE floating-point standard.
Many implementors have
therefore chosen to substitute their own home-grown rounding procedure.

\fi

\M4. The program begins with a normal \PASCAL\ program heading, whose
components will be filled in later, using the conventions of \.{WEB}.
For example, the portion of the program called `\X\glob:Global
variables\X' below will be replaced by a sequence of variable declarations
that starts in $\section\glob$ of this documentation. In this way, we are able
to define each individual global variable when we are prepared to
understand what it means; we do not have to define all of the globals at
once.  Cross references in $\section\glob$, where it says ``See also
sections \gglob, \dots,'' also make it possible to look at the set of
all global variables, if desired.  Similar remarks apply to the other
portions of the program heading.

Actually the heading shown here is not quite normal: The  \&{program}\   line
does not mention any \\{output} file, because \ph\ would ask the \TeX\ user
to specify a file name if \\{output} were specified here.

\Y\P\D \37$\\{mtype}\S\|t\J\|y\J\|p\J\|e$\C{this is a \.{WEB} coding trick:}\par
\P\F \37$\\{mtype}\S\\{type}$\C{`\&{mtype}' will be equivalent to `\&{type}'}%
\par
\P\F \37$\\{type}\S\\{true}$\C{but `\\{type}' will not be treated as a reserved
word}\par
\Y\P\hbox{\4}\X9:Compiler directives\X\6
\4\&{program}\1\  \37\\{TEX};\C{all file names are defined dynamically}\6
\4\&{label} \37\X6:Labels in the outer block\X\6
\4\&{const} \37\X11:Constants in the outer block\X\6
\4\&{mtype} \37\X18:Types in the outer block\X\6
\4\&{var} \37\X13:Global variables\X\7
\4\&{procedure}\1\  \37\\{initialize};\C{this procedure gets things started
properly}\6
\4\&{var} \37\X19:Local variables for initialization\X\2\6
\&{begin} \37\X8:Initialize whatever \TeX\ might access\X\6
\&{end};\7
\hbox{\4}\X57:Basic printing procedures\X\6
\hbox{\4}\X78:Error handling procedures\X\par
\fi

\M5. The overall \TeX\ program begins with the heading just shown, after which
comes a bunch of procedure declarations and function declarations.
Finally we will get to the main program, which begins with the
comment `\\{start\_here}'. If you want to skip down to the
main program now, you can look up `\\{start\_here}' in the index.
But the author suggests that the best way to understand this program
is to follow pretty much the order of \TeX's components as they appear in the
\.{WEB} description you are now reading, since the present ordering is
intended to combine the advantages of the ``bottom up'' and ``top down''
approaches to the problem of understanding a somewhat complicated system.

\fi

\M6. Three labels must be declared in the main program, so we give them
symbolic names.

\Y\P\D \37$\\{start\_of\_TEX}=1$\C{go here when \TeX's variables are
initialized}\par
\P\D \37$\\{end\_of\_TEX}=9998$\C{go here to close files and terminate
gracefully}\par
\P\D \37$\\{final\_end}=9999$\C{this label marks the ending of the program}\par
\Y\P$\4\X6:Labels in the outer block\X\S$\6
$\\{start\_of\_TEX}\hbox{\hskip-2pt},\39\\{end\_of\_TEX}\hbox{\hskip-2pt},\39\,%
\\{final\_end}$;\C{key control points}\par
\U4.\fi

\M7. Some of the code below is intended to be used only when diagnosing the
strange behavior that sometimes occurs when \TeX\ is being installed or
when system wizards are fooling around with \TeX\ without quite knowing
what they are doing. Such code will not normally be compiled; it is
delimited by the codewords `$ \&{debug} \ldots  \&{gubed} $', with apologies
to people who wish to preserve the purity of English.

Similarly, there is some conditional code delimited by
`$ \&{stat} \ldots  \&{tats} $' that is intended for use when statistics are to
be
kept about \TeX's memory usage.  The  \&{stat}  $\ldots$   \&{tats}  code also
implements diagnostic information for \.{\\tracingparagraphs},
\.{\\tracingpages}, and \.{\\tracingrestores}.

\Y\P\D \37$\\{debug}\S\B$\C{change this to `$\\{debug}\equiv\null$' when
debugging}\par
\P\D \37$\\{gubed}\S\hbox{}\T$\C{change this to `$\\{gubed}\equiv\null$' when
debugging}\par
\P\F \37$\\{debug}\S\\{begin}$\par
\P\F \37$\\{gubed}\S\\{end}$\Y\par
\P\D \37$\\{stat}\S\B$\C{change this to `$\\{stat}\equiv\null$' when gathering
 usage statistics}\par
\P\D \37$\\{tats}\S\hbox{}\T$\C{change this to `$\\{tats}\equiv\null$' when
gathering   usage statistics}\par
\P\F \37$\\{stat}\S\\{begin}$\par
\P\F \37$\\{tats}\S\\{end}$\par
\fi

\M8. This program has two important variations: (1) There is a long and slow
version called \.{INITEX}, which does the extra calculations needed to
initialize \TeX's internal tables; and (2)~there is a shorter and faster
production version, which cuts the initialization to a bare minimum.
Parts of the program that are needed in (1) but not in (2) are delimited by
the codewords `$ \&{init} \ldots  \&{tini} $'.

\Y\P\D \37$\\{init}\S$\C{change this to `$\\{init}\equiv\.{@\{}$' in the
production version}\par
\P\D \37$\\{tini}\S$\C{change this to `$\\{tini}\equiv\.{@\}}$' in the
production version}\par
\P\F \37$\\{init}\S\\{begin}$\par
\P\F \37$\\{tini}\S\\{end}$\par
\Y\P$\4\X8:Initialize whatever \TeX\ might access\X\S$\6
\X21:Set initial values of key variables\X\6
\&{init} \37\X182:Initialize table entries (done by \.{INITEX} only)\X\ %
\&{tini}\par
\U4.\fi

\M9. If the first character of a \PASCAL\ comment is a dollar sign,
\ph\ treats the comment as a list of ``compiler directives'' that will
affect the translation of this program into machine language.  The
directives shown below specify full checking and inclusion of the \PASCAL\
debugger when \TeX\ is being debugged, but they cause range checking and other
redundant code to be eliminated when the production system is being generated.
Arithmetic overflow will be detected in all cases.

\Y\P$\4\X9:Compiler directives\X\S$\6
$\B\J\$\|C-,\39\|A+,\39\|D-\T$\C{no range check, catch arithmetic overflow, no
debug overhead}\6
\&{debug} \37$\B\J\$\|C+,\39\|D+\T$\ \&{gubed}\C{but turn everything on when
debugging}\par
\U4.\fi

\M10. This \TeX\ implementation conforms to the rules of the {\sl Pascal User
Manual} published by Jensen and Wirth in 1975, except where system-dependent
code is necessary to make a useful system program, and except in another
respect where such conformity would unnecessarily obscure the meaning
and clutter up the code: We assume that   \&{case}  statements may include a
default case that applies if no matching label is found. Thus, we shall use
constructions like
$$\vbox{\halign{\ignorespaces#\hfil\cr
 \&{case} $\|x$ \&{of}\cr
1: $\langle\,$code for $x=1\,\rangle$;\cr
3: $\langle\,$code for $x=3\,\rangle$;\cr
 \&{othercases}  $\langle\,$code for $\|x\I1$ and $\|x\I3$$\,\rangle$\cr
  \&{endcases} \cr}}$$
since most \PASCAL\ compilers have plugged this hole in the language by
incorporating some sort of default mechanism. For example, the \ph\
compiler allows `\\{others}:' as a default label, and other \PASCAL s allow
syntaxes like `\&{else}' or `\&{otherwise}' or `\\{otherwise}:', etc. The
definitions of  \&{othercases}  and   \&{endcases}  should be changed to agree
with
local conventions.  Note that no semicolon appears before   \&{endcases}  in
this program, so the definition of   \&{endcases}  should include a semicolon
if the compiler wants one. (Of course, if no default mechanism is
available, the   \&{case}  statements of \TeX\ will have to be laboriously
extended by listing all remaining cases. People who are stuck with such
\PASCAL s have, in fact, done this, successfully but not happily!)

\Y\P\D \37$\\{othercases}\S\\{others}$: \37\C{default for cases not listed
explicitly}\par
\P\D \37$\\{endcases}\S$\ \&{end} \C{follows the default case in an extended   %
\&{case}  statement}\par
\P\F \37$\\{othercases}\S\\{else}$\par
\P\F \37$\\{endcases}\S\\{end}$\par
\fi

\M11. The following parameters can be changed at compile time to extend or
reduce \TeX's capacity. They may have different values in \.{INITEX} and
in production versions of \TeX.

\Y\P$\4\X11:Constants in the outer block\X\S$\6
$\\{mem\_max}=30000$;\C{greatest index in \TeX's internal \\{mem} array;   must
be strictly less than \\{max\_halfword};   must be equal to \\{mem\_top} in %
\.{INITEX}, otherwise $\G\\{mem\_top}$}\6
$\\{mem\_min}=0$;\C{smallest index in \TeX's internal \\{mem} array;   must be %
\\{min\_halfword} or more;   must be equal to \\{mem\_bot} in \.{INITEX},
otherwise $\L\\{mem\_bot}$}\6
$\\{buf\_size}=500$;\C{maximum number of characters simultaneously present in
current lines of open files and in control sequences between   \.{\\csname} and
\.{\\endcsname}; must not exceed \\{max\_halfword}}\6
$\\{error\_line}=72$;\C{width of context lines on terminal error messages}\6
$\\{half\_error\_line}=42$;\C{width of first lines of contexts in terminal
error messages; should be between 30 and $\\{error\_line}-15$}\6
$\\{max\_print\_line}=79$;\C{width of longest text lines output; should be at
least 60}\6
$\\{stack\_size}=200$;\C{maximum number of simultaneous input sources}\6
$\\{max\_in\_open}=6$;\C{maximum number of input files and error insertions
that   can be going on simultaneously}\6
$\\{font\_max}=75$;\C{maximum internal font number; must not exceed \\{max%
\_quarterword}   and must be at most $\\{font\_base}+256$}\6
$\\{font\_mem\_size}=20000$;\C{number of words of \\{font\_info} for all fonts}%
\6
$\\{param\_size}=60$;\C{maximum number of simultaneous macro parameters}\6
$\\{nest\_size}=40$;\C{maximum number of semantic levels simultaneously active}%
\6
$\\{max\_strings}=3000$;\C{maximum number of strings; must not exceed \\{max%
\_halfword}}\6
$\\{string\_vacancies}=8000$;\C{the minimum number of characters that should be
  available for the user's control sequences and font names,   after \TeX's own
error messages are stored}\6
$\\{pool\_size}=32000$;\C{maximum number of characters in strings, including
all   error messages and help texts, and the names of all fonts and   control
sequences; must exceed \\{string\_vacancies} by the total   length of \TeX's
own strings, which is currently about 23000}\6
$\\{save\_size}=600$;\C{space for saving values outside of current group; must
be   at most \\{max\_halfword}}\6
$\\{trie\_size}=8000$;\C{space for hyphenation patterns; should be larger for
\.{INITEX} than it is in production versions of \TeX}\6
$\\{trie\_op\_size}=500$;\C{space for ``opcodes'' in the hyphenation patterns}\6
$\\{dvi\_buf\_size}=800$;\C{size of the output buffer; must be a multiple of 8}%
\6
$\\{file\_name\_size}=40$;\C{file names shouldn't be longer than this}\6
$\\{pool\_name}=\.{\'TeXformats:TEX.POOL\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \
\ \'}$;\C{string of length \\{file\_name\_size}; tells where the string pool
appears}\par
\As675, 679, 695, 721\ETs1631.
\U4.\fi

\M12. Like the preceding parameters, the following quantities can be changed
at compile time to extend or reduce \TeX's capacity. But if they are changed,
it is necessary to rerun the initialization program \.{INITEX}
to generate new tables for the production \TeX\ program.
One can't simply make helter-skelter changes to the following constants,
since certain rather complex initialization
numbers are computed from them. They are defined here using
\.{WEB} macros, instead of being put into \PASCAL's  \&{const}  list, in order
to
emphasize this distinction.

\Y\P\D \37$\\{mem\_bot}=0$\C{smallest index in the \\{mem} array dumped by %
\.{INITEX};   must not be less than \\{mem\_min}}\par
\P\D \37$\\{mem\_top}\S30000$\C{largest index in the \\{mem} array dumped by %
\.{INITEX};   must be substantially larger than \\{mem\_bot}   and not greater
than \\{mem\_max}}\par
\P\D \37$\\{font\_base}=0$\C{smallest internal font number; must not be less
than \\{min\_quarterword}}\par
\P\D \37$\\{hash\_size}=2100$\C{maximum number of control sequences; it should
be at most   about $(\\{mem\_max}-\\{mem\_min})/10$}\par
\P\D \37$\\{hash\_prime}=1777$\C{a prime number equal to about 85\pct! of %
\\{hash\_size}}\par
\P\D \37$\\{hyph\_size}=307$\C{another prime; the number of \.{\\hyphenation}
exceptions}\par
\fi

\M13. In case somebody has inadvertently made bad settings of the
``constants,''
\TeX\ checks them using a global variable called \\{bad}.

This is the first of many sections of \TeX\ where global variables are
defined.

\Y\P$\4\X13:Global variables\X\S$\6
\4\\{bad}: \37\\{integer};\C{is some ``constant'' wrong?}\par
\As20, 26, 30, 32, 39, 50, 54, 73, 76, 79, 96, 104, 110, 117, 133, 134, 135,
136, 142, 183, 191, 199, 231, 264, 271, 274, 275, 293, 308, 319, 323, 326, 327,
330, 331, 332, 355, 383, 389, 408, 413, 414, 436, 464, 473, 506, 515, 519, 538,
539, 546, 553, 558, 565, 575, 576, 581, 619, 622, 632, 643, 676, 680, 687, 691,
696, 701, 704, 708, 710, 723, 774, 811, 818, 819, 821, 829, 837, 860, 895, 900,
940, 946, 990, 997, 999, 1001, 1004, 1009, 1015, 1023, 1048, 1069, 1077, 1082,
1084, 1098, 1103, 1120, 1124, 1127, 1148, 1157, 1159, 1166, 1209, 1252, 1444,
1459, 1477, 1483, 1511, 1522, 1525, 1543, 1547, 1550, 1557, 1559, 1570, 1583,
1628, 1633, 1640, 1652, 1660, 1705, 1750, 1773, 1814, 1816, 1835, 1842, 1858%
\ETs1859.
\U4.\fi

\M14. Later on we will say `\ignorespaces \&{if} $\\{mem\_max}\G\\{max%
\_halfword}$ \&{then} $\\{bad}\K14$',
or something similar. (We can't do that until \\{max\_halfword} has been
defined.)

\Y\P$\4\X14:Check the ``constant'' values for consistency\X\S$\6
$\\{bad}\K0$;\6
\&{if} $(\\{half\_error\_line}<30)\V(\\{half\_error\_line}>\\{error\_line}-15)$
\1\&{then}\5
$\\{bad}\K1$;\2\6
\&{if} $\\{max\_print\_line}<60$ \1\&{then}\5
$\\{bad}\K2$;\2\6
\&{if} $\\{dvi\_buf\_size}\mathbin{\&{mod}}8\I0$ \1\&{then}\5
$\\{bad}\K3$;\2\6
\&{if} $\\{mem\_bot}+1100>\\{mem\_top}$ \1\&{then}\5
$\\{bad}\K4$;\2\6
\&{if} $\\{hash\_prime}>\\{hash\_size}$ \1\&{then}\5
$\\{bad}\K5$;\2\6
\&{if} $\\{max\_in\_open}\G128$ \1\&{then}\5
$\\{bad}\K6$;\2\6
\&{if} $\\{mem\_top}<256+11$ \1\&{then}\5
$\\{bad}\K7$;\C{we will want $\\{null\_list}>255$}\2\par
\As129, 312, 548\ETs1427.
\U1512.\fi

\M15. Labels are given symbolic names by the following definitions, so that
occasional \&{goto}  statements will be meaningful. We insert the label
`\\{exit}' just before the `\ignorespaces  \&{end} \unskip' of a procedure in
which we have used the `\&{return}' statement defined below; the label
`\\{restart}' is occasionally used at the very beginning of a procedure; and
the label `\\{reswitch}' is occasionally used just prior to a   \&{case}
statement in which some cases change the conditions and we wish to branch
to the newly applicable case.  Loops that are set up with the  \~ \&{loop}
construction defined below are commonly exited by going to `\\{done}' or to
`\\{found}' or to `\\{not\_found}', and they are sometimes repeated by going to
`\\{continue}'.  If two or more parts of a subroutine start differently but
end up the same, the shared code may be gathered together at
`\\{common\_ending}'.

Incidentally, this program never declares a label that isn't actually used,
because some fussy \PASCAL\ compilers will complain about redundant labels.

\Y\P\D \37$\\{exit}=10$\C{go here to leave a procedure}\par
\P\D \37$\\{restart}=20$\C{go here to start a procedure again}\par
\P\D \37$\\{reswitch}=21$\C{go here to start a case statement again}\par
\P\D \37$\\{continue}=22$\C{go here to resume a loop}\par
\P\D \37$\\{done}=30$\C{go here to exit a loop}\par
\P\D \37$\\{done1}=31$\C{like \\{done}, when there is more than one loop}\par
\P\D \37$\\{done2}=32$\C{for exiting the second loop in a long block}\par
\P\D \37$\\{done3}=33$\C{for exiting the third loop in a very long block}\par
\P\D \37$\\{done4}=34$\C{for exiting the fourth loop in an extremely long
block}\par
\P\D \37$\\{done5}=35$\C{for exiting the fifth loop in an immense block}\par
\P\D \37$\\{done6}=36$\C{for exiting the sixth loop in a block}\par
\P\D \37$\\{found}=40$\C{go here when you've found it}\par
\P\D \37$\\{found1}=41$\C{like \\{found}, when there's more than one per
routine}\par
\P\D \37$\\{found2}=42$\C{like \\{found}, when there's more than two per
routine}\par
\P\D \37$\\{not\_found}=45$\C{go here when you've found nothing}\par
\P\D \37$\\{not\_found1}=46$\C{like \\{not\_found}, when there's more than one}%
\par
\P\D \37$\\{not\_found2}=47$\C{like \\{not\_found}, when there's more than two}%
\par
\P\D \37$\\{not\_found3}=48$\C{like \\{not\_found}, when there's more than
three}\par
\P\D \37$\\{not\_found4}=49$\C{like \\{not\_found}, when there's more than
four}\par
\P\D \37$\\{common\_ending}=50$\C{go here when you want to merge with another
branch}\par
\fi

\M16. Here are some macros for common programming idioms.

\Y\P\D \37$\\{incr}(\#)\S\#\K\#+1$\C{increase a variable by unity}\par
\P\D \37$\\{decr}(\#)\S\#\K\#-1$\C{decrease a variable by unity}\par
\P\D \37$\\{negate}(\#)\S\#\K-\#$\C{change the sign of a variable}\par
\P\D \37$\\{loop}\S$\ \&{while} $\\{true}$ \1\&{do}\ \C{repeat over and over
until a \&{goto}  happens}\par
\P\F \37$\\{loop}\S\\{xclause}$\C{\.{WEB}'s  \~ \&{xclause} acts like `%
\ignorespaces \&{while} $\\{true}$ \&{do}\unskip'}\par
\P\D \37$\\{do\_nothing}\S$\C{empty statement}\par
\P\D \37$\\{return}\S$\1\5
\&{goto} \37\\{exit}\C{terminate a procedure call}\2\par
\P\F \37$\\{return}\S\\{nil}$\par
\P\D \37$\\{empty}=0$\C{symbolic name for a null constant}\par
\fi

\N17.  \[2] The character set.
In order to make \TeX\ readily portable to a wide variety of
computers, all of its input text is converted to an internal eight-bit
code that includes standard ASCII, the ``American Standard Code for
Information Interchange.''  This conversion is done immediately when each
character is read in. Conversely, characters are converted from ASCII to
the user's external representation just before they are output to a
text file.

Such an internal code is relevant to users of \TeX\ primarily because it
governs the positions of characters in the fonts. For example, the
character `\.A' has ASCII code $65=\O{101}$, and when \TeX\ typesets
this letter it specifies character number 65 in the current font.
If that font actually has `\.A' in a different position, \TeX\ doesn't
know what the real position is; the program that does the actual printing from
\TeX's device-independent files is responsible for converting from ASCII to
a particular font encoding.

\TeX's internal code also defines the value of constants
that begin with a reverse apostrophe; and it provides an index to the
\.{\\catcode}, \.{\\mathcode}, \.{\\uccode}, \.{\\lccode}, and \.{\\delcode}
tables.

\fi

\M18. Characters of text that have been converted to \TeX's internal form
are said to be of type \\{ASCII\_code}, which is a subrange of the integers.

\Y\P$\4\X18:Types in the outer block\X\S$\6
$\\{ASCII\_code}=0\to255$;\C{eight-bit numbers}\par
\As25, 38, 101, 109, 131, 168, 230, 291, 322, 574, 621, 694, 707, 722, 1097,
1102, 1627, 1632\ETs1678.
\U4.\fi

\M19. The original \PASCAL\ compiler was designed in the late 60s, when six-bit
character sets were common, so it did not make provision for lowercase
letters. Nowadays, of course, we need to deal with both capital and small
letters in a convenient way, especially in a program for typesetting;
so the present specification of \TeX\ has been written under the assumption
that the \PASCAL\ compiler and run-time system permit the use of text files
with more than 64 distinguishable characters. More precisely, we assume that
the character set contains at least the letters and symbols associated
with ASCII codes \O{40} through \O{176}; all of these characters are now
available on most computer terminals.

Since we are dealing with more characters than were present in the first
\PASCAL\ compilers, we have to decide what to call the associated data
type. Some \PASCAL s use the original name \\{char} for the
characters in text files, even though there now are more than 64 such
characters, while other \PASCAL s consider \\{char} to be a 64-element
subrange of a larger data type that has some other name.

In order to accommodate this difference, we shall use the name \\{text\_char}
to stand for the data type of the characters that are converted to and
from \\{ASCII\_code} when they are input and output. We shall also assume
that \\{text\_char} consists of the elements $\\{chr}(\\{first\_text\_char})$
through
$\\{chr}(\\{last\_text\_char})$, inclusive. The following definitions should be
adjusted if necessary.

\Y\P\D \37$\\{text\_char}\S\\{char}$\C{the data type of characters in text
files}\par
\P\D \37$\\{first\_text\_char}=0$\C{ordinal number of the smallest element of %
\\{text\_char}}\par
\P\D \37$\\{last\_text\_char}=255$\C{ordinal number of the largest element of %
\\{text\_char}}\par
\Y\P$\4\X19:Local variables for initialization\X\S$\6
\4\|i: \37\\{integer};\par
\As181\ET1104.
\U4.\fi

\M20. The \TeX\ processor converts between ASCII code and
the user's external character set by means of arrays \\{xord} and \\{xchr}
that are analogous to \PASCAL's \\{ord} and \\{chr} functions.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{xord}: \37\&{array} $[\\{text\_char}]$ \1\&{of}\5
\\{ASCII\_code};\C{specifies conversion of input characters}\2\6
\4\\{xchr}: \37\&{array} $[\\{ASCII\_code}]$ \1\&{of}\5
\\{text\_char};\C{specifies conversion of output characters}\2\par
\fi

\M21. Since we are assuming that our \PASCAL\ system is able to read and
write the visible characters of standard ASCII (although not
necessarily using the ASCII codes to represent them), the following
assignment statements initialize the standard part of the \\{xchr} array
properly, without needing any system-dependent changes. On the other
hand, it is possible to implement \TeX\ with less complete character
sets, and in such cases it will be necessary to change something here.

\Y\P$\4\X21:Set initial values of key variables\X\S$\6
$\\{xchr}[\O{40}]\K\.{\'\ \'}$;\5
$\\{xchr}[\O{41}]\K\.{\'!\'}$;\5
$\\{xchr}[\O{42}]\K\.{\'"\'}$;\5
$\\{xchr}[\O{43}]\K\.{\'\#\'}$;\5
$\\{xchr}[\O{44}]\K\.{\'\$\'}$;\5
$\\{xchr}[\O{45}]\K\.{\'\%\'}$;\5
$\\{xchr}[\O{46}]\K\.{\'\&\'}$;\5
$\\{xchr}[\O{47}]\K\.{\'\'}\.{\'\'}$;\6
$\\{xchr}[\O{50}]\K\.{\'(\'}$;\5
$\\{xchr}[\O{51}]\K\.{\')\'}$;\5
$\\{xchr}[\O{52}]\K\.{\'*\'}$;\5
$\\{xchr}[\O{53}]\K\.{\'+\'}$;\5
$\\{xchr}[\O{54}]\K\.{\',\'}$;\5
$\\{xchr}[\O{55}]\K\.{\'-\'}$;\5
$\\{xchr}[\O{56}]\K\.{\'.\'}$;\5
$\\{xchr}[\O{57}]\K\.{\'/\'}$;\6
$\\{xchr}[\O{60}]\K\.{\'0\'}$;\5
$\\{xchr}[\O{61}]\K\.{\'1\'}$;\5
$\\{xchr}[\O{62}]\K\.{\'2\'}$;\5
$\\{xchr}[\O{63}]\K\.{\'3\'}$;\5
$\\{xchr}[\O{64}]\K\.{\'4\'}$;\5
$\\{xchr}[\O{65}]\K\.{\'5\'}$;\5
$\\{xchr}[\O{66}]\K\.{\'6\'}$;\5
$\\{xchr}[\O{67}]\K\.{\'7\'}$;\6
$\\{xchr}[\O{70}]\K\.{\'8\'}$;\5
$\\{xchr}[\O{71}]\K\.{\'9\'}$;\5
$\\{xchr}[\O{72}]\K\.{\':\'}$;\5
$\\{xchr}[\O{73}]\K\.{\';\'}$;\5
$\\{xchr}[\O{74}]\K\.{\'<\'}$;\5
$\\{xchr}[\O{75}]\K\.{\'=\'}$;\5
$\\{xchr}[\O{76}]\K\.{\'>\'}$;\5
$\\{xchr}[\O{77}]\K\.{\'?\'}$;\6
$\\{xchr}[\O{100}]\K\.{\'@\'}$;\5
$\\{xchr}[\O{101}]\K\.{\'A\'}$;\5
$\\{xchr}[\O{102}]\K\.{\'B\'}$;\5
$\\{xchr}[\O{103}]\K\.{\'C\'}$;\5
$\\{xchr}[\O{104}]\K\.{\'D\'}$;\5
$\\{xchr}[\O{105}]\K\.{\'E\'}$;\5
$\\{xchr}[\O{106}]\K\.{\'F\'}$;\5
$\\{xchr}[\O{107}]\K\.{\'G\'}$;\6
$\\{xchr}[\O{110}]\K\.{\'H\'}$;\5
$\\{xchr}[\O{111}]\K\.{\'I\'}$;\5
$\\{xchr}[\O{112}]\K\.{\'J\'}$;\5
$\\{xchr}[\O{113}]\K\.{\'K\'}$;\5
$\\{xchr}[\O{114}]\K\.{\'L\'}$;\5
$\\{xchr}[\O{115}]\K\.{\'M\'}$;\5
$\\{xchr}[\O{116}]\K\.{\'N\'}$;\5
$\\{xchr}[\O{117}]\K\.{\'O\'}$;\6
$\\{xchr}[\O{120}]\K\.{\'P\'}$;\5
$\\{xchr}[\O{121}]\K\.{\'Q\'}$;\5
$\\{xchr}[\O{122}]\K\.{\'R\'}$;\5
$\\{xchr}[\O{123}]\K\.{\'S\'}$;\5
$\\{xchr}[\O{124}]\K\.{\'T\'}$;\5
$\\{xchr}[\O{125}]\K\.{\'U\'}$;\5
$\\{xchr}[\O{126}]\K\.{\'V\'}$;\5
$\\{xchr}[\O{127}]\K\.{\'W\'}$;\6
$\\{xchr}[\O{130}]\K\.{\'X\'}$;\5
$\\{xchr}[\O{131}]\K\.{\'Y\'}$;\5
$\\{xchr}[\O{132}]\K\.{\'Z\'}$;\5
$\\{xchr}[\O{133}]\K\.{\'[\'}$;\5
$\\{xchr}[\O{134}]\K\.{\'\\\'}$;\5
$\\{xchr}[\O{135}]\K\.{\']\'}$;\5
$\\{xchr}[\O{136}]\K\.{\'\^\'}$;\5
$\\{xchr}[\O{137}]\K\.{\'\_\'}$;\6
$\\{xchr}[\O{140}]\K\.{\'\`\'}$;\5
$\\{xchr}[\O{141}]\K\.{\'a\'}$;\5
$\\{xchr}[\O{142}]\K\.{\'b\'}$;\5
$\\{xchr}[\O{143}]\K\.{\'c\'}$;\5
$\\{xchr}[\O{144}]\K\.{\'d\'}$;\5
$\\{xchr}[\O{145}]\K\.{\'e\'}$;\5
$\\{xchr}[\O{146}]\K\.{\'f\'}$;\5
$\\{xchr}[\O{147}]\K\.{\'g\'}$;\6
$\\{xchr}[\O{150}]\K\.{\'h\'}$;\5
$\\{xchr}[\O{151}]\K\.{\'i\'}$;\5
$\\{xchr}[\O{152}]\K\.{\'j\'}$;\5
$\\{xchr}[\O{153}]\K\.{\'k\'}$;\5
$\\{xchr}[\O{154}]\K\.{\'l\'}$;\5
$\\{xchr}[\O{155}]\K\.{\'m\'}$;\5
$\\{xchr}[\O{156}]\K\.{\'n\'}$;\5
$\\{xchr}[\O{157}]\K\.{\'o\'}$;\6
$\\{xchr}[\O{160}]\K\.{\'p\'}$;\5
$\\{xchr}[\O{161}]\K\.{\'q\'}$;\5
$\\{xchr}[\O{162}]\K\.{\'r\'}$;\5
$\\{xchr}[\O{163}]\K\.{\'s\'}$;\5
$\\{xchr}[\O{164}]\K\.{\'t\'}$;\5
$\\{xchr}[\O{165}]\K\.{\'u\'}$;\5
$\\{xchr}[\O{166}]\K\.{\'v\'}$;\5
$\\{xchr}[\O{167}]\K\.{\'w\'}$;\6
$\\{xchr}[\O{170}]\K\.{\'x\'}$;\5
$\\{xchr}[\O{171}]\K\.{\'y\'}$;\5
$\\{xchr}[\O{172}]\K\.{\'z\'}$;\5
$\\{xchr}[\O{173}]\K\.{\'\{\'}$;\5
$\\{xchr}[\O{174}]\K\.{\'|\'}$;\5
$\\{xchr}[\O{175}]\K\.{\'\}\'}$;\5
$\\{xchr}[\O{176}]\K\.{\'\~\'}$;\par
\As23, 24, 74, 77, 80, 97, 118, 184, 233, 272, 276, 294, 309, 390, 409, 465,
507, 516, 547, 577, 582, 620, 623, 633, 677, 681, 688, 697, 709, 711, 724, 820,
830, 838, 861, 947, 1105, 1167, 1210, 1445, 1460, 1478, 1523, 1551, 1571, 1584,
1629, 1634, 1706, 1751, 1817, 1836\ETs1860.
\U8.\fi

\M22. Some of the ASCII codes without visible characters have been given
symbolic
names in this program because they are used with a special meaning.

\Y\P\D \37$\\{null\_code}=\O{0}$\C{ASCII code that might disappear}\par
\P\D \37$\\{carriage\_return}=\O{15}$\C{ASCII code used at end of line}\par
\P\D \37$\\{invalid\_code}=\O{177}$\C{ASCII code that many systems prohibit in
text files}\par
\fi

\M23. The ASCII code is ``standard'' only to a certain extent, since many
computer installations have found it advantageous to have ready access
to more than 94 printing characters. Appendix~C of {\sl The \TeX book\/}
gives a complete specification of the intended correspondence between
characters and \TeX's internal representation.

If \TeX\ is being used
on a garden-variety \PASCAL\ for which only standard ASCII
codes will appear in the input and output files, it doesn't really matter
what codes are specified in $\\{xchr}[0\to\O{37}]$, but the safest policy is to
blank everything out by using the code shown below.

However, other settings of \\{xchr} will make \TeX\ more friendly on
computers that have an extended character set, so that users can type things
like `\.^^Z' instead of `\.{\\ne}'. People with extended character sets can
assign codes arbitrarily, giving an \\{xchr} equivalent to whatever
characters the users of \TeX\ are allowed to have in their input files.
It is best to make the codes correspond to the intended interpretations as
shown in Appendix~C whenever possible; but this is not necessary. For
example, in countries with an alphabet of more than 26 letters, it is
usually best to map the additional letters into codes less than~\O{40}.
To get the most ``permissive'' character set, change \.{\'\ \'} on the
right of these assignment statements to $\\{chr}(\|i)$.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|i\K0\mathrel{\&{to}}\O{37}$ \1\&{do}\5
$\\{xchr}[\|i]\K\.{\'\ \'}$;\2\6
\&{for} $\|i\K\O{177}\mathrel{\&{to}}\O{377}$ \1\&{do}\5
$\\{xchr}[\|i]\K\.{\'\ \'}$;\2\par
\fi

\M24. The following system-independent code makes the \\{xord} array contain a
suitable inverse to the information in \\{xchr}. Note that if $\\{xchr}[\|i]=%
\\{xchr}[\|j]$
where $\|i<\|j<\O{177}$, the value of $\\{xord}[\\{xchr}[\|i]]$ will turn out
to be
\|j or more; hence, standard ASCII code numbers will be used instead of
codes below \O{40} in case there is a coincidence.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|i\K\\{first\_text\_char}\mathrel{\&{to}}\\{last\_text\_char}$ \1%
\&{do}\5
$\\{xord}[\\{chr}(\|i)]\K\\{invalid\_code}$;\2\6
\&{for} $\|i\K\O{200}\mathrel{\&{to}}\O{377}$ \1\&{do}\5
$\\{xord}[\\{xchr}[\|i]]\K\|i$;\2\6
\&{for} $\|i\K0\mathrel{\&{to}}\O{176}$ \1\&{do}\5
$\\{xord}[\\{xchr}[\|i]]\K\|i$;\2\par
\fi

\N25.  \[3] Input and output.
The bane of portability is the fact that different operating systems treat
input and output quite differently, perhaps because computer scientists
have not given sufficient attention to this problem. People have felt somehow
that input and output are not part of ``real'' programming. Well, it is true
that some kinds of programming are more fun than others. With existing
input/output conventions being so diverse and so messy, the only sources of
joy in such parts of the code are the rare occasions when one can find a
way to make the program a little less bad than it might have been. We have
two choices, either to attack I/O now and get it over with, or to postpone
I/O until near the end. Neither prospect is very attractive, so let's
get it over with.

The basic operations we need to do are (1)~inputting and outputting of
text, to or from a file or the user's terminal; (2)~inputting and
outputting of eight-bit bytes, to or from a file; (3)~instructing the
operating system to initiate (``open'') or to terminate (``close'') input or
output from a specified file; (4)~testing whether the end of an input
file has been reached.

\TeX\ needs to deal with two kinds of files.
We shall use the term \\{alpha\_file} for a file that contains textual data,
and the term \\{byte\_file} for a file that contains eight-bit binary
information.
These two types turn out to be the same on many computers, but
sometimes there is a significant distinction, so we shall be careful to
distinguish between them. Standard protocols for transferring
such files from computer to computer, via high-speed networks, are
now becoming available to more and more communities of users.

The program actually makes use also of a third kind of file, called a
\\{word\_file}, when dumping and reloading base information for its own
initialization.  We shall define a word file later; but it will be possible
for us to specify simple operations on word files before they are defined.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{eight\_bits}=0\to255$;\C{unsigned one-byte quantity}\6
$\\{alpha\_file}=$\1\5
\&{packed} \37\&{file} \1\&{of}\5
\\{text\_char};\C{files that contain textual data}\2\2\6
$\\{byte\_file}=$\1\5
\&{packed} \37\&{file} \1\&{of}\5
\\{eight\_bits};\C{files that contain binary data}\2\2\par
\fi

\M26. Most of what we need to do with respect to input and output can be
handled
by the I/O facilities that are standard in \PASCAL, i.e., the routines
called \\{get}, \\{put}, \\{eof}, and so on. But
standard \PASCAL\ does not allow file variables to be associated with file
names that are determined at run time, so it cannot be used to implement
\TeX; some sort of extension to \PASCAL's ordinary \\{reset} and \\{rewrite}
is crucial for our purposes. We shall assume that \\{name\_of\_file} is a
variable
of an appropriate type such that the \PASCAL\ run-time system being used to
implement \TeX\ can open a file whose external name is specified by
\\{name\_of\_file}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{name\_of\_file}: \37\&{packed} \37\&{array} $[1\to\\{file\_name\_size}]$ %
\1\&{of}\5
\\{char};\2\6
\C{on some systems this may be a \&{record} variable}\6
\4\\{name\_length}: \37$0\to\\{file\_name\_size}$;\6
\C{this many characters are actually   relevant in \\{name\_of\_file} (the rest
are blank)}\par
\fi

\M27. The \ph\ compiler with which the present version of \TeX\ was prepared
has
extended the rules of \PASCAL\ in a very convenient way. To open file~\|f,
we can write
$$\vbox{\halign{#\hfil\qquad&#\hfil\cr
$\\{reset}(\|f,\hbox{\\{name}},\.{\'/O\'})$&for input;\cr
$\\{rewrite}(\|f,\hbox{\\{name}},\.{\'/O\'})$&for output.\cr}}$$
The `\\{name}' parameter, which is of type `{\bf packed array
$[\langle\\{any}\rangle]$ of \\{char}}', stands for the name of
the external file that is being opened for input or output.
Blank spaces that might appear in \\{name} are ignored.

The `\.{/O}' parameter tells the operating system not to issue its own
error messages if something goes wrong. If a file of the specified name
cannot be found, or if such a file cannot be opened for some other reason
(e.g., someone may already be trying to write the same file), we will have
$\\{erstat}(\|f)\I0$ after an unsuccessful \\{reset} or \\{rewrite}.  This
allows
\TeX\ to undertake appropriate corrective action.

\TeX's file-opening procedures return \\{false} if no file identified by
\\{name\_of\_file} could be opened.

\Y\P\D \37$\\{reset\_OK}(\#)\S\\{erstat}(\#)=0$\par
\P\D \37$\\{rewrite\_OK}(\#)\S\\{erstat}(\#)=0$\par
\Y\P\4\&{function}\1\  \37$\\{a\_open\_in}(\mathop{\&{var}}\|f:\\{alpha%
\_file})$: \37\\{boolean};\C{open a text file for input}\2\6
\&{begin} \37$\\{reset}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{a\_open\_in}\K\\{reset\_OK}(\|f)$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{a\_open\_out}(\mathop{\&{var}}\|f:\\{alpha\_file})$: %
\37\\{boolean};\C{open a text file for output}\2\6
\&{begin} \37$\\{rewrite}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{a\_open\_out}\K\\{rewrite\_OK}(\|f)$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{b\_open\_in}(\mathop{\&{var}}\|f:\\{byte\_file})$: %
\37\\{boolean};\C{open a binary file for input}\2\6
\&{begin} \37$\\{reset}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{b\_open\_in}\K\\{reset\_OK}(\|f)$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{b\_open\_out}(\mathop{\&{var}}\|f:\\{byte\_file})$: %
\37\\{boolean};\C{open a binary file for output}\2\6
\&{begin} \37$\\{rewrite}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{b\_open\_out}\K\\{rewrite\_OK}(\|f)$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{w\_open\_in}(\mathop{\&{var}}\|f:\\{word\_file})$: %
\37\\{boolean};\C{open a word file for input}\2\6
\&{begin} \37$\\{reset}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{w\_open\_in}\K\\{reset\_OK}(\|f)$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{w\_open\_out}(\mathop{\&{var}}\|f:\\{word\_file})$: %
\37\\{boolean};\C{open a word file for output}\2\6
\&{begin} \37$\\{rewrite}(\|f,\39\\{name\_of\_file},\39\.{\'/O\'})$;\5
$\\{w\_open\_out}\K\\{rewrite\_OK}(\|f)$;\6
\&{end};\par
\fi

\M28. Files can be closed with the \ph\ routine `$\\{close}(\|f)$', which
should be used when all input or output with respect to \|f has been completed.
This makes \|f available to be opened again, if desired; and if \|f was used
for
output, the \\{close} operation makes the corresponding external file appear
on the user's area, ready to be read.

These procedures should not generate error messages if a file is
being closed before it has been successfully opened.

\Y\P\4\&{procedure}\1\  \37$\\{a\_close}(\mathop{\&{var}}\|f:\\{alpha\_file})$;%
\C{close a text file}\2\6
\&{begin} \37$\\{close}(\|f)$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{b\_close}(\mathop{\&{var}}\|f:\\{byte\_file})$;%
\C{close a binary file}\2\6
\&{begin} \37$\\{close}(\|f)$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{w\_close}(\mathop{\&{var}}\|f:\\{word\_file})$;%
\C{close a word file}\2\6
\&{begin} \37$\\{close}(\|f)$;\6
\&{end};\par
\fi

\M29. Binary input and output are done with \PASCAL's ordinary \\{get} and %
\\{put}
procedures, so we don't have to make any other special arrangements for
binary~I/O. Text output is also easy to do with standard \PASCAL\ routines.
The treatment of text input is more difficult, however, because
of the necessary translation to \\{ASCII\_code} values.
\TeX's conventions should be efficient, and they should
blend nicely with the user's operating environment.

\fi

\M30. Input from text files is read one line at a time, using a routine called
\\{input\_ln}. This function is defined in terms of global variables called
\\{buffer}, \\{first}, and \\{last} that will be described in detail later; for
now, it suffices for us to know that \\{buffer} is an array of \\{ASCII\_code}
values, and that \\{first} and \\{last} are indices into this array
representing the beginning and ending of a line of text.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{buffer}: \37\&{array} $[0\to\\{buf\_size}]$ \1\&{of}\5
\\{ASCII\_code};\C{lines of characters being read}\2\6
\4\\{first}: \37$0\to\\{buf\_size}$;\C{the first unused position in \\{buffer}}%
\6
\4\\{last}: \37$0\to\\{buf\_size}$;\C{end of the line just input to \\{buffer}}%
\6
\4\\{max\_buf\_stack}: \37$0\to\\{buf\_size}$;\C{largest index used in %
\\{buffer}}\par
\fi

\M31. The \\{input\_ln} function brings the next line of input from the
specified
file into available positions of the buffer array and returns the value
\\{true}, unless the file has already been entirely read, in which case it
returns \\{false} and sets $\\{last}\K\\{first}$.  In general, the \\{ASCII%
\_code}
numbers that represent the next line of the file are input into
$\\{buffer}[\\{first}]$, $\\{buffer}[\\{first}+1]$, \dots, $\\{buffer}[%
\\{last}-1]$; and the
global variable \\{last} is set equal to \\{first} plus the length of the
line. Trailing blanks are removed from the line; thus, either $\\{last}=%
\\{first}$
(in which case the line was entirely blank) or $\\{buffer}[\\{last}-1]\I\.{"\
"}$.

An overflow error is given, however, if the normal actions of \\{input\_ln}
would make $\\{last}\G\\{buf\_size}$; this is done so that other parts of \TeX\
can safely look at the contents of $\\{buffer}[\\{last}+1]$ without
overstepping
the bounds of the \\{buffer} array. Upon entry to \\{input\_ln}, the condition
$\\{first}<\\{buf\_size}$ will always hold, so that there is always room for an
``empty'' line.

The variable \\{max\_buf\_stack}, which is used to keep track of how large
the \\{buf\_size} parameter must be to accommodate the present job, is
also kept up to date by \\{input\_ln}.

If the \\{bypass\_eoln} parameter is \\{true}, \\{input\_ln} will do a \\{get}
before looking at the first character of the line; this skips over
an \\{eoln} that was in $\|f\^$. The procedure does not do a \\{get} when it
reaches the end of the line; therefore it can be used to acquire input
from the user's terminal as well as from ordinary text files.

Standard \PASCAL\ says that a file should have \\{eoln} immediately
before \\{eof}, but \TeX\ needs only a weaker restriction: If \\{eof}
occurs in the middle of a line, the system function \\{eoln} should return
a \\{true} result (even though $\|f\^$ will be undefined).

Since the inner loop of \\{input\_ln} is part of \TeX's ``inner loop''---each
character of input comes in at this place---it is wise to reduce system
overhead by making use of special routines that read in an entire array
of characters at once, if such routines are available. The following
code uses standard \PASCAL\ to illustrate what needs to be done, but
finer tuning is often possible at well-developed \PASCAL\ sites.

\Y\P\4\&{function}\1\  \37$\\{input\_ln}(\mathop{\&{var}}\|f:\\{alpha\_file};\,%
\35\\{bypass\_eoln}:\\{boolean})$: \37\\{boolean};\C{inputs the next line or
returns \\{false}}\6
\4\&{var} \37\\{last\_nonblank}: \37$0\to\\{buf\_size}$;\C{\\{last} with
trailing blanks removed}\2\6
\&{begin} \37\&{if} $\\{bypass\_eoln}$ \1\&{then}\6
\&{if} $\R\\{eof}(\|f)$ \1\&{then}\5
$\\{get}(\|f)$;\C{input the first character of the line into $\|f\^$}\2\2\6
$\\{last}\K\\{first}$;\C{cf.\ Matthew 19\thinspace:\thinspace30}\6
\&{if} $\\{eof}(\|f)$ \1\&{then}\5
$\\{input\_ln}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{last\_nonblank}\K\\{first}$;\6
\&{while} $\R\\{eoln}(\|f)$ \1\&{do}\6
\&{begin} \37\&{if} $\\{last}\G\\{max\_buf\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_buf\_stack}\K\\{last}+1$;\6
\&{if} $\\{max\_buf\_stack}=\\{buf\_size}$ \1\&{then}\5
\X35:Report overflow of the input buffer, and abort\X;\2\6
\&{end};\2\6
$\\{buffer}[\\{last}]\K\\{xord}[\|f\^]$;\5
$\\{get}(\|f)$;\5
$\\{incr}(\\{last})$;\6
\&{if} $\\{buffer}[\\{last}-1]\I\.{"\ "}$ \1\&{then}\5
$\\{last\_nonblank}\K\\{last}$;\2\6
\&{end};\2\6
$\\{last}\K\\{last\_nonblank}$;\5
$\\{input\_ln}\K\\{true}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M32. The user's terminal acts essentially like other files of text, except
that it is used both for input and for output. When the terminal is
considered an input file, the file variable is called \\{term\_in}, and when it
is considered an output file the file variable is \\{term\_out}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{term\_in}: \37\\{alpha\_file};\C{the terminal as an input file}\6
\4\\{term\_out}: \37\\{alpha\_file};\C{the terminal as an output file}\par
\fi

\M33. Here is how to open the terminal files
in \ph. The `\.{/I}' switch suppresses the first \\{get}.

\Y\P\D \37$\\{t\_open\_in}\S\\{reset}(\\{term\_in},\39\.{\'TTY:\'},\39\.{\'/O/I%
\'})$\C{open the terminal for text input}\par
\P\D \37$\\{t\_open\_out}\S\\{rewrite}(\\{term\_out},\39\.{\'TTY:\'},\39\.{\'/O%
\'})$\C{open the terminal for text output}\par
\fi

\M34. Sometimes it is necessary to synchronize the input/output mixture that
happens on the user's terminal, and three system-dependent
procedures are used for this
purpose. The first of these, \\{update\_terminal}, is called when we want
to make sure that everything we have output to the terminal so far has
actually left the computer's internal buffers and been sent.
The second, \\{clear\_terminal}, is called when we wish to cancel any
input that the user may have typed ahead (since we are about to
issue an unexpected error message). The third, \\{wake\_up\_terminal},
is supposed to revive the terminal if the user has disabled it by
some instruction to the operating system.  The following macros show how
these operations can be specified in \ph:

\Y\P\D \37$\\{update\_terminal}\S\\{break}(\\{term\_out})$\C{empty the terminal
output buffer}\par
\P\D \37$\\{clear\_terminal}\S\\{break\_in}(\\{term\_in},\39\\{true})$\C{clear
the terminal input buffer}\par
\P\D \37$\\{wake\_up\_terminal}\S\\{do\_nothing}$\C{cancel the user's
cancellation of output}\par
\fi

\M35. We need a special routine to read the first line of \TeX\ input from
the user's terminal. This line is different because it is read before we
have opened the transcript file; there is sort of a ``chicken and
egg'' problem here. If the user types `\.{\\input paper}' on the first
line, or if some macro invoked by that line does such an \.{\\input},
the transcript file will be named `\.{paper.log}'; but if no \.{\\input}
commands are performed during the first line of terminal input, the transcript
file will acquire its default name `\.{texput.log}'. (The transcript file
will not contain error messages generated by the first line before the
first \.{\\input} command.)

The first line is even more special if we are lucky enough to have an operating
system that treats \TeX\ differently from a run-of-the-mill \PASCAL\ object
program. It's nice to let the user start running a \TeX\ job by typing
a command line like `\.{tex paper}'; in such a case, \TeX\ will operate
as if the first line of input were `\.{paper}', i.e., the first line will
consist of the remainder of the command line, after the part that invoked
\TeX.

The first line is special also because it may be read before \TeX\ has
input a format file. In such cases, normal error messages cannot yet
be given. The following code uses concepts that will be explained later.
(If the \PASCAL\ compiler does not support non-local \&{goto} \unskip, the
statement `\&{goto} \\{final\_end}' should be replaced by something that
quietly terminates the program.)

\Y\P$\4\X35:Report overflow of the input buffer, and abort\X\S$\6
\&{if} $\\{format\_ident}=0$ \1\&{then}\6
\&{begin} \37$\\{write\_ln}(\\{term\_out},\39\.{\'Buffer\ size\ exceeded!\'})$;%
\5
\&{goto} \37\\{final\_end};\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_input}.\\{loc\_field}\K\\{first}$;\5
$\\{cur\_input}.\\{limit\_field}\K\\{last}-1$;\5
$\\{overflow}(\.{"buffer\ size"},\39\\{buf\_size})$;\6
\&{end}\2\par
\Us31\ET1756.\fi

\M36. Different systems have different ways to get started. But regardless of
what conventions are adopted, the routine that initializes the terminal
should satisfy the following specifications:

\yskip\textindent{1)}It should open file \\{term\_in} for input from the
terminal. (The file \\{term\_out} will already be open for output to the
terminal.)

\textindent{2)}If the user has given a command line, this line should be
considered the first line of terminal input. Otherwise the
user should be prompted with `\.{**}', and the first line of input
should be whatever is typed in response.

\textindent{3)}The first line of input, which might or might not be a
command line, should appear in locations \\{first} to $\\{last}-1$ of the
\\{buffer} array.

\textindent{4)}The global variable \\{loc} should be set so that the
character to be read next by \TeX\ is in $\\{buffer}[\\{loc}]$. This
character should not be blank, and we should have $\\{loc}<\\{last}$.

\yskip\noindent(It may be necessary to prompt the user several times
before a non-blank line comes in. The prompt is `\.{**}' instead of the
later `\.*' because the meaning is slightly different: `\.{\\input}' need
not be typed immediately after~`\.{**}'.)

\Y\P\D \37$\\{loc}\S\\{cur\_input}.\\{loc\_field}$\C{location of first unread
character in \\{buffer}}\par
\fi

\M37. The following program does the required initialization
without retrieving a possible command line.
It should be clear how to modify this routine to deal with command lines,
if the system permits them.

\Y\P\4\&{function}\1\  \37\\{init\_terminal}: \37\\{boolean};\C{gets the
terminal input started}\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\\{t\_open\_in};\6
\~ \1\&{loop}\ \&{begin} \37\\{wake\_up\_terminal};\5
$\\{write}(\\{term\_out},\39\.{\'**\'})$;\5
\\{update\_terminal};\6
\&{if} $\R\\{input\_ln}(\\{term\_in},\39\\{true})$ \1\&{then}\C{this shouldn't
happen}\6
\&{begin} \37$\\{write\_ln}(\\{term\_out})$;\5
$\\{write}(\\{term\_out},\39\.{\'!\ End\ of\ file\ on\ the\ terminal...\ why?%
\'})$;\5
$\\{init\_terminal}\K\\{false}$;\5
\&{return};\6
\&{end};\2\6
$\\{loc}\K\\{first}$;\6
\&{while} $(\\{loc}<\\{last})\W(\\{buffer}[\\{loc}]=\.{"\ "})$ \1\&{do}\5
$\\{incr}(\\{loc})$;\2\6
\&{if} $\\{loc}<\\{last}$ \1\&{then}\6
\&{begin} \37$\\{init\_terminal}\K\\{true}$;\5
\&{return};\C{return unless the line was all blank}\6
\&{end};\2\6
$\\{write\_ln}(\\{term\_out},\39\.{\'Please\ type\ the\ name\ of\ your\ input\
file.\'})$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\N38.  \[4] String handling.
Control sequence names and diagnostic messages are variable-length strings
of eight-bit characters. Since \PASCAL\ does not have a well-developed string
mechanism, \TeX\ does all of its string processing by homegrown methods.

Elaborate facilities for dynamic strings are not needed, so all of the
necessary operations can be handled with a simple data structure.
The array \\{str\_pool} contains all of the (eight-bit) ASCII codes in all
of the strings, and the array \\{str\_start} contains indices of the starting
points of each string. Strings are referred to by integer numbers, so that
string number \|s comprises the characters $\\{str\_pool}[\|j]$ for
$\\{str\_start}[\|s]\L\|j<\\{str\_start}[\|s+1]$. Additional integer variables
\\{pool\_ptr} and \\{str\_ptr} indicate the number of entries used so far
in \\{str\_pool} and \\{str\_start}, respectively; locations
$\\{str\_pool}[\\{pool\_ptr}]$ and $\\{str\_start}[\\{str\_ptr}]$ are
ready for the next string to be allocated.

String numbers 0 to 255 are reserved for strings that correspond to single
ASCII characters. This is in accordance with the conventions of \.{WEB},
which converts single-character strings into the ASCII code number of the
single character involved, while it converts other strings into integers
and builds a string pool file. Thus, when the string constant \.{"."} appears
in the program below, \.{WEB} converts it into the integer 46, which is the
ASCII code for a period, while \.{WEB} will convert a string like \.{"hello"}
into some integer greater than~255. String number 46 will presumably be the
single character `\..'; but some ASCII codes have no standard visible
representation, and \TeX\ sometimes needs to be able to print an arbitrary
ASCII character, so the first 256 strings are used to specify exactly what
should be printed for each of the 256 possibilities.

Elements of the \\{str\_pool} array must be ASCII codes that can actually
be printed; i.e., they must have an \\{xchr} equivalent in the local
character set. (This restriction applies only to preloaded strings,
not to those generated dynamically by the user.)

Some \PASCAL\ compilers won't pack integers into a single byte unless the
integers lie in the range $-128\to127$. To accommodate such systems
we access the string pool only via macros that can easily be redefined.

\Y\P\D \37$\\{si}(\#)\S\#$\C{convert from \\{ASCII\_code} to \\{packed\_ASCII%
\_code}}\par
\P\D \37$\\{so}(\#)\S\#$\C{convert from \\{packed\_ASCII\_code} to \\{ASCII%
\_code}}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{pool\_pointer}=0\to\\{pool\_size}$;\C{for variables that point into \\{str%
\_pool}}\6
$\\{str\_number}=0\to\\{max\_strings}$;\C{for variables that point into \\{str%
\_start}}\6
$\\{packed\_ASCII\_code}=0\to255$;\C{elements of \\{str\_pool} array}\par
\fi

\M39. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{str\_pool}: \37\&{packed} \37\&{array} $[\\{pool\_pointer}]$ \1\&{of}\5
\\{packed\_ASCII\_code};\C{the characters}\2\6
\4\\{str\_start}: \37\&{array} $[\\{str\_number}]$ \1\&{of}\5
\\{pool\_pointer};\C{the starting pointers}\2\6
\4\\{pool\_ptr}: \37\\{pool\_pointer};\C{first unused position in \\{str%
\_pool}}\6
\4\\{str\_ptr}: \37\\{str\_number};\C{number of the current string being
created}\6
\4\\{init\_pool\_ptr}: \37\\{pool\_pointer};\C{the starting value of \\{pool%
\_ptr}}\6
\4\\{init\_str\_ptr}: \37\\{str\_number};\C{the starting value of \\{str\_ptr}}%
\par
\fi

\M40. Several of the elementary string operations are performed using \.{WEB}
macros instead of \PASCAL\ procedures, because many of the
operations are done quite frequently and we want to avoid the
overhead of procedure calls. For example, here is
a simple macro that computes the length of a string.

\Y\P\D \37$\\{length}(\#)\S(\\{str\_start}[\#+1]-\\{str\_start}[\#])$\C{the
number of characters   in string number \#}\par
\fi

\M41. The length of the current string is called \\{cur\_length}:

\Y\P\D \37$\\{cur\_length}\S(\\{pool\_ptr}-\\{str\_start}[\\{str\_ptr}])$\par
\fi

\M42. Strings are created by appending character codes to \\{str\_pool}.
The \\{append\_char} macro, defined here, does not check to see if the
value of \\{pool\_ptr} has gotten too high; this test is supposed to be
made before \\{append\_char} is used. There is also a \\{flush\_char}
macro, which erases the last character appended.

To test if there is room to append \|l more characters to \\{str\_pool},
we shall write $\\{str\_room}(\|l)$, which aborts \TeX\ and gives an
apologetic error message if there isn't enough room.

\Y\P\D \37$\\{append\_char}(\#)\S$\C{put \\{ASCII\_code} \# at the end of %
\\{str\_pool}}\6
\&{begin} \37$\\{str\_pool}[\\{pool\_ptr}]\K\\{si}(\#)$;\5
$\\{incr}(\\{pool\_ptr})$;\6
\&{end}\par
\P\D \37$\\{flush\_char}\S\\{decr}(\\{pool\_ptr})$\C{forget the last character
in the pool}\par
\P\D \37$\\{str\_room}(\#)\S$\C{make sure that the pool hasn't overflowed}\6
\&{begin} \37\&{if} $\\{pool\_ptr}+\#>\\{pool\_size}$ \1\&{then}\5
$\\{overflow}(\.{"pool\ size"},\39\\{pool\_size}-\\{init\_pool\_ptr})$;\2\6
\&{end}\par
\fi

\M43. Once a sequence of characters has been appended to \\{str\_pool}, it
officially becomes a string when the function \\{make\_string} is called.
This function returns the identification number of the new string as its
value.

\Y\P\4\&{function}\1\  \37\\{make\_string}: \37\\{str\_number};\C{current
string enters the pool}\2\6
\&{begin} \37\&{if} $\\{str\_ptr}=\\{max\_strings}$ \1\&{then}\5
$\\{overflow}(\.{"number\ of\ strings"},\39\\{max\_strings}-\\{init\_str%
\_ptr})$;\2\6
$\\{incr}(\\{str\_ptr})$;\5
$\\{str\_start}[\\{str\_ptr}]\K\\{pool\_ptr}$;\5
$\\{make\_string}\K\\{str\_ptr}-1$;\6
\&{end};\par
\fi

\M44. To destroy the most recently made string, we say \\{flush\_string}.

\Y\P\D \37$\\{flush\_string}\S$\1\6
\&{begin} \37$\\{decr}(\\{str\_ptr})$;\5
$\\{pool\_ptr}\K\\{str\_start}[\\{str\_ptr}]$;\6
\&{end}\2\par
\fi

\M45. The following subroutine compares string \|s with another string of the
same length that appears in \\{buffer} starting at position \|k;
the result is \\{true} if and only if the strings are equal.
Empirical tests indicate that \\{str\_eq\_buf} is used in such a way that
it tends to return \\{true} about 80 percent of the time.

\Y\P\4\&{function}\1\  \37$\\{str\_eq\_buf}(\|s:\\{str\_number};\,\35\|k:%
\\{integer})$: \37\\{boolean};\C{test equality of strings}\6
\4\&{label} \37\\{not\_found};\C{loop exit}\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{running index}\6
\\{result}: \37\\{boolean};\C{result of comparison}\2\6
\&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37\&{if} $\\{so}(\\{str\_pool}[\|j])\I\\{buffer}[\|k]$ \1\&{then}\6
\&{begin} \37$\\{result}\K\\{false}$;\5
\&{goto} \37\\{not\_found};\6
\&{end};\2\6
$\\{incr}(\|j)$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{result}\K\\{true}$;\6
\4\\{not\_found}: \37$\\{str\_eq\_buf}\K\\{result}$;\6
\&{end};\par
\fi

\M46. Here is a similar routine, but it compares two strings in the string
pool,
and it does not assume that they have the same length.

\Y\P\4\&{function}\1\  \37$\\{str\_eq\_str}(\|s,\39\|t:\\{str\_number})$: \37%
\\{boolean};\C{test equality of strings}\6
\4\&{label} \37\\{not\_found};\C{loop exit}\6
\4\&{var} \37$\|j,\39\|k$: \37\\{pool\_pointer};\C{running indices}\6
\\{result}: \37\\{boolean};\C{result of comparison}\2\6
\&{begin} \37$\\{result}\K\\{false}$;\6
\&{if} $\\{length}(\|s)\I\\{length}(\|t)$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
$\|j\K\\{str\_start}[\|s]$;\5
$\|k\K\\{str\_start}[\|t]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37\&{if} $\\{str\_pool}[\|j]\I\\{str\_pool}[\|k]$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
$\\{incr}(\|j)$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{result}\K\\{true}$;\6
\4\\{not\_found}: \37$\\{str\_eq\_str}\K\\{result}$;\6
\&{end};\par
\fi

\M47. The initial values of \\{str\_pool}, \\{str\_start}, \\{pool\_ptr},
and \\{str\_ptr} are computed by the \.{INITEX} program, based in part
on the information that \.{WEB} has output while processing \TeX.

\Y\P\&{init} \37\&{function}\1\  \37\\{get\_strings\_started}: \37\\{boolean};%
\C{initializes the string pool,   but returns \\{false} if something goes
wrong}\6
\4\&{label} \37$\\{done},\39\\{exit}$;\6
\4\&{var} \37$\|k,\39\|l$: \37$0\to255$;\C{small indices or counters}\6
$\|m,\39\|n$: \37\\{text\_char};\C{characters input from \\{pool\_file}}\6
\|g: \37\\{str\_number};\C{garbage}\6
\|a: \37\\{integer};\C{accumulator for check sum}\6
\|c: \37\\{boolean};\C{check sum has been checked}\2\6
\&{begin} \37$\\{pool\_ptr}\K0$;\5
$\\{str\_ptr}\K0$;\5
$\\{str\_start}[0]\K0$;\5
\X48:Make the first 256 strings\X;\6
\X51:Read the other strings from the \.{TEX.POOL} file and return \\{true}, or
give an error message and return \\{false}\X;\6
\4\\{exit}: \37\&{end};\6
\&{tini}\par
\fi

\M48. \P\D \37$\\{app\_lc\_hex}(\#)\S\|l\K\#$;\6
\&{if} $\|l<10$ \1\&{then}\5
$\\{append\_char}(\|l+\.{"0"})$\ \&{else} $\\{append\_char}(\|l-10+\.{"a"})$\2%
\par
\Y\P$\4\X48:Make the first 256 strings\X\S$\6
\&{for} $\|k\K0\mathrel{\&{to}}255$ \1\&{do}\6
\&{begin} \37\&{if} $(\X49:Character \|k cannot be printed\X)$ \1\&{then}\6
\&{begin} \37$\\{append\_char}(\.{"\^"})$;\5
$\\{append\_char}(\.{"\^"})$;\6
\&{if} $\|k<\O{100}$ \1\&{then}\5
$\\{append\_char}(\|k+\O{100})$\6
\4\&{else} \&{if} $\|k<\O{200}$ \1\&{then}\5
$\\{append\_char}(\|k-\O{100})$\6
\4\&{else} \&{begin} \37$\\{app\_lc\_hex}(\|k\mathbin{\&{div}}16)$;\5
$\\{app\_lc\_hex}(\|k\mathbin{\&{mod}}16)$;\6
\&{end};\2\2\6
\&{end}\6
\4\&{else} $\\{append\_char}(\|k)$;\2\6
$\|g\K\\{make\_string}$;\6
\&{end}\2\par
\U47.\fi

\M49. The first 128 strings will contain 95 standard ASCII characters, and the
other 33 characters will be printed in three-symbol form like `\.{\^\^A}'
unless a system-dependent change is made here. Installations that have
an extended character set, where for example $\\{xchr}[\O{32}]=\hbox{\.{\'^^Z%
\'}}$,
would like string \O{32} to be the single character \O{32} instead of the
three characters \O{136}, \O{136}, \O{132} (\.{\^\^Z}). On the other hand,
even people with an extended character set will want to represent string
\O{15} by \.{\^\^M}, since \O{15} is \\{carriage\_return}; the idea is to
produce visible strings instead of tabs or line-feeds or carriage-returns
or bell-rings or characters that are treated anomalously in text files.

Unprintable characters of codes 128--255 are, similarly, rendered
\.{\^\^80}--\.{\^\^ff}.

The boolean expression defined here should be \\{true} unless \TeX\
internal code number~\|k corresponds to a non-troublesome visible
symbol in the local character set.  An appropriate formula for the
extended character set recommended in {\sl The \TeX book\/} would, for
example, be `$\|k\in[0,\O{10}\to\O{12},\O{14},\O{15},\O{33},\O{177}\to%
\O{377}]$'.
If character \|k cannot be printed, and $\|k<\O{200}$, then character $\|k+%
\O{100}$ or
$\|k-\O{100}$ must be printable; moreover, ASCII codes $[\O{41}\to\O{46},\O{60}%
\to\O{71},\O{136},\O{141}\to\O{146},\O{160}\to\O{171}]$ must be printable.
Thus, at least 80 printable characters are needed.

\Y\P$\4\X49:Character \|k cannot be printed\X\S$\6
$(\|k<\.{"\ "})\V(\|k>\.{"\~"})$\par
\U48.\fi

\M50. When the \.{WEB} system program called \.{TANGLE} processes the %
\.{TEX.WEB}
description that you are now reading, it outputs the \PASCAL\ program
\.{TEX.PAS} and also a string pool file called \.{TEX.POOL}. The \.{INITEX}
program reads the latter file, where each string appears as a two-digit decimal
length followed by the string itself, and the information is recorded in
\TeX's string memory.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\&{init} \37\\{pool\_file}: \37\\{alpha\_file};\C{the string-pool file output
by \.{TANGLE}}\6
\&{tini}\par
\fi

\M51. \P\D \37$\\{bad\_pool}(\#)\S$\1\6
\&{begin} \37\\{wake\_up\_terminal};\5
$\\{write\_ln}(\\{term\_out},\39\#)$;\5
$\\{a\_close}(\\{pool\_file})$;\5
$\\{get\_strings\_started}\K\\{false}$;\5
\&{return};\6
\&{end}\2\par
\Y\P$\4\X51:Read the other strings from the \.{TEX.POOL} file and return %
\\{true}, or give an error message and return \\{false}\X\S$\6
$\\{name\_of\_file}\K\\{pool\_name}$;\C{we needn't set \\{name\_length}}\6
\&{if} $\\{a\_open\_in}(\\{pool\_file})$ \1\&{then}\6
\&{begin} \37$\|c\K\\{false}$;\6
\1\&{repeat} \37\X52:Read one string, but return \\{false} if the string memory
space is getting too tight for comfort\X;\6
\4\&{until}\5
\|c;\2\6
$\\{a\_close}(\\{pool\_file})$;\5
$\\{get\_strings\_started}\K\\{true}$;\6
\&{end}\6
\4\&{else} $\\{bad\_pool}(\.{\'!\ I\ can\'}\.{\'t\ read\ TEX.POOL.\'})$\2\par
\U47.\fi

\M52. \P$\X52:Read one string, but return \\{false} if the string memory space
is getting too tight for comfort\X\S$\6
\&{begin} \37\&{if} $\\{eof}(\\{pool\_file})$ \1\&{then}\5
$\\{bad\_pool}(\.{\'!\ TEX.POOL\ has\ no\ check\ sum.\'})$;\2\6
$\\{read}(\\{pool\_file},\39\|m,\39\|n)$;\C{read two digits of string length}\6
\&{if} $\|m=\.{\'*\'}$ \1\&{then}\5
\X53:Check the pool check sum\X\6
\4\&{else} \&{begin} \37\&{if} $(\\{xord}[\|m]<\.{"0"})\V(\\{xord}[\|m]>%
\.{"9"})\V\30(\\{xord}[\|n]<\.{"0"})\V(\\{xord}[\|n]>\.{"9"})$ \1\&{then}\5
$\\{bad\_pool}(\.{\'!\ TEX.POOL\ line\ doesn\'}\.{\'t\ begin\ with\ two\
digits.\'})$;\2\6
$\|l\K\\{xord}[\|m]\ast10+\\{xord}[\|n]-\.{"0"}\ast11$;\C{compute the length}\6
\&{if} $\\{pool\_ptr}+\|l+\\{string\_vacancies}>\\{pool\_size}$ \1\&{then}\5
$\\{bad\_pool}(\.{\'!\ You\ have\ to\ increase\ POOLSIZE.\'})$;\2\6
\&{for} $\|k\K1\mathrel{\&{to}}\|l$ \1\&{do}\6
\&{begin} \37\&{if} $\\{eoln}(\\{pool\_file})$ \1\&{then}\5
$\|m\K\.{\'\ \'}$\ \&{else} $\\{read}(\\{pool\_file},\39\|m)$;\2\6
$\\{append\_char}(\\{xord}[\|m])$;\6
\&{end};\2\6
$\\{read\_ln}(\\{pool\_file})$;\5
$\|g\K\\{make\_string}$;\6
\&{end};\2\6
\&{end}\par
\U51.\fi

\M53. The \.{WEB} operation \.{@\$} denotes the value that should be at the
end of this \.{TEX.POOL} file; any other value means that the wrong pool
file has been loaded.

\Y\P$\4\X53:Check the pool check sum\X\S$\6
\&{begin} \37$\|a\K0$;\5
$\|k\K1$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $(\\{xord}[\|n]<\.{"0"})\V(\\{xord}[\|n]>%
\.{"9"})$ \1\&{then}\5
$\\{bad\_pool}(\.{\'!\ TEX.POOL\ check\ sum\ doesn\'}\.{\'t\ have\ nine\
digits.\'})$;\2\6
$\|a\K10\ast\|a+\\{xord}[\|n]-\.{"0"}$;\6
\&{if} $\|k=9$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\\{incr}(\|k)$;\5
$\\{read}(\\{pool\_file},\39\|n)$;\6
\&{end};\2\6
\4\\{done}: \37\&{if} $\|a\I\)$ \1\&{then}\5
$\\{bad\_pool}(\.{\'!\ TEX.POOL\ doesn\'}\.{\'t\ match;\ TANGLE\ me\ again.%
\'})$;\2\6
$\|c\K\\{true}$;\6
\&{end}\par
\U52.\fi

\N54.  \[5] On-line and off-line printing.
Messages that are sent to a user's terminal and to the transcript-log file
are produced by several `\\{print}' procedures. These procedures will
direct their output to a variety of places, based on the setting of
the global variable \\{selector}, which has the following possible
values:

\yskip
\hang \\{term\_and\_log}, the normal setting, prints on the terminal and on the
transcript file.

\hang \\{log\_only}, prints only on the transcript file.

\hang \\{term\_only}, prints only on the terminal.

\hang \\{no\_print}, doesn't print at all. This is used only in rare cases
before the transcript file is open.

\hang \\{pseudo}, puts output into a cyclic buffer that is used
by the \\{show\_context} routine; when we get to that routine we shall discuss
the reasoning behind this curious mode.

\hang \\{new\_string}, appends the output to the current string in the
string pool.

\hang 0 to 15, prints on one of the sixteen files for \.{\\write} output.

\yskip
\noindent The symbolic names `\\{term\_and\_log}', etc., have been assigned
numeric codes that satisfy the convenient relations $\\{no\_print}+1=\\{term%
\_only}$,
$\\{no\_print}+2=\\{log\_only}$, $\\{term\_only}+2=\\{log\_only}+1=\\{term\_and%
\_log}$.

Three additional global variables, \\{tally} and \\{term\_offset} and
\\{file\_offset}, record the number of characters that have been printed
since they were most recently cleared to zero. We use \\{tally} to record
the length of (possibly very long) stretches of printing; \\{term\_offset}
and \\{file\_offset}, on the other hand, keep track of how many characters
have appeared so far on the current line that has been output to the
terminal or to the transcript file, respectively.

\Y\P\D \37$\\{no\_print}=16$\C{\\{selector} setting that makes data disappear}%
\par
\P\D \37$\\{term\_only}=17$\C{printing is destined for the terminal only}\par
\P\D \37$\\{log\_only}=18$\C{printing is destined for the transcript file only}%
\par
\P\D \37$\\{term\_and\_log}=19$\C{normal \\{selector} setting}\par
\P\D \37$\\{pseudo}=20$\C{special \\{selector} setting for \\{show\_context}}%
\par
\P\D \37$\\{new\_string}=21$\C{printing is deflected to the string pool}\par
\P\D \37$\\{max\_selector}=21$\C{highest selector setting}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{log\_file}: \37\\{alpha\_file};\C{transcript of \TeX\ session}\6
\4\\{selector}: \37$0\to\\{max\_selector}$;\C{where to print a message}\6
\4\\{dig}: \37\&{array} $[0\to22]$ \1\&{of}\5
$0\to15$;\C{digits in a number being output}\2\6
\4\\{tally}: \37\\{integer};\C{the number of characters recently printed}\6
\4\\{term\_offset}: \37$0\to\\{max\_print\_line}$;\C{the number of characters
on the current terminal line}\6
\4\\{file\_offset}: \37$0\to\\{max\_print\_line}$;\C{the number of characters
on the current file line}\6
\4\\{trick\_buf}: \37\&{array} $[0\to\\{error\_line}]$ \1\&{of}\5
\\{ASCII\_code};\C{circular buffer for   pseudoprinting}\2\6
\4\\{trick\_count}: \37\\{integer};\C{threshold for pseudoprinting, explained
later}\6
\4\\{first\_count}: \37\\{integer};\C{another variable for pseudoprinting}\par
\fi

\M55. \P$\X55:Initialize the output routines\X\S$\6
$\\{selector}\K\\{term\_only}$;\5
$\\{tally}\K0$;\5
$\\{term\_offset}\K0$;\5
$\\{file\_offset}\K0$;\par
\As61, 554\ETs559.
\U1512.\fi

\M56. Macro abbreviations for output to the terminal and to the log file are
defined here for convenience. Some systems need special conventions
for terminal output, and it is possible to adhere to those conventions
by changing \\{wterm}, \\{wterm\_ln}, and \\{wterm\_cr} in this section.

\Y\P\D \37$\\{wterm}(\#)\S\\{write}(\\{term\_out},\39\#)$\par
\P\D \37$\\{wterm\_ln}(\#)\S\\{write\_ln}(\\{term\_out},\39\#)$\par
\P\D \37$\\{wterm\_cr}\S\\{write\_ln}(\\{term\_out})$\par
\P\D \37$\\{wlog}(\#)\S\\{write}(\\{log\_file},\39\#)$\par
\P\D \37$\\{wlog\_ln}(\#)\S\\{write\_ln}(\\{log\_file},\39\#)$\par
\P\D \37$\\{wlog\_cr}\S\\{write\_ln}(\\{log\_file})$\par
\fi

\M57. To end a line of text output, we call \\{print\_ln}.

\Y\P$\4\X57:Basic printing procedures\X\S$\6
\4\&{procedure}\1\  \37\\{print\_ln};\C{prints an end-of-line}\2\6
\&{begin} \37\&{case} $\\{selector}$ \1\&{of}\6
\4\\{term\_and\_log}: \37\&{begin} \37\\{wterm\_cr};\5
\\{wlog\_cr};\5
$\\{term\_offset}\K0$;\5
$\\{file\_offset}\K0$;\6
\&{end};\6
\4\\{log\_only}: \37\&{begin} \37\\{wlog\_cr};\5
$\\{file\_offset}\K0$;\6
\&{end};\6
\4\\{term\_only}: \37\&{begin} \37\\{wterm\_cr};\5
$\\{term\_offset}\K0$;\6
\&{end};\6
\4$\\{no\_print},\39\\{pseudo},\39\\{new\_string}$: \37\\{do\_nothing};\6
\4\&{othercases} \37$\\{write\_ln}(\\{write\_file}[\\{selector}])$\2\6
\&{endcases};\6
\&{end};\C{\\{tally} is not affected}\par
\As58, 59, 60, 62, 63, 64, 65, 284, 285, 544, 875, 1602\ETs1822.
\U4.\fi

\M58. The \\{print\_char} procedure sends one character to the desired
destination,
using the \\{xchr} array to map it into an external character compatible with
\\{input\_ln}. All printing comes through \\{print\_ln} or \\{print\_char}.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_char}(\|s:\\{ASCII\_code})$;\C{prints a
single character}\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{if} $\X262:Character \|s is the current new-line character\X$ %
\1\&{then}\6
\&{if} $\\{selector}<\\{pseudo}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
\&{return};\6
\&{end};\2\2\6
\&{case} $\\{selector}$ \1\&{of}\6
\4\\{term\_and\_log}: \37\&{begin} \37$\\{wterm}(\\{xchr}[\|s])$;\5
$\\{wlog}(\\{xchr}[\|s])$;\5
$\\{incr}(\\{term\_offset})$;\5
$\\{incr}(\\{file\_offset})$;\6
\&{if} $\\{term\_offset}=\\{max\_print\_line}$ \1\&{then}\6
\&{begin} \37\\{wterm\_cr};\5
$\\{term\_offset}\K0$;\6
\&{end};\2\6
\&{if} $\\{file\_offset}=\\{max\_print\_line}$ \1\&{then}\6
\&{begin} \37\\{wlog\_cr};\5
$\\{file\_offset}\K0$;\6
\&{end};\2\6
\&{end};\6
\4\\{log\_only}: \37\&{begin} \37$\\{wlog}(\\{xchr}[\|s])$;\5
$\\{incr}(\\{file\_offset})$;\6
\&{if} $\\{file\_offset}=\\{max\_print\_line}$ \1\&{then}\5
\\{print\_ln};\2\6
\&{end};\6
\4\\{term\_only}: \37\&{begin} \37$\\{wterm}(\\{xchr}[\|s])$;\5
$\\{incr}(\\{term\_offset})$;\6
\&{if} $\\{term\_offset}=\\{max\_print\_line}$ \1\&{then}\5
\\{print\_ln};\2\6
\&{end};\6
\4\\{no\_print}: \37\\{do\_nothing};\6
\4\\{pseudo}: \37\&{if} $\\{tally}<\\{trick\_count}$ \1\&{then}\5
$\\{trick\_buf}[\\{tally}\mathbin{\&{mod}}\\{error\_line}]\K\|s$;\2\6
\4\\{new\_string}: \37\&{begin} \37\&{if} $\\{pool\_ptr}<\\{pool\_size}$ \1%
\&{then}\5
$\\{append\_char}(\|s)$;\2\6
\&{end};\C{we drop characters if the string space is full}\6
\4\&{othercases} \37$\\{write}(\\{write\_file}[\\{selector}],\39\\{xchr}[\|s])$%
\2\6
\&{endcases};\6
$\\{incr}(\\{tally})$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M59. An entire string is output by calling \\{print}. Note that if we are
outputting
the single standard ASCII character \.c, we could call $\\{print}(\.{"c"})$,
since
$\.{"c"}=99$ is the number of a single-character string, as explained above.
But
$\\{print\_char}(\.{"c"})$ is quicker, so \TeX\ goes directly to the \\{print%
\_char}
routine when it knows that this is safe. (The present implementation
assumes that it is always safe to print a visible ASCII character.)

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print}(\|s:\\{integer})$;\C{prints string \|s}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{current character code position}\6
\\{nl}: \37\\{integer};\C{new-line character to restore}\2\6
\&{begin} \37\&{if} $\|s\G\\{str\_ptr}$ \1\&{then}\5
$\|s\K\.{"???"}$\C{this can't happen}\6
\4\&{else} \&{if} $\|s<256$ \1\&{then}\6
\&{if} $\|s<0$ \1\&{then}\5
$\|s\K\.{"???"}$\C{can't happen}\6
\4\&{else} \&{begin} \37\&{if} $\\{selector}>\\{pseudo}$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\|s)$;\5
\&{return};\C{internal strings are not expanded}\6
\&{end};\2\6
\&{if} $(\X262:Character \|s is the current new-line character\X)$ \1\&{then}\6
\&{if} $\\{selector}<\\{pseudo}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
\&{return};\6
\&{end};\2\2\6
$\\{nl}\K\\{new\_line\_char}$;\5
$\\{new\_line\_char}\K-1$;\C{temporarily disable new-line character}\6
$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\\{print\_char}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
$\\{new\_line\_char}\K\\{nl}$;\5
\&{return};\6
\&{end};\2\2\2\6
$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\\{print\_char}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M60. Control sequence names, file names, and strings constructed with
\.{\\string} might contain \\{ASCII\_code} values that can't
be printed using \\{print\_char}. Therefore we use \\{slow\_print} for them:

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{slow\_print}(\|s:\\{integer})$;\C{prints string \|s}%
\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{current character code position}\2\6
\&{begin} \37\&{if} $(\|s\G\\{str\_ptr})\V(\|s<256)$ \1\&{then}\5
$\\{print}(\|s)$\6
\4\&{else} \&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\\{print}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M61. Here is the very first thing that \TeX\ prints: a headline that
identifies
the version number and format package. The \\{term\_offset} variable is
temporarily
incorrect, but the discrepancy is not serious since we assume that this
part of the program is system dependent.

\Y\P$\4\X55:Initialize the output routines\X\mathrel{+}\S$\6
$\\{wterm}(\\{banner})$;\6
\&{if} $\\{format\_ident}=0$ \1\&{then}\5
$\\{wterm\_ln}(\.{\'\ (no\ format\ preloaded)\'})$\6
\4\&{else} \&{begin} \37$\\{slow\_print}(\\{format\_ident})$;\5
\\{print\_ln};\6
\&{end};\2\6
\\{update\_terminal};\par
\fi

\M62. The procedure \\{print\_nl} is like \\{print}, but it makes sure that the
string appears at the beginning of a new line.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_nl}(\|s:\\{str\_number})$;\C{prints string %
\|s at beginning of line}\2\6
\&{begin} \37\&{if} $((\\{term\_offset}>0)\W(\\{odd}(\\{selector})))\V\30((%
\\{file\_offset}>0)\W(\\{selector}\G\\{log\_only}))$ \1\&{then}\5
\\{print\_ln};\2\6
$\\{print}(\|s)$;\6
\&{end};\par
\fi

\M63. The procedure \\{print\_esc} prints a string that is preceded by
the user's escape character (which is usually a backslash).

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_esc}(\|s:\\{str\_number})$;\C{prints escape
character, then \|s}\6
\4\&{var} \37\|c: \37\\{integer};\C{the escape character code}\2\6
\&{begin} \37\X261:Set variable \|c to the current escape character\X;\6
\&{if} $\|c\G0$ \1\&{then}\6
\&{if} $\|c<256$ \1\&{then}\5
$\\{print}(\|c)$;\2\2\6
$\\{slow\_print}(\|s)$;\6
\&{end};\par
\fi

\M64. An array of digits in the range $0\to15$ is printed by \\{print\_the%
\_digs}.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_the\_digs}(\|k:\\{eight\_bits})$;\C{prints $%
\\{dig}[\|k-1]$$\,\ldots\,$$\\{dig}[0]$}\2\6
\&{begin} \37\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\6
\&{if} $\\{dig}[\|k]<10$ \1\&{then}\5
$\\{print\_char}(\.{"0"}+\\{dig}[\|k])$\6
\4\&{else} $\\{print\_char}(\.{"A"}-10+\\{dig}[\|k])$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M65. The following procedure, which prints out the decimal representation of a
given integer \|n, has been written carefully so that it works properly
if $\|n=0$ or if $(-\|n)$ would cause overflow. It does not apply $\mathbin{%
\&{mod}}$ or $\mathbin{\&{div}}$
to negative arguments, since such operations are not implemented consistently
by all \PASCAL\ compilers.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_int}(\|n:\\{longinteger})$;\C{prints an
integer in decimal form}\6
\4\&{var} \37\|k: \37$0\to23$;\C{index to current digit; we assume that $\vert
n\vert<10^{23}$}\6
\|m: \37\\{longinteger};\C{used to negate \|n in possibly dangerous cases}\2\6
\&{begin} \37$\|k\K0$;\6
\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"-"})$;\6
\&{if} $\|n>-100000000$ \1\&{then}\5
$\\{negate}(\|n)$\6
\4\&{else} \&{begin} \37$\|m\K-1-\|n$;\5
$\|n\K\|m\mathbin{\&{div}}10$;\5
$\|m\K(\|m\mathbin{\&{mod}}10)+1$;\5
$\|k\K1$;\6
\&{if} $\|m<10$ \1\&{then}\5
$\\{dig}[0]\K\|m$\6
\4\&{else} \&{begin} \37$\\{dig}[0]\K0$;\5
$\\{incr}(\|n)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\1\&{repeat} \37$\\{dig}[\|k]\K\|n\mathbin{\&{mod}}10$;\5
$\|n\K\|n\mathbin{\&{div}}10$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|n=0$;\2\6
$\\{print\_the\_digs}(\|k)$;\6
\&{end};\par
\fi

\M66. Here is a trivial procedure to print two digits; it is usually called
with
a parameter in the range $0\L\|n\L99$.

\Y\P\4\&{procedure}\1\  \37$\\{print\_two}(\|n:\\{integer})$;\C{prints two
least significant digits}\2\6
\&{begin} \37$\|n\K\\{abs}(\|n)\mathbin{\&{mod}}100$;\5
$\\{print\_char}(\.{"0"}+(\|n\mathbin{\&{div}}10))$;\5
$\\{print\_char}(\.{"0"}+(\|n\mathbin{\&{mod}}10))$;\6
\&{end};\par
\fi

\M67. Hexadecimal printing of nonnegative integers is accomplished by \\{print%
\_hex}.

\Y\P\4\&{procedure}\1\  \37$\\{print\_hex}(\|n:\\{integer})$;\C{prints a
positive integer in hexadecimal form}\6
\4\&{var} \37\|k: \37$0\to22$;\C{index to current digit; we assume that $0\L
n<16^{22}$}\2\6
\&{begin} \37$\|k\K0$;\5
$\\{print\_char}(\.{""}\.{""})$;\6
\1\&{repeat} \37$\\{dig}[\|k]\K\|n\mathbin{\&{mod}}16$;\5
$\|n\K\|n\mathbin{\&{div}}16$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|n=0$;\2\6
$\\{print\_the\_digs}(\|k)$;\6
\&{end};\par
\fi

\M68. Old versions of \TeX\ needed a procedure called \\{print\_ASCII} whose
function
is now subsumed by \\{print}. We retain the old name here as a possible aid to
future software arch\ae ologists.

\Y\P\D \37$\\{print\_ASCII}\S\\{print}$\par
\fi

\M69. Roman numerals are produced by the \\{print\_roman\_int} routine.
Readers
who like puzzles might enjoy trying to figure out how this tricky code
works; therefore no explanation will be given. Notice that 1990 yields
\.{mcmxc}, not \.{mxm}.

\Y\P\4\&{procedure}\1\  \37$\\{print\_roman\_int}(\|n:\\{integer})$;\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37$\|j,\39\|k$: \37\\{pool\_pointer};\C{mysterious indices into %
\\{str\_pool}}\6
$\|u,\39\|v$: \37\\{nonnegative\_integer};\C{mysterious numbers}\2\6
\&{begin} \37$\|j\K\\{str\_start}[\.{"m2d5c2l5x2v5i"}]$;\5
$\|v\K1000$;\6
\~ \1\&{loop}\ \&{begin} \37\&{while} $\|n\G\|v$ \1\&{do}\6
\&{begin} \37$\\{print\_char}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\|n\K\|n-\|v$;\6
\&{end};\2\6
\&{if} $\|n\L0$ \1\&{then}\5
\&{return};\C{nonpositive input produces no output}\2\6
$\|k\K\|j+2$;\5
$\|u\K\|v\mathbin{\&{div}}(\\{so}(\\{str\_pool}[\|k-1])-\.{"0"})$;\6
\&{if} $\\{str\_pool}[\|k-1]=\\{si}(\.{"2"})$ \1\&{then}\6
\&{begin} \37$\|k\K\|k+2$;\5
$\|u\K\|u\mathbin{\&{div}}(\\{so}(\\{str\_pool}[\|k-1])-\.{"0"})$;\6
\&{end};\2\6
\&{if} $\|n+\|u\G\|v$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\\{so}(\\{str\_pool}[\|k]))$;\5
$\|n\K\|n+\|u$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|j\K\|j+2$;\5
$\|v\K\|v\mathbin{\&{div}}(\\{so}(\\{str\_pool}[\|j-1])-\.{"0"})$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M70. The \\{print} subroutine will not print a string that is still being
created. The following procedure will.

\Y\P\4\&{procedure}\1\  \37\\{print\_current\_string};\C{prints a yet-unmade
string}\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{points to current character code}\2\6
\&{begin} \37$\|j\K\\{str\_start}[\\{str\_ptr}]$;\6
\&{while} $\|j<\\{pool\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{print\_char}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M71. Here is a procedure that asks the user to type a line of input,
assuming that the \\{selector} setting is either \\{term\_only} or \\{term\_and%
\_log}.
The input is placed into locations \\{first} through $\\{last}-1$ of the
\\{buffer} array, and echoed on the transcript file if appropriate.

This procedure is never called when $\\{interaction}<\\{scroll\_mode}$.

\Y\P\D \37$\\{prompt\_input}(\#)\S$\1\6
\&{begin} \37\\{wake\_up\_terminal};\5
$\\{print}(\#)$;\5
\\{term\_input};\6
\&{end}\C{prints a string and gets a line of input}\2\par
\Y\P\4\&{procedure}\1\  \37\\{term\_input};\C{gets a line from the terminal}\6
\4\&{var} \37\|k: \37$0\to\\{buf\_size}$;\C{index into \\{buffer}}\2\6
\&{begin} \37\\{update\_terminal};\C{now the user sees the prompt for sure}\6
\&{if} $\R\\{input\_ln}(\\{term\_in},\39\\{true})$ \1\&{then}\5
$\\{fatal\_error}(\.{"End\ of\ file\ on\ the\ terminal!"})$;\2\6
$\\{term\_offset}\K0$;\C{the user's line ended with \<\rm return>}\6
$\\{decr}(\\{selector})$;\C{prepare to echo the input}\6
\&{if} $\\{last}\I\\{first}$ \1\&{then}\6
\&{for} $\|k\K\\{first}\mathrel{\&{to}}\\{last}-1$ \1\&{do}\5
$\\{print}(\\{buffer}[\|k])$;\2\2\6
\\{print\_ln};\5
$\\{incr}(\\{selector})$;\C{restore previous status}\6
\&{end};\par
\fi

\N72.  \[6] Reporting errors.
When something anomalous is detected, \TeX\ typically does something like this:
$$\vbox{\halign{#\hfil\cr
$\\{print\_err}(\.{"Something\ anomalous\ has\ been\ detected"})$;\cr
$\\{help3}(\.{"This\ is\ the\ first\ line\ of\ my\ offer\ to\ help."})$\cr
$(\.{"This\ is\ the\ second\ line.\ I\'m\ trying\ to"})$\cr
$(\.{"explain\ the\ best\ way\ for\ you\ to\ proceed."})$;\cr
\\{error};\cr}}$$
A two-line help message would be given using \\{help2}, etc.; these informal
helps should use simple vocabulary that complements the words used in the
official error message that was printed. (Outside the U.S.A., the help
messages should preferably be translated into the local vernacular. Each
line of help is at most 60 characters long, in the present implementation,
so that \\{max\_print\_line} will not be exceeded.)

The \\{print\_err} procedure supplies a `\.!' before the official message,
and makes sure that the terminal is awake if a stop is going to occur.
The \\{error} procedure supplies a `\..' after the official message, then it
shows the location of the error; and if $\\{interaction}=\\{error\_stop%
\_mode}$,
it also enters into a dialog with the user, during which time the help
message may be printed.

\fi

\M73. The global variable \\{interaction} has four settings, representing
increasing
amounts of user interaction:

\Y\P\D \37$\\{batch\_mode}=0$\C{omits all stops and omits terminal output}\par
\P\D \37$\\{nonstop\_mode}=1$\C{omits all stops}\par
\P\D \37$\\{scroll\_mode}=2$\C{omits error stops}\par
\P\D \37$\\{error\_stop\_mode}=3$\C{stops at every opportunity to interact}\par
\P\D \37$\\{print\_err}(\#)\S$\1\6
\&{begin} \37\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
\\{wake\_up\_terminal};\2\6
$\\{print\_nl}(\.{"!\ "})$;\5
$\\{print}(\#)$;\6
\&{end}\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{interaction}: \37$\\{batch\_mode}\to\\{error\_stop\_mode}$;\C{current
level of interaction}\par
\fi

\M74. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{interaction}\K\\{error\_stop\_mode}$;\par
\fi

\M75. \TeX\ is careful not to call \\{error} when the print \\{selector}
setting
might be unusual. The only possible values of \\{selector} at the time of
error messages are

\yskip\hang\\{no\_print} (when $\\{interaction}=\\{batch\_mode}$
and \\{log\_file} not yet open);

\hang\\{term\_only} (when $\\{interaction}>\\{batch\_mode}$ and \\{log\_file}
not yet open);

\hang\\{log\_only} (when $\\{interaction}=\\{batch\_mode}$ and \\{log\_file} is
open);

\hang\\{term\_and\_log} (when $\\{interaction}>\\{batch\_mode}$ and \\{log%
\_file} is open).

\Y\P$\4\X75:Initialize the print \\{selector} based on \\{interaction}\X\S$\6
\&{if} $\\{interaction}=\\{batch\_mode}$ \1\&{then}\5
$\\{selector}\K\\{no\_print}$\ \&{else} $\\{selector}\K\\{term\_only}$\2\par
\Us1443\ET1517.\fi

\M76. A global variable \\{deletions\_allowed} is set \\{false} if the \\{get%
\_next}
routine is active when \\{error} is called; this ensures that \\{get\_next}
and related routines like \\{get\_token} will never be called recursively.
A similar interlock is provided by \\{set\_box\_allowed}.

The global variable \\{history} records the worst level of error that
has been detected. It has four possible values: \\{spotless}, \\{warning%
\_issued},
\\{error\_message\_issued}, and \\{fatal\_error\_stop}.

Another global variable, \\{error\_count}, is increased by one when an
\\{error} occurs without an interactive dialog, and it is reset to zero at
the end of every paragraph.  If \\{error\_count} reaches 100, \TeX\ decides
that there is no point in continuing further.

\Y\P\D \37$\\{spotless}=0$\C{\\{history} value when nothing has been amiss yet}%
\par
\P\D \37$\\{warning\_issued}=1$\C{\\{history} value when \\{begin\_diagnostic}
has been called}\par
\P\D \37$\\{error\_message\_issued}=2$\C{\\{history} value when \\{error} has
been called}\par
\P\D \37$\\{fatal\_error\_stop}=3$\C{\\{history} value when termination was
premature}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{deletions\_allowed}: \37\\{boolean};\C{is it safe for \\{error} to call %
\\{get\_token}?}\6
\4\\{set\_box\_allowed}: \37\\{boolean};\C{is it safe to do a \.{\\setbox}
assignment?}\6
\4\\{history}: \37$\\{spotless}\to\\{fatal\_error\_stop}$;\C{has the source
input been clean so far?}\6
\4\\{error\_count}: \37$-1\to100$;\C{the number of scrolled errors since the
last paragraph ended}\par
\fi

\M77. The value of \\{history} is initially \\{fatal\_error\_stop}, but it will
be changed to \\{spotless} if \TeX\ survives the initialization process.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{deletions\_allowed}\K\\{true}$;\5
$\\{set\_box\_allowed}\K\\{true}$;\5
$\\{error\_count}\K0$;\C{\\{history} is initialized elsewhere}\par
\fi

\M78. Since errors can be detected almost anywhere in \TeX, we want to declare
the
error procedures near the beginning of the program. But the error procedures
in turn use some other procedures, which need to be declared \\{forward}
before we get to \\{error} itself.

It is possible for \\{error} to be called recursively if some error arises
when \\{get\_token} is being used to delete a token, and/or if some fatal error
occurs while \TeX\ is trying to fix a non-fatal one. But such recursion
is never more than two levels deep.

\Y\P$\4\X78:Error handling procedures\X\S$\6
\4\&{procedure}\1\  \37\\{normalize\_selector};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{get\_token};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{term\_input};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{show\_context};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{begin\_file\_reading};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{open\_log\_file};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{close\_files\_and\_terminate};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{clear\_for\_error\_prompt};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{give\_err\_help};\5
\\{forward};\5
\hbox{\2}\6
\hbox{\4\hskip-\fontdimen2\font}\ \&{debug} \37\ \&{procedure}\1\  \37\\{debug%
\_help};\5
\\{forward};\ \&{gubed} \par
\As81, 82, 93, 94\ETs95.
\U4.\fi

\M79. Individual lines of help are recorded in the array \\{help\_line}, which
contains entries in positions $0\to(\\{help\_ptr}-1)$. They should be printed
in reverse order, i.e., with $\\{help\_line}[0]$ appearing last.

\Y\P\D \37$\\{hlp1}(\#)\S\\{help\_line}[0]\K\#$;\ \&{end} \par
\P\D \37$\\{hlp2}(\#)\S\\{help\_line}[1]\K\#$;\5
\\{hlp1}\par
\P\D \37$\\{hlp3}(\#)\S\\{help\_line}[2]\K\#$;\5
\\{hlp2}\par
\P\D \37$\\{hlp4}(\#)\S\\{help\_line}[3]\K\#$;\5
\\{hlp3}\par
\P\D \37$\\{hlp5}(\#)\S\\{help\_line}[4]\K\#$;\5
\\{hlp4}\par
\P\D \37$\\{hlp6}(\#)\S\\{help\_line}[5]\K\#$;\5
\\{hlp5}\par
\P\D \37$\\{help0}\S\\{help\_ptr}\K0$\C{sometimes there might be no help}\par
\P\D \37$\\{help1}\S$\ \&{begin} \37$\\{help\_ptr}\K1$;\5
\\{hlp1}\C{use this with one help line}\par
\P\D \37$\\{help2}\S$\ \&{begin} \37$\\{help\_ptr}\K2$;\5
\\{hlp2}\C{use this with two help lines}\par
\P\D \37$\\{help3}\S$\ \&{begin} \37$\\{help\_ptr}\K3$;\5
\\{hlp3}\C{use this with three help lines}\par
\P\D \37$\\{help4}\S$\ \&{begin} \37$\\{help\_ptr}\K4$;\5
\\{hlp4}\C{use this with four help lines}\par
\P\D \37$\\{help5}\S$\ \&{begin} \37$\\{help\_ptr}\K5$;\5
\\{hlp5}\C{use this with five help lines}\par
\P\D \37$\\{help6}\S$\ \&{begin} \37$\\{help\_ptr}\K6$;\5
\\{hlp6}\C{use this with six help lines}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{help\_line}: \37\&{array} $[0\to5]$ \1\&{of}\5
\\{str\_number};\C{helps for the next \\{error}}\2\6
\4\\{help\_ptr}: \37$0\to6$;\C{the number of help lines present}\6
\4\\{use\_err\_help}: \37\\{boolean};\C{should the \\{err\_help} list be
shown?}\par
\fi

\M80. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{help\_ptr}\K0$;\5
$\\{use\_err\_help}\K\\{false}$;\par
\fi

\M81. The \\{jump\_out} procedure just cuts across all active procedure levels
and
goes to \\{end\_of\_TEX}. This is the only nontrivial \&{goto}  statement in
the
whole program. It is used when there is no recovery from a particular error.

Some \PASCAL\ compilers do not implement non-local \&{goto}  statements.
In such cases the body of \\{jump\_out} should simply be
`\\{close\_files\_and\_terminate};\thinspace' followed by a call on some system
procedure that quietly terminates the program.

\Y\P$\4\X78:Error handling procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{jump\_out};\2\6
\&{begin} \37\&{goto} \37\\{end\_of\_TEX};\6
\&{end};\par
\fi

\M82. Here now is the general \\{error} routine.

\Y\P$\4\X78:Error handling procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{error};\C{completes the job of error reporting}\6
\4\&{label} \37$\\{continue},\39\\{exit}$;\6
\4\&{var} \37\|c: \37\\{ASCII\_code};\C{what the user types}\6
$\\{s1},\39\\{s2},\39\\{s3},\39\\{s4}$: \37\\{integer};\C{used to save global
variables when deleting tokens}\2\6
\&{begin} \37\&{if} $\\{history}<\\{error\_message\_issued}$ \1\&{then}\5
$\\{history}\K\\{error\_message\_issued}$;\2\6
$\\{print\_char}(\.{"."})$;\5
\\{show\_context};\6
\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
\X83:Get user's advice and \&{return}\X;\2\6
$\\{incr}(\\{error\_count})$;\6
\&{if} $\\{error\_count}=100$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"(That\ makes\ 100\ errors;\ please\ try\
again.)"})$;\5
$\\{history}\K\\{fatal\_error\_stop}$;\5
\\{jump\_out};\6
\&{end};\2\6
\X90:Put help message on the transcript file\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M83. \P$\X83:Get user's advice and \&{return}\X\S$\6
\~ \1\&{loop}\ \&{begin} \37\\{continue}: \37\&{if} $\\{interaction}\I\\{error%
\_stop\_mode}$ \1\&{then}\5
\&{return};\2\6
\\{clear\_for\_error\_prompt};\5
$\\{prompt\_input}(\.{"?\ "})$;\6
\&{if} $\\{last}=\\{first}$ \1\&{then}\5
\&{return};\2\6
$\|c\K\\{buffer}[\\{first}]$;\6
\&{if} $\|c\G\.{"a"}$ \1\&{then}\5
$\|c\K\|c+\.{"A"}-\.{"a"}$;\C{convert to uppercase}\2\6
\X84:Interpret code \|c and \&{return} if done\X;\6
\&{end}\2\par
\U82.\fi

\M84. It is desirable to provide an `\.E' option here that gives the user
an easy way to return from \TeX\ to the system editor, with the offending
line ready to be edited. But such an extension requires some system
wizardry, so the present implementation simply types out the name of the
file that should be
edited and the relevant line number.

There is a secret `\.D' option available when the debugging routines haven't
been commented~out.

\Y\P$\4\X84:Interpret code \|c and \&{return} if done\X\S$\6
\&{case} $\|c$ \1\&{of}\6
\4$\.{"0"},\39\.{"1"},\39\.{"2"},\39\.{"3"},\39\.{"4"},\39\.{"5"},\39\.{"6"},%
\39\.{"7"},\39\.{"8"},\39\.{"9"}$: \37\&{if} $\\{deletions\_allowed}$ \1%
\&{then}\5
\X88:Delete \(c)$\|c-\.{"0"}$ tokens and \&{goto} \\{continue}\X;\2\6
\hbox{\4\4}\ \&{debug} \37\.{"D"}: \37\&{begin} \37\\{debug\_help};\5
\&{goto} \37\\{continue};\ \&{end};\ \&{gubed}\6
\4\.{"E"}: \37\&{if} $\\{base\_ptr}>0$ \1\&{then}\6
\&{if} $\\{input\_stack}[\\{base\_ptr}].\\{name\_field}\G256$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"You\ want\ to\ edit\ file\ "})$;\5
$\\{slow\_print}(\\{input\_stack}[\\{base\_ptr}].\\{name\_field})$;\5
$\\{print}(\.{"\ at\ line\ "})$;\5
$\\{print\_int}(\\{line})$;\5
$\\{interaction}\K\\{scroll\_mode}$;\5
\\{jump\_out};\6
\&{end};\2\2\6
\4\.{"H"}: \37\X89:Print the help information and \&{goto} \\{continue}\X;\6
\4\.{"I"}: \37\X87:Introduce new material from the terminal and \&{return}\X;\6
\4$\.{"Q"},\39\.{"R"},\39\.{"S"}$: \37\X86:Change the interaction level and %
\&{return}\X;\6
\4\.{"X"}: \37\&{begin} \37$\\{interaction}\K\\{scroll\_mode}$;\5
\\{jump\_out};\6
\&{end};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\X85:Print the menu of available options\X\par
\U83.\fi

\M85. \P$\X85:Print the menu of available options\X\S$\6
\&{begin} \37$\\{print}(\.{"Type\ <return>\ to\ proceed,\ S\ to\ scroll\ future%
\ error\ messages,"})$;\6
$\\{print\_nl}(\.{"R\ to\ run\ without\ stopping,\ Q\ to\ run\ quietly,"})$;\6
$\\{print\_nl}(\.{"I\ to\ insert\ something,\ "})$;\6
\&{if} $\\{base\_ptr}>0$ \1\&{then}\6
\&{if} $\\{input\_stack}[\\{base\_ptr}].\\{name\_field}\G256$ \1\&{then}\5
$\\{print}(\.{"E\ to\ edit\ your\ file,"})$;\2\2\6
\&{if} $\\{deletions\_allowed}$ \1\&{then}\5
$\\{print\_nl}(\.{"1\ or\ ...\ or\ 9\ to\ ignore\ the\ next\ 1\ to\ 9\ tokens\
of\ input,"})$;\2\6
$\\{print\_nl}(\.{"H\ for\ help,\ X\ to\ quit."})$;\6
\&{end}\par
\U84.\fi

\M86. Here the author of \TeX\ apologizes for making use of the numerical
relation between \.{"Q"}, \.{"R"}, \.{"S"}, and the desired interaction
settings
\\{batch\_mode}, \\{nonstop\_mode}, \\{scroll\_mode}.

\Y\P$\4\X86:Change the interaction level and \&{return}\X\S$\6
\&{begin} \37$\\{error\_count}\K0$;\5
$\\{interaction}\K\\{batch\_mode}+\|c-\.{"Q"}$;\5
$\\{print}(\.{"OK,\ entering\ "})$;\6
\&{case} $\|c$ \1\&{of}\6
\4\.{"Q"}: \37\&{begin} \37$\\{print\_esc}(\.{"batchmode"})$;\5
$\\{decr}(\\{selector})$;\6
\&{end};\6
\4\.{"R"}: \37$\\{print\_esc}(\.{"nonstopmode"})$;\6
\4\.{"S"}: \37$\\{print\_esc}(\.{"scrollmode"})$;\2\6
\&{end};\C{there are no other cases}\6
$\\{print}(\.{"..."})$;\5
\\{print\_ln};\5
\\{update\_terminal};\5
\&{return};\6
\&{end}\par
\U84.\fi

\M87. When the following code is executed, $\\{buffer}[(\\{first}+1)\to(%
\\{last}-1)]$ may
contain the material inserted by the user; otherwise another prompt will
be given. In order to understand this part of the program fully, you need
to be familiar with \TeX's input stacks.

\Y\P$\4\X87:Introduce new material from the terminal and \&{return}\X\S$\6
\&{begin} \37\\{begin\_file\_reading};\C{enter a new syntactic level for
terminal input}\6
\C{now $\\{state}=\\{mid\_line}$, so an initial blank space will count as a
blank}\6
\&{if} $\\{last}>\\{first}+1$ \1\&{then}\6
\&{begin} \37$\\{loc}\K\\{first}+1$;\5
$\\{buffer}[\\{first}]\K\.{"\ "}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{prompt\_input}(\.{"insert>"})$;\5
$\\{loc}\K\\{first}$;\6
\&{end};\2\6
$\\{first}\K\\{last}$;\5
$\\{cur\_input}.\\{limit\_field}\K\\{last}-1$;\C{no \\{end\_line\_char} ends
this line}\6
\&{return};\6
\&{end}\par
\U84.\fi

\M88. We allow deletion of up to 99 tokens at a time.

\Y\P$\4\X88:Delete \(c)$\|c-\.{"0"}$ tokens and \&{goto} \\{continue}\X\S$\6
\&{begin} \37$\\{s1}\K\\{cur\_tok}$;\5
$\\{s2}\K\\{cur\_cmd}$;\5
$\\{s3}\K\\{cur\_chr}$;\5
$\\{s4}\K\\{align\_state}$;\5
$\\{align\_state}\K1000000$;\5
$\\{OK\_to\_interrupt}\K\\{false}$;\6
\&{if} $(\\{last}>\\{first}+1)\W(\\{buffer}[\\{first}+1]\G\.{"0"})\W(%
\\{buffer}[\\{first}+1]\L\.{"9"})$ \1\&{then}\5
$\|c\K\|c\ast10+\\{buffer}[\\{first}+1]-\.{"0"}\ast11$\6
\4\&{else} $\|c\K\|c-\.{"0"}$;\2\6
\&{while} $\|c>0$ \1\&{do}\6
\&{begin} \37\\{get\_token};\C{one-level recursive call of \\{error} is
possible}\6
$\\{decr}(\|c)$;\6
\&{end};\2\6
$\\{cur\_tok}\K\\{s1}$;\5
$\\{cur\_cmd}\K\\{s2}$;\5
$\\{cur\_chr}\K\\{s3}$;\5
$\\{align\_state}\K\\{s4}$;\5
$\\{OK\_to\_interrupt}\K\\{true}$;\5
$\\{help2}(\.{"I\ have\ just\ deleted\ some\ text,\ as\ you\ asked."})$\6
$(\.{"You\ can\ now\ delete\ more,\ or\ insert,\ or\ whatever."})$;\5
\\{show\_context};\5
\&{goto} \37\\{continue};\6
\&{end}\par
\U84.\fi

\M89. \P$\X89:Print the help information and \&{goto} \\{continue}\X\S$\6
\&{begin} \37\&{if} $\\{use\_err\_help}$ \1\&{then}\6
\&{begin} \37\\{give\_err\_help};\5
$\\{use\_err\_help}\K\\{false}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{help\_ptr}=0$ \1\&{then}\5
$\\{help2}(\.{"Sorry,\ I\ don\'t\ know\ how\ to\ help\ in\ this\ situation."})$%
\2\6
$\hbox{\kern1em}(\.{"Maybe\ you\ should\ try\ asking\ a\ human?"})$;\6
\1\&{repeat} \37$\\{decr}(\\{help\_ptr})$;\5
$\\{print}(\\{help\_line}[\\{help\_ptr}])$;\5
\\{print\_ln};\6
\4\&{until}\5
$\\{help\_ptr}=0$;\2\6
\&{end};\2\6
$\\{help4}(\.{"Sorry,\ I\ already\ gave\ what\ help\ I\ could..."})$\6
$(\.{"Maybe\ you\ should\ try\ asking\ a\ human?"})$\6
$(\.{"An\ error\ might\ have\ occurred\ before\ I\ noticed\ any\ problems."})$\6
$(\.{"\`\`If\ all\ else\ fails,\ read\ the\ instructions.\'\'"})$;\6
\&{goto} \37\\{continue};\6
\&{end}\par
\U84.\fi

\M90. \P$\X90:Put help message on the transcript file\X\S$\6
\&{if} $\\{interaction}>\\{batch\_mode}$ \1\&{then}\5
$\\{decr}(\\{selector})$;\C{avoid terminal output}\2\6
\&{if} $\\{use\_err\_help}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
\\{give\_err\_help};\6
\&{end}\6
\4\&{else} \&{while} $\\{help\_ptr}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{help\_ptr})$;\5
$\\{print\_nl}(\\{help\_line}[\\{help\_ptr}])$;\6
\&{end};\2\2\6
\\{print\_ln};\6
\&{if} $\\{interaction}>\\{batch\_mode}$ \1\&{then}\5
$\\{incr}(\\{selector})$;\C{re-enable terminal output}\2\6
\\{print\_ln}\par
\U82.\fi

\M91. A dozen or so error messages end with a parenthesized integer, so we
save a teeny bit of program space by declaring the following procedure:

\Y\P\4\&{procedure}\1\  \37$\\{int\_error}(\|n:\\{integer})$;\2\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print\_char}(\.{")"})$;\5
\\{error};\6
\&{end};\par
\fi

\M92. In anomalous cases, the print selector might be in an unknown state;
the following subroutine is called to fix things just enough to keep
running a bit longer.

\Y\P\4\&{procedure}\1\  \37\\{normalize\_selector};\2\6
\&{begin} \37\&{if} $\\{log\_opened}$ \1\&{then}\5
$\\{selector}\K\\{term\_and\_log}$\6
\4\&{else} $\\{selector}\K\\{term\_only}$;\2\6
\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\2\6
\&{if} $\\{interaction}=\\{batch\_mode}$ \1\&{then}\5
$\\{decr}(\\{selector})$;\2\6
\&{end};\par
\fi

\M93. The following procedure prints \TeX's last words before dying.

\Y\P\D \37$\\{succumb}\S$\1\6
\&{begin} \37\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
$\\{interaction}\K\\{scroll\_mode}$;\C{no more interaction}\2\6
\&{if} $\\{log\_opened}$ \1\&{then}\5
\\{error};\2\6
\&{debug} \37\&{if} $\\{interaction}>\\{batch\_mode}$ \1\&{then}\5
\\{debug\_help};\ \2\6
\&{gubed}\6
$\\{history}\K\\{fatal\_error\_stop}$;\5
\\{jump\_out};\C{irrecoverable error}\6
\&{end}\2\par
\Y\P$\4\X78:Error handling procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{fatal\_error}(\|s:\\{str\_number})$;\C{prints \|s,
and that's it}\2\6
\&{begin} \37\\{normalize\_selector};\6
$\\{print\_err}(\.{"Emergency\ stop"})$;\5
$\\{help1}(\|s)$;\5
\\{succumb};\6
\&{end};\par
\fi

\M94. Here is the most dreaded error message.

\Y\P$\4\X78:Error handling procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{overflow}(\|s:\\{str\_number};\,\35\|n:%
\\{integer})$;\C{stop due to finiteness}\2\6
\&{begin} \37\\{normalize\_selector};\5
$\\{print\_err}(\.{"TeX\ capacity\ exceeded,\ sorry\ ["})$;\5
$\\{print}(\|s)$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print\_char}(\.{"]"})$;\5
$\\{help2}(\.{"If\ you\ really\ absolutely\ need\ more\ capacity,"})$\6
$(\.{"you\ can\ ask\ a\ wizard\ to\ enlarge\ me."})$;\5
\\{succumb};\6
\&{end};\par
\fi

\M95. The program might sometime run completely amok, at which point there is
no choice but to stop. If no previous error has been detected, that's bad
news; a message is printed that is really intended for the \TeX\
maintenance person instead of the user (unless the user has been
particularly diabolical).  The index entries for `this can't happen' may
help to pinpoint the problem.

\Y\P$\4\X78:Error handling procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{confusion}(\|s:\\{str\_number})$;\C{consistency
check violated; \|s tells where}\2\6
\&{begin} \37\\{normalize\_selector};\6
\&{if} $\\{history}<\\{error\_message\_issued}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"This\ can\'t\ happen\ ("})$;\5
$\\{print}(\|s)$;\5
$\\{print\_char}(\.{")"})$;\5
$\\{help1}(\.{"I\'m\ broken.\ Please\ show\ this\ to\ someone\ who\ can\ fix\
can\ fix"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"I\ can\'t\ go\ on\ meeting\ you\
like\ this"})$;\5
$\\{help2}(\.{"One\ of\ your\ faux\ pas\ seems\ to\ have\ wounded\ me\
deeply..."})$\6
$(\.{"in\ fact,\ I\'m\ barely\ conscious.\ Please\ fix\ it\ and\ try\
again."})$;\6
\&{end};\2\6
\\{succumb};\6
\&{end};\par
\fi

\M96. Users occasionally want to interrupt \TeX\ while it's running.
If the \PASCAL\ runtime system allows this, one can implement
a routine that sets the global variable \\{interrupt} to some nonzero value
when such an interrupt is signalled. Otherwise there is probably at least
a way to make \\{interrupt} nonzero using the \PASCAL\ debugger.

\Y\P\D \37$\\{check\_interrupt}\S$\1\6
\&{begin} \37\&{if} $\\{interrupt}\I0$ \1\&{then}\5
\\{pause\_for\_instructions};\2\6
\&{end}\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{interrupt}: \37\\{integer};\C{should \TeX\ pause for instructions?}\6
\4\\{OK\_to\_interrupt}: \37\\{boolean};\C{should interrupts be observed?}\par
\fi

\M97. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{interrupt}\K0$;\5
$\\{OK\_to\_interrupt}\K\\{true}$;\par
\fi

\M98. When an interrupt has been detected, the program goes into its
highest interaction level and lets the user have nearly the full flexibility of
the \\{error} routine.  \TeX\ checks for interrupts only at times when it is
safe to do this.

\Y\P\4\&{procedure}\1\  \37\\{pause\_for\_instructions};\2\6
\&{begin} \37\&{if} $\\{OK\_to\_interrupt}$ \1\&{then}\6
\&{begin} \37$\\{interaction}\K\\{error\_stop\_mode}$;\6
\&{if} $(\\{selector}=\\{log\_only})\V(\\{selector}=\\{no\_print})$ \1\&{then}\5
$\\{incr}(\\{selector})$;\2\6
$\\{print\_err}(\.{"Interruption"})$;\5
$\\{help3}(\.{"You\ rang?"})$\6
$(\.{"Try\ to\ insert\ an\ instruction\ for\ me\ (e.g.,\ \`I\\showlists\'),"})$%
\6
$(\.{"unless\ you\ just\ want\ to\ quit\ by\ typing\ \`X\'."})$;\5
$\\{deletions\_allowed}\K\\{false}$;\5
\\{error};\5
$\\{deletions\_allowed}\K\\{true}$;\5
$\\{interrupt}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\N99.  \[7] Arithmetic with scaled dimensions.
The principal computations performed by \TeX\ are done entirely in terms of
integers less than $2^{31}$ in magnitude; and divisions are done only when both
dividend and divisor are nonnegative. Thus, the arithmetic specified in this
program can be carried out in exactly the same way on a wide variety of
computers, including some small ones. Why? Because the arithmetic
calculations need to be spelled out precisely in order to guarantee that
\TeX\ will produce identical output on different machines. If some
quantities were rounded differently in different implementations, we would
find that line breaks and even page breaks might occur in different places.
Hence the arithmetic of \TeX\ has been designed with care, and systems that
claim to be implementations of \TeX82 should follow precisely the
calculations as they appear in the present program.

(Actually there are three places where \TeX\ uses $\mathbin{\&{div}}$ with a
possibly negative
numerator. These are harmless; see $\mathbin{\&{div}}$ in the index. Also if
the user
sets the \.{\\time} or the \.{\\year} to a negative value, some diagnostic
information will involve negative-numerator division. The same remarks
apply for $\mathbin{\&{mod}}$ as well as for $\mathbin{\&{div}}$.)

\fi

\M100. Here is a routine that calculates half of an integer, using an
unambiguous convention with respect to signed odd numbers.

\Y\P\4\&{function}\1\  \37$\\{half}(\|x:\\{integer})$: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{odd}(\|x)$ \1\&{then}\5
$\\{half}\K(\|x+1)\mathbin{\&{div}}2$\6
\4\&{else} $\\{half}\K\|x\mathbin{\&{div}}2$;\2\6
\&{end};\par
\fi

\M101. Fixed-point arithmetic is done on {\sl scaled integers\/} that are
multiples
of $2^{-16}$. In other words, a binary point is assumed to be sixteen bit
positions from the right end of a binary computer word.

\Y\P\D \37$\\{unity}\S\O{200000}$\C{$2^{16}$, represents 1.00000}\par
\P\D \37$\\{two}\S\O{400000}$\C{$2^{17}$, represents 2.00000}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{scaled}=\\{integer}$;\C{this type is used for scaled integers}\6
$\\{nonnegative\_integer}=0\to\O{17777777777}$;\C{$0\L x<2^{31}$}\6
$\\{small\_number}=0\to63$;\C{this type is self-explanatory}\par
\fi

\M102. The following function is used to create a scaled integer from a given
decimal
fraction $(.d_0d_1\ldots d_{k-1})$, where $0\L\|k\L17$. The digit $d_i$ is
given in $\\{dig}[\|i]$, and the calculation produces a correctly rounded
result.

\Y\P\4\&{function}\1\  \37$\\{round\_decimals}(\|k:\\{small\_number})$: \37%
\\{scaled};\C{converts a decimal fraction}\6
\4\&{var} \37\|a: \37\\{integer};\C{the accumulator}\2\6
\&{begin} \37$\|a\K0$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\5
$\|a\K(\|a+\\{dig}[\|k]\ast\\{two})\mathbin{\&{div}}10$;\6
\&{end};\2\6
$\\{round\_decimals}\K(\|a+1)\mathbin{\&{div}}2$;\6
\&{end};\par
\fi

\M103. Conversely, here is a procedure analogous to \\{print\_int}. If the
output
of this procedure is subsequently read by \TeX\ and converted by the
\\{round\_decimals} routine above, it turns out that the original value will
be reproduced exactly; the ``simplest'' such decimal number is output,
but there is always at least one digit following the decimal point.

The invariant relation in the \&{repeat} loop is that a sequence of
decimal digits yet to be printed will yield the original number if and only if
they form a fraction~$f$ in the range $s-\delta\L10\cdot2^{16}f<s$.
We can stop if and only if $f=0$ satisfies this condition; the loop will
terminate before $s$ can possibly become zero.

\Y\P\4\&{procedure}\1\  \37$\\{print\_scaled}(\|s:\\{scaled})$;\C{prints scaled
real, rounded to five   digits}\6
\4\&{var} \37\\{delta}: \37\\{scaled};\C{amount of allowable inaccuracy}\2\6
\&{begin} \37\&{if} $\|s<0$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"-"})$;\5
$\\{negate}(\|s)$;\C{print the sign, if negative}\6
\&{end};\2\6
$\\{print\_int}(\|s\mathbin{\&{div}}\\{unity})$;\C{print the integer part}\6
$\\{print\_char}(\.{"."})$;\5
$\|s\K10\ast(\|s\mathbin{\&{mod}}\\{unity})+5$;\5
$\\{delta}\K10$;\6
\1\&{repeat} \37\&{if} $\\{delta}>\\{unity}$ \1\&{then}\5
$\|s\K\|s+\O{100000}-50000$;\C{round the last digit}\2\6
$\\{print\_char}(\.{"0"}+(\|s\mathbin{\&{div}}\\{unity}))$;\5
$\|s\K10\ast(\|s\mathbin{\&{mod}}\\{unity})$;\5
$\\{delta}\K\\{delta}\ast10$;\6
\4\&{until}\5
$\|s\L\\{delta}$;\2\6
\&{end};\par
\fi

\M104. Physical sizes that a \TeX\ user specifies for portions of documents are
represented internally as scaled points. Thus, if we define an `sp' (scaled
point) as a unit equal to $2^{-16}$ printer's points, every dimension
inside of \TeX\ is an integer number of sp. There are exactly
4,736,286.72 sp per inch.  Users are not allowed to specify dimensions
larger than $2^{30}-1$ sp, which is a distance of about 18.892 feet (5.7583
meters); two such quantities can be added without overflow on a 32-bit
computer.

The present implementation of \TeX\ does not check for overflow when
dimensions are added or subtracted. This could be done by inserting a
few dozen tests of the form `\ignorespaces \&{if} $\|x\G\O{10000000000}$ %
\&{then} \hbox{\\{report\_overflow}}', but the chance of overflow is so remote
that
such tests do not seem worthwhile.

\TeX\ needs to do only a few arithmetic operations on scaled quantities,
other than addition and subtraction, and the following subroutines do most of
the work. A single computation might use several subroutine calls, and it is
desirable to avoid producing multiple error messages in case of arithmetic
overflow; so the routines set the global variable \\{arith\_error} to \\{true}
instead of reporting errors directly to the user. Another global variable,
\\{remainder}, holds the remainder after a division.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{arith\_error}: \37\\{boolean};\C{has arithmetic overflow occurred
recently?}\6
\4\\{remainder}: \37\\{scaled};\C{amount subtracted to get an exact division}%
\par
\fi

\M105. The first arithmetical subroutine we need computes $nx+y$, where \|x
and~\|y are \\{scaled} and \|n is an integer. We will also use it to
multiply integers.

\Y\P\D \37$\\{nx\_plus\_y}(\#)\S\\{mult\_and\_add}(\#,\39\O{7777777777})$\par
\P\D \37$\\{mult\_integers}(\#)\S\\{mult\_and\_add}(\#,\390,\39%
\O{17777777777})$\par
\Y\P\4\&{function}\1\  \37$\\{mult\_and\_add}(\|n:\\{integer};\,\35\|x,\39\|y,%
\39\\{max\_answer}:\\{scaled})$: \37\\{scaled};\2\6
\&{begin} \37\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|x)$;\5
$\\{negate}(\|n)$;\6
\&{end};\2\6
\&{if} $\|n=0$ \1\&{then}\5
$\\{mult\_and\_add}\K\|y$\6
\4\&{else} \&{if} $((\|x\L(\\{max\_answer}-\|y)\mathbin{\&{div}}\|n)\W(-\|x\L(%
\\{max\_answer}+\|y)\mathbin{\&{div}}\|n))$ \1\&{then}\5
$\\{mult\_and\_add}\K\|n\ast\|x+\|y$\6
\4\&{else} \&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\\{mult\_and\_add}\K0$;\6
\&{end};\2\2\6
\&{end};\par
\fi

\M106. We also need to divide scaled dimensions by integers.

\Y\P\4\&{function}\1\  \37$\\{x\_over\_n}(\|x:\\{scaled};\,\35\|n:%
\\{integer})$: \37\\{scaled};\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should \\{remainder} be negated?}%
\2\6
\&{begin} \37$\\{negative}\K\\{false}$;\6
\&{if} $\|n=0$ \1\&{then}\6
\&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\\{x\_over\_n}\K0$;\5
$\\{remainder}\K\|x$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|x)$;\5
$\\{negate}(\|n)$;\5
$\\{negative}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|x\G0$ \1\&{then}\6
\&{begin} \37$\\{x\_over\_n}\K\|x\mathbin{\&{div}}\|n$;\5
$\\{remainder}\K\|x\mathbin{\&{mod}}\|n$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{x\_over\_n}\K-((-\|x)\mathbin{\&{div}}\|n)$;\5
$\\{remainder}\K-((-\|x)\mathbin{\&{mod}}\|n)$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\\{remainder})$;\2\6
\&{end};\par
\fi

\M107. Then comes the multiplication of a scaled number by a fraction $\|n/%
\|d$,
where \|n and \|d are nonnegative integers $\L\hbox{$2^{16}$}$ and \|d is
positive. It would be too dangerous to multiply by~\|n and then divide
by~\|d, in separate operations, since overflow might well occur; and it
would be too inaccurate to divide by \|d and then multiply by \|n. Hence
this subroutine simulates 1.5-precision arithmetic.

\Y\P\4\&{function}\1\  \37$\\{xn\_over\_d}(\|x:\\{scaled};\,\35\|n,\39\|d:%
\\{integer})$: \37\\{scaled};\6
\4\&{var} \37\\{positive}: \37\\{boolean};\C{was $\|x\G0$?}\6
$\|t,\39\|u,\39\|v$: \37\\{nonnegative\_integer};\C{intermediate quantities}\2\6
\&{begin} \37\&{if} $\|x\G0$ \1\&{then}\5
$\\{positive}\K\\{true}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|x)$;\5
$\\{positive}\K\\{false}$;\6
\&{end};\2\6
$\|t\K(\|x\mathbin{\&{mod}}\O{100000})\ast\|n$;\5
$\|u\K(\|x\mathbin{\&{div}}\O{100000})\ast\|n+(\|t\mathbin{\&{div}}%
\O{100000})$;\5
$\|v\K(\|u\mathbin{\&{mod}}\|d)\ast\O{100000}+(\|t\mathbin{\&{mod}}%
\O{100000})$;\6
\&{if} $\|u\mathbin{\&{div}}\|d\G\O{100000}$ \1\&{then}\5
$\\{arith\_error}\K\\{true}$\6
\4\&{else} $\|u\K\O{100000}\ast(\|u\mathbin{\&{div}}\|d)+(\|v\mathbin{\&{div}}%
\|d)$;\2\6
\&{if} $\\{positive}$ \1\&{then}\6
\&{begin} \37$\\{xn\_over\_d}\K\|u$;\5
$\\{remainder}\K\|v\mathbin{\&{mod}}\|d$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{xn\_over\_d}\K-\|u$;\5
$\\{remainder}\K-(\|v\mathbin{\&{mod}}\|d)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M108. The next subroutine is used to compute the ``badness'' of glue, when a
total~\|t is supposed to be made from amounts that sum to~\|s.  According
to {\sl The \TeX book}, the badness of this situation is $100(t/s)^3$;
however, badness is simply a heuristic, so we need not squeeze out the
last drop of accuracy when computing it. All we really want is an
approximation that has similar properties.

The actual method used to compute the badness is easier to read from the
program than to describe in words. It produces an integer value that is a
reasonably close approximation to $100(t/s)^3$, and all implementations
of \TeX\ should use precisely this method. Any badness of $2^{13}$ or more is
treated as infinitely bad, and represented by 10000.

It is not difficult to prove that $$\hbox{$\\{badness}(\|t+1,\|s)\G\\{badness}(%
\|t,\|s)\G\\{badness}(\|t,\|s+1)$}.$$ The badness function defined here is
capable of
computing at most 1095 distinct values, but that is plenty.

\Y\P\D \37$\\{inf\_bad}=10000$\C{infinitely bad value}\par
\Y\P\4\&{function}\1\  \37$\\{badness}(\|t,\39\|s:\\{scaled})$: \37%
\\{halfword};\C{compute badness, given $\|t\G0$}\6
\4\&{var} \37\|r: \37\\{integer};\C{approximation to $\alpha t/s$, where $%
\alpha^3\approx   100\cdot2^{18}$}\2\6
\&{begin} \37\&{if} $\|t=0$ \1\&{then}\5
$\\{badness}\K0$\6
\4\&{else} \&{if} $\|s\L0$ \1\&{then}\5
$\\{badness}\K\\{inf\_bad}$\6
\4\&{else} \&{begin} \37\&{if} $\|t\L7230584$ \1\&{then}\5
$\|r\K(\|t\ast297)\mathbin{\&{div}}\|s$\C{$297^3=99.94\times2^{18}$}\6
\4\&{else} \&{if} $\|s\G1663497$ \1\&{then}\5
$\|r\K\|t\mathbin{\&{div}}(\|s\mathbin{\&{div}}297)$\6
\4\&{else} $\|r\K\|t$;\2\2\6
\&{if} $\|r>1290$ \1\&{then}\5
$\\{badness}\K\\{inf\_bad}$\C{$1290^3<2^{31}<1291^3$}\6
\4\&{else} $\\{badness}\K(\|r\ast\|r\ast\|r+\O{400000})\mathbin{\&{div}}%
\O{1000000}$;\2\6
\&{end};\C{that was $r^3/2^{18}$, rounded to the nearest integer}\2\2\6
\&{end};\par
\fi

\M109. When \TeX\ ``packages'' a list into a box, it needs to calculate the
proportionality ratio by which the glue inside the box should stretch
or shrink. This calculation does not affect \TeX's decision making,
so the precise details of rounding, etc., in the glue calculation are not
of critical importance for the consistency of results on different computers.

We shall use the type \\{glue\_ratio} for such proportionality ratios.
A glue ratio should take the same amount of memory as an
\\{integer} (usually 32 bits) if it is to blend smoothly with \TeX's
other data structures. Thus \\{glue\_ratio} should be equivalent to
\\{short\_real} in some implementations of \PASCAL. Alternatively,
it is possible to deal with glue ratios using nothing but fixed-point
arithmetic; see {\sl TUGboat \bf3},1 (March 1982), 10--27. (But the
routines cited there must be modified to allow negative glue ratios.)

\Y\P\D \37$\\{set\_glue\_ratio\_zero}(\#)\S\#\K0.0$\C{store the representation
of zero ratio}\par
\P\D \37$\\{set\_glue\_ratio\_one}(\#)\S\#\K1.0$\C{store the representation of
unit ratio}\par
\P\D \37$\\{float}(\#)\S\#$\C{convert from \\{glue\_ratio} to type \\{real}}\par
\P\D \37$\\{unfloat}(\#)\S\#$\C{convert from \\{real} to type \\{glue\_ratio}}%
\par
\P\D \37$\\{float\_constant}(\#)\S\#.0$\C{convert \\{integer} constant to %
\\{real}}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{glue\_ratio}=\\{real}$;\C{one-word representation of a glue expansion
factor}\par
\fi

\N110.  \[7b] Random numbers.
%
\font\tenlogo=logo10 % font used for the METAFONT logo
\def\MP{{\tenlogo META}\-{\tenlogo POST}}
%
This section is (almost) straight from \MP. I had to change
the types (use \\{integer} instead of \\{fraction}), but that should
not have any influence on the actual calculations (the original
comments refer to quantities like \\{fraction\_four} ($2^{30}$), and
that is the same as the numeric representation of \\{maxdimen}).

I've copied the low-level variables and routines that are needed, but
only those (e.g.~\\{m\_log}), not the accompanying ones like \\{m\_exp}. Most
of the following low-level numeric routines are only needed within the
calculation of \\{norm\_rand}. I've been forced to rename \\{make\_fraction}
to \\{make\_frac} because TeX already has a routine by that name with
a wholly different function (it creates a \\{fraction\_noad} for math
typesetting) -- Taco.

And now let's complete our collection of numeric utility routines
by considering random number generation.
\MP\ generates pseudo-random numbers with the additive scheme recommended
in Section 3.6 of {\sl The Art of Computer Programming}; however, the
results are random fractions between 0 and $\\{fraction\_one}-1$, inclusive.

There's an auxiliary array \\{randoms} that contains 55 pseudo-random
fractions. Using the recurrence $x_n=(x_{n-55}-x_{n-31})\bmod 2^{28}$,
we generate batches of 55 new $x_n$'s at a time by calling \\{new\_randoms}.
The global variable \\{j\_random} tells which element has most recently
been consumed.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{randoms}: \37\&{array} $[0\to54]$ \1\&{of}\5
\\{integer};\C{the last 55 random values generated}\2\6
\4\\{j\_random}: \37$0\to54$;\C{the number of unused \\{randoms}}\6
\4\\{random\_seed}: \37\\{scaled};\C{the default random seed}\par
\fi

\M111. A small bit of \MF\ is needed.

\Y\P\D \37$\\{fraction\_half}\S\O{1000000000}$\C{$2^{27}$, represents
0.50000000}\par
\P\D \37$\\{fraction\_one}\S\O{2000000000}$\C{$2^{28}$, represents 1.00000000}%
\par
\P\D \37$\\{fraction\_four}\S\O{10000000000}$\C{$2^{30}$, represents
4.00000000}\par
\P\D \37$\\{el\_gordo}\S\O{17777777777}$\C{$2^{31}-1$, the largest value that %
\MP\ likes}\par
\P\D \37$\\{halfp}(\#)\S(\#)\mathbin{\&{div}}2$\par
\P\D \37$\\{double}(\#)\S\#\K\#+\#$\C{multiply a variable by two}\par
\fi

\M112. The \\{make\_frac} routine produces the \\{fraction} equivalent of
$\|p/\|q$, given integers \|p and~\|q; it computes the integer
$f=\lfloor2^{28}p/q+{1\over2}\rfloor$, when $p$ and $q$ are
positive. If \|p and \|q are both of the same scaled type \|t,
the ``type relation'' $\\{make\_frac}(\|t,\|t)=\\{fraction}$ is valid;
and it's also possible to use the subroutine ``backwards,'' using
the relation $\\{make\_frac}(\|t,\\{fraction})=\|t$ between scaled types.

If the result would have magnitude $2^{31}$ or more, \\{make\_frac}
sets $\\{arith\_error}\K\\{true}$. Most of \MP's internal computations have
been designed to avoid this sort of error.

If this subroutine were programmed in assembly language on a typical
machine, we could simply compute $(\hbox{$2^{28}$}\ast\|p)\mathbin{\&{div}}%
\|q$, since a
double-precision product can often be input to a fixed-point division
instruction. But when we are restricted to \PASCAL\ arithmetic it
is necessary either to resort to multiple-precision maneuvering
or to use a simple but slow iteration. The multiple-precision technique
would be about three times faster than the code adopted here, but it
would be comparatively long and tricky, involving about sixteen
additional multiplications and divisions.

This operation is part of \MP's ``inner loop''; indeed, it will
consume nearly 10\pct! of the running time (exclusive of input and output)
if the code below is left unchanged. A machine-dependent recoding
will therefore make \MP\ run faster. The present implementation
is highly portable, but slow; it avoids multiplication and division
except in the initial stage. System wizards should be careful to
replace it with a routine that is guaranteed to produce identical
results in all cases.

As noted below, a few more routines should also be replaced by
machine-dependent
code, for efficiency. But when a procedure is not part of the ``inner loop,''
such changes aren't advisable; simplicity and robustness are
preferable to trickery, unless the cost is too high.

\Y\P\4\&{function}\1\  \37$\\{make\_frac}(\|p,\39\|q:\\{integer})$: \37%
\\{integer};\6
\4\&{var} \37\|f: \37\\{integer};\C{the fraction bits, with a leading 1 bit}\6
\|n: \37\\{integer};\C{the integer part of $\vert p/q\vert$}\6
\\{negative}: \37\\{boolean};\C{should the result be negated?}\6
\\{be\_careful}: \37\\{integer};\C{disables certain compiler optimizations}\2\6
\&{begin} \37\&{if} $\|p\G0$ \1\&{then}\5
$\\{negative}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|p)$;\5
$\\{negative}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|q\L0$ \1\&{then}\6
\&{begin} \37\&{debug} \37\&{if} $\|q=0$ \1\&{then}\5
$\\{confusion}(\.{"/"})$;\2\ \&{gubed}\6
$\\{negate}(\|q)$;\5
$\\{negative}\K\R\\{negative}$;\6
\&{end};\2\6
$\|n\K\|p\mathbin{\&{div}}\|q$;\5
$\|p\K\|p\mathbin{\&{mod}}\|q$;\6
\&{if} $\|n\G8$ \1\&{then}\6
\&{begin} \37$\\{arith\_error}\K\\{true}$;\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{make\_frac}\K-\\{el\_gordo}$\ \&{else} $\\{make\_frac}\K\\{el\_gordo}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|n\K(\|n-1)\ast\\{fraction\_one}$;\5
\X113:Compute $f=\lfloor 2^{28}(1+p/q)+{1\over2}\rfloor$\X;\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{make\_frac}\K-(\|f+\|n)$\ \&{else} $\\{make\_frac}\K\|f+\|n$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M113. The  \&{repeat}  loop here preserves the following invariant relations
between \|f, \|p, and~\|q:
(i)~$0\L\|p<\|q$; (ii)~$fq+p=2^k(q+p_0)$, where $k$ is an integer and
$p_0$ is the original value of~$p$.

Notice that the computation specifies
$(\|p-\|q)+\|p$ instead of $(\|p+\|p)-\|q$, because the latter could overflow.
Let us hope that optimizing compilers do not miss this point; a
special variable \\{be\_careful} is used to emphasize the necessary
order of computation. Optimizing compilers should keep \\{be\_careful}
in a register, not store it in memory.

\Y\P$\4\X113:Compute $f=\lfloor 2^{28}(1+p/q)+{1\over2}\rfloor$\X\S$\6
$\|f\K1$;\6
\1\&{repeat} \37$\\{be\_careful}\K\|p-\|q$;\5
$\|p\K\\{be\_careful}+\|p$;\6
\&{if} $\|p\G0$ \1\&{then}\5
$\|f\K\|f+\|f+1$\6
\4\&{else} \&{begin} \37$\\{double}(\|f)$;\5
$\|p\K\|p+\|q$;\6
\&{end};\2\6
\4\&{until}\5
$\|f\G\\{fraction\_one}$;\2\6
$\\{be\_careful}\K\|p-\|q$;\6
\&{if} $\\{be\_careful}+\|p\G0$ \1\&{then}\5
$\\{incr}(\|f)$\2\par
\U112.\fi

\M114.

\Y\P\4\&{function}\1\  \37$\\{take\_frac}(\|q:\\{integer};\,\35\|f:%
\\{integer})$: \37\\{integer};\6
\4\&{var} \37\|p: \37\\{integer};\C{the fraction so far}\6
\\{negative}: \37\\{boolean};\C{should the result be negated?}\6
\|n: \37\\{integer};\C{additional multiple of $q$}\6
\\{be\_careful}: \37\\{integer};\C{disables certain compiler optimizations}\2\6
\&{begin} \37\X115:Reduce to the case that $\|f\G0$ and $\|q>0$\X;\6
\&{if} $\|f<\\{fraction\_one}$ \1\&{then}\5
$\|n\K0$\6
\4\&{else} \&{begin} \37$\|n\K\|f\mathbin{\&{div}}\\{fraction\_one}$;\5
$\|f\K\|f\mathbin{\&{mod}}\\{fraction\_one}$;\6
\&{if} $\|q\L\\{el\_gordo}\mathbin{\&{div}}\|n$ \1\&{then}\5
$\|n\K\|n\ast\|q$\6
\4\&{else} \&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\|n\K\\{el\_gordo}$;\6
\&{end};\2\6
\&{end};\2\6
$\|f\K\|f+\\{fraction\_one}$;\5
\X116:Compute $p=\lfloor qf/2^{28}+{1\over2}\rfloor-q$\X;\6
$\\{be\_careful}\K\|n-\\{el\_gordo}$;\6
\&{if} $\\{be\_careful}+\|p>0$ \1\&{then}\6
\&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\|n\K\\{el\_gordo}-\|p$;\6
\&{end};\2\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{take\_frac}\K-(\|n+\|p)$\6
\4\&{else} $\\{take\_frac}\K\|n+\|p$;\2\6
\&{end};\par
\fi

\M115. \P$\X115:Reduce to the case that $\|f\G0$ and $\|q>0$\X\S$\6
\&{if} $\|f\G0$ \1\&{then}\5
$\\{negative}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|f)$;\5
$\\{negative}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|q<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|q)$;\5
$\\{negative}\K\R\\{negative}$;\6
\&{end};\2\par
\U114.\fi

\M116. The invariant relations in this case are (i)~$\lfloor(qf+p)/2^k\rfloor
=\lfloor qf_0/2^{28}+{1\over2}\rfloor$, where $k$ is an integer and
$f_0$ is the original value of~$f$; (ii)~$2^k\L f<2^{k+1}$.

\Y\P$\4\X116:Compute $p=\lfloor qf/2^{28}+{1\over2}\rfloor-q$\X\S$\6
$\|p\K\\{fraction\_half}$;\C{that's $2^{27}$; the invariants hold now with
$k=28$}\6
\&{if} $\|q<\\{fraction\_four}$ \1\&{then}\6
\1\&{repeat} \37\&{if} $\\{odd}(\|f)$ \1\&{then}\5
$\|p\K\\{halfp}(\|p+\|q)$\ \&{else} $\|p\K\\{halfp}(\|p)$;\2\6
$\|f\K\\{halfp}(\|f)$;\6
\4\&{until}\5
$\|f=1$\2\6
\4\&{else} \1\&{repeat} \37\&{if} $\\{odd}(\|f)$ \1\&{then}\5
$\|p\K\|p+\\{halfp}(\|q-\|p)$\ \&{else} $\|p\K\\{halfp}(\|p)$;\2\6
$\|f\K\\{halfp}(\|f)$;\6
\4\&{until}\5
$\|f=1$\2\2\par
\U114.\fi

\M117. The subroutines for logarithm and exponential involve two tables.
The first is simple: $\\{two\_to\_the}[\|k]$ equals $2^k$. The second involves
a bit more calculation, which the author claims to have done correctly:
$\\{spec\_log}[\|k]$ is $2^{27}$ times $\ln\bigl(1/(1-2^{-k})\bigr)=
2^{-k}+{1\over2}2^{-2k}+{1\over3}2^{-3k}+\cdots\,$, rounded to the
nearest integer.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{two\_to\_the}: \37\&{array} $[0\to30]$ \1\&{of}\5
\\{integer};\C{powers of two}\2\6
\4\\{spec\_log}: \37\&{array} $[1\to28]$ \1\&{of}\5
\\{integer};\C{special logarithms}\2\par
\fi

\M118. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{two\_to\_the}[0]\K1$;\6
\&{for} $\|k\K1\mathrel{\&{to}}30$ \1\&{do}\5
$\\{two\_to\_the}[\|k]\K2\ast\\{two\_to\_the}[\|k-1]$;\2\6
$\\{spec\_log}[1]\K93032640$;\5
$\\{spec\_log}[2]\K38612034$;\5
$\\{spec\_log}[3]\K17922280$;\5
$\\{spec\_log}[4]\K8662214$;\5
$\\{spec\_log}[5]\K4261238$;\5
$\\{spec\_log}[6]\K2113709$;\5
$\\{spec\_log}[7]\K1052693$;\5
$\\{spec\_log}[8]\K525315$;\5
$\\{spec\_log}[9]\K262400$;\5
$\\{spec\_log}[10]\K131136$;\5
$\\{spec\_log}[11]\K65552$;\5
$\\{spec\_log}[12]\K32772$;\5
$\\{spec\_log}[13]\K16385$;\6
\&{for} $\|k\K14\mathrel{\&{to}}27$ \1\&{do}\5
$\\{spec\_log}[\|k]\K\\{two\_to\_the}[27-\|k]$;\2\6
$\\{spec\_log}[28]\K1$;\par
\fi

\M119.

\Y\P\4\&{function}\1\  \37$\\{m\_log}(\|x:\\{integer})$: \37\\{integer};\6
\4\&{var} \37$\|y,\39\|z$: \37\\{integer};\C{auxiliary registers}\6
\|k: \37\\{integer};\C{iteration counter}\2\6
\&{begin} \37\&{if} $\|x\L0$ \1\&{then}\5
\X121:Handle non-positive logarithm\X\6
\4\&{else} \&{begin} \37$\|y\K1302456956+4-100$;\C{$14\times2^{27}\ln2%
\approx1302456956.421063$}\6
$\|z\K27595+6553600$;\C{and $2^{16}\times .421063\approx 27595$}\6
\&{while} $\|x<\\{fraction\_four}$ \1\&{do}\6
\&{begin} \37$\\{double}(\|x)$;\5
$\|y\K\|y-93032639$;\5
$\|z\K\|z-48782$;\6
\&{end};\C{$2^{27}\ln2\approx 93032639.74436163$       and $2^{16}%
\times.74436163\approx 48782$}\2\6
$\|y\K\|y+(\|z\mathbin{\&{div}}\\{unity})$;\5
$\|k\K2$;\6
\&{while} $\|x>\\{fraction\_four}+4$ \1\&{do}\5
\X120:Increase \|k until \|x can be multiplied by a factor of $2^{-k}$, and
adjust $y$ accordingly\X;\2\6
$\\{m\_log}\K\|y\mathbin{\&{div}}8$;\6
\&{end};\2\6
\&{end};\par
\fi

\M120. \P$\X120:Increase \|k until \|x can be multiplied by a factor of
$2^{-k}$, and adjust $y$ accordingly\X\S$\6
\&{begin} \37$\|z\K((\|x-1)\mathbin{\&{div}}\\{two\_to\_the}[\|k])+1$;\C{$z=%
\lceil x/2^k\rceil$}\6
\&{while} $\|x<\\{fraction\_four}+\|z$ \1\&{do}\6
\&{begin} \37$\|z\K\\{halfp}(\|z+1)$;\5
$\|k\K\|k+1$;\6
\&{end};\2\6
$\|y\K\|y+\\{spec\_log}[\|k]$;\5
$\|x\K\|x-\|z$;\6
\&{end}\par
\U119.\fi

\M121. \P$\X121:Handle non-positive logarithm\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Logarithm\ of\ "})$;\5
$\\{print\_scaled}(\|x)$;\5
$\\{print}(\.{"\ has\ been\ replaced\ by\ 0"})$;\5
$\\{help2}(\.{"Since\ I\ don\'t\ take\ logs\ of\ non-positive\ numbers,"})$\6
$(\.{"I\'m\ zeroing\ this\ one.\ Proceed,\ with\ fingers\ crossed."})$;\5
\\{error};\5
$\\{m\_log}\K0$;\6
\&{end}\par
\U119.\fi

\M122. The following somewhat different subroutine tests rigorously if $ab$ is
greater than, equal to, or less than~$cd$,
given integers $(a,b,c,d)$. In most cases a quick decision is reached.
The result is $+1$, 0, or~$-1$ in the three respective cases.

\Y\P\D \37$\\{return\_sign}(\#)\S$\1\6
\&{begin} \37$\\{ab\_vs\_cd}\K\#$;\5
\&{return};\6
\&{end}\2\par
\Y\P\4\&{function}\1\  \37$\\{ab\_vs\_cd}(\|a,\39\|b,\39\|c,\39\|d:%
\\{integer})$: \37\\{integer};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37$\|q,\39\|r$: \37\\{integer};\C{temporary registers}\2\6
\&{begin} \37\X123:Reduce to the case that $\|a,\|c\G0$, $\|b,\|d>0$\X;\6
\~ \1\&{loop}\ \&{begin} \37$\|q\K\|a\mathbin{\&{div}}\|d$;\5
$\|r\K\|c\mathbin{\&{div}}\|b$;\6
\&{if} $\|q\I\|r$ \1\&{then}\6
\&{if} $\|q>\|r$ \1\&{then}\5
$\\{return\_sign}(1)$\ \&{else} $\\{return\_sign}(-1)$;\2\2\6
$\|q\K\|a\mathbin{\&{mod}}\|d$;\5
$\|r\K\|c\mathbin{\&{mod}}\|b$;\6
\&{if} $\|r=0$ \1\&{then}\6
\&{if} $\|q=0$ \1\&{then}\5
$\\{return\_sign}(0)$\ \&{else} $\\{return\_sign}(1)$;\2\2\6
\&{if} $\|q=0$ \1\&{then}\5
$\\{return\_sign}(-1)$;\2\6
$\|a\K\|b$;\5
$\|b\K\|q$;\5
$\|c\K\|d$;\5
$\|d\K\|r$;\6
\&{end};\C{now $\|a>\|d>0$ and $\|c>\|b>0$}\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M123. \P$\X123:Reduce to the case that $\|a,\|c\G0$, $\|b,\|d>0$\X\S$\6
\&{if} $\|a<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|a)$;\5
$\\{negate}(\|b)$;\6
\&{end};\2\6
\&{if} $\|c<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|c)$;\5
$\\{negate}(\|d)$;\6
\&{end};\2\6
\&{if} $\|d\L0$ \1\&{then}\6
\&{begin} \37\&{if} $\|b\G0$ \1\&{then}\6
\&{if} $((\|a=0)\V(\|b=0))\W((\|c=0)\V(\|d=0))$ \1\&{then}\5
$\\{return\_sign}(0)$\6
\4\&{else} $\\{return\_sign}(1)$;\2\2\6
\&{if} $\|d=0$ \1\&{then}\6
\&{if} $\|a=0$ \1\&{then}\5
$\\{return\_sign}(0)$\ \&{else} $\\{return\_sign}(-1)$;\2\2\6
$\|q\K\|a$;\5
$\|a\K\|c$;\5
$\|c\K\|q$;\5
$\|q\K-\|b$;\5
$\|b\K-\|d$;\5
$\|d\K\|q$;\6
\&{end}\6
\4\&{else} \&{if} $\|b\L0$ \1\&{then}\6
\&{begin} \37\&{if} $\|b<0$ \1\&{then}\6
\&{if} $\|a>0$ \1\&{then}\5
$\\{return\_sign}(-1)$;\2\2\6
\&{if} $\|c=0$ \1\&{then}\5
$\\{return\_sign}(0)$\6
\4\&{else} $\\{return\_sign}(-1)$;\2\6
\&{end}\2\2\par
\U122.\fi

\M124. To consume a random integer, the program below will say `\\{next%
\_random}'
and then it will fetch $\\{randoms}[\\{j\_random}]$.

\Y\P\D \37$\\{next\_random}\S$\1\6
\&{if} $\\{j\_random}=0$ \1\&{then}\5
\\{new\_randoms}\6
\4\&{else} $\\{decr}(\\{j\_random})$\2\2\par
\Y\P\4\&{procedure}\1\  \37\\{new\_randoms};\6
\4\&{var} \37\|k: \37$0\to54$;\C{index into \\{randoms}}\6
\|x: \37\\{integer};\C{accumulator}\2\6
\&{begin} \37\&{for} $\|k\K0\mathrel{\&{to}}23$ \1\&{do}\6
\&{begin} \37$\|x\K\\{randoms}[\|k]-\\{randoms}[\|k+31]$;\6
\&{if} $\|x<0$ \1\&{then}\5
$\|x\K\|x+\\{fraction\_one}$;\2\6
$\\{randoms}[\|k]\K\|x$;\6
\&{end};\2\6
\&{for} $\|k\K24\mathrel{\&{to}}54$ \1\&{do}\6
\&{begin} \37$\|x\K\\{randoms}[\|k]-\\{randoms}[\|k-24]$;\6
\&{if} $\|x<0$ \1\&{then}\5
$\|x\K\|x+\\{fraction\_one}$;\2\6
$\\{randoms}[\|k]\K\|x$;\6
\&{end};\2\6
$\\{j\_random}\K54$;\6
\&{end};\par
\fi

\M125. To initialize the \\{randoms} table, we call the following routine.

\Y\P\4\&{procedure}\1\  \37$\\{init\_randoms}(\\{seed}:\\{integer})$;\6
\4\&{var} \37$\|j,\39\\{jj},\39\|k$: \37\\{integer};\C{more or less random
integers}\6
\|i: \37$0\to54$;\C{index into \\{randoms}}\2\6
\&{begin} \37$\|j\K\\{abs}(\\{seed})$;\6
\&{while} $\|j\G\\{fraction\_one}$ \1\&{do}\5
$\|j\K\\{halfp}(\|j)$;\2\6
$\|k\K1$;\6
\&{for} $\|i\K0\mathrel{\&{to}}54$ \1\&{do}\6
\&{begin} \37$\\{jj}\K\|k$;\5
$\|k\K\|j-\|k$;\5
$\|j\K\\{jj}$;\6
\&{if} $\|k<0$ \1\&{then}\5
$\|k\K\|k+\\{fraction\_one}$;\2\6
$\\{randoms}[(\|i\ast21)\mathbin{\&{mod}}55]\K\|j$;\6
\&{end};\2\6
\\{new\_randoms};\5
\\{new\_randoms};\5
\\{new\_randoms};\C{``warm up'' the array}\6
\&{end};\par
\fi

\M126. To produce a uniform random number in the range $0\L\|u<\|x$ or $0\G\|u>%
\|x$
or $0=\|u=\|x$, given a \\{scaled} value~\|x, we proceed as shown here.

Note that the call of \\{take\_frac} will produce the values 0 and~\|x
with about half the probability that it will produce any other particular
values between 0 and~\|x, because it rounds its answers.

\Y\P\4\&{function}\1\  \37$\\{unif\_rand}(\|x:\\{integer})$: \37\\{integer};\6
\4\&{var} \37\|y: \37\\{integer};\C{trial value}\2\6
\&{begin} \37\\{next\_random};\5
$\|y\K\\{take\_frac}(\\{abs}(\|x),\39\\{randoms}[\\{j\_random}])$;\6
\&{if} $\|y=\\{abs}(\|x)$ \1\&{then}\5
$\\{unif\_rand}\K0$\6
\4\&{else} \&{if} $\|x>0$ \1\&{then}\5
$\\{unif\_rand}\K\|y$\6
\4\&{else} $\\{unif\_rand}\K-\|y$;\2\2\6
\&{end};\par
\fi

\M127. Finally, a normal deviate with mean zero and unit standard deviation
can readily be obtained with the ratio method (Algorithm 3.4.1R in
{\sl The Art of Computer Programming\/}).

\Y\P\4\&{function}\1\  \37\\{norm\_rand}: \37\\{integer};\6
\4\&{var} \37$\|x,\39\|u,\39\|l$: \37\\{integer};\C{what the book would call
$2^{16}X$, $2^{28}U$,   and $-2^{24}\ln U$}\2\6
\&{begin} \37\1\&{repeat} \37\1\&{repeat} \37\\{next\_random};\5
$\|x\K\\{take\_frac}(112429,\39\\{randoms}[\\{j\_random}]-\\{fraction\_half})$;%
\C{$2^{16}\sqrt{8/e}\approx 112428.82793$}\6
\\{next\_random};\5
$\|u\K\\{randoms}[\\{j\_random}]$;\6
\4\&{until}\5
$\\{abs}(\|x)<\|u$;\2\6
$\|x\K\\{make\_frac}(\|x,\39\|u)$;\5
$\|l\K139548960-\\{m\_log}(\|u)$;\C{$2^{24}\cdot12\ln2\approx139548959.6165$}\6
\4\&{until}\5
$\\{ab\_vs\_cd}(1024,\39\|l,\39\|x,\39\|x)\G0$;\2\6
$\\{norm\_rand}\K\|x$;\6
\&{end};\par
\fi

\N128.  \[8] Packed data.
In order to make efficient use of storage space, \TeX\ bases its major data
structures on a \\{memory\_word}, which contains either a (signed) integer,
possibly scaled, or a (signed) \\{glue\_ratio}, or a small number of
fields that are one half or one quarter of the size used for storing
integers.

If \|x is a variable of type \\{memory\_word}, it contains up to four
fields that can be referred to as follows:
$$\vbox{\halign{\hfil#&#\hfil&#\hfil\cr
\|x&.\\{int}&(an \\{integer})\cr
\|x&.\\{sc}\qquad&(a \\{scaled} integer)\cr
\|x&.\\{gr}&(a \\{glue\_ratio})\cr
\|x.\\{hh}.\\{lh}, \|x.\\{hh}&.\\{rh}&(two halfword fields)\cr
\|x.\\{hh}.\\{b0}, \|x.\\{hh}.\\{b1}, \|x.\\{hh}&.\\{rh}&(two quarterword
fields, one halfword
field)\cr
\|x.\\{qqqq}.\\{b0}, \|x.\\{qqqq}.\\{b1}, \|x.\\{qqqq}&.\\{b2}, \|x.\\{qqqq}.%
\\{b3}\hskip-100pt
&\qquad\qquad\qquad(four quarterword fields)\cr}}$$
This is somewhat cumbersome to write, and not very readable either, but
macros will be used to make the notation shorter and more transparent.
The \PASCAL\ code below gives a formal definition of \\{memory\_word} and
its subsidiary types, using packed variant records. \TeX\ makes no
assumptions about the relative positions of the fields within a word.

Since we are assuming 32-bit integers, a halfword must contain at least
16 bits, and a quarterword must contain at least 8 bits.
But it doesn't hurt to have more bits; for example, with enough 36-bit
words you might be able to have \\{mem\_max} as large as 262142, which is
eight times as much memory as anybody had during the first four years of
\TeX's existence.

N.B.: Valuable memory space will be dreadfully wasted unless \TeX\ is compiled
by a \PASCAL\ that packs all of the \\{memory\_word} variants into
the space of a single integer. This means, for example, that \\{glue\_ratio}
words should be \\{short\_real} instead of \\{real} on some computers. Some
\PASCAL\ compilers will pack an integer whose subrange is `$0\to255$' into
an eight-bit field, but others insist on allocating space for an additional
sign bit; on such systems you can get 256 values into a quarterword only
if the subrange is `$-128\to127$'.

The present implementation tries to accommodate as many variations as possible,
so it makes few assumptions. If integers having the subrange
`$\\{min\_quarterword}\to\\{max\_quarterword}$' can be packed into a
quarterword,
and if integers having the subrange `$\\{min\_halfword}\to\\{max\_halfword}$'
can be packed into a halfword, everything should work satisfactorily.

It is usually most efficient to have $\\{min\_quarterword}=\\{min%
\_halfword}=0$,
so one should try to achieve this unless it causes a severe problem.
The values defined here are recommended for most 32-bit computers.

\Y\P\D \37$\\{min\_quarterword}=0$\C{smallest allowable value in a %
\\{quarterword}}\par
\P\D \37$\\{max\_quarterword}=255$\C{largest allowable value in a %
\\{quarterword}}\par
\P\D \37$\\{min\_halfword}\S0$\C{smallest allowable value in a \\{halfword}}\par
\P\D \37$\\{max\_halfword}\S65535$\C{largest allowable value in a \\{halfword}}%
\par
\fi

\M129. Here are the inequalities that the quarterword and halfword values
must satisfy (or rather, the inequalities that they mustn't satisfy):

\Y\P$\4\X14:Check the ``constant'' values for consistency\X\mathrel{+}\S$\6
\&{init} \37\&{if} $(\\{mem\_min}\I\\{mem\_bot})\V(\\{mem\_max}\I\\{mem\_top})$
\1\&{then}\5
$\\{bad}\K10$;\ \2\6
\&{tini}\6
\&{if} $(\\{mem\_min}>\\{mem\_bot})\V(\\{mem\_max}<\\{mem\_top})$ \1\&{then}\5
$\\{bad}\K10$;\2\6
\&{if} $(\\{min\_quarterword}>0)\V(\\{max\_quarterword}<127)$ \1\&{then}\5
$\\{bad}\K11$;\2\6
\&{if} $(\\{min\_halfword}>0)\V(\\{max\_halfword}<32767)$ \1\&{then}\5
$\\{bad}\K12$;\2\6
\&{if} $(\\{min\_quarterword}<\\{min\_halfword})\V\30(\\{max\_quarterword}>%
\\{max\_halfword})$ \1\&{then}\5
$\\{bad}\K13$;\2\6
\&{if} $(\\{mem\_min}<\\{min\_halfword})\V(\\{mem\_max}\G\\{max\_halfword})\V%
\30(\\{mem\_bot}-\\{mem\_min}>\\{max\_halfword}+1)$ \1\&{then}\5
$\\{bad}\K14$;\2\6
\&{if} $(\\{font\_base}<\\{min\_quarterword})\V(\\{font\_max}>\\{max%
\_quarterword})$ \1\&{then}\5
$\\{bad}\K15$;\2\6
\&{if} $\\{font\_max}>\\{font\_base}+256$ \1\&{then}\5
$\\{bad}\K16$;\2\6
\&{if} $(\\{save\_size}>\\{max\_halfword})\V(\\{max\_strings}>\\{max%
\_halfword})$ \1\&{then}\5
$\\{bad}\K17$;\2\6
\&{if} $\\{buf\_size}>\\{max\_halfword}$ \1\&{then}\5
$\\{bad}\K18$;\2\6
\&{if} $\\{max\_quarterword}-\\{min\_quarterword}<255$ \1\&{then}\5
$\\{bad}\K19$;\2\par
\fi

\M130. The operation of adding or subtracting \\{min\_quarterword} occurs quite
frequently in \TeX, so it is convenient to abbreviate this operation
by using the macros \\{qi} and \\{qo} for input and output to and from
quarterword format.

The inner loop of \TeX\ will run faster with respect to compilers
that don't optimize expressions like `$\|x+0$' and `$\|x-0$', if these
macros are simplified in the obvious way when $\\{min\_quarterword}=0$.

\Y\P\D \37$\\{qi}(\#)\S\#+\\{min\_quarterword}$\C{to put an \\{eight\_bits}
item into a quarterword}\par
\P\D \37$\\{qo}(\#)\S\#-\\{min\_quarterword}$\C{to take an \\{eight\_bits} item
out of a quarterword}\par
\P\D \37$\\{hi}(\#)\S\#+\\{min\_halfword}$\C{to put a sixteen-bit item into a
halfword}\par
\P\D \37$\\{ho}(\#)\S\#-\\{min\_halfword}$\C{to take a sixteen-bit item from a
halfword}\par
\fi

\M131. The reader should study the following definitions closely:

\Y\P\D \37$\\{sc}\S\\{int}$\C{\\{scaled} data is equivalent to \\{integer}}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{quarterword}=\\{min\_quarterword}\to\\{max\_quarterword}$;\C{1/4 of a word}%
\6
$\\{halfword}=\\{min\_halfword}\to\\{max\_halfword}$;\C{1/2 of a word}\6
$\\{two\_choices}=1\to2$;\C{used when there are two variants in a record}\6
$\\{four\_choices}=1\to4$;\C{used when there are four variants in a record}\6
$\\{two\_halves}=$\1\5
\&{packed} \37\1\&{record} \37\\{rh}: \37\\{halfword};\2\6
\&{case} $\\{two\_choices}$ \1\&{of}\6
\41: \37$(\\{lh}:\\{halfword})$;\6
\42: \37$(\\{b0}:\\{quarterword};\,\35\\{b1}:\\{quarterword})$;\2\6
\&{end};\2\6
$\\{four\_quarters}=$\1\5
\&{packed} \37\1\&{record} \37\\{b0}: \37\\{quarterword};\6
\4\\{b1}: \37\\{quarterword};\6
\4\\{b2}: \37\\{quarterword};\6
\4\\{b3}: \37\\{quarterword};\2\6
\&{end};\2\6
$\\{memory\_word}=$\1\5
\1\&{record} \37\2\6
\&{case} $\\{four\_choices}$ \1\&{of}\6
\41: \37$(\\{int}:\\{integer})$;\6
\42: \37$(\\{gr}:\\{glue\_ratio})$;\6
\43: \37$(\\{hh}:\\{two\_halves})$;\6
\44: \37$(\\{qqqq}:\\{four\_quarters})$;\2\6
\&{end};\2\6
$\\{word\_file}=$\1\5
\&{file} \1\&{of}\5
\\{memory\_word};\2\2\par
\fi

\M132. When debugging, we may want to print a \\{memory\_word} without knowing
what type it is; so we print it in all modes.

\Y\P\&{debug} \37\&{procedure}\1\  \37$\\{print\_word}(\|w:\\{memory\_word})$;%
\C{prints \|w in all ways}\2\6
\&{begin} \37$\\{print\_int}(\|w.\\{int})$;\5
$\\{print\_char}(\.{"\ "})$;\6
$\\{print\_scaled}(\|w.\\{sc})$;\5
$\\{print\_char}(\.{"\ "})$;\6
$\\{print\_scaled}(\\{round}(\\{unity}\ast\\{float}(\|w.\\{gr})))$;\5
\\{print\_ln};\6
$\\{print\_int}(\|w.\\{hh}.\\{lh})$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_int}(\|w.\\{hh}.\\{b0})$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_int}(\|w.\\{hh}.\\{b1})$;\5
$\\{print\_char}(\.{";"})$;\5
$\\{print\_int}(\|w.\\{hh}.\\{rh})$;\5
$\\{print\_char}(\.{"\ "})$;\6
$\\{print\_int}(\|w.\\{qqqq}.\\{b0})$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_int}(\|w.\\{qqqq}.\\{b1})$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_int}(\|w.\\{qqqq}.\\{b2})$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_int}(\|w.\\{qqqq}.\\{b3})$;\6
\&{end};\6
\&{gubed}\par
\fi

\N133.  \[9] Dynamic memory allocation.
The \TeX\ system does nearly all of its own memory allocation, so that it
can readily be transported into environments that do not have automatic
facilities for strings, garbage collection, etc., and so that it can be in
control of what error messages the user receives. The dynamic storage
requirements of \TeX\ are handled by providing a large array \\{mem} in
which consecutive blocks of words are used as nodes by the \TeX\ routines.

Pointer variables are indices into this array, or into another array
called \\{eqtb} that will be explained later. A pointer variable might
also be a special flag that lies outside the bounds of \\{mem}, so we
allow pointers to assume any \\{halfword} value. The minimum halfword
value represents a null pointer. \TeX\ does not assume that $\\{mem}[\\{null}]$
exists.

\Y\P\D \37$\\{pointer}\S\\{halfword}$\C{a flag or a location in \\{mem} or %
\\{eqtb}}\par
\P\D \37$\\{null}\S\\{min\_halfword}$\C{the null pointer}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{temp\_ptr}: \37\\{pointer};\C{a pointer variable for occasional emergency
use}\par
\fi

\M134. The \\{mem} array is divided into two regions that are allocated
separately,
but the dividing line between these two regions is not fixed; they grow
together until finding their ``natural'' size in a particular job.
Locations less than or equal to \\{lo\_mem\_max} are used for storing
variable-length records consisting of two or more words each. This region
is maintained using an algorithm similar to the one described in exercise
2.5--19 of {\sl The Art of Computer Programming}. However, no size field
appears in the allocated nodes; the program is responsible for knowing the
relevant size when a node is freed. Locations greater than or equal to
\\{hi\_mem\_min} are used for storing one-word records; a conventional
\.{AVAIL} stack is used for allocation in this region.

Locations of \\{mem} between \\{mem\_bot} and \\{mem\_top} may be dumped as
part
of preloaded format files, by the \.{INITEX} preprocessor.
Production versions of \TeX\ may extend the memory at both ends in order to
provide more space; locations between \\{mem\_min} and \\{mem\_bot} are always
used for variable-size nodes, and locations between \\{mem\_top} and \\{mem%
\_max}
are always used for single-word nodes.

The key pointers that govern \\{mem} allocation have a prescribed order:
$$\advance\thickmuskip-2mu
\hbox{$\\{null}\L\\{mem\_min}\L\\{mem\_bot}<\\{lo\_mem\_max}<\\{hi\_mem\_min}<%
\\{mem\_top}\L\\{mem\_end}\L\\{mem\_max}$.}$$

Empirical tests show that the present implementation of \TeX\ tends to
spend about 9\pct! of its running time allocating nodes, and about 6\pct!
deallocating them after their use.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{mem}: \37\&{array} $[\\{mem\_min}\to\\{mem\_max}]$ \1\&{of}\5
\\{memory\_word};\C{the big dynamic storage area}\2\6
\4\\{lo\_mem\_max}: \37\\{pointer};\C{the largest location of variable-size
memory in use}\6
\4\\{hi\_mem\_min}: \37\\{pointer};\C{the smallest location of one-word memory
in use}\par
\fi

\M135. In order to study the memory requirements of particular applications, it
is possible to prepare a version of \TeX\ that keeps track of current and
maximum memory usage. When code between the delimiters  \&{stat}  $\ldots$
  \&{tats}  is not ``commented out,'' \TeX\ will run a bit slower but it will
report these statistics when \\{tracing\_stats} is sufficiently large.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4$\\{var\_used},\39\\{dyn\_used}$: \37\\{integer};\C{how much memory is in
use}\par
\fi

\M136. Let's consider the one-word memory region first, since it's the
simplest. The pointer variable \\{mem\_end} holds the highest-numbered location
of \\{mem} that has ever been used. The free locations of \\{mem} that
occur between \\{hi\_mem\_min} and \\{mem\_end}, inclusive, are of type
\\{two\_halves}, and we write $\\{info}(\|p)$ and $\\{link}(\|p)$ for the %
\\{lh}
and \\{rh} fields of $\\{mem}[\|p]$ when it is of this type. The single-word
free locations form a linked list
$$\\{avail},\;\hbox{$\\{link}(\\{avail})$},\;\hbox{$\\{link}(\\{link}(%
\\{avail}))$},\;\ldots$$
terminated by \\{null}.

\Y\P\D \37$\\{link}(\#)\S\\{mem}[\#].\\{hh}.\\{rh}$\C{the \\{link} field of a
memory word}\par
\P\D \37$\\{info}(\#)\S\\{mem}[\#].\\{hh}.\\{lh}$\C{the \\{info} field of a
memory word}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{avail}: \37\\{pointer};\C{head of the list of available one-word nodes}\6
\4\\{mem\_end}: \37\\{pointer};\C{the last one-word node used in \\{mem}}\par
\fi

\M137. If memory is exhausted, it might mean that the user has forgotten
a right brace. We will define some procedures later that try to help
pinpoint the trouble.

\Y\P\X314:Declare the procedure called \\{show\_token\_list}\X\6
\X328:Declare the procedure called \\{runaway}\X\par
\fi

\M138. The function \\{get\_avail} returns a pointer to a new one-word node
whose
\\{link} field is null. However, \TeX\ will halt if there is no more room left.

If the available-space list is empty, i.e., if $\\{avail}=\\{null}$,
we try first to increase \\{mem\_end}. If that cannot be done, i.e., if
$\\{mem\_end}=\\{mem\_max}$, we try to decrease \\{hi\_mem\_min}. If that
cannot be
done, i.e., if $\\{hi\_mem\_min}=\\{lo\_mem\_max}+1$, we have to quit.

\Y\P\4\&{function}\1\  \37\\{get\_avail}: \37\\{pointer};\C{single-word node
allocation}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node being got}\2\6
\&{begin} \37$\|p\K\\{avail}$;\C{get top location in the \\{avail} stack}\6
\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{avail}\K\\{link}(\\{avail})$\C{and pop it off}\6
\4\&{else} \&{if} $\\{mem\_end}<\\{mem\_max}$ \1\&{then}\C{or go into virgin
territory}\6
\&{begin} \37$\\{incr}(\\{mem\_end})$;\5
$\|p\K\\{mem\_end}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{decr}(\\{hi\_mem\_min})$;\5
$\|p\K\\{hi\_mem\_min}$;\6
\&{if} $\\{hi\_mem\_min}\L\\{lo\_mem\_max}$ \1\&{then}\6
\&{begin} \37\\{runaway};\C{if memory is exhausted, display possible runaway
text}\6
$\\{overflow}(\.{"main\ memory\ size"},\39\\{mem\_max}+1-\\{mem\_min})$;%
\C{quit; all one-word nodes are busy}\6
\&{end};\2\6
\&{end};\2\2\6
$\\{link}(\|p)\K\\{null}$;\C{provide an oft-desired initialization of the new
node}\6
\&{stat} \37$\\{incr}(\\{dyn\_used})$;\ \&{tats}\C{maintain statistics}\6
$\\{get\_avail}\K\|p$;\6
\&{end};\par
\fi

\M139. Conversely, a one-word node is recycled by calling \\{free\_avail}.
This routine is part of \TeX's ``inner loop,'' so we want it to be fast.

\Y\P\D \37$\\{free\_avail}(\#)\S$\C{single-word node liberation}\6
\&{begin} \37$\\{link}(\#)\K\\{avail}$;\5
$\\{avail}\K\#$;\6
\&{stat} \37$\\{decr}(\\{dyn\_used})$;\ \&{tats}\6
\&{end}\par
\fi

\M140. There's also a \\{fast\_get\_avail} routine, which saves the
procedure-call
overhead at the expense of extra programming. This routine is used in
the places that would otherwise account for the most calls of \\{get\_avail}.

\Y\P\D \37$\\{fast\_get\_avail}(\#)\S\hbox{}$\6
\&{begin} \37$\#\K\\{avail}$;\C{avoid \\{get\_avail} if possible, to save time}%
\6
\&{if} $\#=\\{null}$ \1\&{then}\5
$\#\K\\{get\_avail}$\6
\4\&{else} \&{begin} \37$\\{avail}\K\\{link}(\#)$;\5
$\\{link}(\#)\K\\{null}$;\6
\&{stat} \37$\\{incr}(\\{dyn\_used})$;\ \&{tats}\6
\&{end};\2\6
\&{end}\par
\fi

\M141. The procedure $\\{flush\_list}(\|p)$ frees an entire linked list of
one-word nodes that starts at position \|p.

\Y\P\4\&{procedure}\1\  \37$\\{flush\_list}(\|p:\\{pointer})$;\C{makes list of
single-word nodes   available}\6
\4\&{var} \37$\|q,\39\|r$: \37\\{pointer};\C{list traversers}\2\6
\&{begin} \37\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\|p$;\6
\1\&{repeat} \37$\|q\K\|r$;\5
$\|r\K\\{link}(\|r)$;\6
\&{stat} \37$\\{decr}(\\{dyn\_used})$;\ \&{tats}\6
\4\&{until}\5
$\|r=\\{null}$;\C{now \|q is the last node on the list}\2\6
$\\{link}(\|q)\K\\{avail}$;\5
$\\{avail}\K\|p$;\6
\&{end};\2\6
\&{end};\par
\fi

\M142. The available-space list that keeps track of the variable-size portion
of \\{mem} is a nonempty, doubly-linked circular list of empty nodes,
pointed to by the roving pointer \\{rover}.

Each empty node has size 2 or more; the first word contains the special
value \\{max\_halfword} in its \\{link} field and the size in its \\{info}
field;
the second word contains the two pointers for double linking.

Each nonempty node also has size 2 or more. Its first word is of type
\\{two\_halves}\kern-1pt, and its \\{link} field is never equal to \\{max%
\_halfword}.
Otherwise there is complete flexibility with respect to the contents
of its other fields and its other words.

(We require $\\{mem\_max}<\\{max\_halfword}$ because terrible things can happen
when \\{max\_halfword} appears in the \\{link} field of a nonempty node.)

\Y\P\D \37$\\{empty\_flag}\S\\{max\_halfword}$\C{the \\{link} of an empty
variable-size node}\par
\P\D \37$\\{is\_empty}(\#)\S(\\{link}(\#)=\\{empty\_flag})$\C{tests for empty
node}\par
\P\D \37$\\{node\_size}\S\\{info}$\C{the size field in empty variable-size
nodes}\par
\P\D \37$\\{llink}(\#)\S\\{info}(\#+1)$\C{left link in doubly-linked list of
empty nodes}\par
\P\D \37$\\{rlink}(\#)\S\\{link}(\#+1)$\C{right link in doubly-linked list of
empty nodes}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{rover}: \37\\{pointer};\C{points to some node in the list of empties}\par
\fi

\M143. A call to \\{get\_node} with argument \|s returns a pointer to a new
node
of size~\|s, which must be 2~or more. The \\{link} field of the first word
of this new node is set to null. An overflow stop occurs if no suitable
space exists.

If \\{get\_node} is called with $s=2^{30}$, it simply merges adjacent free
areas and returns the value \\{max\_halfword}.

\Y\P\4\&{function}\1\  \37$\\{get\_node}(\|s:\\{integer})$: \37\\{pointer};%
\C{variable-size node allocation}\6
\4\&{label} \37$\\{found},\39\\{exit},\39\\{restart}$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the node currently under inspection}\6
\|q: \37\\{pointer};\C{the node physically after node \|p}\6
\|r: \37\\{integer};\C{the newly allocated node, or a candidate for this honor}%
\6
\|t: \37\\{integer};\C{temporary register}\2\6
\&{begin} \37\\{restart}: \37$\|p\K\\{rover}$;\C{start at some free node in the
ring}\6
\1\&{repeat} \37\X145:Try to allocate within node \|p and its physical
successors, and \&{goto} \\{found} if allocation was possible\X;\6
$\|p\K\\{rlink}(\|p)$;\C{move to the next node in the ring}\6
\4\&{until}\5
$\|p=\\{rover}$;\C{repeat until the whole list has been traversed}\2\6
\&{if} $\|s=\O{10000000000}$ \1\&{then}\6
\&{begin} \37$\\{get\_node}\K\\{max\_halfword}$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{lo\_mem\_max}+2<\\{hi\_mem\_min}$ \1\&{then}\6
\&{if} $\\{lo\_mem\_max}+2\L\\{mem\_bot}+\\{max\_halfword}$ \1\&{then}\5
\X144:Grow more variable-size memory and \&{goto} \\{restart}\X;\2\2\6
$\\{overflow}(\.{"main\ memory\ size"},\39\\{mem\_max}+1-\\{mem\_min})$;%
\C{sorry, nothing satisfactory is left}\6
\4\\{found}: \37$\\{link}(\|r)\K\\{null}$;\C{this node is now nonempty}\6
\&{stat} \37$\\{var\_used}\K\\{var\_used}+\|s$;\C{maintain usage statistics}\6
\&{tats}\6
$\\{get\_node}\K\|r$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M144. The lower part of \\{mem} grows by 1000 words at a time, unless
we are very close to going under. When it grows, we simply link
a new node into the available-space list. This method of controlled
growth helps to keep the \\{mem} usage consecutive when \TeX\ is
implemented on ``virtual memory'' systems.

\Y\P$\4\X144:Grow more variable-size memory and \&{goto} \\{restart}\X\S$\6
\&{begin} \37\&{if} $\\{hi\_mem\_min}-\\{lo\_mem\_max}\G1998$ \1\&{then}\5
$\|t\K\\{lo\_mem\_max}+1000$\6
\4\&{else} $\|t\K\\{lo\_mem\_max}+1+(\\{hi\_mem\_min}-\\{lo\_mem\_max})%
\mathbin{\&{div}}2$;\C{$\\{lo\_mem\_max}+2\L\|t<\\{hi\_mem\_min}$}\2\6
$\|p\K\\{llink}(\\{rover})$;\5
$\|q\K\\{lo\_mem\_max}$;\5
$\\{rlink}(\|p)\K\|q$;\5
$\\{llink}(\\{rover})\K\|q$;\6
\&{if} $\|t>\\{mem\_bot}+\\{max\_halfword}$ \1\&{then}\5
$\|t\K\\{mem\_bot}+\\{max\_halfword}$;\2\6
$\\{rlink}(\|q)\K\\{rover}$;\5
$\\{llink}(\|q)\K\|p$;\5
$\\{link}(\|q)\K\\{empty\_flag}$;\5
$\\{node\_size}(\|q)\K\|t-\\{lo\_mem\_max}$;\6
$\\{lo\_mem\_max}\K\|t$;\5
$\\{link}(\\{lo\_mem\_max})\K\\{null}$;\5
$\\{info}(\\{lo\_mem\_max})\K\\{null}$;\5
$\\{rover}\K\|q$;\5
\&{goto} \37\\{restart};\6
\&{end}\par
\U143.\fi

\M145. Empirical tests show that the routine in this section performs a
node-merging operation about 0.75 times per allocation, on the average,
after which it finds that $\|r>\|p+1$ about 95\pct! of the time.

\Y\P$\4\X145:Try to allocate within node \|p and its physical successors, and %
\&{goto} \\{found} if allocation was possible\X\S$\6
$\|q\K\|p+\\{node\_size}(\|p)$;\C{find the physical successor}\6
\&{while} $\\{is\_empty}(\|q)$ \1\&{do}\C{merge node \|p with node \|q}\6
\&{begin} \37$\|t\K\\{rlink}(\|q)$;\6
\&{if} $\|q=\\{rover}$ \1\&{then}\5
$\\{rover}\K\|t$;\2\6
$\\{llink}(\|t)\K\\{llink}(\|q)$;\5
$\\{rlink}(\\{llink}(\|q))\K\|t$;\6
$\|q\K\|q+\\{node\_size}(\|q)$;\6
\&{end};\2\6
$\|r\K\|q-\|s$;\6
\&{if} $\|r>\|p+1$ \1\&{then}\5
\X146:Allocate from the top of node \|p and \&{goto} \\{found}\X;\2\6
\&{if} $\|r=\|p$ \1\&{then}\6
\&{if} $\\{rlink}(\|p)\I\|p$ \1\&{then}\5
\X147:Allocate entire node \|p and \&{goto} \\{found}\X;\2\2\6
$\\{node\_size}(\|p)\K\|q-\|p$\C{reset the size in case it grew}\par
\U143.\fi

\M146. \P$\X146:Allocate from the top of node \|p and \&{goto} \\{found}\X\S$\6
\&{begin} \37$\\{node\_size}(\|p)\K\|r-\|p$;\C{store the remaining size}\6
$\\{rover}\K\|p$;\C{start searching here next time}\6
\&{goto} \37\\{found};\6
\&{end}\par
\U145.\fi

\M147. Here we delete node \|p from the ring, and let \\{rover} rove around.

\Y\P$\4\X147:Allocate entire node \|p and \&{goto} \\{found}\X\S$\6
\&{begin} \37$\\{rover}\K\\{rlink}(\|p)$;\5
$\|t\K\\{llink}(\|p)$;\5
$\\{llink}(\\{rover})\K\|t$;\5
$\\{rlink}(\|t)\K\\{rover}$;\5
\&{goto} \37\\{found};\6
\&{end}\par
\U145.\fi

\M148. Conversely, when some variable-size node \|p of size \|s is no longer
needed,
the operation $\\{free\_node}(\|p,\|s)$ will make its words available, by
inserting
\|p as a new empty node just before where \\{rover} now points.

\Y\P\4\&{procedure}\1\  \37$\\{free\_node}(\|p:\\{pointer};\,\35\|s:%
\\{halfword})$;\C{variable-size node   liberation}\6
\4\&{var} \37\|q: \37\\{pointer};\C{$\\{llink}(\\{rover})$}\2\6
\&{begin} \37$\\{node\_size}(\|p)\K\|s$;\5
$\\{link}(\|p)\K\\{empty\_flag}$;\5
$\|q\K\\{llink}(\\{rover})$;\5
$\\{llink}(\|p)\K\|q$;\5
$\\{rlink}(\|p)\K\\{rover}$;\C{set both links}\6
$\\{llink}(\\{rover})\K\|p$;\5
$\\{rlink}(\|q)\K\|p$;\C{insert \|p into the ring}\6
\&{stat} \37$\\{var\_used}\K\\{var\_used}-\|s$;\ \&{tats}\C{maintain
statistics}\6
\&{end};\par
\fi

\M149. Just before \.{INITEX} writes out the memory, it sorts the doubly linked
available space list. The list is probably very short at such times, so a
simple insertion sort is used. The smallest available location will be
pointed to by \\{rover}, the next-smallest by $\\{rlink}(\\{rover})$, etc.

\Y\P\&{init} \37\&{procedure}\1\  \37\\{sort\_avail};\C{sorts the available
variable-size nodes   by location}\6
\4\&{var} \37$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{indices into \\{mem}}\6
\\{old\_rover}: \37\\{pointer};\C{initial \\{rover} setting}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\O{10000000000})$;\C{merge adjacent free
areas}\6
$\|p\K\\{rlink}(\\{rover})$;\5
$\\{rlink}(\\{rover})\K\\{max\_halfword}$;\5
$\\{old\_rover}\K\\{rover}$;\6
\&{while} $\|p\I\\{old\_rover}$ \1\&{do}\5
\X150:Sort \(p)\|p into the list starting at \\{rover} and advance \|p to $%
\\{rlink}(\|p)$\X;\2\6
$\|p\K\\{rover}$;\6
\&{while} $\\{rlink}(\|p)\I\\{max\_halfword}$ \1\&{do}\6
\&{begin} \37$\\{llink}(\\{rlink}(\|p))\K\|p$;\5
$\|p\K\\{rlink}(\|p)$;\6
\&{end};\2\6
$\\{rlink}(\|p)\K\\{rover}$;\5
$\\{llink}(\\{rover})\K\|p$;\6
\&{end};\6
\&{tini}\par
\fi

\M150. The following  \&{while}  loop is guaranteed to
terminate, since the list that starts at
\\{rover} ends with \\{max\_halfword} during the sorting procedure.

\Y\P$\4\X150:Sort \(p)\|p into the list starting at \\{rover} and advance \|p
to $\\{rlink}(\|p)$\X\S$\6
\&{if} $\|p<\\{rover}$ \1\&{then}\6
\&{begin} \37$\|q\K\|p$;\5
$\|p\K\\{rlink}(\|q)$;\5
$\\{rlink}(\|q)\K\\{rover}$;\5
$\\{rover}\K\|q$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{rover}$;\6
\&{while} $\\{rlink}(\|q)<\|p$ \1\&{do}\5
$\|q\K\\{rlink}(\|q)$;\2\6
$\|r\K\\{rlink}(\|p)$;\5
$\\{rlink}(\|p)\K\\{rlink}(\|q)$;\5
$\\{rlink}(\|q)\K\|p$;\5
$\|p\K\|r$;\6
\&{end}\2\par
\U149.\fi

\N151.  \[10] Data structures for boxes and their friends.
From the computer's standpoint, \TeX's chief mission is to create
horizontal and vertical lists. We shall now investigate how the elements
of these lists are represented internally as nodes in the dynamic memory.

A horizontal or vertical list is linked together by \\{link} fields in
the first word of each node. Individual nodes represent boxes, glue,
penalties, or special things like discretionary hyphens; because of this
variety, some nodes are longer than others, and we must distinguish different
kinds of nodes. We do this by putting a `\\{type}' field in the first word,
together with the link and an optional `\\{subtype}'.

\Y\P\D \37$\\{type}(\#)\S\\{mem}[\#].\\{hh}.\\{b0}$\C{identifies what kind of
node this is}\par
\P\D \37$\\{subtype}(\#)\S\\{mem}[\#].\\{hh}.\\{b1}$\C{secondary identification
in some cases}\par
\fi

\M152. A \\{char\_node}, which represents a single character, is the most
important
kind of node because it accounts for the vast majority of all boxes.
Special precautions are therefore taken to ensure that a \\{char\_node} does
not take up much memory space. Every such node is one word long, and in fact
it is identifiable by this property, since other kinds of nodes have at least
two words, and they appear in \\{mem} locations less than \\{hi\_mem\_min}.
This makes it possible to omit the \\{type} field in a \\{char\_node}, leaving
us room for two bytes that identify a \\{font} and a \\{character} within
that font.

Note that the format of a \\{char\_node} allows for up to 256 different
fonts and up to 256 characters per font; but most implementations will
probably limit the total number of fonts to fewer than 75 per job,
and most fonts will stick to characters whose codes are
less than 128 (since higher codes
are more difficult to access on most keyboards).

Extensions of \TeX\ intended for oriental languages will need even more
than $256\times256$ possible characters, when we consider different sizes
and styles of type.  It is suggested that Chinese and Japanese fonts be
handled by representing such characters in two consecutive \\{char\_node}
entries: The first of these has $\\{font}=\\{font\_base}$, and its \\{link}
points
to the second;
the second identifies the font and the character dimensions.
The saving feature about oriental characters is that most of them have
the same box dimensions. The \\{character} field of the first \\{char\_node}
is a ``\\{charext}'' that distinguishes between graphic symbols whose
dimensions are identical for typesetting purposes. (See the \MF\ manual.)
Such an extension of \TeX\ would not be difficult; further details are
left to the reader.

In order to make sure that the \\{character} code fits in a quarterword,
\TeX\ adds the quantity \\{min\_quarterword} to the actual code.

Character nodes appear only in horizontal lists, never in vertical lists.

\Y\P\D \37$\\{is\_char\_node}(\#)\S(\#\G\\{hi\_mem\_min})$\C{does the argument
point to a \\{char\_node}?}\par
\P\D \37$\\{font}\S\\{type}$\C{the font code in a \\{char\_node}}\par
\P\D \37$\\{character}\S\\{subtype}$\C{the character code in a \\{char\_node}}%
\par
\fi

\M153. An \\{hlist\_node} stands for a box that was made from a horizontal
list.
Each \\{hlist\_node} is seven words long, and contains the following fields
(in addition to the mandatory \\{type} and \\{link}, which we shall not
mention explicitly when discussing the other node types): The \\{height} and
\\{width} and \\{depth} are scaled integers denoting the dimensions of the
box.  There is also a \\{shift\_amount} field, a scaled integer indicating
how much this box should be lowered (if it appears in a horizontal list),
or how much it should be moved to the right (if it appears in a vertical
list). There is a \\{list\_ptr} field, which points to the beginning of the
list from which this box was fabricated; if \\{list\_ptr} is \\{null}, the box
is empty. Finally, there are three fields that represent the setting of
the glue:  $\\{glue\_set}(\|p)$ is a word of type \\{glue\_ratio} that
represents
the proportionality constant for glue setting; $\\{glue\_sign}(\|p)$ is
\\{stretching} or \\{shrinking} or \\{normal} depending on whether or not the
glue should stretch or shrink or remain rigid; and $\\{glue\_order}(\|p)$
specifies the order of infinity to which glue setting applies (\\{normal},
\\{fil}, \\{fill}, or \\{filll}). The \\{subtype} field is not used in \TeX.
In \eTeX\ the \\{subtype} field records the box direction mode \\{box\_lr}.

\Y\P\D \37$\\{hlist\_node}=0$\C{\\{type} of hlist nodes}\par
\P\D \37$\\{box\_node\_size}=7$\C{number of words to allocate for a box node}%
\par
\P\D \37$\\{width\_offset}=1$\C{position of \\{width} field in a box node}\par
\P\D \37$\\{depth\_offset}=2$\C{position of \\{depth} field in a box node}\par
\P\D \37$\\{height\_offset}=3$\C{position of \\{height} field in a box node}\par
\P\D \37$\\{width}(\#)\S\\{mem}[\#+\\{width\_offset}].\\{sc}$\C{width of the
box, in sp}\par
\P\D \37$\\{depth}(\#)\S\\{mem}[\#+\\{depth\_offset}].\\{sc}$\C{depth of the
box, in sp}\par
\P\D \37$\\{height}(\#)\S\\{mem}[\#+\\{height\_offset}].\\{sc}$\C{height of the
box, in sp}\par
\P\D \37$\\{shift\_amount}(\#)\S\\{mem}[\#+4].\\{sc}$\C{repositioning distance,
in sp}\par
\P\D \37$\\{list\_offset}=5$\C{position of \\{list\_ptr} field in a box node}%
\par
\P\D \37$\\{list\_ptr}(\#)\S\\{link}(\#+\\{list\_offset})$\C{beginning of the
list inside the box}\par
\P\D \37$\\{glue\_order}(\#)\S\\{subtype}(\#+\\{list\_offset})$\C{applicable
order of infinity}\par
\P\D \37$\\{glue\_sign}(\#)\S\\{type}(\#+\\{list\_offset})$\C{stretching or
shrinking}\par
\P\D \37$\\{normal}=0$\C{the most common case when several cases are named}\par
\P\D \37$\\{stretching}=1$\C{glue setting applies to the stretch components}\par
\P\D \37$\\{shrinking}=2$\C{glue setting applies to the shrink components}\par
\P\D \37$\\{glue\_offset}=6$\C{position of \\{glue\_set} in a box node}\par
\P\D \37$\\{glue\_set}(\#)\S\\{mem}[\#+\\{glue\_offset}].\\{gr}$\C{a word of
type \\{glue\_ratio} for glue setting}\par
\fi

\M154. The \\{new\_null\_box} function returns a pointer to an \\{hlist\_node}
in
which all subfields have the values corresponding to `\.{\\hbox\{\}}'.
(The \\{subtype} field is set to \\{min\_quarterword}, for historic reasons
that are no longer relevant.)

\Y\P\4\&{function}\1\  \37\\{new\_null\_box}: \37\\{pointer};\C{creates a new
box node}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{box\_node\_size})$;\5
$\\{type}(\|p)\K\\{hlist\_node}$;\5
$\\{subtype}(\|p)\K\\{min\_quarterword}$;\5
$\\{width}(\|p)\K0$;\5
$\\{depth}(\|p)\K0$;\5
$\\{height}(\|p)\K0$;\5
$\\{shift\_amount}(\|p)\K0$;\5
$\\{list\_ptr}(\|p)\K\\{null}$;\5
$\\{glue\_sign}(\|p)\K\\{normal}$;\5
$\\{glue\_order}(\|p)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|p))$;\5
$\\{new\_null\_box}\K\|p$;\6
\&{end};\par
\fi

\M155. A \\{vlist\_node} is like an \\{hlist\_node} in all respects except that
it
contains a vertical list.

\Y\P\D \37$\\{vlist\_node}=1$\C{\\{type} of vlist nodes}\par
\fi

\M156. A \\{rule\_node} stands for a solid black rectangle; it has \\{width},
\\{depth}, and \\{height} fields just as in an \\{hlist\_node}. However, if
any of these dimensions is $-2^{30}$, the actual value will be determined
by running the rule up to the boundary of the innermost enclosing box.
This is called a ``running dimension.'' The \\{width} is never running in
an hlist; the \\{height} and \\{depth} are never running in a~vlist.

\Y\P\D \37$\\{rule\_node}=2$\C{\\{type} of rule nodes}\par
\P\D \37$\\{rule\_node\_size}=4$\C{number of words to allocate for a rule node}%
\par
\P\D \37$\\{null\_flag}\S-\O{10000000000}$\C{$-2^{30}$, signifies a missing
item}\par
\P\D \37$\\{is\_running}(\#)\S(\#=\\{null\_flag})$\C{tests for a running
dimension}\par
\fi

\M157. A new rule node is delivered by the \\{new\_rule} function. It
makes all the dimensions ``running,'' so you have to change the
ones that are not allowed to run.

\Y\P\4\&{function}\1\  \37\\{new\_rule}: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{rule\_node\_size})$;\5
$\\{type}(\|p)\K\\{rule\_node}$;\5
$\\{subtype}(\|p)\K0$;\C{the \\{subtype} is not used}\6
$\\{width}(\|p)\K\\{null\_flag}$;\5
$\\{depth}(\|p)\K\\{null\_flag}$;\5
$\\{height}(\|p)\K\\{null\_flag}$;\5
$\\{new\_rule}\K\|p$;\6
\&{end};\par
\fi

\M158. Insertions are represented by \\{ins\_node} records, where the %
\\{subtype}
indicates the corresponding box number. For example, `\.{\\insert 250}'
leads to an \\{ins\_node} whose \\{subtype} is $250+\\{min\_quarterword}$.
The \\{height} field of an \\{ins\_node} is slightly misnamed; it actually
holds
the natural height plus depth of the vertical list being inserted.
The \\{depth} field holds the \\{split\_max\_depth} to be used in case this
insertion is split, and the \\{split\_top\_ptr} points to the corresponding
\\{split\_top\_skip}. The \\{float\_cost} field holds the \\{floating\_penalty}
that
will be used if this insertion floats to a subsequent page after a
split insertion of the same class.  There is one more field, the
\\{ins\_ptr}, which points to the beginning of the vlist for the insertion.

\Y\P\D \37$\\{ins\_node}=3$\C{\\{type} of insertion nodes}\par
\P\D \37$\\{ins\_node\_size}=5$\C{number of words to allocate for an insertion}%
\par
\P\D \37$\\{float\_cost}(\#)\S\\{mem}[\#+1].\\{int}$\C{the \\{floating%
\_penalty} to be used}\par
\P\D \37$\\{ins\_ptr}(\#)\S\\{info}(\#+4)$\C{the vertical list to be inserted}%
\par
\P\D \37$\\{split\_top\_ptr}(\#)\S\\{link}(\#+4)$\C{the \\{split\_top\_skip} to
be used}\par
\fi

\M159. A \\{mark\_node} has a \\{mark\_ptr} field that points to the reference
count
of a token list that contains the user's \.{\\mark} text.
In addition there is a \\{mark\_class} field that contains the mark class.

\Y\P\D \37$\\{mark\_node}=4$\C{\\{type} of a mark node}\par
\P\D \37$\\{small\_node\_size}=2$\C{number of words to allocate for most node
types}\par
\P\D \37$\\{mark\_ptr}(\#)\S\\{link}(\#+1)$\C{head of the token list for a
mark}\par
\P\D \37$\\{mark\_class}(\#)\S\\{info}(\#+1)$\C{the mark class}\par
\fi

\M160. An \\{adjust\_node}, which occurs only in horizontal lists,
specifies material that will be moved out into the surrounding
vertical list; i.e., it is used to implement \TeX's `\.{\\vadjust}'
operation.  The \\{adjust\_ptr} field points to the vlist containing this
material.

\Y\P\D \37$\\{adjust\_node}=5$\C{\\{type} of an adjust node}\par
\P\D \37$\\{adjust\_pre}\S\\{subtype}$\C{<>0 => pre-adjustment}\7
\C{\\{append\_list} is used to append a list to \\{tail}}\par
\P\D $\\{append\_list}(\#)\S$ \6
\&{begin} \37$\\{link}(\\{tail})\K\\{link}(\#)$;\5
\\{append\_list\_end}\par
\P\D \37$\\{append\_list\_end}(\#)\S\\{tail}\K\#$; \6
\&{end} \par
\P\D \37$\\{adjust\_ptr}(\#)\S\\{mem}[\#+1].\\{int}$\C{vertical list to be
moved out of horizontal list}\par
\fi

\M161. A \\{ligature\_node}, which occurs only in horizontal lists, specifies
a character that was fabricated from the interaction of two or more
actual characters.  The second word of the node, which is called the
\\{lig\_char} word, contains \\{font} and \\{character} fields just as in a
\\{char\_node}. The characters that generated the ligature have not been
forgotten, since they are needed for diagnostic messages and for
hyphenation; the \\{lig\_ptr} field points to a linked list of character
nodes for all original characters that have been deleted. (This list
might be empty if the characters that generated the ligature were
retained in other nodes.)

The \\{subtype} field is 0, plus 2 and/or 1 if the original source of the
ligature included implicit left and/or right boundaries.

\Y\P\D \37$\\{ligature\_node}=6$\C{\\{type} of a ligature node}\par
\P\D \37$\\{lig\_char}(\#)\S\#+1$\C{the word where the ligature is to be found}%
\par
\P\D \37$\\{lig\_ptr}(\#)\S\\{link}(\\{lig\_char}(\#))$\C{the list of
characters}\par
\fi

\M162. The \\{new\_ligature} function creates a ligature node having given
contents of the \\{font}, \\{character}, and \\{lig\_ptr} fields. We also have
a \\{new\_lig\_item} function, which returns a two-word node having a given
\\{character} field. Such nodes are used for temporary processing as ligatures
are being created.

\Y\P\4\&{function}\1\  \37$\\{new\_ligature}(\|f,\39\|c:\\{quarterword};\,\35%
\|q:\\{pointer})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{ligature\_node}$;\5
$\\{font}(\\{lig\_char}(\|p))\K\|f$;\5
$\\{character}(\\{lig\_char}(\|p))\K\|c$;\5
$\\{lig\_ptr}(\|p)\K\|q$;\5
$\\{subtype}(\|p)\K0$;\5
$\\{new\_ligature}\K\|p$;\6
\&{end};\7
\4\&{function}\1\  \37$\\{new\_lig\_item}(\|c:\\{quarterword})$: \37%
\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{character}(\|p)\K\|c$;\5
$\\{lig\_ptr}(\|p)\K\\{null}$;\5
$\\{new\_lig\_item}\K\|p$;\6
\&{end};\par
\fi

\M163. A \\{disc\_node}, which occurs only in horizontal lists, specifies a
``dis\-cretion\-ary'' line break. If such a break occurs at node \|p, the text
that starts at $\\{pre\_break}(\|p)$ will precede the break, the text that
starts at
$\\{post\_break}(\|p)$ will follow the break, and text that appears in the next
$\\{replace\_count}(\|p)$ nodes will be ignored. For example, an ordinary
discretionary hyphen, indicated by `\.{\\-}', yields a \\{disc\_node} with
\\{pre\_break} pointing to a \\{char\_node} containing a hyphen, $\\{post%
\_break}=\\{null}$,
and $\\{replace\_count}=0$. All three of the discretionary texts must be
lists that consist entirely of character, kern, box, rule, and ligature nodes.

If $\\{pre\_break}(\|p)=\\{null}$, the \\{ex\_hyphen\_penalty} will be charged
for this
break.  Otherwise the \\{hyphen\_penalty} will be charged.  The texts will
actually be substituted into the list by the line-breaking algorithm if it
decides to make the break, and the discretionary node will disappear at
that time; thus, the output routine sees only discretionaries that were
not chosen.

\Y\P\D \37$\\{disc\_node}=7$\C{\\{type} of a discretionary node}\par
\P\D \37$\\{replace\_count}\S\\{subtype}$\C{how many subsequent nodes to
replace}\par
\P\D \37$\\{pre\_break}\S\\{llink}$\C{text that precedes a discretionary break}%
\par
\P\D \37$\\{post\_break}\S\\{rlink}$\C{text that follows a discretionary break}%
\par
\Y\P\4\&{function}\1\  \37\\{new\_disc}: \37\\{pointer};\C{creates an empty %
\\{disc\_node}}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{disc\_node}$;\5
$\\{replace\_count}(\|p)\K0$;\5
$\\{pre\_break}(\|p)\K\\{null}$;\5
$\\{post\_break}(\|p)\K\\{null}$;\5
$\\{new\_disc}\K\|p$;\6
\&{end};\par
\fi

\M164. A \\{whatsit\_node} is a wild card reserved for extensions to \TeX. The
\\{subtype} field in its first word says what `\\{whatsit}' it is, and
implicitly determines the node size (which must be 2 or more) and the
format of the remaining words. When a \\{whatsit\_node} is encountered
in a list, special actions are invoked; knowledgeable people who are
careful not to mess up the rest of \TeX\ are able to make \TeX\ do new
things by adding code at the end of the program. For example, there
might be a `\TeX nicolor' extension to specify different colors of ink,
and the whatsit node might contain the desired parameters.

The present implementation of \TeX\ treats the features associated with
`\.{\\write}' and `\.{\\special}' as if they were extensions, in order to
illustrate how such routines might be coded. We shall defer further
discussion of extensions until the end of this program.

\Y\P\D \37$\\{whatsit\_node}=8$\C{\\{type} of special extension nodes}\par
\fi

\M165. A \\{math\_node}, which occurs only in horizontal lists, appears before
and
after mathematical formulas. The \\{subtype} field is \\{before} before the
formula and \\{after} after it. There is a \\{width} field, which represents
the amount of surrounding space inserted by \.{\\mathsurround}.

In addition a \\{math\_node} with $\\{subtype}>\\{after}$ and $\\{width}=0$
will be
(ab)used to record a regular \\{math\_node} reinserted after being
discarded at a line break or one of the text direction primitives (
\.{\\beginL}, \.{\\endL}, \.{\\beginR}, and \.{\\endR} ).

\Y\P\D \37$\\{math\_node}=9$\C{\\{type} of a math node}\par
\P\D \37$\\{before}=0$\C{\\{subtype} for math node that introduces a formula}%
\par
\P\D \37$\\{after}=1$\C{\\{subtype} for math node that winds up a formula}\Y\par
\P\D \37$\\{M\_code}=2$\par
\P\D \37$\\{begin\_M\_code}=\\{M\_code}+\\{before}$\C{\\{subtype} for \.{%
\\beginM} node}\par
\P\D \37$\\{end\_M\_code}=\\{M\_code}+\\{after}$\C{\\{subtype} for \.{\\endM}
node}\par
\P\D \37$\\{L\_code}=4$\par
\P\D \37$\\{begin\_L\_code}=\\{L\_code}+\\{begin\_M\_code}$\C{\\{subtype} for %
\.{\\beginL} node}\par
\P\D \37$\\{end\_L\_code}=\\{L\_code}+\\{end\_M\_code}$\C{\\{subtype} for \.{%
\\endL} node}\par
\P\D \37$\\{R\_code}=\\{L\_code}+\\{L\_code}$\par
\P\D \37$\\{begin\_R\_code}=\\{R\_code}+\\{begin\_M\_code}$\C{\\{subtype} for %
\.{\\beginR} node}\par
\P\D \37$\\{end\_R\_code}=\\{R\_code}+\\{end\_M\_code}$\C{\\{subtype} for \.{%
\\endR} node}\Y\par
\P\D \37$\\{end\_LR}(\#)\S\\{odd}(\\{subtype}(\#))$\par
\P\D \37$\\{end\_LR\_type}(\#)\S(\\{L\_code}\ast(\\{subtype}(\#)\mathbin{%
\&{div}}\\{L\_code})+\\{end\_M\_code})$\par
\P\D \37$\\{begin\_LR\_type}(\#)\S(\#-\\{after}+\\{before})$\par
\Y\P\4\&{function}\1\  \37$\\{new\_math}(\|w:\\{scaled};\,\35\|s:\\{small%
\_number})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{math\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\5
$\\{width}(\|p)\K\|w$;\5
$\\{new\_math}\K\|p$;\6
\&{end};\par
\fi

\M166. \TeX\ makes use of the fact that \\{hlist\_node}, \\{vlist\_node},
\\{rule\_node}, \\{ins\_node}, \\{mark\_node}, \\{adjust\_node}, \\{ligature%
\_node},
\\{disc\_node}, \\{whatsit\_node}, and \\{math\_node} are at the low end of the
type codes, by permitting a break at glue in a list if and only if the
\\{type} of the previous node is less than \\{math\_node}. Furthermore, a
node is discarded after a break if its type is \\{math\_node} or~more.

\Y\P\D \37$\\{precedes\_break}(\#)\S(\\{type}(\#)<\\{math\_node})$\par
\P\D \37$\\{non\_discardable}(\#)\S(\\{type}(\#)<\\{math\_node})$\par
\fi

\M167. A \\{glue\_node} represents glue in a list. However, it is really only
a pointer to a separate glue specification, since \TeX\ makes use of the
fact that many essentially identical nodes of glue are usually present.
If \|p points to a \\{glue\_node}, $\\{glue\_ptr}(\|p)$ points to
another packet of words that specify the stretch and shrink components, etc.

Glue nodes also serve to represent leaders; the \\{subtype} is used to
distinguish between ordinary glue (which is called \\{normal}) and the three
kinds of leaders (which are called \\{a\_leaders}, \\{c\_leaders}, and \\{x%
\_leaders}).
The \\{leader\_ptr} field points to a rule node or to a box node containing the
leaders; it is set to \\{null} in ordinary glue nodes.

Many kinds of glue are computed from \TeX's ``skip'' parameters, and
it is helpful to know which parameter has led to a particular glue node.
Therefore the \\{subtype} is set to indicate the source of glue, whenever
it originated as a parameter. We will be defining symbolic names for the
parameter numbers later (e.g., $\\{line\_skip\_code}=0$, $\\{baseline\_skip%
\_code}=1$,
etc.); it suffices for now to say that the \\{subtype} of parametric glue
will be the same as the parameter number, plus~one.

In math formulas there are two more possibilities for the \\{subtype} in a
glue node: \\{mu\_glue} denotes an \.{\\mskip} (where the units are scaled %
\.{mu}
instead of scaled \.{pt}); and \\{cond\_math\_glue} denotes the `\.{%
\\nonscript}'
feature that cancels the glue node immediately following if it appears
in a subscript.

\Y\P\D \37$\\{glue\_node}=10$\C{\\{type} of node that points to a glue
specification}\par
\P\D \37$\\{cond\_math\_glue}=98$\C{special \\{subtype} to suppress glue in the
next node}\par
\P\D \37$\\{mu\_glue}=99$\C{\\{subtype} for math glue}\par
\P\D \37$\\{a\_leaders}=100$\C{\\{subtype} for aligned leaders}\par
\P\D \37$\\{c\_leaders}=101$\C{\\{subtype} for centered leaders}\par
\P\D \37$\\{x\_leaders}=102$\C{\\{subtype} for expanded leaders}\par
\P\D \37$\\{glue\_ptr}\S\\{llink}$\C{pointer to a glue specification}\par
\P\D \37$\\{leader\_ptr}\S\\{rlink}$\C{pointer to box or rule node for leaders}%
\par
\fi

\M168. A glue specification has a halfword reference count in its first word,
representing \\{null} plus the number of glue nodes that point to it (less
one).
Note that the reference count appears in the same position as
the \\{link} field in list nodes; this is the field that is initialized
to \\{null} when a node is allocated, and it is also the field that is flagged
by \\{empty\_flag} in empty nodes.

Glue specifications also contain three \\{scaled} fields, for the \\{width},
\\{stretch}, and \\{shrink} dimensions. Finally, there are two one-byte
fields called \\{stretch\_order} and \\{shrink\_order}; these contain the
orders of infinity (\\{normal}, \\{fil}, \\{fill}, or \\{filll})
corresponding to the stretch and shrink values.

\Y\P\D \37$\\{glue\_spec\_size}=4$\C{number of words to allocate for a glue
specification}\par
\P\D \37$\\{glue\_ref\_count}(\#)\S\\{link}(\#)$\C{reference count of a glue
specification}\par
\P\D \37$\\{stretch}(\#)\S\\{mem}[\#+2].\\{sc}$\C{the stretchability of this
glob of glue}\par
\P\D \37$\\{shrink}(\#)\S\\{mem}[\#+3].\\{sc}$\C{the shrinkability of this glob
of glue}\par
\P\D \37$\\{stretch\_order}\S\\{type}$\C{order of infinity for stretching}\par
\P\D \37$\\{shrink\_order}\S\\{subtype}$\C{order of infinity for shrinking}\par
\P\D \37$\\{fil}=1$\C{first-order infinity}\par
\P\D \37$\\{fill}=2$\C{second-order infinity}\par
\P\D \37$\\{filll}=3$\C{third-order infinity}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{glue\_ord}=\\{normal}\to\\{filll}$;\C{infinity to the 0, 1, 2, or 3 power}%
\par
\fi

\M169. Here is a function that returns a pointer to a copy of a glue spec.
The reference count in the copy is \\{null}, because there is assumed
to be exactly one reference to the new specification.

\Y\P\4\&{function}\1\  \37$\\{new\_spec}(\|p:\\{pointer})$: \37\\{pointer};%
\C{duplicates a glue specification}\6
\4\&{var} \37\|q: \37\\{pointer};\C{the new spec}\2\6
\&{begin} \37$\|q\K\\{get\_node}(\\{glue\_spec\_size})$;\6
$\\{mem}[\|q]\K\\{mem}[\|p]$;\5
$\\{glue\_ref\_count}(\|q)\K\\{null}$;\6
$\\{width}(\|q)\K\\{width}(\|p)$;\5
$\\{stretch}(\|q)\K\\{stretch}(\|p)$;\5
$\\{shrink}(\|q)\K\\{shrink}(\|p)$;\5
$\\{new\_spec}\K\|q$;\6
\&{end};\par
\fi

\M170. And here's a function that creates a glue node for a given parameter
identified by its code number; for example,
$\\{new\_param\_glue}(\\{line\_skip\_code})$ returns a pointer to a glue node
for the
current \.{\\lineskip}.

\Y\P\4\&{function}\1\  \37$\\{new\_param\_glue}(\|n:\\{small\_number})$: \37%
\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\6
\|q: \37\\{pointer};\C{the glue specification}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{glue\_node}$;\5
$\\{subtype}(\|p)\K\|n+1$;\5
$\\{leader\_ptr}(\|p)\K\\{null}$;\6
$\|q\K\X242:Current \\{mem} equivalent of glue parameter number \|n\X\hbox{}$;\5
$\\{glue\_ptr}(\|p)\K\|q$;\5
$\\{incr}(\\{glue\_ref\_count}(\|q))$;\5
$\\{new\_param\_glue}\K\|p$;\6
\&{end};\par
\fi

\M171. Glue nodes that are more or less anonymous are created by \\{new\_glue},
whose argument points to a glue specification.

\Y\P\4\&{function}\1\  \37$\\{new\_glue}(\|q:\\{pointer})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{glue\_node}$;\5
$\\{subtype}(\|p)\K\\{normal}$;\5
$\\{leader\_ptr}(\|p)\K\\{null}$;\5
$\\{glue\_ptr}(\|p)\K\|q$;\5
$\\{incr}(\\{glue\_ref\_count}(\|q))$;\5
$\\{new\_glue}\K\|p$;\6
\&{end};\par
\fi

\M172. Still another subroutine is needed: This one is sort of a combination
of \\{new\_param\_glue} and \\{new\_glue}. It creates a glue node for one of
the current glue parameters, but it makes a fresh copy of the glue
specification, since that specification will probably be subject to change,
while the parameter will stay put. The global variable \\{temp\_ptr} is
set to the address of the new spec.

\Y\P\4\&{function}\1\  \37$\\{new\_skip\_param}(\|n:\\{small\_number})$: \37%
\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\\{temp\_ptr}\K\\{new\_spec}(\X242:Current \\{mem} equivalent of
glue parameter number \|n\X)$;\5
$\|p\K\\{new\_glue}(\\{temp\_ptr})$;\5
$\\{glue\_ref\_count}(\\{temp\_ptr})\K\\{null}$;\5
$\\{subtype}(\|p)\K\|n+1$;\5
$\\{new\_skip\_param}\K\|p$;\6
\&{end};\par
\fi

\M173. A \\{kern\_node} has a \\{width} field to specify a (normally negative)
amount of spacing. This spacing correction appears in horizontal lists
between letters like A and V when the font designer said that it looks
better to move them closer together or further apart. A kern node can
also appear in a vertical list, when its `\\{width}' denotes additional
spacing in the vertical direction. The \\{subtype} is either \\{normal} (for
kerns inserted from font information or math mode calculations) or \\{explicit}
(for kerns inserted from \.{\\kern} and \.{\\/} commands) or \\{acc\_kern}
(for kerns inserted from non-math accents) or \\{mu\_glue} (for kerns
inserted from \.{\\mkern} specifications in math formulas).

\Y\P\D \37$\\{kern\_node}=11$\C{\\{type} of a kern node}\par
\P\D \37$\\{explicit}=1$\C{\\{subtype} of kern nodes from \.{\\kern} and \.{%
\\/}}\par
\P\D \37$\\{acc\_kern}=2$\C{\\{subtype} of kern nodes from accents}\par
\P\D \37$\\{auto\_kern}=3$\C{\\{subtype} of kern nodes created by \\{get\_auto%
\_kern}}\7
\C{memory structure for marginal kerns}\par
\P\D \37$\\{margin\_kern\_node}=40$\par
\P\D \37$\\{margin\_kern\_node\_size}=3$\par
\P\D \37$\\{margin\_char}(\#)\S\\{info}(\#+2)$\7
\C{\\{subtype} of marginal kerns}\par
\P\D \37$\\{left\_side}\S0$\par
\P\D \37$\\{right\_side}\S1$\7
\C{base for lp/rp/ef codes starts from 2:     0 for \\{hyphen\_char},     1 for
\\{skew\_char}}\par
\P\D \37$\\{lp\_code\_base}\S2$\par
\P\D \37$\\{rp\_code\_base}\S3$\par
\P\D \37$\\{ef\_code\_base}\S4$\par
\P\D \37$\\{tag\_code}\S5$\par
\P\D \37$\\{kn\_bs\_code\_base}\S7$\par
\P\D \37$\\{st\_bs\_code\_base}\S8$\par
\P\D \37$\\{sh\_bs\_code\_base}\S9$\par
\P\D \37$\\{kn\_bc\_code\_base}\S10$\par
\P\D \37$\\{kn\_ac\_code\_base}\S11$\par
\P\D \37$\\{no\_lig\_code}\S6$\par
\P\D \37$\\{max\_hlist\_stack}=512$\C{maximum fill level for \\{hlist\_stack}}\6
\C{maybe good if larger than $2\ast\\{max\_quarterword}$, so that box nesting
level would overflow first}\par
\fi

\M174. The \\{new\_kern} function creates a kern node having a given width.

\Y\P\4\&{function}\1\  \37$\\{new\_kern}(\|w:\\{scaled})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{subtype}(\|p)\K\\{normal}$;\5
$\\{width}(\|p)\K\|w$;\5
$\\{new\_kern}\K\|p$;\6
\&{end};\par
\fi

\M175. A \\{penalty\_node} specifies the penalty associated with line or page
breaking, in its \\{penalty} field. This field is a fullword integer, but
the full range of integer values is not used: Any penalty $\G10000$ is
treated as infinity, and no break will be allowed for such high values.
Similarly, any penalty $\L-10000$ is treated as negative infinity, and a
break will be forced.

\Y\P\D \37$\\{penalty\_node}=12$\C{\\{type} of a penalty node}\par
\P\D \37$\\{inf\_penalty}=\\{inf\_bad}$\C{``infinite'' penalty value}\par
\P\D \37$\\{eject\_penalty}=-\\{inf\_penalty}$\C{``negatively infinite''
penalty value}\par
\P\D \37$\\{penalty}(\#)\S\\{mem}[\#+1].\\{int}$\C{the added cost of breaking a
list here}\par
\fi

\M176. Anyone who has been reading the last few sections of the program will
be able to guess what comes next.

\Y\P\4\&{function}\1\  \37$\\{new\_penalty}(\|m:\\{integer})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{type}(\|p)\K\\{penalty\_node}$;\5
$\\{subtype}(\|p)\K0$;\C{the \\{subtype} is not used}\6
$\\{penalty}(\|p)\K\|m$;\5
$\\{new\_penalty}\K\|p$;\6
\&{end};\par
\fi

\M177. You might think that we have introduced enough node types by now. Well,
almost, but there is one more: An \\{unset\_node} has nearly the same format
as an \\{hlist\_node} or \\{vlist\_node}; it is used for entries in \.{%
\\halign}
or \.{\\valign} that are not yet in their final form, since the box
dimensions are their ``natural'' sizes before any glue adjustment has been
made. The \\{glue\_set} word is not present; instead, we have a \\{glue%
\_stretch}
field, which contains the total stretch of order \\{glue\_order} that is
present in the hlist or vlist being boxed.
Similarly, the \\{shift\_amount} field is replaced by a \\{glue\_shrink} field,
containing the total shrink of order \\{glue\_sign} that is present.
The \\{subtype} field is called \\{span\_count}; an unset box typically
contains the data for $\\{qo}(\\{span\_count})+1$ columns.
Unset nodes will be changed to box nodes when alignment is completed.

\Y\P\D \37$\\{unset\_node}=13$\C{\\{type} for an unset node}\par
\P\D \37$\\{glue\_stretch}(\#)\S\\{mem}[\#+\\{glue\_offset}].\\{sc}$\C{total
stretch in an unset node}\par
\P\D \37$\\{glue\_shrink}\S\\{shift\_amount}$\C{total shrink in an unset node}%
\par
\P\D \37$\\{span\_count}\S\\{subtype}$\C{indicates the number of spanned
columns}\par
\fi

\M178. In fact, there are still more types coming. When we get to math formula
processing we will see that a \\{style\_node} has $\\{type}=14$; and a number
of larger type codes will also be defined, for use in math mode only.

\fi

\M179. Warning: If any changes are made to these data structure layouts, such
as
changing any of the node sizes or even reordering the words of nodes,
the \\{copy\_node\_list} procedure and the memory initialization code
below may have to be changed. Such potentially dangerous parts of the
program are listed in the index under `data structure assumptions'.
However, other references to the nodes are made symbolically in terms of
the \.{WEB} macro definitions above, so that format changes will leave
\TeX's other algorithms intact.

\fi

\N180.  \[11] Memory layout.
Some areas of \\{mem} are dedicated to fixed usage, since static allocation is
more efficient than dynamic allocation when we can get away with it. For
example, locations \\{mem\_bot} to $\\{mem\_bot}+3$ are always used to store
the
specification for glue that is `\.{0pt plus 0pt minus 0pt}'. The
following macro definitions accomplish the static allocation by giving
symbolic names to the fixed positions. Static variable-size nodes appear
in locations \\{mem\_bot} through \\{lo\_mem\_stat\_max}, and static
single-word nodes
appear in locations \\{hi\_mem\_stat\_min} through \\{mem\_top}, inclusive. It
is
harmless to let \\{lig\_trick} and \\{garbage} share the same location of %
\\{mem}.

\Y\P\D \37$\\{zero\_glue}\S\\{mem\_bot}$\C{specification for \.{0pt plus 0pt
minus 0pt}}\par
\P\D \37$\\{fil\_glue}\S\\{zero\_glue}+\\{glue\_spec\_size}$\C{\.{0pt plus 1fil
minus 0pt}}\par
\P\D \37$\\{fill\_glue}\S\\{fil\_glue}+\\{glue\_spec\_size}$\C{\.{0pt plus
1fill minus 0pt}}\par
\P\D \37$\\{ss\_glue}\S\\{fill\_glue}+\\{glue\_spec\_size}$\C{\.{0pt plus 1fil
minus 1fil}}\par
\P\D \37$\\{fil\_neg\_glue}\S\\{ss\_glue}+\\{glue\_spec\_size}$\C{\.{0pt plus
-1fil minus 0pt}}\par
\P\D \37$\\{lo\_mem\_stat\_max}\S\\{fil\_neg\_glue}+\\{glue\_spec\_size}-1$%
\C{largest statically   allocated word in the variable-size \\{mem}}\Y\par
\P\D \37$\\{page\_ins\_head}\S\\{mem\_top}$\C{list of insertion data for
current page}\par
\P\D \37$\\{contrib\_head}\S\\{mem\_top}-1$\C{vlist of items not yet on current
page}\par
\P\D \37$\\{page\_head}\S\\{mem\_top}-2$\C{vlist for current page}\par
\P\D \37$\\{temp\_head}\S\\{mem\_top}-3$\C{head of a temporary list of some
kind}\par
\P\D \37$\\{hold\_head}\S\\{mem\_top}-4$\C{head of a temporary list of another
kind}\par
\P\D \37$\\{adjust\_head}\S\\{mem\_top}-5$\C{head of adjustment list returned
by \\{hpack}}\par
\P\D \37$\\{active}\S\\{mem\_top}-7$\C{head of active list in \\{line\_break},
needs two words}\par
\P\D \37$\\{align\_head}\S\\{mem\_top}-8$\C{head of preamble list for
alignments}\par
\P\D \37$\\{end\_span}\S\\{mem\_top}-9$\C{tail of spanned-width lists}\par
\P\D \37$\\{omit\_template}\S\\{mem\_top}-10$\C{a constant token list}\par
\P\D \37$\\{null\_list}\S\\{mem\_top}-11$\C{permanently empty list}\par
\P\D \37$\\{lig\_trick}\S\\{mem\_top}-12$\C{a ligature masquerading as a %
\\{char\_node}}\par
\P\D \37$\\{garbage}\S\\{mem\_top}-12$\C{used for scrap information}\par
\P\D \37$\\{backup\_head}\S\\{mem\_top}-13$\C{head of token list built by %
\\{scan\_keyword}}\par
\P\D \37$\\{pre\_adjust\_head}\S\\{mem\_top}-14$\C{head of pre-adjustment list
returned by \\{hpack}}\par
\P\D \37$\\{hi\_mem\_stat\_min}\S\\{mem\_top}-14$\C{smallest statically
allocated word in   the one-word \\{mem}}\par
\P\D \37$\\{hi\_mem\_stat\_usage}=15$\C{the number of one-word nodes always
present}\par
\fi

\M181. The following code gets \\{mem} off to a good start, when \TeX\ is
initializing itself the slow~way.

\Y\P$\4\X19:Local variables for initialization\X\mathrel{+}\S$\6
\4\|k: \37\\{integer};\C{index into \\{mem}, \\{eqtb}, etc.}\par
\fi

\M182. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X\S$\6
\&{for} $\|k\K\\{mem\_bot}+1\mathrel{\&{to}}\\{lo\_mem\_stat\_max}$ \1\&{do}\5
$\\{mem}[\|k].\\{sc}\K0$;\C{all glue dimensions are zeroed}\2\6
$\|k\K\\{mem\_bot}$;\ \&{while} $\|k\L\\{lo\_mem\_stat\_max}$ \1\&{do}\C{set
first words of glue specifications}\6
\&{begin} \37$\\{glue\_ref\_count}(\|k)\K\\{null}+1$;\5
$\\{stretch\_order}(\|k)\K\\{normal}$;\5
$\\{shrink\_order}(\|k)\K\\{normal}$;\5
$\|k\K\|k+\\{glue\_spec\_size}$;\6
\&{end};\2\6
$\\{stretch}(\\{fil\_glue})\K\\{unity}$;\5
$\\{stretch\_order}(\\{fil\_glue})\K\\{fil}$;\6
$\\{stretch}(\\{fill\_glue})\K\\{unity}$;\5
$\\{stretch\_order}(\\{fill\_glue})\K\\{fill}$;\6
$\\{stretch}(\\{ss\_glue})\K\\{unity}$;\5
$\\{stretch\_order}(\\{ss\_glue})\K\\{fil}$;\6
$\\{shrink}(\\{ss\_glue})\K\\{unity}$;\5
$\\{shrink\_order}(\\{ss\_glue})\K\\{fil}$;\6
$\\{stretch}(\\{fil\_neg\_glue})\K-\\{unity}$;\5
$\\{stretch\_order}(\\{fil\_neg\_glue})\K\\{fil}$;\6
$\\{rover}\K\\{lo\_mem\_stat\_max}+1$;\5
$\\{link}(\\{rover})\K\\{empty\_flag}$;\C{now initialize the dynamic memory}\6
$\\{node\_size}(\\{rover})\K1000$;\C{which is a 1000-word available node}\6
$\\{llink}(\\{rover})\K\\{rover}$;\5
$\\{rlink}(\\{rover})\K\\{rover}$;\6
$\\{lo\_mem\_max}\K\\{rover}+1000$;\5
$\\{link}(\\{lo\_mem\_max})\K\\{null}$;\5
$\\{info}(\\{lo\_mem\_max})\K\\{null}$;\6
\&{for} $\|k\K\\{hi\_mem\_stat\_min}\mathrel{\&{to}}\\{mem\_top}$ \1\&{do}\5
$\\{mem}[\|k]\K\\{mem}[\\{lo\_mem\_max}]$;\C{clear list heads}\2\6
\X966:Initialize the special list heads and constant nodes\X;\6
$\\{avail}\K\\{null}$;\5
$\\{mem\_end}\K\\{mem\_top}$;\5
$\\{hi\_mem\_min}\K\\{hi\_mem\_stat\_min}$;\C{initialize the one-word memory}\6
$\\{var\_used}\K\\{lo\_mem\_stat\_max}+1-\\{mem\_bot}$;\5
$\\{dyn\_used}\K\\{hi\_mem\_stat\_usage}$;\C{initialize statistics}\par
\As240, 246, 250, 258, 268, 277, 578, 672, 1064, 1123, 1128, 1394, 1479, 1616,
1653, 1818\ETs1854.
\U8.\fi

\M183. If \TeX\ is extended improperly, the \\{mem} array might get screwed up.
For example, some pointers might be wrong, or some ``dead'' nodes might not
have been freed when the last reference to them disappeared. Procedures
\\{check\_mem} and \\{search\_mem} are available to help diagnose such
problems. These procedures make use of two arrays called \\{free} and
\\{was\_free} that are present only if \TeX's debugging routines have
been included. (You may want to decrease the size of \\{mem} while you
are debugging.)

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\&{debug} \37\\{free}: \37\&{packed} \37\&{array} $[\\{mem\_min}\to\\{mem%
\_max}]$ \1\&{of}\5
\\{boolean};\C{free cells}\2\6
\4\hbox{\hskip10pt}\\{was\_free}: \37\&{packed} \37\&{array} $[\\{mem\_min}\to%
\\{mem\_max}]$ \1\&{of}\5
\\{boolean};\C{previously free cells}\2\6
\4$\hbox{\hskip10pt}\\{was\_mem\_end},\39\\{was\_lo\_max},\39\\{was\_hi\_min}$:
\37\\{pointer};\C{previous \\{mem\_end}, \\{lo\_mem\_max}, and \\{hi\_mem%
\_min}}\6
\4\hbox{\hskip10pt}\\{panicking}: \37\\{boolean};\C{do we want to check memory
constantly?}\6
\&{gubed}\par
\fi

\M184. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{debug} \37$\\{was\_mem\_end}\K\\{mem\_min}$;\C{indicate that everything was
previously free}\6
$\\{was\_lo\_max}\K\\{mem\_min}$;\5
$\\{was\_hi\_min}\K\\{mem\_max}$;\5
$\\{panicking}\K\\{false}$;\6
\&{gubed}\par
\fi

\M185. Procedure \\{check\_mem} makes sure that the available space lists of
\\{mem} are well formed, and it optionally prints out all locations
that are reserved now but were free the last time this procedure was called.

\Y\P\&{debug} \37\&{procedure}\1\  \37$\\{check\_mem}(\\{print\_locs}:%
\\{boolean})$;\6
\4\&{label} \37$\\{done1},\39\\{done2}$;\C{loop exits}\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{current locations of interest in %
\\{mem}}\6
\\{clobbered}: \37\\{boolean};\C{is something amiss?}\2\6
\&{begin} \37\&{for} $\|p\K\\{mem\_min}\mathrel{\&{to}}\\{lo\_mem\_max}$ \1%
\&{do}\5
$\\{free}[\|p]\K\\{false}$;\C{you can probably   do this faster}\2\6
\&{for} $\|p\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\5
$\\{free}[\|p]\K\\{false}$;\C{ditto}\2\6
\X186:Check single-word \\{avail} list\X;\6
\X187:Check variable-size \\{avail} list\X;\6
\X188:Check flags of unavailable nodes\X;\6
\&{if} $\\{print\_locs}$ \1\&{then}\5
\X189:Print newly busy locations\X;\2\6
\&{for} $\|p\K\\{mem\_min}\mathrel{\&{to}}\\{lo\_mem\_max}$ \1\&{do}\5
$\\{was\_free}[\|p]\K\\{free}[\|p]$;\2\6
\&{for} $\|p\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\5
$\\{was\_free}[\|p]\K\\{free}[\|p]$;\C{$\\{was\_free}\K\\{free}$ might be
faster}\2\6
$\\{was\_mem\_end}\K\\{mem\_end}$;\5
$\\{was\_lo\_max}\K\\{lo\_mem\_max}$;\5
$\\{was\_hi\_min}\K\\{hi\_mem\_min}$;\6
\&{end};\6
\&{gubed}\par
\fi

\M186. \P$\X186:Check single-word \\{avail} list\X\S$\6
$\|p\K\\{avail}$;\5
$\|q\K\\{null}$;\5
$\\{clobbered}\K\\{false}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $(\|p>\\{mem\_end})\V(\|p<\\{hi\_mem\_min})$ \1\&{then}\5
$\\{clobbered}\K\\{true}$\6
\4\&{else} \&{if} $\\{free}[\|p]$ \1\&{then}\5
$\\{clobbered}\K\\{true}$;\2\2\6
\&{if} $\\{clobbered}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"AVAIL\ list\ clobbered\ at\ "})$;\5
$\\{print\_int}(\|q)$;\5
\&{goto} \37\\{done1};\6
\&{end};\2\6
$\\{free}[\|p]\K\\{true}$;\5
$\|q\K\|p$;\5
$\|p\K\\{link}(\|q)$;\6
\&{end};\2\6
\4\\{done1}: \37\par
\U185.\fi

\M187. \P$\X187:Check variable-size \\{avail} list\X\S$\6
$\|p\K\\{rover}$;\5
$\|q\K\\{null}$;\5
$\\{clobbered}\K\\{false}$;\6
\1\&{repeat} \37\&{if} $(\|p\G\\{lo\_mem\_max})\V(\|p<\\{mem\_min})$ \1\&{then}%
\5
$\\{clobbered}\K\\{true}$\6
\4\&{else} \&{if} $(\\{rlink}(\|p)\G\\{lo\_mem\_max})\V(\\{rlink}(\|p)<\\{mem%
\_min})$ \1\&{then}\5
$\\{clobbered}\K\\{true}$\6
\4\&{else} \&{if} $\R(\\{is\_empty}(\|p))\V(\\{node\_size}(\|p)<2)\V\30(\|p+%
\\{node\_size}(\|p)>\\{lo\_mem\_max})\V\30(\\{llink}(\\{rlink}(\|p))\I\|p)$ \1%
\&{then}\5
$\\{clobbered}\K\\{true}$;\2\2\2\6
\&{if} $\\{clobbered}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Double-AVAIL\ list\ clobbered\ at\ "})$;\5
$\\{print\_int}(\|q)$;\5
\&{goto} \37\\{done2};\6
\&{end};\2\6
\&{for} $\|q\K\|p\mathrel{\&{to}}\|p+\\{node\_size}(\|p)-1$ \1\&{do}\C{mark all
locations free}\6
\&{begin} \37\&{if} $\\{free}[\|q]$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Doubly\ free\ location\ at\ "})$;\5
$\\{print\_int}(\|q)$;\5
\&{goto} \37\\{done2};\6
\&{end};\2\6
$\\{free}[\|q]\K\\{true}$;\6
\&{end};\2\6
$\|q\K\|p$;\5
$\|p\K\\{rlink}(\|p)$;\6
\4\&{until}\5
$\|p=\\{rover}$;\2\6
\4\\{done2}: \37\par
\U185.\fi

\M188. \P$\X188:Check flags of unavailable nodes\X\S$\6
$\|p\K\\{mem\_min}$;\6
\&{while} $\|p\L\\{lo\_mem\_max}$ \1\&{do}\C{node \|p should not be empty}\6
\&{begin} \37\&{if} $\\{is\_empty}(\|p)$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Bad\ flag\ at\ "})$;\5
$\\{print\_int}(\|p)$;\6
\&{end};\2\6
\&{while} $(\|p\L\\{lo\_mem\_max})\W\R\\{free}[\|p]$ \1\&{do}\5
$\\{incr}(\|p)$;\2\6
\&{while} $(\|p\L\\{lo\_mem\_max})\W\\{free}[\|p]$ \1\&{do}\5
$\\{incr}(\|p)$;\2\6
\&{end}\2\par
\U185.\fi

\M189. \P$\X189:Print newly busy locations\X\S$\6
\&{begin} \37$\\{print\_nl}(\.{"New\ busy\ locs:"})$;\6
\&{for} $\|p\K\\{mem\_min}\mathrel{\&{to}}\\{lo\_mem\_max}$ \1\&{do}\6
\&{if} $\R\\{free}[\|p]\W((\|p>\\{was\_lo\_max})\V\\{was\_free}[\|p])$ \1%
\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\|p)$;\6
\&{end};\2\2\6
\&{for} $\|p\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\6
\&{if} $\R\\{free}[\|p]\W((\|p<\\{was\_hi\_min})\V(\|p>\\{was\_mem\_end})\V%
\\{was\_free}[\|p])$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\|p)$;\6
\&{end};\2\2\6
\&{end}\par
\U185.\fi

\M190. The \\{search\_mem} procedure attempts to answer the question ``Who
points
to node~\|p?'' In doing so, it fetches \\{link} and \\{info} fields of \\{mem}
that might not be of type \\{two\_halves}. Strictly speaking, this is
undefined in \PASCAL, and it can lead to ``false drops'' (words that seem to
point to \|p purely by coincidence). But for debugging purposes, we want
to rule out the places that do {\sl not\/} point to \|p, so a few false
drops are tolerable.

\Y\P\&{debug} \37\&{procedure}\1\  \37$\\{search\_mem}(\|p:\\{pointer})$;%
\C{look for pointers to \|p}\6
\4\&{var} \37\|q: \37\\{integer};\C{current position being searched}\2\6
\&{begin} \37\&{for} $\|q\K\\{mem\_min}\mathrel{\&{to}}\\{lo\_mem\_max}$ \1%
\&{do}\6
\&{begin} \37\&{if} $\\{link}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"LINK("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{if} $\\{info}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"INFO("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{end};\2\6
\&{for} $\|q\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{link}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"LINK("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{if} $\\{info}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"INFO("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{end};\2\6
\X273:Search \\{eqtb} for equivalents equal to \|p\X;\6
\X307:Search \\{save\_stack} for equivalents that point to \|p\X;\6
\X1110:Search \\{hyph\_list} for pointers to \|p\X;\6
\&{end};\6
\&{gubed}\X686:Declare procedures that need to be declared forward for \pdfTeX%
\X\par
\fi

\N191.  \[12] Displaying boxes.
We can reinforce our knowledge of the data structures just introduced
by considering two procedures that display a list in symbolic form.
The first of these, called \\{short\_display}, is used in ``overfull box''
messages to give the top-level description of a list. The other one,
called \\{show\_node\_list}, prints a detailed description of exactly what
is in the data structure.

The philosophy of \\{short\_display} is to ignore the fine points about exactly
what is inside boxes, except that ligatures and discretionary breaks are
expanded. As a result, \\{short\_display} is a recursive procedure, but the
recursion is never more than one level deep.

A global variable \\{font\_in\_short\_display} keeps track of the font code
that
is assumed to be present when \\{short\_display} begins; deviations from this
font will be printed.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{font\_in\_short\_display}: \37\\{integer};\C{an internal font number}\par
\fi

\M192. Boxes, rules, inserts, whatsits, marks, and things in general that are
sort of ``complicated'' are indicated only by printing `\.{[]}'.

\Y\P\4\&{procedure}\1\  \37$\\{print\_font\_identifier}(\|f:\\{internal\_font%
\_number})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_blink}[\|f]=\\{null\_font}$ \1\&{then}\5
$\\{print\_esc}(\\{font\_id\_text}(\|f))$\6
\4\&{else} $\\{print\_esc}(\\{font\_id\_text}(\\{pdf\_font\_blink}[\|f]))$;\2\6
\&{if} $\\{pdf\_tracing\_fonts}>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\5
$\\{print}(\\{font\_name}[\|f])$;\6
\&{if} $\\{font\_size}[\|f]\I\\{font\_dsize}[\|f]$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"@"})$;\5
$\\{print\_scaled}(\\{font\_size}[\|f])$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\2\6
$\\{print}(\.{")"})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{pdf\_font\_expand\_ratio}[\|f]\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\6
\&{if} $\\{pdf\_font\_expand\_ratio}[\|f]>0$ \1\&{then}\5
$\\{print}(\.{"+"})$;\2\6
$\\{print\_int}(\\{pdf\_font\_expand\_ratio}[\|f])$;\5
$\\{print}(\.{")"})$;\6
\&{end};\2\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{short\_display}(\|p:\\{integer})$;\C{prints
highlights of list \|p}\6
\4\&{var} \37\|n: \37\\{integer};\C{for replacement counts}\2\6
\&{begin} \37\&{while} $\|p>\\{mem\_min}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37\&{if} $\|p\L\\{mem\_end}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{font}(\|p)\I\\{font\_in\_short\_display}$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{font}(\|p)<\\{font\_base})\V(\\{font}(\|p)>\\{font%
\_max})$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} $\\{print\_font\_identifier}(\\{font}(\|p))$;\2\6
$\\{print\_char}(\.{"\ "})$;\5
$\\{font\_in\_short\_display}\K\\{font}(\|p)$;\6
\&{end};\2\6
$\\{print\_ASCII}(\\{qo}(\\{character}(\|p)))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \X193:Print a short indication of the contents of node \|p\X;\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M193. \P$\X193:Print a short indication of the contents of node \|p\X\S$\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{ins\_node},\39\\{whatsit\_node},\39%
\\{mark\_node},\39\\{adjust\_node},\39\\{unset\_node}$: \37$\\{print}(%
\.{"[]"})$;\6
\4\\{rule\_node}: \37$\\{print\_char}(\.{"|"})$;\6
\4\\{glue\_node}: \37\&{if} $\\{glue\_ptr}(\|p)\I\\{zero\_glue}$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\6
\4\\{math\_node}: \37\&{if} $\\{subtype}(\|p)\G\\{L\_code}$ \1\&{then}\5
$\\{print}(\.{"[]"})$\6
\4\&{else} $\\{print\_char}(\.{"\$"})$;\2\6
\4\\{ligature\_node}: \37$\\{short\_display}(\\{lig\_ptr}(\|p))$;\6
\4\\{disc\_node}: \37\&{begin} \37$\\{short\_display}(\\{pre\_break}(\|p))$;\5
$\\{short\_display}(\\{post\_break}(\|p))$;\6
$\|n\K\\{replace\_count}(\|p)$;\6
\&{while} $\|n>0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{link}(\|p)\I\\{null}$ \1\&{then}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{decr}(\|n)$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases}\par
\Us192\ET674.\fi

\M194. The \\{show\_node\_list} routine requires some auxiliary subroutines:
one to
print a font-and-character combination, one to print a token list without
its reference count, and one to print a rule dimension.

\Y\P\4\&{procedure}\1\  \37$\\{print\_font\_and\_char}(\|p:\\{integer})$;%
\C{prints \\{char\_node} data}\2\6
\&{begin} \37\&{if} $\|p>\\{mem\_end}$ \1\&{then}\5
$\\{print\_esc}(\.{"CLOBBERED."})$\6
\4\&{else} \&{begin} \37\&{if} $(\\{font}(\|p)<\\{font\_base})\V(\\{font}(\|p)>%
\\{font\_max})$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} $\\{print\_font\_identifier}(\\{font}(\|p))$;\2\6
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_ASCII}(\\{qo}(\\{character}(\|p)))$;\6
\&{end};\2\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{print\_mark}(\|p:\\{integer})$;\C{prints token list
data in braces}\2\6
\&{begin} \37$\\{print\_char}(\.{"\{"})$;\6
\&{if} $(\|p<\\{hi\_mem\_min})\V(\|p>\\{mem\_end})$ \1\&{then}\5
$\\{print\_esc}(\.{"CLOBBERED."})$\6
\4\&{else} $\\{show\_token\_list}(\\{link}(\|p),\39\\{null},\39\\{max\_print%
\_line}-10)$;\2\6
$\\{print\_char}(\.{"\}"})$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{print\_rule\_dimen}(\|d:\\{scaled})$;\C{prints
dimension in rule node}\2\6
\&{begin} \37\&{if} $\\{is\_running}(\|d)$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} $\\{print\_scaled}(\|d)$;\2\6
\&{end};\par
\fi

\M195. Then there is a subroutine that prints glue stretch and shrink, possibly
followed by the name of finite units:

\Y\P\4\&{procedure}\1\  \37$\\{print\_glue}(\|d:\\{scaled};\,\35\\{order}:%
\\{integer};\,\35\|s:\\{str\_number})$;\C{prints a glue component}\2\6
\&{begin} \37$\\{print\_scaled}(\|d)$;\6
\&{if} $(\\{order}<\\{normal})\V(\\{order}>\\{filll})$ \1\&{then}\5
$\\{print}(\.{"foul"})$\6
\4\&{else} \&{if} $\\{order}>\\{normal}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"fil"})$;\6
\&{while} $\\{order}>\\{fil}$ \1\&{do}\6
\&{begin} \37$\\{print\_char}(\.{"l"})$;\5
$\\{decr}(\\{order})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\|s\I0$ \1\&{then}\5
$\\{print}(\|s)$;\2\2\2\6
\&{end};\par
\fi

\M196. The next subroutine prints a whole glue specification.

\Y\P\4\&{procedure}\1\  \37$\\{print\_spec}(\|p:\\{integer};\,\35\|s:\\{str%
\_number})$;\C{prints a glue specification}\2\6
\&{begin} \37\&{if} $(\|p<\\{mem\_min})\V(\|p\G\\{lo\_mem\_max})$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} \&{begin} \37$\\{print\_scaled}(\\{width}(\|p))$;\6
\&{if} $\|s\I0$ \1\&{then}\5
$\\{print}(\|s)$;\2\6
\&{if} $\\{stretch}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ plus\ "})$;\5
$\\{print\_glue}(\\{stretch}(\|p),\39\\{stretch\_order}(\|p),\39\|s)$;\6
\&{end};\2\6
\&{if} $\\{shrink}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ minus\ "})$;\5
$\\{print\_glue}(\\{shrink}(\|p),\39\\{shrink\_order}(\|p),\39\|s)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M197. We also need to declare some procedures that appear later in this
documentation.

\Y\P\X867:Declare procedures needed for displaying the elements of mlists\X\6
\X243:Declare the procedure called \\{print\_skip\_param}\X\par
\fi

\M198. Since boxes can be inside of boxes, \\{show\_node\_list} is inherently
recursive,
up to a given maximum number of levels.  The history of nesting is indicated
by the current string, which will be printed at the beginning of each line;
the length of this string, namely \\{cur\_length}, is the depth of nesting.

Recursive calls on \\{show\_node\_list} therefore use the following pattern:

\Y\P\D \37$\\{node\_list\_display}(\#)\S$\1\6
\&{begin} \37$\\{append\_char}(\.{"."})$;\5
$\\{show\_node\_list}(\#)$;\5
\\{flush\_char};\6
\&{end}\C{\\{str\_room} need not be checked; see \\{show\_box} below}\2\par
\fi

\M199. A global variable called \\{depth\_threshold} is used to record the
maximum
depth of nesting for which \\{show\_node\_list} will show information.  If we
have $\\{depth\_threshold}=0$, for example, only the top level information will
be given and no sublists will be traversed. Another global variable, called
\\{breadth\_max}, tells the maximum number of items to show at each level;
\\{breadth\_max} had better be positive, or you won't see anything.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{depth\_threshold}: \37\\{integer};\C{maximum nesting depth in box
displays}\6
\4\\{breadth\_max}: \37\\{integer};\C{maximum number of items shown at the same
list level}\par
\fi

\M200. Now we are ready for \\{show\_node\_list} itself. This procedure has
been
written to be ``extra robust'' in the sense that it should not crash or get
into a loop even if the data structures have been messed up by bugs in
the rest of the program. You can safely call its parent routine
$\\{show\_box}(\|p)$ for arbitrary values of \|p when you are debugging \TeX.
However, in the presence of bad data, the procedure may
fetch a \\{memory\_word} whose variant is different from the way it was stored;
for example, it might try to read $\\{mem}[\|p].\\{hh}$ when $\\{mem}[\|p]$
contains a scaled integer, if \|p is a pointer that has been
clobbered or chosen at random.

\Y\P\4\&{procedure}\1\  \37$\\{show\_node\_list}(\|p:\\{integer})$;\C{prints a
node list symbolically}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|n: \37\\{integer};\C{the number of items already printed at this
level}\6
\|g: \37\\{real};\C{a glue ratio, as a floating point number}\2\6
\&{begin} \37\&{if} $\\{cur\_length}>\\{depth\_threshold}$ \1\&{then}\6
\&{begin} \37\&{if} $\|p>\\{null}$ \1\&{then}\5
$\\{print}(\.{"\ []"})$;\C{indicate that there's been some truncation}\2\6
\&{return};\6
\&{end};\2\6
$\|n\K0$;\6
\&{while} $\|p>\\{mem\_min}$ \1\&{do}\6
\&{begin} \37\\{print\_ln};\5
\\{print\_current\_string};\C{display the nesting history}\6
\&{if} $\|p>\\{mem\_end}$ \1\&{then}\C{pointer out of range}\6
\&{begin} \37$\\{print}(\.{"Bad\ link,\ display\ aborted."})$;\5
\&{return};\6
\&{end};\2\6
$\\{incr}(\|n)$;\6
\&{if} $\|n>\\{breadth\_max}$ \1\&{then}\C{time to stop}\6
\&{begin} \37$\\{print}(\.{"etc."})$;\5
\&{return};\6
\&{end};\2\6
\X201:Display node \|p\X;\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M201. \P$\X201:Display node \|p\X\S$\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{print\_font\_and\_char}(\|p)$\6
\4\&{else} \&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{unset\_node}$: \37\X202:Display box
\|p\X;\6
\4\\{rule\_node}: \37\X205:Display rule \|p\X;\6
\4\\{ins\_node}: \37\X206:Display insertion \|p\X;\6
\4\\{whatsit\_node}: \37\X1603:Display the whatsit node \|p\X;\6
\4\\{glue\_node}: \37\X207:Display glue \|p\X;\6
\4\\{margin\_kern\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"kern"})$;\5
$\\{print\_scaled}(\\{width}(\|p))$;\6
\&{if} $\\{subtype}(\|p)=\\{left\_side}$ \1\&{then}\5
$\\{print}(\.{"\ (left\ margin)"})$\6
\4\&{else} $\\{print}(\.{"\ (right\ margin)"})$;\2\6
\&{end};\6
\4\\{kern\_node}: \37\X209:Display kern \|p\X;\6
\4\\{math\_node}: \37\X210:Display math node \|p\X;\6
\4\\{ligature\_node}: \37\X211:Display ligature \|p\X;\6
\4\\{penalty\_node}: \37\X212:Display penalty \|p\X;\6
\4\\{disc\_node}: \37\X213:Display discretionary \|p\X;\6
\4\\{mark\_node}: \37\X214:Display mark \|p\X;\6
\4\\{adjust\_node}: \37\X215:Display adjustment \|p\X;\6
\hbox{\4}\X866:Cases of \\{show\_node\_list} that arise in mlists only\X\6
\4\&{othercases} \37$\\{print}(\.{"Unknown\ node\ type!"})$\2\6
\&{endcases}\2\par
\U200.\fi

\M202. \P$\X202:Display box \|p\X\S$\6
\&{begin} \37\&{if} $\\{type}(\|p)=\\{hlist\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"h"})$\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"v"})$\6
\4\&{else} $\\{print\_esc}(\.{"unset"})$;\2\2\6
$\\{print}(\.{"box("})$;\5
$\\{print\_scaled}(\\{height}(\|p))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_scaled}(\\{depth}(\|p))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_scaled}(\\{width}(\|p))$;\6
\&{if} $\\{type}(\|p)=\\{unset\_node}$ \1\&{then}\5
\X203:Display special fields of the unset node \|p\X\6
\4\&{else} \&{begin} \37\X204:Display the value of $\\{glue\_set}(\|p)$\X;\6
\&{if} $\\{shift\_amount}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ shifted\ "})$;\5
$\\{print\_scaled}(\\{shift\_amount}(\|p))$;\6
\&{end};\2\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1704:Display if this box is never to be reversed\X;\2\6
\&{end};\2\6
$\\{node\_list\_display}(\\{list\_ptr}(\|p))$;\C{recursive call}\6
\&{end}\par
\U201.\fi

\M203. \P$\X203:Display special fields of the unset node \|p\X\S$\6
\&{begin} \37\&{if} $\\{span\_count}(\|p)\I\\{min\_quarterword}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\5
$\\{print\_int}(\\{qo}(\\{span\_count}(\|p))+1)$;\5
$\\{print}(\.{"\ columns)"})$;\6
\&{end};\2\6
\&{if} $\\{glue\_stretch}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ stretch\ "})$;\5
$\\{print\_glue}(\\{glue\_stretch}(\|p),\39\\{glue\_order}(\|p),\390)$;\6
\&{end};\2\6
\&{if} $\\{glue\_shrink}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ shrink\ "})$;\5
$\\{print\_glue}(\\{glue\_shrink}(\|p),\39\\{glue\_sign}(\|p),\390)$;\6
\&{end};\2\6
\&{end}\par
\U202.\fi

\M204. The code will have to change in this place if \\{glue\_ratio} is
a structured type instead of an ordinary \\{real}. Note that this routine
should avoid arithmetic errors even if the \\{glue\_set} field holds an
arbitrary random value. The following code assumes that a properly
formed nonzero \\{real} number has absolute value $2^{20}$ or more when
it is regarded as an integer; this precaution was adequate to prevent
floating point underflow on the author's computer.

\Y\P$\4\X204:Display the value of $\\{glue\_set}(\|p)$\X\S$\6
$\|g\K\\{float}(\\{glue\_set}(\|p))$;\6
\&{if} $(\|g\I\\{float\_constant}(0))\W(\\{glue\_sign}(\|p)\I\\{normal})$ \1%
\&{then}\6
\&{begin} \37$\\{print}(\.{",\ glue\ set\ "})$;\6
\&{if} $\\{glue\_sign}(\|p)=\\{shrinking}$ \1\&{then}\5
$\\{print}(\.{"-\ "})$;\2\6
\&{if} $\\{abs}(\\{mem}[\|p+\\{glue\_offset}].\\{int})<\O{4000000}$ \1\&{then}\5
$\\{print}(\.{"?.?"})$\6
\4\&{else} \&{if} $\\{abs}(\|g)>\\{float\_constant}(20000)$ \1\&{then}\6
\&{begin} \37\&{if} $\|g>\\{float\_constant}(0)$ \1\&{then}\5
$\\{print\_char}(\.{">"})$\6
\4\&{else} $\\{print}(\.{"<\ -"})$;\2\6
$\\{print\_glue}(20000\ast\\{unity},\39\\{glue\_order}(\|p),\390)$;\6
\&{end}\6
\4\&{else} $\\{print\_glue}(\\{round}(\\{unity}\ast\|g),\39\\{glue\_order}(%
\|p),\390)$;\2\2\6
\&{end}\2\par
\U202.\fi

\M205. \P$\X205:Display rule \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"rule("})$;\5
$\\{print\_rule\_dimen}(\\{height}(\|p))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_rule\_dimen}(\\{depth}(\|p))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_rule\_dimen}(\\{width}(\|p))$;\6
\&{end}\par
\U201.\fi

\M206. \P$\X206:Display insertion \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"insert"})$;\5
$\\{print\_int}(\\{qo}(\\{subtype}(\|p)))$;\5
$\\{print}(\.{",\ natural\ size\ "})$;\5
$\\{print\_scaled}(\\{height}(\|p))$;\5
$\\{print}(\.{";\ split("})$;\5
$\\{print\_spec}(\\{split\_top\_ptr}(\|p),\390)$;\5
$\\{print\_char}(\.{","})$;\5
$\\{print\_scaled}(\\{depth}(\|p))$;\5
$\\{print}(\.{");\ float\ cost\ "})$;\5
$\\{print\_int}(\\{float\_cost}(\|p))$;\5
$\\{node\_list\_display}(\\{ins\_ptr}(\|p))$;\C{recursive call}\6
\&{end}\par
\U201.\fi

\M207. \P$\X207:Display glue \|p\X\S$\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\X208:Display leaders \|p\X\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"glue"})$;\6
\&{if} $\\{subtype}(\|p)\I\\{normal}$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"("})$;\6
\&{if} $\\{subtype}(\|p)<\\{cond\_math\_glue}$ \1\&{then}\5
$\\{print\_skip\_param}(\\{subtype}(\|p)-1)$\6
\4\&{else} \&{if} $\\{subtype}(\|p)=\\{cond\_math\_glue}$ \1\&{then}\5
$\\{print\_esc}(\.{"nonscript"})$\6
\4\&{else} $\\{print\_esc}(\.{"mskip"})$;\2\2\6
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{if} $\\{subtype}(\|p)\I\\{cond\_math\_glue}$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"\ "})$;\6
\&{if} $\\{subtype}(\|p)<\\{cond\_math\_glue}$ \1\&{then}\5
$\\{print\_spec}(\\{glue\_ptr}(\|p),\390)$\6
\4\&{else} $\\{print\_spec}(\\{glue\_ptr}(\|p),\39\.{"mu"})$;\2\6
\&{end};\2\6
\&{end}\2\par
\U201.\fi

\M208. \P$\X208:Display leaders \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{""})$;\6
\&{if} $\\{subtype}(\|p)=\\{c\_leaders}$ \1\&{then}\5
$\\{print\_char}(\.{"c"})$\6
\4\&{else} \&{if} $\\{subtype}(\|p)=\\{x\_leaders}$ \1\&{then}\5
$\\{print\_char}(\.{"x"})$;\2\2\6
$\\{print}(\.{"leaders\ "})$;\5
$\\{print\_spec}(\\{glue\_ptr}(\|p),\390)$;\5
$\\{node\_list\_display}(\\{leader\_ptr}(\|p))$;\C{recursive call}\6
\&{end}\par
\U207.\fi

\M209. An ``explicit'' kern value is indicated implicitly by an explicit space.

\Y\P$\4\X209:Display kern \|p\X\S$\6
\&{if} $\\{subtype}(\|p)\I\\{mu\_glue}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"kern"})$;\6
\&{if} $\\{subtype}(\|p)\I\\{normal}$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\6
$\\{print\_scaled}(\\{width}(\|p))$;\6
\&{if} $\\{subtype}(\|p)=\\{acc\_kern}$ \1\&{then}\5
$\\{print}(\.{"\ (for\ accent)"})$;\2\6
\&{if} $\\{subtype}(\|p)=\\{auto\_kern}$ \1\&{then}\5
$\\{print}(\.{"\ (for\ \\pdfprependkern/\\pdfappendkern)"})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"mkern"})$;\5
$\\{print\_scaled}(\\{width}(\|p))$;\5
$\\{print}(\.{"mu"})$;\6
\&{end}\2\par
\U201.\fi

\M210. \P$\X210:Display math node \|p\X\S$\6
\&{if} $\\{subtype}(\|p)>\\{after}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\5
$\\{print\_esc}(\.{"end"})$\6
\4\&{else} $\\{print\_esc}(\.{"begin"})$;\2\6
\&{if} $\\{subtype}(\|p)>\\{R\_code}$ \1\&{then}\5
$\\{print\_char}(\.{"R"})$\6
\4\&{else} \&{if} $\\{subtype}(\|p)>\\{L\_code}$ \1\&{then}\5
$\\{print\_char}(\.{"L"})$\6
\4\&{else} $\\{print\_char}(\.{"M"})$;\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"math"})$;\6
\&{if} $\\{subtype}(\|p)=\\{before}$ \1\&{then}\5
$\\{print}(\.{"on"})$\6
\4\&{else} $\\{print}(\.{"off"})$;\2\6
\&{if} $\\{width}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ surrounded\ "})$;\5
$\\{print\_scaled}(\\{width}(\|p))$;\6
\&{end};\2\6
\&{end}\2\par
\U201.\fi

\M211. \P$\X211:Display ligature \|p\X\S$\6
\&{begin} \37$\\{print\_font\_and\_char}(\\{lig\_char}(\|p))$;\5
$\\{print}(\.{"\ (ligature\ "})$;\6
\&{if} $\\{subtype}(\|p)>1$ \1\&{then}\5
$\\{print\_char}(\.{"|"})$;\2\6
$\\{font\_in\_short\_display}\K\\{font}(\\{lig\_char}(\|p))$;\5
$\\{short\_display}(\\{lig\_ptr}(\|p))$;\6
\&{if} $\\{odd}(\\{subtype}(\|p))$ \1\&{then}\5
$\\{print\_char}(\.{"|"})$;\2\6
$\\{print\_char}(\.{")"})$;\6
\&{end}\par
\U201.\fi

\M212. \P$\X212:Display penalty \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"penalty\ "})$;\5
$\\{print\_int}(\\{penalty}(\|p))$;\6
\&{end}\par
\U201.\fi

\M213. The \\{post\_break} list of a discretionary node is indicated by a
prefixed
`\.{\char'174}' instead of the `\..' before the \\{pre\_break} list.

\Y\P$\4\X213:Display discretionary \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"discretionary"})$;\6
\&{if} $\\{replace\_count}(\|p)>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ replacing\ "})$;\5
$\\{print\_int}(\\{replace\_count}(\|p))$;\6
\&{end};\2\6
$\\{node\_list\_display}(\\{pre\_break}(\|p))$;\C{recursive call}\6
$\\{append\_char}(\.{"|"})$;\5
$\\{show\_node\_list}(\\{post\_break}(\|p))$;\5
\\{flush\_char};\C{recursive call}\6
\&{end}\par
\U201.\fi

\M214. \P$\X214:Display mark \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"mark"})$;\6
\&{if} $\\{mark\_class}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"s"})$;\5
$\\{print\_int}(\\{mark\_class}(\|p))$;\6
\&{end};\2\6
$\\{print\_mark}(\\{mark\_ptr}(\|p))$;\6
\&{end}\par
\U201.\fi

\M215. \P$\X215:Display adjustment \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"vadjust"})$;\6
\&{if} $\\{adjust\_pre}(\|p)\I0$ \1\&{then}\5
$\\{print}(\.{"\ pre\ "})$;\2\6
$\\{node\_list\_display}(\\{adjust\_ptr}(\|p))$;\C{recursive call}\6
\&{end}\par
\U201.\fi

\M216. The recursive machinery is started by calling \\{show\_box}.

\Y\P\4\&{procedure}\1\  \37$\\{show\_box}(\|p:\\{pointer})$;\2\6
\&{begin} \37\X254:Assign the values $\\{depth\_threshold}\K\\{show\_box%
\_depth}$ and $\\{breadth\_max}\K\\{show\_box\_breadth}$\X;\6
\&{if} $\\{breadth\_max}\L0$ \1\&{then}\5
$\\{breadth\_max}\K5$;\2\6
\&{if} $\\{pool\_ptr}+\\{depth\_threshold}\G\\{pool\_size}$ \1\&{then}\5
$\\{depth\_threshold}\K\\{pool\_size}-\\{pool\_ptr}-1$;\C{now there's enough
room for prefix string}\2\6
$\\{show\_node\_list}(\|p)$;\C{the show starts at \|p}\6
\\{print\_ln};\6
\&{end};\par
\fi

\N217.  \[13] Destroying boxes.
When we are done with a node list, we are obliged to return it to free
storage, including all of its sublists. The recursive procedure
\\{flush\_node\_list} does this for us.

\fi

\M218. First, however, we shall consider two non-recursive procedures that do
simpler tasks. The first of these, \\{delete\_token\_ref}, is called when
a pointer to a token list's reference count is being removed. This means
that the token list should disappear if the reference count was \\{null},
otherwise the count should be decreased by one.

\Y\P\D \37$\\{token\_ref\_count}(\#)\S\\{info}(\#)$\C{reference count preceding
a token list}\par
\Y\P\4\&{procedure}\1\  \37$\\{delete\_token\_ref}(\|p:\\{pointer})$;\C{\|p
points to the reference count   of a token list that is losing one reference}\2%
\6
\&{begin} \37\&{if} $\\{token\_ref\_count}(\|p)=\\{null}$ \1\&{then}\5
$\\{flush\_list}(\|p)$\6
\4\&{else} $\\{decr}(\\{token\_ref\_count}(\|p))$;\2\6
\&{end};\par
\fi

\M219. Similarly, \\{delete\_glue\_ref} is called when a pointer to a glue
specification is being withdrawn.
\Y\P\D \37$\\{fast\_delete\_glue\_ref}(\#)\S\hbox{}$\6
\&{begin} \37\&{if} $\\{glue\_ref\_count}(\#)=\\{null}$ \1\&{then}\5
$\\{free\_node}(\#,\39\\{glue\_spec\_size})$\6
\4\&{else} $\\{decr}(\\{glue\_ref\_count}(\#))$;\2\6
\&{end}\par
\Y\P\4\&{procedure}\1\  \37$\\{delete\_glue\_ref}(\|p:\\{pointer})$;\C{\|p
points to a glue specification}\6
$\\{fast\_delete\_glue\_ref}(\|p)$;\par
\fi

\M220. Now we are ready to delete any node list, recursively.
In practice, the nodes deleted are usually charnodes (about 2/3 of the time),
and they are glue nodes in about half of the remaining cases.

\Y\P\4\&{procedure}\1\  \37$\\{flush\_node\_list}(\|p:\\{pointer})$;\C{erase
list of nodes starting at \|p}\6
\4\&{label} \37\\{done};\C{go here when node \|p has been freed}\6
\4\&{var} \37\|q: \37\\{pointer};\C{successor to node \|p}\2\6
\&{begin} \37\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|q\K\\{link}(\|p)$;\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{free\_avail}(\|p)$\6
\4\&{else} \&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{unset\_node}$: \37\&{begin} \37$%
\\{flush\_node\_list}(\\{list\_ptr}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{box\_node\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{rule\_node}: \37\&{begin} \37$\\{free\_node}(\|p,\39\\{rule\_node%
\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{ins\_node}: \37\&{begin} \37$\\{flush\_node\_list}(\\{ins\_ptr}(\|p))$;\5
$\\{delete\_glue\_ref}(\\{split\_top\_ptr}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{ins\_node\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1605:Wipe out the whatsit node \|p and \&{goto} %
\\{done}\X;\6
\4\\{glue\_node}: \37\&{begin} \37$\\{fast\_delete\_glue\_ref}(\\{glue\_ptr}(%
\|p))$;\6
\&{if} $\\{leader\_ptr}(\|p)\I\\{null}$ \1\&{then}\5
$\\{flush\_node\_list}(\\{leader\_ptr}(\|p))$;\2\6
\&{end};\6
\4$\\{kern\_node},\39\\{math\_node},\39\\{penalty\_node}$: \37\\{do\_nothing};\6
\4\\{margin\_kern\_node}: \37\&{begin} \37$\\{free\_avail}(\\{margin\_char}(%
\|p))$;\5
$\\{free\_node}(\|p,\39\\{margin\_kern\_node\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{ligature\_node}: \37$\\{flush\_node\_list}(\\{lig\_ptr}(\|p))$;\6
\4\\{mark\_node}: \37$\\{delete\_token\_ref}(\\{mark\_ptr}(\|p))$;\6
\4\\{disc\_node}: \37\&{begin} \37$\\{flush\_node\_list}(\\{pre\_break}(\|p))$;%
\5
$\\{flush\_node\_list}(\\{post\_break}(\|p))$;\6
\&{end};\6
\4\\{adjust\_node}: \37$\\{flush\_node\_list}(\\{adjust\_ptr}(\|p))$;\6
\hbox{\4}\X874:Cases of \\{flush\_node\_list} that arise in mlists only\X\6
\4\&{othercases} \37$\\{confusion}(\.{"flushing"})$\2\6
\&{endcases};\6
$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\6
\4\\{done}: \37\&{end};\2\6
$\|p\K\|q$;\6
\&{end};\2\6
\&{end};\par
\fi

\N221.  \[14] Copying boxes.
Another recursive operation that acts on boxes is sometimes needed: The
procedure \\{copy\_node\_list} returns a pointer to another node list that has
the same structure and meaning as the original. Note that since glue
specifications and token lists have reference counts, we need not make
copies of them. Reference counts can never get too large to fit in a
halfword, since each pointer to a node is in a different memory address,
and the total number of memory addresses fits in a halfword.

(Well, there actually are also references from outside \\{mem}; if the
\\{save\_stack} is made arbitrarily large, it would theoretically be possible
to break \TeX\ by overflowing a reference count. But who would want to do
that?)

\Y\P\D \37$\\{add\_token\_ref}(\#)\S\\{incr}(\\{token\_ref\_count}(\#))$\C{new
reference to a token list}\par
\P\D \37$\\{add\_glue\_ref}(\#)\S\\{incr}(\\{glue\_ref\_count}(\#))$\C{new
reference to a glue spec}\par
\fi

\M222. The copying procedure copies words en masse without bothering
to look at their individual fields. If the node format changes---for
example, if the size is altered, or if some link field is moved to another
relative position---then this code may need to be changed too.

\Y\P\4\&{function}\1\  \37$\\{copy\_node\_list}(\|p:\\{pointer})$: \37%
\\{pointer};\C{makes a duplicate of the   node list that starts at \|p and
returns a pointer to the new list}\6
\4\&{var} \37\|h: \37\\{pointer};\C{temporary head of copied list}\6
\|q: \37\\{pointer};\C{previous position in new list}\6
\|r: \37\\{pointer};\C{current node being fabricated for new list}\6
\\{words}: \37$0\to5$;\C{number of words remaining to be copied}\2\6
\&{begin} \37$\|h\K\\{get\_avail}$;\5
$\|q\K\|h$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\X223:Make a copy of node \|p in node \|r\X;\6
$\\{link}(\|q)\K\|r$;\5
$\|q\K\|r$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{link}(\|q)\K\\{null}$;\5
$\|q\K\\{link}(\|h)$;\5
$\\{free\_avail}(\|h)$;\5
$\\{copy\_node\_list}\K\|q$;\6
\&{end};\par
\fi

\M223. \P$\X223:Make a copy of node \|p in node \|r\X\S$\6
$\\{words}\K1$;\C{this setting occurs in more branches than any other}\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\|r\K\\{get\_avail}$\6
\4\&{else} \X224:Case statement to copy different types and set \\{words} to
the number of initial words not yet copied\X;\2\6
\&{while} $\\{words}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{words})$;\5
$\\{mem}[\|r+\\{words}]\K\\{mem}[\|p+\\{words}]$;\6
\&{end}\2\par
\U222.\fi

\M224. \P$\X224:Case statement to copy different types and set \\{words} to the
number of initial words not yet copied\X\S$\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{unset\_node}$: \37\&{begin} \37$\|r%
\K\\{get\_node}(\\{box\_node\_size})$;\5
$\\{mem}[\|r+6]\K\\{mem}[\|p+6]$;\5
$\\{mem}[\|r+5]\K\\{mem}[\|p+5]$;\C{copy the last two words}\6
$\\{list\_ptr}(\|r)\K\\{copy\_node\_list}(\\{list\_ptr}(\|p))$;\C{this affects
$\\{mem}[\|r+5]$}\6
$\\{words}\K5$;\6
\&{end};\6
\4\\{rule\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{rule\_node\_size})$;\5
$\\{words}\K\\{rule\_node\_size}$;\6
\&{end};\6
\4\\{ins\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{ins\_node\_size})$;\5
$\\{mem}[\|r+4]\K\\{mem}[\|p+4]$;\5
$\\{add\_glue\_ref}(\\{split\_top\_ptr}(\|p))$;\5
$\\{ins\_ptr}(\|r)\K\\{copy\_node\_list}(\\{ins\_ptr}(\|p))$;\C{this affects $%
\\{mem}[\|r+4]$}\6
$\\{words}\K\\{ins\_node\_size}-1$;\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1604:Make a partial copy of the whatsit node \|p and
make \|r point to it; set \\{words} to the number of initial words not yet
copied\X;\6
\4\\{glue\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{add\_glue\_ref}(\\{glue\_ptr}(\|p))$;\5
$\\{glue\_ptr}(\|r)\K\\{glue\_ptr}(\|p)$;\5
$\\{leader\_ptr}(\|r)\K\\{copy\_node\_list}(\\{leader\_ptr}(\|p))$;\6
\&{end};\6
\4$\\{kern\_node},\39\\{math\_node},\39\\{penalty\_node}$: \37\&{begin} \37$\|r%
\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{words}\K\\{small\_node\_size}$;\6
\&{end};\6
\4\\{margin\_kern\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{margin\_kern%
\_node\_size})$;\5
$\\{fast\_get\_avail}(\\{margin\_char}(\|r))$;\5
$\\{font}(\\{margin\_char}(\|r))\K\\{font}(\\{margin\_char}(\|p))$;\5
$\\{character}(\\{margin\_char}(\|r))\K\\{character}(\\{margin\_char}(\|p))$;\5
$\\{words}\K\\{small\_node\_size}$;\6
\&{end};\6
\4\\{ligature\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\5
$\\{mem}[\\{lig\_char}(\|r)]\K\\{mem}[\\{lig\_char}(\|p)]$;\C{copy \\{font} and
\\{character}}\6
$\\{lig\_ptr}(\|r)\K\\{copy\_node\_list}(\\{lig\_ptr}(\|p))$;\6
\&{end};\6
\4\\{disc\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{pre\_break}(\|r)\K\\{copy\_node\_list}(\\{pre\_break}(\|p))$;\5
$\\{post\_break}(\|r)\K\\{copy\_node\_list}(\\{post\_break}(\|p))$;\6
\&{end};\6
\4\\{mark\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{add\_token\_ref}(\\{mark\_ptr}(\|p))$;\5
$\\{words}\K\\{small\_node\_size}$;\6
\&{end};\6
\4\\{adjust\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\5
$\\{adjust\_ptr}(\|r)\K\\{copy\_node\_list}(\\{adjust\_ptr}(\|p))$;\6
\&{end};\C{$\\{words}=1=\\{small\_node\_size}-1$}\6
\4\&{othercases} \37$\\{confusion}(\.{"copying"})$\2\6
\&{endcases}\par
\U223.\fi

\N225.  \[15] The command codes.
Before we can go any further, we need to define symbolic names for the internal
code numbers that represent the various commands obeyed by \TeX. These codes
are somewhat arbitrary, but not completely so. For example, the command
codes for character types are fixed by the language, since a user says,
e.g., `\.{\\catcode \`\\\${} = 3}' to make \.{\char'44} a math delimiter,
and the command code \\{math\_shift} is equal to~3. Some other codes have
been made adjacent so that   \&{case}  statements in the program need not
consider
cases that are widely spaced, or so that   \&{case}  statements can be replaced
by   \&{if}  statements.

At any rate, here is the list, for future reference. First come the
``catcode'' commands, several of which share their numeric codes with
ordinary commands when the catcode cannot emerge from \TeX's scanning routine.

\Y\P\D \37$\\{escape}=0$\C{escape delimiter (called \.\\ in {\sl The \TeX book%
\/})}\par
\P\D \37$\\{relax}=0$\C{do nothing ( \.{\\relax} )}\par
\P\D \37$\\{left\_brace}=1$\C{beginning of a group ( \.\{ )}\par
\P\D \37$\\{right\_brace}=2$\C{ending of a group ( \.\} )}\par
\P\D \37$\\{math\_shift}=3$\C{mathematics shift character ( \.\$ )}\par
\P\D \37$\\{tab\_mark}=4$\C{alignment delimiter ( \.\&, \.{\\span} )}\par
\P\D \37$\\{car\_ret}=5$\C{end of line ( \\{carriage\_return}, \.{\\cr}, \.{%
\\crcr} )}\par
\P\D \37$\\{out\_param}=5$\C{output a macro parameter}\par
\P\D \37$\\{mac\_param}=6$\C{macro parameter symbol ( \.\# )}\par
\P\D \37$\\{sup\_mark}=7$\C{superscript ( \.{\char'136} )}\par
\P\D \37$\\{sub\_mark}=8$\C{subscript ( \.{\char'137} )}\par
\P\D \37$\\{ignore}=9$\C{characters to ignore ( \.{\^\^@} )}\par
\P\D \37$\\{endv}=9$\C{end of \<v_j> list in alignment template}\par
\P\D \37$\\{spacer}=10$\C{characters equivalent to blank space ( \.{\ } )}\par
\P\D \37$\\{letter}=11$\C{characters regarded as letters ( \.{A..Z}, \.{a..z}
)}\par
\P\D \37$\\{other\_char}=12$\C{none of the special character types}\par
\P\D \37$\\{active\_char}=13$\C{characters that invoke macros ( \.{\char`\~} )}%
\par
\P\D \37$\\{par\_end}=13$\C{end of paragraph ( \.{\\par} )}\par
\P\D \37$\\{match}=13$\C{match a macro parameter}\par
\P\D \37$\\{comment}=14$\C{characters that introduce comments ( \.\% )}\par
\P\D \37$\\{end\_match}=14$\C{end of parameters to macro}\par
\P\D \37$\\{stop}=14$\C{end of job ( \.{\\end}, \.{\\dump} )}\par
\P\D \37$\\{invalid\_char}=15$\C{characters that shouldn't appear ( \.{\^\^?}
)}\par
\P\D \37$\\{delim\_num}=15$\C{specify delimiter numerically ( \.{\\delimiter}
)}\par
\P\D \37$\\{max\_char\_code}=15$\C{largest catcode for individual characters}%
\par
\fi

\M226. Next are the ordinary run-of-the-mill command codes.  Codes that are
\\{min\_internal} or more represent internal quantities that might be
expanded by `\.{\\the}'.

\Y\P\D \37$\\{char\_num}=16$\C{character specified numerically ( \.{\\char} )}%
\par
\P\D \37$\\{math\_char\_num}=17$\C{explicit math code ( \.{\\mathchar} )}\par
\P\D \37$\\{mark}=18$\C{mark definition ( \.{\\mark} )}\par
\P\D \37$\\{xray}=19$\C{peek inside of \TeX\ ( \.{\\show}, \.{\\showbox},
etc.~)}\par
\P\D \37$\\{make\_box}=20$\C{make a box ( \.{\\box}, \.{\\copy}, \.{\\hbox},
etc.~)}\par
\P\D \37$\\{hmove}=21$\C{horizontal motion ( \.{\\moveleft}, \.{\\moveright} )}%
\par
\P\D \37$\\{vmove}=22$\C{vertical motion ( \.{\\raise}, \.{\\lower} )}\par
\P\D \37$\\{un\_hbox}=23$\C{unglue a box ( \.{\\unhbox}, \.{\\unhcopy} )}\par
\P\D \37$\\{un\_vbox}=24$\C{unglue a box ( \.{\\unvbox}, \.{\\unvcopy} )}\6
\C{( or \.{\\pagediscards}, \.{\\splitdiscards} )}\par
\P\D \37$\\{remove\_item}=25$\C{nullify last item ( \.{\\unpenalty},   \.{%
\\unkern}, \.{\\unskip} )}\par
\P\D \37$\\{hskip}=26$\C{horizontal glue ( \.{\\hskip}, \.{\\hfil}, etc.~)}\par
\P\D \37$\\{vskip}=27$\C{vertical glue ( \.{\\vskip}, \.{\\vfil}, etc.~)}\par
\P\D \37$\\{mskip}=28$\C{math glue ( \.{\\mskip} )}\par
\P\D \37$\\{kern}=29$\C{fixed space ( \.{\\kern} )}\par
\P\D \37$\\{mkern}=30$\C{math kern ( \.{\\mkern} )}\par
\P\D \37$\\{leader\_ship}=31$\C{use a box ( \.{\\shipout}, \.{\\leaders},
etc.~)}\par
\P\D \37$\\{halign}=32$\C{horizontal table alignment ( \.{\\halign} )}\par
\P\D \37$\\{valign}=33$\C{vertical table alignment ( \.{\\valign} )}\6
\C{or text direction directives ( \.{\\beginL}, etc.~)}\par
\P\D \37$\\{no\_align}=34$\C{temporary escape from alignment ( \.{\\noalign} )}%
\par
\P\D \37$\\{vrule}=35$\C{vertical rule ( \.{\\vrule} )}\par
\P\D \37$\\{hrule}=36$\C{horizontal rule ( \.{\\hrule} )}\par
\P\D \37$\\{insert}=37$\C{vlist inserted in box ( \.{\\insert} )}\par
\P\D \37$\\{vadjust}=38$\C{vlist inserted in enclosing paragraph ( \.{%
\\vadjust} )}\par
\P\D \37$\\{ignore\_spaces}=39$\C{gobble \\{spacer} tokens ( \.{\\ignorespaces}
)}\par
\P\D \37$\\{after\_assignment}=40$\C{save till assignment is done ( \.{%
\\afterassignment} )}\par
\P\D \37$\\{after\_group}=41$\C{save till group is done ( \.{\\aftergroup} )}%
\par
\P\D \37$\\{break\_penalty}=42$\C{additional badness ( \.{\\penalty} )}\par
\P\D \37$\\{start\_par}=43$\C{begin paragraph ( \.{\\indent}, \.{\\noindent} )}%
\par
\P\D \37$\\{ital\_corr}=44$\C{italic correction ( \.{\\/} )}\par
\P\D \37$\\{accent}=45$\C{attach accent in text ( \.{\\accent} )}\par
\P\D \37$\\{math\_accent}=46$\C{attach accent in math ( \.{\\mathaccent} )}\par
\P\D \37$\\{discretionary}=47$\C{discretionary texts ( \.{\\-}, \.{%
\\discretionary} )}\par
\P\D \37$\\{eq\_no}=48$\C{equation number ( \.{\\eqno}, \.{\\leqno} )}\par
\P\D \37$\\{left\_right}=49$\C{variable delimiter ( \.{\\left}, \.{\\right} )}\6
\C{( or \.{\\middle} )}\par
\P\D \37$\\{math\_comp}=50$\C{component of formula ( \.{\\mathbin}, etc.~)}\par
\P\D \37$\\{limit\_switch}=51$\C{diddle limit conventions ( \.{%
\\displaylimits}, etc.~)}\par
\P\D \37$\\{above}=52$\C{generalized fraction ( \.{\\above}, \.{\\atop},
etc.~)}\par
\P\D \37$\\{math\_style}=53$\C{style specification ( \.{\\displaystyle},
etc.~)}\par
\P\D \37$\\{math\_choice}=54$\C{choice specification ( \.{\\mathchoice} )}\par
\P\D \37$\\{non\_script}=55$\C{conditional math glue ( \.{\\nonscript} )}\par
\P\D \37$\\{vcenter}=56$\C{vertically center a vbox ( \.{\\vcenter} )}\par
\P\D \37$\\{case\_shift}=57$\C{force specific case ( \.{\\lowercase}, \.{%
\\uppercase}~)}\par
\P\D \37$\\{message}=58$\C{send to user ( \.{\\message}, \.{\\errmessage} )}\par
\P\D \37$\\{extension}=59$\C{extensions to \TeX\ ( \.{\\write}, \.{\\special},
etc.~)}\par
\P\D \37$\\{in\_stream}=60$\C{files for reading ( \.{\\openin}, \.{\\closein}
)}\par
\P\D \37$\\{begin\_group}=61$\C{begin local grouping ( \.{\\begingroup} )}\par
\P\D \37$\\{end\_group}=62$\C{end local grouping ( \.{\\endgroup} )}\par
\P\D \37$\\{omit}=63$\C{omit alignment template ( \.{\\omit} )}\par
\P\D \37$\\{ex\_space}=64$\C{explicit space ( \.{\\\ } )}\par
\P\D \37$\\{no\_boundary}=65$\C{suppress boundary ligatures ( \.{\\noboundary}
)}\par
\P\D \37$\\{radical}=66$\C{square root and similar signs ( \.{\\radical} )}\par
\P\D \37$\\{end\_cs\_name}=67$\C{end control sequence ( \.{\\endcsname} )}\par
\P\D \37$\\{min\_internal}=68$\C{the smallest code that can follow \.{\\the}}%
\par
\P\D \37$\\{char\_given}=68$\C{character code defined by \.{\\chardef}}\par
\P\D \37$\\{math\_given}=69$\C{math code defined by \.{\\mathchardef}}\par
\P\D \37$\\{last\_item}=70$\C{most recent item ( \.{\\lastpenalty},   \.{%
\\lastkern}, \.{\\lastskip} )}\par
\P\D \37$\\{max\_non\_prefixed\_command}=70$\C{largest command code that can't
be \.{\\global}}\par
\fi

\M227. The next codes are special; they all relate to mode-independent
assignment of values to \TeX's internal registers or tables.
Codes that are \\{max\_internal} or less represent internal quantities
that might be expanded by `\.{\\the}'.

\Y\P\D \37$\\{toks\_register}=71$\C{token list register ( \.{\\toks} )}\par
\P\D \37$\\{assign\_toks}=72$\C{special token list ( \.{\\output}, \.{%
\\everypar}, etc.~)}\par
\P\D \37$\\{assign\_int}=73$\C{user-defined integer ( \.{\\tolerance}, \.{%
\\day}, etc.~)}\par
\P\D \37$\\{assign\_dimen}=74$\C{user-defined length ( \.{\\hsize}, etc.~)}\par
\P\D \37$\\{assign\_glue}=75$\C{user-defined glue ( \.{\\baselineskip}, etc.~)}%
\par
\P\D \37$\\{assign\_mu\_glue}=76$\C{user-defined muglue ( \.{\\thinmuskip},
etc.~)}\par
\P\D \37$\\{assign\_font\_dimen}=77$\C{user-defined font dimension ( \.{%
\\fontdimen} )}\par
\P\D \37$\\{assign\_font\_int}=78$\C{user-defined font integer ( \.{%
\\hyphenchar},   \.{\\skewchar} )}\par
\P\D \37$\\{set\_aux}=79$\C{specify state info ( \.{\\spacefactor}, \.{%
\\prevdepth} )}\par
\P\D \37$\\{set\_prev\_graf}=80$\C{specify state info ( \.{\\prevgraf} )}\par
\P\D \37$\\{set\_page\_dimen}=81$\C{specify state info ( \.{\\pagegoal},
etc.~)}\par
\P\D \37$\\{set\_page\_int}=82$\C{specify state info ( \.{\\deadcycles},   \.{%
\\insertpenalties} )}\6
\C{( or \.{\\interactionmode} )}\par
\P\D \37$\\{set\_box\_dimen}=83$\C{change dimension of box ( \.{\\wd}, \.{%
\\ht}, \.{\\dp} )}\par
\P\D \37$\\{set\_shape}=84$\C{specify fancy paragraph shape ( \.{\\parshape} )}%
\6
\C{(or \.{\\interlinepenalties}, etc.~)}\par
\P\D \37$\\{def\_code}=85$\C{define a character code ( \.{\\catcode}, etc.~)}%
\par
\P\D \37$\\{def\_family}=86$\C{declare math fonts ( \.{\\textfont}, etc.~)}\par
\P\D \37$\\{set\_font}=87$\C{set current font ( font identifiers )}\par
\P\D \37$\\{def\_font}=88$\C{define a font file ( \.{\\font} )}\par
\P\D \37$\\{register}=89$\C{internal register ( \.{\\count}, \.{\\dimen},
etc.~)}\par
\P\D \37$\\{max\_internal}=89$\C{the largest code that can follow \.{\\the}}\par
\P\D \37$\\{advance}=90$\C{advance a register or parameter ( \.{\\advance} )}%
\par
\P\D \37$\\{multiply}=91$\C{multiply a register or parameter ( \.{\\multiply}
)}\par
\P\D \37$\\{divide}=92$\C{divide a register or parameter ( \.{\\divide} )}\par
\P\D \37$\\{prefix}=93$\C{qualify a definition ( \.{\\global}, \.{\\long}, \.{%
\\outer} )}\6
\C{( or \.{\\protected} )}\par
\P\D \37$\\{let}=94$\C{assign a command code ( \.{\\let}, \.{\\futurelet} )}\par
\P\D \37$\\{shorthand\_def}=95$\C{code definition ( \.{\\chardef}, \.{%
\\countdef}, etc.~)}\par
\P\D \37$\\{read\_to\_cs}=96$\C{read into a control sequence ( \.{\\read} )}\6
\C{( or \.{\\readline} )}\par
\P\D \37$\\{def}=97$\C{macro definition ( \.{\\def}, \.{\\gdef}, \.{\\xdef}, %
\.{\\edef} )}\par
\P\D \37$\\{set\_box}=98$\C{set a box ( \.{\\setbox} )}\par
\P\D \37$\\{hyph\_data}=99$\C{hyphenation data ( \.{\\hyphenation}, \.{%
\\patterns} )}\par
\P\D \37$\\{set\_interaction}=100$\C{define level of interaction ( \.{%
\\batchmode}, etc.~)}\par
\P\D \37$\\{letterspace\_font}=101$\C{letterspace a font ( \.{%
\\letterspacefont} )}\par
\P\D \37$\\{pdf\_copy\_font}=102$\C{create a new font instance ( \.{%
\\pdfcopyfont} )}\par
\P\D \37$\\{max\_command}=102$\C{the largest command code seen at \\{big%
\_switch}}\par
\fi

\M228. The remaining command codes are extra special, since they cannot get
through
\TeX's scanner to the main control routine. They have been given values higher
than \\{max\_command} so that their special nature is easily discernible.
The ``expandable'' commands come first.

\Y\P\D \37$\\{undefined\_cs}=\\{max\_command}+1$\C{initial state of most \\{eq%
\_type} fields}\par
\P\D \37$\\{expand\_after}=\\{max\_command}+2$\C{special expansion ( \.{%
\\expandafter} )}\par
\P\D \37$\\{no\_expand}=\\{max\_command}+3$\C{special nonexpansion ( \.{%
\\noexpand} )}\par
\P\D \37$\\{input}=\\{max\_command}+4$\C{input a source file ( \.{\\input}, \.{%
\\endinput} )}\6
\C{( or \.{\\scantokens} )}\par
\P\D \37$\\{if\_test}=\\{max\_command}+5$\C{conditional text ( \.{\\if}, \.{%
\\ifcase}, etc.~)}\par
\P\D \37$\\{fi\_or\_else}=\\{max\_command}+6$\C{delimiters for conditionals ( %
\.{\\else}, etc.~)}\par
\P\D \37$\\{cs\_name}=\\{max\_command}+7$\C{make a control sequence from tokens
( \.{\\csname} )}\par
\P\D \37$\\{convert}=\\{max\_command}+8$\C{convert to text ( \.{\\number}, \.{%
\\string}, etc.~)}\par
\P\D \37$\\{the}=\\{max\_command}+9$\C{expand an internal quantity ( \.{\\the}
)}\6
\C{( or \.{\\unexpanded}, \.{\\detokenize} )}\par
\P\D \37$\\{top\_bot\_mark}=\\{max\_command}+10$\C{inserted mark ( \.{%
\\topmark}, etc.~)}\par
\P\D \37$\\{call}=\\{max\_command}+11$\C{non-long, non-outer control sequence}%
\par
\P\D \37$\\{long\_call}=\\{max\_command}+12$\C{long, non-outer control
sequence}\par
\P\D \37$\\{outer\_call}=\\{max\_command}+13$\C{non-long, outer control
sequence}\par
\P\D \37$\\{long\_outer\_call}=\\{max\_command}+14$\C{long, outer control
sequence}\par
\P\D \37$\\{end\_template}=\\{max\_command}+15$\C{end of an alignment template}%
\par
\P\D \37$\\{dont\_expand}=\\{max\_command}+16$\C{the following token was marked
by \.{\\noexpand}}\par
\P\D \37$\\{glue\_ref}=\\{max\_command}+17$\C{the equivalent points to a glue
specification}\par
\P\D \37$\\{shape\_ref}=\\{max\_command}+18$\C{the equivalent points to a
parshape specification}\par
\P\D \37$\\{box\_ref}=\\{max\_command}+19$\C{the equivalent points to a box
node, or is \\{null}}\par
\P\D \37$\\{data}=\\{max\_command}+20$\C{the equivalent is simply a halfword
number}\par
\fi

\N229.  \[16] The semantic nest.
\TeX\ is typically in the midst of building many lists at once. For example,
when a math formula is being processed, \TeX\ is in math mode and
working on an mlist; this formula has temporarily interrupted \TeX\ from
being in horizontal mode and building the hlist of a paragraph; and this
paragraph has temporarily interrupted \TeX\ from being in vertical mode
and building the vlist for the next page of a document. Similarly, when a
\.{\\vbox} occurs inside of an \.{\\hbox}, \TeX\ is temporarily
interrupted from working in restricted horizontal mode, and it enters
internal vertical mode.  The ``semantic nest'' is a stack that
keeps track of what lists and modes are currently suspended.

At each level of processing we are in one of six modes:

\yskip\hang\\{vmode} stands for vertical mode (the page builder);

\hang\\{hmode} stands for horizontal mode (the paragraph builder);

\hang\\{mmode} stands for displayed formula mode;

\hang$-\\{vmode}$ stands for internal vertical mode (e.g., in a \.{\\vbox});

\hang$-\\{hmode}$ stands for restricted horizontal mode (e.g., in an \.{%
\\hbox});

\hang$-\\{mmode}$ stands for math formula mode (not displayed).

\yskip\noindent The mode is temporarily set to zero while processing \.{%
\\write}
texts.

Numeric values are assigned to \\{vmode}, \\{hmode}, and \\{mmode} so that
\TeX's ``big semantic switch'' can select the appropriate thing to
do by computing the value $\\{abs}(\\{mode})+\\{cur\_cmd}$, where \\{mode} is
the current
mode and \\{cur\_cmd} is the current command code.

\Y\P\D \37$\\{vmode}=1$\C{vertical mode}\par
\P\D \37$\\{hmode}=\\{vmode}+\\{max\_command}+1$\C{horizontal mode}\par
\P\D \37$\\{mmode}=\\{hmode}+\\{max\_command}+1$\C{math mode}\par
\Y\P\4\&{procedure}\1\  \37$\\{print\_mode}(\|m:\\{integer})$;\C{prints the
mode represented by \|m}\2\6
\&{begin} \37\&{if} $\|m>0$ \1\&{then}\6
\&{case} $\|m\mathbin{\&{div}}(\\{max\_command}+1)$ \1\&{of}\6
\40: \37$\\{print}(\.{"vertical"})$;\6
\41: \37$\\{print}(\.{"horizontal"})$;\6
\42: \37$\\{print}(\.{"display\ math"})$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|m=0$ \1\&{then}\5
$\\{print}(\.{"no"})$\6
\4\&{else} \&{case} $(-\|m)\mathbin{\&{div}}(\\{max\_command}+1)$ \1\&{of}\6
\40: \37$\\{print}(\.{"internal\ vertical"})$;\6
\41: \37$\\{print}(\.{"restricted\ horizontal"})$;\6
\42: \37$\\{print}(\.{"math"})$;\2\6
\&{end};\2\2\6
$\\{print}(\.{"\ mode"})$;\6
\&{end};\par
\fi

\M230. The state of affairs at any semantic level can be represented by
five values:

\yskip\hang\\{mode} is the number representing the semantic mode, as
just explained.

\yskip\hang\\{head} is a \\{pointer} to a list head for the list being built;
$\\{link}(\\{head})$ therefore points to the first element of the list, or
to \\{null} if the list is empty.

\yskip\hang\\{tail} is a \\{pointer} to the final node of the list being
built; thus, $\\{tail}=\\{head}$ if and only if the list is empty.

\yskip\hang\\{prev\_graf} is the number of lines of the current paragraph that
have already been put into the present vertical list.

\yskip\hang\\{aux} is an auxiliary \\{memory\_word} that gives further
information
that is needed to characterize the situation.

\yskip\noindent
In vertical mode, \\{aux} is also known as \\{prev\_depth}; it is the scaled
value representing the depth of the previous box, for use in baseline
calculations, or it is $\L-1000$pt if the next box on the vertical list is to
be exempt from baseline calculations.  In horizontal mode, \\{aux} is also
known as \\{space\_factor} and \\{clang}; it holds the current space factor
used in
spacing calculations, and the current language used for hyphenation.
(The value of \\{clang} is undefined in restricted horizontal mode.)
In math mode, \\{aux} is also known as \\{incompleat\_noad}; if
not \\{null}, it points to a record that represents the numerator of a
generalized fraction for which the denominator is currently being formed
in the current list.

There is also a sixth quantity, \\{mode\_line}, which correlates
the semantic nest with the user's input; \\{mode\_line} contains the source
line number at which the current level of nesting was entered. The negative
of this line number is the \\{mode\_line} at the level of the
user's output routine.

A seventh quantity, \\{eTeX\_aux}, is used by the extended features \eTeX.
In vertical modes it is known as \\{LR\_save} and holds the LR stack when a
paragraph is interrupted by a displayed formula.  In display math mode
it is known as \\{LR\_box} and holds a pointer to a prototype box for the
display.  In math mode it is known as \\{delim\_ptr} and points to the most
recent \\{left\_noad} or \\{middle\_noad} of a \\{math\_left\_group}.

In horizontal mode, the \\{prev\_graf} field is used for initial language data.

The semantic nest is an array called \\{nest} that holds the \\{mode}, %
\\{head},
\\{tail}, \\{prev\_graf}, \\{aux}, and \\{mode\_line} values for all semantic
levels
below the currently active one. Information about the currently active
level is kept in the global quantities \\{mode}, \\{head}, \\{tail}, \\{prev%
\_graf},
\\{aux}, and \\{mode\_line}, which live in a \PASCAL\ record that is ready to
be pushed onto \\{nest} if necessary.

\Y\P\D \37$\\{ignore\_depth}\S-65536000$\C{magic dimension value to mean
`ignore me'}\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{list\_state\_record}=$\1\5
\1\&{record} \37\\{mode\_field}: \37$-\\{mmode}\to\\{mmode}$;\ $\\{head%
\_field},\39\\{tail\_field}$: \37\\{pointer};\6
\4\\{eTeX\_aux\_field}: \37\\{pointer};\6
\4$\\{pg\_field},\39\\{ml\_field}$: \37\\{integer};\ \\{aux\_field}: \37%
\\{memory\_word};\2\6
\&{end};\2\par
\fi

\M231. \P\D \37$\\{mode}\S\\{cur\_list}.\\{mode\_field}$\C{current mode}\par
\P\D \37$\\{head}\S\\{cur\_list}.\\{head\_field}$\C{header node of current
list}\par
\P\D \37$\\{tail}\S\\{cur\_list}.\\{tail\_field}$\C{final node on current list}%
\par
\P\D \37$\\{eTeX\_aux}\S\\{cur\_list}.\\{eTeX\_aux\_field}$\C{auxiliary data
for \eTeX}\par
\P\D \37$\\{LR\_save}\S\\{eTeX\_aux}$\C{LR stack when a paragraph is
interrupted}\par
\P\D \37$\\{LR\_box}\S\\{eTeX\_aux}$\C{prototype box for display}\par
\P\D \37$\\{delim\_ptr}\S\\{eTeX\_aux}$\C{most recent left or right noad of a
math left group}\par
\P\D \37$\\{prev\_graf}\S\\{cur\_list}.\\{pg\_field}$\C{number of paragraph
lines accumulated}\par
\P\D \37$\\{aux}\S\\{cur\_list}.\\{aux\_field}$\C{auxiliary data about the
current list}\par
\P\D \37$\\{prev\_depth}\S\\{aux}.\\{sc}$\C{the name of \\{aux} in vertical
mode}\par
\P\D \37$\\{space\_factor}\S\\{aux}.\\{hh}.\\{lh}$\C{part of \\{aux} in
horizontal mode}\par
\P\D \37$\\{clang}\S\\{aux}.\\{hh}.\\{rh}$\C{the other part of \\{aux} in
horizontal mode}\par
\P\D \37$\\{incompleat\_noad}\S\\{aux}.\\{int}$\C{the name of \\{aux} in math
mode}\par
\P\D \37$\\{mode\_line}\S\\{cur\_list}.\\{ml\_field}$\C{source file line number
at beginning of list}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{nest}: \37\&{array} $[0\to\\{nest\_size}]$ \1\&{of}\5
\\{list\_state\_record};\2\6
\4\\{nest\_ptr}: \37$0\to\\{nest\_size}$;\C{first unused location of \\{nest}}\6
\4\\{max\_nest\_stack}: \37$0\to\\{nest\_size}$;\C{maximum of \\{nest\_ptr}
when pushing}\6
\4\\{cur\_list}: \37\\{list\_state\_record};\C{the ``top'' semantic state}\6
\4\\{shown\_mode}: \37$-\\{mmode}\to\\{mmode}$;\C{most recent mode shown by \.{%
\\tracingcommands}}\6
\4\\{save\_tail}: \37\\{pointer};\C{save \\{tail} so we can examine whether we
have an auto                        kern before a glue}\6
\4\\{prev\_tail}: \37\\{pointer};\C{value of \\{tail} before the last call to %
\\{tail\_append}}\par
\fi

\M232. Here is a common way to make the current list grow:

\Y\P\D \37$\\{tail\_append}(\#)\S$\1\6
\&{begin} \37$\\{prev\_tail}\K\\{tail}$;\5
$\\{link}(\\{tail})\K\#$;\5
$\\{tail}\K\\{link}(\\{tail})$;\6
\&{end}\2\par
\P\D \37$\\{insert\_before\_tail}(\#)\S$\1\6
\&{begin} \37$\\{link}(\\{prev\_tail})\K\#$;\5
$\\{link}(\#)\K\\{tail}$;\5
$\\{prev\_tail}\K\#$;\6
\&{end}\2\par
\fi

\M233. We will see later that the vertical list at the bottom semantic level is
split
into two parts; the ``current page'' runs from \\{page\_head} to \\{page%
\_tail},
and the ``contribution list'' runs from \\{contrib\_head} to \\{tail} of
semantic level zero. The idea is that contributions are first formed in
vertical mode, then ``contributed'' to the current page (during which time
the page-breaking decisions are made). For now, we don't need to know
any more details about the page-building process.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{nest\_ptr}\K0$;\5
$\\{max\_nest\_stack}\K0$;\5
$\\{mode}\K\\{vmode}$;\5
$\\{head}\K\\{contrib\_head}$;\5
$\\{tail}\K\\{contrib\_head}$;\5
$\\{eTeX\_aux}\K\\{null}$;\5
$\\{save\_tail}\K\\{null}$;\5
$\\{prev\_depth}\K\\{ignore\_depth}$;\5
$\\{mode\_line}\K0$;\5
$\\{prev\_graf}\K0$;\5
$\\{shown\_mode}\K0$;\5
\X1168:Start a new current page\X;\par
\fi

\M234. When \TeX's work on one level is interrupted, the state is saved by
calling \\{push\_nest}. This routine changes \\{head} and \\{tail} so that
a new (empty) list is begun; it does not change \\{mode} or \\{aux}.

\Y\P\4\&{procedure}\1\  \37\\{push\_nest};\C{enter a new semantic level, save
the old}\2\6
\&{begin} \37\&{if} $\\{nest\_ptr}>\\{max\_nest\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_nest\_stack}\K\\{nest\_ptr}$;\6
\&{if} $\\{nest\_ptr}=\\{nest\_size}$ \1\&{then}\5
$\\{overflow}(\.{"semantic\ nest\ size"},\39\\{nest\_size})$;\2\6
\&{end};\2\6
$\\{nest}[\\{nest\_ptr}]\K\\{cur\_list}$;\C{stack the record}\6
$\\{incr}(\\{nest\_ptr})$;\5
$\\{head}\K\\{get\_avail}$;\5
$\\{tail}\K\\{head}$;\5
$\\{prev\_graf}\K0$;\5
$\\{mode\_line}\K\\{line}$;\5
$\\{eTeX\_aux}\K\\{null}$;\6
\&{end};\par
\fi

\M235. Conversely, when \TeX\ is finished on the current level, the former
state is restored by calling \\{pop\_nest}. This routine will never be
called at the lowest semantic level, nor will it be called unless \\{head}
is a node that should be returned to free memory.

\Y\P\4\&{procedure}\1\  \37\\{pop\_nest};\C{leave a semantic level, re-enter
the old}\2\6
\&{begin} \37$\\{free\_avail}(\\{head})$;\5
$\\{decr}(\\{nest\_ptr})$;\5
$\\{cur\_list}\K\\{nest}[\\{nest\_ptr}]$;\6
\&{end};\par
\fi

\M236. Here is a procedure that displays what \TeX\ is working on, at all
levels.

\Y\P\4\&{procedure}\1\  \37\\{print\_totals};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{show\_activities};\6
\4\&{var} \37\|p: \37$0\to\\{nest\_size}$;\C{index into \\{nest}}\6
\|m: \37$-\\{mmode}\to\\{mmode}$;\C{mode}\6
\|a: \37\\{memory\_word};\C{auxiliary}\6
$\|q,\39\|r$: \37\\{pointer};\C{for showing the current page}\6
\|t: \37\\{integer};\C{ditto}\2\6
\&{begin} \37$\\{nest}[\\{nest\_ptr}]\K\\{cur\_list}$;\C{put the top level into
the array}\6
$\\{print\_nl}(\.{""})$;\5
\\{print\_ln};\6
\&{for} $\|p\K\\{nest\_ptr}\mathrel{\&{downto}}0$ \1\&{do}\6
\&{begin} \37$\|m\K\\{nest}[\|p].\\{mode\_field}$;\5
$\|a\K\\{nest}[\|p].\\{aux\_field}$;\5
$\\{print\_nl}(\.{"\#\#\#\ "})$;\5
$\\{print\_mode}(\|m)$;\5
$\\{print}(\.{"\ entered\ at\ line\ "})$;\5
$\\{print\_int}(\\{abs}(\\{nest}[\|p].\\{ml\_field}))$;\6
\&{if} $\|m=\\{hmode}$ \1\&{then}\6
\&{if} $\\{nest}[\|p].\\{pg\_field}\I\O{40600000}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ (language"})$;\5
$\\{print\_int}(\\{nest}[\|p].\\{pg\_field}\mathbin{\&{mod}}\O{200000})$;\5
$\\{print}(\.{":hyphenmin"})$;\5
$\\{print\_int}(\\{nest}[\|p].\\{pg\_field}\mathbin{\&{div}}\O{20000000})$;\5
$\\{print\_char}(\.{","})$;\5
$\\{print\_int}((\\{nest}[\|p].\\{pg\_field}\mathbin{\&{div}}\O{200000})%
\mathbin{\&{mod}}\O{100})$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\2\6
\&{if} $\\{nest}[\|p].\\{ml\_field}<0$ \1\&{then}\5
$\\{print}(\.{"\ (\\output\ routine)"})$;\2\6
\&{if} $\|p=0$ \1\&{then}\6
\&{begin} \37\X1163:Show the status of the current page\X;\6
\&{if} $\\{link}(\\{contrib\_head})\I\\{null}$ \1\&{then}\5
$\\{print\_nl}(\.{"\#\#\#\ recent\ contributions:"})$;\2\6
\&{end};\2\6
$\\{show\_box}(\\{link}(\\{nest}[\|p].\\{head\_field}))$;\5
\X237:Show the auxiliary field, \|a\X;\6
\&{end};\2\6
\&{end};\par
\fi

\M237. \P$\X237:Show the auxiliary field, \|a\X\S$\6
\&{case} $\\{abs}(\|m)\mathbin{\&{div}}(\\{max\_command}+1)$ \1\&{of}\6
\40: \37\&{begin} \37$\\{print\_nl}(\.{"prevdepth\ "})$;\6
\&{if} $\|a.\\{sc}\L\\{pdf\_ignored\_dimen}$ \1\&{then}\5
$\\{print}(\.{"ignored"})$\6
\4\&{else} $\\{print\_scaled}(\|a.\\{sc})$;\2\6
\&{if} $\\{nest}[\|p].\\{pg\_field}\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ prevgraf\ "})$;\5
$\\{print\_int}(\\{nest}[\|p].\\{pg\_field})$;\5
$\\{print}(\.{"\ line"})$;\6
\&{if} $\\{nest}[\|p].\\{pg\_field}\I1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
\&{end};\2\6
\&{end};\6
\41: \37\&{begin} \37$\\{print\_nl}(\.{"spacefactor\ "})$;\5
$\\{print\_int}(\|a.\\{hh}.\\{lh})$;\6
\&{if} $\|m>0$ \1\&{then}\ \&{if} $\|a.\\{hh}.\\{rh}>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ current\ language\ "})$;\5
$\\{print\_int}(\|a.\\{hh}.\\{rh})$;\ \&{end};\2\2\6
\&{end};\6
\42: \37\&{if} $\|a.\\{int}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"this\ will\ begin\ denominator\ of:"})$;\5
$\\{show\_box}(\|a.\\{int})$;\ \&{end};\2\2\6
\&{end}\C{there are no other cases}\par
\U236.\fi

\N238.  \[17] The table of equivalents.
Now that we have studied the data structures for \TeX's semantic routines,
we ought to consider the data structures used by its syntactic routines. In
other words, our next concern will be
the tables that \TeX\ looks at when it is scanning
what the user has written.

The biggest and most important such table is called \\{eqtb}. It holds the
current ``equivalents'' of things; i.e., it explains what things mean
or what their current values are, for all quantities that are subject to
the nesting structure provided by \TeX's grouping mechanism. There are six
parts to \\{eqtb}:

\yskip\hangg 1) $\\{eqtb}[\\{active\_base}\to(\\{hash\_base}-1)]$ holds the
current
equivalents of single-character control sequences.

\yskip\hangg 2) $\\{eqtb}[\\{hash\_base}\to(\\{glue\_base}-1)]$ holds the
current
equivalents of multiletter control sequences.

\yskip\hangg 3) $\\{eqtb}[\\{glue\_base}\to(\\{local\_base}-1)]$ holds the
current
equivalents of glue parameters like the current baselineskip.

\yskip\hangg 4) $\\{eqtb}[\\{local\_base}\to(\\{int\_base}-1)]$ holds the
current
equivalents of local halfword quantities like the current box registers,
the current ``catcodes,'' the current font, and a pointer to the current
paragraph shape.

\yskip\hangg 5) $\\{eqtb}[\\{int\_base}\to(\\{dimen\_base}-1)]$ holds the
current
equivalents of fullword integer parameters like the current hyphenation
penalty.

\yskip\hangg 6) $\\{eqtb}[\\{dimen\_base}\to\\{eqtb\_size}]$ holds the current
equivalents
of fullword dimension parameters like the current hsize or amount of
hanging indentation.

\yskip\noindent Note that, for example, the current amount of
baselineskip glue is determined by the setting of a particular location
in region~3 of \\{eqtb}, while the current meaning of the control sequence
`\.{\\baselineskip}' (which might have been changed by \.{\\def} or
\.{\\let}) appears in region~2.

\fi

\M239. Each entry in \\{eqtb} is a \\{memory\_word}. Most of these words are of
type
\\{two\_halves}, and subdivided into three fields:

\yskip\hangg 1) The \\{eq\_level} (a quarterword) is the level of grouping at
which this equivalent was defined. If the level is \\{level\_zero}, the
equivalent has never been defined; \\{level\_one} refers to the outer level
(outside of all groups), and this level is also used for global
definitions that never go away. Higher levels are for equivalents that
will disappear at the end of their group.

\yskip\hangg 2) The \\{eq\_type} (another quarterword) specifies what kind of
entry this is. There are many types, since each \TeX\ primitive like
\.{\\hbox}, \.{\\def}, etc., has its own special code. The list of
command codes above includes all possible settings of the \\{eq\_type} field.

\yskip\hangg 3) The \\{equiv} (a halfword) is the current equivalent value.
This may be a font number, a pointer into \\{mem}, or a variety of other
things.

\Y\P\D \37$\\{eq\_level\_field}(\#)\S\#.\\{hh}.\\{b1}$\par
\P\D \37$\\{eq\_type\_field}(\#)\S\#.\\{hh}.\\{b0}$\par
\P\D \37$\\{equiv\_field}(\#)\S\#.\\{hh}.\\{rh}$\par
\P\D \37$\\{eq\_level}(\#)\S\\{eq\_level\_field}(\\{eqtb}[\#])$\C{level of
definition}\par
\P\D \37$\\{eq\_type}(\#)\S\\{eq\_type\_field}(\\{eqtb}[\#])$\C{command code
for equivalent}\par
\P\D \37$\\{equiv}(\#)\S\\{equiv\_field}(\\{eqtb}[\#])$\C{equivalent value}\par
\P\D \37$\\{level\_zero}=\\{min\_quarterword}$\C{level for undefined
quantities}\par
\P\D \37$\\{level\_one}=\\{level\_zero}+1$\C{outermost level for defined
quantities}\par
\fi

\M240. Many locations in \\{eqtb} have symbolic names. The purpose of the next
paragraphs is to define these names, and to set up the initial values of the
equivalents.

In the first region we have 256 equivalents for ``active characters'' that
act as control sequences, followed by 256 equivalents for single-character
control sequences.

Then comes region~2, which corresponds to the hash table that we will
define later.  The maximum address in this region is used for a dummy
control sequence that is perpetually undefined. There also are several
locations for control sequences that are perpetually defined
(since they are used in error recovery).

\Y\P\D \37$\\{active\_base}=1$\C{beginning of region 1, for active character
equivalents}\par
\P\D \37$\\{single\_base}=\\{active\_base}+256$\C{equivalents of one-character
control sequences}\par
\P\D \37$\\{null\_cs}=\\{single\_base}+256$\C{equivalent of \.{\\csname%
\\endcsname}}\par
\P\D \37$\\{hash\_base}=\\{null\_cs}+1$\C{beginning of region 2, for the hash
table}\par
\P\D \37$\\{frozen\_control\_sequence}=\\{hash\_base}+\\{hash\_size}$\C{for
error recovery}\par
\P\D \37$\\{frozen\_protection}=\\{frozen\_control\_sequence}$\C{inaccessible
but definable}\par
\P\D \37$\\{frozen\_cr}=\\{frozen\_control\_sequence}+1$\C{permanent `\.{%
\\cr}'}\par
\P\D \37$\\{frozen\_end\_group}=\\{frozen\_control\_sequence}+2$\C{permanent `%
\.{\\endgroup}'}\par
\P\D \37$\\{frozen\_right}=\\{frozen\_control\_sequence}+3$\C{permanent `\.{%
\\right}'}\par
\P\D \37$\\{frozen\_fi}=\\{frozen\_control\_sequence}+4$\C{permanent `\.{%
\\fi}'}\par
\P\D \37$\\{frozen\_end\_template}=\\{frozen\_control\_sequence}+5$\C{permanent
`\.{\\endtemplate}'}\par
\P\D \37$\\{frozen\_endv}=\\{frozen\_control\_sequence}+6$\C{second permanent `%
\.{\\endtemplate}'}\par
\P\D \37$\\{frozen\_relax}=\\{frozen\_control\_sequence}+7$\C{permanent `\.{%
\\relax}'}\par
\P\D \37$\\{end\_write}=\\{frozen\_control\_sequence}+8$\C{permanent `\.{%
\\endwrite}'}\par
\P\D \37$\\{frozen\_dont\_expand}=\\{frozen\_control\_sequence}+9$\C{permanent
`\.{\\notexpanded:}'}\par
\P\D \37$\\{prim\_size}=2100$\C{maximum number of primitives }\par
\P\D \37$\\{frozen\_null\_font}=\\{frozen\_control\_sequence}+10$\C{permanent `%
\.{\\nullfont}'}\par
\P\D \37$\\{frozen\_primitive}=\\{frozen\_control\_sequence}+11$\C{permanent `%
\.{\\pdfprimitive}'}\par
\P\D \37$\\{prim\_eqtb\_base}=\\{frozen\_primitive}+1$\par
\P\D \37$\\{font\_id\_base}=\\{frozen\_null\_font}-\\{font\_base}$\C{begins
table of 257 permanent font identifiers}\par
\P\D \37$\\{undefined\_control\_sequence}=\\{frozen\_null\_font}+257$\C{dummy
location}\par
\P\D \37$\\{glue\_base}=\\{undefined\_control\_sequence}+1$\C{beginning of
region 3}\par
\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{eq\_type}(\\{undefined\_control\_sequence})\K\\{undefined\_cs}$;\5
$\\{equiv}(\\{undefined\_control\_sequence})\K\\{null}$;\5
$\\{eq\_level}(\\{undefined\_control\_sequence})\K\\{level\_zero}$;\6
\&{for} $\|k\K\\{active\_base}\mathrel{\&{to}}\\{undefined\_control%
\_sequence}-1$ \1\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{undefined\_control\_sequence}]$;\2\par
\fi

\M241. Here is a routine that displays the current meaning of an \\{eqtb} entry
in region 1 or~2. (Similar routines for the other regions will appear
below.)

\Y\P$\4\X241:Show equivalent \|n, in region 1 or 2\X\S$\6
\&{begin} \37$\\{sprint\_cs}(\|n)$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_cmd\_chr}(\\{eq\_type}(\|n),\39\\{equiv}(\|n))$;\6
\&{if} $\\{eq\_type}(\|n)\G\\{call}$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{":"})$;\5
$\\{show\_token\_list}(\\{link}(\\{equiv}(\|n)),\39\\{null},\3932)$;\6
\&{end};\2\6
\&{end}\par
\U270.\fi

\M242. Region 3 of \\{eqtb} contains the 256 \.{\\skip} registers, as well as
the
glue parameters defined here. It is important that the ``muskip''
parameters have larger numbers than the others.

\Y\P\D \37$\\{line\_skip\_code}=0$\C{interline glue if \\{baseline\_skip} is
infeasible}\par
\P\D \37$\\{baseline\_skip\_code}=1$\C{desired glue between baselines}\par
\P\D \37$\\{par\_skip\_code}=2$\C{extra glue just above a paragraph}\par
\P\D \37$\\{above\_display\_skip\_code}=3$\C{extra glue just above displayed
math}\par
\P\D \37$\\{below\_display\_skip\_code}=4$\C{extra glue just below displayed
math}\par
\P\D \37$\\{above\_display\_short\_skip\_code}=5$\C{glue above displayed math
following short lines}\par
\P\D \37$\\{below\_display\_short\_skip\_code}=6$\C{glue below displayed math
following short lines}\par
\P\D \37$\\{left\_skip\_code}=7$\C{glue at left of justified lines}\par
\P\D \37$\\{right\_skip\_code}=8$\C{glue at right of justified lines}\par
\P\D \37$\\{top\_skip\_code}=9$\C{glue at top of main pages}\par
\P\D \37$\\{split\_top\_skip\_code}=10$\C{glue at top of split pages}\par
\P\D \37$\\{tab\_skip\_code}=11$\C{glue between aligned entries}\par
\P\D \37$\\{space\_skip\_code}=12$\C{glue between words (if not \\{zero%
\_glue})}\par
\P\D \37$\\{xspace\_skip\_code}=13$\C{glue after sentences (if not \\{zero%
\_glue})}\par
\P\D \37$\\{par\_fill\_skip\_code}=14$\C{glue on last line of paragraph}\par
\P\D \37$\\{thin\_mu\_skip\_code}=15$\C{thin space in math formula}\par
\P\D \37$\\{med\_mu\_skip\_code}=16$\C{medium space in math formula}\par
\P\D \37$\\{thick\_mu\_skip\_code}=17$\C{thick space in math formula}\par
\P\D \37$\\{glue\_pars}=18$\C{total number of glue parameters}\par
\P\D \37$\\{skip\_base}=\\{glue\_base}+\\{glue\_pars}$\C{table of 256 ``skip''
registers}\par
\P\D \37$\\{mu\_skip\_base}=\\{skip\_base}+256$\C{table of 256 ``muskip''
registers}\par
\P\D \37$\\{local\_base}=\\{mu\_skip\_base}+256$\C{beginning of region 4}\Y\par
\P\D \37$\\{skip}(\#)\S\\{equiv}(\\{skip\_base}+\#)$\C{\\{mem} location of glue
specification}\par
\P\D \37$\\{mu\_skip}(\#)\S\\{equiv}(\\{mu\_skip\_base}+\#)$\C{\\{mem} location
of math glue spec}\par
\P\D \37$\\{glue\_par}(\#)\S\\{equiv}(\\{glue\_base}+\#)$\C{\\{mem} location of
glue specification}\par
\P\D \37$\\{line\_skip}\S\\{glue\_par}(\\{line\_skip\_code})$\par
\P\D \37$\\{baseline\_skip}\S\\{glue\_par}(\\{baseline\_skip\_code})$\par
\P\D \37$\\{par\_skip}\S\\{glue\_par}(\\{par\_skip\_code})$\par
\P\D \37$\\{above\_display\_skip}\S\\{glue\_par}(\\{above\_display\_skip%
\_code})$\par
\P\D \37$\\{below\_display\_skip}\S\\{glue\_par}(\\{below\_display\_skip%
\_code})$\par
\P\D \37$\\{above\_display\_short\_skip}\S\\{glue\_par}(\\{above\_display%
\_short\_skip\_code})$\par
\P\D \37$\\{below\_display\_short\_skip}\S\\{glue\_par}(\\{below\_display%
\_short\_skip\_code})$\par
\P\D \37$\\{left\_skip}\S\\{glue\_par}(\\{left\_skip\_code})$\par
\P\D \37$\\{right\_skip}\S\\{glue\_par}(\\{right\_skip\_code})$\par
\P\D \37$\\{top\_skip}\S\\{glue\_par}(\\{top\_skip\_code})$\par
\P\D \37$\\{split\_top\_skip}\S\\{glue\_par}(\\{split\_top\_skip\_code})$\par
\P\D \37$\\{tab\_skip}\S\\{glue\_par}(\\{tab\_skip\_code})$\par
\P\D \37$\\{space\_skip}\S\\{glue\_par}(\\{space\_skip\_code})$\par
\P\D \37$\\{xspace\_skip}\S\\{glue\_par}(\\{xspace\_skip\_code})$\par
\P\D \37$\\{par\_fill\_skip}\S\\{glue\_par}(\\{par\_fill\_skip\_code})$\par
\P\D \37$\\{thin\_mu\_skip}\S\\{glue\_par}(\\{thin\_mu\_skip\_code})$\par
\P\D \37$\\{med\_mu\_skip}\S\\{glue\_par}(\\{med\_mu\_skip\_code})$\par
\P\D \37$\\{thick\_mu\_skip}\S\\{glue\_par}(\\{thick\_mu\_skip\_code})$\par
\Y\P$\4\X242:Current \\{mem} equivalent of glue parameter number \|n\X\S$\6
$\\{glue\_par}(\|n)$\par
\Us170\ET172.\fi

\M243. Sometimes we need to convert \TeX's internal code numbers into symbolic
form. The \\{print\_skip\_param} routine gives the symbolic name of a glue
parameter.

\Y\P$\4\X243:Declare the procedure called \\{print\_skip\_param}\X\S$\6
\4\&{procedure}\1\  \37$\\{print\_skip\_param}(\|n:\\{integer})$;\2\6
\&{begin} \37\&{case} $\|n$ \1\&{of}\6
\4\\{line\_skip\_code}: \37$\\{print\_esc}(\.{"lineskip"})$;\6
\4\\{baseline\_skip\_code}: \37$\\{print\_esc}(\.{"baselineskip"})$;\6
\4\\{par\_skip\_code}: \37$\\{print\_esc}(\.{"parskip"})$;\6
\4\\{above\_display\_skip\_code}: \37$\\{print\_esc}(\.{"abovedisplayskip"})$;\6
\4\\{below\_display\_skip\_code}: \37$\\{print\_esc}(\.{"belowdisplayskip"})$;\6
\4\\{above\_display\_short\_skip\_code}: \37$\\{print\_esc}(%
\.{"abovedisplayshortskip"})$;\6
\4\\{below\_display\_short\_skip\_code}: \37$\\{print\_esc}(%
\.{"belowdisplayshortskip"})$;\6
\4\\{left\_skip\_code}: \37$\\{print\_esc}(\.{"leftskip"})$;\6
\4\\{right\_skip\_code}: \37$\\{print\_esc}(\.{"rightskip"})$;\6
\4\\{top\_skip\_code}: \37$\\{print\_esc}(\.{"topskip"})$;\6
\4\\{split\_top\_skip\_code}: \37$\\{print\_esc}(\.{"splittopskip"})$;\6
\4\\{tab\_skip\_code}: \37$\\{print\_esc}(\.{"tabskip"})$;\6
\4\\{space\_skip\_code}: \37$\\{print\_esc}(\.{"spaceskip"})$;\6
\4\\{xspace\_skip\_code}: \37$\\{print\_esc}(\.{"xspaceskip"})$;\6
\4\\{par\_fill\_skip\_code}: \37$\\{print\_esc}(\.{"parfillskip"})$;\6
\4\\{thin\_mu\_skip\_code}: \37$\\{print\_esc}(\.{"thinmuskip"})$;\6
\4\\{med\_mu\_skip\_code}: \37$\\{print\_esc}(\.{"medmuskip"})$;\6
\4\\{thick\_mu\_skip\_code}: \37$\\{print\_esc}(\.{"thickmuskip"})$;\6
\4\&{othercases} \37$\\{print}(\.{"[unknown\ glue\ parameter!]"})$\2\6
\&{endcases};\6
\&{end};\par
\U197.\fi

\M244. The symbolic names for glue parameters are put into \TeX's hash table
by using the routine called \\{primitive}, defined below. Let us enter them
now, so that we don't have to list all those parameter names anywhere else.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\S$\6
$\\{primitive}(\.{"lineskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{line%
\_skip\_code})$;\6
$\\{primitive}(\.{"baselineskip"},\39\\{assign\_glue},\39\\{glue\_base}+%
\\{baseline\_skip\_code})$;\6
$\\{primitive}(\.{"parskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{par\_skip%
\_code})$;\6
$\\{primitive}(\.{"abovedisplayskip"},\39\\{assign\_glue},\39\\{glue\_base}+%
\\{above\_display\_skip\_code})$;\6
$\\{primitive}(\.{"belowdisplayskip"},\39\\{assign\_glue},\39\\{glue\_base}+%
\\{below\_display\_skip\_code})$;\6
$\\{primitive}(\.{"abovedisplayshortskip"},\39\\{assign\_glue},\39\\{glue%
\_base}+\\{above\_display\_short\_skip\_code})$;\6
$\\{primitive}(\.{"belowdisplayshortskip"},\39\\{assign\_glue},\39\\{glue%
\_base}+\\{below\_display\_short\_skip\_code})$;\6
$\\{primitive}(\.{"leftskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{left%
\_skip\_code})$;\6
$\\{primitive}(\.{"rightskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{right%
\_skip\_code})$;\6
$\\{primitive}(\.{"topskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{top\_skip%
\_code})$;\6
$\\{primitive}(\.{"splittopskip"},\39\\{assign\_glue},\39\\{glue\_base}+%
\\{split\_top\_skip\_code})$;\6
$\\{primitive}(\.{"tabskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{tab\_skip%
\_code})$;\6
$\\{primitive}(\.{"spaceskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{space%
\_skip\_code})$;\6
$\\{primitive}(\.{"xspaceskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{xspace%
\_skip\_code})$;\6
$\\{primitive}(\.{"parfillskip"},\39\\{assign\_glue},\39\\{glue\_base}+\\{par%
\_fill\_skip\_code})$;\6
$\\{primitive}(\.{"thinmuskip"},\39\\{assign\_mu\_glue},\39\\{glue\_base}+%
\\{thin\_mu\_skip\_code})$;\6
$\\{primitive}(\.{"medmuskip"},\39\\{assign\_mu\_glue},\39\\{glue\_base}+\\{med%
\_mu\_skip\_code})$;\6
$\\{primitive}(\.{"thickmuskip"},\39\\{assign\_mu\_glue},\39\\{glue\_base}+%
\\{thick\_mu\_skip\_code})$;\par
\As248, 256, 266, 287, 356, 402, 410, 437, 442, 494, 513, 517, 579, 956, 1160,
1230, 1236, 1249, 1266, 1285, 1292, 1319, 1334, 1347, 1356, 1366, 1386, 1397,
1400, 1408, 1428, 1432, 1440, 1450, 1455, 1464, 1469\ETs1524.
\U1516.\fi

\M245. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\S$\6
\4$\\{assign\_glue},\39\\{assign\_mu\_glue}$: \37\&{if} $\\{chr\_code}<\\{skip%
\_base}$ \1\&{then}\5
$\\{print\_skip\_param}(\\{chr\_code}-\\{glue\_base})$\6
\4\&{else} \&{if} $\\{chr\_code}<\\{mu\_skip\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"skip"})$;\5
$\\{print\_int}(\\{chr\_code}-\\{skip\_base})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"muskip"})$;\5
$\\{print\_int}(\\{chr\_code}-\\{mu\_skip\_base})$;\6
\&{end};\2\2\par
\As249, 257, 267, 288, 357, 403, 411, 438, 443, 495, 514, 518, 957, 1161, 1231,
1237, 1250, 1267, 1286, 1293, 1321, 1335, 1348, 1357, 1367, 1387, 1398, 1401,
1409, 1429, 1433, 1439, 1441, 1451, 1456, 1465, 1470, 1473\ETs1526.
\U320.\fi

\M246. All glue parameters and registers are initially `\.{0pt plus0pt
minus0pt}'.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{equiv}(\\{glue\_base})\K\\{zero\_glue}$;\5
$\\{eq\_level}(\\{glue\_base})\K\\{level\_one}$;\5
$\\{eq\_type}(\\{glue\_base})\K\\{glue\_ref}$;\6
\&{for} $\|k\K\\{glue\_base}+1\mathrel{\&{to}}\\{local\_base}-1$ \1\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{glue\_base}]$;\2\6
$\\{glue\_ref\_count}(\\{zero\_glue})\K\\{glue\_ref\_count}(\\{zero\_glue})+%
\\{local\_base}-\\{glue\_base}$;\par
\fi

\M247. \P$\X247:Show equivalent \|n, in region 3\X\S$\6
\&{if} $\|n<\\{skip\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_skip\_param}(\|n-\\{glue\_base})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\|n<\\{glue\_base}+\\{thin\_mu\_skip\_code}$ \1\&{then}\5
$\\{print\_spec}(\\{equiv}(\|n),\39\.{"pt"})$\6
\4\&{else} $\\{print\_spec}(\\{equiv}(\|n),\39\.{"mu"})$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{mu\_skip\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"skip"})$;\5
$\\{print\_int}(\|n-\\{skip\_base})$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_spec}(\\{equiv}(\|n),\39\.{"pt"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"muskip"})$;\5
$\\{print\_int}(\|n-\\{mu\_skip\_base})$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_spec}(\\{equiv}(\|n),\39\.{"mu"})$;\6
\&{end}\2\2\par
\U270.\fi

\M248. Region 4 of \\{eqtb} contains the local quantities defined here. The
bulk of this region is taken up by five tables that are indexed by eight-bit
characters; these tables are important to both the syntactic and semantic
portions of \TeX. There are also a bunch of special things like font and
token parameters, as well as the tables of \.{\\toks} and \.{\\box}
registers.

\Y\P\D \37$\\{par\_shape\_loc}=\\{local\_base}$\C{specifies paragraph shape}\par
\P\D \37$\\{output\_routine\_loc}=\\{local\_base}+1$\C{points to token list for
\.{\\output}}\par
\P\D \37$\\{every\_par\_loc}=\\{local\_base}+2$\C{points to token list for \.{%
\\everypar}}\par
\P\D \37$\\{every\_math\_loc}=\\{local\_base}+3$\C{points to token list for \.{%
\\everymath}}\par
\P\D \37$\\{every\_display\_loc}=\\{local\_base}+4$\C{points to token list for %
\.{\\everydisplay}}\par
\P\D \37$\\{every\_hbox\_loc}=\\{local\_base}+5$\C{points to token list for \.{%
\\everyhbox}}\par
\P\D \37$\\{every\_vbox\_loc}=\\{local\_base}+6$\C{points to token list for \.{%
\\everyvbox}}\par
\P\D \37$\\{every\_job\_loc}=\\{local\_base}+7$\C{points to token list for \.{%
\\everyjob}}\par
\P\D \37$\\{every\_cr\_loc}=\\{local\_base}+8$\C{points to token list for \.{%
\\everycr}}\par
\P\D \37$\\{err\_help\_loc}=\\{local\_base}+9$\C{points to token list for \.{%
\\errhelp}}\par
\P\D \37$\\{tex\_toks}=\\{local\_base}+10$\C{end of \TeX's token list
parameters}\Y\par
\P\D \37$\\{pdftex\_first\_loc}=\\{tex\_toks}$\C{base for \pdfTeX's token list
parameters}\par
\P\D \37$\\{pdf\_pages\_attr\_loc}=\\{pdftex\_first\_loc}+0$\C{points to token
list for \.{\\pdfpagesattr}}\par
\P\D \37$\\{pdf\_page\_attr\_loc}=\\{pdftex\_first\_loc}+1$\C{points to token
list for \.{\\pdfpageattr}}\par
\P\D \37$\\{pdf\_page\_resources\_loc}=\\{pdftex\_first\_loc}+2$\C{points to
token list for \.{\\pdfpageresources}}\par
\P\D \37$\\{pdf\_pk\_mode\_loc}=\\{pdftex\_first\_loc}+3$\C{points to token
list for \.{\\pdfpkmode}}\par
\P\D \37$\\{pdf\_toks}=\\{pdftex\_first\_loc}+4$\C{end of \pdfTeX's token list
parameters}\Y\par
\P\D \37$\\{etex\_toks\_base}=\\{pdf\_toks}$\C{base for \eTeX's token list
parameters}\par
\P\D \37$\\{every\_eof\_loc}=\\{etex\_toks\_base}$\C{points to token list for %
\.{\\everyeof}}\par
\P\D \37$\\{etex\_toks}=\\{etex\_toks\_base}+1$\C{end of \eTeX's token list
parameters}\Y\par
\P\D \37$\\{toks\_base}=\\{etex\_toks}$\C{table of 256 token list registers}\Y%
\par
\P\D \37$\\{etex\_pen\_base}=\\{toks\_base}+256$\C{start of table of \eTeX's
penalties}\par
\P\D \37$\\{inter\_line\_penalties\_loc}=\\{etex\_pen\_base}$\C{additional
penalties between lines}\par
\P\D \37$\\{club\_penalties\_loc}=\\{etex\_pen\_base}+1$\C{penalties for
creating club lines}\par
\P\D \37$\\{widow\_penalties\_loc}=\\{etex\_pen\_base}+2$\C{penalties for
creating widow lines}\par
\P\D \37$\\{display\_widow\_penalties\_loc}=\\{etex\_pen\_base}+3$\C{ditto,
just before a display}\par
\P\D \37$\\{etex\_pens}=\\{etex\_pen\_base}+4$\C{end of table of \eTeX's
penalties}\Y\par
\P\D \37$\\{box\_base}=\\{etex\_pens}$\C{table of 256 box registers}\par
\P\D \37$\\{cur\_font\_loc}=\\{box\_base}+256$\C{internal font number outside
math mode}\par
\P\D \37$\\{math\_font\_base}=\\{cur\_font\_loc}+1$\C{table of 48 math font
numbers}\par
\P\D \37$\\{cat\_code\_base}=\\{math\_font\_base}+48$\C{table of 256 command
codes (the ``catcodes'')}\par
\P\D \37$\\{lc\_code\_base}=\\{cat\_code\_base}+256$\C{table of 256 lowercase
mappings}\par
\P\D \37$\\{uc\_code\_base}=\\{lc\_code\_base}+256$\C{table of 256 uppercase
mappings}\par
\P\D \37$\\{sf\_code\_base}=\\{uc\_code\_base}+256$\C{table of 256 spacefactor
mappings}\par
\P\D \37$\\{math\_code\_base}=\\{sf\_code\_base}+256$\C{table of 256 math mode
mappings}\par
\P\D \37$\\{int\_base}=\\{math\_code\_base}+256$\C{beginning of region 5}\Y\par
\P\D \37$\\{par\_shape\_ptr}\S\\{equiv}(\\{par\_shape\_loc})$\par
\P\D \37$\\{output\_routine}\S\\{equiv}(\\{output\_routine\_loc})$\par
\P\D \37$\\{every\_par}\S\\{equiv}(\\{every\_par\_loc})$\par
\P\D \37$\\{every\_math}\S\\{equiv}(\\{every\_math\_loc})$\par
\P\D \37$\\{every\_display}\S\\{equiv}(\\{every\_display\_loc})$\par
\P\D \37$\\{every\_hbox}\S\\{equiv}(\\{every\_hbox\_loc})$\par
\P\D \37$\\{every\_vbox}\S\\{equiv}(\\{every\_vbox\_loc})$\par
\P\D \37$\\{every\_job}\S\\{equiv}(\\{every\_job\_loc})$\par
\P\D \37$\\{every\_cr}\S\\{equiv}(\\{every\_cr\_loc})$\par
\P\D \37$\\{err\_help}\S\\{equiv}(\\{err\_help\_loc})$\par
\P\D \37$\\{pdf\_pages\_attr}\S\\{equiv}(\\{pdf\_pages\_attr\_loc})$\par
\P\D \37$\\{pdf\_page\_attr}\S\\{equiv}(\\{pdf\_page\_attr\_loc})$\par
\P\D \37$\\{pdf\_page\_resources}\S\\{equiv}(\\{pdf\_page\_resources\_loc})$\par
\P\D \37$\\{pdf\_pk\_mode}\S\\{equiv}(\\{pdf\_pk\_mode\_loc})$\par
\P\D \37$\\{toks}(\#)\S\\{equiv}(\\{toks\_base}+\#)$\par
\P\D \37$\\{box}(\#)\S\\{equiv}(\\{box\_base}+\#)$\par
\P\D \37$\\{cur\_font}\S\\{equiv}(\\{cur\_font\_loc})$\par
\P\D \37$\\{fam\_fnt}(\#)\S\\{equiv}(\\{math\_font\_base}+\#)$\par
\P\D \37$\\{cat\_code}(\#)\S\\{equiv}(\\{cat\_code\_base}+\#)$\par
\P\D \37$\\{lc\_code}(\#)\S\\{equiv}(\\{lc\_code\_base}+\#)$\par
\P\D \37$\\{uc\_code}(\#)\S\\{equiv}(\\{uc\_code\_base}+\#)$\par
\P\D \37$\\{sf\_code}(\#)\S\\{equiv}(\\{sf\_code\_base}+\#)$\par
\P\D \37$\\{math\_code}(\#)\S\\{equiv}(\\{math\_code\_base}+\#)$\C{Note: $%
\\{math\_code}(\|c)$ is the true math code plus \\{min\_halfword}}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"output"},\39\\{assign\_toks},\39\\{output\_routine\_loc})$;\5
$\\{primitive}(\.{"everypar"},\39\\{assign\_toks},\39\\{every\_par\_loc})$;\5
$\\{primitive}(\.{"everymath"},\39\\{assign\_toks},\39\\{every\_math\_loc})$;\5
$\\{primitive}(\.{"everydisplay"},\39\\{assign\_toks},\39\\{every\_display%
\_loc})$;\5
$\\{primitive}(\.{"everyhbox"},\39\\{assign\_toks},\39\\{every\_hbox\_loc})$;\5
$\\{primitive}(\.{"everyvbox"},\39\\{assign\_toks},\39\\{every\_vbox\_loc})$;\5
$\\{primitive}(\.{"everyjob"},\39\\{assign\_toks},\39\\{every\_job\_loc})$;\5
$\\{primitive}(\.{"everycr"},\39\\{assign\_toks},\39\\{every\_cr\_loc})$;\5
$\\{primitive}(\.{"errhelp"},\39\\{assign\_toks},\39\\{err\_help\_loc})$;\5
$\\{primitive}(\.{"pdfpagesattr"},\39\\{assign\_toks},\39\\{pdf\_pages\_attr%
\_loc})$;\5
$\\{primitive}(\.{"pdfpageattr"},\39\\{assign\_toks},\39\\{pdf\_page\_attr%
\_loc})$;\5
$\\{primitive}(\.{"pdfpageresources"},\39\\{assign\_toks},\39\\{pdf\_page%
\_resources\_loc})$;\5
$\\{primitive}(\.{"pdfpkmode"},\39\\{assign\_toks},\39\\{pdf\_pk\_mode\_loc})$;%
\par
\fi

\M249. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{assign\_toks}: \37\&{if} $\\{chr\_code}\G\\{toks\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"toks"})$;\5
$\\{print\_int}(\\{chr\_code}-\\{toks\_base})$;\6
\&{end}\6
\4\&{else} \&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{output\_routine\_loc}: \37$\\{print\_esc}(\.{"output"})$;\6
\4\\{every\_par\_loc}: \37$\\{print\_esc}(\.{"everypar"})$;\6
\4\\{every\_math\_loc}: \37$\\{print\_esc}(\.{"everymath"})$;\6
\4\\{every\_display\_loc}: \37$\\{print\_esc}(\.{"everydisplay"})$;\6
\4\\{every\_hbox\_loc}: \37$\\{print\_esc}(\.{"everyhbox"})$;\6
\4\\{every\_vbox\_loc}: \37$\\{print\_esc}(\.{"everyvbox"})$;\6
\4\\{every\_job\_loc}: \37$\\{print\_esc}(\.{"everyjob"})$;\6
\4\\{every\_cr\_loc}: \37$\\{print\_esc}(\.{"everycr"})$;\6
\X1658:Cases of \\{assign\_toks} for \\{print\_cmd\_chr}\X\6
\4\\{pdf\_pages\_attr\_loc}: \37$\\{print\_esc}(\.{"pdfpagesattr"})$;\6
\4\\{pdf\_page\_attr\_loc}: \37$\\{print\_esc}(\.{"pdfpageattr"})$;\6
\4\\{pdf\_page\_resources\_loc}: \37$\\{print\_esc}(\.{"pdfpageresources"})$;\6
\4\\{pdf\_pk\_mode\_loc}: \37$\\{print\_esc}(\.{"pdfpkmode"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"errhelp"})$\2\6
\&{endcases};\2\par
\fi

\M250. We initialize most things to null or undefined values. An undefined font
is represented by the internal code \\{font\_base}.

However, the character code tables are given initial values based on the
conventional interpretation of ASCII code. These initial values should
not be changed when \TeX\ is adapted for use with non-English languages;
all changes to the initialization conventions should be made in format
packages, not in \TeX\ itself, so that global interchange of formats is
possible.

\Y\P\D \37$\\{null\_font}\S\\{font\_base}$\par
\P\D \37$\\{var\_code}\S\O{70000}$\C{math code meaning ``use the current
family''}\par
\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{par\_shape\_ptr}\K\\{null}$;\5
$\\{eq\_type}(\\{par\_shape\_loc})\K\\{shape\_ref}$;\5
$\\{eq\_level}(\\{par\_shape\_loc})\K\\{level\_one}$;\6
\&{for} $\|k\K\\{etex\_pen\_base}\mathrel{\&{to}}\\{etex\_pens}-1$ \1\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{par\_shape\_loc}]$;\2\6
\&{for} $\|k\K\\{output\_routine\_loc}\mathrel{\&{to}}\\{toks\_base}+255$ \1%
\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{undefined\_control\_sequence}]$;\2\6
$\\{box}(0)\K\\{null}$;\5
$\\{eq\_type}(\\{box\_base})\K\\{box\_ref}$;\5
$\\{eq\_level}(\\{box\_base})\K\\{level\_one}$;\6
\&{for} $\|k\K\\{box\_base}+1\mathrel{\&{to}}\\{box\_base}+255$ \1\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{box\_base}]$;\2\6
$\\{cur\_font}\K\\{null\_font}$;\5
$\\{eq\_type}(\\{cur\_font\_loc})\K\\{data}$;\5
$\\{eq\_level}(\\{cur\_font\_loc})\K\\{level\_one}$;\6
\&{for} $\|k\K\\{math\_font\_base}\mathrel{\&{to}}\\{math\_font\_base}+47$ \1%
\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{cur\_font\_loc}]$;\2\6
$\\{equiv}(\\{cat\_code\_base})\K0$;\5
$\\{eq\_type}(\\{cat\_code\_base})\K\\{data}$;\5
$\\{eq\_level}(\\{cat\_code\_base})\K\\{level\_one}$;\6
\&{for} $\|k\K\\{cat\_code\_base}+1\mathrel{\&{to}}\\{int\_base}-1$ \1\&{do}\5
$\\{eqtb}[\|k]\K\\{eqtb}[\\{cat\_code\_base}]$;\2\6
\&{for} $\|k\K0\mathrel{\&{to}}255$ \1\&{do}\6
\&{begin} \37$\\{cat\_code}(\|k)\K\\{other\_char}$;\5
$\\{math\_code}(\|k)\K\\{hi}(\|k)$;\5
$\\{sf\_code}(\|k)\K1000$;\6
\&{end};\2\6
$\\{cat\_code}(\\{carriage\_return})\K\\{car\_ret}$;\5
$\\{cat\_code}(\.{"\ "})\K\\{spacer}$;\5
$\\{cat\_code}(\.{"\\"})\K\\{escape}$;\5
$\\{cat\_code}(\.{"\%"})\K\\{comment}$;\5
$\\{cat\_code}(\\{invalid\_code})\K\\{invalid\_char}$;\5
$\\{cat\_code}(\\{null\_code})\K\\{ignore}$;\6
\&{for} $\|k\K\.{"0"}\mathrel{\&{to}}\.{"9"}$ \1\&{do}\5
$\\{math\_code}(\|k)\K\\{hi}(\|k+\\{var\_code})$;\2\6
\&{for} $\|k\K\.{"A"}\mathrel{\&{to}}\.{"Z"}$ \1\&{do}\6
\&{begin} \37$\\{cat\_code}(\|k)\K\\{letter}$;\5
$\\{cat\_code}(\|k+\.{"a"}-\.{"A"})\K\\{letter}$;\6
$\\{math\_code}(\|k)\K\\{hi}(\|k+\\{var\_code}+\H{100})$;\5
$\\{math\_code}(\|k+\.{"a"}-\.{"A"})\K\\{hi}(\|k+\.{"a"}-\.{"A"}+\\{var\_code}+%
\H{100})$;\6
$\\{lc\_code}(\|k)\K\|k+\.{"a"}-\.{"A"}$;\5
$\\{lc\_code}(\|k+\.{"a"}-\.{"A"})\K\|k+\.{"a"}-\.{"A"}$;\6
$\\{uc\_code}(\|k)\K\|k$;\5
$\\{uc\_code}(\|k+\.{"a"}-\.{"A"})\K\|k$;\6
$\\{sf\_code}(\|k)\K999$;\6
\&{end};\2\par
\fi

\M251. \P$\X251:Show equivalent \|n, in region 4\X\S$\6
\&{if} $(\|n=\\{par\_shape\_loc})\V((\|n\G\\{etex\_pen\_base})\W(\|n<\\{etex%
\_pens}))$ \1\&{then}\6
\&{begin} \37$\\{print\_cmd\_chr}(\\{set\_shape},\39\|n)$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\\{equiv}(\|n)=\\{null}$ \1\&{then}\5
$\\{print\_char}(\.{"0"})$\6
\4\&{else} \&{if} $\|n>\\{par\_shape\_loc}$ \1\&{then}\6
\&{begin} \37$\\{print\_int}(\\{penalty}(\\{equiv}(\|n)))$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\\{penalty}(\\{equiv}(\|n)+1))$;\6
\&{if} $\\{penalty}(\\{equiv}(\|n))>1$ \1\&{then}\5
$\\{print\_esc}(\.{"ETC."})$;\2\6
\&{end}\6
\4\&{else} $\\{print\_int}(\\{info}(\\{par\_shape\_ptr}))$;\2\2\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{toks\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_cmd\_chr}(\\{assign\_toks},\39\|n)$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\\{equiv}(\|n)\I\\{null}$ \1\&{then}\5
$\\{show\_token\_list}(\\{link}(\\{equiv}(\|n)),\39\\{null},\3932)$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{box\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"toks"})$;\5
$\\{print\_int}(\|n-\\{toks\_base})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\\{equiv}(\|n)\I\\{null}$ \1\&{then}\5
$\\{show\_token\_list}(\\{link}(\\{equiv}(\|n)),\39\\{null},\3932)$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{cur\_font\_loc}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"box"})$;\5
$\\{print\_int}(\|n-\\{box\_base})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\\{equiv}(\|n)=\\{null}$ \1\&{then}\5
$\\{print}(\.{"void"})$\6
\4\&{else} \&{begin} \37$\\{depth\_threshold}\K0$;\5
$\\{breadth\_max}\K1$;\5
$\\{show\_node\_list}(\\{equiv}(\|n))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{cat\_code\_base}$ \1\&{then}\5
\X252:Show the font identifier in $\\{eqtb}[\|n]$\X\6
\4\&{else} \X253:Show the halfword code in $\\{eqtb}[\|n]$\X\2\2\2\2\2\par
\U270.\fi

\M252. \P$\X252:Show the font identifier in $\\{eqtb}[\|n]$\X\S$\6
\&{begin} \37\&{if} $\|n=\\{cur\_font\_loc}$ \1\&{then}\5
$\\{print}(\.{"current\ font"})$\6
\4\&{else} \&{if} $\|n<\\{math\_font\_base}+16$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"textfont"})$;\5
$\\{print\_int}(\|n-\\{math\_font\_base})$;\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{math\_font\_base}+32$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"scriptfont"})$;\5
$\\{print\_int}(\|n-\\{math\_font\_base}-16)$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"scriptscriptfont"})$;\5
$\\{print\_int}(\|n-\\{math\_font\_base}-32)$;\6
\&{end};\2\2\2\6
$\\{print\_char}(\.{"="})$;\6
$\\{print\_esc}(\\{hash}[\\{font\_id\_base}+\\{equiv}(\|n)].\\{rh})$;\C{that's
$\\{font\_id\_text}(\\{equiv}(\|n))$}\6
\&{end}\par
\U251.\fi

\M253. \P$\X253:Show the halfword code in $\\{eqtb}[\|n]$\X\S$\6
\&{if} $\|n<\\{math\_code\_base}$ \1\&{then}\6
\&{begin} \37\&{if} $\|n<\\{lc\_code\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"catcode"})$;\5
$\\{print\_int}(\|n-\\{cat\_code\_base})$;\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{uc\_code\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"lccode"})$;\5
$\\{print\_int}(\|n-\\{lc\_code\_base})$;\6
\&{end}\6
\4\&{else} \&{if} $\|n<\\{sf\_code\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"uccode"})$;\5
$\\{print\_int}(\|n-\\{uc\_code\_base})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"sfcode"})$;\5
$\\{print\_int}(\|n-\\{sf\_code\_base})$;\6
\&{end};\2\2\2\6
$\\{print\_char}(\.{"="})$;\5
$\\{print\_int}(\\{equiv}(\|n))$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"mathcode"})$;\5
$\\{print\_int}(\|n-\\{math\_code\_base})$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_int}(\\{ho}(\\{equiv}(\|n)))$;\6
\&{end}\2\par
\U251.\fi

\M254. Region 5 of \\{eqtb} contains the integer parameters and registers
defined
here, as well as the \\{del\_code} table. The latter table differs from the
$\\{cat\_code}\to\\{math\_code}$ tables that precede it, since delimiter codes
are
fullword integers while the other kinds of codes occupy at most a
halfword. This is what makes region~5 different from region~4. We will
store the \\{eq\_level} information in an auxiliary array of quarterwords
that will be defined later.

\Y\P\D \37$\\{pretolerance\_code}=0$\C{badness tolerance before hyphenation}\par
\P\D \37$\\{tolerance\_code}=1$\C{badness tolerance after hyphenation}\par
\P\D \37$\\{line\_penalty\_code}=2$\C{added to the badness of every line}\par
\P\D \37$\\{hyphen\_penalty\_code}=3$\C{penalty for break after discretionary
hyphen}\par
\P\D \37$\\{ex\_hyphen\_penalty\_code}=4$\C{penalty for break after explicit
hyphen}\par
\P\D \37$\\{club\_penalty\_code}=5$\C{penalty for creating a club line}\par
\P\D \37$\\{widow\_penalty\_code}=6$\C{penalty for creating a widow line}\par
\P\D \37$\\{display\_widow\_penalty\_code}=7$\C{ditto, just before a display}%
\par
\P\D \37$\\{broken\_penalty\_code}=8$\C{penalty for breaking a page at a broken
line}\par
\P\D \37$\\{bin\_op\_penalty\_code}=9$\C{penalty for breaking after a binary
operation}\par
\P\D \37$\\{rel\_penalty\_code}=10$\C{penalty for breaking after a relation}\par
\P\D \37$\\{pre\_display\_penalty\_code}=11$\C{penalty for breaking just before
a displayed formula}\par
\P\D \37$\\{post\_display\_penalty\_code}=12$\C{penalty for breaking just after
a displayed formula}\par
\P\D \37$\\{inter\_line\_penalty\_code}=13$\C{additional penalty between lines}%
\par
\P\D \37$\\{double\_hyphen\_demerits\_code}=14$\C{demerits for double hyphen
break}\par
\P\D \37$\\{final\_hyphen\_demerits\_code}=15$\C{demerits for final hyphen
break}\par
\P\D \37$\\{adj\_demerits\_code}=16$\C{demerits for adjacent incompatible
lines}\par
\P\D \37$\\{mag\_code}=17$\C{magnification ratio}\par
\P\D \37$\\{delimiter\_factor\_code}=18$\C{ratio for variable-size delimiters}%
\par
\P\D \37$\\{looseness\_code}=19$\C{change in number of lines for a paragraph}%
\par
\P\D \37$\\{time\_code}=20$\C{current time of day}\par
\P\D \37$\\{day\_code}=21$\C{current day of the month}\par
\P\D \37$\\{month\_code}=22$\C{current month of the year}\par
\P\D \37$\\{year\_code}=23$\C{current year of our Lord}\par
\P\D \37$\\{show\_box\_breadth\_code}=24$\C{nodes per level in \\{show\_box}}%
\par
\P\D \37$\\{show\_box\_depth\_code}=25$\C{maximum level in \\{show\_box}}\par
\P\D \37$\\{hbadness\_code}=26$\C{hboxes exceeding this badness will be shown
by \\{hpack}}\par
\P\D \37$\\{vbadness\_code}=27$\C{vboxes exceeding this badness will be shown
by \\{vpack}}\par
\P\D \37$\\{pausing\_code}=28$\C{pause after each line is read from a file}\par
\P\D \37$\\{tracing\_online\_code}=29$\C{show diagnostic output on terminal}\par
\P\D \37$\\{tracing\_macros\_code}=30$\C{show macros as they are being
expanded}\par
\P\D \37$\\{tracing\_stats\_code}=31$\C{show memory usage if \TeX\ knows it}\par
\P\D \37$\\{tracing\_paragraphs\_code}=32$\C{show line-break calculations}\par
\P\D \37$\\{tracing\_pages\_code}=33$\C{show page-break calculations}\par
\P\D \37$\\{tracing\_output\_code}=34$\C{show boxes when they are shipped out}%
\par
\P\D \37$\\{tracing\_lost\_chars\_code}=35$\C{show characters that aren't in
the font}\par
\P\D \37$\\{tracing\_commands\_code}=36$\C{show command codes at \\{big%
\_switch}}\par
\P\D \37$\\{tracing\_restores\_code}=37$\C{show equivalents when they are
restored}\par
\P\D \37$\\{uc\_hyph\_code}=38$\C{hyphenate words beginning with a capital
letter}\par
\P\D \37$\\{output\_penalty\_code}=39$\C{penalty found at current page break}%
\par
\P\D \37$\\{max\_dead\_cycles\_code}=40$\C{bound on consecutive dead cycles of
output}\par
\P\D \37$\\{hang\_after\_code}=41$\C{hanging indentation changes after this
many lines}\par
\P\D \37$\\{floating\_penalty\_code}=42$\C{penalty for insertions held over
after a split}\par
\P\D \37$\\{global\_defs\_code}=43$\C{override \.{\\global} specifications}\par
\P\D \37$\\{cur\_fam\_code}=44$\C{current family}\par
\P\D \37$\\{escape\_char\_code}=45$\C{escape character for token output}\par
\P\D \37$\\{default\_hyphen\_char\_code}=46$\C{value of \.{\\hyphenchar} when a
font is loaded}\par
\P\D \37$\\{default\_skew\_char\_code}=47$\C{value of \.{\\skewchar} when a
font is loaded}\par
\P\D \37$\\{end\_line\_char\_code}=48$\C{character placed at the right end of
the buffer}\par
\P\D \37$\\{new\_line\_char\_code}=49$\C{character that prints as \\{print%
\_ln}}\par
\P\D \37$\\{language\_code}=50$\C{current hyphenation table}\par
\P\D \37$\\{left\_hyphen\_min\_code}=51$\C{minimum left hyphenation fragment
size}\par
\P\D \37$\\{right\_hyphen\_min\_code}=52$\C{minimum right hyphenation fragment
size}\par
\P\D \37$\\{holding\_inserts\_code}=53$\C{do not remove insertion nodes from %
\.{\\box255}}\par
\P\D \37$\\{error\_context\_lines\_code}=54$\C{maximum intermediate line pairs
shown}\par
\P\D \37$\\{tex\_int\_pars}=55$\C{total number of \TeX's integer parameters}\Y%
\par
\P\D \37$\\{pdftex\_first\_integer\_code}=\\{tex\_int\_pars}$\C{base for %
\pdfTeX's integer parameters}\par
\P\D \37$\\{pdf\_output\_code}=\\{pdftex\_first\_integer\_code}+0$\C{switch on
PDF output if positive}\par
\P\D \37$\\{pdf\_compress\_level\_code}=\\{pdftex\_first\_integer\_code}+1$%
\C{compress level of streams}\par
\P\D \37$\\{pdf\_decimal\_digits\_code}=\\{pdftex\_first\_integer\_code}+2$%
\C{digits after the decimal point of numbers}\par
\P\D \37$\\{pdf\_move\_chars\_code}=\\{pdftex\_first\_integer\_code}+3$\C{move
chars 0..31 to higher area if possible}\par
\P\D \37$\\{pdf\_image\_resolution\_code}=\\{pdftex\_first\_integer\_code}+4$%
\C{default image resolution}\par
\P\D \37$\\{pdf\_pk\_resolution\_code}=\\{pdftex\_first\_integer\_code}+5$%
\C{default resolution of PK font}\par
\P\D \37$\\{pdf\_unique\_resname\_code}=\\{pdftex\_first\_integer\_code}+6$%
\C{generate unique names for resouces}\par
\P\D \37$\\{pdf\_option\_always\_use\_pdfpagebox\_code}=\\{pdftex\_first%
\_integer\_code}+7$\C{if the PDF inclusion should always use a specific PDF
page box}\par
\P\D \37$\\{pdf\_option\_pdf\_inclusion\_errorlevel\_code}=\\{pdftex\_first%
\_integer\_code}+8$\C{if the PDF inclusion should treat pdfs newer than \\{pdf%
\_minor\_version} as an error}\par
\P\D \37$\\{pdf\_major\_version\_code}=\\{pdftex\_first\_integer\_code}+9$%
\C{integer part of the PDF version produced}\par
\P\D \37$\\{pdf\_minor\_version\_code}=\\{pdftex\_first\_integer\_code}+10$%
\C{fractional part of the PDF version produced}\par
\P\D \37$\\{pdf\_force\_pagebox\_code}=\\{pdftex\_first\_integer\_code}+11$%
\C{if the PDF inclusion should always use a specific PDF page box}\par
\P\D \37$\\{pdf\_pagebox\_code}=\\{pdftex\_first\_integer\_code}+12$\C{default
pagebox to use for PDF inclusion}\par
\P\D \37$\\{pdf\_inclusion\_errorlevel\_code}=\\{pdftex\_first\_integer%
\_code}+13$\C{if the PDF inclusion should treat pdfs newer than \\{pdf\_minor%
\_version} as an error}\par
\P\D \37$\\{pdf\_gamma\_code}=\\{pdftex\_first\_integer\_code}+14$\par
\P\D \37$\\{pdf\_image\_gamma\_code}=\\{pdftex\_first\_integer\_code}+15$\par
\P\D \37$\\{pdf\_image\_hicolor\_code}=\\{pdftex\_first\_integer\_code}+16$\par
\P\D \37$\\{pdf\_image\_apply\_gamma\_code}=\\{pdftex\_first\_integer%
\_code}+17$\par
\P\D \37$\\{pdf\_adjust\_spacing\_code}=\\{pdftex\_first\_integer\_code}+18$%
\C{level of spacing adjusting}\par
\P\D \37$\\{pdf\_protrude\_chars\_code}=\\{pdftex\_first\_integer\_code}+19$%
\C{protrude chars at left/right edge of paragraphs}\par
\P\D \37$\\{pdf\_tracing\_fonts\_code}=\\{pdftex\_first\_integer\_code}+20$%
\C{level of font detail in log}\par
\P\D \37$\\{pdf\_objcompresslevel\_code}=\\{pdftex\_first\_integer\_code}+21$%
\C{activate object streams}\par
\P\D \37$\\{pdf\_adjust\_interword\_glue\_code}=\\{pdftex\_first\_integer%
\_code}+22$\C{adjust interword glue?}\par
\P\D \37$\\{pdf\_prepend\_kern\_code}=\\{pdftex\_first\_integer\_code}+23$%
\C{prepend kern before certain characters?}\par
\P\D \37$\\{pdf\_append\_kern\_code}=\\{pdftex\_first\_integer\_code}+24$%
\C{append kern before certain characters?}\par
\P\D \37$\\{pdf\_gen\_tounicode\_code}=\\{pdftex\_first\_integer\_code}+25$%
\C{generate ToUnicode for fonts?}\par
\P\D \37$\\{pdf\_draftmode\_code}=\\{pdftex\_first\_integer\_code}+26$\C{switch
on draftmode if positive}\par
\P\D \37$\\{pdf\_inclusion\_copy\_font\_code}=\\{pdftex\_first\_integer%
\_code}+27$\C{generate ToUnicode for fonts?}\par
\P\D \37$\\{pdf\_suppress\_warning\_dup\_dest\_code}=\\{pdftex\_first\_integer%
\_code}+28$\C{suppress warning about duplicated destinations}\par
\P\D \37$\\{pdf\_suppress\_warning\_dup\_map\_code}=\\{pdftex\_first\_integer%
\_code}+29$\C{suppress warning about duplicated map lines}\par
\P\D \37$\\{pdf\_suppress\_warning\_page\_group\_code}=\\{pdftex\_first%
\_integer\_code}+30$\C{suppress warning about multiple pdfs with page group}\par
\P\D \37$\\{pdf\_info\_omit\_date\_code}=\\{pdftex\_first\_integer\_code}+31$%
\C{omit generating CreationDate and ModDate}\par
\P\D \37$\\{pdf\_suppress\_ptex\_info\_code}=\\{pdftex\_first\_integer%
\_code}+32$\C{suppress /PTEX.* entries in PDF dictionaries}\par
\P\D \37$\\{pdf\_omit\_charset\_code}=\\{pdftex\_first\_integer\_code}+33$%
\C{omit CharSet in Font dict}\par
\P\D \37$\\{pdf\_omit\_info\_dict\_code}=\\{pdftex\_first\_integer\_code}+34$%
\C{omit Info dict}\par
\P\D \37$\\{pdf\_omit\_procset\_code}=\\{pdftex\_first\_integer\_code}+35$%
\C{omit ProcSet in resources dict}\par
\P\D \37$\\{pdf\_ptex\_use\_underscore\_code}=\\{pdftex\_first\_integer%
\_code}+36$\C{use underscore for PTEX prefix}\par
\P\D \37$\\{pdf\_int\_pars}=\\{pdftex\_first\_integer\_code}+37$\C{total number
of \pdfTeX's integer parameters}\Y\par
\P\D \37$\\{etex\_int\_base}=\\{pdf\_int\_pars}$\C{base for \eTeX's integer
parameters}\par
\P\D \37$\\{tracing\_assigns\_code}=\\{etex\_int\_base}$\C{show assignments}\par
\P\D \37$\\{tracing\_groups\_code}=\\{etex\_int\_base}+1$\C{show save/restore
groups}\par
\P\D \37$\\{tracing\_ifs\_code}=\\{etex\_int\_base}+2$\C{show conditionals}\par
\P\D \37$\\{tracing\_scan\_tokens\_code}=\\{etex\_int\_base}+3$\C{show pseudo
file open and close}\par
\P\D \37$\\{tracing\_nesting\_code}=\\{etex\_int\_base}+4$\C{show incomplete
groups and ifs within files}\par
\P\D \37$\\{pre\_display\_direction\_code}=\\{etex\_int\_base}+5$\C{text
direction preceding a display}\par
\P\D \37$\\{last\_line\_fit\_code}=\\{etex\_int\_base}+6$\C{adjustment for last
line of paragraph}\par
\P\D \37$\\{saving\_vdiscards\_code}=\\{etex\_int\_base}+7$\C{save items
discarded from vlists}\par
\P\D \37$\\{saving\_hyph\_codes\_code}=\\{etex\_int\_base}+8$\C{save
hyphenation codes for languages}\par
\P\D \37$\\{eTeX\_state\_code}=\\{etex\_int\_base}+9$\C{\eTeX\ state variables}%
\par
\P\D \37$\\{etex\_int\_pars}=\\{eTeX\_state\_code}+\\{eTeX\_states}$\C{total
number of \eTeX's integer parameters}\Y\par
\P\D \37$\\{int\_pars}=\\{etex\_int\_pars}$\C{total number of integer
parameters}\par
\P\D \37$\\{count\_base}=\\{int\_base}+\\{int\_pars}$\C{256 user \.{\\count}
registers}\par
\P\D \37$\\{del\_code\_base}=\\{count\_base}+256$\C{256 delimiter code
mappings}\par
\P\D \37$\\{dimen\_base}=\\{del\_code\_base}+256$\C{beginning of region 6}\Y\par
\P\D \37$\\{del\_code}(\#)\S\\{eqtb}[\\{del\_code\_base}+\#].\\{int}$\par
\P\D \37$\\{count}(\#)\S\\{eqtb}[\\{count\_base}+\#].\\{int}$\par
\P\D \37$\\{int\_par}(\#)\S\\{eqtb}[\\{int\_base}+\#].\\{int}$\C{an integer
parameter}\par
\P\D \37$\\{pretolerance}\S\\{int\_par}(\\{pretolerance\_code})$\par
\P\D \37$\\{tolerance}\S\\{int\_par}(\\{tolerance\_code})$\par
\P\D \37$\\{line\_penalty}\S\\{int\_par}(\\{line\_penalty\_code})$\par
\P\D \37$\\{hyphen\_penalty}\S\\{int\_par}(\\{hyphen\_penalty\_code})$\par
\P\D \37$\\{ex\_hyphen\_penalty}\S\\{int\_par}(\\{ex\_hyphen\_penalty\_code})$%
\par
\P\D \37$\\{club\_penalty}\S\\{int\_par}(\\{club\_penalty\_code})$\par
\P\D \37$\\{widow\_penalty}\S\\{int\_par}(\\{widow\_penalty\_code})$\par
\P\D \37$\\{display\_widow\_penalty}\S\\{int\_par}(\\{display\_widow\_penalty%
\_code})$\par
\P\D \37$\\{broken\_penalty}\S\\{int\_par}(\\{broken\_penalty\_code})$\par
\P\D \37$\\{bin\_op\_penalty}\S\\{int\_par}(\\{bin\_op\_penalty\_code})$\par
\P\D \37$\\{rel\_penalty}\S\\{int\_par}(\\{rel\_penalty\_code})$\par
\P\D \37$\\{pre\_display\_penalty}\S\\{int\_par}(\\{pre\_display\_penalty%
\_code})$\par
\P\D \37$\\{post\_display\_penalty}\S\\{int\_par}(\\{post\_display\_penalty%
\_code})$\par
\P\D \37$\\{inter\_line\_penalty}\S\\{int\_par}(\\{inter\_line\_penalty%
\_code})$\par
\P\D \37$\\{double\_hyphen\_demerits}\S\\{int\_par}(\\{double\_hyphen\_demerits%
\_code})$\par
\P\D \37$\\{final\_hyphen\_demerits}\S\\{int\_par}(\\{final\_hyphen\_demerits%
\_code})$\par
\P\D \37$\\{adj\_demerits}\S\\{int\_par}(\\{adj\_demerits\_code})$\par
\P\D \37$\\{mag}\S\\{int\_par}(\\{mag\_code})$\par
\P\D \37$\\{delimiter\_factor}\S\\{int\_par}(\\{delimiter\_factor\_code})$\par
\P\D \37$\\{looseness}\S\\{int\_par}(\\{looseness\_code})$\par
\P\D \37$\\{time}\S\\{int\_par}(\\{time\_code})$\par
\P\D \37$\\{day}\S\\{int\_par}(\\{day\_code})$\par
\P\D \37$\\{month}\S\\{int\_par}(\\{month\_code})$\par
\P\D \37$\\{year}\S\\{int\_par}(\\{year\_code})$\par
\P\D \37$\\{show\_box\_breadth}\S\\{int\_par}(\\{show\_box\_breadth\_code})$\par
\P\D \37$\\{show\_box\_depth}\S\\{int\_par}(\\{show\_box\_depth\_code})$\par
\P\D \37$\\{hbadness}\S\\{int\_par}(\\{hbadness\_code})$\par
\P\D \37$\\{vbadness}\S\\{int\_par}(\\{vbadness\_code})$\par
\P\D \37$\\{pausing}\S\\{int\_par}(\\{pausing\_code})$\par
\P\D \37$\\{tracing\_online}\S\\{int\_par}(\\{tracing\_online\_code})$\par
\P\D \37$\\{tracing\_macros}\S\\{int\_par}(\\{tracing\_macros\_code})$\par
\P\D \37$\\{tracing\_stats}\S\\{int\_par}(\\{tracing\_stats\_code})$\par
\P\D \37$\\{tracing\_paragraphs}\S\\{int\_par}(\\{tracing\_paragraphs\_code})$%
\par
\P\D \37$\\{tracing\_pages}\S\\{int\_par}(\\{tracing\_pages\_code})$\par
\P\D \37$\\{tracing\_output}\S\\{int\_par}(\\{tracing\_output\_code})$\par
\P\D \37$\\{tracing\_lost\_chars}\S\\{int\_par}(\\{tracing\_lost\_chars%
\_code})$\par
\P\D \37$\\{tracing\_commands}\S\\{int\_par}(\\{tracing\_commands\_code})$\par
\P\D \37$\\{tracing\_restores}\S\\{int\_par}(\\{tracing\_restores\_code})$\par
\P\D \37$\\{uc\_hyph}\S\\{int\_par}(\\{uc\_hyph\_code})$\par
\P\D \37$\\{output\_penalty}\S\\{int\_par}(\\{output\_penalty\_code})$\par
\P\D \37$\\{max\_dead\_cycles}\S\\{int\_par}(\\{max\_dead\_cycles\_code})$\par
\P\D \37$\\{hang\_after}\S\\{int\_par}(\\{hang\_after\_code})$\par
\P\D \37$\\{floating\_penalty}\S\\{int\_par}(\\{floating\_penalty\_code})$\par
\P\D \37$\\{global\_defs}\S\\{int\_par}(\\{global\_defs\_code})$\par
\P\D \37$\\{cur\_fam}\S\\{int\_par}(\\{cur\_fam\_code})$\par
\P\D \37$\\{escape\_char}\S\\{int\_par}(\\{escape\_char\_code})$\par
\P\D \37$\\{default\_hyphen\_char}\S\\{int\_par}(\\{default\_hyphen\_char%
\_code})$\par
\P\D \37$\\{default\_skew\_char}\S\\{int\_par}(\\{default\_skew\_char\_code})$%
\par
\P\D \37$\\{end\_line\_char}\S\\{int\_par}(\\{end\_line\_char\_code})$\par
\P\D \37$\\{new\_line\_char}\S\\{int\_par}(\\{new\_line\_char\_code})$\par
\P\D \37$\\{language}\S\\{int\_par}(\\{language\_code})$\par
\P\D \37$\\{left\_hyphen\_min}\S\\{int\_par}(\\{left\_hyphen\_min\_code})$\par
\P\D \37$\\{right\_hyphen\_min}\S\\{int\_par}(\\{right\_hyphen\_min\_code})$\par
\P\D \37$\\{holding\_inserts}\S\\{int\_par}(\\{holding\_inserts\_code})$\par
\P\D \37$\\{error\_context\_lines}\S\\{int\_par}(\\{error\_context\_lines%
\_code})$\Y\par
\P\D \37$\\{pdf\_adjust\_spacing}\S\\{int\_par}(\\{pdf\_adjust\_spacing%
\_code})$\par
\P\D \37$\\{pdf\_protrude\_chars}\S\\{int\_par}(\\{pdf\_protrude\_chars%
\_code})$\par
\P\D \37$\\{pdf\_tracing\_fonts}\S\\{int\_par}(\\{pdf\_tracing\_fonts\_code})$%
\par
\P\D \37$\\{pdf\_adjust\_interword\_glue}\S\\{int\_par}(\\{pdf\_adjust%
\_interword\_glue\_code})$\par
\P\D \37$\\{pdf\_prepend\_kern}\S\\{int\_par}(\\{pdf\_prepend\_kern\_code})$\par
\P\D \37$\\{pdf\_append\_kern}\S\\{int\_par}(\\{pdf\_append\_kern\_code})$\par
\P\D \37$\\{pdf\_gen\_tounicode}\S\\{int\_par}(\\{pdf\_gen\_tounicode\_code})$%
\par
\P\D \37$\\{pdf\_output}\S\\{int\_par}(\\{pdf\_output\_code})$\par
\P\D \37$\\{pdf\_compress\_level}\S\\{int\_par}(\\{pdf\_compress\_level%
\_code})$\par
\P\D \37$\\{pdf\_objcompresslevel}\S\\{int\_par}(\\{pdf\_objcompresslevel%
\_code})$\par
\P\D \37$\\{pdf\_decimal\_digits}\S\\{int\_par}(\\{pdf\_decimal\_digits%
\_code})$\par
\P\D \37$\\{pdf\_move\_chars}\S\\{int\_par}(\\{pdf\_move\_chars\_code})$\par
\P\D \37$\\{pdf\_image\_resolution}\S\\{int\_par}(\\{pdf\_image\_resolution%
\_code})$\par
\P\D \37$\\{pdf\_pk\_resolution}\S\\{int\_par}(\\{pdf\_pk\_resolution\_code})$%
\par
\P\D \37$\\{pdf\_unique\_resname}\S\\{int\_par}(\\{pdf\_unique\_resname%
\_code})$\par
\P\D \37$\\{pdf\_option\_always\_use\_pdfpagebox}\S\\{int\_par}(\\{pdf\_option%
\_always\_use\_pdfpagebox\_code})$\par
\P\D \37$\\{pdf\_option\_pdf\_inclusion\_errorlevel}\S\\{int\_par}(\\{pdf%
\_option\_pdf\_inclusion\_errorlevel\_code})$\par
\P\D \37$\\{pdf\_major\_version}\S\\{int\_par}(\\{pdf\_major\_version\_code})$%
\par
\P\D \37$\\{pdf\_minor\_version}\S\\{int\_par}(\\{pdf\_minor\_version\_code})$%
\par
\P\D \37$\\{pdf\_force\_pagebox}\S\\{int\_par}(\\{pdf\_force\_pagebox\_code})$%
\par
\P\D \37$\\{pdf\_pagebox}\S\\{int\_par}(\\{pdf\_pagebox\_code})$\par
\P\D \37$\\{pdf\_inclusion\_errorlevel}\S\\{int\_par}(\\{pdf\_inclusion%
\_errorlevel\_code})$\par
\P\D \37$\\{pdf\_gamma}\S\\{int\_par}(\\{pdf\_gamma\_code})$\par
\P\D \37$\\{pdf\_image\_gamma}\S\\{int\_par}(\\{pdf\_image\_gamma\_code})$\par
\P\D \37$\\{pdf\_image\_hicolor}\S\\{int\_par}(\\{pdf\_image\_hicolor\_code})$%
\par
\P\D \37$\\{pdf\_image\_apply\_gamma}\S\\{int\_par}(\\{pdf\_image\_apply\_gamma%
\_code})$\par
\P\D \37$\\{pdf\_draftmode}\S\\{int\_par}(\\{pdf\_draftmode\_code})$\par
\P\D \37$\\{pdf\_inclusion\_copy\_font}\S\\{int\_par}(\\{pdf\_inclusion\_copy%
\_font\_code})$\par
\P\D \37$\\{pdf\_suppress\_warning\_dup\_dest}\S\\{int\_par}(\\{pdf\_suppress%
\_warning\_dup\_dest\_code})$\par
\P\D \37$\\{pdf\_suppress\_warning\_dup\_map}\S\\{int\_par}(\\{pdf\_suppress%
\_warning\_dup\_map\_code})$\par
\P\D \37$\\{pdf\_suppress\_warning\_page\_group}\S\\{int\_par}(\\{pdf\_suppress%
\_warning\_page\_group\_code})$\par
\P\D \37$\\{pdf\_info\_omit\_date}\S\\{int\_par}(\\{pdf\_info\_omit\_date%
\_code})$\par
\P\D \37$\\{pdf\_suppress\_ptex\_info}\S\\{int\_par}(\\{pdf\_suppress\_ptex%
\_info\_code})$\par
\P\D \37$\\{pdf\_omit\_charset}\S\\{int\_par}(\\{pdf\_omit\_charset\_code})$\par
\P\D \37$\\{pdf\_omit\_info\_dict}\S\\{int\_par}(\\{pdf\_omit\_info\_dict%
\_code})$\par
\P\D \37$\\{pdf\_omit\_procset}\S\\{int\_par}(\\{pdf\_omit\_procset\_code})$\par
\P\D \37$\\{pdf\_ptex\_use\_underscore}\S\\{int\_par}(\\{pdf\_ptex\_use%
\_underscore\_code})$\Y\par
\P\D \37$\\{tracing\_assigns}\S\\{int\_par}(\\{tracing\_assigns\_code})$\par
\P\D \37$\\{tracing\_groups}\S\\{int\_par}(\\{tracing\_groups\_code})$\par
\P\D \37$\\{tracing\_ifs}\S\\{int\_par}(\\{tracing\_ifs\_code})$\par
\P\D \37$\\{tracing\_scan\_tokens}\S\\{int\_par}(\\{tracing\_scan\_tokens%
\_code})$\par
\P\D \37$\\{tracing\_nesting}\S\\{int\_par}(\\{tracing\_nesting\_code})$\par
\P\D \37$\\{pre\_display\_direction}\S\\{int\_par}(\\{pre\_display\_direction%
\_code})$\par
\P\D \37$\\{last\_line\_fit}\S\\{int\_par}(\\{last\_line\_fit\_code})$\par
\P\D \37$\\{saving\_vdiscards}\S\\{int\_par}(\\{saving\_vdiscards\_code})$\par
\P\D \37$\\{saving\_hyph\_codes}\S\\{int\_par}(\\{saving\_hyph\_codes\_code})$%
\par
\Y\P$\4\X254:Assign the values $\\{depth\_threshold}\K\\{show\_box\_depth}$ and
$\\{breadth\_max}\K\\{show\_box\_breadth}$\X\S$\6
$\\{depth\_threshold}\K\\{show\_box\_depth}$;\5
$\\{breadth\_max}\K\\{show\_box\_breadth}$\par
\U216.\fi

\M255. We can print the symbolic name of an integer parameter as follows.

\Y\P\4\&{procedure}\1\  \37$\\{print\_param}(\|n:\\{integer})$;\2\6
\&{begin} \37\&{case} $\|n$ \1\&{of}\6
\4\\{pretolerance\_code}: \37$\\{print\_esc}(\.{"pretolerance"})$;\6
\4\\{tolerance\_code}: \37$\\{print\_esc}(\.{"tolerance"})$;\6
\4\\{line\_penalty\_code}: \37$\\{print\_esc}(\.{"linepenalty"})$;\6
\4\\{hyphen\_penalty\_code}: \37$\\{print\_esc}(\.{"hyphenpenalty"})$;\6
\4\\{ex\_hyphen\_penalty\_code}: \37$\\{print\_esc}(\.{"exhyphenpenalty"})$;\6
\4\\{club\_penalty\_code}: \37$\\{print\_esc}(\.{"clubpenalty"})$;\6
\4\\{widow\_penalty\_code}: \37$\\{print\_esc}(\.{"widowpenalty"})$;\6
\4\\{display\_widow\_penalty\_code}: \37$\\{print\_esc}(%
\.{"displaywidowpenalty"})$;\6
\4\\{broken\_penalty\_code}: \37$\\{print\_esc}(\.{"brokenpenalty"})$;\6
\4\\{bin\_op\_penalty\_code}: \37$\\{print\_esc}(\.{"binoppenalty"})$;\6
\4\\{rel\_penalty\_code}: \37$\\{print\_esc}(\.{"relpenalty"})$;\6
\4\\{pre\_display\_penalty\_code}: \37$\\{print\_esc}(%
\.{"predisplaypenalty"})$;\6
\4\\{post\_display\_penalty\_code}: \37$\\{print\_esc}(%
\.{"postdisplaypenalty"})$;\6
\4\\{inter\_line\_penalty\_code}: \37$\\{print\_esc}(\.{"interlinepenalty"})$;\6
\4\\{double\_hyphen\_demerits\_code}: \37$\\{print\_esc}(%
\.{"doublehyphendemerits"})$;\6
\4\\{final\_hyphen\_demerits\_code}: \37$\\{print\_esc}(%
\.{"finalhyphendemerits"})$;\6
\4\\{adj\_demerits\_code}: \37$\\{print\_esc}(\.{"adjdemerits"})$;\6
\4\\{mag\_code}: \37$\\{print\_esc}(\.{"mag"})$;\6
\4\\{delimiter\_factor\_code}: \37$\\{print\_esc}(\.{"delimiterfactor"})$;\6
\4\\{looseness\_code}: \37$\\{print\_esc}(\.{"looseness"})$;\6
\4\\{time\_code}: \37$\\{print\_esc}(\.{"time"})$;\6
\4\\{day\_code}: \37$\\{print\_esc}(\.{"day"})$;\6
\4\\{month\_code}: \37$\\{print\_esc}(\.{"month"})$;\6
\4\\{year\_code}: \37$\\{print\_esc}(\.{"year"})$;\6
\4\\{show\_box\_breadth\_code}: \37$\\{print\_esc}(\.{"showboxbreadth"})$;\6
\4\\{show\_box\_depth\_code}: \37$\\{print\_esc}(\.{"showboxdepth"})$;\6
\4\\{hbadness\_code}: \37$\\{print\_esc}(\.{"hbadness"})$;\6
\4\\{vbadness\_code}: \37$\\{print\_esc}(\.{"vbadness"})$;\6
\4\\{pausing\_code}: \37$\\{print\_esc}(\.{"pausing"})$;\6
\4\\{tracing\_online\_code}: \37$\\{print\_esc}(\.{"tracingonline"})$;\6
\4\\{tracing\_macros\_code}: \37$\\{print\_esc}(\.{"tracingmacros"})$;\6
\4\\{tracing\_stats\_code}: \37$\\{print\_esc}(\.{"tracingstats"})$;\6
\4\\{tracing\_paragraphs\_code}: \37$\\{print\_esc}(\.{"tracingparagraphs"})$;\6
\4\\{tracing\_pages\_code}: \37$\\{print\_esc}(\.{"tracingpages"})$;\6
\4\\{tracing\_output\_code}: \37$\\{print\_esc}(\.{"tracingoutput"})$;\6
\4\\{tracing\_lost\_chars\_code}: \37$\\{print\_esc}(\.{"tracinglostchars"})$;\6
\4\\{tracing\_commands\_code}: \37$\\{print\_esc}(\.{"tracingcommands"})$;\6
\4\\{tracing\_restores\_code}: \37$\\{print\_esc}(\.{"tracingrestores"})$;\6
\4\\{uc\_hyph\_code}: \37$\\{print\_esc}(\.{"uchyph"})$;\6
\4\\{output\_penalty\_code}: \37$\\{print\_esc}(\.{"outputpenalty"})$;\6
\4\\{max\_dead\_cycles\_code}: \37$\\{print\_esc}(\.{"maxdeadcycles"})$;\6
\4\\{hang\_after\_code}: \37$\\{print\_esc}(\.{"hangafter"})$;\6
\4\\{floating\_penalty\_code}: \37$\\{print\_esc}(\.{"floatingpenalty"})$;\6
\4\\{global\_defs\_code}: \37$\\{print\_esc}(\.{"globaldefs"})$;\6
\4\\{cur\_fam\_code}: \37$\\{print\_esc}(\.{"fam"})$;\6
\4\\{escape\_char\_code}: \37$\\{print\_esc}(\.{"escapechar"})$;\6
\4\\{default\_hyphen\_char\_code}: \37$\\{print\_esc}(%
\.{"defaulthyphenchar"})$;\6
\4\\{default\_skew\_char\_code}: \37$\\{print\_esc}(\.{"defaultskewchar"})$;\6
\4\\{end\_line\_char\_code}: \37$\\{print\_esc}(\.{"endlinechar"})$;\6
\4\\{new\_line\_char\_code}: \37$\\{print\_esc}(\.{"newlinechar"})$;\6
\4\\{language\_code}: \37$\\{print\_esc}(\.{"language"})$;\6
\4\\{left\_hyphen\_min\_code}: \37$\\{print\_esc}(\.{"lefthyphenmin"})$;\6
\4\\{right\_hyphen\_min\_code}: \37$\\{print\_esc}(\.{"righthyphenmin"})$;\6
\4\\{holding\_inserts\_code}: \37$\\{print\_esc}(\.{"holdinginserts"})$;\6
\4\\{error\_context\_lines\_code}: \37$\\{print\_esc}(%
\.{"errorcontextlines"})$;\7
\4\\{pdf\_output\_code}: \37$\\{print\_esc}(\.{"pdfoutput"})$;\6
\4\\{pdf\_compress\_level\_code}: \37$\\{print\_esc}(\.{"pdfcompresslevel"})$;\6
\4\\{pdf\_objcompresslevel\_code}: \37$\\{print\_esc}(%
\.{"pdfobjcompresslevel"})$;\6
\4\\{pdf\_decimal\_digits\_code}: \37$\\{print\_esc}(\.{"pdfdecimaldigits"})$;\6
\4\\{pdf\_move\_chars\_code}: \37$\\{print\_esc}(\.{"pdfmovechars"})$;\6
\4\\{pdf\_image\_resolution\_code}: \37$\\{print\_esc}(%
\.{"pdfimageresolution"})$;\6
\4\\{pdf\_pk\_resolution\_code}: \37$\\{print\_esc}(\.{"pdfpkresolution"})$;\6
\4\\{pdf\_unique\_resname\_code}: \37$\\{print\_esc}(\.{"pdfuniqueresname"})$;\6
\4\\{pdf\_option\_always\_use\_pdfpagebox\_code}: \37$\\{print\_esc}(%
\.{"pdfoptionalwaysusepdfpagebox"})$;\6
\4\\{pdf\_option\_pdf\_inclusion\_errorlevel\_code}: \37$\\{print\_esc}(%
\.{"pdfoptionpdfinclusionerrorlevel"})$;\6
\4\\{pdf\_major\_version\_code}: \37$\\{print\_esc}(\.{"pdfmajorversion"})$;\6
\4\\{pdf\_minor\_version\_code}: \37$\\{print\_esc}(\.{"pdfminorversion"})$;\6
\4\\{pdf\_force\_pagebox\_code}: \37$\\{print\_esc}(\.{"pdfforcepagebox"})$;\6
\4\\{pdf\_pagebox\_code}: \37$\\{print\_esc}(\.{"pdfpagebox"})$;\6
\4\\{pdf\_inclusion\_errorlevel\_code}: \37$\\{print\_esc}(%
\.{"pdfinclusionerrorlevel"})$;\6
\4\\{pdf\_gamma\_code}: \37$\\{print\_esc}(\.{"pdfgamma"})$;\6
\4\\{pdf\_image\_gamma\_code}: \37$\\{print\_esc}(\.{"pdfimagegamma"})$;\6
\4\\{pdf\_image\_hicolor\_code}: \37$\\{print\_esc}(\.{"pdfimagehicolor"})$;\6
\4\\{pdf\_image\_apply\_gamma\_code}: \37$\\{print\_esc}(%
\.{"pdfimageapplygamma"})$;\6
\4\\{pdf\_adjust\_spacing\_code}: \37$\\{print\_esc}(\.{"pdfadjustspacing"})$;\6
\4\\{pdf\_protrude\_chars\_code}: \37$\\{print\_esc}(\.{"pdfprotrudechars"})$;\6
\4\\{pdf\_tracing\_fonts\_code}: \37$\\{print\_esc}(\.{"pdftracingfonts"})$;\6
\4\\{pdf\_adjust\_interword\_glue\_code}: \37$\\{print\_esc}(%
\.{"pdfadjustinterwordglue"})$;\6
\4\\{pdf\_prepend\_kern\_code}: \37$\\{print\_esc}(\.{"pdfprependkern"})$;\6
\4\\{pdf\_append\_kern\_code}: \37$\\{print\_esc}(\.{"pdfappendkern"})$;\6
\4\\{pdf\_gen\_tounicode\_code}: \37$\\{print\_esc}(\.{"pdfgentounicode"})$;\6
\4\\{pdf\_draftmode\_code}: \37$\\{print\_esc}(\.{"pdfdraftmode"})$;\6
\4\\{pdf\_inclusion\_copy\_font\_code}: \37$\\{print\_esc}(%
\.{"pdfinclusioncopyfonts"})$;\6
\4\\{pdf\_suppress\_warning\_dup\_dest\_code}: \37$\\{print\_esc}(%
\.{"pdfsuppresswarningdupdest"})$;\6
\4\\{pdf\_suppress\_warning\_dup\_map\_code}: \37$\\{print\_esc}(%
\.{"pdfsuppresswarningdupmap"})$;\6
\4\\{pdf\_suppress\_warning\_page\_group\_code}: \37$\\{print\_esc}(%
\.{"pdfsuppresswarningpagegroup"})$;\6
\4\\{pdf\_info\_omit\_date\_code}: \37$\\{print\_esc}(\.{"pdfinfoomitdate"})$;\6
\4\\{pdf\_suppress\_ptex\_info\_code}: \37$\\{print\_esc}(%
\.{"pdfsuppressptexinfo"})$;\6
\4\\{pdf\_omit\_charset\_code}: \37$\\{print\_esc}(\.{"pdfomitcharset"})$;\6
\4\\{pdf\_omit\_info\_dict\_code}: \37$\\{print\_esc}(\.{"pdfomitinfodict"})$;\6
\4\\{pdf\_omit\_procset\_code}: \37$\\{print\_esc}(\.{"pdfomitprocset"})$;\6
\4\\{pdf\_ptex\_use\_underscore\_code}: \37$\\{print\_esc}(%
\.{"pdfptexuseunderscore"})$;\6
\X1659:Cases for \\{print\_param}\X\6
\4\&{othercases} \37$\\{print}(\.{"[unknown\ integer\ parameter!]"})$\2\6
\&{endcases};\6
\&{end};\par
\fi

\M256. The integer parameter names must be entered into the hash table.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"pretolerance"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pretolerance\_code})$;\6
$\\{primitive}(\.{"tolerance"},\39\\{assign\_int},\39\\{int\_base}+\\{tolerance%
\_code})$;\6
$\\{primitive}(\.{"linepenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{line%
\_penalty\_code})$;\6
$\\{primitive}(\.{"hyphenpenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{hyphen\_penalty\_code})$;\6
$\\{primitive}(\.{"exhyphenpenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{ex%
\_hyphen\_penalty\_code})$;\6
$\\{primitive}(\.{"clubpenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{club%
\_penalty\_code})$;\6
$\\{primitive}(\.{"widowpenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{widow%
\_penalty\_code})$;\6
$\\{primitive}(\.{"displaywidowpenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{display\_widow\_penalty\_code})$;\6
$\\{primitive}(\.{"brokenpenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{broken\_penalty\_code})$;\6
$\\{primitive}(\.{"binoppenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{bin%
\_op\_penalty\_code})$;\6
$\\{primitive}(\.{"relpenalty"},\39\\{assign\_int},\39\\{int\_base}+\\{rel%
\_penalty\_code})$;\6
$\\{primitive}(\.{"predisplaypenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pre\_display\_penalty\_code})$;\6
$\\{primitive}(\.{"postdisplaypenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{post\_display\_penalty\_code})$;\6
$\\{primitive}(\.{"interlinepenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{inter\_line\_penalty\_code})$;\6
$\\{primitive}(\.{"doublehyphendemerits"},\39\\{assign\_int},\39\\{int\_base}+%
\\{double\_hyphen\_demerits\_code})$;\6
$\\{primitive}(\.{"finalhyphendemerits"},\39\\{assign\_int},\39\\{int\_base}+%
\\{final\_hyphen\_demerits\_code})$;\6
$\\{primitive}(\.{"adjdemerits"},\39\\{assign\_int},\39\\{int\_base}+\\{adj%
\_demerits\_code})$;\6
$\\{primitive}(\.{"mag"},\39\\{assign\_int},\39\\{int\_base}+\\{mag\_code})$;\6
$\\{primitive}(\.{"delimiterfactor"},\39\\{assign\_int},\39\\{int\_base}+%
\\{delimiter\_factor\_code})$;\6
$\\{primitive}(\.{"looseness"},\39\\{assign\_int},\39\\{int\_base}+\\{looseness%
\_code})$;\6
$\\{primitive}(\.{"time"},\39\\{assign\_int},\39\\{int\_base}+\\{time\_code})$;%
\6
$\\{primitive}(\.{"day"},\39\\{assign\_int},\39\\{int\_base}+\\{day\_code})$;\6
$\\{primitive}(\.{"month"},\39\\{assign\_int},\39\\{int\_base}+\\{month%
\_code})$;\6
$\\{primitive}(\.{"year"},\39\\{assign\_int},\39\\{int\_base}+\\{year\_code})$;%
\6
$\\{primitive}(\.{"showboxbreadth"},\39\\{assign\_int},\39\\{int\_base}+\\{show%
\_box\_breadth\_code})$;\6
$\\{primitive}(\.{"showboxdepth"},\39\\{assign\_int},\39\\{int\_base}+\\{show%
\_box\_depth\_code})$;\6
$\\{primitive}(\.{"hbadness"},\39\\{assign\_int},\39\\{int\_base}+\\{hbadness%
\_code})$;\6
$\\{primitive}(\.{"vbadness"},\39\\{assign\_int},\39\\{int\_base}+\\{vbadness%
\_code})$;\6
$\\{primitive}(\.{"pausing"},\39\\{assign\_int},\39\\{int\_base}+\\{pausing%
\_code})$;\6
$\\{primitive}(\.{"tracingonline"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_online\_code})$;\6
$\\{primitive}(\.{"tracingmacros"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_macros\_code})$;\6
$\\{primitive}(\.{"tracingstats"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_stats\_code})$;\6
$\\{primitive}(\.{"tracingparagraphs"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_paragraphs\_code})$;\6
$\\{primitive}(\.{"tracingpages"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_pages\_code})$;\6
$\\{primitive}(\.{"tracingoutput"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_output\_code})$;\6
$\\{primitive}(\.{"tracinglostchars"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_lost\_chars\_code})$;\6
$\\{primitive}(\.{"tracingcommands"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_commands\_code})$;\6
$\\{primitive}(\.{"tracingrestores"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_restores\_code})$;\6
$\\{primitive}(\.{"uchyph"},\39\\{assign\_int},\39\\{int\_base}+\\{uc\_hyph%
\_code})$;\6
$\\{primitive}(\.{"outputpenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{output\_penalty\_code})$;\6
$\\{primitive}(\.{"maxdeadcycles"},\39\\{assign\_int},\39\\{int\_base}+\\{max%
\_dead\_cycles\_code})$;\6
$\\{primitive}(\.{"hangafter"},\39\\{assign\_int},\39\\{int\_base}+\\{hang%
\_after\_code})$;\6
$\\{primitive}(\.{"floatingpenalty"},\39\\{assign\_int},\39\\{int\_base}+%
\\{floating\_penalty\_code})$;\6
$\\{primitive}(\.{"globaldefs"},\39\\{assign\_int},\39\\{int\_base}+\\{global%
\_defs\_code})$;\6
$\\{primitive}(\.{"fam"},\39\\{assign\_int},\39\\{int\_base}+\\{cur\_fam%
\_code})$;\6
$\\{primitive}(\.{"escapechar"},\39\\{assign\_int},\39\\{int\_base}+\\{escape%
\_char\_code})$;\6
$\\{primitive}(\.{"defaulthyphenchar"},\39\\{assign\_int},\39\\{int\_base}+%
\\{default\_hyphen\_char\_code})$;\6
$\\{primitive}(\.{"defaultskewchar"},\39\\{assign\_int},\39\\{int\_base}+%
\\{default\_skew\_char\_code})$;\6
$\\{primitive}(\.{"endlinechar"},\39\\{assign\_int},\39\\{int\_base}+\\{end%
\_line\_char\_code})$;\6
$\\{primitive}(\.{"newlinechar"},\39\\{assign\_int},\39\\{int\_base}+\\{new%
\_line\_char\_code})$;\6
$\\{primitive}(\.{"language"},\39\\{assign\_int},\39\\{int\_base}+\\{language%
\_code})$;\6
$\\{primitive}(\.{"lefthyphenmin"},\39\\{assign\_int},\39\\{int\_base}+\\{left%
\_hyphen\_min\_code})$;\6
$\\{primitive}(\.{"righthyphenmin"},\39\\{assign\_int},\39\\{int\_base}+%
\\{right\_hyphen\_min\_code})$;\6
$\\{primitive}(\.{"holdinginserts"},\39\\{assign\_int},\39\\{int\_base}+%
\\{holding\_inserts\_code})$;\6
$\\{primitive}(\.{"errorcontextlines"},\39\\{assign\_int},\39\\{int\_base}+%
\\{error\_context\_lines\_code})$;\6
$\\{primitive}(\.{"pdfoutput"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_output\_code})$;\6
$\\{primitive}(\.{"pdfcompresslevel"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_compress\_level\_code})$;\6
$\\{primitive}(\.{"pdfobjcompresslevel"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_objcompresslevel\_code})$;\6
$\\{primitive}(\.{"pdfdecimaldigits"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_decimal\_digits\_code})$;\6
$\\{primitive}(\.{"pdfmovechars"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_move\_chars\_code})$;\6
$\\{primitive}(\.{"pdfimageresolution"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_image\_resolution\_code})$;\6
$\\{primitive}(\.{"pdfpkresolution"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_pk\_resolution\_code})$;\6
$\\{primitive}(\.{"pdfuniqueresname"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_unique\_resname\_code})$;\6
$\\{primitive}(\.{"pdfoptionpdfminorversion"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_minor\_version\_code})$;\6
$\\{primitive}(\.{"pdfoptionalwaysusepdfpagebox"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_option\_always\_use\_pdfpagebox\_code})$;\6
$\\{primitive}(\.{"pdfoptionpdfinclusionerrorlevel"},\39\\{assign\_int},\39%
\\{int\_base}+\\{pdf\_option\_pdf\_inclusion\_errorlevel\_code})$;\6
$\\{primitive}(\.{"pdfmajorversion"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_major\_version\_code})$;\6
$\\{primitive}(\.{"pdfminorversion"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_minor\_version\_code})$;\6
$\\{primitive}(\.{"pdfforcepagebox"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_force\_pagebox\_code})$;\6
$\\{primitive}(\.{"pdfpagebox"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_pagebox\_code})$;\6
$\\{primitive}(\.{"pdfinclusionerrorlevel"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_inclusion\_errorlevel\_code})$;\6
$\\{primitive}(\.{"pdfgamma"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf\_gamma%
\_code})$;\6
$\\{primitive}(\.{"pdfimagegamma"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_image\_gamma\_code})$;\6
$\\{primitive}(\.{"pdfimagehicolor"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_image\_hicolor\_code})$;\6
$\\{primitive}(\.{"pdfimageapplygamma"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_image\_apply\_gamma\_code})$;\6
$\\{primitive}(\.{"pdfadjustspacing"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_adjust\_spacing\_code})$;\6
$\\{primitive}(\.{"pdfprotrudechars"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_protrude\_chars\_code})$;\6
$\\{primitive}(\.{"pdftracingfonts"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_tracing\_fonts\_code})$;\6
$\\{primitive}(\.{"pdfadjustinterwordglue"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_adjust\_interword\_glue\_code})$;\6
$\\{primitive}(\.{"pdfprependkern"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_prepend\_kern\_code})$;\6
$\\{primitive}(\.{"pdfappendkern"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_append\_kern\_code})$;\6
$\\{primitive}(\.{"pdfgentounicode"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_gen\_tounicode\_code})$;\6
$\\{primitive}(\.{"pdfdraftmode"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_draftmode\_code})$;\6
$\\{primitive}(\.{"pdfinclusioncopyfonts"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_inclusion\_copy\_font\_code})$;\6
$\\{primitive}(\.{"pdfsuppresswarningdupdest"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_suppress\_warning\_dup\_dest\_code})$;\6
$\\{primitive}(\.{"pdfsuppresswarningdupmap"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_suppress\_warning\_dup\_map\_code})$;\6
$\\{primitive}(\.{"pdfsuppresswarningpagegroup"},\39\\{assign\_int},\39\\{int%
\_base}+\\{pdf\_suppress\_warning\_page\_group\_code})$;\6
$\\{primitive}(\.{"pdfinfoomitdate"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_info\_omit\_date\_code})$;\6
$\\{primitive}(\.{"pdfsuppressptexinfo"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_suppress\_ptex\_info\_code})$;\6
$\\{primitive}(\.{"pdfomitcharset"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_omit\_charset\_code})$;\6
$\\{primitive}(\.{"pdfomitinfodict"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_omit\_info\_dict\_code})$;\6
$\\{primitive}(\.{"pdfomitprocset"},\39\\{assign\_int},\39\\{int\_base}+\\{pdf%
\_omit\_procset\_code})$;\6
$\\{primitive}(\.{"pdfptexuseunderscore"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pdf\_ptex\_use\_underscore\_code})$;\par
\fi

\M257. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{assign\_int}: \37\&{if} $\\{chr\_code}<\\{count\_base}$ \1\&{then}\5
$\\{print\_param}(\\{chr\_code}-\\{int\_base})$\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"count"})$;\5
$\\{print\_int}(\\{chr\_code}-\\{count\_base})$;\6
\&{end};\2\par
\fi

\M258. The integer parameters should really be initialized by a macro package;
the following initialization does the minimum to keep \TeX\ from
complete failure.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
\&{for} $\|k\K\\{int\_base}\mathrel{\&{to}}\\{del\_code\_base}-1$ \1\&{do}\5
$\\{eqtb}[\|k].\\{int}\K0$;\2\6
$\\{mag}\K1000$;\5
$\\{tolerance}\K10000$;\5
$\\{hang\_after}\K1$;\5
$\\{max\_dead\_cycles}\K25$;\5
$\\{escape\_char}\K\.{"\\"}$;\5
$\\{end\_line\_char}\K\\{carriage\_return}$;\6
\&{for} $\|k\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{del\_code}(\|k)\K-1$;\2\6
$\\{del\_code}(\.{"."})\K0$;\C{this null delimiter is used in error recovery}%
\par
\fi

\M259. The following procedure, which is called just before \TeX\ initializes
its
input and output, establishes the initial values of the date and time.
Since standard \PASCAL\ cannot provide such information, something special
is needed. The program here simply assumes that suitable values appear in
the global variables \\{sys\_time}, \\{sys\_day}, \\{sys\_month}, and
\\{sys\_year} (which are initialized to noon on 4 July 1776,
in case the implementor is careless).

\Y\P\4\&{procedure}\1\  \37\\{fix\_date\_and\_time};\2\6
\&{begin} \37$\\{sys\_time}\K12\ast60$;\5
$\\{sys\_day}\K4$;\5
$\\{sys\_month}\K7$;\5
$\\{sys\_year}\K1776$;\C{self-evident truths}\6
$\\{time}\K\\{sys\_time}$;\C{minutes since midnight}\6
$\\{day}\K\\{sys\_day}$;\C{day of the month}\6
$\\{month}\K\\{sys\_month}$;\C{month of the year}\6
$\\{year}\K\\{sys\_year}$;\C{Anno Domini}\6
\&{end};\par
\fi

\M260. \P$\X260:Show equivalent \|n, in region 5\X\S$\6
\&{begin} \37\&{if} $\|n<\\{count\_base}$ \1\&{then}\5
$\\{print\_param}(\|n-\\{int\_base})$\6
\4\&{else} \&{if} $\|n<\\{del\_code\_base}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"count"})$;\5
$\\{print\_int}(\|n-\\{count\_base})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"delcode"})$;\5
$\\{print\_int}(\|n-\\{del\_code\_base})$;\6
\&{end};\2\2\6
$\\{print\_char}(\.{"="})$;\5
$\\{print\_int}(\\{eqtb}[\|n].\\{int})$;\6
\&{end}\par
\U270.\fi

\M261. \P$\X261:Set variable \|c to the current escape character\X\S$\6
$\|c\K\\{escape\_char}$\par
\U63.\fi

\M262. \P$\X262:Character \|s is the current new-line character\X\S$\6
$\|s=\\{new\_line\_char}$\par
\Us58\ET59.\fi

\M263. \TeX\ is occasionally supposed to print diagnostic information that
goes only into the transcript file, unless \\{tracing\_online} is positive.
Here are two routines that adjust the destination of print commands:

\Y\P\4\&{procedure}\1\  \37\\{begin\_diagnostic};\C{prepare to do some tracing}%
\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\6
\&{if} $(\\{tracing\_online}\L0)\W(\\{selector}=\\{term\_and\_log})$ \1\&{then}%
\6
\&{begin} \37$\\{decr}(\\{selector})$;\6
\&{if} $\\{history}=\\{spotless}$ \1\&{then}\5
$\\{history}\K\\{warning\_issued}$;\2\6
\&{end};\2\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{end\_diagnostic}(\\{blank\_line}:\\{boolean})$;%
\C{restore proper conditions after tracing}\2\6
\&{begin} \37$\\{print\_nl}(\.{""})$;\6
\&{if} $\\{blank\_line}$ \1\&{then}\5
\\{print\_ln};\2\6
$\\{selector}\K\\{old\_setting}$;\6
\&{end};\par
\fi

\M264. Of course we had better declare a few more global variables, if the
previous
routines are going to work.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{old\_setting}: \37$0\to\\{max\_selector}$;\6
\4$\\{sys\_time},\39\\{sys\_day},\39\\{sys\_month},\39\\{sys\_year}$: \37%
\\{integer};\C{date and time supplied by external system}\par
\fi

\M265. The final region of \\{eqtb} contains the dimension parameters defined
here, and the 256 \.{\\dimen} registers.

\Y\P\D \37$\\{par\_indent\_code}=0$\C{indentation of paragraphs}\par
\P\D \37$\\{math\_surround\_code}=1$\C{space around math in text}\par
\P\D \37$\\{line\_skip\_limit\_code}=2$\C{threshold for \\{line\_skip} instead
of \\{baseline\_skip}}\par
\P\D \37$\\{hsize\_code}=3$\C{line width in horizontal mode}\par
\P\D \37$\\{vsize\_code}=4$\C{page height in vertical mode}\par
\P\D \37$\\{max\_depth\_code}=5$\C{maximum depth of boxes on main pages}\par
\P\D \37$\\{split\_max\_depth\_code}=6$\C{maximum depth of boxes on split
pages}\par
\P\D \37$\\{box\_max\_depth\_code}=7$\C{maximum depth of explicit vboxes}\par
\P\D \37$\\{hfuzz\_code}=8$\C{tolerance for overfull hbox messages}\par
\P\D \37$\\{vfuzz\_code}=9$\C{tolerance for overfull vbox messages}\par
\P\D \37$\\{delimiter\_shortfall\_code}=10$\C{maximum amount uncovered by
variable delimiters}\par
\P\D \37$\\{null\_delimiter\_space\_code}=11$\C{blank space in null delimiters}%
\par
\P\D \37$\\{script\_space\_code}=12$\C{extra space after subscript or
superscript}\par
\P\D \37$\\{pre\_display\_size\_code}=13$\C{length of text preceding a display}%
\par
\P\D \37$\\{display\_width\_code}=14$\C{length of line for displayed equation}%
\par
\P\D \37$\\{display\_indent\_code}=15$\C{indentation of line for displayed
equation}\par
\P\D \37$\\{overfull\_rule\_code}=16$\C{width of rule that identifies overfull
hboxes}\par
\P\D \37$\\{hang\_indent\_code}=17$\C{amount of hanging indentation}\par
\P\D \37$\\{h\_offset\_code}=18$\C{amount of horizontal offset when shipping
pages out}\par
\P\D \37$\\{v\_offset\_code}=19$\C{amount of vertical offset when shipping
pages out}\par
\P\D \37$\\{emergency\_stretch\_code}=20$\C{reduces badnesses on final pass of
line-breaking}\par
\P\D \37$\\{pdftex\_first\_dimen\_code}=21$\C{first number defined in this
section}\par
\P\D \37$\\{pdf\_h\_origin\_code}=\\{pdftex\_first\_dimen\_code}+0$\C{horigin
of the PDF output}\par
\P\D \37$\\{pdf\_v\_origin\_code}=\\{pdftex\_first\_dimen\_code}+1$\C{vorigin
of the PDF output}\par
\P\D \37$\\{pdf\_page\_width\_code}=\\{pdftex\_first\_dimen\_code}+2$\C{page
width of the PDF output}\par
\P\D \37$\\{pdf\_page\_height\_code}=\\{pdftex\_first\_dimen\_code}+3$\C{page
height of the PDF output}\par
\P\D \37$\\{pdf\_link\_margin\_code}=\\{pdftex\_first\_dimen\_code}+4$\C{link
margin in the PDF output}\par
\P\D \37$\\{pdf\_dest\_margin\_code}=\\{pdftex\_first\_dimen\_code}+5$\C{dest
margin in the PDF output}\par
\P\D \37$\\{pdf\_thread\_margin\_code}=\\{pdftex\_first\_dimen\_code}+6$%
\C{thread margin in the PDF output}\par
\P\D \37$\\{pdf\_first\_line\_height\_code}=\\{pdftex\_first\_dimen\_code}+7$%
\par
\P\D \37$\\{pdf\_last\_line\_depth\_code}=\\{pdftex\_first\_dimen\_code}+8$\par
\P\D \37$\\{pdf\_each\_line\_height\_code}=\\{pdftex\_first\_dimen\_code}+9$\par
\P\D \37$\\{pdf\_each\_line\_depth\_code}=\\{pdftex\_first\_dimen\_code}+10$\par
\P\D \37$\\{pdf\_ignored\_dimen\_code}=\\{pdftex\_first\_dimen\_code}+11$\par
\P\D \37$\\{pdf\_px\_dimen\_code}=\\{pdftex\_first\_dimen\_code}+12$\par
\P\D \37$\\{pdftex\_last\_dimen\_code}=\\{pdftex\_first\_dimen\_code}+12$%
\C{last number defined in this section}\par
\P\D \37$\\{dimen\_pars}=\\{pdftex\_last\_dimen\_code}+1$\C{total number of
dimension parameters}\par
\P\D \37$\\{scaled\_base}=\\{dimen\_base}+\\{dimen\_pars}$\C{table of 256
user-defined \.{\\dimen} registers}\par
\P\D \37$\\{eqtb\_size}=\\{scaled\_base}+255$\C{largest subscript of \\{eqtb}}%
\Y\par
\P\D \37$\\{dimen}(\#)\S\\{eqtb}[\\{scaled\_base}+\#].\\{sc}$\par
\P\D \37$\\{dimen\_par}(\#)\S\\{eqtb}[\\{dimen\_base}+\#].\\{sc}$\C{a scaled
quantity}\par
\P\D \37$\\{par\_indent}\S\\{dimen\_par}(\\{par\_indent\_code})$\par
\P\D \37$\\{math\_surround}\S\\{dimen\_par}(\\{math\_surround\_code})$\par
\P\D \37$\\{line\_skip\_limit}\S\\{dimen\_par}(\\{line\_skip\_limit\_code})$\par
\P\D \37$\\{hsize}\S\\{dimen\_par}(\\{hsize\_code})$\par
\P\D \37$\\{vsize}\S\\{dimen\_par}(\\{vsize\_code})$\par
\P\D \37$\\{max\_depth}\S\\{dimen\_par}(\\{max\_depth\_code})$\par
\P\D \37$\\{split\_max\_depth}\S\\{dimen\_par}(\\{split\_max\_depth\_code})$\par
\P\D \37$\\{box\_max\_depth}\S\\{dimen\_par}(\\{box\_max\_depth\_code})$\par
\P\D \37$\\{hfuzz}\S\\{dimen\_par}(\\{hfuzz\_code})$\par
\P\D \37$\\{vfuzz}\S\\{dimen\_par}(\\{vfuzz\_code})$\par
\P\D \37$\\{delimiter\_shortfall}\S\\{dimen\_par}(\\{delimiter\_shortfall%
\_code})$\par
\P\D \37$\\{null\_delimiter\_space}\S\\{dimen\_par}(\\{null\_delimiter\_space%
\_code})$\par
\P\D \37$\\{script\_space}\S\\{dimen\_par}(\\{script\_space\_code})$\par
\P\D \37$\\{pre\_display\_size}\S\\{dimen\_par}(\\{pre\_display\_size\_code})$%
\par
\P\D \37$\\{display\_width}\S\\{dimen\_par}(\\{display\_width\_code})$\par
\P\D \37$\\{display\_indent}\S\\{dimen\_par}(\\{display\_indent\_code})$\par
\P\D \37$\\{overfull\_rule}\S\\{dimen\_par}(\\{overfull\_rule\_code})$\par
\P\D \37$\\{hang\_indent}\S\\{dimen\_par}(\\{hang\_indent\_code})$\par
\P\D \37$\\{h\_offset}\S\\{dimen\_par}(\\{h\_offset\_code})$\par
\P\D \37$\\{v\_offset}\S\\{dimen\_par}(\\{v\_offset\_code})$\par
\P\D \37$\\{emergency\_stretch}\S\\{dimen\_par}(\\{emergency\_stretch\_code})$%
\par
\P\D \37$\\{pdf\_h\_origin}\S\\{dimen\_par}(\\{pdf\_h\_origin\_code})$\par
\P\D \37$\\{pdf\_v\_origin}\S\\{dimen\_par}(\\{pdf\_v\_origin\_code})$\par
\P\D \37$\\{pdf\_page\_width}\S\\{dimen\_par}(\\{pdf\_page\_width\_code})$\par
\P\D \37$\\{pdf\_page\_height}\S\\{dimen\_par}(\\{pdf\_page\_height\_code})$\par
\P\D \37$\\{pdf\_link\_margin}\S\\{dimen\_par}(\\{pdf\_link\_margin\_code})$\par
\P\D \37$\\{pdf\_dest\_margin}\S\\{dimen\_par}(\\{pdf\_dest\_margin\_code})$\par
\P\D \37$\\{pdf\_thread\_margin}\S\\{dimen\_par}(\\{pdf\_thread\_margin%
\_code})$\par
\P\D \37$\\{pdf\_first\_line\_height}\S\\{dimen\_par}(\\{pdf\_first\_line%
\_height\_code})$\par
\P\D \37$\\{pdf\_last\_line\_depth}\S\\{dimen\_par}(\\{pdf\_last\_line\_depth%
\_code})$\par
\P\D \37$\\{pdf\_each\_line\_height}\S\\{dimen\_par}(\\{pdf\_each\_line\_height%
\_code})$\par
\P\D \37$\\{pdf\_each\_line\_depth}\S\\{dimen\_par}(\\{pdf\_each\_line\_depth%
\_code})$\par
\P\D \37$\\{pdf\_ignored\_dimen}\S\\{dimen\_par}(\\{pdf\_ignored\_dimen%
\_code})$\par
\P\D \37$\\{pdf\_px\_dimen}\S\\{dimen\_par}(\\{pdf\_px\_dimen\_code})$\par
\Y\P\4\&{procedure}\1\  \37$\\{print\_length\_param}(\|n:\\{integer})$;\2\6
\&{begin} \37\&{case} $\|n$ \1\&{of}\6
\4\\{par\_indent\_code}: \37$\\{print\_esc}(\.{"parindent"})$;\6
\4\\{math\_surround\_code}: \37$\\{print\_esc}(\.{"mathsurround"})$;\6
\4\\{line\_skip\_limit\_code}: \37$\\{print\_esc}(\.{"lineskiplimit"})$;\6
\4\\{hsize\_code}: \37$\\{print\_esc}(\.{"hsize"})$;\6
\4\\{vsize\_code}: \37$\\{print\_esc}(\.{"vsize"})$;\6
\4\\{max\_depth\_code}: \37$\\{print\_esc}(\.{"maxdepth"})$;\6
\4\\{split\_max\_depth\_code}: \37$\\{print\_esc}(\.{"splitmaxdepth"})$;\6
\4\\{box\_max\_depth\_code}: \37$\\{print\_esc}(\.{"boxmaxdepth"})$;\6
\4\\{hfuzz\_code}: \37$\\{print\_esc}(\.{"hfuzz"})$;\6
\4\\{vfuzz\_code}: \37$\\{print\_esc}(\.{"vfuzz"})$;\6
\4\\{delimiter\_shortfall\_code}: \37$\\{print\_esc}(%
\.{"delimitershortfall"})$;\6
\4\\{null\_delimiter\_space\_code}: \37$\\{print\_esc}(%
\.{"nulldelimiterspace"})$;\6
\4\\{script\_space\_code}: \37$\\{print\_esc}(\.{"scriptspace"})$;\6
\4\\{pre\_display\_size\_code}: \37$\\{print\_esc}(\.{"predisplaysize"})$;\6
\4\\{display\_width\_code}: \37$\\{print\_esc}(\.{"displaywidth"})$;\6
\4\\{display\_indent\_code}: \37$\\{print\_esc}(\.{"displayindent"})$;\6
\4\\{overfull\_rule\_code}: \37$\\{print\_esc}(\.{"overfullrule"})$;\6
\4\\{hang\_indent\_code}: \37$\\{print\_esc}(\.{"hangindent"})$;\6
\4\\{h\_offset\_code}: \37$\\{print\_esc}(\.{"hoffset"})$;\6
\4\\{v\_offset\_code}: \37$\\{print\_esc}(\.{"voffset"})$;\6
\4\\{emergency\_stretch\_code}: \37$\\{print\_esc}(\.{"emergencystretch"})$;\6
\4\\{pdf\_h\_origin\_code}: \37$\\{print\_esc}(\.{"pdfhorigin"})$;\6
\4\\{pdf\_v\_origin\_code}: \37$\\{print\_esc}(\.{"pdfvorigin"})$;\6
\4\\{pdf\_page\_width\_code}: \37$\\{print\_esc}(\.{"pdfpagewidth"})$;\6
\4\\{pdf\_page\_height\_code}: \37$\\{print\_esc}(\.{"pdfpageheight"})$;\6
\4\\{pdf\_link\_margin\_code}: \37$\\{print\_esc}(\.{"pdflinkmargin"})$;\6
\4\\{pdf\_dest\_margin\_code}: \37$\\{print\_esc}(\.{"pdfdestmargin"})$;\6
\4\\{pdf\_thread\_margin\_code}: \37$\\{print\_esc}(\.{"pdfthreadmargin"})$;\6
\4\\{pdf\_first\_line\_height\_code}: \37$\\{print\_esc}(%
\.{"pdffirstlineheight"})$;\6
\4\\{pdf\_last\_line\_depth\_code}: \37$\\{print\_esc}(%
\.{"pdflastlinedepth"})$;\6
\4\\{pdf\_each\_line\_height\_code}: \37$\\{print\_esc}(%
\.{"pdfeachlineheight"})$;\6
\4\\{pdf\_each\_line\_depth\_code}: \37$\\{print\_esc}(%
\.{"pdfeachlinedepth"})$;\6
\4\\{pdf\_ignored\_dimen\_code}: \37$\\{print\_esc}(\.{"pdfignoreddimen"})$;\6
\4\\{pdf\_px\_dimen\_code}: \37$\\{print\_esc}(\.{"pdfpxdimen"})$;\6
\4\&{othercases} \37$\\{print}(\.{"[unknown\ dimen\ parameter!]"})$\2\6
\&{endcases};\6
\&{end};\par
\fi

\M266. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"parindent"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{par%
\_indent\_code})$;\6
$\\{primitive}(\.{"mathsurround"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{math\_surround\_code})$;\6
$\\{primitive}(\.{"lineskiplimit"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{line\_skip\_limit\_code})$;\6
$\\{primitive}(\.{"hsize"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{hsize%
\_code})$;\6
$\\{primitive}(\.{"vsize"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{vsize%
\_code})$;\6
$\\{primitive}(\.{"maxdepth"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{max%
\_depth\_code})$;\6
$\\{primitive}(\.{"splitmaxdepth"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{split\_max\_depth\_code})$;\6
$\\{primitive}(\.{"boxmaxdepth"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{box%
\_max\_depth\_code})$;\6
$\\{primitive}(\.{"hfuzz"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{hfuzz%
\_code})$;\6
$\\{primitive}(\.{"vfuzz"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{vfuzz%
\_code})$;\6
$\\{primitive}(\.{"delimitershortfall"},\39\\{assign\_dimen},\39\\{dimen%
\_base}+\\{delimiter\_shortfall\_code})$;\6
$\\{primitive}(\.{"nulldelimiterspace"},\39\\{assign\_dimen},\39\\{dimen%
\_base}+\\{null\_delimiter\_space\_code})$;\6
$\\{primitive}(\.{"scriptspace"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{script\_space\_code})$;\6
$\\{primitive}(\.{"predisplaysize"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pre\_display\_size\_code})$;\6
$\\{primitive}(\.{"displaywidth"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{display\_width\_code})$;\6
$\\{primitive}(\.{"displayindent"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{display\_indent\_code})$;\6
$\\{primitive}(\.{"overfullrule"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{overfull\_rule\_code})$;\6
$\\{primitive}(\.{"hangindent"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{hang%
\_indent\_code})$;\6
$\\{primitive}(\.{"hoffset"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{h%
\_offset\_code})$;\6
$\\{primitive}(\.{"voffset"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{v%
\_offset\_code})$;\6
$\\{primitive}(\.{"emergencystretch"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{emergency\_stretch\_code})$;\6
$\\{primitive}(\.{"pdfhorigin"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{pdf%
\_h\_origin\_code})$;\6
$\\{primitive}(\.{"pdfvorigin"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{pdf%
\_v\_origin\_code})$;\6
$\\{primitive}(\.{"pdfpagewidth"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_page\_width\_code})$;\6
$\\{primitive}(\.{"pdfpageheight"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_page\_height\_code})$;\6
$\\{primitive}(\.{"pdflinkmargin"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_link\_margin\_code})$;\6
$\\{primitive}(\.{"pdfdestmargin"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_dest\_margin\_code})$;\6
$\\{primitive}(\.{"pdfthreadmargin"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_thread\_margin\_code})$;\6
$\\{primitive}(\.{"pdffirstlineheight"},\39\\{assign\_dimen},\39\\{dimen%
\_base}+\\{pdf\_first\_line\_height\_code})$;\6
$\\{primitive}(\.{"pdflastlinedepth"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_last\_line\_depth\_code})$;\6
$\\{primitive}(\.{"pdfeachlineheight"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_each\_line\_height\_code})$;\6
$\\{primitive}(\.{"pdfeachlinedepth"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_each\_line\_depth\_code})$;\6
$\\{primitive}(\.{"pdfignoreddimen"},\39\\{assign\_dimen},\39\\{dimen\_base}+%
\\{pdf\_ignored\_dimen\_code})$;\6
$\\{primitive}(\.{"pdfpxdimen"},\39\\{assign\_dimen},\39\\{dimen\_base}+\\{pdf%
\_px\_dimen\_code})$;\par
\fi

\M267. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{assign\_dimen}: \37\&{if} $\\{chr\_code}<\\{scaled\_base}$ \1\&{then}\5
$\\{print\_length\_param}(\\{chr\_code}-\\{dimen\_base})$\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"dimen"})$;\5
$\\{print\_int}(\\{chr\_code}-\\{scaled\_base})$;\6
\&{end};\2\par
\fi

\M268. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}%
\S$\6
\&{for} $\|k\K\\{dimen\_base}\mathrel{\&{to}}\\{eqtb\_size}$ \1\&{do}\5
$\\{eqtb}[\|k].\\{sc}\K0$;\2\par
\fi

\M269. \P$\X269:Show equivalent \|n, in region 6\X\S$\6
\&{begin} \37\&{if} $\|n<\\{scaled\_base}$ \1\&{then}\5
$\\{print\_length\_param}(\|n-\\{dimen\_base})$\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"dimen"})$;\5
$\\{print\_int}(\|n-\\{scaled\_base})$;\6
\&{end};\2\6
$\\{print\_char}(\.{"="})$;\5
$\\{print\_scaled}(\\{eqtb}[\|n].\\{sc})$;\5
$\\{print}(\.{"pt"})$;\6
\&{end}\par
\U270.\fi

\M270. Here is a procedure that displays the contents of $\\{eqtb}[\|n]$
symbolically.

\Y\P\hbox{\4}\X320:Declare the procedure called \\{print\_cmd\_chr}\X\6
\&{stat} \37\&{procedure}\1\  \37$\\{show\_eqtb}(\|n:\\{pointer})$;\2\6
\&{begin} \37\&{if} $\|n<\\{active\_base}$ \1\&{then}\5
$\\{print\_char}(\.{"?"})$\C{this can't happen}\6
\4\&{else} \&{if} $\|n<\\{glue\_base}$ \1\&{then}\5
\X241:Show equivalent \|n, in region 1 or 2\X\6
\4\&{else} \&{if} $\|n<\\{local\_base}$ \1\&{then}\5
\X247:Show equivalent \|n, in region 3\X\6
\4\&{else} \&{if} $\|n<\\{int\_base}$ \1\&{then}\5
\X251:Show equivalent \|n, in region 4\X\6
\4\&{else} \&{if} $\|n<\\{dimen\_base}$ \1\&{then}\5
\X260:Show equivalent \|n, in region 5\X\6
\4\&{else} \&{if} $\|n\L\\{eqtb\_size}$ \1\&{then}\5
\X269:Show equivalent \|n, in region 6\X\6
\4\&{else} $\\{print\_char}(\.{"?"})$;\C{this can't happen either}\2\2\2\2\2\2\6
\&{end};\6
\&{tats}\par
\fi

\M271. The last two regions of \\{eqtb} have fullword values instead of the
three fields \\{eq\_level}, \\{eq\_type}, and \\{equiv}. An \\{eq\_type} is
unnecessary,
but \TeX\ needs to store the \\{eq\_level} information in another array
called \\{xeq\_level}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{eqtb}: \37\&{array} $[\\{active\_base}\to\\{eqtb\_size}]$ \1\&{of}\5
\\{memory\_word};\2\6
\4\\{xeq\_level}: \37\&{array} $[\\{int\_base}\to\\{eqtb\_size}]$ \1\&{of}\5
\\{quarterword};\2\par
\fi

\M272. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|k\K\\{int\_base}\mathrel{\&{to}}\\{eqtb\_size}$ \1\&{do}\5
$\\{xeq\_level}[\|k]\K\\{level\_one}$;\2\par
\fi

\M273. When the debugging routine \\{search\_mem} is looking for pointers
having a
given value, it is interested only in regions 1 to~3 of~\\{eqtb}, and in the
first part of region~4.

\Y\P$\4\X273:Search \\{eqtb} for equivalents equal to \|p\X\S$\6
\&{for} $\|q\K\\{active\_base}\mathrel{\&{to}}\\{box\_base}+255$ \1\&{do}\6
\&{begin} \37\&{if} $\\{equiv}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"EQUIV("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{end}\2\par
\U190.\fi

\N274.  \[18] The hash table.
Control sequences are stored and retrieved by means of a fairly standard hash
table algorithm called the method of ``coalescing lists'' (cf.\ Algorithm 6.4C
in {\sl The Art of Computer Programming\/}). Once a control sequence enters the
table, it is never removed, because there are complicated situations
involving \.{\\gdef} where the removal of a control sequence at the end of
a group would be a mistake preventable only by the introduction of a
complicated reference-count mechanism.

The actual sequence of letters forming a control sequence identifier is
stored in the \\{str\_pool} array together with all the other strings. An
auxiliary array \\{hash} consists of items with two halfword fields per
word. The first of these, called $\\{next}(\|p)$, points to the next identifier
belonging to the same coalesced list as the identifier corresponding to~\|p;
and the other, called $\\{text}(\|p)$, points to the \\{str\_start} entry for
\|p's identifier. If position~\|p of the hash table is empty, we have
$\\{text}(\|p)=0$; if position \|p is either empty or the end of a coalesced
hash list, we have $\\{next}(\|p)=0$. An auxiliary pointer variable called
\\{hash\_used} is maintained in such a way that all locations $\|p\G\\{hash%
\_used}$
are nonempty. The global variable \\{cs\_count} tells how many multiletter
control sequences have been defined, if statistics are being kept.

A global boolean variable called \\{no\_new\_control\_sequence} is set to
\\{true} during the time that new hash table entries are forbidden.

\Y\P\D \37$\\{next}(\#)\S\\{hash}[\#].\\{lh}$\C{link for coalesced lists}\par
\P\D \37$\\{text}(\#)\S\\{hash}[\#].\\{rh}$\C{string number for control
sequence name}\par
\P\D \37$\\{hash\_is\_full}\S(\\{hash\_used}=\\{hash\_base})$\C{test if all
positions are occupied}\par
\P\D \37$\\{font\_id\_text}(\#)\S\\{text}(\\{font\_id\_base}+\#)$\C{a frozen
font identifier's name}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hash}: \37\&{array} $[\\{hash\_base}\to\\{undefined\_control%
\_sequence}-1]$ \1\&{of}\5
\\{two\_halves};\C{the hash table}\2\6
\4\\{hash\_used}: \37\\{pointer};\C{allocation pointer for \\{hash}}\6
\4\\{no\_new\_control\_sequence}: \37\\{boolean};\C{are new identifiers legal?}%
\6
\4\\{cs\_count}: \37\\{integer};\C{total number of known identifiers}\par
\fi

\M275. Primitive support needs a few extra variables and definitions

\Y\P\D \37$\\{prim\_prime}=1777$\C{about 85\pct! of \\{primitive\_size}}\par
\P\D \37$\\{prim\_base}=1$\par
\P\D \37$\\{prim\_next}(\#)\S\\{prim}[\#].\\{lh}$\C{link for coalesced lists}%
\par
\P\D \37$\\{prim\_text}(\#)\S\\{prim}[\#].\\{rh}$\C{string number for control
sequence name, plus one}\par
\P\D \37$\\{prim\_is\_full}\S(\\{prim\_used}=\\{prim\_base})$\C{test if all
positions are occupied}\par
\P\D \37$\\{prim\_eq\_level\_field}(\#)\S\#.\\{hh}.\\{b1}$\par
\P\D \37$\\{prim\_eq\_type\_field}(\#)\S\#.\\{hh}.\\{b0}$\par
\P\D \37$\\{prim\_equiv\_field}(\#)\S\#.\\{hh}.\\{rh}$\par
\P\D \37$\\{prim\_eq\_level}(\#)\S\\{prim\_eq\_level\_field}(\\{eqtb}[\\{prim%
\_eqtb\_base}+\#])$\C{level of definition}\par
\P\D \37$\\{prim\_eq\_type}(\#)\S\\{prim\_eq\_type\_field}(\\{eqtb}[\\{prim%
\_eqtb\_base}+\#])$\C{command code for equivalent}\par
\P\D \37$\\{prim\_equiv}(\#)\S\\{prim\_equiv\_field}(\\{eqtb}[\\{prim\_eqtb%
\_base}+\#])$\C{equivalent value}\par
\P\D \37$\\{undefined\_primitive}=0$\par
\P\D \37$\\{biggest\_char}=255$\C{ 65535 in XeTeX }\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{prim}: \37\&{array} $[0\to\\{prim\_size}]$ \1\&{of}\5
\\{two\_halves};\C{the primitives table}\2\6
\4\\{prim\_used}: \37\\{pointer};\C{allocation pointer for \\{prim}}\par
\fi

\M276. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{no\_new\_control\_sequence}\K\\{true}$;\C{new identifiers are usually
forbidden}\6
$\\{prim\_next}(0)\K0$;\5
$\\{prim\_text}(0)\K0$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{prim\_size}$ \1\&{do}\5
$\\{prim}[\|k]\K\\{prim}[0]$;\2\6
$\\{next}(\\{hash\_base})\K0$;\5
$\\{text}(\\{hash\_base})\K0$;\6
\&{for} $\|k\K\\{hash\_base}+1\mathrel{\&{to}}\\{undefined\_control%
\_sequence}-1$ \1\&{do}\5
$\\{hash}[\|k]\K\\{hash}[\\{hash\_base}]$;\2\par
\fi

\M277. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}%
\S$\6
$\\{prim\_used}\K\\{prim\_size}$;\C{nothing is used}\6
$\\{hash\_used}\K\\{frozen\_control\_sequence}$;\C{nothing is used}\6
$\\{cs\_count}\K0$;\5
$\\{eq\_type}(\\{frozen\_dont\_expand})\K\\{dont\_expand}$;\5
$\\{text}(\\{frozen\_dont\_expand})\K\.{"notexpanded:"}$;\5
$\\{eq\_type}(\\{frozen\_primitive})\K\\{ignore\_spaces}$;\5
$\\{equiv}(\\{frozen\_primitive})\K1$;\5
$\\{eq\_level}(\\{frozen\_primitive})\K\\{level\_one}$;\5
$\\{text}(\\{frozen\_primitive})\K\.{"pdfprimitive"}$;\par
\fi

\M278. Here is the subroutine that searches the hash table for an identifier
that matches a given string of length $\|l>1$ appearing in $\\{buffer}[\|j\to(%
\|j+\|l-1)]$. If the identifier is found, the corresponding hash table address
is returned. Otherwise, if the global variable \\{no\_new\_control\_sequence}
is \\{true}, the dummy address \\{undefined\_control\_sequence} is returned.
Otherwise the identifier is inserted into the hash table and its location
is returned.

\Y\P\4\&{function}\1\  \37$\\{id\_lookup}(\|j,\39\|l:\\{integer})$: \37%
\\{pointer};\C{search the hash table}\6
\4\&{label} \37\\{found};\C{go here if you found it}\6
\4\&{var} \37\|h: \37\\{integer};\C{hash code}\6
\|d: \37\\{integer};\C{number of characters in incomplete current string}\6
\|p: \37\\{pointer};\C{index in \\{hash} array}\6
\|k: \37\\{pointer};\C{index in \\{buffer} array}\2\6
\&{begin} \37\X280:Compute the hash code \|h\X;\6
$\|p\K\|h+\\{hash\_base}$;\C{we start searching here; note that $0\L\|h<\\{hash%
\_prime}$}\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{text}(\|p)>0$ \1\&{then}\6
\&{if} $\\{length}(\\{text}(\|p))=\|l$ \1\&{then}\6
\&{if} $\\{str\_eq\_buf}(\\{text}(\|p),\39\|j)$ \1\&{then}\5
\&{goto} \37\\{found};\2\2\2\6
\&{if} $\\{next}(\|p)=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{no\_new\_control\_sequence}$ \1\&{then}\5
$\|p\K\\{undefined\_control\_sequence}$\6
\4\&{else} \X279:Insert a new control sequence after \|p, then make \|p point
to it\X;\2\6
\&{goto} \37\\{found};\6
\&{end};\2\6
$\|p\K\\{next}(\|p)$;\6
\&{end};\2\6
\4\\{found}: \37$\\{id\_lookup}\K\|p$;\6
\&{end};\par
\fi

\M279. \P$\X279:Insert a new control sequence after \|p, then make \|p point to
it\X\S$\6
\&{begin} \37\&{if} $\\{text}(\|p)>0$ \1\&{then}\6
\&{begin} \37\1\&{repeat} \37\&{if} $\\{hash\_is\_full}$ \1\&{then}\5
$\\{overflow}(\.{"hash\ size"},\39\\{hash\_size})$;\2\6
$\\{decr}(\\{hash\_used})$;\6
\4\&{until}\5
$\\{text}(\\{hash\_used})=0$;\C{search for an empty location in \\{hash}}\2\6
$\\{next}(\|p)\K\\{hash\_used}$;\5
$\|p\K\\{hash\_used}$;\6
\&{end};\2\6
$\\{str\_room}(\|l)$;\5
$\|d\K\\{cur\_length}$;\6
\&{while} $\\{pool\_ptr}>\\{str\_start}[\\{str\_ptr}]$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{pool\_ptr})$;\5
$\\{str\_pool}[\\{pool\_ptr}+\|l]\K\\{str\_pool}[\\{pool\_ptr}]$;\6
\&{end};\C{move current string up to make room for another}\2\6
\&{for} $\|k\K\|j\mathrel{\&{to}}\|j+\|l-1$ \1\&{do}\5
$\\{append\_char}(\\{buffer}[\|k])$;\2\6
$\\{text}(\|p)\K\\{make\_string}$;\5
$\\{pool\_ptr}\K\\{pool\_ptr}+\|d$;\6
\&{stat} \37$\\{incr}(\\{cs\_count})$;\ \&{tats}\6
\&{end}\par
\U278.\fi

\M280. The value of \\{hash\_prime} should be roughly 85\pct! of \\{hash%
\_size}, and it
should be a prime number.  The theory of hashing tells us to expect fewer
than two table probes, on the average, when the search is successful.
[See J.~S. Vitter, {\sl Journal of the ACM\/ \bf30} (1983), 231--258.]

\Y\P$\4\X280:Compute the hash code \|h\X\S$\6
$\|h\K\\{buffer}[\|j]$;\6
\&{for} $\|k\K\|j+1\mathrel{\&{to}}\|j+\|l-1$ \1\&{do}\6
\&{begin} \37$\|h\K\|h+\|h+\\{buffer}[\|k]$;\6
\&{while} $\|h\G\\{hash\_prime}$ \1\&{do}\5
$\|h\K\|h-\\{hash\_prime}$;\2\6
\&{end}\2\par
\U278.\fi

\M281. Here is the subroutine that searches the primitive table for an
identifier:

\Y\P\4\&{function}\1\  \37$\\{prim\_lookup}(\|s:\\{str\_number})$: \37%
\\{pointer};\C{search the primitives table}\6
\4\&{label} \37\\{found};\C{go here if you found it}\6
\4\&{var} \37\|h: \37\\{integer};\C{hash code}\6
\|p: \37\\{pointer};\C{index in \\{hash} array}\6
\|k: \37\\{pointer};\C{index in string pool}\6
$\|j,\39\|l$: \37\\{integer};\2\6
\&{begin} \37\&{if} $\|s\L\\{biggest\_char}$ \1\&{then}\6
\&{begin} \37\&{if} $\|s<0$ \1\&{then}\6
\&{begin} \37$\|p\K\\{undefined\_primitive}$;\5
\&{goto} \37\\{found};\6
\&{end}\6
\4\&{else} $\|p\K(\|s\mathbin{\&{mod}}\\{prim\_prime})+\\{prim\_base}$;\C{we
start searching here}\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{if} $\|s=\\{str\_ptr}$ \1\&{then}\5
$\|l\K\\{cur\_length}$\6
\4\&{else} $\|l\K\\{length}(\|s)$;\2\6
\X283:Compute the primitive code \|h\X;\6
$\|p\K\|h+\\{prim\_base}$;\C{we start searching here; note that $0\L\|h<\\{prim%
\_prime}$}\6
\&{end};\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{prim\_text}(\|p)>1+\\{biggest\_char}$ \1%
\&{then}\C{ \|p points a multi-letter primitive }\6
\&{begin} \37\&{if} $\\{length}(\\{prim\_text}(\|p)-1)=\|l$ \1\&{then}\6
\&{if} $\\{str\_eq\_str}(\\{prim\_text}(\|p)-1,\39\|s)$ \1\&{then}\5
\&{goto} \37\\{found};\2\2\6
\&{end}\6
\4\&{else} \&{if} $\\{prim\_text}(\|p)=1+\|s$ \1\&{then}\5
\&{goto} \37\\{found};\C{ \|p points a single-letter primitive }\2\2\6
\&{if} $\\{prim\_next}(\|p)=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{no\_new\_control\_sequence}$ \1\&{then}\5
$\|p\K\\{undefined\_primitive}$\6
\4\&{else} \X282:Insert a new primitive after \|p, then make \|p point to it\X;%
\2\6
\&{goto} \37\\{found};\6
\&{end};\2\6
$\|p\K\\{prim\_next}(\|p)$;\6
\&{end};\2\6
\4\\{found}: \37$\\{prim\_lookup}\K\|p$;\6
\&{end};\par
\fi

\M282. \P$\X282:Insert a new primitive after \|p, then make \|p point to it\X%
\S$\6
\&{begin} \37\&{if} $\\{prim\_text}(\|p)>0$ \1\&{then}\6
\&{begin} \37\1\&{repeat} \37\&{if} $\\{prim\_is\_full}$ \1\&{then}\5
$\\{overflow}(\.{"primitive\ size"},\39\\{prim\_size})$;\2\6
$\\{decr}(\\{prim\_used})$;\6
\4\&{until}\5
$\\{prim\_text}(\\{prim\_used})=0$;\C{search for an empty location in \\{prim}}%
\2\6
$\\{prim\_next}(\|p)\K\\{prim\_used}$;\5
$\|p\K\\{prim\_used}$;\6
\&{end};\2\6
$\\{prim\_text}(\|p)\K\|s+1$;\6
\&{end}\par
\U281.\fi

\M283. The value of \\{prim\_prime} should be roughly 85\pct! of
\\{prim\_size}, and it should be a prime number.

\Y\P$\4\X283:Compute the primitive code \|h\X\S$\6
$\|h\K\\{str\_pool}[\|j]$;\6
\&{for} $\|k\K\|j+1\mathrel{\&{to}}\|j+\|l-1$ \1\&{do}\6
\&{begin} \37$\|h\K\|h+\|h+\\{str\_pool}[\|k]$;\6
\&{while} $\|h\G\\{prim\_prime}$ \1\&{do}\5
$\|h\K\|h-\\{prim\_prime}$;\2\6
\&{end}\2\par
\U281.\fi

\M284. Single-character control sequences do not need to be looked up in a hash
table, since we can use the character code itself as a direct address.
The procedure \\{print\_cs} prints the name of a control sequence, given
a pointer to its address in \\{eqtb}. A space is printed after the name
unless it is a single nonletter or an active character. This procedure
might be invoked with invalid data, so it is ``extra robust.'' The
individual characters must be printed one at a time using \\{print}, since
they may be unprintable.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_cs}(\|p:\\{integer})$;\C{prints a purported
control sequence}\2\6
\&{begin} \37\&{if} $\|p<\\{hash\_base}$ \1\&{then}\C{single character}\6
\&{if} $\|p\G\\{single\_base}$ \1\&{then}\6
\&{if} $\|p=\\{null\_cs}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"csname"})$;\5
$\\{print\_esc}(\.{"endcsname"})$;\5
$\\{print\_char}(\.{"\ "})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\|p-\\{single\_base})$;\6
\&{if} $\\{cat\_code}(\|p-\\{single\_base})=\\{letter}$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\6
\&{end}\2\6
\4\&{else} \&{if} $\|p<\\{active\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"IMPOSSIBLE."})$\6
\4\&{else} $\\{print}(\|p-\\{active\_base})$\2\2\6
\4\&{else} \&{if} $\|p\G\\{undefined\_control\_sequence}$ \1\&{then}\5
$\\{print\_esc}(\.{"IMPOSSIBLE."})$\6
\4\&{else} \&{if} $(\\{text}(\|p)<0)\V(\\{text}(\|p)\G\\{str\_ptr})$ \1\&{then}%
\5
$\\{print\_esc}(\.{"NONEXISTENT."})$\6
\4\&{else} \&{begin} \37\&{if} $(\|p\G\\{prim\_eqtb\_base})\W(\|p<\\{frozen%
\_null\_font})$ \1\&{then}\5
$\\{print\_esc}(\\{prim\_text}(\|p-\\{prim\_eqtb\_base})-1)$\6
\4\&{else} $\\{print\_esc}(\\{text}(\|p))$;\2\6
$\\{print\_char}(\.{"\ "})$;\6
\&{end};\2\2\2\6
\&{end};\par
\fi

\M285. Here is a similar procedure; it avoids the error checks, and it never
prints a space after the control sequence.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{sprint\_cs}(\|p:\\{pointer})$;\C{prints a control
sequence}\2\6
\&{begin} \37\&{if} $\|p<\\{hash\_base}$ \1\&{then}\6
\&{if} $\|p<\\{single\_base}$ \1\&{then}\5
$\\{print}(\|p-\\{active\_base})$\6
\4\&{else} \&{if} $\|p<\\{null\_cs}$ \1\&{then}\5
$\\{print\_esc}(\|p-\\{single\_base})$\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"csname"})$;\5
$\\{print\_esc}(\.{"endcsname"})$;\6
\&{end}\2\2\6
\4\&{else} \&{if} $(\|p\G\\{prim\_eqtb\_base})\W(\|p<\\{frozen\_null\_font})$ %
\1\&{then}\5
$\\{print\_esc}(\\{prim\_text}(\|p-\\{prim\_eqtb\_base})-1)$\6
\4\&{else} $\\{print\_esc}(\\{text}(\|p))$;\2\2\6
\&{end};\par
\fi

\M286. We need to put \TeX's ``primitive'' control sequences into the hash
table, together with their command code (which will be the \\{eq\_type})
and an operand (which will be the \\{equiv}). The \\{primitive} procedure
does this, in a way that no \TeX\ user can. The global value \\{cur\_val}
contains the new \\{eqtb} pointer after \\{primitive} has acted.

Until pdf\TeX\ 1.40.19 (released in 2018), a bug in primitive handling
caused, e.g., \.{\\pdfprimitive\\ \\q} to swallow the \.{\\q} instead of
giving an undefined control sequence error. The original report was
posted by Hironori Kitagawa
(\.{tug.org/pipermail/tex-k/2017-October/002816.html}). Largely
quoting from that message:

The cause was \\{cur\_tok} not being set in the ``Cases of \\{main\_control}%
\dots''
module, because \\{back\_input} unscans the token, but only looks at
\\{cur\_tok}, which represents the internalized \.{\\pdfprimitive} at that
time.  So \.{\\pdfprimitive\\vrule\\q} becomes ``(internalized
\.{\\pdfprimitive})''\.{\\q}, hence no error (and \.{\\vrule} disappears).

Hironori's explanation of the previous behavior and fix continues (off-list):

\yskip\textindent{*} \\{back\_input} (and similar routine $\langle\,$Insert
token
\|p into \TeX's input$\,\rangle$) only stores \\{cur\_tok} to a token list.

\textindent{*} When \TeX\ gets input from a token list (at module
$\langle\,$Input from token list, \&{goto} \\{restart} \dots$\,\rangle$),
\TeX\ looks at the saved \\{cur\_tok} value $t$, and recover the command
code (\\{cur\_cmd}) and its modifier (\\{cur\_chr}) from it:

{\advance\leftskip by 1.5em
\textindent{--} If $\|t\G\\{cs\_token\_flag}$, $t$ points to an \\{eqtb}
location
$\|t-\\{cs\_token\_flag}$.

\textindent{--} If $\|t<\\{cs\_token\_flag}$, \\{cur\_cmd} and \\{cur\_chr} are
set
with $\\{cur\_cmd}\K\|t\mathbin{\&{div}}\O{400}$; $\\{cur\_chr}\K\|t\mathbin{%
\&{mod}}\O{400}$.

\textindent{--} This $t$ is used to display the token (\\{show\_token\_list}).
\par}

\textindent{*} pdf\TeX\ defines \\{cs\_token\_flag} as \.{"FFF}.  So simply
using $\\{cur\_tok}\K(\\{cur\_cmd}\ast\O{400})+\\{cur\_chr}$ by \.{%
\\pdfprimitive} does not
work correctly with primitives whose command codes \\{cur\_cmd} $\ge16$.

Increasing \\{cs\_token\_flag} to \.{"FFFF} or somewhat higher
might suffice for fixing this situation in pdf\TeX.
However, this approach does not seem good, because

\textindent{1)} an (indirect) mapping from \\{cur\_tok} to control sequence
name is needed anyway, for displaying the token, and

\textindent{2)} this does not work in Japanese e-(u)p\TeX.

Thus, we now put \\{prim\_eqtb} entries into the end of region 2 of
\\{eqtb} (which contains some frozen primitives, such as ``frozen \.{\\fi}''
and ``frozen \.{\\cr}''), thus treating \\{prim\_eqtb} entries as a permanent
location for primitives.

\Y\P\&{init} \37\&{procedure}\1\  \37$\\{primitive}(\|s:\\{str\_number};\,\35%
\|c:\\{quarterword};\,\35\|o:\\{halfword})$;\6
\4\&{var} \37\|k: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\6
\|j: \37$0\to\\{buf\_size}$;\C{index into \\{buffer}}\6
\|l: \37\\{small\_number};\C{length of the string}\6
\\{prim\_val}: \37\\{integer};\C{needed to fill \\{prim\_eqtb}}\2\6
\&{begin} \37\&{if} $\|s<256$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\|s+\\{single\_base}$;\5
$\\{prim\_val}\K\\{prim\_lookup}(\|s)$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|k\K\\{str\_start}[\|s]$;\5
$\|l\K\\{str\_start}[\|s+1]-\|k$;\C{we will move \|s into the (possibly
non-empty) \\{buffer}}\6
\&{if} $\\{first}+\|l>\\{buf\_size}+1$ \1\&{then}\5
$\\{overflow}(\.{"buffer\ size"},\39\\{buf\_size})$;\2\6
\&{for} $\|j\K0\mathrel{\&{to}}\|l-1$ \1\&{do}\5
$\\{buffer}[\\{first}+\|j]\K\\{so}(\\{str\_pool}[\|k+\|j])$;\2\6
$\\{cur\_val}\K\\{id\_lookup}(\\{first},\39\|l)$;\C{\\{no\_new\_control%
\_sequence} is \\{false}}\6
\\{flush\_string};\5
$\\{text}(\\{cur\_val})\K\|s$;\C{we don't want to have the string twice}\6
$\\{prim\_val}\K\\{prim\_lookup}(\|s)$;\6
\&{end};\2\6
$\\{eq\_level}(\\{cur\_val})\K\\{level\_one}$;\5
$\\{eq\_type}(\\{cur\_val})\K\|c$;\5
$\\{equiv}(\\{cur\_val})\K\|o$;\5
$\\{prim\_eq\_level}(\\{prim\_val})\K\\{level\_one}$;\5
$\\{prim\_eq\_type}(\\{prim\_val})\K\|c$;\5
$\\{prim\_equiv}(\\{prim\_val})\K\|o$;\6
\&{end};\6
\&{tini}\par
\fi

\M287. Many of \TeX's primitives need no \\{equiv}, since they are identifiable
by their \\{eq\_type} alone. These primitives are loaded into the hash table
as follows:

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"\ "},\39\\{ex\_space},\390)$;\6
$\\{primitive}(\.{"/"},\39\\{ital\_corr},\390)$;\6
$\\{primitive}(\.{"accent"},\39\\{accent},\390)$;\6
$\\{primitive}(\.{"advance"},\39\\{advance},\390)$;\6
$\\{primitive}(\.{"afterassignment"},\39\\{after\_assignment},\390)$;\6
$\\{primitive}(\.{"aftergroup"},\39\\{after\_group},\390)$;\6
$\\{primitive}(\.{"begingroup"},\39\\{begin\_group},\390)$;\6
$\\{primitive}(\.{"char"},\39\\{char\_num},\390)$;\6
$\\{primitive}(\.{"csname"},\39\\{cs\_name},\390)$;\6
$\\{primitive}(\.{"delimiter"},\39\\{delim\_num},\390)$;\6
$\\{primitive}(\.{"divide"},\39\\{divide},\390)$;\6
$\\{primitive}(\.{"endcsname"},\39\\{end\_cs\_name},\390)$;\6
$\\{primitive}(\.{"endgroup"},\39\\{end\_group},\390)$;\5
$\\{text}(\\{frozen\_end\_group})\K\.{"endgroup"}$;\5
$\\{eqtb}[\\{frozen\_end\_group}]\K\\{eqtb}[\\{cur\_val}]$;\6
$\\{primitive}(\.{"expandafter"},\39\\{expand\_after},\390)$;\6
$\\{primitive}(\.{"font"},\39\\{def\_font},\390)$;\6
$\\{primitive}(\.{"letterspacefont"},\39\\{letterspace\_font},\390)$;\6
$\\{primitive}(\.{"pdfcopyfont"},\39\\{pdf\_copy\_font},\390)$;\6
$\\{primitive}(\.{"fontdimen"},\39\\{assign\_font\_dimen},\390)$;\6
$\\{primitive}(\.{"halign"},\39\\{halign},\390)$;\6
$\\{primitive}(\.{"hrule"},\39\\{hrule},\390)$;\6
$\\{primitive}(\.{"ignorespaces"},\39\\{ignore\_spaces},\390)$;\6
$\\{primitive}(\.{"insert"},\39\\{insert},\390)$;\6
$\\{primitive}(\.{"mark"},\39\\{mark},\390)$;\6
$\\{primitive}(\.{"mathaccent"},\39\\{math\_accent},\390)$;\6
$\\{primitive}(\.{"mathchar"},\39\\{math\_char\_num},\390)$;\6
$\\{primitive}(\.{"mathchoice"},\39\\{math\_choice},\390)$;\6
$\\{primitive}(\.{"multiply"},\39\\{multiply},\390)$;\6
$\\{primitive}(\.{"noalign"},\39\\{no\_align},\390)$;\6
$\\{primitive}(\.{"noboundary"},\39\\{no\_boundary},\390)$;\6
$\\{primitive}(\.{"noexpand"},\39\\{no\_expand},\390)$;\6
$\\{primitive}(\.{"pdfprimitive"},\39\\{no\_expand},\391)$;\6
$\\{primitive}(\.{"nonscript"},\39\\{non\_script},\390)$;\6
$\\{primitive}(\.{"omit"},\39\\{omit},\390)$;\6
$\\{primitive}(\.{"parshape"},\39\\{set\_shape},\39\\{par\_shape\_loc})$;\6
$\\{primitive}(\.{"penalty"},\39\\{break\_penalty},\390)$;\6
$\\{primitive}(\.{"prevgraf"},\39\\{set\_prev\_graf},\390)$;\6
$\\{primitive}(\.{"radical"},\39\\{radical},\390)$;\6
$\\{primitive}(\.{"read"},\39\\{read\_to\_cs},\390)$;\6
$\\{primitive}(\.{"relax"},\39\\{relax},\39256)$;\C{cf.\ \\{scan\_file\_name}}\6
$\\{text}(\\{frozen\_relax})\K\.{"relax"}$;\5
$\\{eqtb}[\\{frozen\_relax}]\K\\{eqtb}[\\{cur\_val}]$;\6
$\\{primitive}(\.{"setbox"},\39\\{set\_box},\390)$;\6
$\\{primitive}(\.{"the"},\39\\{the},\390)$;\6
$\\{primitive}(\.{"toks"},\39\\{toks\_register},\39\\{mem\_bot})$;\6
$\\{primitive}(\.{"vadjust"},\39\\{vadjust},\390)$;\6
$\\{primitive}(\.{"valign"},\39\\{valign},\390)$;\6
$\\{primitive}(\.{"vcenter"},\39\\{vcenter},\390)$;\6
$\\{primitive}(\.{"vrule"},\39\\{vrule},\390)$;\par
\fi

\M288. Each primitive has a corresponding inverse, so that it is possible to
display the cryptic numeric contents of \\{eqtb} in symbolic form.
Every call of \\{primitive} in this program is therefore accompanied by some
straightforward code that forms part of the \\{print\_cmd\_chr} routine
below.

\Y\P$\4\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of primitives\X%
\mathrel{+}\S$\6
\4\\{accent}: \37$\\{print\_esc}(\.{"accent"})$;\6
\4\\{advance}: \37$\\{print\_esc}(\.{"advance"})$;\6
\4\\{after\_assignment}: \37$\\{print\_esc}(\.{"afterassignment"})$;\6
\4\\{after\_group}: \37$\\{print\_esc}(\.{"aftergroup"})$;\6
\4\\{assign\_font\_dimen}: \37$\\{print\_esc}(\.{"fontdimen"})$;\6
\4\\{begin\_group}: \37$\\{print\_esc}(\.{"begingroup"})$;\6
\4\\{break\_penalty}: \37$\\{print\_esc}(\.{"penalty"})$;\6
\4\\{char\_num}: \37$\\{print\_esc}(\.{"char"})$;\6
\4\\{cs\_name}: \37$\\{print\_esc}(\.{"csname"})$;\6
\4\\{def\_font}: \37$\\{print\_esc}(\.{"font"})$;\6
\4\\{letterspace\_font}: \37$\\{print\_esc}(\.{"letterspacefont"})$;\6
\4\\{pdf\_copy\_font}: \37$\\{print\_esc}(\.{"pdfcopyfont"})$;\6
\4\\{delim\_num}: \37$\\{print\_esc}(\.{"delimiter"})$;\6
\4\\{divide}: \37$\\{print\_esc}(\.{"divide"})$;\6
\4\\{end\_cs\_name}: \37$\\{print\_esc}(\.{"endcsname"})$;\6
\4\\{end\_group}: \37$\\{print\_esc}(\.{"endgroup"})$;\6
\4\\{ex\_space}: \37$\\{print\_esc}(\.{"\ "})$;\6
\4\\{expand\_after}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"expandafter"})$\1\5
\X1763:Cases of \\{expandafter} for \\{print\_cmd\_chr}\X;\2\2\6
\4\\{halign}: \37$\\{print\_esc}(\.{"halign"})$;\6
\4\\{hrule}: \37$\\{print\_esc}(\.{"hrule"})$;\6
\4\\{ignore\_spaces}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"ignorespaces"})$\6
\4\&{else} $\\{print\_esc}(\.{"pdfprimitive"})$;\2\6
\4\\{insert}: \37$\\{print\_esc}(\.{"insert"})$;\6
\4\\{ital\_corr}: \37$\\{print\_esc}(\.{"/"})$;\6
\4\\{mark}: \37\&{begin} \37$\\{print\_esc}(\.{"mark"})$;\6
\&{if} $\\{chr\_code}>0$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
\&{end};\6
\4\\{math\_accent}: \37$\\{print\_esc}(\.{"mathaccent"})$;\6
\4\\{math\_char\_num}: \37$\\{print\_esc}(\.{"mathchar"})$;\6
\4\\{math\_choice}: \37$\\{print\_esc}(\.{"mathchoice"})$;\6
\4\\{multiply}: \37$\\{print\_esc}(\.{"multiply"})$;\6
\4\\{no\_align}: \37$\\{print\_esc}(\.{"noalign"})$;\6
\4\\{no\_boundary}: \37$\\{print\_esc}(\.{"noboundary"})$;\6
\4\\{no\_expand}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"noexpand"})$\6
\4\&{else} $\\{print\_esc}(\.{"pdfprimitive"})$;\2\6
\4\\{non\_script}: \37$\\{print\_esc}(\.{"nonscript"})$;\6
\4\\{omit}: \37$\\{print\_esc}(\.{"omit"})$;\6
\4\\{radical}: \37$\\{print\_esc}(\.{"radical"})$;\6
\4\\{read\_to\_cs}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"read"})$\1\5
\X1760:Cases of \\{read} for \\{print\_cmd\_chr}\X;\2\2\6
\4\\{relax}: \37$\\{print\_esc}(\.{"relax"})$;\6
\4\\{set\_box}: \37$\\{print\_esc}(\.{"setbox"})$;\6
\4\\{set\_prev\_graf}: \37$\\{print\_esc}(\.{"prevgraf"})$;\6
\4\\{set\_shape}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{par\_shape\_loc}: \37$\\{print\_esc}(\.{"parshape"})$;\6
\X1865:Cases of \\{set\_shape} for \\{print\_cmd\_chr}\X\2\6
\&{end};\C{there are no other cases}\6
\4\\{the}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"the"})$\1\5
\X1687:Cases of \\{the} for \\{print\_cmd\_chr}\X;\2\2\6
\4\\{toks\_register}: \37\X1833:Cases of \\{toks\_register} for \\{print\_cmd%
\_chr}\X;\6
\4\\{vadjust}: \37$\\{print\_esc}(\.{"vadjust"})$;\6
\4\\{valign}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"valign"})$\2\6
\X1702:Cases of \\{valign} for \\{print\_cmd\_chr}\X;\6
\4\\{vcenter}: \37$\\{print\_esc}(\.{"vcenter"})$;\6
\4\\{vrule}: \37$\\{print\_esc}(\.{"vrule"})$;\par
\fi

\M289. We will deal with the other primitives later, at some point in the
program
where their \\{eq\_type} and \\{equiv} values are more meaningful.  For
example,
the primitives for math mode will be loaded when we consider the routines
that deal with formulas. It is easy to find where each particular
primitive was treated by looking in the index at the end; for example, the
section where \.{"radical"} entered \\{eqtb} is listed under `\.{\\radical}
primitive'. (Primitives consisting of a single nonalphabetic character,
like `\.{\\/}', are listed under `Single-character primitives'.)

Meanwhile, this is a convenient place to catch up on something we were unable
to do before the hash table was defined:

\fi

\N290.  \[19] Saving and restoring equivalents.
The nested structure provided by `$\.{\char'173}\ldots\.{\char'175}$' groups
in \TeX\ means that \\{eqtb} entries valid in outer groups should be saved
and restored later if they are overridden inside the braces. When a new %
\\{eqtb}
value is being assigned, the program therefore checks to see if the previous
entry belongs to an outer level. In such a case, the old value is placed
on the \\{save\_stack} just before the new value enters \\{eqtb}. At the
end of a grouping level, i.e., when the right brace is sensed, the
\\{save\_stack} is used to restore the outer values, and the inner ones are
destroyed.

Entries on the \\{save\_stack} are of type \\{memory\_word}. The top item on
this stack is $\\{save\_stack}[\|p]$, where $\|p=\\{save\_ptr}-1$; it contains
three
fields called \\{save\_type}, \\{save\_level}, and \\{save\_index}, and it is
interpreted in one of five ways:

\yskip\hangg 1) If $\\{save\_type}(\|p)=\\{restore\_old\_value}$, then
$\\{save\_index}(\|p)$ is a location in \\{eqtb} whose current value should
be destroyed at the end of the current group and replaced by $\\{save\_stack}[%
\|p-1]$.
Furthermore if $\\{save\_index}(\|p)\G\\{int\_base}$, then $\\{save\_level}(%
\|p)$
should replace the corresponding entry in \\{xeq\_level}.

\yskip\hangg 2) If $\\{save\_type}(\|p)=\\{restore\_zero}$, then $\\{save%
\_index}(\|p)$
is a location in \\{eqtb} whose current value should be destroyed at the end
of the current group, when it should be
replaced by the value of $\\{eqtb}[\\{undefined\_control\_sequence}]$.

\yskip\hangg 3) If $\\{save\_type}(\|p)=\\{insert\_token}$, then $\\{save%
\_index}(\|p)$
is a token that should be inserted into \TeX's input when the current
group ends.

\yskip\hangg 4) If $\\{save\_type}(\|p)=\\{level\_boundary}$, then $\\{save%
\_level}(\|p)$
is a code explaining what kind of group we were previously in, and
$\\{save\_index}(\|p)$ points to the level boundary word at the bottom of
the entries for that group.
Furthermore, in extended \eTeX\ mode, $\\{save\_stack}[\|p-1]$ contains the
source line number at which the current level of grouping was entered.

\yskip\hang 5) If $\\{save\_type}(\|p)=\\{restore\_sa}$, then \\{sa\_chain}
points to a
chain of sparse array entries to be restored at the end of the current
group. Furthermore $\\{save\_index}(\|p)$ and $\\{save\_level}(\|p)$ should
replace
the values of \\{sa\_chain} and \\{sa\_level} respectively.

\Y\P\D \37$\\{save\_type}(\#)\S\\{save\_stack}[\#].\\{hh}.\\{b0}$\C{classifies
a \\{save\_stack} entry}\par
\P\D \37$\\{save\_level}(\#)\S\\{save\_stack}[\#].\\{hh}.\\{b1}$\C{saved level
for regions 5 and 6, or group code}\par
\P\D \37$\\{save\_index}(\#)\S\\{save\_stack}[\#].\\{hh}.\\{rh}$\C{\\{eqtb}
location or token or \\{save\_stack} location}\par
\P\D \37$\\{restore\_old\_value}=0$\C{\\{save\_type} when a value should be
restored later}\par
\P\D \37$\\{restore\_zero}=1$\C{\\{save\_type} when an undefined entry should
be restored}\par
\P\D \37$\\{insert\_token}=2$\C{\\{save\_type} when a token is being saved for
later use}\par
\P\D \37$\\{level\_boundary}=3$\C{\\{save\_type} corresponding to beginning of
group}\par
\P\D \37$\\{restore\_sa}=4$\C{\\{save\_type} when sparse array entries should
be restored}\par
\Y\P\hbox{\4}\X306:Declare \eTeX\ procedures for tracing and input\X\par
\fi

\M291. Here are the group codes that are used to discriminate between different
kinds of groups. They allow \TeX\ to decide what special actions, if any,
should be performed when a group ends.
\def\grp{\.{\char'173...\char'175}}

Some groups are not supposed to be ended by right braces. For example,
the `\.\$' that begins a math formula causes a \\{math\_shift\_group} to
be started, and this should be terminated by a matching `\.\$'. Similarly,
a group that starts with \.{\\left} should end with \.{\\right}, and
one that starts with \.{\\begingroup} should end with \.{\\endgroup}.

\Y\P\D \37$\\{bottom\_level}=0$\C{group code for the outside world}\par
\P\D \37$\\{simple\_group}=1$\C{group code for local structure only}\par
\P\D \37$\\{hbox\_group}=2$\C{code for `\.{\\hbox}\grp'}\par
\P\D \37$\\{adjusted\_hbox\_group}=3$\C{code for `\.{\\hbox}\grp' in vertical
mode}\par
\P\D \37$\\{vbox\_group}=4$\C{code for `\.{\\vbox}\grp'}\par
\P\D \37$\\{vtop\_group}=5$\C{code for `\.{\\vtop}\grp'}\par
\P\D \37$\\{align\_group}=6$\C{code for `\.{\\halign}\grp', `\.{\\valign}\grp'}%
\par
\P\D \37$\\{no\_align\_group}=7$\C{code for `\.{\\noalign}\grp'}\par
\P\D \37$\\{output\_group}=8$\C{code for output routine}\par
\P\D \37$\\{math\_group}=9$\C{code for, e.g., `\.{\char'136}\grp'}\par
\P\D \37$\\{disc\_group}=10$\C{code for `\.{\\discretionary}\grp\grp\grp'}\par
\P\D \37$\\{insert\_group}=11$\C{code for `\.{\\insert}\grp', `\.{\\vadjust}%
\grp'}\par
\P\D \37$\\{vcenter\_group}=12$\C{code for `\.{\\vcenter}\grp'}\par
\P\D \37$\\{math\_choice\_group}=13$\C{code for `\.{\\mathchoice}\grp\grp\grp%
\grp'}\par
\P\D \37$\\{semi\_simple\_group}=14$\C{code for `\.{\\begingroup...%
\\endgroup}'}\par
\P\D \37$\\{math\_shift\_group}=15$\C{code for `\.{\$...\$}'}\par
\P\D \37$\\{math\_left\_group}=16$\C{code for `\.{\\left...\\right}'}\par
\P\D \37$\\{max\_group\_code}=16$\par
\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{group\_code}=0\to\\{max\_group\_code}$;\C{\\{save\_level} for a level
boundary}\par
\fi

\M292. The global variable \\{cur\_group} keeps track of what sort of group we
are
currently in. Another global variable, \\{cur\_boundary}, points to the
topmost \\{level\_boundary} word.  And \\{cur\_level} is the current depth of
nesting. The routines are designed to preserve the condition that no entry
in the \\{save\_stack} or in \\{eqtb} ever has a level greater than \\{cur%
\_level}.

\fi

\M293. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{save\_stack}: \37\&{array} $[0\to\\{save\_size}]$ \1\&{of}\5
\\{memory\_word};\2\6
\4\\{save\_ptr}: \37$0\to\\{save\_size}$;\C{first unused entry on \\{save%
\_stack}}\6
\4\\{max\_save\_stack}: \37$0\to\\{save\_size}$;\C{maximum usage of save stack}%
\6
\4\\{cur\_level}: \37\\{quarterword};\C{current nesting level for groups}\6
\4\\{cur\_group}: \37\\{group\_code};\C{current group type}\6
\4\\{cur\_boundary}: \37$0\to\\{save\_size}$;\C{where the current level begins}%
\par
\fi

\M294. At this time it might be a good idea for the reader to review the
introduction
to \\{eqtb} that was given above just before the long lists of parameter names.
Recall that the ``outer level'' of the program is \\{level\_one}, since
undefined control sequences are assumed to be ``defined'' at \\{level\_zero}.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{save\_ptr}\K0$;\5
$\\{cur\_level}\K\\{level\_one}$;\5
$\\{cur\_group}\K\\{bottom\_level}$;\5
$\\{cur\_boundary}\K0$;\5
$\\{max\_save\_stack}\K0$;\par
\fi

\M295. The following macro is used to test if there is room for up to seven
more
entries on \\{save\_stack}. By making a conservative test like this, we can
get by with testing for overflow in only a few places.

\Y\P\D \37$\\{check\_full\_save\_stack}\S$\1\6
\&{if} $\\{save\_ptr}>\\{max\_save\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_save\_stack}\K\\{save\_ptr}$;\6
\&{if} $\\{max\_save\_stack}>\\{save\_size}-7$ \1\&{then}\5
$\\{overflow}(\.{"save\ size"},\39\\{save\_size})$;\2\6
\&{end}\2\2\par
\fi

\M296. Procedure \\{new\_save\_level} is called when a group begins. The
argument is a group identification code like `\\{hbox\_group}'. After
calling this routine, it is safe to put five more entries on \\{save\_stack}.

In some cases integer-valued items are placed onto the
\\{save\_stack} just below a \\{level\_boundary} word, because this is a
convenient place to keep information that is supposed to ``pop up'' just
when the group has finished.
For example, when `\.{\\hbox to 100pt}\grp' is being treated, the 100pt
dimension is stored on \\{save\_stack} just before \\{new\_save\_level} is
called.

We use the notation $\\{saved}(\|k)$ to stand for an integer item that
appears in location $\\{save\_ptr}+\|k$ of the save stack.

\Y\P\D \37$\\{saved}(\#)\S\\{save\_stack}[\\{save\_ptr}+\#].\\{int}$\par
\Y\P\4\&{procedure}\1\  \37$\\{new\_save\_level}(\|c:\\{group\_code})$;\C{begin
a new level of grouping}\2\6
\&{begin} \37\\{check\_full\_save\_stack};\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37$\\{saved}(0)\K\\{line}$;\5
$\\{incr}(\\{save\_ptr})$;\6
\&{end};\2\6
$\\{save\_type}(\\{save\_ptr})\K\\{level\_boundary}$;\5
$\\{save\_level}(\\{save\_ptr})\K\\{cur\_group}$;\5
$\\{save\_index}(\\{save\_ptr})\K\\{cur\_boundary}$;\6
\&{if} $\\{cur\_level}=\\{max\_quarterword}$ \1\&{then}\5
$\\{overflow}(\.{"grouping\ levels"},\39\\{max\_quarterword}-\\{min%
\_quarterword})$;\C{quit if $(\\{cur\_level}+1)$ is too big to be stored in %
\\{eqtb}}\2\6
$\\{cur\_boundary}\K\\{save\_ptr}$;\5
$\\{cur\_group}\K\|c$;\6
\&{stat} \37\&{if} $\\{tracing\_groups}>0$ \1\&{then}\5
$\\{group\_trace}(\\{false})$;\ \2\6
\&{tats}\6
$\\{incr}(\\{cur\_level})$;\5
$\\{incr}(\\{save\_ptr})$;\6
\&{end};\par
\fi

\M297. Just before an entry of \\{eqtb} is changed, the following procedure
should
be called to update the other data structures properly. It is important
to keep in mind that reference counts in \\{mem} include references from
within \\{save\_stack}, so these counts must be handled carefully.

\Y\P\4\&{procedure}\1\  \37$\\{eq\_destroy}(\|w:\\{memory\_word})$;\C{gets
ready to forget \|w}\6
\4\&{var} \37\|q: \37\\{pointer};\C{\\{equiv} field of \|w}\2\6
\&{begin} \37\&{case} $\\{eq\_type\_field}(\|w)$ \1\&{of}\6
\4$\\{call},\39\\{long\_call},\39\\{outer\_call},\39\\{long\_outer\_call}$: %
\37$\\{delete\_token\_ref}(\\{equiv\_field}(\|w))$;\6
\4\\{glue\_ref}: \37$\\{delete\_glue\_ref}(\\{equiv\_field}(\|w))$;\6
\4\\{shape\_ref}: \37\&{begin} \37$\|q\K\\{equiv\_field}(\|w)$;\C{we need to
free a \.{\\parshape} block}\6
\&{if} $\|q\I\\{null}$ \1\&{then}\5
$\\{free\_node}(\|q,\39\\{info}(\|q)+\\{info}(\|q)+1)$;\2\6
\&{end};\C{such a block is $2\|n+1$ words long, where $\|n=\\{info}(\|q)$}\6
\4\\{box\_ref}: \37$\\{flush\_node\_list}(\\{equiv\_field}(\|w))$;\6
\X1834:Cases for \\{eq\_destroy}\X\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{end};\par
\fi

\M298. To save a value of $\\{eqtb}[\|p]$ that was established at level \|l, we
can use the following subroutine.

\Y\P\4\&{procedure}\1\  \37$\\{eq\_save}(\|p:\\{pointer};\,\35\|l:%
\\{quarterword})$;\C{saves $\\{eqtb}[\|p]$}\2\6
\&{begin} \37\\{check\_full\_save\_stack};\6
\&{if} $\|l=\\{level\_zero}$ \1\&{then}\5
$\\{save\_type}(\\{save\_ptr})\K\\{restore\_zero}$\6
\4\&{else} \&{begin} \37$\\{save\_stack}[\\{save\_ptr}]\K\\{eqtb}[\|p]$;\5
$\\{incr}(\\{save\_ptr})$;\5
$\\{save\_type}(\\{save\_ptr})\K\\{restore\_old\_value}$;\6
\&{end};\2\6
$\\{save\_level}(\\{save\_ptr})\K\|l$;\5
$\\{save\_index}(\\{save\_ptr})\K\|p$;\5
$\\{incr}(\\{save\_ptr})$;\6
\&{end};\par
\fi

\M299. The procedure \\{eq\_define} defines an \\{eqtb} entry having specified
\\{eq\_type} and \\{equiv} fields, and saves the former value if appropriate.
This procedure is used only for entries in the first four regions of \\{eqtb},
i.e., only for entries that have \\{eq\_type} and \\{equiv} fields.
After calling this routine, it is safe to put four more entries on
\\{save\_stack}, provided that there was room for four more entries before
the call, since \\{eq\_save} makes the necessary test.

\Y\P\D \37$\\{assign\_trace}(\#)\S$\1\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{restore\_trace}(\#)$;\2\6
\&{tats}\2\par
\Y\P\4\&{procedure}\1\  \37$\\{eq\_define}(\|p:\\{pointer};\,\35\|t:%
\\{quarterword};\,\35\|e:\\{halfword})$;\C{new data for \\{eqtb}}\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{if} $\\{eTeX\_ex}\W(\\{eq\_type}(\|p)=\|t)\W(\\{equiv}(\|p)=%
\|e)$ \1\&{then}\6
\&{begin} \37$\\{assign\_trace}(\|p,\39\.{"reassigning"})$\6
$\\{eq\_destroy}(\\{eqtb}[\|p])$;\5
\&{return};\6
\&{end};\2\6
$\\{assign\_trace}(\|p,\39\.{"changing"})$\6
\&{if} $\\{eq\_level}(\|p)=\\{cur\_level}$ \1\&{then}\5
$\\{eq\_destroy}(\\{eqtb}[\|p])$\6
\4\&{else} \&{if} $\\{cur\_level}>\\{level\_one}$ \1\&{then}\5
$\\{eq\_save}(\|p,\39\\{eq\_level}(\|p))$;\2\2\6
$\\{eq\_level}(\|p)\K\\{cur\_level}$;\5
$\\{eq\_type}(\|p)\K\|t$;\5
$\\{equiv}(\|p)\K\|e$;\5
$\\{assign\_trace}(\|p,\39\.{"into"})$\6
\4\\{exit}: \37\&{end};\par
\fi

\M300. The counterpart of \\{eq\_define} for the remaining (fullword) positions
in
\\{eqtb} is called \\{eq\_word\_define}. Since $\\{xeq\_level}[\|p]\G\\{level%
\_one}$ for all
\|p, a `\\{restore\_zero}' will never be used in this case.

\Y\P\4\&{procedure}\1\  \37$\\{eq\_word\_define}(\|p:\\{pointer};\,\35\|w:%
\\{integer})$;\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{if} $\\{eTeX\_ex}\W(\\{eqtb}[\|p].\\{int}=\|w)$ \1\&{then}\6
\&{begin} \37$\\{assign\_trace}(\|p,\39\.{"reassigning"})$\6
\&{return};\6
\&{end};\2\6
$\\{assign\_trace}(\|p,\39\.{"changing"})$\6
\&{if} $\\{xeq\_level}[\|p]\I\\{cur\_level}$ \1\&{then}\6
\&{begin} \37$\\{eq\_save}(\|p,\39\\{xeq\_level}[\|p])$;\5
$\\{xeq\_level}[\|p]\K\\{cur\_level}$;\6
\&{end};\2\6
$\\{eqtb}[\|p].\\{int}\K\|w$;\5
$\\{assign\_trace}(\|p,\39\.{"into"})$\6
\4\\{exit}: \37\&{end};\par
\fi

\M301. The \\{eq\_define} and \\{eq\_word\_define} routines take care of local
definitions.
Global definitions are done in almost the same way, but there is no need
to save old values, and the new value is associated with \\{level\_one}.

\Y\P\4\&{procedure}\1\  \37$\\{geq\_define}(\|p:\\{pointer};\,\35\|t:%
\\{quarterword};\,\35\|e:\\{halfword})$;\C{global \\{eq\_define}}\2\6
\&{begin} \37$\\{assign\_trace}(\|p,\39\.{"globally\ changing"})$\6
\&{begin} \37$\\{eq\_destroy}(\\{eqtb}[\|p])$;\5
$\\{eq\_level}(\|p)\K\\{level\_one}$;\5
$\\{eq\_type}(\|p)\K\|t$;\5
$\\{equiv}(\|p)\K\|e$;\6
\&{end};\5
$\\{assign\_trace}(\|p,\39\.{"into"})$\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{geq\_word\_define}(\|p:\\{pointer};\,\35\|w:%
\\{integer})$;\C{global \\{eq\_word\_define}}\2\6
\&{begin} \37$\\{assign\_trace}(\|p,\39\.{"globally\ changing"})$\6
\&{begin} \37$\\{eqtb}[\|p].\\{int}\K\|w$;\5
$\\{xeq\_level}[\|p]\K\\{level\_one}$;\6
\&{end};\5
$\\{assign\_trace}(\|p,\39\.{"into"})$\6
\&{end};\par
\fi

\M302. Subroutine \\{save\_for\_after} puts a token on the stack for
save-keeping.

\Y\P\4\&{procedure}\1\  \37$\\{save\_for\_after}(\|t:\\{halfword})$;\2\6
\&{begin} \37\&{if} $\\{cur\_level}>\\{level\_one}$ \1\&{then}\6
\&{begin} \37\\{check\_full\_save\_stack};\5
$\\{save\_type}(\\{save\_ptr})\K\\{insert\_token}$;\5
$\\{save\_level}(\\{save\_ptr})\K\\{level\_zero}$;\5
$\\{save\_index}(\\{save\_ptr})\K\|t$;\5
$\\{incr}(\\{save\_ptr})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M303. The \\{unsave} routine goes the other way, taking items off of \\{save%
\_stack}.
This routine takes care of restoration when a level ends; everything
belonging to the topmost group is cleared off of the save stack.

\Y\P\4\&{procedure}\1\  \37\\{back\_input};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{unsave};\C{pops the top level off the save stack}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\|p: \37\\{pointer};\C{position to be restored}\6
\|l: \37\\{quarterword};\C{saved level, if in fullword regions of \\{eqtb}}\6
\|t: \37\\{halfword};\C{saved value of \\{cur\_tok}}\6
\|a: \37\\{boolean};\C{have we already processed an \.{\\aftergroup} ?}\2\6
\&{begin} \37$\|a\K\\{false}$;\6
\&{if} $\\{cur\_level}>\\{level\_one}$ \1\&{then}\6
\&{begin} \37$\\{decr}(\\{cur\_level})$;\5
\X304:Clear off top level from \\{save\_stack}\X;\6
\&{end}\6
\4\&{else} $\\{confusion}(\.{"curlevel"})$;\C{\\{unsave} is not used when $%
\\{cur\_group}=\\{bottom\_level}$}\2\6
\&{end};\par
\fi

\M304. \P$\X304:Clear off top level from \\{save\_stack}\X\S$\6
\~ \1\&{loop}\ \&{begin} \37$\\{decr}(\\{save\_ptr})$;\6
\&{if} $\\{save\_type}(\\{save\_ptr})=\\{level\_boundary}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|p\K\\{save\_index}(\\{save\_ptr})$;\6
\&{if} $\\{save\_type}(\\{save\_ptr})=\\{insert\_token}$ \1\&{then}\5
\X348:Insert token \|p into \TeX's input\X\6
\4\&{else} \&{if} $\\{save\_type}(\\{save\_ptr})=\\{restore\_sa}$ \1\&{then}\6
\&{begin} \37\\{sa\_restore};\5
$\\{sa\_chain}\K\|p$;\5
$\\{sa\_level}\K\\{save\_level}(\\{save\_ptr})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{save\_type}(\\{save\_ptr})=\\{restore\_old%
\_value}$ \1\&{then}\6
\&{begin} \37$\|l\K\\{save\_level}(\\{save\_ptr})$;\5
$\\{decr}(\\{save\_ptr})$;\6
\&{end}\6
\4\&{else} $\\{save\_stack}[\\{save\_ptr}]\K\\{eqtb}[\\{undefined\_control%
\_sequence}]$;\2\6
\X305:Store \(s)$\\{save\_stack}[\\{save\_ptr}]$ in $\\{eqtb}[\|p]$, unless $%
\\{eqtb}[\|p]$ holds a global value\X;\6
\&{end};\2\2\6
\&{end};\2\6
\4\\{done}: \37\&{stat} \37\&{if} $\\{tracing\_groups}>0$ \1\&{then}\5
$\\{group\_trace}(\\{true})$;\ \2\6
\&{tats}\6
\&{if} $\\{grp\_stack}[\\{in\_open}]=\\{cur\_boundary}$ \1\&{then}\5
\\{group\_warning};\C{groups possibly not properly nested with files}\2\6
$\\{cur\_group}\K\\{save\_level}(\\{save\_ptr})$;\5
$\\{cur\_boundary}\K\\{save\_index}(\\{save\_ptr})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
$\\{decr}(\\{save\_ptr})$\2\par
\U303.\fi

\M305. A global definition, which sets the level to \\{level\_one},
will not be undone by \\{unsave}. If at least one global definition of
$\\{eqtb}[\|p]$ has been carried out within the group that just ended, the
last such definition will therefore survive.

\Y\P$\4\X305:Store \(s)$\\{save\_stack}[\\{save\_ptr}]$ in $\\{eqtb}[\|p]$,
unless $\\{eqtb}[\|p]$ holds a global value\X\S$\6
\&{if} $\|p<\\{int\_base}$ \1\&{then}\6
\&{if} $\\{eq\_level}(\|p)=\\{level\_one}$ \1\&{then}\6
\&{begin} \37$\\{eq\_destroy}(\\{save\_stack}[\\{save\_ptr}])$;\C{destroy the
saved value}\6
\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}\5
$\\{restore\_trace}(\|p,\39\.{"retaining"})$;\ \2\6
\&{tats}\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{eq\_destroy}(\\{eqtb}[\|p])$;\C{destroy the current
value}\6
$\\{eqtb}[\|p]\K\\{save\_stack}[\\{save\_ptr}]$;\C{restore the saved value}\6
\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}\5
$\\{restore\_trace}(\|p,\39\.{"restoring"})$;\ \2\6
\&{tats}\6
\&{end}\2\6
\4\&{else} \&{if} $\\{xeq\_level}[\|p]\I\\{level\_one}$ \1\&{then}\6
\&{begin} \37$\\{eqtb}[\|p]\K\\{save\_stack}[\\{save\_ptr}]$;\5
$\\{xeq\_level}[\|p]\K\|l$;\6
\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}\5
$\\{restore\_trace}(\|p,\39\.{"restoring"})$;\ \2\6
\&{tats}\6
\&{end}\6
\4\&{else} \&{begin} \37\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}%
\5
$\\{restore\_trace}(\|p,\39\.{"retaining"})$;\ \2\6
\&{tats}\6
\&{end}\2\2\par
\U304.\fi

\M306. \P$\X306:Declare \eTeX\ procedures for tracing and input\X\S$\6
\&{stat} \37\&{procedure}\1\  \37$\\{restore\_trace}(\|p:\\{pointer};\,\35\|s:%
\\{str\_number})$;\C{$\\{eqtb}[\|p]$ has just been restored or retained}\2\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_char}(\.{"\{"})$;\5
$\\{print}(\|s)$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{show\_eqtb}(\|p)$;\5
$\\{print\_char}(\.{"\}"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\6
\&{tats}\par
\As1661, 1662, 1756, 1757, 1774, 1776, 1777, 1821, 1823, 1837, 1838, 1839, 1840%
\ETs1841.
\U290.\fi

\M307. When looking for possible pointers to a memory location, it is helpful
to look for references from \\{eqtb} that might be waiting on the
save stack. Of course, we might find spurious pointers too; but this
routine is merely an aid when debugging, and at such times we are
grateful for any scraps of information, even if they prove to be irrelevant.

\Y\P$\4\X307:Search \\{save\_stack} for equivalents that point to \|p\X\S$\6
\&{if} $\\{save\_ptr}>0$ \1\&{then}\6
\&{for} $\|q\K0\mathrel{\&{to}}\\{save\_ptr}-1$ \1\&{do}\6
\&{begin} \37\&{if} $\\{equiv\_field}(\\{save\_stack}[\|q])=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"SAVE("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{end}\2\2\par
\U190.\fi

\M308. Most of the parameters kept in \\{eqtb} can be changed freely, but
there's
an exception:  The magnification should not be used with two different
values during any \TeX\ job, since a single magnification is applied to an
entire run. The global variable \\{mag\_set} is set to the current
magnification
whenever it becomes necessary to ``freeze'' it at a particular value.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{mag\_set}: \37\\{integer};\C{if nonzero, this magnification should be used
henceforth}\par
\fi

\M309. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{mag\_set}\K0$;\par
\fi

\M310. The \\{prepare\_mag} subroutine is called whenever \TeX\ wants to use %
\\{mag}
for magnification.

\Y\P\4\&{procedure}\1\  \37\\{prepare\_mag};\2\6
\&{begin} \37\&{if} $(\\{mag\_set}>0)\W(\\{mag}\I\\{mag\_set})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Incompatible\ magnification\ ("})$;\5
$\\{print\_int}(\\{mag})$;\5
$\\{print}(\.{");"})$;\5
$\\{print\_nl}(\.{"\ the\ previous\ value\ will\ be\ retained"})$;\5
$\\{help2}(\.{"I\ can\ handle\ only\ one\ magnification\ ratio\ per\ job.\ So\
I\'ve"})$\6
$(\.{"reverted\ to\ the\ magnification\ you\ used\ earlier\ on\ this\ run."})$;%
\6
$\\{int\_error}(\\{mag\_set})$;\5
$\\{geq\_word\_define}(\\{int\_base}+\\{mag\_code},\39\\{mag\_set})$;\C{$%
\\{mag}\K\\{mag\_set}$}\6
\&{end};\2\6
\&{if} $(\\{mag}\L0)\V(\\{mag}>32768)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ magnification\ has\ been\ changed\ to%
\ 1000"})$;\6
$\\{help1}(\.{"The\ magnification\ ratio\ must\ be\ between\ 1\ and\
32768."})$;\5
$\\{int\_error}(\\{mag})$;\5
$\\{geq\_word\_define}(\\{int\_base}+\\{mag\_code},\391000)$;\6
\&{end};\2\6
$\\{mag\_set}\K\\{mag}$;\6
\&{end};\par
\fi

\N311.  \[20] Token lists.
A \TeX\ token is either a character or a control sequence, and it is
represented internally in one of two ways: (1)~A character whose ASCII
code number is \|c and whose command code is \|m is represented as the
number $2^8m+c$; the command code is in the range $1\L\|m\L14$. (2)~A control
sequence whose \\{eqtb} address is \|p is represented as the number
$\\{cs\_token\_flag}+\|p$. Here $\\{cs\_token\_flag}=\hbox{$2^{12}-1$}$ is
larger than
$2^8m+c$, yet it is small enough that $\\{cs\_token\_flag}+\|p<\\{max%
\_halfword}$;
thus, a token fits comfortably in a halfword.

A token \|t represents a \\{left\_brace} command if and only if
$\|t<\\{left\_brace\_limit}$; it represents a \\{right\_brace} command if and
only if
we have $\\{left\_brace\_limit}\L\|t<\\{right\_brace\_limit}$; and it
represents a \\{match} or
\\{end\_match} command if and only if $\\{match\_token}\L\|t\L\\{end\_match%
\_token}$.
The following definitions take care of these token-oriented constants
and a few others.

\Y\P\D \37$\\{cs\_token\_flag}\S\O{7777}$\C{amount added to the \\{eqtb}
location in a   token that stands for a control sequence; is a multiple of~256,
less~1}\par
\P\D \37$\\{left\_brace\_token}=\O{0400}$\C{$2^8\cdot\\{left\_brace}$}\par
\P\D \37$\\{left\_brace\_limit}=\O{1000}$\C{$2^8\cdot(\\{left\_brace}+1)$}\par
\P\D \37$\\{right\_brace\_token}=\O{1000}$\C{$2^8\cdot\\{right\_brace}$}\par
\P\D \37$\\{right\_brace\_limit}=\O{1400}$\C{$2^8\cdot(\\{right\_brace}+1)$}\par
\P\D \37$\\{math\_shift\_token}=\O{1400}$\C{$2^8\cdot\\{math\_shift}$}\par
\P\D \37$\\{tab\_token}=\O{2000}$\C{$2^8\cdot\\{tab\_mark}$}\par
\P\D \37$\\{out\_param\_token}=\O{2400}$\C{$2^8\cdot\\{out\_param}$}\par
\P\D \37$\\{space\_token}=\O{5040}$\C{$2^8\cdot\\{spacer}+\.{"\ "}$}\par
\P\D \37$\\{letter\_token}=\O{5400}$\C{$2^8\cdot\\{letter}$}\par
\P\D \37$\\{other\_token}=\O{6000}$\C{$2^8\cdot\\{other\_char}$}\par
\P\D \37$\\{match\_token}=\O{6400}$\C{$2^8\cdot\\{match}$}\par
\P\D \37$\\{end\_match\_token}=\O{7000}$\C{$2^8\cdot\\{end\_match}$}\par
\P\D \37$\\{protected\_token}=\O{7001}$\C{$2^8\cdot\\{end\_match}+1$}\par
\fi

\M312. \P$\X14:Check the ``constant'' values for consistency\X\mathrel{+}\S$\6
\&{if} $\\{cs\_token\_flag}+\\{undefined\_control\_sequence}>\\{max\_halfword}$
\1\&{then}\5
$\\{bad}\K21$;\2\par
\fi

\M313. A token list is a singly linked list of one-word nodes in \\{mem}, where
each word contains a token and a link. Macro definitions, output-routine
definitions, marks, \.{\\write} texts, and a few other things
are remembered by \TeX\ in the form
of token lists, usually preceded by a node with a reference count in its
\\{token\_ref\_count} field. The token stored in location \|p is called
$\\{info}(\|p)$.

Three special commands appear in the token lists of macro definitions.
When $\|m=\\{match}$, it means that \TeX\ should scan a parameter
for the current macro; when $\|m=\\{end\_match}$, it means that parameter
matching should end and \TeX\ should start reading the macro text; and
when $\|m=\\{out\_param}$, it means that \TeX\ should insert parameter
number \|c into the text at this point.

The enclosing \.{\char'173} and \.{\char'175} characters of a macro
definition are omitted, but an output routine
will be enclosed in braces.

Here is an example macro definition that illustrates these conventions.
After \TeX\ processes the text
$$\.{\\def\\mac a\#1\#2 \\b \{\#1\\-a \#\#1\#2 \#2\}}$$
the definition of \.{\\mac} is represented as a token list containing
$$\def\,{\hskip2pt}
\vbox{\halign{\hfil#\hfil\cr
(reference count), \\{letter}\,\.a, \\{match}\,\#, \\{match}\,\#, \\{spacer}\,%
\.\ ,
\.{\\b}, \\{end\_match},\cr
\\{out\_param}\,1, \.{\\-}, \\{letter}\,\.a, \\{spacer}\,\.\ , \\{mac\_param}\,%
\#,
\\{other\_char}\,\.1,\cr
\\{out\_param}\,2, \\{spacer}\,\.\ , \\{out\_param}\,2.\cr}}$$
The procedure \\{scan\_toks} builds such token lists, and \\{macro\_call}
does the parameter matching.

Examples such as
$$\.{\\def\\m\{\\def\\m\{a\}\ b\}}$$
explain why reference counts would be needed even if \TeX\ had no \.{\\let}
operation: When the token list for \.{\\m} is being read, the redefinition of
\.{\\m} changes the \\{eqtb} entry before the token list has been fully
consumed, so we dare not simply destroy a token list when its
control sequence is being redefined.

If the parameter-matching part of a definition ends with `\.{\#\{}',
the corresponding token list will have `\.\{' just before the `\\{end\_match}'
and also at the very end. The first `\.\{' is used to delimit the parameter;
the
second one keeps the first from disappearing.

\fi

\M314. The procedure \\{show\_token\_list}, which prints a symbolic form of
the token list that starts at a given node \|p, illustrates these
conventions. The token list being displayed should not begin with a reference
count. However, the procedure is intended to be robust, so that if the
memory links are awry or if \|p is not really a pointer to a token list,
nothing catastrophic will happen.

An additional parameter \|q is also given; this parameter is either null
or it points to a node in the token list where a certain magic computation
takes place that will be explained later. (Basically, \|q is non-null when
we are printing the two-line context information at the time of an error
message; \|q marks the place corresponding to where the second line
should begin.)

For example, if \|p points to the node containing the first \.a in the
token list above, then \\{show\_token\_list} will print the string
$$\hbox{`\.{a\#1\#2\ \\b\ ->\#1\\-a\ \#\#1\#2\ \#2}';}$$
and if \|q points to the node containing the second \.a,
the magic computation will be performed just before the second \.a is printed.

The generation will stop, and `\.{\\ETC.}' will be printed, if the length
of printing exceeds a given limit~\|l. Anomalous entries are printed in the
form of control sequences that are not followed by a blank space, e.g.,
`\.{\\BAD.}'; this cannot be confused with actual control sequences because
a real control sequence named \.{BAD} would come out `\.{\\BAD\ }'.

\Y\P$\4\X314:Declare the procedure called \\{show\_token\_list}\X\S$\6
\4\&{procedure}\1\  \37$\\{show\_token\_list}(\|p,\39\|q:\\{integer};\,\35\|l:%
\\{integer})$;\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37$\|m,\39\|c$: \37\\{integer};\C{pieces of a token}\6
\\{match\_chr}: \37\\{ASCII\_code};\C{character used in a `\\{match}'}\6
\|n: \37\\{ASCII\_code};\C{the highest parameter number, as an ASCII digit}\2\6
\&{begin} \37$\\{match\_chr}\K\.{"\#"}$;\5
$\|n\K\.{"0"}$;\5
$\\{tally}\K0$;\6
\&{while} $(\|p\I\\{null})\W(\\{tally}<\|l)$ \1\&{do}\6
\&{begin} \37\&{if} $\|p=\|q$ \1\&{then}\5
\X342:Do magic computation\X;\2\6
\X315:Display token \|p, and \&{return} if there are problems\X;\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{print\_esc}(\.{"ETC."})$;\2\6
\4\\{exit}: \37\&{end};\par
\U137.\fi

\M315. \P$\X315:Display token \|p, and \&{return} if there are problems\X\S$\6
\&{if} $(\|p<\\{hi\_mem\_min})\V(\|p>\\{mem\_end})$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"CLOBBERED."})$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{info}(\|p)\G\\{cs\_token\_flag}$ \1\&{then}\5
$\\{print\_cs}(\\{info}(\|p)-\\{cs\_token\_flag})$\6
\4\&{else} \&{begin} \37$\|m\K\\{info}(\|p)\mathbin{\&{div}}\O{400}$;\5
$\|c\K\\{info}(\|p)\mathbin{\&{mod}}\O{400}$;\6
\&{if} $\\{info}(\|p)<0$ \1\&{then}\5
$\\{print\_esc}(\.{"BAD."})$\6
\4\&{else} \X316:Display the token $(\|m,\|c)$\X;\2\6
\&{end}\2\par
\U314.\fi

\M316. The procedure usually ``learns'' the character code used for macro
parameters by seeing one in a \\{match} command before it runs into any
\\{out\_param} commands.

\Y\P$\4\X316:Display the token $(\|m,\|c)$\X\S$\6
\&{case} $\|m$ \1\&{of}\6
\4$\\{left\_brace},\39\\{right\_brace},\39\\{math\_shift},\39\\{tab\_mark},\39%
\\{sup\_mark},\39\\{sub\_mark},\39\\{spacer},\39\\{letter},\39\\{other\_char}$:
\37$\\{print}(\|c)$;\6
\4\\{mac\_param}: \37\&{begin} \37$\\{print}(\|c)$;\5
$\\{print}(\|c)$;\6
\&{end};\6
\4\\{out\_param}: \37\&{begin} \37$\\{print}(\\{match\_chr})$;\6
\&{if} $\|c\L9$ \1\&{then}\5
$\\{print\_char}(\|c+\.{"0"})$\6
\4\&{else} \&{begin} \37$\\{print\_char}(\.{"!"})$;\5
\&{return};\6
\&{end};\2\6
\&{end};\6
\4\\{match}: \37\&{begin} \37$\\{match\_chr}\K\|c$;\5
$\\{print}(\|c)$;\5
$\\{incr}(\|n)$;\5
$\\{print\_char}(\|n)$;\6
\&{if} $\|n>\.{"9"}$ \1\&{then}\5
\&{return};\2\6
\&{end};\6
\4\\{end\_match}: \37\&{if} $\|c=0$ \1\&{then}\5
$\\{print}(\.{"->"})$;\6
\4\&{othercases} $\\{print\_esc}(\.{"BAD."})$\2\2\6
\&{endcases}\par
\U315.\fi

\M317. Here's the way we sometimes want to display a token list, given a
pointer
to its reference count; the pointer may be null.

\Y\P\4\&{procedure}\1\  \37$\\{token\_show}(\|p:\\{pointer})$;\2\6
\&{begin} \37\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{show\_token\_list}(\\{link}(\|p),\39\\{null},\3910000000)$;\2\6
\&{end};\par
\fi

\M318. The \\{print\_meaning} subroutine displays \\{cur\_cmd} and \\{cur\_chr}
in
symbolic form, including the expansion of a macro or mark.

\Y\P\4\&{procedure}\1\  \37\\{print\_meaning};\2\6
\&{begin} \37$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\6
\&{if} $\\{cur\_cmd}\G\\{call}$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{":"})$;\5
\\{print\_ln};\5
$\\{token\_show}(\\{cur\_chr})$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{cur\_cmd}=\\{top\_bot\_mark})\W(\\{cur\_chr}<\\{marks%
\_code})$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{":"})$;\5
\\{print\_ln};\5
$\\{token\_show}(\\{cur\_mark}[\\{cur\_chr}])$;\6
\&{end};\2\2\6
\&{end};\par
\fi

\N319.  \[21] Introduction to the syntactic routines.
Let's pause a moment now and try to look at the Big Picture.
The \TeX\ program consists of three main parts: syntactic routines,
semantic routines, and output routines. The chief purpose of the
syntactic routines is to deliver the user's input to the semantic routines,
one token at a time. The semantic routines act as an interpreter
responding to these tokens, which may be regarded as commands. And the
output routines are periodically called on to convert box-and-glue
lists into a compact set of instructions that will be sent
to a typesetter. We have discussed the basic data structures and utility
routines of \TeX, so we are good and ready to plunge into the real activity by
considering the syntactic routines.

Our current goal is to come to grips with the \\{get\_next} procedure,
which is the keystone of \TeX's input mechanism. Each call of \\{get\_next}
sets the value of three variables \\{cur\_cmd}, \\{cur\_chr}, and \\{cur\_cs},
representing the next input token.
$$\vbox{\halign{#\hfil\cr
\hbox{\\{cur\_cmd} denotes a command code from the long list of codes
given above;}\cr
\hbox{\\{cur\_chr} denotes a character code or other modifier of the command
code;}\cr
\hbox{\\{cur\_cs} is the \\{eqtb} location of the current control sequence,}\cr
\hbox{\qquad if the current token was a control sequence,
otherwise it's zero.}\cr}}$$
Underlying this external behavior of \\{get\_next} is all the machinery
necessary to convert from character files to tokens. At a given time we
may be only partially finished with the reading of several files (for
which \.{\\input} was specified), and partially finished with the expansion
of some user-defined macros and/or some macro parameters, and partially
finished with the generation of some text in a template for \.{\\halign},
and so on. When reading a character file, special characters must be
classified as math delimiters, etc.; comments and extra blank spaces must
be removed, paragraphs must be recognized, and control sequences must be
found in the hash table. Furthermore there are occasions in which the
scanning routines have looked ahead for a word like `\.{plus}' but only
part of that word was found, hence a few characters must be put back
into the input and scanned again.

To handle these situations, which might all be present simultaneously,
\TeX\ uses various stacks that hold information about the incomplete
activities, and there is a finite state control for each level of the
input mechanism. These stacks record the current state of an implicitly
recursive process, but the \\{get\_next} procedure is not recursive.
Therefore it will not be difficult to translate these algorithms into
low-level languages that do not support recursion.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_cmd}: \37\\{eight\_bits};\C{current command set by \\{get\_next}}\6
\4\\{cur\_chr}: \37\\{halfword};\C{operand of current command}\6
\4\\{cur\_cs}: \37\\{pointer};\C{control sequence found here, zero if none
found}\6
\4\\{cur\_tok}: \37\\{halfword};\C{packed representative of \\{cur\_cmd} and %
\\{cur\_chr}}\par
\fi

\M320. The \\{print\_cmd\_chr} routine prints a symbolic interpretation of a
command code and its modifier. This is used in certain `\.{You can\'t}'
error messages, and in the implementation of diagnostic routines like
\.{\\show}.

The body of \\{print\_cmd\_chr} is a rather tedious listing of print
commands, and most of it is essentially an inverse to the \\{primitive}
routine that enters a \TeX\ primitive into \\{eqtb}. Therefore much of
this procedure appears elsewhere in the program,
together with the corresponding \\{primitive} calls.

\Y\P\D \37$\\{chr\_cmd}(\#)\S$\1\6
\&{begin} \37$\\{print}(\#)$;\5
$\\{print\_ASCII}(\\{chr\_code})$;\6
\&{end}\2\par
\Y\P$\4\X320:Declare the procedure called \\{print\_cmd\_chr}\X\S$\6
\4\&{procedure}\1\  \37$\\{print\_cmd\_chr}(\\{cmd}:\\{quarterword};\,\35\\{chr%
\_code}:\\{halfword})$;\6
\4\&{var} \37\|n: \37\\{integer};\C{temp variable}\2\6
\&{begin} \37\&{case} $\\{cmd}$ \1\&{of}\6
\4\\{left\_brace}: \37$\\{chr\_cmd}(\.{"begin-group\ character\ "})$;\6
\4\\{right\_brace}: \37$\\{chr\_cmd}(\.{"end-group\ character\ "})$;\6
\4\\{math\_shift}: \37$\\{chr\_cmd}(\.{"math\ shift\ character\ "})$;\6
\4\\{mac\_param}: \37$\\{chr\_cmd}(\.{"macro\ parameter\ character\ "})$;\6
\4\\{sup\_mark}: \37$\\{chr\_cmd}(\.{"superscript\ character\ "})$;\6
\4\\{sub\_mark}: \37$\\{chr\_cmd}(\.{"subscript\ character\ "})$;\6
\4\\{endv}: \37$\\{print}(\.{"end\ of\ alignment\ template"})$;\6
\4\\{spacer}: \37$\\{chr\_cmd}(\.{"blank\ space\ "})$;\6
\4\\{letter}: \37$\\{chr\_cmd}(\.{"the\ letter\ "})$;\6
\4\\{other\_char}: \37$\\{chr\_cmd}(\.{"the\ character\ "})$;\6
\hbox{\4}\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of primitives%
\X\6
\4\&{othercases} \37$\\{print}(\.{"[unknown\ command\ code!]"})$\2\6
\&{endcases};\6
\&{end};\par
\U270.\fi

\M321. Here is a procedure that displays the current command.

\Y\P\4\&{procedure}\1\  \37\\{show\_cur\_cmd\_chr};\6
\4\&{var} \37\|n: \37\\{integer};\C{level of \.{\\if...\\fi} nesting}\6
\|l: \37\\{integer};\C{line where \.{\\if} started}\6
\|p: \37\\{pointer};\2\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"\{"})$;\6
\&{if} $\\{mode}\I\\{shown\_mode}$ \1\&{then}\6
\&{begin} \37$\\{print\_mode}(\\{mode})$;\5
$\\{print}(\.{":\ "})$;\5
$\\{shown\_mode}\K\\{mode}$;\6
\&{end};\2\6
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\6
\&{if} $\\{tracing\_ifs}>0$ \1\&{then}\6
\&{if} $\\{cur\_cmd}\G\\{if\_test}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}\L\\{fi\_or\_else}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{":\ "})$;\6
\&{if} $\\{cur\_cmd}=\\{fi\_or\_else}$ \1\&{then}\6
\&{begin} \37$\\{print\_cmd\_chr}(\\{if\_test},\39\\{cur\_if})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\|n\K0$;\5
$\|l\K\\{if\_line}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|n\K1$;\5
$\|l\K\\{line}$;\6
\&{end};\2\6
$\|p\K\\{cond\_ptr}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{incr}(\|n)$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{print}(\.{"(level\ "})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print\_char}(\.{")"})$;\5
$\\{print\_if\_line}(\|l)$;\6
\&{end};\2\2\2\6
$\\{print\_char}(\.{"\}"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\par
\fi

\N322.  \[22] Input stacks and states.
This implementation of
\TeX\ uses two different conventions for representing sequential stacks.

\yskip\hangg 1) If there is frequent access to the top entry, and if the
stack is essentially never empty, then the top entry is kept in a global
variable (even better would be a machine register), and the other entries
appear in the array $\\{stack}[0\to(\\{ptr}-1)]$. For example, the
semantic stack described above is handled this way, and so is the input
stack that we are about to study.

\yskip\hangg 2) If there is infrequent top access, the entire stack contents
are in the array $\\{stack}[0\to(\\{ptr}-1)]$. For example, the \\{save\_stack}
is treated this way, as we have seen.

\yskip\noindent
The state of \TeX's input mechanism appears in the input stack, whose
entries are records with six fields, called \\{state}, \\{index}, \\{start}, %
\\{loc},
\\{limit}, and \\{name}. This stack is maintained with
convention~(1), so it is declared in the following way:

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{in\_state\_record}=$\1\5
\1\&{record} \37$\\{state\_field},\39\\{index\_field}$: \37\\{quarterword};\6
\4$\\{start\_field},\39\\{loc\_field},\39\\{limit\_field},\39\\{name\_field}$: %
\37\\{halfword};\2\6
\&{end};\2\par
\fi

\M323. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{input\_stack}: \37\&{array} $[0\to\\{stack\_size}]$ \1\&{of}\5
\\{in\_state\_record};\2\6
\4\\{input\_ptr}: \37$0\to\\{stack\_size}$;\C{first unused location of \\{input%
\_stack}}\6
\4\\{max\_in\_stack}: \37$0\to\\{stack\_size}$;\C{largest value of \\{input%
\_ptr} when pushing}\6
\4\\{cur\_input}: \37\\{in\_state\_record};\C{the ``top'' input state,
according to convention (1)}\par
\fi

\M324. We've already defined the special variable $\\{loc}\S\\{cur\_input}.%
\\{loc\_field}$
in our discussion of basic input-output routines. The other components of
\\{cur\_input} are defined in the same way:

\Y\P\D \37$\\{state}\S\\{cur\_input}.\\{state\_field}$\C{current scanner state}%
\par
\P\D \37$\\{index}\S\\{cur\_input}.\\{index\_field}$\C{reference for buffer
information}\par
\P\D \37$\\{start}\S\\{cur\_input}.\\{start\_field}$\C{starting position in %
\\{buffer}}\par
\P\D \37$\\{limit}\S\\{cur\_input}.\\{limit\_field}$\C{end of current line in %
\\{buffer}}\par
\P\D \37$\\{name}\S\\{cur\_input}.\\{name\_field}$\C{name of the current file}%
\par
\fi

\M325. Let's look more closely now at the control variables
(\\{state},~\\{index},~\\{start},~\\{loc},~\\{limit},~\\{name}),
assuming that \TeX\ is reading a line of characters that have been input
from some file or from the user's terminal. There is an array called
\\{buffer} that acts as a stack of all lines of characters that are
currently being read from files, including all lines on subsidiary
levels of the input stack that are not yet completed. \TeX\ will return to
the other lines when it is finished with the present input file.

(Incidentally, on a machine with byte-oriented addressing, it might be
appropriate to combine \\{buffer} with the \\{str\_pool} array,
letting the buffer entries grow downward from the top of the string pool
and checking that these two tables don't bump into each other.)

The line we are currently working on begins in position \\{start} of the
buffer; the next character we are about to read is $\\{buffer}[\\{loc}]$; and
\\{limit} is the location of the last character present.  If $\\{loc}>%
\\{limit}$,
the line has been completely read. Usually $\\{buffer}[\\{limit}]$ is the
\\{end\_line\_char}, denoting the end of a line, but this is not
true if the current line is an insertion that was entered on the user's
terminal in response to an error message.

The \\{name} variable is a string number that designates the name of
the current file, if we are reading a text file. It is zero if we
are reading from the terminal; it is $\|n+1$ if we are reading from
input stream \|n, where $0\L\|n\L16$. (Input stream 16 stands for
an invalid stream number; in such cases the input is actually from
the terminal, under control of the procedure \\{read\_toks}.)
Finally $18\L\\{name}\L19$ indicates that we are reading a pseudo file
created by the \.{\\scantokens} command.

The \\{state} variable has one of three values, when we are scanning such
files:
$$\baselineskip 15pt\vbox{\halign{#\hfil\cr
1) $\\{state}=\\{mid\_line}$ is the normal state.\cr
2) $\\{state}=\\{skip\_blanks}$ is like \\{mid\_line}, but blanks are ignored.%
\cr
3) $\\{state}=\\{new\_line}$ is the state at the beginning of a line.\cr}}$$
These state values are assigned numeric codes so that if we add the state
code to the next character's command code, we get distinct values. For
example, `$\\{mid\_line}+\\{spacer}$' stands for the case that a blank
space character occurs in the middle of a line when it is not being
ignored; after this case is processed, the next value of \\{state} will
be \\{skip\_blanks}.

\Y\P\D \37$\\{mid\_line}=1$\C{\\{state} code when scanning a line of
characters}\par
\P\D \37$\\{skip\_blanks}=2+\\{max\_char\_code}$\C{\\{state} code when ignoring
blanks}\par
\P\D \37$\\{new\_line}=3+\\{max\_char\_code}+\\{max\_char\_code}$\C{\\{state}
code at start of line}\par
\fi

\M326. Additional information about the current line is available via the
\\{index} variable, which counts how many lines of characters are present
in the buffer below the current level. We have $\\{index}=0$ when reading
from the terminal and prompting the user for each line; then if the user types,
e.g., `\.{\\input paper}', we will have $\\{index}=1$ while reading
the file \.{paper.tex}. However, it does not follow that \\{index} is the
same as the input stack pointer, since many of the levels on the input
stack may come from token lists. For example, the instruction `\.{\\input
paper}' might occur in a token list.

The global variable \\{in\_open} is equal to the \\{index}
value of the highest non-token-list level. Thus, the number of partially read
lines in the buffer is $\\{in\_open}+1$, and we have $\\{in\_open}=\\{index}$
when we are not reading a token list.

If we are not currently reading from the terminal, or from an input
stream, we are reading from the file variable $\\{input\_file}[\\{index}]$. We
use
the notation \\{terminal\_input} as a convenient abbreviation for $\\{name}=0$,
and \\{cur\_file} as an abbreviation for $\\{input\_file}[\\{index}]$.

The global variable \\{line} contains the line number in the topmost
open file, for use in error messages. If we are not reading from
the terminal, $\\{line\_stack}[\\{index}]$ holds the line number for the
enclosing level, so that \\{line} can be restored when the current
file has been read. Line numbers should never be negative, since the
negative of the current line number is used to identify the user's output
routine in the \\{mode\_line} field of the semantic nest entries.

If more information about the input state is needed, it can be
included in small arrays like those shown here. For example,
the current page or segment number in the input file might be
put into a variable \\{page}, maintained for enclosing levels in
`\ignorespaces \\{page\_stack}: \&{array} $[1\to\\{max\_in\_open}]$ \&{of} %
\\{integer}\unskip'
by analogy with \\{line\_stack}.

\Y\P\D \37$\\{terminal\_input}\S(\\{name}=0)$\C{are we reading from the
terminal?}\par
\P\D \37$\\{cur\_file}\S\\{input\_file}[\\{index}]$\C{the current \\{alpha%
\_file} variable}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{in\_open}: \37$0\to\\{max\_in\_open}$;\C{the number of lines in the
buffer, less one}\6
\4\\{open\_parens}: \37$0\to\\{max\_in\_open}$;\C{the number of open text
files}\6
\4\\{input\_file}: \37\&{array} $[1\to\\{max\_in\_open}]$ \1\&{of}\5
\\{alpha\_file};\2\6
\4\\{line}: \37\\{integer};\C{current line number in the current source file}\6
\4\\{line\_stack}: \37\&{array} $[1\to\\{max\_in\_open}]$ \1\&{of}\5
\\{integer};\2\par
\fi

\M327. Users of \TeX\ sometimes forget to balance left and right braces
properly,
and one of the ways \TeX\ tries to spot such errors is by considering an
input file as broken into subfiles by control sequences that
are declared to be \.{\\outer}.

A variable called \\{scanner\_status} tells \TeX\ whether or not to complain
when a subfile ends. This variable has six possible values:

\yskip\hang\\{normal}, means that a subfile can safely end here without
incident.

\yskip\hang\\{skipping}, means that a subfile can safely end here, but not a
file,
because we're reading past some conditional text that was not selected.

\yskip\hang\\{defining}, means that a subfile shouldn't end now because a
macro is being defined.

\yskip\hang\\{matching}, means that a subfile shouldn't end now because a
macro is being used and we are searching for the end of its arguments.

\yskip\hang\\{aligning}, means that a subfile shouldn't end now because we are
not finished with the preamble of an \.{\\halign} or \.{\\valign}.

\yskip\hang\\{absorbing}, means that a subfile shouldn't end now because we are
reading a balanced token list for \.{\\message}, \.{\\write}, etc.

\yskip\noindent
If the \\{scanner\_status} is not \\{normal}, the variable \\{warning\_index}
points
to the \\{eqtb} location for the relevant control sequence name to print
in an error message.

\Y\P\D \37$\\{skipping}=1$\C{\\{scanner\_status} when passing conditional text}%
\par
\P\D \37$\\{defining}=2$\C{\\{scanner\_status} when reading a macro definition}%
\par
\P\D \37$\\{matching}=3$\C{\\{scanner\_status} when reading macro arguments}\par
\P\D \37$\\{aligning}=4$\C{\\{scanner\_status} when reading an alignment
preamble}\par
\P\D \37$\\{absorbing}=5$\C{\\{scanner\_status} when reading a balanced text}%
\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{scanner\_status}: \37$\\{normal}\to\\{absorbing}$;\C{can a subfile end
now?}\6
\4\\{warning\_index}: \37\\{pointer};\C{identifier relevant to non-\\{normal}
scanner status}\6
\4\\{def\_ref}: \37\\{pointer};\C{reference count of token list being defined}%
\par
\fi

\M328. Here is a procedure that uses \\{scanner\_status} to print a warning
message
when a subfile has ended, and at certain other crucial times:

\Y\P$\4\X328:Declare the procedure called \\{runaway}\X\S$\6
\4\&{procedure}\1\  \37\\{runaway};\6
\4\&{var} \37\|p: \37\\{pointer};\C{head of runaway list}\2\6
\&{begin} \37\&{if} $\\{scanner\_status}>\\{skipping}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Runaway\ "})$;\6
\&{case} $\\{scanner\_status}$ \1\&{of}\6
\4\\{defining}: \37\&{begin} \37$\\{print}(\.{"definition"})$;\5
$\|p\K\\{def\_ref}$;\6
\&{end};\6
\4\\{matching}: \37\&{begin} \37$\\{print}(\.{"argument"})$;\5
$\|p\K\\{temp\_head}$;\6
\&{end};\6
\4\\{aligning}: \37\&{begin} \37$\\{print}(\.{"preamble"})$;\5
$\|p\K\\{hold\_head}$;\6
\&{end};\6
\4\\{absorbing}: \37\&{begin} \37$\\{print}(\.{"text"})$;\5
$\|p\K\\{def\_ref}$;\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
$\\{print\_char}(\.{"?"})$;\5
\\{print\_ln};\5
$\\{show\_token\_list}(\\{link}(\|p),\39\\{null},\39\\{error\_line}-10)$;\6
\&{end};\2\6
\&{end};\par
\U137.\fi

\M329. However, all this discussion about input state really applies only to
the
case that we are inputting from a file. There is another important case,
namely when we are currently getting input from a token list. In this case
$\\{state}=\\{token\_list}$, and the conventions about the other state
variables
are different:

\yskip\hang\\{loc} is a pointer to the current node in the token list, i.e.,
the node that will be read next. If $\\{loc}=\\{null}$, the token list has been
fully read.

\yskip\hang\\{start} points to the first node of the token list; this node
may or may not contain a reference count, depending on the type of token
list involved.

\yskip\hang\\{token\_type}, which takes the place of \\{index} in the
discussion above, is a code number that explains what kind of token list
is being scanned.

\yskip\hang\\{name} points to the \\{eqtb} address of the control sequence
being expanded, if the current token list is a macro.

\yskip\hang\\{param\_start}, which takes the place of \\{limit}, tells where
the parameters of the current macro begin in the \\{param\_stack}, if the
current token list is a macro.

\yskip\noindent The \\{token\_type} can take several values, depending on
where the current token list came from:

\yskip\hang\\{parameter}, if a parameter is being scanned;

\hang\\{u\_template}, if the \<u_j> part of an alignment
template is being scanned;

\hang\\{v\_template}, if the \<v_j> part of an alignment
template is being scanned;

\hang\\{backed\_up}, if the token list being scanned has been inserted as
`to be read again';

\hang\\{inserted}, if the token list being scanned has been inserted as
the text expansion of a \.{\\count} or similar variable;

\hang\\{macro}, if a user-defined control sequence is being scanned;

\hang\\{output\_text}, if an \.{\\output} routine is being scanned;

\hang\\{every\_par\_text}, if the text of \.{\\everypar} is being scanned;

\hang\\{every\_math\_text}, if the text of \.{\\everymath} is being scanned;

\hang\\{every\_display\_text}, if the text of \.{\\everydisplay} is being
scanned;

\hang\\{every\_hbox\_text}, if the text of \.{\\everyhbox} is being scanned;

\hang\\{every\_vbox\_text}, if the text of \.{\\everyvbox} is being scanned;

\hang\\{every\_job\_text}, if the text of \.{\\everyjob} is being scanned;

\hang\\{every\_cr\_text}, if the text of \.{\\everycr} is being scanned;

\hang\\{mark\_text}, if the text of a \.{\\mark} is being scanned;

\hang\\{write\_text}, if the text of a \.{\\write} is being scanned.

\yskip\noindent
The codes for \\{output\_text}, \\{every\_par\_text}, etc., are equal to a
constant
plus the corresponding codes for token list parameters \\{output\_routine%
\_loc},
\\{every\_par\_loc}, etc.  The token list begins with a reference count if and
only if $\\{token\_type}\G\\{macro}$.

Since \eTeX's additional token list parameters precede \\{toks\_base}, the
corresponding token types must precede \\{write\_text}.

\Y\P\D \37$\\{token\_list}=0$\C{\\{state} code when scanning a token list}\par
\P\D \37$\\{token\_type}\S\\{index}$\C{type of current token list}\par
\P\D \37$\\{param\_start}\S\\{limit}$\C{base of macro parameters in \\{param%
\_stack}}\par
\P\D \37$\\{parameter}=0$\C{\\{token\_type} code for parameter}\par
\P\D \37$\\{u\_template}=1$\C{\\{token\_type} code for \<u_j> template}\par
\P\D \37$\\{v\_template}=2$\C{\\{token\_type} code for \<v_j> template}\par
\P\D \37$\\{backed\_up}=3$\C{\\{token\_type} code for text to be reread}\par
\P\D \37$\\{inserted}=4$\C{\\{token\_type} code for inserted texts}\par
\P\D \37$\\{macro}=5$\C{\\{token\_type} code for defined control sequences}\par
\P\D \37$\\{output\_text}=6$\C{\\{token\_type} code for output routines}\par
\P\D \37$\\{every\_par\_text}=7$\C{\\{token\_type} code for \.{\\everypar}}\par
\P\D \37$\\{every\_math\_text}=8$\C{\\{token\_type} code for \.{\\everymath}}%
\par
\P\D \37$\\{every\_display\_text}=9$\C{\\{token\_type} code for \.{%
\\everydisplay}}\par
\P\D \37$\\{every\_hbox\_text}=10$\C{\\{token\_type} code for \.{\\everyhbox}}%
\par
\P\D \37$\\{every\_vbox\_text}=11$\C{\\{token\_type} code for \.{\\everyvbox}}%
\par
\P\D \37$\\{every\_job\_text}=12$\C{\\{token\_type} code for \.{\\everyjob}}\par
\P\D \37$\\{every\_cr\_text}=13$\C{\\{token\_type} code for \.{\\everycr}}\par
\P\D \37$\\{mark\_text}=14$\C{\\{token\_type} code for \.{\\topmark}, etc.}\Y%
\par
\P\D \37$\\{eTeX\_text\_offset}=\\{output\_routine\_loc}-\\{output\_text}$\par
\P\D \37$\\{every\_eof\_text}=\\{every\_eof\_loc}-\\{eTeX\_text\_offset}$\C{%
\\{token\_type} code for \.{\\everyeof}}\Y\par
\P\D \37$\\{write\_text}=\\{toks\_base}-\\{eTeX\_text\_offset}$\C{\\{token%
\_type} code for \.{\\write}}\par
\fi

\M330. The \\{param\_stack} is an auxiliary array used to hold pointers to the
token
lists for parameters at the current level and subsidiary levels of input.
This stack is maintained with convention (2), and it grows at a different
rate from the others.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{param\_stack}: \37\&{array} $[0\to\\{param\_size}]$ \1\&{of}\5
\\{pointer};\C{token list pointers for parameters}\2\6
\4\\{param\_ptr}: \37$0\to\\{param\_size}$;\C{first unused entry in \\{param%
\_stack}}\6
\4\\{max\_param\_stack}: \37\\{integer};\C{largest value of \\{param\_ptr},
will be $\L\\{param\_size}+9$}\par
\fi

\M331. The input routines must also interact with the processing of
\.{\\halign} and \.{\\valign}, since the appearance of tab marks and
\.{\\cr} in certain places is supposed to trigger the beginning of special
\<v_j> template text in the scanner. This magic is accomplished by an
\\{align\_state} variable that is increased by~1 when a `\.{\char'173}' is
scanned and decreased by~1 when a `\.{\char'175}' is scanned. The \\{align%
\_state}
is nonzero during the \<u_j> template, after which it is set to zero; the
\<v_j> template begins when a tab mark or \.{\\cr} occurs at a time that
$\\{align\_state}=0$.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{align\_state}: \37\\{integer};\C{group level with respect to current
alignment}\par
\fi

\M332. Thus, the ``current input state'' can be very complicated indeed; there
can be many levels and each level can arise in a variety of ways. The
\\{show\_context} procedure, which is used by \TeX's error-reporting routine to
print out the current input state on all levels down to the most recent
line of characters from an input file, illustrates most of these conventions.
The global variable \\{base\_ptr} contains the lowest level that was
displayed by this procedure.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{base\_ptr}: \37$0\to\\{stack\_size}$;\C{shallowest level shown by \\{show%
\_context}}\par
\fi

\M333. The status at each level is indicated by printing two lines, where the
first
line indicates what was read so far and the second line shows what remains
to be read. The context is cropped, if necessary, so that the first line
contains at most \\{half\_error\_line} characters, and the second contains
at most \\{error\_line}. Non-current input levels whose \\{token\_type} is
`\\{backed\_up}' are shown only if they have not been fully read.

\Y\P\4\&{procedure}\1\  \37\\{show\_context};\C{prints where the scanner is}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{saved \\{selector}
setting}\6
\\{nn}: \37\\{integer};\C{number of contexts shown so far, less one}\6
\\{bottom\_line}: \37\\{boolean};\C{have we reached the final context to be
shown?}\6
\X337:Local variables for formatting calculations\X\2\6
\&{begin} \37$\\{base\_ptr}\K\\{input\_ptr}$;\5
$\\{input\_stack}[\\{base\_ptr}]\K\\{cur\_input}$;\C{store current state}\6
$\\{nn}\K-1$;\5
$\\{bottom\_line}\K\\{false}$;\6
\~ \1\&{loop}\ \&{begin} \37$\\{cur\_input}\K\\{input\_stack}[\\{base\_ptr}]$;%
\C{enter into the context}\6
\&{if} $(\\{state}\I\\{token\_list})$ \1\&{then}\6
\&{if} $(\\{name}>19)\V(\\{base\_ptr}=0)$ \1\&{then}\5
$\\{bottom\_line}\K\\{true}$;\2\2\6
\&{if} $(\\{base\_ptr}=\\{input\_ptr})\V\\{bottom\_line}\V(\\{nn}<\\{error%
\_context\_lines})$ \1\&{then}\5
\X334:Display the current context\X\6
\4\&{else} \&{if} $\\{nn}=\\{error\_context\_lines}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"..."})$;\5
$\\{incr}(\\{nn})$;\C{omitted if $\\{error\_context\_lines}<0$}\6
\&{end};\2\2\6
\&{if} $\\{bottom\_line}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\\{decr}(\\{base\_ptr})$;\6
\&{end};\2\6
\4\\{done}: \37$\\{cur\_input}\K\\{input\_stack}[\\{input\_ptr}]$;\C{restore
original state}\6
\&{end};\par
\fi

\M334. \P$\X334:Display the current context\X\S$\6
\&{begin} \37\&{if} $(\\{base\_ptr}=\\{input\_ptr})\V(\\{state}\I\\{token%
\_list})\V(\\{token\_type}\I\\{backed\_up})\V(\\{loc}\I\\{null})$ \1\&{then}%
\C{we omit backed-up token lists that have already been read}\6
\&{begin} \37$\\{tally}\K0$;\C{get ready to count characters}\6
$\\{old\_setting}\K\\{selector}$;\6
\&{if} $\\{state}\I\\{token\_list}$ \1\&{then}\6
\&{begin} \37\X335:Print location of current line\X;\6
\X340:Pseudoprint the line\X;\6
\&{end}\6
\4\&{else} \&{begin} \37\X336:Print type of token list\X;\6
\X341:Pseudoprint the token list\X;\6
\&{end};\2\6
$\\{selector}\K\\{old\_setting}$;\C{stop pseudoprinting}\6
\X339:Print two lines using the tricky pseudoprinted information\X;\6
$\\{incr}(\\{nn})$;\6
\&{end};\2\6
\&{end}\par
\U333.\fi

\M335. This routine should be changed, if necessary, to give the best possible
indication of where the current line resides in the input file.
For example, on some systems it is best to print both a page and line number.

\Y\P$\4\X335:Print location of current line\X\S$\6
\&{if} $\\{name}\L17$ \1\&{then}\6
\&{if} $\\{terminal\_input}$ \1\&{then}\6
\&{if} $\\{base\_ptr}=0$ \1\&{then}\5
$\\{print\_nl}(\.{"<*>"})$\6
\4\&{else} $\\{print\_nl}(\.{"<insert>\ "})$\2\6
\4\&{else} \&{begin} \37$\\{print\_nl}(\.{"<read\ "})$;\6
\&{if} $\\{name}=17$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\ \&{else} $\\{print\_int}(\\{name}-1)$;\2\6
$\\{print\_char}(\.{">"})$;\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\\{print\_nl}(\.{"l."})$;\6
\&{if} $\\{index}=\\{in\_open}$ \1\&{then}\5
$\\{print\_int}(\\{line})$\6
\4\&{else} $\\{print\_int}(\\{line\_stack}[\\{index}+1])$;\C{input from a
pseudo file}\2\6
\&{end};\2\6
$\\{print\_char}(\.{"\ "})$\par
\U334.\fi

\M336. \P$\X336:Print type of token list\X\S$\6
\&{case} $\\{token\_type}$ \1\&{of}\6
\4\\{parameter}: \37$\\{print\_nl}(\.{"<argument>\ "})$;\6
\4$\\{u\_template},\39\\{v\_template}$: \37$\\{print\_nl}(\.{"<template>\ "})$;%
\6
\4\\{backed\_up}: \37\&{if} $\\{loc}=\\{null}$ \1\&{then}\5
$\\{print\_nl}(\.{"<recently\ read>\ "})$\6
\4\&{else} $\\{print\_nl}(\.{"<to\ be\ read\ again>\ "})$;\2\6
\4\\{inserted}: \37$\\{print\_nl}(\.{"<inserted\ text>\ "})$;\6
\4\\{macro}: \37\&{begin} \37\\{print\_ln};\5
$\\{print\_cs}(\\{name})$;\6
\&{end};\6
\4\\{output\_text}: \37$\\{print\_nl}(\.{"<output>\ "})$;\6
\4\\{every\_par\_text}: \37$\\{print\_nl}(\.{"<everypar>\ "})$;\6
\4\\{every\_math\_text}: \37$\\{print\_nl}(\.{"<everymath>\ "})$;\6
\4\\{every\_display\_text}: \37$\\{print\_nl}(\.{"<everydisplay>\ "})$;\6
\4\\{every\_hbox\_text}: \37$\\{print\_nl}(\.{"<everyhbox>\ "})$;\6
\4\\{every\_vbox\_text}: \37$\\{print\_nl}(\.{"<everyvbox>\ "})$;\6
\4\\{every\_job\_text}: \37$\\{print\_nl}(\.{"<everyjob>\ "})$;\6
\4\\{every\_cr\_text}: \37$\\{print\_nl}(\.{"<everycr>\ "})$;\6
\4\\{mark\_text}: \37$\\{print\_nl}(\.{"<mark>\ "})$;\6
\4\\{every\_eof\_text}: \37$\\{print\_nl}(\.{"<everyeof>\ "})$;\6
\4\\{write\_text}: \37$\\{print\_nl}(\.{"<write>\ "})$;\6
\4\&{othercases} \37$\\{print\_nl}(\.{"?"})$\C{this should never happen}\2\6
\&{endcases}\par
\U334.\fi

\M337. Here it is necessary to explain a little trick. We don't want to store a
long
string that corresponds to a token list, because that string might take up
lots of memory; and we are printing during a time when an error message is
being given, so we dare not do anything that might overflow one of \TeX's
tables. So `pseudoprinting' is the answer: We enter a mode of printing
that stores characters into a buffer of length \\{error\_line}, where character
$k+1$ is placed into \hbox{$\\{trick\_buf}[\|k\mathbin{\&{mod}}\\{error%
\_line}]$} if
$\|k<\\{trick\_count}$, otherwise character \|k is dropped. Initially we set
$\\{tally}\K0$ and $\\{trick\_count}\K1000000$; then when we reach the
point where transition from line 1 to line 2 should occur, we
set $\\{first\_count}\K\\{tally}$ and $\\{trick\_count}\K\hbox{max}(\\{error%
\_line},\\{tally}+1+\\{error\_line}-\\{half\_error\_line})$. At the end of the
pseudoprinting, the values of \\{first\_count}, \\{tally}, and
\\{trick\_count} give us all the information we need to print the two lines,
and all of the necessary text is in \\{trick\_buf}.

Namely, let \|l be the length of the descriptive information that appears
on the first line. The length of the context information gathered for that
line is $\|k=\\{first\_count}$, and the length of the context information
gathered for line~2 is $m=\min(\\{tally}, \\{trick\_count})-k$. If $\|l+\|k\L%
\|h$,
where $\|h=\\{half\_error\_line}$, we print $\\{trick\_buf}[0\to\|k-1]$ after
the
descriptive information on line~1, and set $\|n\K\|l+\|k$; here \|n is the
length of line~1. If $l+k>h$, some cropping is necessary, so we set $\|n\K\|h$
and print `\.{...}' followed by
$$\hbox{$\\{trick\_buf}[(\|l+\|k-\|h+3)\to\|k-1]$,}$$
where subscripts of \\{trick\_buf} are circular modulo \\{error\_line}. The
second line consists of \|n~spaces followed by $\\{trick\_buf}[\|k\to(\|k+%
\|m-1)]$,
unless $\|n+\|m>\\{error\_line}$; in the latter case, further cropping is done.
This is easier to program than to explain.

\Y\P$\4\X337:Local variables for formatting calculations\X\S$\6
\4\|i: \37$0\to\\{buf\_size}$;\C{index into \\{buffer}}\6
\4\|j: \37$0\to\\{buf\_size}$;\C{end of current line in \\{buffer}}\6
\4\|l: \37$0\to\\{half\_error\_line}$;\C{length of descriptive information on
line 1}\6
\4\|m: \37\\{integer};\C{context information gathered for line 2}\6
\4\|n: \37$0\to\\{error\_line}$;\C{length of line 1}\6
\4\|p: \37\\{integer};\C{starting or ending place in \\{trick\_buf}}\6
\4\|q: \37\\{integer};\C{temporary index}\par
\U333.\fi

\M338. The following code sets up the print routines so that they will gather
the desired information.

\Y\P\D \37$\\{begin\_pseudoprint}\S$\1\6
\&{begin} \37$\|l\K\\{tally}$;\5
$\\{tally}\K0$;\5
$\\{selector}\K\\{pseudo}$;\5
$\\{trick\_count}\K1000000$;\6
\&{end}\2\par
\P\D \37$\\{set\_trick\_count}\S$\1\6
\&{begin} \37$\\{first\_count}\K\\{tally}$;\5
$\\{trick\_count}\K\\{tally}+1+\\{error\_line}-\\{half\_error\_line}$;\6
\&{if} $\\{trick\_count}<\\{error\_line}$ \1\&{then}\5
$\\{trick\_count}\K\\{error\_line}$;\2\6
\&{end}\2\par
\fi

\M339. And the following code uses the information after it has been gathered.

\Y\P$\4\X339:Print two lines using the tricky pseudoprinted information\X\S$\6
\&{if} $\\{trick\_count}=1000000$ \1\&{then}\5
\\{set\_trick\_count};\C{\\{set\_trick\_count} must be performed}\2\6
\&{if} $\\{tally}<\\{trick\_count}$ \1\&{then}\5
$\|m\K\\{tally}-\\{first\_count}$\6
\4\&{else} $\|m\K\\{trick\_count}-\\{first\_count}$;\C{context on line 2}\2\6
\&{if} $\|l+\\{first\_count}\L\\{half\_error\_line}$ \1\&{then}\6
\&{begin} \37$\|p\K0$;\5
$\|n\K\|l+\\{first\_count}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"..."})$;\5
$\|p\K\|l+\\{first\_count}-\\{half\_error\_line}+3$;\5
$\|n\K\\{half\_error\_line}$;\6
\&{end};\2\6
\&{for} $\|q\K\|p\mathrel{\&{to}}\\{first\_count}-1$ \1\&{do}\5
$\\{print\_char}(\\{trick\_buf}[\|q\mathbin{\&{mod}}\\{error\_line}])$;\2\6
\\{print\_ln};\6
\&{for} $\|q\K1\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{print\_char}(\.{"\ "})$;\C{print \|n spaces to begin line~2}\2\6
\&{if} $\|m+\|n\L\\{error\_line}$ \1\&{then}\5
$\|p\K\\{first\_count}+\|m$\6
\4\&{else} $\|p\K\\{first\_count}+(\\{error\_line}-\|n-3)$;\2\6
\&{for} $\|q\K\\{first\_count}\mathrel{\&{to}}\|p-1$ \1\&{do}\5
$\\{print\_char}(\\{trick\_buf}[\|q\mathbin{\&{mod}}\\{error\_line}])$;\2\6
\&{if} $\|m+\|n>\\{error\_line}$ \1\&{then}\5
$\\{print}(\.{"..."})$\2\par
\U334.\fi

\M340. But the trick is distracting us from our current goal, which is to
understand the input state. So let's concentrate on the data structures that
are being pseudoprinted as we finish up the \\{show\_context} procedure.

\Y\P$\4\X340:Pseudoprint the line\X\S$\6
\\{begin\_pseudoprint};\6
\&{if} $\\{buffer}[\\{limit}]=\\{end\_line\_char}$ \1\&{then}\5
$\|j\K\\{limit}$\6
\4\&{else} $\|j\K\\{limit}+1$;\C{determine the effective end of the line}\2\6
\&{if} $\|j>0$ \1\&{then}\6
\&{for} $\|i\K\\{start}\mathrel{\&{to}}\|j-1$ \1\&{do}\6
\&{begin} \37\&{if} $\|i=\\{loc}$ \1\&{then}\5
\\{set\_trick\_count};\2\6
$\\{print}(\\{buffer}[\|i])$;\6
\&{end}\2\2\par
\U334.\fi

\M341. \P$\X341:Pseudoprint the token list\X\S$\6
\\{begin\_pseudoprint};\6
\&{if} $\\{token\_type}<\\{macro}$ \1\&{then}\5
$\\{show\_token\_list}(\\{start},\39\\{loc},\39100000)$\6
\4\&{else} $\\{show\_token\_list}(\\{link}(\\{start}),\39\\{loc},\39100000)$%
\C{avoid reference count}\2\par
\U334.\fi

\M342. Here is the missing piece of \\{show\_token\_list} that is activated
when the
token beginning line~2 is about to be shown:

\Y\P$\4\X342:Do magic computation\X\S$\6
\\{set\_trick\_count}\par
\U314.\fi

\N343.  \[23] Maintaining the input stacks.
The following subroutines change the input status in commonly needed ways.

First comes \\{push\_input}, which stores the current state and creates a
new level (having, initially, the same properties as the old).

\Y\P\D \37$\\{push\_input}\S\hbox{}$\C{enter a new input level, save the old}\6
\&{begin} \37\&{if} $\\{input\_ptr}>\\{max\_in\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_in\_stack}\K\\{input\_ptr}$;\6
\&{if} $\\{input\_ptr}=\\{stack\_size}$ \1\&{then}\5
$\\{overflow}(\.{"input\ stack\ size"},\39\\{stack\_size})$;\2\6
\&{end};\2\6
$\\{input\_stack}[\\{input\_ptr}]\K\\{cur\_input}$;\C{stack the record}\6
$\\{incr}(\\{input\_ptr})$;\6
\&{end}\par
\fi

\M344. And of course what goes up must come down.

\Y\P\D \37$\\{pop\_input}\S\hbox{}$\C{leave an input level, re-enter the old}\6
\&{begin} \37$\\{decr}(\\{input\_ptr})$;\5
$\\{cur\_input}\K\\{input\_stack}[\\{input\_ptr}]$;\6
\&{end}\par
\fi

\M345. Here is a procedure that starts a new level of token-list input, given
a token list \|p and its type \|t. If $\|t=\\{macro}$, the calling routine
should
set \\{name} and \\{loc}.

\Y\P\D \37$\\{back\_list}(\#)\S\\{begin\_token\_list}(\#,\39\\{backed\_up})$%
\C{backs up a simple token list}\par
\P\D \37$\\{ins\_list}(\#)\S\\{begin\_token\_list}(\#,\39\\{inserted})$%
\C{inserts a simple token list}\par
\Y\P\4\&{procedure}\1\  \37$\\{begin\_token\_list}(\|p:\\{pointer};\,\35\|t:%
\\{quarterword})$;\2\6
\&{begin} \37\\{push\_input};\5
$\\{state}\K\\{token\_list}$;\5
$\\{start}\K\|p$;\5
$\\{token\_type}\K\|t$;\6
\&{if} $\|t\G\\{macro}$ \1\&{then}\C{the token list starts with a reference
count}\6
\&{begin} \37$\\{add\_token\_ref}(\|p)$;\6
\&{if} $\|t=\\{macro}$ \1\&{then}\5
$\\{param\_start}\K\\{param\_ptr}$\6
\4\&{else} \&{begin} \37$\\{loc}\K\\{link}(\|p)$;\6
\&{if} $\\{tracing\_macros}>1$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{""})$;\6
\&{case} $\|t$ \1\&{of}\6
\4\\{mark\_text}: \37$\\{print\_esc}(\.{"mark"})$;\6
\4\\{write\_text}: \37$\\{print\_esc}(\.{"write"})$;\6
\4\&{othercases} \37$\\{print\_cmd\_chr}(\\{assign\_toks},\39\|t-\\{output%
\_text}+\\{output\_routine\_loc})$\2\6
\&{endcases};\6
$\\{print}(\.{"->"})$;\5
$\\{token\_show}(\|p)$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\\{loc}\K\|p$;\2\6
\&{end};\par
\fi

\M346. When a token list has been fully scanned, the following computations
should be done as we leave that level of input. The \\{token\_type} tends
to be equal to either \\{backed\_up} or \\{inserted} about 2/3 of the time.

\Y\P\4\&{procedure}\1\  \37\\{end\_token\_list};\C{leave a token-list input
level}\2\6
\&{begin} \37\&{if} $\\{token\_type}\G\\{backed\_up}$ \1\&{then}\C{token list
to be deleted}\6
\&{begin} \37\&{if} $\\{token\_type}\L\\{inserted}$ \1\&{then}\5
$\\{flush\_list}(\\{start})$\6
\4\&{else} \&{begin} \37$\\{delete\_token\_ref}(\\{start})$;\C{update reference
count}\6
\&{if} $\\{token\_type}=\\{macro}$ \1\&{then}\C{parameters must be flushed}\6
\&{while} $\\{param\_ptr}>\\{param\_start}$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{param\_ptr})$;\5
$\\{flush\_list}(\\{param\_stack}[\\{param\_ptr}])$;\6
\&{end};\2\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{token\_type}=\\{u\_template}$ \1\&{then}\6
\&{if} $\\{align\_state}>500000$ \1\&{then}\5
$\\{align\_state}\K0$\6
\4\&{else} $\\{fatal\_error}(\.{"(interwoven\ alignment\ preambles\ are\ not\
allowed)"})$;\2\2\2\6
\\{pop\_input};\5
\\{check\_interrupt};\6
\&{end};\par
\fi

\M347. Sometimes \TeX\ has read too far and wants to ``unscan'' what it has
seen. The \\{back\_input} procedure takes care of this by putting the token
just scanned back into the input stream, ready to be read again. This
procedure can be used only if \\{cur\_tok} represents the token to be
replaced. Some applications of \TeX\ use this procedure a lot,
so it has been slightly optimized for speed.

\Y\P\4\&{procedure}\1\  \37\\{back\_input};\C{undoes one token of input}\6
\4\&{var} \37\|p: \37\\{pointer};\C{a token list of length one}\2\6
\&{begin} \37\&{while} $(\\{state}=\\{token\_list})\W(\\{loc}=\\{null})\W(%
\\{token\_type}\I\\{v\_template})$ \1\&{do}\5
\\{end\_token\_list};\C{conserve stack space}\2\6
$\|p\K\\{get\_avail}$;\5
$\\{info}(\|p)\K\\{cur\_tok}$;\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\5
$\\{decr}(\\{align\_state})$\6
\4\&{else} $\\{incr}(\\{align\_state})$;\2\2\6
\\{push\_input};\5
$\\{state}\K\\{token\_list}$;\5
$\\{start}\K\|p$;\5
$\\{token\_type}\K\\{backed\_up}$;\5
$\\{loc}\K\|p$;\C{that was $\\{back\_list}(\|p)$, without procedure overhead}\6
\&{end};\par
\fi

\M348. \P$\X348:Insert token \|p into \TeX's input\X\S$\6
\&{begin} \37$\|t\K\\{cur\_tok}$;\5
$\\{cur\_tok}\K\|p$;\6
\&{if} $\|a$ \1\&{then}\6
\&{begin} \37$\|p\K\\{get\_avail}$;\5
$\\{info}(\|p)\K\\{cur\_tok}$;\5
$\\{link}(\|p)\K\\{loc}$;\5
$\\{loc}\K\|p$;\5
$\\{start}\K\|p$;\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\5
$\\{decr}(\\{align\_state})$\6
\4\&{else} $\\{incr}(\\{align\_state})$;\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\\{back\_input};\5
$\|a\K\\{eTeX\_ex}$;\6
\&{end};\2\6
$\\{cur\_tok}\K\|t$;\6
\&{end}\par
\U304.\fi

\M349. The \\{back\_error} routine is used when we want to replace an offending
token
just before issuing an error message. This routine, like \\{back\_input},
requires that \\{cur\_tok} has been set. We disable interrupts during the
call of \\{back\_input} so that the help message won't be lost.

\Y\P\4\&{procedure}\1\  \37\\{back\_error};\C{back up one token and call %
\\{error}}\2\6
\&{begin} \37$\\{OK\_to\_interrupt}\K\\{false}$;\5
\\{back\_input};\5
$\\{OK\_to\_interrupt}\K\\{true}$;\5
\\{error};\6
\&{end};\7
\4\&{procedure}\1\  \37\\{ins\_error};\C{back up one inserted token and call %
\\{error}}\2\6
\&{begin} \37$\\{OK\_to\_interrupt}\K\\{false}$;\5
\\{back\_input};\5
$\\{token\_type}\K\\{inserted}$;\5
$\\{OK\_to\_interrupt}\K\\{true}$;\5
\\{error};\6
\&{end};\par
\fi

\M350. The \\{begin\_file\_reading} procedure starts a new level of input for
lines
of characters to be read from a file, or as an insertion from the
terminal. It does not take care of opening the file, nor does it set \\{loc}
or \\{limit} or \\{line}.

\Y\P\4\&{procedure}\1\  \37\\{begin\_file\_reading};\2\6
\&{begin} \37\&{if} $\\{in\_open}=\\{max\_in\_open}$ \1\&{then}\5
$\\{overflow}(\.{"text\ input\ levels"},\39\\{max\_in\_open})$;\2\6
\&{if} $\\{first}=\\{buf\_size}$ \1\&{then}\5
$\\{overflow}(\.{"buffer\ size"},\39\\{buf\_size})$;\2\6
$\\{incr}(\\{in\_open})$;\5
\\{push\_input};\5
$\\{index}\K\\{in\_open}$;\5
$\\{eof\_seen}[\\{index}]\K\\{false}$;\5
$\\{grp\_stack}[\\{index}]\K\\{cur\_boundary}$;\5
$\\{if\_stack}[\\{index}]\K\\{cond\_ptr}$;\5
$\\{line\_stack}[\\{index}]\K\\{line}$;\5
$\\{start}\K\\{first}$;\5
$\\{state}\K\\{mid\_line}$;\5
$\\{name}\K0$;\C{\\{terminal\_input} is now \\{true}}\6
\&{end};\par
\fi

\M351. Conversely, the variables must be downdated when such a level of input
is finished:

\Y\P\4\&{procedure}\1\  \37\\{end\_file\_reading};\2\6
\&{begin} \37$\\{first}\K\\{start}$;\5
$\\{line}\K\\{line\_stack}[\\{index}]$;\6
\&{if} $(\\{name}=18)\V(\\{name}=19)$ \1\&{then}\5
\\{pseudo\_close}\6
\4\&{else} \&{if} $\\{name}>17$ \1\&{then}\5
$\\{a\_close}(\\{cur\_file})$;\C{forget it}\2\2\6
\\{pop\_input};\5
$\\{decr}(\\{in\_open})$;\6
\&{end};\par
\fi

\M352. In order to keep the stack from overflowing during a long sequence of
inserted `\.{\\show}' commands, the following routine removes completed
error-inserted lines from memory.

\Y\P\4\&{procedure}\1\  \37\\{clear\_for\_error\_prompt};\2\6
\&{begin} \37\&{while} $(\\{state}\I\\{token\_list})\W\\{terminal\_input}\W\30(%
\\{input\_ptr}>0)\W(\\{loc}>\\{limit})$ \1\&{do}\5
\\{end\_file\_reading};\2\6
\\{print\_ln};\5
\\{clear\_terminal};\6
\&{end};\par
\fi

\M353. To get \TeX's whole input mechanism going, we perform the following
actions.

\Y\P$\4\X353:Initialize the input routines\X\S$\6
\&{begin} \37$\\{input\_ptr}\K0$;\5
$\\{max\_in\_stack}\K0$;\5
$\\{in\_open}\K0$;\5
$\\{open\_parens}\K0$;\5
$\\{max\_buf\_stack}\K0$;\5
$\\{grp\_stack}[0]\K0$;\5
$\\{if\_stack}[0]\K\\{null}$;\5
$\\{param\_ptr}\K0$;\5
$\\{max\_param\_stack}\K0$;\5
$\\{first}\K\\{buf\_size}$;\6
\1\&{repeat} \37$\\{buffer}[\\{first}]\K0$;\5
$\\{decr}(\\{first})$;\6
\4\&{until}\5
$\\{first}=0$;\2\6
$\\{scanner\_status}\K\\{normal}$;\5
$\\{warning\_index}\K\\{null}$;\5
$\\{first}\K1$;\5
$\\{state}\K\\{new\_line}$;\5
$\\{start}\K1$;\5
$\\{index}\K0$;\5
$\\{line}\K0$;\5
$\\{name}\K0$;\5
$\\{force\_eof}\K\\{false}$;\5
$\\{align\_state}\K1000000$;\6
\&{if} $\R\\{init\_terminal}$ \1\&{then}\5
\&{goto} \37\\{final\_end};\2\6
$\\{limit}\K\\{last}$;\5
$\\{first}\K\\{last}+1$;\C{\\{init\_terminal} has set \\{loc} and \\{last}}\6
\&{end}\par
\U1517.\fi

\N354.  \[24] Getting the next token.
The heart of \TeX's input mechanism is the \\{get\_next} procedure, which
we shall develop in the next few sections of the program. Perhaps we
shouldn't actually call it the ``heart,'' however, because it really acts
as \TeX's eyes and mouth, reading the source files and gobbling them up.
And it also helps \TeX\ to regurgitate stored token lists that are to be
processed again.

The main duty of \\{get\_next} is to input one token and to set \\{cur\_cmd}
and \\{cur\_chr} to that token's command code and modifier. Furthermore, if
the input token is a control sequence, the \\{eqtb} location of that control
sequence is stored in \\{cur\_cs}; otherwise \\{cur\_cs} is set to zero.

Underlying this simple description is a certain amount of complexity
because of all the cases that need to be handled.
However, the inner loop of \\{get\_next} is reasonably short and fast.

When \\{get\_next} is asked to get the next token of a \.{\\read} line,
it sets $\\{cur\_cmd}=\\{cur\_chr}=\\{cur\_cs}=0$ in the case that no more
tokens
appear on that line. (There might not be any tokens at all, if the
\\{end\_line\_char} has \\{ignore} as its catcode.)

\fi

\M355. The value of \\{par\_loc} is the \\{eqtb} address of `\.{\\par}'. This
quantity
is needed because a blank line of input is supposed to be exactly equivalent
to the appearance of \.{\\par}; we must set $\\{cur\_cs}\K\\{par\_loc}$
when detecting a blank line.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{par\_loc}: \37\\{pointer};\C{location of `\.{\\par}' in \\{eqtb}}\6
\4\\{par\_token}: \37\\{halfword};\C{token representing `\.{\\par}'}\par
\fi

\M356. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"par"},\39\\{par\_end},\39256)$;\C{cf.\ \\{scan\_file\_name}}%
\6
$\\{par\_loc}\K\\{cur\_val}$;\5
$\\{par\_token}\K\\{cs\_token\_flag}+\\{par\_loc}$;\par
\fi

\M357. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{par\_end}: \37$\\{print\_esc}(\.{"par"})$;\par
\fi

\M358. Before getting into \\{get\_next}, let's consider the subroutine that
is called when an `\.{\\outer}' control sequence has been scanned or
when the end of a file has been reached. These two cases are distinguished
by \\{cur\_cs}, which is zero at the end of a file.

\Y\P\4\&{procedure}\1\  \37\\{check\_outer\_validity};\6
\4\&{var} \37\|p: \37\\{pointer};\C{points to inserted token list}\6
\|q: \37\\{pointer};\C{auxiliary pointer}\2\6
\&{begin} \37\&{if} $\\{scanner\_status}\I\\{normal}$ \1\&{then}\6
\&{begin} \37$\\{deletions\_allowed}\K\\{false}$;\5
\X359:Back up an outer control sequence so that it can be reread\X;\6
\&{if} $\\{scanner\_status}>\\{skipping}$ \1\&{then}\5
\X360:Tell the user what has run away and try to recover\X\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Incomplete\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{cur\_if})$;\5
$\\{print}(\.{";\ all\ text\ was\ ignored\ after\ line\ "})$;\5
$\\{print\_int}(\\{skip\_line})$;\5
$\\{help3}(\.{"A\ forbidden\ control\ sequence\ occurred\ in\ skipped\
text."})$\6
$(\.{"This\ kind\ of\ error\ happens\ when\ you\ say\ \`\\if...\'\ and\
forget"})$\6
$(\.{"the\ matching\ \`\\fi\'.\ I\'ve\ inserted\ a\ \`\\fi\';\ this\ might\
work."})$;\6
\&{if} $\\{cur\_cs}\I0$ \1\&{then}\5
$\\{cur\_cs}\K0$\6
\4\&{else} $\\{help\_line}[2]\K\30\.{"The\ file\ ended\ while\ I\ was\ skipping%
\ conditional\ text."}$;\2\6
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_fi}$;\5
\\{ins\_error};\6
\&{end};\2\6
$\\{deletions\_allowed}\K\\{true}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M359. An outer control sequence that occurs in a \.{\\read} will not be
reread,
since the error recovery for \.{\\read} is not very powerful.

\Y\P$\4\X359:Back up an outer control sequence so that it can be reread\X\S$\6
\&{if} $\\{cur\_cs}\I0$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{state}=\\{token\_list})\V(\\{name}<1)\V(\\{name}>17)$ %
\1\&{then}\6
\&{begin} \37$\|p\K\\{get\_avail}$;\5
$\\{info}(\|p)\K\\{cs\_token\_flag}+\\{cur\_cs}$;\5
$\\{back\_list}(\|p)$;\C{prepare to read the control sequence again}\6
\&{end};\2\6
$\\{cur\_cmd}\K\\{spacer}$;\5
$\\{cur\_chr}\K\.{"\ "}$;\C{replace it by a space}\6
\&{end}\2\par
\U358.\fi

\M360. \P$\X360:Tell the user what has run away and try to recover\X\S$\6
\&{begin} \37\\{runaway};\C{print a definition, argument, or preamble}\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{print\_err}(\.{"File\ ended"})$\6
\4\&{else} \&{begin} \37$\\{cur\_cs}\K0$;\5
$\\{print\_err}(\.{"Forbidden\ control\ sequence\ found"})$;\6
\&{end};\2\6
$\\{print}(\.{"\ while\ scanning\ "})$;\5
\X361:Print either `\.{definition}' or `\.{use}' or `\.{preamble}' or `%
\.{text}', and insert tokens that should lead to recovery\X;\6
$\\{print}(\.{"\ of\ "})$;\5
$\\{sprint\_cs}(\\{warning\_index})$;\5
$\\{help4}(\.{"I\ suspect\ you\ have\ forgotten\ a\ \`\}\',\ causing\ me"})$\6
$(\.{"to\ read\ past\ where\ you\ wanted\ me\ to\ stop."})$\6
$(\.{"I\'ll\ try\ to\ recover;\ but\ if\ the\ error\ is\ serious,"})$\6
$(\.{"you\'d\ better\ type\ \`E\'\ or\ \`X\'\ now\ and\ fix\ your\ file."})$;\6
\\{error};\6
\&{end}\par
\U358.\fi

\M361. The recovery procedure can't be fully understood without knowing more
about the \TeX\ routines that should be aborted, but we can sketch the
ideas here:  For a runaway definition or a runaway balanced text
we will insert a right brace; for a
runaway preamble, we will insert a special \.{\\cr} token and a right
brace; and for a runaway argument, we will set \\{long\_state} to
\\{outer\_call} and insert \.{\\par}.

\Y\P$\4\X361:Print either `\.{definition}' or `\.{use}' or `\.{preamble}' or `%
\.{text}', and insert tokens that should lead to recovery\X\S$\6
$\|p\K\\{get\_avail}$;\6
\&{case} $\\{scanner\_status}$ \1\&{of}\6
\4\\{defining}: \37\&{begin} \37$\\{print}(\.{"definition"})$;\5
$\\{info}(\|p)\K\\{right\_brace\_token}+\.{"\}"}$;\6
\&{end};\6
\4\\{matching}: \37\&{begin} \37$\\{print}(\.{"use"})$;\5
$\\{info}(\|p)\K\\{par\_token}$;\5
$\\{long\_state}\K\\{outer\_call}$;\6
\&{end};\6
\4\\{aligning}: \37\&{begin} \37$\\{print}(\.{"preamble"})$;\5
$\\{info}(\|p)\K\\{right\_brace\_token}+\.{"\}"}$;\5
$\|q\K\|p$;\5
$\|p\K\\{get\_avail}$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{info}(\|p)\K\\{cs\_token\_flag}+\\{frozen\_cr}$;\5
$\\{align\_state}\K-1000000$;\6
\&{end};\6
\4\\{absorbing}: \37\&{begin} \37$\\{print}(\.{"text"})$;\5
$\\{info}(\|p)\K\\{right\_brace\_token}+\.{"\}"}$;\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
$\\{ins\_list}(\|p)$\par
\U360.\fi

\M362. We need to mention a procedure here that may be called by \\{get\_next}.

\Y\P\4\&{procedure}\1\  \37\\{firm\_up\_the\_line};\5
\\{forward};\par
\fi

\M363. Now we're ready to take the plunge into \\{get\_next} itself. Parts of
this routine are executed more often than any other instructions of \TeX.

\Y\P\D \37$\\{switch}=25$\C{a label in \\{get\_next}}\par
\P\D \37$\\{start\_cs}=26$\C{another}\par
\Y\P\4\&{procedure}\1\  \37\\{get\_next};\C{sets \\{cur\_cmd}, \\{cur\_chr}, %
\\{cur\_cs} to next token}\6
\4\&{label} \37$\\{restart},\39$\C{go here to get the next input token}\6
$\\{switch},\39$\C{go here to eat the next character from a file}\6
$\\{reswitch},\39$\C{go here to digest it again}\6
$\\{start\_cs},\39$\C{go here to start looking for a control sequence}\6
$\\{found},\39$\C{go here when a control sequence has been found}\6
\\{exit};\C{go here when the next input token has been got}\6
\4\&{var} \37\|k: \37$0\to\\{buf\_size}$;\C{an index into \\{buffer}}\6
\|t: \37\\{halfword};\C{a token}\6
\\{cat}: \37$0\to\\{max\_char\_code}$;\C{$\\{cat\_code}(\\{cur\_chr})$,
usually}\6
$\|c,\39\\{cc}$: \37\\{ASCII\_code};\C{constituents of a possible expanded
code}\6
\|d: \37$2\to3$;\C{number of excess characters in an expanded code}\2\6
\&{begin} \37\\{restart}: \37$\\{cur\_cs}\K0$;\6
\&{if} $\\{state}\I\\{token\_list}$ \1\&{then}\5
\X365:Input from external file, \&{goto} \\{restart} if no input found\X\6
\4\&{else} \X379:Input from token list, \&{goto} \\{restart} if end of list or
if a parameter needs to be expanded\X;\2\6
\X364:If an alignment entry has just ended, take appropriate action\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M364. An alignment entry ends when a tab or \.{\\cr} occurs, provided that the
current level of braces is the same as the level that was present at the
beginning of that alignment entry; i.e., provided that \\{align\_state} has
returned to the value it had after the \<u_j> template for that entry.

\Y\P$\4\X364:If an alignment entry has just ended, take appropriate action\X\S$%
\6
\&{if} $\\{cur\_cmd}\L\\{car\_ret}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}\G\\{tab\_mark}$ \1\&{then}\6
\&{if} $\\{align\_state}=0$ \1\&{then}\5
\X965:Insert the \(v)\<v_j> template and \&{goto} \\{restart}\X\2\2\2\par
\U363.\fi

\M365. \P$\X365:Input from external file, \&{goto} \\{restart} if no input
found\X\S$\6
\&{begin} \37\\{switch}: \37\&{if} $\\{loc}\L\\{limit}$ \1\&{then}\C{current
line not yet finished}\6
\&{begin} \37$\\{cur\_chr}\K\\{buffer}[\\{loc}]$;\5
$\\{incr}(\\{loc})$;\6
\4\\{reswitch}: \37$\\{cur\_cmd}\K\\{cat\_code}(\\{cur\_chr})$;\5
\X366:Change state if necessary, and \&{goto} \\{switch} if the current
character should be ignored, or \&{goto} \\{reswitch} if the current character
changes to another\X;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{state}\K\\{new\_line}$;\6
\X382:Move to next line of file, or \&{goto} \\{restart} if there is no next
line, or \&{return} if a \.{\\read} line has finished\X;\6
\\{check\_interrupt};\5
\&{goto} \37\\{switch};\6
\&{end};\2\6
\&{end}\par
\U363.\fi

\M366. The following 48-way switch accomplishes the scanning quickly, assuming
that a decent \PASCAL\ compiler has translated the code. Note that the numeric
values for \\{mid\_line}, \\{skip\_blanks}, and \\{new\_line} are spaced
apart from each other by $\\{max\_char\_code}+1$, so we can add a character's
command code to the state to get a single number that characterizes both.

\Y\P\D \37$\\{any\_state\_plus}(\#)\S\\{mid\_line}+\#,\39\\{skip\_blanks}+\#,%
\39\\{new\_line}+\#$\par
\Y\P$\4\X366:Change state if necessary, and \&{goto} \\{switch} if the current
character should be ignored, or \&{goto} \\{reswitch} if the current character
changes to another\X\S$\6
\&{case} $\\{state}+\\{cur\_cmd}$ \1\&{of}\6
\4\X367:Cases where character is ignored\X: \37\&{goto} \37\\{switch};\6
\4$\\{any\_state\_plus}(\\{escape})$: \37\X376:Scan a control sequence and set
$\\{state}\K\\{skip\_blanks}$ or \\{mid\_line}\X;\6
\4$\\{any\_state\_plus}(\\{active\_char})$: \37\X375:Process an
active-character control sequence and set $\\{state}\K\\{mid\_line}$\X;\6
\4$\\{any\_state\_plus}(\\{sup\_mark})$: \37\X374:If this \\{sup\_mark} starts
an expanded character like~\.{\^\^A} or~\.{\^\^df}, then \&{goto} \\{reswitch},
otherwise set $\\{state}\K\\{mid\_line}$\X;\6
\4$\\{any\_state\_plus}(\\{invalid\_char})$: \37\X368:Decry the invalid
character and \&{goto} \\{restart}\X;\6
\hbox{\4}\X369:Handle situations involving spaces, braces, changes of state\X\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases}\par
\U365.\fi

\M367. \P$\X367:Cases where character is ignored\X\S$\6
$\\{any\_state\_plus}(\\{ignore}),\39\\{skip\_blanks}+\\{spacer},\39\\{new%
\_line}+\\{spacer}$\par
\U366.\fi

\M368. We go to \\{restart} instead of to \\{switch}, because \\{state} might
equal
\\{token\_list} after the error has been dealt with
(cf.\ \\{clear\_for\_error\_prompt}).

\Y\P$\4\X368:Decry the invalid character and \&{goto} \\{restart}\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Text\ line\ contains\ an\ invalid\
character"})$;\5
$\\{help2}(\.{"A\ funny\ symbol\ that\ I\ can\'t\ read\ has\ just\ been\
input."})$\6
$(\.{"Continue,\ and\ I\'ll\ forget\ that\ it\ ever\ happened."})$;\6
$\\{deletions\_allowed}\K\\{false}$;\5
\\{error};\5
$\\{deletions\_allowed}\K\\{true}$;\5
\&{goto} \37\\{restart};\6
\&{end}\par
\U366.\fi

\M369. \P\D \37$\\{add\_delims\_to}(\#)\S\#+\\{math\_shift},\39\#+\\{tab%
\_mark},\39\#+\\{mac\_param},\39\#+\\{sub\_mark},\39\#+\\{letter},\39\#+%
\\{other\_char}$\par
\Y\P$\4\X369:Handle situations involving spaces, braces, changes of state\X\S$\6
\4$\\{mid\_line}+\\{spacer}$: \37\X371:Enter \\{skip\_blanks} state, emit a
space\X;\6
\4$\\{mid\_line}+\\{car\_ret}$: \37\X370:Finish line, emit a space\X;\6
\4$\\{skip\_blanks}+\\{car\_ret},\39\\{any\_state\_plus}(\\{comment})$: \37%
\X372:Finish line, \&{goto} \\{switch}\X;\6
\4$\\{new\_line}+\\{car\_ret}$: \37\X373:Finish line, emit a \.{\\par}\X;\6
\4$\\{mid\_line}+\\{left\_brace}$: \37$\\{incr}(\\{align\_state})$;\6
\4$\\{skip\_blanks}+\\{left\_brace},\39\\{new\_line}+\\{left\_brace}$: \37%
\&{begin} \37$\\{state}\K\\{mid\_line}$;\5
$\\{incr}(\\{align\_state})$;\6
\&{end};\6
\4$\\{mid\_line}+\\{right\_brace}$: \37$\\{decr}(\\{align\_state})$;\6
\4$\\{skip\_blanks}+\\{right\_brace},\39\\{new\_line}+\\{right\_brace}$: \37%
\&{begin} \37$\\{state}\K\\{mid\_line}$;\5
$\\{decr}(\\{align\_state})$;\6
\&{end};\6
\4$\\{add\_delims\_to}(\\{skip\_blanks}),\39\\{add\_delims\_to}(\\{new%
\_line})$: \37$\\{state}\K\\{mid\_line}$;\par
\U366.\fi

\M370. When a character of type \\{spacer} gets through, its character code is
changed to $\.{"\ "}=\O{40}$. This means that the ASCII codes for tab and
space,
and for the space inserted at the end of a line, will
be treated alike when macro parameters are being matched. We do this
since such characters are indistinguishable on most computer terminal displays.

\Y\P$\4\X370:Finish line, emit a space\X\S$\6
\&{begin} \37$\\{loc}\K\\{limit}+1$;\5
$\\{cur\_cmd}\K\\{spacer}$;\5
$\\{cur\_chr}\K\.{"\ "}$;\6
\&{end}\par
\U369.\fi

\M371. The following code is performed only when $\\{cur\_cmd}=\\{spacer}$.

\Y\P$\4\X371:Enter \\{skip\_blanks} state, emit a space\X\S$\6
\&{begin} \37$\\{state}\K\\{skip\_blanks}$;\5
$\\{cur\_chr}\K\.{"\ "}$;\6
\&{end}\par
\U369.\fi

\M372. \P$\X372:Finish line, \&{goto} \\{switch}\X\S$\6
\&{begin} \37$\\{loc}\K\\{limit}+1$;\5
\&{goto} \37\\{switch};\6
\&{end}\par
\U369.\fi

\M373. \P$\X373:Finish line, emit a \.{\\par}\X\S$\6
\&{begin} \37$\\{loc}\K\\{limit}+1$;\5
$\\{cur\_cs}\K\\{par\_loc}$;\5
$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\6
\&{if} $\\{cur\_cmd}\G\\{outer\_call}$ \1\&{then}\5
\\{check\_outer\_validity};\2\6
\&{end}\par
\U369.\fi

\M374. Notice that a code like \.{\^\^8} becomes \.x if not followed by a hex
digit.

\Y\P\D \37$\\{is\_hex}(\#)\S(((\#\G\.{"0"})\W(\#\L\.{"9"}))\V((\#\G\.{"a"})\W(%
\#\L\.{"f"})))$\par
\P\D \37$\\{hex\_to\_cur\_chr}\S$\1\6
\&{if} $\|c\L\.{"9"}$ \1\&{then}\5
$\\{cur\_chr}\K\|c-\.{"0"}$\ \&{else} $\\{cur\_chr}\K\|c-\.{"a"}+10$;\2\2\6
\&{if} $\\{cc}\L\.{"9"}$ \1\&{then}\5
$\\{cur\_chr}\K16\ast\\{cur\_chr}+\\{cc}-\.{"0"}$\6
\4\&{else} $\\{cur\_chr}\K16\ast\\{cur\_chr}+\\{cc}-\.{"a"}+10$\2\par
\Y\P$\4\X374:If this \\{sup\_mark} starts an expanded character like~\.{\^\^A}
or~\.{\^\^df}, then \&{goto} \\{reswitch}, otherwise set $\\{state}\K\\{mid%
\_line}$\X\S$\6
\&{begin} \37\&{if} $\\{cur\_chr}=\\{buffer}[\\{loc}]$ \1\&{then}\6
\&{if} $\\{loc}<\\{limit}$ \1\&{then}\6
\&{begin} \37$\|c\K\\{buffer}[\\{loc}+1]$;\ \&{if} $\|c<\O{200}$ \1\&{then}%
\C{yes we have an expanded char}\6
\&{begin} \37$\\{loc}\K\\{loc}+2$;\6
\&{if} $\\{is\_hex}(\|c)$ \1\&{then}\6
\&{if} $\\{loc}\L\\{limit}$ \1\&{then}\6
\&{begin} \37$\\{cc}\K\\{buffer}[\\{loc}]$;\ \&{if} $\\{is\_hex}(\\{cc})$ \1%
\&{then}\6
\&{begin} \37$\\{incr}(\\{loc})$;\5
\\{hex\_to\_cur\_chr};\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{end};\2\2\6
\&{if} $\|c<\O{100}$ \1\&{then}\5
$\\{cur\_chr}\K\|c+\O{100}$\ \&{else} $\\{cur\_chr}\K\|c-\O{100}$;\2\6
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{end};\2\2\6
$\\{state}\K\\{mid\_line}$;\6
\&{end}\par
\U366.\fi

\M375. \P$\X375:Process an active-character control sequence and set $\\{state}%
\K\\{mid\_line}$\X\S$\6
\&{begin} \37$\\{cur\_cs}\K\\{cur\_chr}+\\{active\_base}$;\5
$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\5
$\\{state}\K\\{mid\_line}$;\6
\&{if} $\\{cur\_cmd}\G\\{outer\_call}$ \1\&{then}\5
\\{check\_outer\_validity};\2\6
\&{end}\par
\U366.\fi

\M376. Control sequence names are scanned only when they appear in some line of
a file; once they have been scanned the first time, their \\{eqtb} location
serves as a unique identification, so \TeX\ doesn't need to refer to the
original name any more except when it prints the equivalent in symbolic form.

The program that scans a control sequence has been written carefully
in order to avoid the blowups that might otherwise occur if a malicious
user tried something like `\.{\\catcode\'15=0}'. The algorithm might
look at $\\{buffer}[\\{limit}+1]$, but it never looks at $\\{buffer}[%
\\{limit}+2]$.

If expanded characters like `\.{\^\^A}' or `\.{\^\^df}'
appear in or just following
a control sequence name, they are converted to single characters in the
buffer and the process is repeated, slowly but surely.

\Y\P$\4\X376:Scan a control sequence and set $\\{state}\K\\{skip\_blanks}$ or %
\\{mid\_line}\X\S$\6
\&{begin} \37\&{if} $\\{loc}>\\{limit}$ \1\&{then}\5
$\\{cur\_cs}\K\\{null\_cs}$\C{\\{state} is irrelevant in this case}\6
\4\&{else} \&{begin} \37\\{start\_cs}: \37$\|k\K\\{loc}$;\5
$\\{cur\_chr}\K\\{buffer}[\|k]$;\5
$\\{cat}\K\\{cat\_code}(\\{cur\_chr})$;\5
$\\{incr}(\|k)$;\6
\&{if} $\\{cat}=\\{letter}$ \1\&{then}\5
$\\{state}\K\\{skip\_blanks}$\6
\4\&{else} \&{if} $\\{cat}=\\{spacer}$ \1\&{then}\5
$\\{state}\K\\{skip\_blanks}$\6
\4\&{else} $\\{state}\K\\{mid\_line}$;\2\2\6
\&{if} $(\\{cat}=\\{letter})\W(\|k\L\\{limit})$ \1\&{then}\5
\X378:Scan ahead in the buffer until finding a nonletter; if an expanded code
is encountered, reduce it and \&{goto} \\{start\_cs}; otherwise if a
multiletter control sequence is found, adjust \\{cur\_cs} and \\{loc}, and %
\&{goto} \\{found}\X\6
\4\&{else} \X377:If an expanded code is present, reduce it and \&{goto} %
\\{start\_cs}\X;\2\6
$\\{cur\_cs}\K\\{single\_base}+\\{buffer}[\\{loc}]$;\5
$\\{incr}(\\{loc})$;\6
\&{end};\2\6
\4\\{found}: \37$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\6
\&{if} $\\{cur\_cmd}\G\\{outer\_call}$ \1\&{then}\5
\\{check\_outer\_validity};\2\6
\&{end}\par
\U366.\fi

\M377. Whenever we reach the following piece of code, we will have
$\\{cur\_chr}=\\{buffer}[\|k-1]$ and $\|k\L\\{limit}+1$ and $\\{cat}=\\{cat%
\_code}(\\{cur\_chr})$. If an
expanded code like \.{\^\^A} or \.{\^\^df} appears in $\\{buffer}[(\|k-1)\to(%
\|k+1)]$
or $\\{buffer}[(\|k-1)\to(\|k+2)]$, we
will store the corresponding code in $\\{buffer}[\|k-1]$ and shift the rest of
the buffer left two or three places.

\Y\P$\4\X377:If an expanded code is present, reduce it and \&{goto} \\{start%
\_cs}\X\S$\6
\&{begin} \37\&{if} $\\{buffer}[\|k]=\\{cur\_chr}$ \1\&{then}\ \&{if} $\\{cat}=%
\\{sup\_mark}$ \1\&{then}\ \&{if} $\|k<\\{limit}$ \1\&{then}\6
\&{begin} \37$\|c\K\\{buffer}[\|k+1]$;\ \&{if} $\|c<\O{200}$ \1\&{then}\C{yes,
one is indeed present}\6
\&{begin} \37$\|d\K2$;\6
\&{if} $\\{is\_hex}(\|c)$ \1\&{then}\ \&{if} $\|k+2\L\\{limit}$ \1\&{then}\6
\&{begin} \37$\\{cc}\K\\{buffer}[\|k+2]$;\ \&{if} $\\{is\_hex}(\\{cc})$ \1%
\&{then}\5
$\\{incr}(\|d)$;\2\6
\&{end};\2\2\6
\&{if} $\|d>2$ \1\&{then}\6
\&{begin} \37\\{hex\_to\_cur\_chr};\5
$\\{buffer}[\|k-1]\K\\{cur\_chr}$;\6
\&{end}\6
\4\&{else} \&{if} $\|c<\O{100}$ \1\&{then}\5
$\\{buffer}[\|k-1]\K\|c+\O{100}$\6
\4\&{else} $\\{buffer}[\|k-1]\K\|c-\O{100}$;\2\2\6
$\\{limit}\K\\{limit}-\|d$;\5
$\\{first}\K\\{first}-\|d$;\6
\&{while} $\|k\L\\{limit}$ \1\&{do}\6
\&{begin} \37$\\{buffer}[\|k]\K\\{buffer}[\|k+\|d]$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
\&{goto} \37\\{start\_cs};\6
\&{end};\2\6
\&{end};\2\2\2\6
\&{end}\par
\Us376\ET378.\fi

\M378. \P$\X378:Scan ahead in the buffer until finding a nonletter; if an
expanded code is encountered, reduce it and \&{goto} \\{start\_cs}; otherwise
if a multiletter control sequence is found, adjust \\{cur\_cs} and \\{loc}, and
\&{goto} \\{found}\X\S$\6
\&{begin} \37\1\&{repeat} \37$\\{cur\_chr}\K\\{buffer}[\|k]$;\5
$\\{cat}\K\\{cat\_code}(\\{cur\_chr})$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$(\\{cat}\I\\{letter})\V(\|k>\\{limit})$;\2\6
\X377:If an expanded code is present, reduce it and \&{goto} \\{start\_cs}\X;\6
\&{if} $\\{cat}\I\\{letter}$ \1\&{then}\5
$\\{decr}(\|k)$;\C{now \|k points to first nonletter}\2\6
\&{if} $\|k>\\{loc}+1$ \1\&{then}\C{multiletter control sequence has been
scanned}\6
\&{begin} \37$\\{cur\_cs}\K\\{id\_lookup}(\\{loc},\39\|k-\\{loc})$;\5
$\\{loc}\K\|k$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\&{end}\par
\U376.\fi

\M379. Let's consider now what happens when \\{get\_next} is looking at a token
list.

\Y\P$\4\X379:Input from token list, \&{goto} \\{restart} if end of list or if a
parameter needs to be expanded\X\S$\6
\&{if} $\\{loc}\I\\{null}$ \1\&{then}\C{list not exhausted}\6
\&{begin} \37$\|t\K\\{info}(\\{loc})$;\5
$\\{loc}\K\\{link}(\\{loc})$;\C{move to next}\6
\&{if} $\|t\G\\{cs\_token\_flag}$ \1\&{then}\C{a control sequence token}\6
\&{begin} \37$\\{cur\_cs}\K\|t-\\{cs\_token\_flag}$;\5
$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\6
\&{if} $\\{cur\_cmd}\G\\{outer\_call}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}=\\{dont\_expand}$ \1\&{then}\5
\X380:Get the next token, suppressing expansion\X\6
\4\&{else} \\{check\_outer\_validity};\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_cmd}\K\|t\mathbin{\&{div}}\O{400}$;\5
$\\{cur\_chr}\K\|t\mathbin{\&{mod}}\O{400}$;\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4\\{left\_brace}: \37$\\{incr}(\\{align\_state})$;\6
\4\\{right\_brace}: \37$\\{decr}(\\{align\_state})$;\6
\4\\{out\_param}: \37\X381:Insert macro parameter and \&{goto} \\{restart}\X;\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\C{we are done with this token list}\6
\\{end\_token\_list};\5
\&{goto} \37\\{restart};\C{resume previous level}\6
\&{end}\2\par
\U363.\fi

\M380. The present point in the program is reached only when the \\{expand}
routine has inserted a special marker into the input. In this special
case, $\\{info}(\\{loc})$ is known to be a control sequence token, and $%
\\{link}(\\{loc})=\\{null}$.

\Y\P\D \37$\\{no\_expand\_flag}=257$\C{this characterizes a special variant of %
\\{relax}}\par
\Y\P$\4\X380:Get the next token, suppressing expansion\X\S$\6
\&{begin} \37$\\{cur\_cs}\K\\{info}(\\{loc})-\\{cs\_token\_flag}$;\5
$\\{loc}\K\\{null}$;\6
$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\6
\&{if} $\\{cur\_cmd}>\\{max\_command}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{relax}$;\5
$\\{cur\_chr}\K\\{no\_expand\_flag}$;\6
\&{end};\2\6
\&{end}\par
\U379.\fi

\M381. \P$\X381:Insert macro parameter and \&{goto} \\{restart}\X\S$\6
\&{begin} \37$\\{begin\_token\_list}(\\{param\_stack}[\\{param\_start}+\\{cur%
\_chr}-1],\39\\{parameter})$;\5
\&{goto} \37\\{restart};\6
\&{end}\par
\U379.\fi

\M382. All of the easy branches of \\{get\_next} have now been taken care of.
There is one more branch.

\Y\P\D \37$\\{end\_line\_char\_inactive}\S(\\{end\_line\_char}<0)\V(\\{end%
\_line\_char}>255)$\par
\Y\P$\4\X382:Move to next line of file, or \&{goto} \\{restart} if there is no
next line, or \&{return} if a \.{\\read} line has finished\X\S$\6
\&{if} $\\{name}>17$ \1\&{then}\5
\X384:Read next line of file into \\{buffer}, or \&{goto} \\{restart} if the
file has ended\X\6
\4\&{else} \&{begin} \37\&{if} $\R\\{terminal\_input}$ \1\&{then}\C{\.{\\read}
line has ended}\6
\&{begin} \37$\\{cur\_cmd}\K0$;\5
$\\{cur\_chr}\K0$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{input\_ptr}>0$ \1\&{then}\C{text was inserted during error recovery}%
\6
\&{begin} \37\\{end\_file\_reading};\5
\&{goto} \37\\{restart};\C{resume previous level}\6
\&{end};\2\6
\&{if} $\\{selector}<\\{log\_only}$ \1\&{then}\5
\\{open\_log\_file};\2\6
\&{if} $\\{interaction}>\\{nonstop\_mode}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{incr}(\\{limit})$;\2\6
\&{if} $\\{limit}=\\{start}$ \1\&{then}\C{previous line was empty}\6
$\\{print\_nl}(\.{"(Please\ type\ a\ command\ or\ say\ \`\\end\')"})$;\2\6
\\{print\_ln};\5
$\\{first}\K\\{start}$;\5
$\\{prompt\_input}(\.{"*"})$;\C{input on-line into \\{buffer}}\6
$\\{limit}\K\\{last}$;\6
\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{decr}(\\{limit})$\6
\4\&{else} $\\{buffer}[\\{limit}]\K\\{end\_line\_char}$;\2\6
$\\{first}\K\\{limit}+1$;\5
$\\{loc}\K\\{start}$;\6
\&{end}\6
\4\&{else} $\\{fatal\_error}(\.{"***\ (job\ aborted,\ no\ legal\ \\end\
found)"})$;\C{nonstop mode, which is intended for overnight batch processing,
  never waits for on-line input}\2\6
\&{end}\2\par
\U365.\fi

\M383. The global variable \\{force\_eof} is normally \\{false}; it is set %
\\{true}
by an \.{\\endinput} command.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{force\_eof}: \37\\{boolean};\C{should the next \.{\\input} be aborted
early?}\par
\fi

\M384. \P$\X384:Read next line of file into \\{buffer}, or \&{goto} \\{restart}
if the file has ended\X\S$\6
\&{begin} \37$\\{incr}(\\{line})$;\5
$\\{first}\K\\{start}$;\6
\&{if} $\R\\{force\_eof}$ \1\&{then}\6
\&{if} $\\{name}\L19$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pseudo\_input}$ \1\&{then}\C{not end of file}\6
\\{firm\_up\_the\_line}\C{this sets \\{limit}}\6
\4\&{else} \&{if} $(\\{every\_eof}\I\\{null})\W\R\\{eof\_seen}[\\{index}]$ \1%
\&{then}\6
\&{begin} \37$\\{limit}\K\\{first}-1$;\5
$\\{eof\_seen}[\\{index}]\K\\{true}$;\C{fake one empty line}\6
$\\{begin\_token\_list}(\\{every\_eof},\39\\{every\_eof\_text})$;\5
\&{goto} \37\\{restart};\6
\&{end}\6
\4\&{else} $\\{force\_eof}\K\\{true}$;\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{input\_ln}(\\{cur\_file},\39\\{true})$ \1%
\&{then}\C{not end of file}\6
\\{firm\_up\_the\_line}\C{this sets \\{limit}}\6
\4\&{else} \&{if} $(\\{every\_eof}\I\\{null})\W\R\\{eof\_seen}[\\{index}]$ \1%
\&{then}\6
\&{begin} \37$\\{limit}\K\\{first}-1$;\5
$\\{eof\_seen}[\\{index}]\K\\{true}$;\C{fake one empty line}\6
$\\{begin\_token\_list}(\\{every\_eof},\39\\{every\_eof\_text})$;\5
\&{goto} \37\\{restart};\6
\&{end}\6
\4\&{else} $\\{force\_eof}\K\\{true}$;\2\2\6
\&{end};\2\2\6
\&{if} $\\{force\_eof}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{tracing\_nesting}>0$ \1\&{then}\6
\&{if} $(\\{grp\_stack}[\\{in\_open}]\I\\{cur\_boundary})\V\30(\\{if\_stack}[%
\\{in\_open}]\I\\{cond\_ptr})$ \1\&{then}\5
\\{file\_warning};\C{give warning for some unfinished groups and/or
conditionals}\2\2\6
\&{if} $\\{name}\G19$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{")"})$;\5
$\\{decr}(\\{open\_parens})$;\5
\\{update\_terminal};\C{show user that file has been read}\6
\&{end};\2\6
$\\{force\_eof}\K\\{false}$;\5
\\{end\_file\_reading};\C{resume previous level}\6
\\{check\_outer\_validity};\5
\&{goto} \37\\{restart};\6
\&{end};\2\6
\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{decr}(\\{limit})$\6
\4\&{else} $\\{buffer}[\\{limit}]\K\\{end\_line\_char}$;\2\6
$\\{first}\K\\{limit}+1$;\5
$\\{loc}\K\\{start}$;\C{ready to read}\6
\&{end}\par
\U382.\fi

\M385. If the user has set the \\{pausing} parameter to some positive value,
and if nonstop mode has not been selected, each line of input is displayed
on the terminal and the transcript file, followed by `\.{=>}'.
\TeX\ waits for a response. If the response is simply \\{carriage\_return}, the
line is accepted as it stands, otherwise the line typed is
used instead of the line in the file.

\Y\P\4\&{procedure}\1\  \37\\{firm\_up\_the\_line};\6
\4\&{var} \37\|k: \37$0\to\\{buf\_size}$;\C{an index into \\{buffer}}\2\6
\&{begin} \37$\\{limit}\K\\{last}$;\6
\&{if} $\\{pausing}>0$ \1\&{then}\6
\&{if} $\\{interaction}>\\{nonstop\_mode}$ \1\&{then}\6
\&{begin} \37\\{wake\_up\_terminal};\5
\\{print\_ln};\6
\&{if} $\\{start}<\\{limit}$ \1\&{then}\6
\&{for} $\|k\K\\{start}\mathrel{\&{to}}\\{limit}-1$ \1\&{do}\5
$\\{print}(\\{buffer}[\|k])$;\2\2\6
$\\{first}\K\\{limit}$;\5
$\\{prompt\_input}(\.{"=>"})$;\C{wait for user response}\6
\&{if} $\\{last}>\\{first}$ \1\&{then}\6
\&{begin} \37\&{for} $\|k\K\\{first}\mathrel{\&{to}}\\{last}-1$ \1\&{do}\C{move
line down in buffer}\6
$\\{buffer}[\|k+\\{start}-\\{first}]\K\\{buffer}[\|k]$;\2\6
$\\{limit}\K\\{start}+\\{last}-\\{first}$;\6
\&{end};\2\6
\&{end};\2\2\6
\&{end};\par
\fi

\M386. Since \\{get\_next} is used so frequently in \TeX, it is convenient
to define three related procedures that do a little more:

\yskip\hang\\{get\_token} not only sets \\{cur\_cmd} and \\{cur\_chr}, it
also sets \\{cur\_tok}, a packed halfword version of the current token.

\yskip\hang\\{get\_x\_token}, meaning ``get an expanded token,'' is like
\\{get\_token}, but if the current token turns out to be a user-defined
control sequence (i.e., a macro call), or a conditional,
or something like \.{\\topmark} or \.{\\expandafter} or \.{\\csname},
it is eliminated from the input by beginning the expansion of the macro
or the evaluation of the conditional.

\yskip\hang\\{x\_token} is like \\{get\_x\_token} except that it assumes that
\\{get\_next} has already been called.

\yskip\noindent
In fact, these three procedures account for almost every use of \\{get\_next}.

\fi

\M387. No new control sequences will be defined except during a call of
\\{get\_token}, or when \.{\\csname} compresses a token list, because
\\{no\_new\_control\_sequence} is always \\{true} at other times.

\Y\P\4\&{procedure}\1\  \37\\{get\_token};\C{sets \\{cur\_cmd}, \\{cur\_chr}, %
\\{cur\_tok}}\2\6
\&{begin} \37$\\{no\_new\_control\_sequence}\K\\{false}$;\5
\\{get\_next};\5
$\\{no\_new\_control\_sequence}\K\\{true}$;\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{cur\_tok}\K(\\{cur\_cmd}\ast\O{400})+\\{cur\_chr}$\6
\4\&{else} $\\{cur\_tok}\K\\{cs\_token\_flag}+\\{cur\_cs}$;\2\6
\&{end};\par
\fi

\N388.  \[25] Expanding the next token.
Only a dozen or so command codes $>\\{max\_command}$ can possibly be returned
by
\\{get\_next}; in increasing order, they are \\{undefined\_cs}, \\{expand%
\_after},
\\{no\_expand}, \\{input}, \\{if\_test}, \\{fi\_or\_else}, \\{cs\_name}, %
\\{convert}, \\{the},
\\{top\_bot\_mark}, \\{call}, \\{long\_call}, \\{outer\_call}, \\{long\_outer%
\_call}, and
\\{end\_template}.{\emergencystretch=40pt\par}

The \\{expand} subroutine is used when $\\{cur\_cmd}>\\{max\_command}$. It
removes a
``call'' or a conditional or one of the other special operations just
listed.  It follows that \\{expand} might invoke itself recursively. In all
cases, \\{expand} destroys the current token, but it sets things up so that
the next \\{get\_next} will deliver the appropriate next token. The value of
\\{cur\_tok} need not be known when \\{expand} is called.

Since several of the basic scanning routines communicate via global variables,
their values are saved as local variables of \\{expand} so that
recursive calls don't invalidate them.

\Y\P\hbox{\4}\X415:Declare the procedure called \\{macro\_call}\X\6
\hbox{\4}\X405:Declare the procedure called \\{insert\_relax}\X\6
\hbox{\4}\X1752:Declare \eTeX\ procedures for expanding\X\6
\4\&{procedure}\1\  \37\\{pass\_text};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{start\_input};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{conditional};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{get\_x\_token};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{conv\_toks};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{ins\_the\_toks};\5
\\{forward}; \hbox{\2} \6
\4\&{procedure}\1\  \37\\{expand};\6
\4\&{label} \37\\{reswitch};\6
\4\&{var} \37\|t: \37\\{halfword};\C{token that is being ``expanded after''}\6
\|b: \37\\{boolean};\C{keep track of nested csnames}\6
$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{for list manipulation}\6
\|j: \37$0\to\\{buf\_size}$;\C{index into \\{buffer}}\6
\\{cv\_backup}: \37\\{integer};\C{to save the global quantity \\{cur\_val}}\6
$\\{cvl\_backup},\39\\{radix\_backup},\39\\{co\_backup}$: \37\\{small\_number};%
\C{to save \\{cur\_val\_level}, etc.}\6
\\{backup\_backup}: \37\\{pointer};\C{to save $\\{link}(\\{backup\_head})$}\6
\\{save\_scanner\_status}: \37\\{small\_number};\C{temporary storage of %
\\{scanner\_status}}\2\6
\&{begin} \37$\\{cv\_backup}\K\\{cur\_val}$;\5
$\\{cvl\_backup}\K\\{cur\_val\_level}$;\5
$\\{radix\_backup}\K\\{radix}$;\5
$\\{co\_backup}\K\\{cur\_order}$;\5
$\\{backup\_backup}\K\\{link}(\\{backup\_head})$;\6
\4\\{reswitch}: \37\&{if} $\\{cur\_cmd}<\\{call}$ \1\&{then}\5
\X391:Expand a nonmacro\X\6
\4\&{else} \&{if} $\\{cur\_cmd}<\\{end\_template}$ \1\&{then}\5
\\{macro\_call}\6
\4\&{else} \X401:Insert a token containing \\{frozen\_endv}\X;\2\2\6
$\\{cur\_val}\K\\{cv\_backup}$;\5
$\\{cur\_val\_level}\K\\{cvl\_backup}$;\5
$\\{radix}\K\\{radix\_backup}$;\5
$\\{cur\_order}\K\\{co\_backup}$;\5
$\\{link}(\\{backup\_head})\K\\{backup\_backup}$;\6
\&{end};\par
\fi

\M389. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{is\_in\_csname}: \37\\{boolean};\par
\fi

\M390. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{is\_in\_csname}\K\\{false}$;\par
\fi

\M391. \P$\X391:Expand a nonmacro\X\S$\6
\&{begin} \37\&{if} $\\{tracing\_commands}>1$ \1\&{then}\5
\\{show\_cur\_cmd\_chr};\2\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4\\{top\_bot\_mark}: \37\X412:Insert the \(a)appropriate mark text into the
scanner\X;\6
\4\\{expand\_after}: \37\&{if} $\\{cur\_chr}=0$ \1\&{then}\5
\X392:Expand the token after the next token\X\6
\4\&{else} \X1765:Negate a boolean conditional and \&{goto} \\{reswitch}\X;\2\6
\4\\{no\_expand}: \37\&{if} $\\{cur\_chr}=0$ \1\&{then}\5
\X393:Suppress expansion of the next token\X\6
\4\&{else} \X394:Implement \.{\\pdfprimitive}\X;\2\6
\4\\{cs\_name}: \37\X398:Manufacture a control sequence name\X;\6
\4\\{convert}: \37\\{conv\_toks};\C{this procedure is discussed in Part 27
below}\6
\4\\{the}: \37\\{ins\_the\_toks};\C{this procedure is discussed in Part 27
below}\6
\4\\{if\_test}: \37\\{conditional};\C{this procedure is discussed in Part 28
below}\6
\4\\{fi\_or\_else}: \37\X536:Terminate the current conditional and skip to \.{%
\\fi}\X;\6
\4\\{input}: \37\X404:Initiate or terminate input from a file\X;\6
\4\&{othercases} \37\X396:Complain about an undefined macro\X\2\6
\&{endcases};\6
\&{end}\par
\U388.\fi

\M392. It takes only a little shuffling to do what \TeX\ calls \.{%
\\expandafter}.

\Y\P$\4\X392:Expand the token after the next token\X\S$\6
\&{begin} \37\\{get\_token};\5
$\|t\K\\{cur\_tok}$;\5
\\{get\_token};\6
\&{if} $\\{cur\_cmd}>\\{max\_command}$ \1\&{then}\5
\\{expand}\ \&{else} \\{back\_input};\2\6
$\\{cur\_tok}\K\|t$;\5
\\{back\_input};\6
\&{end}\par
\U391.\fi

\M393. The implementation of \.{\\noexpand} is a bit trickier, because it is
necessary to insert a special `\\{dont\_expand}' marker into \TeX's reading
mechanism.  This special marker is processed by \\{get\_next}, but it does
not slow down the inner loop.

Since \.{\\outer} macros might arise here, we must also
clear the \\{scanner\_status} temporarily.

\Y\P$\4\X393:Suppress expansion of the next token\X\S$\6
\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_token};\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|t\K\\{cur\_tok}$;\5
\\{back\_input};\C{now \\{start} and \\{loc} point to the backed-up token \|t}\6
\&{if} $\|t\G\\{cs\_token\_flag}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{get\_avail}$;\5
$\\{info}(\|p)\K\\{cs\_token\_flag}+\\{frozen\_dont\_expand}$;\5
$\\{link}(\|p)\K\\{loc}$;\5
$\\{start}\K\|p$;\5
$\\{loc}\K\|p$;\6
\&{end};\2\6
\&{end}\par
\U391.\fi

\M394. The \.{\\pdfprimitive} handling. If the primitive meaning of the next
token is an expandable command, it suffices to replace the current
token with the primitive one and restart \\{expand}.

Otherwise, the token we just read has to be pushed back, as well
as a token matching the internal form of \.{\\pdfprimitive}, that is
sneaked in as an alternate form of \\{ignore\_spaces}.

Simply pushing back a token that matches the correct internal command
does not work, because approach would not survive roundtripping to a
temporary file.

\Y\P$\4\X394:Implement \.{\\pdfprimitive}\X\S$\6
\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_token};\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{if} $\\{cur\_cs}<\\{hash\_base}$ \1\&{then}\5
$\\{cur\_cs}\K\\{prim\_lookup}(\\{cur\_cs}-\\{single\_base})$\6
\4\&{else} $\\{cur\_cs}\K\\{prim\_lookup}(\\{text}(\\{cur\_cs}))$;\2\6
\&{if} $\\{cur\_cs}\I\\{undefined\_primitive}$ \1\&{then}\6
\&{begin} \37$\|t\K\\{prim\_eq\_type}(\\{cur\_cs})$;\6
\&{if} $\|t>\\{max\_command}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\|t$;\5
$\\{cur\_chr}\K\\{prim\_equiv}(\\{cur\_cs})$;\5
$\\{cur\_tok}\K(\\{cur\_cmd}\ast\O{400})+\\{cur\_chr}$;\5
$\\{cur\_cs}\K0$;\5
\&{goto} \37\\{reswitch};\6
\&{end}\6
\4\&{else} \&{begin} \37\\{back\_input};\C{ now \\{loc} and \\{start} point to
a one-item list }\6
$\|p\K\\{get\_avail}$;\5
$\\{info}(\|p)\K\\{cs\_token\_flag}+\\{frozen\_primitive}$;\5
$\\{link}(\|p)\K\\{loc}$;\5
$\\{loc}\K\|p$;\5
$\\{start}\K\|p$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\par
\U391.\fi

\M395. This block deals with unexpandable \.{\\primitive} appearing at a spot
where
an integer or an internal values should have been found. It fetches the
next token then resets \\{cur\_cmd}, \\{cur\_cs}, and \\{cur\_tok}, based on
the
primitive value of that token. No expansion takes place, because the
next token may be all sorts of things. This could trigger further
expansion creating new errors.

\Y\P$\4\X395:Reset \\{cur\_tok} for unexpandable primitives, goto restart\X\S$\6
\&{begin} \37\\{get\_token};\6
\&{if} $\\{cur\_cs}<\\{hash\_base}$ \1\&{then}\5
$\\{cur\_cs}\K\\{prim\_lookup}(\\{cur\_cs}-\\{single\_base})$\6
\4\&{else} $\\{cur\_cs}\K\\{prim\_lookup}(\\{text}(\\{cur\_cs}))$;\2\6
\&{if} $\\{cur\_cs}\I\\{undefined\_primitive}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{prim\_eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{prim\_equiv}(\\{cur\_cs})$;\5
$\\{cur\_cs}\K\\{prim\_eqtb\_base}+\\{cur\_cs}$;\5
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{cur\_cs}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_cmd}\K\\{relax}$;\5
$\\{cur\_chr}\K0$;\5
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_relax}$;\5
$\\{cur\_cs}\K\\{frozen\_relax}$;\6
\&{end};\2\6
\&{goto} \37\\{restart};\6
\&{end}\par
\Us439\ET466.\fi

\M396. \P$\X396:Complain about an undefined macro\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Undefined\ control\ sequence"})$;\5
$\\{help5}(\.{"The\ control\ sequence\ at\ the\ end\ of\ the\ top\ line"})$\6
$(\.{"of\ your\ error\ message\ was\ never\ \\def\'ed.\ If\ you\ have"})$\6
$(\.{"misspelled\ it\ (e.g.,\ \`\\hobx\'),\ type\ \`I\'\ and\ the\ correct"})$\6
$(\.{"spelling\ (e.g.,\ \`I\\hbox\').\ Otherwise\ just\ continue,"})$\6
$(\.{"and\ I\'ll\ forget\ about\ whatever\ was\ undefined."})$;\5
\\{error};\6
\&{end}\par
\U391.\fi

\M397. The \\{expand} procedure and some other routines that construct token
lists find it convenient to use the following macros, which are valid only if
the variables \|p and \|q are reserved for token-list building.

\Y\P\D \37$\\{store\_new\_token}(\#)\S$\1\6
\&{begin} \37$\|q\K\\{get\_avail}$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{info}(\|q)\K\#$;\5
$\|p\K\|q$;\C{$\\{link}(\|p)$ is \\{null}}\6
\&{end}\2\par
\P\D \37$\\{fast\_store\_new\_token}(\#)\S$\1\6
\&{begin} \37$\\{fast\_get\_avail}(\|q)$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{info}(\|q)\K\#$;\5
$\|p\K\|q$;\C{$\\{link}(\|p)$ is \\{null}}\6
\&{end}\2\par
\fi

\M398. \P$\X398:Manufacture a control sequence name\X\S$\6
\&{begin} \37$\|r\K\\{get\_avail}$;\5
$\|p\K\|r$;\C{head of the list of characters}\6
$\|b\K\\{is\_in\_csname}$;\5
$\\{is\_in\_csname}\K\\{true}$;\6
\1\&{repeat} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{store\_new\_token}(\\{cur\_tok})$;\2\6
\4\&{until}\5
$\\{cur\_cs}\I0$;\2\6
\&{if} $\\{cur\_cmd}\I\\{end\_cs\_name}$ \1\&{then}\5
\X399:Complain about missing \.{\\endcsname}\X;\2\6
$\\{is\_in\_csname}\K\|b$;\5
\X400:Look up the characters of list \|r in the hash table, and set \\{cur\_cs}%
\X;\6
$\\{flush\_list}(\|r)$;\6
\&{if} $\\{eq\_type}(\\{cur\_cs})=\\{undefined\_cs}$ \1\&{then}\6
\&{begin} \37$\\{eq\_define}(\\{cur\_cs},\39\\{relax},\39256)$;\C{N.B.: The %
\\{save\_stack} might change}\6
\&{end};\C{the control sequence will now match `\.{\\relax}'}\2\6
$\\{cur\_tok}\K\\{cur\_cs}+\\{cs\_token\_flag}$;\5
\\{back\_input};\6
\&{end}\par
\U391.\fi

\M399. \P$\X399:Complain about missing \.{\\endcsname}\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ "})$;\5
$\\{print\_esc}(\.{"endcsname"})$;\5
$\\{print}(\.{"\ inserted"})$;\5
$\\{help2}(\.{"The\ control\ sequence\ marked\ <to\ be\ read\ again>\
should"})$\6
$(\.{"not\ appear\ between\ \\csname\ and\ \\endcsname."})$;\5
\\{back\_error};\6
\&{end}\par
\Us398\ET1767.\fi

\M400. \P$\X400:Look up the characters of list \|r in the hash table, and set %
\\{cur\_cs}\X\S$\6
$\|j\K\\{first}$;\5
$\|p\K\\{link}(\|r)$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\|j\G\\{max\_buf\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_buf\_stack}\K\|j+1$;\6
\&{if} $\\{max\_buf\_stack}=\\{buf\_size}$ \1\&{then}\5
$\\{overflow}(\.{"buffer\ size"},\39\\{buf\_size})$;\2\6
\&{end};\2\6
$\\{buffer}[\|j]\K\\{info}(\|p)\mathbin{\&{mod}}\O{400}$;\5
$\\{incr}(\|j)$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{if} $\|j>\\{first}+1$ \1\&{then}\6
\&{begin} \37$\\{no\_new\_control\_sequence}\K\\{false}$;\5
$\\{cur\_cs}\K\\{id\_lookup}(\\{first},\39\|j-\\{first})$;\5
$\\{no\_new\_control\_sequence}\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{if} $\|j=\\{first}$ \1\&{then}\5
$\\{cur\_cs}\K\\{null\_cs}$\C{the list is empty}\6
\4\&{else} $\\{cur\_cs}\K\\{single\_base}+\\{buffer}[\\{first}]$\C{the list has
length one}\2\2\par
\U398.\fi

\M401. An \\{end\_template} command is effectively changed to an \\{endv}
command
by the following code. (The reason for this is discussed below; the
\\{frozen\_end\_template} at the end of the template has passed the
\\{check\_outer\_validity} test, so its mission of error detection has been
accomplished.)

\Y\P$\4\X401:Insert a token containing \\{frozen\_endv}\X\S$\6
\&{begin} \37$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_endv}$;\5
\\{back\_input};\6
\&{end}\par
\U388.\fi

\M402. The processing of \.{\\input} involves the \\{start\_input} subroutine,
which will be declared later; the processing of \.{\\endinput} is trivial.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"input"},\39\\{input},\390)$;\6
$\\{primitive}(\.{"endinput"},\39\\{input},\391)$;\par
\fi

\M403. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{input}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"input"})$\2\6
\X1748:Cases of \\{input} for \\{print\_cmd\_chr}\X\6
\4\&{else} \37$\\{print\_esc}(\.{"endinput"})$;\par
\fi

\M404. \P$\X404:Initiate or terminate input from a file\X\S$\6
\&{if} $\\{cur\_chr}=1$ \1\&{then}\5
$\\{force\_eof}\K\\{true}$\2\6
\X1749:Cases for \\{input}\X\6
\4\&{else} \37\&{if} $\\{name\_in\_progress}$ \1\&{then}\5
\\{insert\_relax}\6
\4\&{else} \\{start\_input}\2\par
\U391.\fi

\M405. Sometimes the expansion looks too far ahead, so we want to insert
a harmless \.{\\relax} into the user's input.

\Y\P$\4\X405:Declare the procedure called \\{insert\_relax}\X\S$\6
\4\&{procedure}\1\  \37\\{insert\_relax};\2\6
\&{begin} \37$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{cur\_cs}$;\5
\\{back\_input};\5
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_relax}$;\5
\\{back\_input};\5
$\\{token\_type}\K\\{inserted}$;\6
\&{end};\par
\U388.\fi

\M406. Here is a recursive procedure that is \TeX's usual way to get the
next token of input. It has been slightly optimized to take account of
common cases.

\Y\P\4\&{procedure}\1\  \37\\{get\_x\_token};\C{sets \\{cur\_cmd}, \\{cur%
\_chr}, \\{cur\_tok},   and expands macros}\6
\4\&{label} \37$\\{restart},\39\\{done}$;\2\6
\&{begin} \37\\{restart}: \37\\{get\_next};\6
\&{if} $\\{cur\_cmd}\L\\{max\_command}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{if} $\\{cur\_cmd}\G\\{call}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}<\\{end\_template}$ \1\&{then}\5
\\{macro\_call}\6
\4\&{else} \&{begin} \37$\\{cur\_cs}\K\\{frozen\_endv}$;\5
$\\{cur\_cmd}\K\\{endv}$;\5
\&{goto} \37\\{done};\C{$\\{cur\_chr}=\\{null\_list}$}\6
\&{end}\2\6
\4\&{else} \\{expand};\2\6
\&{goto} \37\\{restart};\6
\4\\{done}: \37\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{cur\_tok}\K(\\{cur\_cmd}\ast\O{400})+\\{cur\_chr}$\6
\4\&{else} $\\{cur\_tok}\K\\{cs\_token\_flag}+\\{cur\_cs}$;\2\6
\&{end};\par
\fi

\M407. The \\{get\_x\_token} procedure is essentially equivalent to two
consecutive
procedure calls: \\{get\_next}; \\{x\_token}.

\Y\P\4\&{procedure}\1\  \37\\{x\_token};\C{\\{get\_x\_token} without the
initial \\{get\_next}}\2\6
\&{begin} \37\&{while} $\\{cur\_cmd}>\\{max\_command}$ \1\&{do}\6
\&{begin} \37\\{expand};\5
\\{get\_next};\6
\&{end};\2\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{cur\_tok}\K(\\{cur\_cmd}\ast\O{400})+\\{cur\_chr}$\6
\4\&{else} $\\{cur\_tok}\K\\{cs\_token\_flag}+\\{cur\_cs}$;\2\6
\&{end};\par
\fi

\M408. A control sequence that has been \.{\\def}'ed by the user is expanded by
\TeX's \\{macro\_call} procedure.

Before we get into the details of \\{macro\_call}, however, let's consider the
treatment of primitives like \.{\\topmark}, since they are essentially
macros without parameters. The token lists for such marks are kept in a
global array of five pointers; we refer to the individual entries of this
array by symbolic names \\{top\_mark}, etc. The value of \\{top\_mark} is
either
\\{null} or a pointer to the reference count of a token list.

\Y\P\D \37$\\{marks\_code}\S5$\C{add this for \.{\\topmarks} etc.}\Y\par
\P\D \37$\\{top\_mark\_code}=0$\C{the mark in effect at the previous page
break}\par
\P\D \37$\\{first\_mark\_code}=1$\C{the first mark between \\{top\_mark} and %
\\{bot\_mark}}\par
\P\D \37$\\{bot\_mark\_code}=2$\C{the mark in effect at the current page break}%
\par
\P\D \37$\\{split\_first\_mark\_code}=3$\C{the first mark found by \.{%
\\vsplit}}\par
\P\D \37$\\{split\_bot\_mark\_code}=4$\C{the last mark found by \.{\\vsplit}}%
\par
\P\D \37$\\{top\_mark}\S\\{cur\_mark}[\\{top\_mark\_code}]$\par
\P\D \37$\\{first\_mark}\S\\{cur\_mark}[\\{first\_mark\_code}]$\par
\P\D \37$\\{bot\_mark}\S\\{cur\_mark}[\\{bot\_mark\_code}]$\par
\P\D \37$\\{split\_first\_mark}\S\\{cur\_mark}[\\{split\_first\_mark\_code}]$%
\par
\P\D \37$\\{split\_bot\_mark}\S\\{cur\_mark}[\\{split\_bot\_mark\_code}]$\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_mark}: \37\&{array} $[\\{top\_mark\_code}\to\\{split\_bot\_mark%
\_code}]$ \1\&{of}\5
\\{pointer};\C{token lists for marks}\2\par
\fi

\M409. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{top\_mark}\K\\{null}$;\5
$\\{first\_mark}\K\\{null}$;\5
$\\{bot\_mark}\K\\{null}$;\5
$\\{split\_first\_mark}\K\\{null}$;\5
$\\{split\_bot\_mark}\K\\{null}$;\par
\fi

\M410. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"topmark"},\39\\{top\_bot\_mark},\39\\{top\_mark\_code})$;\5
$\\{primitive}(\.{"firstmark"},\39\\{top\_bot\_mark},\39\\{first\_mark%
\_code})$;\5
$\\{primitive}(\.{"botmark"},\39\\{top\_bot\_mark},\39\\{bot\_mark\_code})$;\5
$\\{primitive}(\.{"splitfirstmark"},\39\\{top\_bot\_mark},\39\\{split\_first%
\_mark\_code})$;\5
$\\{primitive}(\.{"splitbotmark"},\39\\{top\_bot\_mark},\39\\{split\_bot\_mark%
\_code})$;\par
\fi

\M411. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{top\_bot\_mark}: \37\&{begin} \37\&{case} $(\\{chr\_code}\mathbin{\&{mod}}%
\\{marks\_code})$ \1\&{of}\6
\4\\{first\_mark\_code}: \37$\\{print\_esc}(\.{"firstmark"})$;\6
\4\\{bot\_mark\_code}: \37$\\{print\_esc}(\.{"botmark"})$;\6
\4\\{split\_first\_mark\_code}: \37$\\{print\_esc}(\.{"splitfirstmark"})$;\6
\4\\{split\_bot\_mark\_code}: \37$\\{print\_esc}(\.{"splitbotmark"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"topmark"})$\2\6
\&{endcases};\6
\&{if} $\\{chr\_code}\G\\{marks\_code}$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
\&{end};\par
\fi

\M412. The following code is activated when $\\{cur\_cmd}=\\{top\_bot\_mark}$
and
when \\{cur\_chr} is a code like \\{top\_mark\_code}.

\Y\P$\4\X412:Insert the \(a)appropriate mark text into the scanner\X\S$\6
\&{begin} \37$\|t\K\\{cur\_chr}\mathbin{\&{mod}}\\{marks\_code}$;\6
\&{if} $\\{cur\_chr}\G\\{marks\_code}$ \1\&{then}\5
\\{scan\_register\_num}\ \&{else} $\\{cur\_val}\K0$;\2\6
\&{if} $\\{cur\_val}=0$ \1\&{then}\5
$\\{cur\_ptr}\K\\{cur\_mark}[\|t]$\6
\4\&{else} \X1824:Compute the mark pointer for mark type \|t and class \\{cur%
\_val}\X;\2\6
\&{if} $\\{cur\_ptr}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{cur\_ptr},\39\\{mark\_text})$;\2\6
\&{end}\par
\U391.\fi

\M413. Now let's consider \\{macro\_call} itself, which is invoked when \TeX\
is
scanning a control sequence whose \\{cur\_cmd} is either \\{call}, \\{long%
\_call},
\\{outer\_call}, or \\{long\_outer\_call}.  The control sequence definition
appears in the token list whose reference count is in location \\{cur\_chr}
of \\{mem}.

The global variable \\{long\_state} will be set to \\{call} or to \\{long%
\_call},
depending on whether or not the control sequence disallows \.{\\par}
in its parameters. The \\{get\_next} routine will set \\{long\_state} to
\\{outer\_call} and emit \.{\\par}, if a file ends or if an \.{\\outer}
control sequence occurs in the midst of an argument.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{long\_state}: \37$\\{call}\to\\{long\_outer\_call}$;\C{governs the
acceptance of \.{\\par}}\par
\fi

\M414. The parameters, if any, must be scanned before the macro is expanded.
Parameters are token lists without reference counts. They are placed on
an auxiliary stack called \\{pstack} while they are being scanned, since
the \\{param\_stack} may be losing entries during the matching process.
(Note that \\{param\_stack} can't be gaining entries, since \\{macro\_call} is
the only routine that puts anything onto \\{param\_stack}, and it
is not recursive.)

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pstack}: \37\&{array} $[0\to8]$ \1\&{of}\5
\\{pointer};\C{arguments supplied to a macro}\2\par
\fi

\M415. After parameter scanning is complete, the parameters are moved to the
\\{param\_stack}. Then the macro body is fed to the scanner; in other words,
\\{macro\_call} places the defined text of the control sequence at the
top of\/ \TeX's input stack, so that \\{get\_next} will proceed to read it
next.

The global variable \\{cur\_cs} contains the \\{eqtb} address of the control
sequence
being expanded, when \\{macro\_call} begins. If this control sequence has not
been
declared \.{\\long}, i.e., if its command code in the \\{eq\_type} field is
not \\{long\_call} or \\{long\_outer\_call}, its parameters are not allowed to
contain
the control sequence \.{\\par}. If an illegal \.{\\par} appears, the macro
call is aborted, and the \.{\\par} will be rescanned.

\Y\P$\4\X415:Declare the procedure called \\{macro\_call}\X\S$\6
\4\&{procedure}\1\  \37\\{macro\_call};\C{invokes a user-defined control
sequence}\6
\4\&{label} \37$\\{exit},\39\\{continue},\39\\{done},\39\\{done1},\39%
\\{found}$;\6
\4\&{var} \37\|r: \37\\{pointer};\C{current node in the macro's token list}\6
\|p: \37\\{pointer};\C{current node in parameter token list being built}\6
\|q: \37\\{pointer};\C{new node being put into the token list}\6
\|s: \37\\{pointer};\C{backup pointer for parameter matching}\6
\|t: \37\\{pointer};\C{cycle pointer for backup recovery}\6
$\|u,\39\|v$: \37\\{pointer};\C{auxiliary pointers for backup recovery}\6
\\{rbrace\_ptr}: \37\\{pointer};\C{one step before the last \\{right\_brace}
token}\6
\|n: \37\\{small\_number};\C{the number of parameters scanned}\6
\\{unbalance}: \37\\{halfword};\C{unmatched left braces in current parameter}\6
\|m: \37\\{halfword};\C{the number of tokens or groups (usually)}\6
\\{ref\_count}: \37\\{pointer};\C{start of the token list}\6
\\{save\_scanner\_status}: \37\\{small\_number};\C{\\{scanner\_status} upon
entry}\6
\\{save\_warning\_index}: \37\\{pointer};\C{\\{warning\_index} upon entry}\6
\\{match\_chr}: \37\\{ASCII\_code};\C{character used in parameter}\2\6
\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{warning\_index}\K\\{cur\_cs}$;\5
$\\{ref\_count}\K\\{cur\_chr}$;\5
$\|r\K\\{link}(\\{ref\_count})$;\5
$\|n\K0$;\6
\&{if} $\\{tracing\_macros}>0$ \1\&{then}\5
\X427:Show the text of the macro being expanded\X;\2\6
\&{if} $\\{info}(\|r)=\\{protected\_token}$ \1\&{then}\5
$\|r\K\\{link}(\|r)$;\2\6
\&{if} $\\{info}(\|r)\I\\{end\_match\_token}$ \1\&{then}\5
\X417:Scan the parameters and make $\\{link}(\|r)$ point to the macro body; but
\&{return} if an illegal \.{\\par} is detected\X;\2\6
\X416:Feed the macro body and its parameters to the scanner\X;\6
\4\\{exit}: \37$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\6
\&{end};\par
\U388.\fi

\M416. Before we put a new token list on the input stack, it is wise to clean
off
all token lists that have recently been depleted. Then a user macro that ends
with a call to itself will not require unbounded stack space.

\Y\P$\4\X416:Feed the macro body and its parameters to the scanner\X\S$\6
\&{while} $(\\{state}=\\{token\_list})\W(\\{loc}=\\{null})\W(\\{token\_type}\I%
\\{v\_template})$ \1\&{do}\5
\\{end\_token\_list};\C{conserve stack space}\2\6
$\\{begin\_token\_list}(\\{ref\_count},\39\\{macro})$;\5
$\\{name}\K\\{warning\_index}$;\5
$\\{loc}\K\\{link}(\|r)$;\6
\&{if} $\|n>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{param\_ptr}+\|n>\\{max\_param\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_param\_stack}\K\\{param\_ptr}+\|n$;\6
\&{if} $\\{max\_param\_stack}>\\{param\_size}$ \1\&{then}\5
$\\{overflow}(\.{"parameter\ stack\ size"},\39\\{param\_size})$;\2\6
\&{end};\2\6
\&{for} $\|m\K0\mathrel{\&{to}}\|n-1$ \1\&{do}\5
$\\{param\_stack}[\\{param\_ptr}+\|m]\K\\{pstack}[\|m]$;\2\6
$\\{param\_ptr}\K\\{param\_ptr}+\|n$;\6
\&{end}\2\par
\U415.\fi

\M417. At this point, the reader will find it advisable to review the
explanation
of token list format that was presented earlier, since many aspects of that
format are of importance chiefly in the \\{macro\_call} routine.

The token list might begin with a string of compulsory tokens before the
first \\{match} or \\{end\_match}. In that case the macro name is supposed to
be
followed by those tokens; the following program will set $\|s=\\{null}$ to
represent this restriction. Otherwise \|s will be set to the first token of
a string that will delimit the next parameter.

\Y\P$\4\X417:Scan the parameters and make $\\{link}(\|r)$ point to the macro
body; but \&{return} if an illegal \.{\\par} is detected\X\S$\6
\&{begin} \37$\\{scanner\_status}\K\\{matching}$;\5
$\\{unbalance}\K0$;\5
$\\{long\_state}\K\\{eq\_type}(\\{cur\_cs})$;\6
\&{if} $\\{long\_state}\G\\{outer\_call}$ \1\&{then}\5
$\\{long\_state}\K\\{long\_state}-2$;\2\6
\1\&{repeat} \37$\\{link}(\\{temp\_head})\K\\{null}$;\6
\&{if} $(\\{info}(\|r)>\\{match\_token}+255)\V(\\{info}(\|r)<\\{match\_token})$
\1\&{then}\5
$\|s\K\\{null}$\6
\4\&{else} \&{begin} \37$\\{match\_chr}\K\\{info}(\|r)-\\{match\_token}$;\5
$\|s\K\\{link}(\|r)$;\5
$\|r\K\|s$;\5
$\|p\K\\{temp\_head}$;\5
$\|m\K0$;\6
\&{end};\2\6
\X418:Scan a parameter until its delimiter string has been found; or, if $\|s=%
\\{null}$, simply scan the delimiter string\X;\6
\C{now $\\{info}(\|r)$ is a token whose command code is either \\{match} or %
\\{end\_match}}\6
\4\&{until}\5
$\\{info}(\|r)=\\{end\_match\_token}$;\2\6
\&{end}\par
\U415.\fi

\M418. If $\\{info}(\|r)$ is a \\{match} or \\{end\_match} command, it cannot
be equal to
any token found by \\{get\_token}. Therefore an undelimited parameter---i.e.,
a \\{match} that is immediately followed by \\{match} or \\{end\_match}---will
always fail the test `$\\{cur\_tok}=\\{info}(\|r)$' in the following algorithm.

\Y\P$\4\X418:Scan a parameter until its delimiter string has been found; or, if
$\|s=\\{null}$, simply scan the delimiter string\X\S$\6
\4\\{continue}: \37\\{get\_token};\C{set \\{cur\_tok} to the next token of
input}\6
\&{if} $\\{cur\_tok}=\\{info}(\|r)$ \1\&{then}\5
\X420:Advance \(r)\|r; \&{goto} \\{found} if the parameter delimiter has been
fully matched, otherwise \&{goto} \\{continue}\X;\2\6
\X423:Contribute the recently matched tokens to the current parameter, and %
\&{goto} \\{continue} if a partial match is still in effect; but abort if $\|s=%
\\{null}$\X;\6
\&{if} $\\{cur\_tok}=\\{par\_token}$ \1\&{then}\6
\&{if} $\\{long\_state}\I\\{long\_call}$ \1\&{then}\5
\X422:Report a runaway argument and abort\X;\2\2\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\5
\X425:Contribute an entire group to the current parameter\X\6
\4\&{else} \X421:Report an extra right brace and \&{goto} \\{continue}\X\2\6
\4\&{else} \X419:Store the current token, but \&{goto} \\{continue} if it is a
blank space that would become an undelimited parameter\X;\2\6
$\\{incr}(\|m)$;\6
\&{if} $\\{info}(\|r)>\\{end\_match\_token}$ \1\&{then}\5
\&{goto} \37\\{continue};\2\6
\&{if} $\\{info}(\|r)<\\{match\_token}$ \1\&{then}\5
\&{goto} \37\\{continue};\2\6
\4\\{found}: \37\&{if} $\|s\I\\{null}$ \1\&{then}\5
\X426:Tidy up the parameter just scanned, and tuck it away\X\2\par
\U417.\fi

\M419. \P$\X419:Store the current token, but \&{goto} \\{continue} if it is a
blank space that would become an undelimited parameter\X\S$\6
\&{begin} \37\&{if} $\\{cur\_tok}=\\{space\_token}$ \1\&{then}\6
\&{if} $\\{info}(\|r)\L\\{end\_match\_token}$ \1\&{then}\6
\&{if} $\\{info}(\|r)\G\\{match\_token}$ \1\&{then}\5
\&{goto} \37\\{continue};\2\2\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end}\par
\U418.\fi

\M420. A slightly subtle point arises here: When the parameter delimiter ends
with `\.{\#\{}', the token list will have a left brace both before and
after the \\{end\_match}\kern-.4pt. Only one of these should affect the
\\{align\_state}, but both will be scanned, so we must make a correction.

\Y\P$\4\X420:Advance \(r)\|r; \&{goto} \\{found} if the parameter delimiter has
been fully matched, otherwise \&{goto} \\{continue}\X\S$\6
\&{begin} \37$\|r\K\\{link}(\|r)$;\6
\&{if} $(\\{info}(\|r)\G\\{match\_token})\W(\\{info}(\|r)\L\\{end\_match%
\_token})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\5
$\\{decr}(\\{align\_state})$;\2\6
\&{goto} \37\\{found};\6
\&{end}\6
\4\&{else} \&{goto} \37\\{continue};\2\6
\&{end}\par
\U418.\fi

\M421. \P$\X421:Report an extra right brace and \&{goto} \\{continue}\X\S$\6
\&{begin} \37\\{back\_input};\5
$\\{print\_err}(\.{"Argument\ of\ "})$;\5
$\\{sprint\_cs}(\\{warning\_index})$;\5
$\\{print}(\.{"\ has\ an\ extra\ \}"})$;\5
$\\{help6}(\.{"I\'ve\ run\ across\ a\ \`\}\'\ that\ doesn\'t\ seem\ to\ match\
anything."})$\6
$(\.{"For\ example,\ \`\\def\\a\#1\{...\}\'\ and\ \`\\a\}\'\ would\ produce"})$%
\6
$(\.{"this\ error.\ If\ you\ simply\ proceed\ now,\ the\ \`\\par\'\ that"})$\6
$(\.{"I\'ve\ just\ inserted\ will\ cause\ me\ to\ report\ a\ runaway"})$\6
$(\.{"argument\ that\ might\ be\ the\ root\ of\ the\ problem.\ But\ if"})$\6
$(\.{"your\ \`\}\'\ was\ spurious,\ just\ type\ \`2\'\ and\ it\ will\ go\
away."})$;\5
$\\{incr}(\\{align\_state})$;\5
$\\{long\_state}\K\\{call}$;\5
$\\{cur\_tok}\K\\{par\_token}$;\5
\\{ins\_error};\5
\&{goto} \37\\{continue};\6
\&{end}\C{a white lie; the \.{\\par} won't always trigger a runaway}\par
\U418.\fi

\M422. If $\\{long\_state}=\\{outer\_call}$, a runaway argument has already
been reported.

\Y\P$\4\X422:Report a runaway argument and abort\X\S$\6
\&{begin} \37\&{if} $\\{long\_state}=\\{call}$ \1\&{then}\6
\&{begin} \37\\{runaway};\5
$\\{print\_err}(\.{"Paragraph\ ended\ before\ "})$;\5
$\\{sprint\_cs}(\\{warning\_index})$;\5
$\\{print}(\.{"\ was\ complete"})$;\5
$\\{help3}(\.{"I\ suspect\ you\'ve\ forgotten\ a\ \`\}\',\ causing\ me\ to\
apply\ this"})$\6
$(\.{"control\ sequence\ to\ too\ much\ text.\ How\ can\ we\ recover?"})$\6
$(\.{"My\ plan\ is\ to\ forget\ the\ whole\ thing\ and\ hope\ for\ the\
best."})$;\5
\\{back\_error};\6
\&{end};\2\6
$\\{pstack}[\|n]\K\\{link}(\\{temp\_head})$;\5
$\\{align\_state}\K\\{align\_state}-\\{unbalance}$;\6
\&{for} $\|m\K0\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{flush\_list}(\\{pstack}[\|m])$;\2\6
\&{return};\6
\&{end}\par
\Us418\ET425.\fi

\M423. When the following code becomes active, we have matched tokens from \|s
to
the predecessor of \|r, and we have found that $\\{cur\_tok}\I\\{info}(\|r)$.
An
interesting situation now presents itself: If the parameter is to be
delimited by a string such as `\.{ab}', and if we have scanned `\.{aa}',
we want to contribute one `\.a' to the current parameter and resume
looking for a `\.b'. The program must account for such partial matches and
for others that can be quite complex.  But most of the time we have $\|s=\|r$
and nothing needs to be done.

Incidentally, it is possible for \.{\\par} tokens to sneak in to certain
parameters of non-\.{\\long} macros. For example, consider a case like
`\.{\\def\\a\#1\\par!\{...\}}' where the first \.{\\par} is not followed
by an exclamation point. In such situations it does not seem appropriate
to prohibit the \.{\\par}, so \TeX\ keeps quiet about this bending of
the rules.

\Y\P$\4\X423:Contribute the recently matched tokens to the current parameter,
and \&{goto} \\{continue} if a partial match is still in effect; but abort if $%
\|s=\\{null}$\X\S$\6
\&{if} $\|s\I\|r$ \1\&{then}\6
\&{if} $\|s=\\{null}$ \1\&{then}\5
\X424:Report an improper use of the macro and abort\X\6
\4\&{else} \&{begin} \37$\|t\K\|s$;\6
\1\&{repeat} \37$\\{store\_new\_token}(\\{info}(\|t))$;\5
$\\{incr}(\|m)$;\5
$\|u\K\\{link}(\|t)$;\5
$\|v\K\|s$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\|u=\|r$ \1\&{then}\6
\&{if} $\\{cur\_tok}\I\\{info}(\|v)$ \1\&{then}\5
\&{goto} \37\\{done}\6
\4\&{else} \&{begin} \37$\|r\K\\{link}(\|v)$;\5
\&{goto} \37\\{continue};\6
\&{end};\2\2\6
\&{if} $\\{info}(\|u)\I\\{info}(\|v)$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|u\K\\{link}(\|u)$;\5
$\|v\K\\{link}(\|v)$;\6
\&{end};\2\6
\4\\{done}: \37$\|t\K\\{link}(\|t)$;\6
\4\&{until}\5
$\|t=\|r$;\2\6
$\|r\K\|s$;\C{at this point, no tokens are recently matched}\6
\&{end}\2\2\par
\U418.\fi

\M424. \P$\X424:Report an improper use of the macro and abort\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Use\ of\ "})$;\5
$\\{sprint\_cs}(\\{warning\_index})$;\5
$\\{print}(\.{"\ doesn\'t\ match\ its\ definition"})$;\5
$\\{help4}(\.{"If\ you\ say,\ e.g.,\ \`\\def\\a1\{...\}\',\ then\ you\ must\
always"})$\6
$(\.{"put\ \`1\'\ after\ \`\\a\',\ since\ control\ sequence\ names\ are"})$\6
$(\.{"made\ up\ of\ letters\ only.\ The\ macro\ here\ has\ not\ been"})$\6
$(\.{"followed\ by\ the\ required\ stuff,\ so\ I\'m\ ignoring\ it."})$;\5
\\{error};\5
\&{return};\6
\&{end}\par
\U423.\fi

\M425. \P$\X425:Contribute an entire group to the current parameter\X\S$\6
\&{begin} \37$\\{unbalance}\K1$;\6
\~ \1\&{loop}\ \&{begin} \37$\\{fast\_store\_new\_token}(\\{cur\_tok})$;\5
\\{get\_token};\6
\&{if} $\\{cur\_tok}=\\{par\_token}$ \1\&{then}\6
\&{if} $\\{long\_state}\I\\{long\_call}$ \1\&{then}\5
\X422:Report a runaway argument and abort\X;\2\2\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\5
$\\{incr}(\\{unbalance})$\6
\4\&{else} \&{begin} \37$\\{decr}(\\{unbalance})$;\6
\&{if} $\\{unbalance}=0$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{end};\2\2\6
\&{end};\2\6
\4\\{done1}: \37$\\{rbrace\_ptr}\K\|p$;\5
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end}\par
\U418.\fi

\M426. If the parameter consists of a single group enclosed in braces, we must
strip off the enclosing braces. That's why \\{rbrace\_ptr} was introduced.

\Y\P$\4\X426:Tidy up the parameter just scanned, and tuck it away\X\S$\6
\&{begin} \37\&{if} $(\|m=1)\W(\\{info}(\|p)<\\{right\_brace\_limit})$ \1%
\&{then}\6
\&{begin} \37$\\{link}(\\{rbrace\_ptr})\K\\{null}$;\5
$\\{free\_avail}(\|p)$;\5
$\|p\K\\{link}(\\{temp\_head})$;\5
$\\{pstack}[\|n]\K\\{link}(\|p)$;\5
$\\{free\_avail}(\|p)$;\6
\&{end}\6
\4\&{else} $\\{pstack}[\|n]\K\\{link}(\\{temp\_head})$;\2\6
$\\{incr}(\|n)$;\6
\&{if} $\\{tracing\_macros}>0$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\\{match\_chr})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print}(\.{"<-"})$;\5
$\\{show\_token\_list}(\\{pstack}[\|n-1],\39\\{null},\391000)$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\2\6
\&{end}\par
\U418.\fi

\M427. \P$\X427:Show the text of the macro being expanded\X\S$\6
\&{begin} \37\\{begin\_diagnostic};\5
\\{print\_ln};\5
$\\{print\_cs}(\\{warning\_index})$;\5
$\\{token\_show}(\\{ref\_count})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end}\par
\U415.\fi

\N428.  \[26] Basic scanning subroutines.
Let's turn now to some procedures that \TeX\ calls upon frequently to digest
certain kinds of patterns in the input. Most of these are quite simple;
some are quite elaborate. Almost all of the routines call \\{get\_x\_token},
which can cause them to be invoked recursively.

\fi

\M429. The \\{scan\_left\_brace} routine is called when a left brace is
supposed to be
the next non-blank token. (The term ``left brace'' means, more precisely,
a character whose catcode is \\{left\_brace}.) \TeX\ allows \.{\\relax} to
appear before the \\{left\_brace}.

\Y\P\4\&{procedure}\1\  \37\\{scan\_left\_brace};\C{reads a mandatory \\{left%
\_brace}}\2\6
\&{begin} \37\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $\\{cur\_cmd}\I\\{left\_brace}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \{\ inserted"})$;\5
$\\{help4}(\.{"A\ left\ brace\ was\ mandatory\ here,\ so\ I\'ve\ put\ one\
in."})$\6
$(\.{"You\ might\ want\ to\ delete\ and/or\ insert\ some\ corrections"})$\6
$(\.{"so\ that\ I\ will\ find\ a\ matching\ right\ brace\ soon."})$\6
$(\.{"(If\ you\'re\ confused\ by\ all\ this,\ try\ typing\ \`I\}\'\ now.)"})$;\5
\\{back\_error};\5
$\\{cur\_tok}\K\\{left\_brace\_token}+\.{"\{"}$;\5
$\\{cur\_cmd}\K\\{left\_brace}$;\5
$\\{cur\_chr}\K\.{"\{"}$;\5
$\\{incr}(\\{align\_state})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M430. \P$\X430:Get the next non-blank non-relax non-call token\X\S$\6
\1\&{repeat} \37\\{get\_x\_token};\6
\4\&{until}\5
$(\\{cur\_cmd}\I\\{spacer})\W(\\{cur\_cmd}\I\\{relax})$\2\par
\Us429, 1256, 1262, 1329, 1338, 1389, 1404\ETs1448.\fi

\M431. The \\{scan\_optional\_equals} routine looks for an optional `\.=' sign
preceded
by optional spaces; `\.{\\relax}' is not ignored here.

\Y\P\4\&{procedure}\1\  \37\\{scan\_optional\_equals};\2\6
\&{begin} \37\X432:Get the next non-blank non-call token\X;\6
\&{if} $\\{cur\_tok}\I\\{other\_token}+\.{"="}$ \1\&{then}\5
\\{back\_input};\2\6
\&{end};\par
\fi

\M432. \P$\X432:Get the next non-blank non-call token\X\S$\6
\1\&{repeat} \37\\{get\_x\_token};\6
\4\&{until}\5
$\\{cur\_cmd}\I\\{spacer}$\2\par
\Us431, 467, 481, 529, 552, 604, 1223, 1769, 1784\ETs1785.\fi

\M433. In case you are getting bored, here is a slightly less trivial routine:
Given a string of lowercase letters, like `\.{pt}' or `\.{plus}' or
`\.{width}', the \\{scan\_keyword} routine checks to see whether the next
tokens of input match this string. The match must be exact, except that
uppercase letters will match their lowercase counterparts; uppercase
equivalents are determined by subtracting $\.{"a"}-\.{"A"}$, rather than using
the
\\{uc\_code} table, since \TeX\ uses this routine only for its own limited
set of keywords.

If a match is found, the characters are effectively removed from the input
and \\{true} is returned. Otherwise \\{false} is returned, and the input
is left essentially unchanged (except for the fact that some macros
may have been expanded, etc.).

\Y\P\4\&{function}\1\  \37$\\{scan\_keyword}(\|s:\\{str\_number})$: \37%
\\{boolean};\C{look for a given string}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{tail of the backup list}\6
\|q: \37\\{pointer};\C{new node being added to the token list via \\{store\_new%
\_token}}\6
\|k: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\6
\\{save\_cur\_cs}: \37\\{pointer};\C{to save \\{cur\_cs}}\2\6
\&{begin} \37$\|p\K\\{backup\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\|k\K\\{str\_start}[\|s]$;\5
$\\{save\_cur\_cs}\K\\{cur\_cs}$;\6
\&{while} $\|k<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37\\{get\_x\_token};\C{recursion is possible here}\6
\&{if} $(\\{cur\_cs}=0)\W\30((\\{cur\_chr}=\\{so}(\\{str\_pool}[\|k]))\V(\\{cur%
\_chr}=\\{so}(\\{str\_pool}[\|k])-\.{"a"}+\.{"A"}))$ \1\&{then}\6
\&{begin} \37$\\{store\_new\_token}(\\{cur\_tok})$;\5
$\\{incr}(\|k)$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{cur\_cmd}\I\\{spacer})\V(\|p\I\\{backup\_head})$ \1%
\&{then}\6
\&{begin} \37\\{back\_input};\6
\&{if} $\|p\I\\{backup\_head}$ \1\&{then}\5
$\\{back\_list}(\\{link}(\\{backup\_head}))$;\2\6
$\\{cur\_cs}\K\\{save\_cur\_cs}$;\5
$\\{scan\_keyword}\K\\{false}$;\5
\&{return};\6
\&{end};\2\2\6
\&{end};\2\6
$\\{flush\_list}(\\{link}(\\{backup\_head}))$;\5
$\\{scan\_keyword}\K\\{true}$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M434. Here is a procedure that sounds an alarm when mu and non-mu units
are being switched.

\Y\P\4\&{procedure}\1\  \37\\{mu\_error};\2\6
\&{begin} \37$\\{print\_err}(\.{"Incompatible\ glue\ units"})$;\5
$\\{help1}(\.{"I\'m\ going\ to\ assume\ that\ 1mu=1pt\ when\ they\'re\
mixed."})$;\5
\\{error};\6
\&{end};\par
\fi

\M435. The next routine `\\{scan\_something\_internal}' is used to fetch
internal
numeric quantities like `\.{\\hsize}', and also to handle the `\.{\\the}'
when expanding constructions like `\.{\\the\\toks0}' and
`\.{\\the\\baselineskip}'. Soon we will be considering the \\{scan\_int}
procedure, which calls \\{scan\_something\_internal}; on the other hand,
\\{scan\_something\_internal} also calls \\{scan\_int}, for constructions like
`\.{\\catcode\`\\\$}' or `\.{\\fontdimen} \.3 \.{\\ff}'. So we
have to declare \\{scan\_int} as a \\{forward} procedure. A few other
procedures are also declared at this point.

\Y\P\4\&{procedure}\1\  \37\\{scan\_int};\5
\\{forward};\C{scans an integer value}\6
\hbox{\4\4}\X459:Declare procedures that scan restricted classes of integers\X\6
\hbox{\4\4}\X1682:Declare \eTeX\ procedures for scanning\X\6
\hbox{\4\4}\X604:Declare procedures that scan font-related stuff\X\par
\fi

\M436. \TeX\ doesn't know exactly what to expect when \\{scan\_something%
\_internal}
begins.  For example, an integer or dimension or glue value could occur
immediately after `\.{\\hskip}'; and one can even say \.{\\the} with
respect to token lists in constructions like
`\.{\\xdef\\o\{\\the\\output\}}'.  On the other hand, only integers are
allowed after a construction like `\.{\\count}'. To handle the various
possibilities, \\{scan\_something\_internal} has a \\{level} parameter, which
tells the ``highest'' kind of quantity that \\{scan\_something\_internal} is
allowed to produce. Six levels are distinguished, namely \\{int\_val},
\\{dimen\_val}, \\{glue\_val}, \\{mu\_val}, \\{ident\_val}, and \\{tok\_val}.

The output of \\{scan\_something\_internal} (and of the other routines
\\{scan\_int}, \\{scan\_dimen}, and \\{scan\_glue} below) is put into the
global
variable \\{cur\_val}, and its level is put into \\{cur\_val\_level}. The
highest
values of \\{cur\_val\_level} are special: \\{mu\_val} is used only when
\\{cur\_val} points to something in a ``muskip'' register, or to one of the
three parameters \.{\\thinmuskip}, \.{\\medmuskip}, \.{\\thickmuskip};
\\{ident\_val} is used only when \\{cur\_val} points to a font identifier;
\\{tok\_val} is used only when \\{cur\_val} points to \\{null} or to the
reference
count of a token list. The last two cases are allowed only when
\\{scan\_something\_internal} is called with $\\{level}=\\{tok\_val}$.

If the output is glue, \\{cur\_val} will point to a glue specification, and
the reference count of that glue will have been updated to reflect this
reference; if the output is a nonempty token list, \\{cur\_val} will point to
its reference count, but in this case the count will not have been updated.
Otherwise \\{cur\_val} will contain the integer or scaled value in question.

\Y\P\D \37$\\{int\_val}=0$\C{integer values}\par
\P\D \37$\\{dimen\_val}=1$\C{dimension values}\par
\P\D \37$\\{glue\_val}=2$\C{glue specifications}\par
\P\D \37$\\{mu\_val}=3$\C{math glue specifications}\par
\P\D \37$\\{ident\_val}=4$\C{font identifier}\par
\P\D \37$\\{tok\_val}=5$\C{token lists}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_val}: \37\\{integer};\C{value returned by numeric scanners}\6
\4\\{cur\_val\_level}: \37$\\{int\_val}\to\\{tok\_val}$;\C{the ``level'' of
this value}\par
\fi

\M437. The hash table is initialized with `\.{\\count}', `\.{\\dimen}', `\.{%
\\skip}',
and `\.{\\muskip}' all having \\{register} as their command code; they are
distinguished by the \\{chr\_code}, which is either \\{int\_val}, \\{dimen%
\_val},
\\{glue\_val}, or \\{mu\_val} more than \\{mem\_bot} (dynamic variable-size
nodes
cannot have these values)

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"count"},\39\\{register},\39\\{mem\_bot}+\\{int\_val})$;\5
$\\{primitive}(\.{"dimen"},\39\\{register},\39\\{mem\_bot}+\\{dimen\_val})$;\5
$\\{primitive}(\.{"skip"},\39\\{register},\39\\{mem\_bot}+\\{glue\_val})$;\5
$\\{primitive}(\.{"muskip"},\39\\{register},\39\\{mem\_bot}+\\{mu\_val})$;\par
\fi

\M438. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{register}: \37\X1832:Cases of \\{register} for \\{print\_cmd\_chr}\X;\par
\fi

\M439. OK, we're ready for \\{scan\_something\_internal} itself. A second
parameter,
\\{negative}, is set \\{true} if the value that is found should be negated.
It is assumed that \\{cur\_cmd} and \\{cur\_chr} represent the first token of
the internal quantity to be scanned; an error will be signalled if
$\\{cur\_cmd}<\\{min\_internal}$ or $\\{cur\_cmd}>\\{max\_internal}$.

\Y\P\D \37$\\{scanned\_result\_end}(\#)\S\\{cur\_val\_level}\K\#$;\ \&{end} \par
\P\D \37$\\{scanned\_result}(\#)\S$\ \&{begin} \37$\\{cur\_val}\K\#$;\5
\\{scanned\_result\_end}\par
\Y\P\4\&{procedure}\1\  \37$\\{scan\_something\_internal}(\\{level}:\\{small%
\_number};\,\35\\{negative}:\\{boolean})$;\C{fetch an internal parameter}\6
\4\&{label} \37$\\{exit},\39\\{restart}$;\6
\4\&{var} \37\|m: \37\\{halfword};\C{\\{chr\_code} part of the operand token}\6
$\|n,\39\|k$: \37\\{integer};\C{accumulators}\6
$\|q,\39\|r$: \37\\{pointer};\C{general purpose indices}\6
\\{tx}: \37\\{pointer};\C{effective tail node}\6
\|i: \37\\{four\_quarters};\C{character info}\6
\|p: \37$0\to\\{nest\_size}$;\C{index into \\{nest}}\2\6
\&{begin} \37\\{restart}: \37$\|m\K\\{cur\_chr}$;\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4\\{def\_code}: \37\X440:Fetch a character code from some table\X;\6
\4$\\{toks\_register},\39\\{assign\_toks},\39\\{def\_family},\39\\{set\_font},%
\39\\{def\_font},\39\\{letterspace\_font},\39\\{pdf\_copy\_font}$: \37%
\X441:Fetch a token list or font identifier, provided that $\\{level}=\\{tok%
\_val}$\X;\6
\4\\{assign\_int}: \37$\\{scanned\_result}(\\{eqtb}[\|m].\\{int})(\\{int%
\_val})$;\6
\4\\{assign\_dimen}: \37$\\{scanned\_result}(\\{eqtb}[\|m].\\{sc})(\\{dimen%
\_val})$;\6
\4\\{assign\_glue}: \37$\\{scanned\_result}(\\{equiv}(\|m))(\\{glue\_val})$;\6
\4\\{assign\_mu\_glue}: \37$\\{scanned\_result}(\\{equiv}(\|m))(\\{mu\_val})$;\6
\4\\{set\_aux}: \37\X444:Fetch the \\{space\_factor} or the \\{prev\_depth}\X;\6
\4\\{set\_prev\_graf}: \37\X448:Fetch the \\{prev\_graf}\X;\6
\4\\{set\_page\_int}: \37\X445:Fetch the \\{dead\_cycles} or the \\{insert%
\_penalties}\X;\6
\4\\{set\_page\_dimen}: \37\X447:Fetch something on the \\{page\_so\_far}\X;\6
\4\\{set\_shape}: \37\X449:Fetch the \\{par\_shape} size\X;\6
\4\\{set\_box\_dimen}: \37\X446:Fetch a box dimension\X;\6
\4$\\{char\_given},\39\\{math\_given}$: \37$\\{scanned\_result}(\\{cur\_chr})(%
\\{int\_val})$;\6
\4\\{assign\_font\_dimen}: \37\X451:Fetch a font dimension\X;\6
\4\\{assign\_font\_int}: \37\X452:Fetch a font integer\X;\6
\4\\{register}: \37\X453:Fetch a register\X;\6
\4\\{last\_item}: \37\X450:Fetch an item in the current node, if appropriate\X;%
\6
\4\\{ignore\_spaces}: \37\C{trap unexpandable primitives}\6
\&{if} $\\{cur\_chr}=1$ \1\&{then}\5
\X395:Reset \\{cur\_tok} for unexpandable primitives, goto restart\X;\6
\4\&{othercases} \X454:Complain that \.{\\the} can't do this; give zero result%
\X\2\2\6
\&{endcases};\6
\&{while} $\\{cur\_val\_level}>\\{level}$ \1\&{do}\5
\X455:Convert \(c)\\{cur\_val} to a lower level\X;\2\6
\X456:Fix the reference count, if any, and negate \\{cur\_val} if \\{negative}%
\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M440. \P$\X440:Fetch a character code from some table\X\S$\6
\&{begin} \37\\{scan\_char\_num};\6
\&{if} $\|m=\\{math\_code\_base}$ \1\&{then}\5
$\\{scanned\_result}(\\{ho}(\\{math\_code}(\\{cur\_val})))(\\{int\_val})$\6
\4\&{else} \&{if} $\|m<\\{math\_code\_base}$ \1\&{then}\5
$\\{scanned\_result}(\\{equiv}(\|m+\\{cur\_val}))(\\{int\_val})$\6
\4\&{else} $\\{scanned\_result}(\\{eqtb}[\|m+\\{cur\_val}].\\{int})(\\{int%
\_val})$;\2\2\6
\&{end}\par
\U439.\fi

\M441. \P$\X441:Fetch a token list or font identifier, provided that $%
\\{level}=\\{tok\_val}$\X\S$\6
\&{if} $\\{level}\I\\{tok\_val}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ number,\ treated\ as\ zero"})$;\5
$\\{help3}(\.{"A\ number\ should\ have\ been\ here;\ I\ inserted\ \`0\'."})$\6
$(\.{"(If\ you\ can\'t\ figure\ out\ why\ I\ needed\ to\ see\ a\ number,"})$\6
$(\.{"look\ up\ \`weird\ error\'\ in\ the\ index\ to\ The\ TeXbook.)"})$;\5
\\{back\_error};\5
$\\{scanned\_result}(0)(\\{dimen\_val})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_cmd}\L\\{assign\_toks}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_cmd}<\\{assign\_toks}$ \1\&{then}\C{$\\{cur\_cmd}=%
\\{toks\_register}$}\6
\&{if} $\|m=\\{mem\_bot}$ \1\&{then}\6
\&{begin} \37\\{scan\_register\_num};\6
\&{if} $\\{cur\_val}<256$ \1\&{then}\5
$\\{cur\_val}\K\\{equiv}(\\{toks\_base}+\\{cur\_val})$\6
\4\&{else} \&{begin} \37$\\{find\_sa\_element}(\\{tok\_val},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}=\\{null}$ \1\&{then}\5
$\\{cur\_val}\K\\{null}$\6
\4\&{else} $\\{cur\_val}\K\\{sa\_ptr}(\\{cur\_ptr})$;\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\\{cur\_val}\K\\{sa\_ptr}(\|m)$\2\6
\4\&{else} $\\{cur\_val}\K\\{equiv}(\|m)$;\2\6
$\\{cur\_val\_level}\K\\{tok\_val}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\\{back\_input};\5
\\{scan\_font\_ident};\5
$\\{scanned\_result}(\\{font\_id\_base}+\\{cur\_val})(\\{ident\_val})$;\6
\&{end}\2\2\par
\U439.\fi

\M442. Users refer to `\.{\\the\\spacefactor}' only in horizontal
mode, and to `\.{\\the\\prevdepth}' only in vertical mode; so we put the
associated mode in the modifier part of the \\{set\_aux} command.
The \\{set\_page\_int} command has modifier 0 or 1, for `\.{\\deadcycles}' and
`\.{\\insertpenalties}', respectively. The \\{set\_box\_dimen} command is
modified by either \\{width\_offset}, \\{height\_offset}, or \\{depth\_offset}.
And the \\{last\_item} command is modified by either \\{int\_val}, \\{dimen%
\_val},
\\{glue\_val}, \\{input\_line\_no\_code}, or \\{badness\_code}.
\pdfTeX\ adds the codes for its extensions: \\{pdftex\_version\_code}, \dots.
\eTeX\ inserts \\{last\_node\_type\_code} after \\{glue\_val} and adds
the codes for its extensions: \\{eTeX\_version\_code}, \dots.

\Y\P\D \37$\\{last\_node\_type\_code}=\\{glue\_val}+1$\C{code for \.{%
\\lastnodetype}}\par
\P\D \37$\\{input\_line\_no\_code}=\\{glue\_val}+2$\C{code for \.{%
\\inputlineno}}\par
\P\D \37$\\{badness\_code}=\\{input\_line\_no\_code}+1$\C{code for \.{%
\\badness}}\Y\par
\P\D \37$\\{pdftex\_first\_rint\_code}=\\{badness\_code}+1$\C{base for %
\pdfTeX's command codes}\par
\P\D \37$\\{pdftex\_version\_code}=\\{pdftex\_first\_rint\_code}+0$\C{code for %
\.{\\pdftexversion}}\par
\P\D \37$\\{pdf\_last\_obj\_code}=\\{pdftex\_first\_rint\_code}+1$\C{code for %
\.{\\pdflastobj}}\par
\P\D \37$\\{pdf\_last\_xform\_code}=\\{pdftex\_first\_rint\_code}+2$\C{code for
\.{\\pdflastxform}}\par
\P\D \37$\\{pdf\_last\_ximage\_code}=\\{pdftex\_first\_rint\_code}+3$\C{code
for \.{\\pdflastximage}}\par
\P\D \37$\\{pdf\_last\_ximage\_pages\_code}=\\{pdftex\_first\_rint\_code}+4$%
\C{code for \.{\\pdflastximagepages}}\par
\P\D \37$\\{pdf\_last\_annot\_code}=\\{pdftex\_first\_rint\_code}+5$\C{code for
\.{\\pdflastannot}}\par
\P\D \37$\\{pdf\_last\_x\_pos\_code}=\\{pdftex\_first\_rint\_code}+6$\C{code
for \.{\\pdflastxpos}}\par
\P\D \37$\\{pdf\_last\_y\_pos\_code}=\\{pdftex\_first\_rint\_code}+7$\C{code
for \.{\\pdflastypos}}\par
\P\D \37$\\{pdf\_retval\_code}=\\{pdftex\_first\_rint\_code}+8$\C{global
multi-purpose return value}\par
\P\D \37$\\{pdf\_last\_ximage\_colordepth\_code}=\\{pdftex\_first\_rint%
\_code}+9$\C{code for \.{\\pdflastximagecolordepth}}\par
\P\D \37$\\{elapsed\_time\_code}=\\{pdftex\_first\_rint\_code}+10$\C{code for %
\.{\\pdfelapsedtime}}\par
\P\D \37$\\{pdf\_shell\_escape\_code}=\\{pdftex\_first\_rint\_code}+11$\C{code
for \.{\\pdfshellescape}}\par
\P\D \37$\\{random\_seed\_code}=\\{pdftex\_first\_rint\_code}+12$\C{code for %
\.{\\pdfrandomseed}}\par
\P\D \37$\\{pdf\_last\_link\_code}=\\{pdftex\_first\_rint\_code}+13$\C{code for
\.{\\pdflastlink}}\par
\P\D \37$\\{pdftex\_last\_item\_codes}=\\{pdftex\_first\_rint\_code}+13$\C{end
of \pdfTeX's command codes}\Y\par
\P\D \37$\\{eTeX\_int}=\\{pdftex\_last\_item\_codes}+1$\C{first of \eTeX\ codes
for integers}\par
\P\D \37$\\{eTeX\_dim}=\\{eTeX\_int}+8$\C{first of \eTeX\ codes for dimensions}%
\par
\P\D \37$\\{eTeX\_glue}=\\{eTeX\_dim}+9$\C{first of \eTeX\ codes for glue}\par
\P\D \37$\\{eTeX\_mu}=\\{eTeX\_glue}+1$\C{first of \eTeX\ codes for muglue}\par
\P\D \37$\\{eTeX\_expr}=\\{eTeX\_mu}+1$\C{first of \eTeX\ codes for
expressions}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"spacefactor"},\39\\{set\_aux},\39\\{hmode})$;\5
$\\{primitive}(\.{"prevdepth"},\39\\{set\_aux},\39\\{vmode})$;\6
$\\{primitive}(\.{"deadcycles"},\39\\{set\_page\_int},\390)$;\5
$\\{primitive}(\.{"insertpenalties"},\39\\{set\_page\_int},\391)$;\5
$\\{primitive}(\.{"wd"},\39\\{set\_box\_dimen},\39\\{width\_offset})$;\5
$\\{primitive}(\.{"ht"},\39\\{set\_box\_dimen},\39\\{height\_offset})$;\5
$\\{primitive}(\.{"dp"},\39\\{set\_box\_dimen},\39\\{depth\_offset})$;\5
$\\{primitive}(\.{"lastpenalty"},\39\\{last\_item},\39\\{int\_val})$;\5
$\\{primitive}(\.{"lastkern"},\39\\{last\_item},\39\\{dimen\_val})$;\5
$\\{primitive}(\.{"lastskip"},\39\\{last\_item},\39\\{glue\_val})$;\5
$\\{primitive}(\.{"inputlineno"},\39\\{last\_item},\39\\{input\_line\_no%
\_code})$;\5
$\\{primitive}(\.{"badness"},\39\\{last\_item},\39\\{badness\_code})$;\5
$\\{primitive}(\.{"pdftexversion"},\39\\{last\_item},\39\\{pdftex\_version%
\_code})$;\6
$\\{primitive}(\.{"pdflastobj"},\39\\{last\_item},\39\\{pdf\_last\_obj%
\_code})$;\6
$\\{primitive}(\.{"pdflastxform"},\39\\{last\_item},\39\\{pdf\_last\_xform%
\_code})$;\6
$\\{primitive}(\.{"pdflastximage"},\39\\{last\_item},\39\\{pdf\_last\_ximage%
\_code})$;\6
$\\{primitive}(\.{"pdflastximagepages"},\39\\{last\_item},\39\\{pdf\_last%
\_ximage\_pages\_code})$;\6
$\\{primitive}(\.{"pdflastannot"},\39\\{last\_item},\39\\{pdf\_last\_annot%
\_code})$;\6
$\\{primitive}(\.{"pdflastxpos"},\39\\{last\_item},\39\\{pdf\_last\_x\_pos%
\_code})$;\6
$\\{primitive}(\.{"pdflastypos"},\39\\{last\_item},\39\\{pdf\_last\_y\_pos%
\_code})$;\6
$\\{primitive}(\.{"pdfretval"},\39\\{last\_item},\39\\{pdf\_retval\_code})$;\6
$\\{primitive}(\.{"pdflastximagecolordepth"},\39\\{last\_item},\39\\{pdf\_last%
\_ximage\_colordepth\_code})$;\6
$\\{primitive}(\.{"pdfelapsedtime"},\39\\{last\_item},\39\\{elapsed\_time%
\_code})$;\5
$\\{primitive}(\.{"pdfshellescape"},\39\\{last\_item},\39\\{pdf\_shell\_escape%
\_code})$;\5
$\\{primitive}(\.{"pdfrandomseed"},\39\\{last\_item},\39\\{random\_seed%
\_code})$;\5
$\\{primitive}(\.{"pdflastlink"},\39\\{last\_item},\39\\{pdf\_last\_link%
\_code})$;\par
\fi

\M443. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{set\_aux}: \37\&{if} $\\{chr\_code}=\\{vmode}$ \1\&{then}\5
$\\{print\_esc}(\.{"prevdepth"})$\ \&{else} $\\{print\_esc}(%
\.{"spacefactor"})$;\2\6
\4\\{set\_page\_int}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"deadcycles"})$\2\6
\X1693:Cases of \\{set\_page\_int} for \\{print\_cmd\_chr}\X\ \&{else} \37$%
\\{print\_esc}(\.{"insertpenalties"})$;\6
\4\\{set\_box\_dimen}: \37\&{if} $\\{chr\_code}=\\{width\_offset}$ \1\&{then}\5
$\\{print\_esc}(\.{"wd"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{height\_offset}$ \1\&{then}\5
$\\{print\_esc}(\.{"ht"})$\6
\4\&{else} $\\{print\_esc}(\.{"dp"})$;\2\2\6
\4\\{last\_item}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{int\_val}: \37$\\{print\_esc}(\.{"lastpenalty"})$;\6
\4\\{dimen\_val}: \37$\\{print\_esc}(\.{"lastkern"})$;\6
\4\\{glue\_val}: \37$\\{print\_esc}(\.{"lastskip"})$;\6
\4\\{input\_line\_no\_code}: \37$\\{print\_esc}(\.{"inputlineno"})$;\6
\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\6
\4\\{pdftex\_version\_code}: \37$\\{print\_esc}(\.{"pdftexversion"})$;\6
\4\\{pdf\_last\_obj\_code}: \37$\\{print\_esc}(\.{"pdflastobj"})$;\6
\4\\{pdf\_last\_xform\_code}: \37$\\{print\_esc}(\.{"pdflastxform"})$;\6
\4\\{pdf\_last\_ximage\_code}: \37$\\{print\_esc}(\.{"pdflastximage"})$;\6
\4\\{pdf\_last\_ximage\_pages\_code}: \37$\\{print\_esc}(%
\.{"pdflastximagepages"})$;\6
\4\\{pdf\_last\_annot\_code}: \37$\\{print\_esc}(\.{"pdflastannot"})$;\6
\4\\{pdf\_last\_x\_pos\_code}: \37$\\{print\_esc}(\.{"pdflastxpos"})$;\6
\4\\{pdf\_last\_y\_pos\_code}: \37$\\{print\_esc}(\.{"pdflastypos"})$;\6
\4\\{pdf\_retval\_code}: \37$\\{print\_esc}(\.{"pdfretval"})$;\6
\4\\{pdf\_last\_ximage\_colordepth\_code}: \37$\\{print\_esc}(%
\.{"pdflastximagecolordepth"})$;\6
\4\\{elapsed\_time\_code}: \37$\\{print\_esc}(\.{"pdfelapsedtime"})$;\6
\4\\{pdf\_shell\_escape\_code}: \37$\\{print\_esc}(\.{"pdfshellescape"})$;\6
\4\\{random\_seed\_code}: \37$\\{print\_esc}(\.{"pdfrandomseed"})$;\6
\4\\{pdf\_last\_link\_code}: \37$\\{print\_esc}(\.{"pdflastlink"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"badness"})$\2\6
\&{endcases};\par
\fi

\M444. \P$\X444:Fetch the \\{space\_factor} or the \\{prev\_depth}\X\S$\6
\&{if} $\\{abs}(\\{mode})\I\|m$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ "})$;\5
$\\{print\_cmd\_chr}(\\{set\_aux},\39\|m)$;\5
$\\{help4}(\.{"You\ can\ refer\ to\ \\spacefactor\ only\ in\ horizontal\
mode;"})$\6
$(\.{"you\ can\ refer\ to\ \\prevdepth\ only\ in\ vertical\ mode;\ and"})$\6
$(\.{"neither\ of\ these\ is\ meaningful\ inside\ \\write.\ So"})$\6
$(\.{"I\'m\ forgetting\ what\ you\ said\ and\ using\ zero\ instead."})$;\5
\\{error};\6
\&{if} $\\{level}\I\\{tok\_val}$ \1\&{then}\5
$\\{scanned\_result}(0)(\\{dimen\_val})$\6
\4\&{else} $\\{scanned\_result}(0)(\\{int\_val})$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|m=\\{vmode}$ \1\&{then}\5
$\\{scanned\_result}(\\{prev\_depth})(\\{dimen\_val})$\6
\4\&{else} $\\{scanned\_result}(\\{space\_factor})(\\{int\_val})$\2\2\par
\U439.\fi

\M445. \P$\X445:Fetch the \\{dead\_cycles} or the \\{insert\_penalties}\X\S$\6
\&{begin} \37\&{if} $\|m=0$ \1\&{then}\5
$\\{cur\_val}\K\\{dead\_cycles}$\2\6
\X1694:Cases for `Fetch the \\{dead\_cycles} or the \\{insert\_penalties}'\X\6
\4\&{else} \37$\\{cur\_val}\K\\{insert\_penalties}$;\5
$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{end}\par
\U439.\fi

\M446. \P$\X446:Fetch a box dimension\X\S$\6
\&{begin} \37\\{scan\_register\_num};\5
$\\{fetch\_box}(\|q)$;\6
\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{cur\_val}\K0$\ \&{else} $\\{cur\_val}\K\\{mem}[\|q+\|m].\\{sc}$;\2\6
$\\{cur\_val\_level}\K\\{dimen\_val}$;\6
\&{end}\par
\U439.\fi

\M447. Inside an \.{\\output} routine, a user may wish to look at the page
totals
that were present at the moment when output was triggered.

\Y\P\D \37$\\{max\_dimen}\S\O{7777777777}$\C{$2^{30}-1$}\par
\Y\P$\4\X447:Fetch something on the \\{page\_so\_far}\X\S$\6
\&{begin} \37\&{if} $(\\{page\_contents}=\\{empty})\W(\R\\{output\_active})$ \1%
\&{then}\6
\&{if} $\|m=0$ \1\&{then}\5
$\\{cur\_val}\K\\{max\_dimen}$\ \&{else} $\\{cur\_val}\K0$\2\6
\4\&{else} $\\{cur\_val}\K\\{page\_so\_far}[\|m]$;\2\6
$\\{cur\_val\_level}\K\\{dimen\_val}$;\6
\&{end}\par
\U439.\fi

\M448. \P$\X448:Fetch the \\{prev\_graf}\X\S$\6
\&{if} $\\{mode}=0$ \1\&{then}\5
$\\{scanned\_result}(0)(\\{int\_val})$\C{$\\{prev\_graf}=0$ within \.{\\write}}%
\6
\4\&{else} \&{begin} \37$\\{nest}[\\{nest\_ptr}]\K\\{cur\_list}$;\5
$\|p\K\\{nest\_ptr}$;\6
\&{while} $\\{abs}(\\{nest}[\|p].\\{mode\_field})\I\\{vmode}$ \1\&{do}\5
$\\{decr}(\|p)$;\2\6
$\\{scanned\_result}(\\{nest}[\|p].\\{pg\_field})(\\{int\_val})$;\6
\&{end}\2\par
\U439.\fi

\M449. \P$\X449:Fetch the \\{par\_shape} size\X\S$\6
\&{begin} \37\&{if} $\|m>\\{par\_shape\_loc}$ \1\&{then}\5
\X1866:Fetch a penalties array element\X\6
\4\&{else} \&{if} $\\{par\_shape\_ptr}=\\{null}$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} $\\{cur\_val}\K\\{info}(\\{par\_shape\_ptr})$;\2\2\6
$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{end}\par
\U439.\fi

\M450. Here is where \.{\\lastpenalty}, \.{\\lastkern}, \.{\\lastskip}, and
\.{\\lastnodetype} are
implemented. The reference count for \.{\\lastskip} will be updated later.

We also handle \.{\\inputlineno} and \.{\\badness} here, because they are
legal in similar contexts.

The macro \\{find\_effective\_tail\_eTeX} sets \\{tx} to the last non-\.{%
\\endM}
node of the current list.

\Y\P\D \37$\\{find\_effective\_tail\_eTeX}\S\\{tx}\K\\{tail}$;\6
\&{if} $\R\\{is\_char\_node}(\\{tx})$ \1\&{then}\6
\&{if} $(\\{type}(\\{tx})=\\{math\_node})\W(\\{subtype}(\\{tx})=\\{end\_M%
\_code})$ \1\&{then}\6
\&{begin} \37$\|r\K\\{head}$;\6
\1\&{repeat} \37$\|q\K\|r$;\5
$\|r\K\\{link}(\|q)$;\6
\4\&{until}\5
$\|r=\\{tx}$;\2\6
$\\{tx}\K\|q$;\6
\&{end}\2\2\par
\P\D \37$\\{find\_effective\_tail}\S\\{find\_effective\_tail\_eTeX}$\par
\Y\P$\4\X450:Fetch an item in the current node, if appropriate\X\S$\6
\&{if} $\|m\G\\{input\_line\_no\_code}$ \1\&{then}\6
\&{if} $\|m\G\\{eTeX\_glue}$ \1\&{then}\5
\X1780:Process an expression and \&{return}\X\6
\4\&{else} \&{if} $\|m\G\\{eTeX\_dim}$ \1\&{then}\6
\&{begin} \37\&{case} $\|m$ \1\&{of}\6
\X1671:Cases for fetching a dimension value\X\2\6
\&{end};\C{there are no other cases}\6
$\\{cur\_val\_level}\K\\{dimen\_val}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{case} $\|m$ \1\&{of}\6
\4\\{input\_line\_no\_code}: \37$\\{cur\_val}\K\\{line}$;\6
\4\\{badness\_code}: \37$\\{cur\_val}\K\\{last\_badness}$;\6
\4\\{pdftex\_version\_code}: \37$\\{cur\_val}\K\\{pdftex\_version}$;\6
\4\\{pdf\_last\_obj\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_obj}$;\6
\4\\{pdf\_last\_xform\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_xform}$;\6
\4\\{pdf\_last\_ximage\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_ximage}$;\6
\4\\{pdf\_last\_ximage\_pages\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_ximage%
\_pages}$;\6
\4\\{pdf\_last\_annot\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_annot}$;\6
\4\\{pdf\_last\_x\_pos\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_x\_pos}$;\6
\4\\{pdf\_last\_y\_pos\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_y\_pos}$;\6
\4\\{pdf\_retval\_code}: \37$\\{cur\_val}\K\\{pdf\_retval}$;\6
\4\\{pdf\_last\_ximage\_colordepth\_code}: \37$\\{cur\_val}\K\\{pdf\_last%
\_ximage\_colordepth}$;\6
\4\\{elapsed\_time\_code}: \37$\\{cur\_val}\K\\{get\_microinterval}$;\6
\4\\{random\_seed\_code}: \37$\\{cur\_val}\K\\{random\_seed}$;\6
\4\\{pdf\_shell\_escape\_code}: \37\&{begin} \37\&{if} $\\{shellenabledp}$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{restrictedshell}$ \1\&{then}\5
$\\{cur\_val}\K2$\6
\4\&{else} $\\{cur\_val}\K1$;\2\6
\&{end}\6
\4\&{else} $\\{cur\_val}\K0$;\2\6
\&{end};\6
\4\\{pdf\_last\_link\_code}: \37$\\{cur\_val}\K\\{pdf\_last\_link}$;\6
\X1651:Cases for fetching an integer value\X\2\6
\&{end};\C{there are no other cases}\6
$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{end}\2\2\6
\4\&{else} \&{begin} \37\&{if} $\\{cur\_chr}=\\{glue\_val}$ \1\&{then}\5
$\\{cur\_val}\K\\{zero\_glue}$\ \&{else} $\\{cur\_val}\K0$;\2\6
\\{find\_effective\_tail};\6
\&{if} $\\{cur\_chr}=\\{last\_node\_type\_code}$ \1\&{then}\6
\&{begin} \37$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{if} $(\\{tx}=\\{head})\V(\\{mode}=0)$ \1\&{then}\5
$\\{cur\_val}\K-1$;\2\6
\&{end}\6
\4\&{else} $\\{cur\_val\_level}\K\\{cur\_chr}$;\2\6
\&{if} $\R\\{is\_char\_node}(\\{tx})\W(\\{mode}\I0)$ \1\&{then}\6
\&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{int\_val}: \37\&{if} $\\{type}(\\{tx})=\\{penalty\_node}$ \1\&{then}\5
$\\{cur\_val}\K\\{penalty}(\\{tx})$;\2\6
\4\\{dimen\_val}: \37\&{if} $\\{type}(\\{tx})=\\{kern\_node}$ \1\&{then}\5
$\\{cur\_val}\K\\{width}(\\{tx})$;\2\6
\4\\{glue\_val}: \37\&{if} $\\{type}(\\{tx})=\\{glue\_node}$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\\{glue\_ptr}(\\{tx})$;\6
\&{if} $\\{subtype}(\\{tx})=\\{mu\_glue}$ \1\&{then}\5
$\\{cur\_val\_level}\K\\{mu\_val}$;\2\6
\&{end};\2\6
\4\\{last\_node\_type\_code}: \37\&{if} $\\{type}(\\{tx})\L\\{unset\_node}$ \1%
\&{then}\5
$\\{cur\_val}\K\\{type}(\\{tx})+1$\6
\4\&{else} $\\{cur\_val}\K\\{unset\_node}+2$;\2\2\6
\&{end}\C{there are no other cases}\6
\4\&{else} \&{if} $(\\{mode}=\\{vmode})\W(\\{tx}=\\{head})$ \1\&{then}\6
\&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{int\_val}: \37$\\{cur\_val}\K\\{last\_penalty}$;\6
\4\\{dimen\_val}: \37$\\{cur\_val}\K\\{last\_kern}$;\6
\4\\{glue\_val}: \37\&{if} $\\{last\_glue}\I\\{max\_halfword}$ \1\&{then}\5
$\\{cur\_val}\K\\{last\_glue}$;\2\6
\4\\{last\_node\_type\_code}: \37$\\{cur\_val}\K\\{last\_node\_type}$;\2\6
\&{end};\C{there are no other cases}\2\2\6
\&{end}\2\par
\U439.\fi

\M451. \P$\X451:Fetch a font dimension\X\S$\6
\&{begin} \37$\\{find\_font\_dimen}(\\{false})$;\5
$\\{font\_info}[\\{fmem\_ptr}].\\{sc}\K0$;\5
$\\{scanned\_result}(\\{font\_info}[\\{cur\_val}].\\{sc})(\\{dimen\_val})$;\6
\&{end}\par
\U439.\fi

\M452. \P$\X452:Fetch a font integer\X\S$\6
\&{begin} \37\\{scan\_font\_ident};\6
\&{if} $\|m=0$ \1\&{then}\5
$\\{scanned\_result}(\\{hyphen\_char}[\\{cur\_val}])(\\{int\_val})$\6
\4\&{else} \&{if} $\|m=1$ \1\&{then}\5
$\\{scanned\_result}(\\{skew\_char}[\\{cur\_val}])(\\{int\_val})$\6
\4\&{else} \&{if} $\|m=\\{no\_lig\_code}$ \1\&{then}\5
$\\{scanned\_result}(\\{test\_no\_ligatures}(\\{cur\_val}))(\\{int\_val})$\6
\4\&{else} \&{begin} \37$\|n\K\\{cur\_val}$;\5
\\{scan\_char\_num};\5
$\|k\K\\{cur\_val}$;\6
\&{case} $\|m$ \1\&{of}\6
\4\\{lp\_code\_base}: \37$\\{scanned\_result}(\\{get\_lp\_code}(\|n,\39\|k))(%
\\{int\_val})$;\6
\4\\{rp\_code\_base}: \37$\\{scanned\_result}(\\{get\_rp\_code}(\|n,\39\|k))(%
\\{int\_val})$;\6
\4\\{ef\_code\_base}: \37$\\{scanned\_result}(\\{get\_ef\_code}(\|n,\39\|k))(%
\\{int\_val})$;\6
\4\\{tag\_code}: \37$\\{scanned\_result}(\\{get\_tag\_code}(\|n,\39\|k))(\\{int%
\_val})$;\6
\4\\{kn\_bs\_code\_base}: \37$\\{scanned\_result}(\\{get\_kn\_bs\_code}(\|n,\39%
\|k))(\\{int\_val})$;\6
\4\\{st\_bs\_code\_base}: \37$\\{scanned\_result}(\\{get\_st\_bs\_code}(\|n,\39%
\|k))(\\{int\_val})$;\6
\4\\{sh\_bs\_code\_base}: \37$\\{scanned\_result}(\\{get\_sh\_bs\_code}(\|n,\39%
\|k))(\\{int\_val})$;\6
\4\\{kn\_bc\_code\_base}: \37$\\{scanned\_result}(\\{get\_kn\_bc\_code}(\|n,\39%
\|k))(\\{int\_val})$;\6
\4\\{kn\_ac\_code\_base}: \37$\\{scanned\_result}(\\{get\_kn\_ac\_code}(\|n,\39%
\|k))(\\{int\_val})$;\2\6
\&{end};\6
\&{end};\2\2\2\6
\&{end}\par
\U439.\fi

\M453. \P$\X453:Fetch a register\X\S$\6
\&{begin} \37\&{if} $(\|m<\\{mem\_bot})\V(\|m>\\{lo\_mem\_stat\_max})$ \1%
\&{then}\6
\&{begin} \37$\\{cur\_val\_level}\K\\{sa\_type}(\|m)$;\6
\&{if} $\\{cur\_val\_level}<\\{glue\_val}$ \1\&{then}\5
$\\{cur\_val}\K\\{sa\_int}(\|m)$\6
\4\&{else} $\\{cur\_val}\K\\{sa\_ptr}(\|m)$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\\{scan\_register\_num};\5
$\\{cur\_val\_level}\K\|m-\\{mem\_bot}$;\6
\&{if} $\\{cur\_val}>255$ \1\&{then}\6
\&{begin} \37$\\{find\_sa\_element}(\\{cur\_val\_level},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}=\\{null}$ \1\&{then}\6
\&{if} $\\{cur\_val\_level}<\\{glue\_val}$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} $\\{cur\_val}\K\\{zero\_glue}$\2\6
\4\&{else} \&{if} $\\{cur\_val\_level}<\\{glue\_val}$ \1\&{then}\5
$\\{cur\_val}\K\\{sa\_int}(\\{cur\_ptr})$\6
\4\&{else} $\\{cur\_val}\K\\{sa\_ptr}(\\{cur\_ptr})$;\2\2\6
\&{end}\6
\4\&{else} \&{case} $\\{cur\_val\_level}$ \1\&{of}\6
\4\\{int\_val}: \37$\\{cur\_val}\K\\{count}(\\{cur\_val})$;\6
\4\\{dimen\_val}: \37$\\{cur\_val}\K\\{dimen}(\\{cur\_val})$;\6
\4\\{glue\_val}: \37$\\{cur\_val}\K\\{skip}(\\{cur\_val})$;\6
\4\\{mu\_val}: \37$\\{cur\_val}\K\\{mu\_skip}(\\{cur\_val})$;\2\6
\&{end};\C{there are no other cases}\2\6
\&{end};\2\6
\&{end}\par
\U439.\fi

\M454. \P$\X454:Complain that \.{\\the} can't do this; give zero result\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print}(\.{"\'\ after\ "})$;\5
$\\{print\_esc}(\.{"the"})$;\5
$\\{help1}(\.{"I\'m\ forgetting\ what\ you\ said\ and\ using\ zero\
instead."})$;\5
\\{error};\6
\&{if} $\\{level}\I\\{tok\_val}$ \1\&{then}\5
$\\{scanned\_result}(0)(\\{dimen\_val})$\6
\4\&{else} $\\{scanned\_result}(0)(\\{int\_val})$;\2\6
\&{end}\par
\U439.\fi

\M455. When a \\{glue\_val} changes to a \\{dimen\_val}, we use the width
component
of the glue; there is no need to decrease the reference count, since it
has not yet been increased.  When a \\{dimen\_val} changes to an \\{int\_val},
we use scaled points so that the value doesn't actually change. And when a
\\{mu\_val} changes to a \\{glue\_val}, the value doesn't change either.

\Y\P$\4\X455:Convert \(c)\\{cur\_val} to a lower level\X\S$\6
\&{begin} \37\&{if} $\\{cur\_val\_level}=\\{glue\_val}$ \1\&{then}\5
$\\{cur\_val}\K\\{width}(\\{cur\_val})$\6
\4\&{else} \&{if} $\\{cur\_val\_level}=\\{mu\_val}$ \1\&{then}\5
\\{mu\_error};\2\2\6
$\\{decr}(\\{cur\_val\_level})$;\6
\&{end}\par
\U439.\fi

\M456. If \\{cur\_val} points to a glue specification at this point, the
reference
count for the glue does not yet include the reference by \\{cur\_val}.
If \\{negative} is \\{true}, \\{cur\_val\_level} is known to be $\L\\{mu%
\_val}$.

\Y\P$\4\X456:Fix the reference count, if any, and negate \\{cur\_val} if %
\\{negative}\X\S$\6
\&{if} $\\{negative}$ \1\&{then}\6
\&{if} $\\{cur\_val\_level}\G\\{glue\_val}$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\\{new\_spec}(\\{cur\_val})$;\5
\X457:Negate all three glue components of \\{cur\_val}\X;\6
\&{end}\6
\4\&{else} $\\{negate}(\\{cur\_val})$\2\6
\4\&{else} \&{if} $(\\{cur\_val\_level}\G\\{glue\_val})\W(\\{cur\_val\_level}\L%
\\{mu\_val})$ \1\&{then}\5
$\\{add\_glue\_ref}(\\{cur\_val})$\2\2\par
\U439.\fi

\M457. \P$\X457:Negate all three glue components of \\{cur\_val}\X\S$\6
\&{begin} \37$\\{negate}(\\{width}(\\{cur\_val}))$;\5
$\\{negate}(\\{stretch}(\\{cur\_val}))$;\5
$\\{negate}(\\{shrink}(\\{cur\_val}))$;\6
\&{end}\par
\Us456\ET1780.\fi

\M458. Our next goal is to write the \\{scan\_int} procedure, which scans
anything that
\TeX\ treats as an integer. But first we might as well look at some simple
applications of \\{scan\_int} that have already been made inside of
\\{scan\_something\_internal}.

\fi

\M459. \P$\X459:Declare procedures that scan restricted classes of integers\X%
\S$\6
\4\&{procedure}\1\  \37\\{scan\_eight\_bit\_int};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>255)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ register\ code"})$;\5
$\\{help2}(\.{"A\ register\ number\ must\ be\ between\ 0\ and\ 255."})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\As460, 461, 462, 463\ETs1811.
\U435.\fi

\M460. \P$\X459:Declare procedures that scan restricted classes of integers\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_char\_num};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>255)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ character\ code"})$;\5
$\\{help2}(\.{"A\ character\ number\ must\ be\ between\ 0\ and\ 255."})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M461. While we're at it, we might as well deal with similar routines that
will be needed later.

\Y\P$\4\X459:Declare procedures that scan restricted classes of integers\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_four\_bit\_int};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>15)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ number"})$;\5
$\\{help2}(\.{"Since\ I\ expected\ to\ read\ a\ number\ between\ 0\ and\
15,"})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M462. \P$\X459:Declare procedures that scan restricted classes of integers\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_fifteen\_bit\_int};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>\O{77777})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ mathchar"})$;\5
$\\{help2}(\.{"A\ mathchar\ number\ must\ be\ between\ 0\ and\ 32767."})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M463. \P$\X459:Declare procedures that scan restricted classes of integers\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_twenty\_seven\_bit\_int};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>\O{777777777})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ delimiter\ code"})$;\5
$\\{help2}(\.{"A\ numeric\ delimiter\ code\ must\ be\ between\ 0\ and\ 2\^\{27%
\}-1."})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M464. An integer number can be preceded by any number of spaces and `\.+' or
`\.-' signs. Then comes either a decimal constant (i.e., radix 10), an
octal constant (i.e., radix 8, preceded by~\.\'), a hexadecimal constant
(radix 16, preceded by~\."), an alphabetic constant (preceded by~\.\`), or
an internal variable. After scanning is complete,
\\{cur\_val} will contain the answer, which must be at most
$2^{31}-1=2147483647$ in absolute value. The value of \\{radix} is set to
10, 8, or 16 in the cases of decimal, octal, or hexadecimal constants,
otherwise \\{radix} is set to zero. An optional space follows a constant.

\Y\P\D \37$\\{octal\_token}=\\{other\_token}+\.{"\'"}$\C{apostrophe, indicates
an octal constant}\par
\P\D \37$\\{hex\_token}=\\{other\_token}+\.{""}\.{""}$\C{double quote,
indicates a hex constant}\par
\P\D \37$\\{alpha\_token}=\\{other\_token}+\.{"\`"}$\C{reverse apostrophe,
precedes alpha constants}\par
\P\D \37$\\{point\_token}=\\{other\_token}+\.{"."}$\C{decimal point}\par
\P\D \37$\\{continental\_point\_token}=\\{other\_token}+\.{","}$\C{decimal
point, Eurostyle}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{radix}: \37\\{small\_number};\C{\\{scan\_int} sets this to 8, 10, 16, or
zero}\par
\fi

\M465. We initialize the following global variables just in case \\{expand}
comes into action before any of the basic scanning routines has assigned
them a value.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{cur\_val}\K0$;\5
$\\{cur\_val\_level}\K\\{int\_val}$;\5
$\\{radix}\K0$;\5
$\\{cur\_order}\K\\{normal}$;\par
\fi

\M466. The \\{scan\_int} routine is used also to scan the integer part of a
fraction; for example, the `\.3' in `\.{3.14159}' will be found by
\\{scan\_int}. The \\{scan\_dimen} routine assumes that $\\{cur\_tok}=\\{point%
\_token}$
after the integer part of such a fraction has been scanned by \\{scan\_int},
and that the decimal point has been backed up to be scanned again.

\Y\P\4\&{procedure}\1\  \37\\{scan\_int};\C{sets \\{cur\_val} to an integer}\6
\4\&{label} \37$\\{done},\39\\{restart}$;\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should the answer be negated?}\6
\|m: \37\\{integer};\C{$\hbox{$2^{31}$}\mathbin{\&{div}}\\{radix}$, the
threshold of danger}\6
\|d: \37\\{small\_number};\C{the digit just scanned}\6
\\{vacuous}: \37\\{boolean};\C{have no digits appeared?}\6
\\{OK\_so\_far}: \37\\{boolean};\C{has an error message been issued?}\2\6
\&{begin} \37$\\{radix}\K0$;\5
$\\{OK\_so\_far}\K\\{true}$;\6
\X467:Get the next non-blank non-sign token; set \\{negative} appropriately\X;\6
\4\\{restart}: \37\&{if} $\\{cur\_tok}=\\{alpha\_token}$ \1\&{then}\5
\X468:Scan an alphabetic character code into \\{cur\_val}\X\6
\4\&{else} \&{if} $\\{cur\_tok}=\\{cs\_token\_flag}+\\{frozen\_primitive}$ \1%
\&{then}\5
\X395:Reset \\{cur\_tok} for unexpandable primitives, goto restart\X\6
\4\&{else} \&{if} $(\\{cur\_cmd}\G\\{min\_internal})\W(\\{cur\_cmd}\L\\{max%
\_internal})$ \1\&{then}\5
$\\{scan\_something\_internal}(\\{int\_val},\39\\{false})$\6
\4\&{else} \X470:Scan a numeric constant\X;\2\2\2\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\\{cur\_val})$;\2\6
\&{end};\par
\fi

\M467. \P$\X467:Get the next non-blank non-sign token; set \\{negative}
appropriately\X\S$\6
$\\{negative}\K\\{false}$;\6
\1\&{repeat} \37\X432:Get the next non-blank non-call token\X;\6
\&{if} $\\{cur\_tok}=\\{other\_token}+\.{"-"}$ \1\&{then}\6
\&{begin} \37$\\{negative}\K\R\\{negative}$;\5
$\\{cur\_tok}\K\\{other\_token}+\.{"+"}$;\6
\&{end};\2\6
\4\&{until}\5
$\\{cur\_tok}\I\\{other\_token}+\.{"+"}$\2\par
\Us466, 474\ETs487.\fi

\M468. A space is ignored after an alphabetic character constant, so that
such constants behave like numeric ones.

\Y\P$\4\X468:Scan an alphabetic character code into \\{cur\_val}\X\S$\6
\&{begin} \37\\{get\_token};\C{suppress macro expansion}\6
\&{if} $\\{cur\_tok}<\\{cs\_token\_flag}$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\\{cur\_chr}$;\6
\&{if} $\\{cur\_cmd}\L\\{right\_brace}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}=\\{right\_brace}$ \1\&{then}\5
$\\{incr}(\\{align\_state})$\6
\4\&{else} $\\{decr}(\\{align\_state})$;\2\2\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_tok}<\\{cs\_token\_flag}+\\{single\_base}$ \1%
\&{then}\5
$\\{cur\_val}\K\\{cur\_tok}-\\{cs\_token\_flag}-\\{active\_base}$\6
\4\&{else} $\\{cur\_val}\K\\{cur\_tok}-\\{cs\_token\_flag}-\\{single\_base}$;\2%
\2\6
\&{if} $\\{cur\_val}>255$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ alphabetic\ constant"})$;\5
$\\{help2}(\.{"A\ one-character\ control\ sequence\ belongs\ after\ a\ \`\
mark."})$\6
$(\.{"So\ I\'m\ essentially\ inserting\ \\0\ here."})$;\5
$\\{cur\_val}\K\.{"0"}$;\5
\\{back\_error};\6
\&{end}\6
\4\&{else} \X469:Scan an optional space\X;\2\6
\&{end}\par
\U466.\fi

\M469. \P$\X469:Scan an optional space\X\S$\6
\&{begin} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cmd}\I\\{spacer}$ \1\&{then}\5
\\{back\_input};\2\6
\&{end}\par
\Us468, 474, 481, 705, 1378, 1544, 1556, 1556, 1558\ETs1565.\fi

\M470. \P$\X470:Scan a numeric constant\X\S$\6
\&{begin} \37$\\{radix}\K10$;\5
$\|m\K214748364$;\6
\&{if} $\\{cur\_tok}=\\{octal\_token}$ \1\&{then}\6
\&{begin} \37$\\{radix}\K8$;\5
$\|m\K\O{2000000000}$;\5
\\{get\_x\_token};\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_tok}=\\{hex\_token}$ \1\&{then}\6
\&{begin} \37$\\{radix}\K16$;\5
$\|m\K\O{1000000000}$;\5
\\{get\_x\_token};\6
\&{end};\2\2\6
$\\{vacuous}\K\\{true}$;\5
$\\{cur\_val}\K0$;\6
\X471:Accumulate the constant until \\{cur\_tok} is not a suitable digit\X;\6
\&{if} $\\{vacuous}$ \1\&{then}\5
\X472:Express astonishment that no number was here\X\6
\4\&{else} \&{if} $\\{cur\_cmd}\I\\{spacer}$ \1\&{then}\5
\\{back\_input};\2\2\6
\&{end}\par
\U466.\fi

\M471. \P\D \37$\\{infinity}\S\O{17777777777}$\C{the largest positive value
that \TeX\ knows}\par
\P\D \37$\\{zero\_token}=\\{other\_token}+\.{"0"}$\C{zero, the smallest digit}%
\par
\P\D \37$\\{A\_token}=\\{letter\_token}+\.{"A"}$\C{the smallest special hex
digit}\par
\P\D \37$\\{other\_A\_token}=\\{other\_token}+\.{"A"}$\C{special hex digit of
type \\{other\_char}}\par
\Y\P$\4\X471:Accumulate the constant until \\{cur\_tok} is not a suitable digit%
\X\S$\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $(\\{cur\_tok}<\\{zero\_token}+\\{radix})\W(%
\\{cur\_tok}\G\\{zero\_token})\W(\\{cur\_tok}\L\\{zero\_token}+9)$ \1\&{then}\5
$\|d\K\\{cur\_tok}-\\{zero\_token}$\6
\4\&{else} \&{if} $\\{radix}=16$ \1\&{then}\6
\&{if} $(\\{cur\_tok}\L\\{A\_token}+5)\W(\\{cur\_tok}\G\\{A\_token})$ \1%
\&{then}\5
$\|d\K\\{cur\_tok}-\\{A\_token}+10$\6
\4\&{else} \&{if} $(\\{cur\_tok}\L\\{other\_A\_token}+5)\W(\\{cur\_tok}\G%
\\{other\_A\_token})$ \1\&{then}\5
$\|d\K\\{cur\_tok}-\\{other\_A\_token}+10$\6
\4\&{else} \&{goto} \37\\{done}\2\2\6
\4\&{else} \&{goto} \37\\{done};\2\2\6
$\\{vacuous}\K\\{false}$;\6
\&{if} $(\\{cur\_val}\G\|m)\W((\\{cur\_val}>\|m)\V(\|d>7)\V(\\{radix}\I10))$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{OK\_so\_far}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Number\ too\ big"})$;\5
$\\{help2}(\.{"I\ can\ only\ go\ up\ to\ 2147483647=\'17777777777="}%
\.{"7FFFFFFF,"})$\6
$(\.{"so\ I\'m\ using\ that\ number\ instead\ of\ yours."})$;\5
\\{error};\5
$\\{cur\_val}\K\\{infinity}$;\5
$\\{OK\_so\_far}\K\\{false}$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\\{cur\_val}\K\\{cur\_val}\ast\\{radix}+\|d$;\2\6
\\{get\_x\_token};\6
\&{end};\2\6
\4\\{done}: \37\par
\U470.\fi

\M472. \P$\X472:Express astonishment that no number was here\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ number,\ treated\ as\ zero"})$;\5
$\\{help3}(\.{"A\ number\ should\ have\ been\ here;\ I\ inserted\ \`0\'."})$\6
$(\.{"(If\ you\ can\'t\ figure\ out\ why\ I\ needed\ to\ see\ a\ number,"})$\6
$(\.{"look\ up\ \`weird\ error\'\ in\ the\ index\ to\ The\ TeXbook.)"})$;\5
\\{back\_error};\6
\&{end}\par
\U470.\fi

\M473. The \\{scan\_dimen} routine is similar to \\{scan\_int}, but it sets %
\\{cur\_val} to
a \\{scaled} value, i.e., an integral number of sp. One of its main tasks
is therefore to interpret the abbreviations for various kinds of units and
to convert measurements to scaled points.

There are three parameters: \\{mu} is \\{true} if the finite units must be
`\.{mu}', while \\{mu} is \\{false} if `\.{mu}' units are disallowed;
\\{inf} is \\{true} if the infinite units `\.{fil}', `\.{fill}', `\.{filll}'
are permitted; and \\{shortcut} is \\{true} if \\{cur\_val} already contains
an integer and only the units need to be considered.

The order of infinity that was found in the case of infinite glue is returned
in the global variable \\{cur\_order}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_order}: \37\\{glue\_ord};\C{order of infinity found by \\{scan%
\_dimen}}\par
\fi

\M474. Constructions like `\.{-\'77 pt}' are legal dimensions, so \\{scan%
\_dimen}
may begin with \\{scan\_int}. This explains why it is convenient to use
\\{scan\_int} also for the integer part of a decimal fraction.

Several branches of \\{scan\_dimen} work with \\{cur\_val} as an integer and
with an auxiliary fraction \|f, so that the actual quantity of interest is
$\\{cur\_val}+\|f/2^{16}$. At the end of the routine, this ``unpacked''
representation is put into the single word \\{cur\_val}, which suddenly
switches significance from \\{integer} to \\{scaled}.

\Y\P\D \37$\\{attach\_fraction}=88$\C{go here to pack \\{cur\_val} and \|f into
\\{cur\_val}}\par
\P\D \37$\\{attach\_sign}=89$\C{go here when \\{cur\_val} is correct except
perhaps for sign}\par
\P\D \37$\\{scan\_normal\_dimen}\S\\{scan\_dimen}(\\{false},\39\\{false},\39%
\\{false})$\par
\Y\P\4\&{procedure}\1\  \37$\\{scan\_dimen}(\\{mu},\39\\{inf},\39\\{shortcut}:%
\\{boolean})$;\C{sets \\{cur\_val} to a dimension}\6
\4\&{label} \37$\\{done},\39\\{done1},\39\\{done2},\39\\{found},\39\\{not%
\_found},\39\\{attach\_fraction},\39\\{attach\_sign}$;\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should the answer be negated?}\6
\|f: \37\\{integer};\C{numerator of a fraction whose denominator is $2^{16}$}\6
\X476:Local variables for dimension calculations\X\2\6
\&{begin} \37$\|f\K0$;\5
$\\{arith\_error}\K\\{false}$;\5
$\\{cur\_order}\K\\{normal}$;\5
$\\{negative}\K\\{false}$;\6
\&{if} $\R\\{shortcut}$ \1\&{then}\6
\&{begin} \37\X467:Get the next non-blank non-sign token; set \\{negative}
appropriately\X;\6
\&{if} $(\\{cur\_cmd}\G\\{min\_internal})\W(\\{cur\_cmd}\L\\{max\_internal})$ %
\1\&{then}\5
\X475:Fetch an internal dimension and \&{goto} \\{attach\_sign}, or fetch an
internal integer\X\6
\4\&{else} \&{begin} \37\\{back\_input};\6
\&{if} $\\{cur\_tok}=\\{continental\_point\_token}$ \1\&{then}\5
$\\{cur\_tok}\K\\{point\_token}$;\2\6
\&{if} $\\{cur\_tok}\I\\{point\_token}$ \1\&{then}\5
\\{scan\_int}\6
\4\&{else} \&{begin} \37$\\{radix}\K10$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{if} $\\{cur\_tok}=\\{continental\_point\_token}$ \1\&{then}\5
$\\{cur\_tok}\K\\{point\_token}$;\2\6
\&{if} $(\\{radix}=10)\W(\\{cur\_tok}=\\{point\_token})$ \1\&{then}\5
\X478:Scan decimal fraction\X;\2\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\C{in this case $\|f=0$}\6
\&{begin} \37$\\{negative}\K\R\\{negative}$;\5
$\\{negate}(\\{cur\_val})$;\6
\&{end};\2\6
\X479:Scan units and set \\{cur\_val} to $x\cdot(\\{cur\_val}+f/2^{16})$, where
there are \|x sp per unit; \&{goto} \\{attach\_sign} if the units are internal%
\X;\6
\X469:Scan an optional space\X;\6
\4\\{attach\_sign}: \37\&{if} $\\{arith\_error}\V(\\{abs}(\\{cur\_val})\G%
\O{10000000000})$ \1\&{then}\5
\X486:Report that this dimension is out of range\X;\2\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\\{cur\_val})$;\2\6
\&{end};\par
\fi

\M475. \P$\X475:Fetch an internal dimension and \&{goto} \\{attach\_sign}, or
fetch an internal integer\X\S$\6
\&{if} $\\{mu}$ \1\&{then}\6
\&{begin} \37$\\{scan\_something\_internal}(\\{mu\_val},\39\\{false})$;\5
\X477:Coerce glue to a dimension\X;\6
\&{if} $\\{cur\_val\_level}=\\{mu\_val}$ \1\&{then}\5
\&{goto} \37\\{attach\_sign};\2\6
\&{if} $\\{cur\_val\_level}\I\\{int\_val}$ \1\&{then}\5
\\{mu\_error};\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{scan\_something\_internal}(\\{dimen\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_val\_level}=\\{dimen\_val}$ \1\&{then}\5
\&{goto} \37\\{attach\_sign};\2\6
\&{end}\2\par
\U474.\fi

\M476. \P$\X476:Local variables for dimension calculations\X\S$\6
\4$\\{num},\39\\{denom}$: \37$1\to65536$;\C{conversion ratio for the scanned
units}\6
\4$\|k,\39\\{kk}$: \37\\{small\_number};\C{number of digits in a decimal
fraction}\6
\4$\|p,\39\|q$: \37\\{pointer};\C{top of decimal digit stack}\6
\4\|v: \37\\{scaled};\C{an internal dimension}\6
\4\\{save\_cur\_val}: \37\\{integer};\C{temporary storage of \\{cur\_val}}\par
\U474.\fi

\M477. The following code is executed when \\{scan\_something\_internal} was
called asking for \\{mu\_val}, when we really wanted a ``mudimen'' instead
of ``muglue.''

\Y\P$\4\X477:Coerce glue to a dimension\X\S$\6
\&{if} $\\{cur\_val\_level}\G\\{glue\_val}$ \1\&{then}\6
\&{begin} \37$\|v\K\\{width}(\\{cur\_val})$;\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\5
$\\{cur\_val}\K\|v$;\6
\&{end}\2\par
\Us475\ET481.\fi

\M478. When the following code is executed, we have $\\{cur\_tok}=\\{point%
\_token}$, but this
token has been backed up using \\{back\_input}; we must first discard it.

It turns out that a decimal point all by itself is equivalent to `\.{0.0}'.
Let's hope people don't use that fact.

\Y\P$\4\X478:Scan decimal fraction\X\S$\6
\&{begin} \37$\|k\K0$;\5
$\|p\K\\{null}$;\5
\\{get\_token};\C{\\{point\_token} is being re-scanned}\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_x\_token};\6
\&{if} $(\\{cur\_tok}>\\{zero\_token}+9)\V(\\{cur\_tok}<\\{zero\_token})$ \1%
\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $\|k<17$ \1\&{then}\C{digits for $\|k\G17$ cannot affect the result}\6
\&{begin} \37$\|q\K\\{get\_avail}$;\5
$\\{link}(\|q)\K\|p$;\5
$\\{info}(\|q)\K\\{cur\_tok}-\\{zero\_token}$;\5
$\|p\K\|q$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{done1}: \37\&{for} $\\{kk}\K\|k\mathrel{\&{downto}}1$ \1\&{do}\6
\&{begin} \37$\\{dig}[\\{kk}-1]\K\\{info}(\|p)$;\5
$\|q\K\|p$;\5
$\|p\K\\{link}(\|p)$;\5
$\\{free\_avail}(\|q)$;\6
\&{end};\2\6
$\|f\K\\{round\_decimals}(\|k)$;\6
\&{if} $\\{cur\_cmd}\I\\{spacer}$ \1\&{then}\5
\\{back\_input};\2\6
\&{end}\par
\U474.\fi

\M479. Now comes the harder part: At this point in the program, \\{cur\_val} is
a
nonnegative integer and $f/2^{16}$ is a nonnegative fraction less than 1;
we want to multiply the sum of these two quantities by the appropriate
factor, based on the specified units, in order to produce a \\{scaled}
result, and we want to do the calculation with fixed point arithmetic that
does not overflow.

\Y\P$\4\X479:Scan units and set \\{cur\_val} to $x\cdot(\\{cur%
\_val}+f/2^{16})$, where there are \|x sp per unit; \&{goto} \\{attach\_sign}
if the units are internal\X\S$\6
\&{if} $\\{inf}$ \1\&{then}\5
\X480:Scan for \(f)\.{fil} units; \&{goto} \\{attach\_fraction} if found\X;\2\6
\X481:Scan for \(u)units that are internal dimensions; \&{goto} \\{attach%
\_sign} with \\{cur\_val} set if found\X;\6
\&{if} $\\{mu}$ \1\&{then}\5
\X482:Scan for \(m)\.{mu} units and \&{goto} \\{attach\_fraction}\X;\2\6
\&{if} $\\{scan\_keyword}(\.{"true"})$ \1\&{then}\5
\X483:Adjust \(f)for the magnification ratio\X;\2\6
\&{if} $\\{scan\_keyword}(\.{"pt"})$ \1\&{then}\5
\&{goto} \37\\{attach\_fraction};\C{the easy case}\2\6
\X484:Scan for \(a)all other units and adjust \\{cur\_val} and \|f accordingly;
\&{goto} \\{done} in the case of scaled points\X;\6
\4\\{attach\_fraction}: \37\&{if} $\\{cur\_val}\G\O{40000}$ \1\&{then}\5
$\\{arith\_error}\K\\{true}$\6
\4\&{else} $\\{cur\_val}\K\\{cur\_val}\ast\\{unity}+\|f$;\2\6
\4\\{done}: \37\par
\U474.\fi

\M480. A specification like `\.{filllll}' or `\.{fill L L L}' will lead to two
error messages (one for each additional keyword \.{"l"}).

\Y\P$\4\X480:Scan for \(f)\.{fil} units; \&{goto} \\{attach\_fraction} if found%
\X\S$\6
\&{if} $\\{scan\_keyword}(\.{"fil"})$ \1\&{then}\6
\&{begin} \37$\\{cur\_order}\K\\{fil}$;\6
\&{while} $\\{scan\_keyword}(\.{"l"})$ \1\&{do}\6
\&{begin} \37\&{if} $\\{cur\_order}=\\{filll}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ unit\ of\ measure\ ("})$;\5
$\\{print}(\.{"replaced\ by\ filll)"})$;\5
$\\{help1}(\.{"I\ dddon\'t\ go\ any\ higher\ than\ filll."})$;\5
\\{error};\6
\&{end}\6
\4\&{else} $\\{incr}(\\{cur\_order})$;\2\6
\&{end};\2\6
\&{goto} \37\\{attach\_fraction};\6
\&{end}\2\par
\U479.\fi

\M481. \P$\X481:Scan for \(u)units that are internal dimensions; \&{goto} %
\\{attach\_sign} with \\{cur\_val} set if found\X\S$\6
$\\{save\_cur\_val}\K\\{cur\_val}$;\5
\X432:Get the next non-blank non-call token\X;\6
\&{if} $(\\{cur\_cmd}<\\{min\_internal})\V(\\{cur\_cmd}>\\{max\_internal})$ \1%
\&{then}\5
\\{back\_input}\6
\4\&{else} \&{begin} \37\&{if} $\\{mu}$ \1\&{then}\6
\&{begin} \37$\\{scan\_something\_internal}(\\{mu\_val},\39\\{false})$;\5
\X477:Coerce glue to a dimension\X;\6
\&{if} $\\{cur\_val\_level}\I\\{mu\_val}$ \1\&{then}\5
\\{mu\_error};\2\6
\&{end}\6
\4\&{else} $\\{scan\_something\_internal}(\\{dimen\_val},\39\\{false})$;\2\6
$\|v\K\\{cur\_val}$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\&{if} $\\{mu}$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\&{if} $\\{scan\_keyword}(\.{"em"})$ \1\&{then}\5
$\|v\K(\X584:The em width for \\{cur\_font}\X)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"ex"})$ \1\&{then}\5
$\|v\K(\X585:The x-height for \\{cur\_font}\X)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"px"})$ \1\&{then}\5
$\|v\K\\{pdf\_px\_dimen}$\6
\4\&{else} \&{goto} \37\\{not\_found};\2\2\2\6
\X469:Scan an optional space\X;\6
\4\\{found}: \37$\\{cur\_val}\K\\{nx\_plus\_y}(\\{save\_cur\_val},\39\|v,\39%
\\{xn\_over\_d}(\|v,\39\|f,\39\O{200000}))$;\5
\&{goto} \37\\{attach\_sign};\6
\4\\{not\_found}: \37\par
\U479.\fi

\M482. \P$\X482:Scan for \(m)\.{mu} units and \&{goto} \\{attach\_fraction}\X%
\S$\6
\&{if} $\\{scan\_keyword}(\.{"mu"})$ \1\&{then}\5
\&{goto} \37\\{attach\_fraction}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Illegal\ unit\ of\ measure\ ("})$;\5
$\\{print}(\.{"mu\ inserted)"})$;\5
$\\{help4}(\.{"The\ unit\ of\ measurement\ in\ math\ glue\ must\ be\ mu."})$\6
$(\.{"To\ recover\ gracefully\ from\ this\ error,\ it\'s\ best\ to"})$\6
$(\.{"delete\ the\ erroneous\ units;\ e.g.,\ type\ \`2\'\ to\ delete"})$\6
$(\.{"two\ letters.\ (See\ Chapter\ 27\ of\ The\ TeXbook.)"})$;\5
\\{error};\5
\&{goto} \37\\{attach\_fraction};\6
\&{end}\2\par
\U479.\fi

\M483. \P$\X483:Adjust \(f)for the magnification ratio\X\S$\6
\&{begin} \37\\{prepare\_mag};\6
\&{if} $\\{mag}\I1000$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\\{xn\_over\_d}(\\{cur\_val},\391000,\39\\{mag})$;\5
$\|f\K(1000\ast\|f+\O{200000}\ast\\{remainder})\mathbin{\&{div}}\\{mag}$;\5
$\\{cur\_val}\K\\{cur\_val}+(\|f\mathbin{\&{div}}\O{200000})$;\5
$\|f\K\|f\mathbin{\&{mod}}\O{200000}$;\6
\&{end};\2\6
\&{end}\par
\U479.\fi

\M484. The necessary conversion factors can all be specified exactly as
fractions whose numerator and denominator sum to 32768 or less.
According to the definitions here, $\rm2660\,dd\approx1000.33297\,mm$;
this agrees well with the value $\rm1000.333\,mm$ cited by Bosshard
in {\sl Technische Grundlagen zur Satzherstellung\/} (Bern, 1980).
The Didot point has been newly standardized in 1978;
it's now exactly $\rm 1\,nd=0.375\,mm$.
Conversion uses the equation $0.375=21681/20320/72.27\cdot25.4$.
The new Cicero follows the new Didot point; $\rm 1\,nc=12\,nd$.
These would lead to the ratios $21681/20320$ and $65043/5080$,
respectively.
The closest approximations supported by the algorithm would be
$11183/10481$ and $1370/107$.  In order to maintain the
relation $\rm 1\,nc=12\,nd$, we pick the ratio $685/642$ for
$\rm nd$, however.

\Y\P\D \37$\\{set\_conversion\_end}(\#)\S\\{denom}\K\#$; \6
\&{end} \par
\P\D \37$\\{set\_conversion}(\#)\S$\ \&{begin} \37$\\{num}\K\#$;\5
\\{set\_conversion\_end}\par
\Y\P$\4\X484:Scan for \(a)all other units and adjust \\{cur\_val} and \|f
accordingly; \&{goto} \\{done} in the case of scaled points\X\S$\6
\&{if} $\\{scan\_keyword}(\.{"in"})$ \1\&{then}\5
$\\{set\_conversion}(7227)(100)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"pc"})$ \1\&{then}\5
$\\{set\_conversion}(12)(1)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"cm"})$ \1\&{then}\5
$\\{set\_conversion}(7227)(254)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"mm"})$ \1\&{then}\5
$\\{set\_conversion}(7227)(2540)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"bp"})$ \1\&{then}\5
$\\{set\_conversion}(7227)(7200)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"dd"})$ \1\&{then}\5
$\\{set\_conversion}(1238)(1157)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"cc"})$ \1\&{then}\5
$\\{set\_conversion}(14856)(1157)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"nd"})$ \1\&{then}\5
$\\{set\_conversion}(685)(642)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"nc"})$ \1\&{then}\5
$\\{set\_conversion}(1370)(107)$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"sp"})$ \1\&{then}\5
\&{goto} \37\\{done}\6
\4\&{else} \X485:Complain about unknown unit and \&{goto} \\{done2}\X;\2\2\2\2%
\2\2\2\2\2\2\6
$\\{cur\_val}\K\\{xn\_over\_d}(\\{cur\_val},\39\\{num},\39\\{denom})$;\5
$\|f\K(\\{num}\ast\|f+\O{200000}\ast\\{remainder})\mathbin{\&{div}}\\{denom}$;\6
$\\{cur\_val}\K\\{cur\_val}+(\|f\mathbin{\&{div}}\O{200000})$;\5
$\|f\K\|f\mathbin{\&{mod}}\O{200000}$;\6
\4\\{done2}: \37\par
\U479.\fi

\M485. \P$\X485:Complain about unknown unit and \&{goto} \\{done2}\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ unit\ of\ measure\ ("})$;\5
$\\{print}(\.{"pt\ inserted)"})$;\5
$\\{help6}(\.{"Dimensions\ can\ be\ in\ units\ of\ em,\ ex,\ in,\ pt,\ pc,"})$\6
$(\.{"cm,\ mm,\ dd,\ cc,\ nd,\ nc,\ bp,\ or\ sp;\ but\ yours\ is\ a\ new\
one!"})$\6
$(\.{"I\'ll\ assume\ that\ you\ meant\ to\ say\ pt,\ for\ printer\'s\
points."})$\6
$(\.{"To\ recover\ gracefully\ from\ this\ error,\ it\'s\ best\ to"})$\6
$(\.{"delete\ the\ erroneous\ units;\ e.g.,\ type\ \`2\'\ to\ delete"})$\6
$(\.{"two\ letters.\ (See\ Chapter\ 27\ of\ The\ TeXbook.)"})$;\5
\\{error};\5
\&{goto} \37\\{done2};\6
\&{end}\par
\U484.\fi

\M486. \P$\X486:Report that this dimension is out of range\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Dimension\ too\ large"})$;\5
$\\{help2}(\.{"I\ can\'t\ work\ with\ sizes\ bigger\ than\ about\ 19\ feet."})$%
\6
$(\.{"Continue\ and\ I\'ll\ use\ the\ largest\ value\ I\ can."})$;\6
\\{error};\5
$\\{cur\_val}\K\\{max\_dimen}$;\5
$\\{arith\_error}\K\\{false}$;\6
\&{end}\par
\U474.\fi

\M487. The final member of \TeX's value-scanning trio is \\{scan\_glue}, which
makes \\{cur\_val} point to a glue specification. The reference count of that
glue spec will take account of the fact that \\{cur\_val} is pointing to~it.

The \\{level} parameter should be either \\{glue\_val} or \\{mu\_val}.

Since \\{scan\_dimen} was so much more complex than \\{scan\_int}, we might
expect
\\{scan\_glue} to be even worse. But fortunately, it is very simple, since
most of the work has already been done.

\Y\P\4\&{procedure}\1\  \37$\\{scan\_glue}(\\{level}:\\{small\_number})$;%
\C{sets \\{cur\_val} to a glue spec pointer}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should the answer be negated?}\6
\|q: \37\\{pointer};\C{new glue specification}\6
\\{mu}: \37\\{boolean};\C{does $\\{level}=\\{mu\_val}$?}\2\6
\&{begin} \37$\\{mu}\K(\\{level}=\\{mu\_val})$;\5
\X467:Get the next non-blank non-sign token; set \\{negative} appropriately\X;\6
\&{if} $(\\{cur\_cmd}\G\\{min\_internal})\W(\\{cur\_cmd}\L\\{max\_internal})$ %
\1\&{then}\6
\&{begin} \37$\\{scan\_something\_internal}(\\{level},\39\\{negative})$;\6
\&{if} $\\{cur\_val\_level}\G\\{glue\_val}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_val\_level}\I\\{level}$ \1\&{then}\5
\\{mu\_error};\2\6
\&{return};\6
\&{end};\2\6
\&{if} $\\{cur\_val\_level}=\\{int\_val}$ \1\&{then}\5
$\\{scan\_dimen}(\\{mu},\39\\{false},\39\\{true})$\6
\4\&{else} \&{if} $\\{level}=\\{mu\_val}$ \1\&{then}\5
\\{mu\_error};\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\\{back\_input};\5
$\\{scan\_dimen}(\\{mu},\39\\{false},\39\\{false})$;\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\\{cur\_val})$;\2\6
\&{end};\2\6
\X488:Create a new glue specification whose width is \\{cur\_val}; scan for its
stretch and shrink components\X;\6
\4\\{exit}: \37\&{end};\7
\X1782:Declare procedures needed for expressions\X\par
\fi

\M488. \P$\X488:Create a new glue specification whose width is \\{cur\_val};
scan for its stretch and shrink components\X\S$\6
$\|q\K\\{new\_spec}(\\{zero\_glue})$;\5
$\\{width}(\|q)\K\\{cur\_val}$;\6
\&{if} $\\{scan\_keyword}(\.{"plus"})$ \1\&{then}\6
\&{begin} \37$\\{scan\_dimen}(\\{mu},\39\\{true},\39\\{false})$;\5
$\\{stretch}(\|q)\K\\{cur\_val}$;\5
$\\{stretch\_order}(\|q)\K\\{cur\_order}$;\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"minus"})$ \1\&{then}\6
\&{begin} \37$\\{scan\_dimen}(\\{mu},\39\\{true},\39\\{false})$;\5
$\\{shrink}(\|q)\K\\{cur\_val}$;\5
$\\{shrink\_order}(\|q)\K\\{cur\_order}$;\6
\&{end};\2\6
$\\{cur\_val}\K\|q$\par
\U487.\fi

\M489. Here's a similar procedure that returns a pointer to a rule node. This
routine is called just after \TeX\ has seen \.{\\hrule} or \.{\\vrule};
therefore \\{cur\_cmd} will be either \\{hrule} or \\{vrule}. The idea is to
store
the default rule dimensions in the node, then to override them if
`\.{height}' or `\.{width}' or `\.{depth}' specifications are
found (in any order).

\Y\P\D \37$\\{default\_rule}=26214$\C{0.4\thinspace pt}\par
\Y\P\4\&{function}\1\  \37\\{scan\_rule\_spec}: \37\\{pointer};\6
\4\&{label} \37\\{reswitch};\6
\4\&{var} \37\|q: \37\\{pointer};\C{the rule node being created}\2\6
\&{begin} \37$\|q\K\\{new\_rule}$;\C{\\{width}, \\{depth}, and \\{height} all
equal \\{null\_flag} now}\6
\&{if} $\\{cur\_cmd}=\\{vrule}$ \1\&{then}\5
$\\{width}(\|q)\K\\{default\_rule}$\6
\4\&{else} \&{begin} \37$\\{height}(\|q)\K\\{default\_rule}$;\5
$\\{depth}(\|q)\K0$;\6
\&{end};\2\6
\4\\{reswitch}: \37\&{if} $\\{scan\_keyword}(\.{"width"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{width}(\|q)\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"height"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{height}(\|q)\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"depth"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{depth}(\|q)\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
$\\{scan\_rule\_spec}\K\|q$;\6
\&{end};\par
\fi

\N490.  \[27] Building token lists.
The token lists for macros and for other things like \.{\\mark} and \.{%
\\output}
and \.{\\write} are produced by a procedure called \\{scan\_toks}.

Before we get into the details of \\{scan\_toks}, let's consider a much
simpler task, that of converting the current string into a token list.
The \\{str\_toks} function does this; it classifies spaces as type \\{spacer}
and everything else as type \\{other\_char}.

The token list created by \\{str\_toks} begins at $\\{link}(\\{temp\_head})$
and ends
at the value \|p that is returned. (If $\|p=\\{temp\_head}$, the list is
empty.)

\Y\P\hbox{\4}\X1683:Declare \eTeX\ procedures for token lists\X\6
\4\&{function}\1\  \37$\\{str\_toks}(\|b:\\{pool\_pointer})$: \37\\{pointer};%
\C{converts $\\{str\_pool}[\|b\to\\{pool\_ptr}-1]$ to a token list}\6
\4\&{var} \37\|p: \37\\{pointer};\C{tail of the token list}\6
\|q: \37\\{pointer};\C{new node being added to the token list via \\{store\_new%
\_token}}\6
\|t: \37\\{halfword};\C{token being appended}\6
\|k: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\2\6
\&{begin} \37$\\{str\_room}(1)$;\5
$\|p\K\\{temp\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\|k\K\|b$;\6
\&{while} $\|k<\\{pool\_ptr}$ \1\&{do}\6
\&{begin} \37$\|t\K\\{so}(\\{str\_pool}[\|k])$;\6
\&{if} $\|t=\.{"\ "}$ \1\&{then}\5
$\|t\K\\{space\_token}$\6
\4\&{else} $\|t\K\\{other\_token}+\|t$;\2\6
$\\{fast\_store\_new\_token}(\|t)$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{pool\_ptr}\K\|b$;\5
$\\{str\_toks}\K\|p$;\6
\&{end};\par
\fi

\M491. The main reason for wanting \\{str\_toks} is the next function,
\\{the\_toks}, which has similar input/output characteristics.

This procedure is supposed to scan something like `\.{\\skip\\count12}',
i.e., whatever can follow `\.{\\the}', and it constructs a token list
containing something like `\.{-3.0pt minus 0.5fill}'.

\Y\P\4\&{function}\1\  \37\\{the\_toks}: \37\\{pointer};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector}
setting}\6
$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{used for copying a token list}\6
\|b: \37\\{pool\_pointer};\C{base of temporary string}\6
\|c: \37\\{small\_number};\C{value of \\{cur\_chr}}\2\6
\&{begin} \37\X1688:Handle \.{\\unexpanded} or \.{\\detokenize} and \&{return}%
\X;\6
\\{get\_x\_token};\5
$\\{scan\_something\_internal}(\\{tok\_val},\39\\{false})$;\6
\&{if} $\\{cur\_val\_level}\G\\{ident\_val}$ \1\&{then}\5
\X492:Copy the token list\X\6
\4\&{else} \&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\|b\K\\{pool\_ptr}$;\6
\&{case} $\\{cur\_val\_level}$ \1\&{of}\6
\4\\{int\_val}: \37$\\{print\_int}(\\{cur\_val})$;\6
\4\\{dimen\_val}: \37\&{begin} \37$\\{print\_scaled}(\\{cur\_val})$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{glue\_val}: \37\&{begin} \37$\\{print\_spec}(\\{cur\_val},\39\.{"pt"})$;\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\6
\&{end};\6
\4\\{mu\_val}: \37\&{begin} \37$\\{print\_spec}(\\{cur\_val},\39\.{"mu"})$;\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
$\\{selector}\K\\{old\_setting}$;\5
$\\{the\_toks}\K\\{str\_toks}(\|b)$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M492. \P$\X492:Copy the token list\X\S$\6
\&{begin} \37$\|p\K\\{temp\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\6
\&{if} $\\{cur\_val\_level}=\\{ident\_val}$ \1\&{then}\5
$\\{store\_new\_token}(\\{cs\_token\_flag}+\\{cur\_val})$\6
\4\&{else} \&{if} $\\{cur\_val}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{link}(\\{cur\_val})$;\C{do not copy the reference count}\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{fast\_store\_new\_token}(\\{info}(\|r))$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{end};\2\2\6
$\\{the\_toks}\K\|p$;\6
\&{end}\par
\U491.\fi

\M493. Here's part of the \\{expand} subroutine that we are now ready to
complete:

\Y\P\4\&{procedure}\1\  \37\\{ins\_the\_toks};\2\6
\&{begin} \37$\\{link}(\\{garbage})\K\\{the\_toks}$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\6
\&{end};\par
\fi

\M494. The primitives \.{\\number}, \.{\\romannumeral}, \.{\\string}, \.{%
\\meaning},
\.{\\fontname}, and \.{\\jobname} are defined as follows.

\eTeX\ adds \.{\\eTeXrevision} such that \\{job\_name\_code} remains last.

\pdfTeX\ adds \.{\\pdftexrevision}, \.{\\pdftexbanner}, \.{\\pdffontname},
\.{\\pdffontobjnum}, \.{\\pdffontsize}, and \.{\\pdfpageref} such that
\\{job\_name\_code} remains last.

\Y\P\D \37$\\{number\_code}=0$\C{command code for \.{\\number}}\par
\P\D \37$\\{roman\_numeral\_code}=1$\C{command code for \.{\\romannumeral}}\par
\P\D \37$\\{string\_code}=2$\C{command code for \.{\\string}}\par
\P\D \37$\\{meaning\_code}=3$\C{command code for \.{\\meaning}}\par
\P\D \37$\\{font\_name\_code}=4$\C{command code for \.{\\fontname}}\par
\P\D \37$\\{etex\_convert\_base}=5$\C{base for \eTeX's command codes}\par
\P\D \37$\\{eTeX\_revision\_code}=\\{etex\_convert\_base}$\C{command code for %
\.{\\eTeXrevision}}\par
\P\D \37$\\{etex\_convert\_codes}=\\{etex\_convert\_base}+1$\C{end of \eTeX's
command codes}\par
\P\D \37$\\{expanded\_code}=\\{etex\_convert\_codes}$\C{command code for \.{%
\\expanded}}\par
\P\D \37$\\{pdftex\_first\_expand\_code}=\\{expanded\_code}+1$\C{base for %
\pdfTeX's command codes}\par
\P\D \37$\\{pdftex\_revision\_code}=\\{pdftex\_first\_expand\_code}+0$%
\C{command code for \.{\\pdftexrevision}}\par
\P\D \37$\\{pdftex\_banner\_code}=\\{pdftex\_first\_expand\_code}+1$\C{command
code for \.{\\pdftexbanner}}\par
\P\D \37$\\{pdf\_font\_name\_code}=\\{pdftex\_first\_expand\_code}+2$\C{command
code for \.{\\pdffontname}}\par
\P\D \37$\\{pdf\_font\_objnum\_code}=\\{pdftex\_first\_expand\_code}+3$%
\C{command code for \.{\\pdffontobjnum}}\par
\P\D \37$\\{pdf\_font\_size\_code}=\\{pdftex\_first\_expand\_code}+4$\C{command
code for \.{\\pdffontsize}}\par
\P\D \37$\\{pdf\_page\_ref\_code}=\\{pdftex\_first\_expand\_code}+5$\C{command
code for \.{\\pdfpageref}}\par
\P\D \37$\\{pdf\_xform\_name\_code}=\\{pdftex\_first\_expand\_code}+6$%
\C{command code for \.{\\pdfxformname}}\par
\P\D \37$\\{pdf\_escape\_string\_code}=\\{pdftex\_first\_expand\_code}+7$%
\C{command code for \.{\\pdfescapestring}}\par
\P\D \37$\\{pdf\_escape\_name\_code}=\\{pdftex\_first\_expand\_code}+8$%
\C{command code for \.{\\pdfescapename}}\par
\P\D \37$\\{left\_margin\_kern\_code}=\\{pdftex\_first\_expand\_code}+9$%
\C{command code for \.{\\leftmarginkern}}\par
\P\D \37$\\{right\_margin\_kern\_code}=\\{pdftex\_first\_expand\_code}+10$%
\C{command code for \.{\\rightmarginkern}}\par
\P\D \37$\\{pdf\_strcmp\_code}=\\{pdftex\_first\_expand\_code}+11$\C{command
code for \.{\\pdfstrcmp}}\par
\P\D \37$\\{pdf\_colorstack\_init\_code}=\\{pdftex\_first\_expand\_code}+12$%
\C{command code for \.{\\pdfcolorstackinit}}\par
\P\D \37$\\{pdf\_escape\_hex\_code}=\\{pdftex\_first\_expand\_code}+13$%
\C{command code for \.{\\pdfescapehex}}\par
\P\D \37$\\{pdf\_unescape\_hex\_code}=\\{pdftex\_first\_expand\_code}+14$%
\C{command code for \.{\\pdfunescapehex}}\par
\P\D \37$\\{pdf\_creation\_date\_code}=\\{pdftex\_first\_expand\_code}+15$%
\C{command code for \.{\\pdfcreationdate}}\par
\P\D \37$\\{pdf\_file\_mod\_date\_code}=\\{pdftex\_first\_expand\_code}+16$%
\C{command code for \.{\\pdffilemoddate}}\par
\P\D \37$\\{pdf\_file\_size\_code}=\\{pdftex\_first\_expand\_code}+17$%
\C{command code for \.{\\pdffilesize}}\par
\P\D \37$\\{pdf\_mdfive\_sum\_code}=\\{pdftex\_first\_expand\_code}+18$%
\C{command code for \.{\\pdfmdfivesum}}\par
\P\D \37$\\{pdf\_file\_dump\_code}=\\{pdftex\_first\_expand\_code}+19$%
\C{command code for \.{\\pdffiledump}}\par
\P\D \37$\\{pdf\_match\_code}=\\{pdftex\_first\_expand\_code}+20$\C{command
code for \.{\\pdfmatch}}\par
\P\D \37$\\{pdf\_last\_match\_code}=\\{pdftex\_first\_expand\_code}+21$%
\C{command code for \.{\\pdflastmatch}}\par
\P\D \37$\\{uniform\_deviate\_code}=\\{pdftex\_first\_expand\_code}+22$\C{end
of \pdfTeX's command codes}\par
\P\D \37$\\{normal\_deviate\_code}=\\{pdftex\_first\_expand\_code}+23$\C{end of
\pdfTeX's command codes}\par
\P\D \37$\\{pdf\_insert\_ht\_code}=\\{pdftex\_first\_expand\_code}+24$%
\C{command code for \.{\\pdfinsertht}}\par
\P\D \37$\\{pdf\_ximage\_bbox\_code}=\\{pdftex\_first\_expand\_code}+25$%
\C{command code for \.{\\pdfximagebbox}}\par
\P\D \37$\\{pdftex\_convert\_codes}=\\{pdftex\_first\_expand\_code}+26$\C{end
of \pdfTeX's command codes}\par
\P\D \37$\\{job\_name\_code}=\\{pdftex\_convert\_codes}$\C{command code for \.{%
\\jobname}}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"number"},\39\\{convert},\39\\{number\_code})$;\6
$\\{primitive}(\.{"romannumeral"},\39\\{convert},\39\\{roman\_numeral\_code})$;%
\6
$\\{primitive}(\.{"string"},\39\\{convert},\39\\{string\_code})$;\6
$\\{primitive}(\.{"meaning"},\39\\{convert},\39\\{meaning\_code})$;\6
$\\{primitive}(\.{"fontname"},\39\\{convert},\39\\{font\_name\_code})$;\7
$\\{primitive}(\.{"expanded"},\39\\{convert},\39\\{expanded\_code})$;\7
$\\{primitive}(\.{"pdftexrevision"},\39\\{convert},\39\\{pdftex\_revision%
\_code})$;\6
$\\{primitive}(\.{"pdftexbanner"},\39\\{convert},\39\\{pdftex\_banner\_code})$;%
\6
$\\{primitive}(\.{"pdffontname"},\39\\{convert},\39\\{pdf\_font\_name\_code})$;%
\6
$\\{primitive}(\.{"pdffontobjnum"},\39\\{convert},\39\\{pdf\_font\_objnum%
\_code})$;\6
$\\{primitive}(\.{"pdffontsize"},\39\\{convert},\39\\{pdf\_font\_size\_code})$;%
\6
$\\{primitive}(\.{"pdfpageref"},\39\\{convert},\39\\{pdf\_page\_ref\_code})$;\6
$\\{primitive}(\.{"leftmarginkern"},\39\\{convert},\39\\{left\_margin\_kern%
\_code})$;\6
$\\{primitive}(\.{"rightmarginkern"},\39\\{convert},\39\\{right\_margin\_kern%
\_code})$;\6
$\\{primitive}(\.{"pdfxformname"},\39\\{convert},\39\\{pdf\_xform\_name%
\_code})$;\6
$\\{primitive}(\.{"pdfescapestring"},\39\\{convert},\39\\{pdf\_escape\_string%
\_code})$;\6
$\\{primitive}(\.{"pdfescapename"},\39\\{convert},\39\\{pdf\_escape\_name%
\_code})$;\6
$\\{primitive}(\.{"pdfescapehex"},\39\\{convert},\39\\{pdf\_escape\_hex%
\_code})$;\6
$\\{primitive}(\.{"pdfunescapehex"},\39\\{convert},\39\\{pdf\_unescape\_hex%
\_code})$;\6
$\\{primitive}(\.{"pdfcreationdate"},\39\\{convert},\39\\{pdf\_creation\_date%
\_code})$;\6
$\\{primitive}(\.{"pdffilemoddate"},\39\\{convert},\39\\{pdf\_file\_mod\_date%
\_code})$;\6
$\\{primitive}(\.{"pdffilesize"},\39\\{convert},\39\\{pdf\_file\_size\_code})$;%
\6
$\\{primitive}(\.{"pdfmdfivesum"},\39\\{convert},\39\\{pdf\_mdfive\_sum%
\_code})$;\6
$\\{primitive}(\.{"pdffiledump"},\39\\{convert},\39\\{pdf\_file\_dump\_code})$;%
\6
$\\{primitive}(\.{"pdfmatch"},\39\\{convert},\39\\{pdf\_match\_code})$;\6
$\\{primitive}(\.{"pdflastmatch"},\39\\{convert},\39\\{pdf\_last\_match%
\_code})$;\6
$\\{primitive}(\.{"pdfstrcmp"},\39\\{convert},\39\\{pdf\_strcmp\_code})$;\6
$\\{primitive}(\.{"pdfcolorstackinit"},\39\\{convert},\39\\{pdf\_colorstack%
\_init\_code})$;\6
$\\{primitive}(\.{"pdfuniformdeviate"},\39\\{convert},\39\\{uniform\_deviate%
\_code})$;\6
$\\{primitive}(\.{"pdfnormaldeviate"},\39\\{convert},\39\\{normal\_deviate%
\_code})$;\7
$\\{primitive}(\.{"jobname"},\39\\{convert},\39\\{job\_name\_code})$;\6
$\\{primitive}(\.{"pdfinsertht"},\39\\{convert},\39\\{pdf\_insert\_ht\_code})$;%
\6
$\\{primitive}(\.{"pdfximagebbox"},\39\\{convert},\39\\{pdf\_ximage\_bbox%
\_code})$;\par
\fi

\M495. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{convert}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{number\_code}: \37$\\{print\_esc}(\.{"number"})$;\6
\4\\{roman\_numeral\_code}: \37$\\{print\_esc}(\.{"romannumeral"})$;\6
\4\\{string\_code}: \37$\\{print\_esc}(\.{"string"})$;\6
\4\\{meaning\_code}: \37$\\{print\_esc}(\.{"meaning"})$;\6
\4\\{font\_name\_code}: \37$\\{print\_esc}(\.{"fontname"})$;\6
\4\\{eTeX\_revision\_code}: \37$\\{print\_esc}(\.{"eTeXrevision"})$;\6
\4\\{expanded\_code}: \37$\\{print\_esc}(\.{"expanded"})$;\6
\4\\{pdftex\_revision\_code}: \37$\\{print\_esc}(\.{"pdftexrevision"})$;\6
\4\\{pdftex\_banner\_code}: \37$\\{print\_esc}(\.{"pdftexbanner"})$;\6
\4\\{pdf\_font\_name\_code}: \37$\\{print\_esc}(\.{"pdffontname"})$;\6
\4\\{pdf\_font\_objnum\_code}: \37$\\{print\_esc}(\.{"pdffontobjnum"})$;\6
\4\\{pdf\_font\_size\_code}: \37$\\{print\_esc}(\.{"pdffontsize"})$;\6
\4\\{pdf\_page\_ref\_code}: \37$\\{print\_esc}(\.{"pdfpageref"})$;\6
\4\\{left\_margin\_kern\_code}: \37$\\{print\_esc}(\.{"leftmarginkern"})$;\6
\4\\{right\_margin\_kern\_code}: \37$\\{print\_esc}(\.{"rightmarginkern"})$;\6
\4\\{pdf\_xform\_name\_code}: \37$\\{print\_esc}(\.{"pdfxformname"})$;\6
\4\\{pdf\_escape\_string\_code}: \37$\\{print\_esc}(\.{"pdfescapestring"})$;\6
\4\\{pdf\_escape\_name\_code}: \37$\\{print\_esc}(\.{"pdfescapename"})$;\6
\4\\{pdf\_escape\_hex\_code}: \37$\\{print\_esc}(\.{"pdfescapehex"})$;\6
\4\\{pdf\_unescape\_hex\_code}: \37$\\{print\_esc}(\.{"pdfunescapehex"})$;\6
\4\\{pdf\_creation\_date\_code}: \37$\\{print\_esc}(\.{"pdfcreationdate"})$;\6
\4\\{pdf\_file\_mod\_date\_code}: \37$\\{print\_esc}(\.{"pdffilemoddate"})$;\6
\4\\{pdf\_file\_size\_code}: \37$\\{print\_esc}(\.{"pdffilesize"})$;\6
\4\\{pdf\_mdfive\_sum\_code}: \37$\\{print\_esc}(\.{"pdfmdfivesum"})$;\6
\4\\{pdf\_file\_dump\_code}: \37$\\{print\_esc}(\.{"pdffiledump"})$;\6
\4\\{pdf\_match\_code}: \37$\\{print\_esc}(\.{"pdfmatch"})$;\6
\4\\{pdf\_last\_match\_code}: \37$\\{print\_esc}(\.{"pdflastmatch"})$;\6
\4\\{pdf\_strcmp\_code}: \37$\\{print\_esc}(\.{"pdfstrcmp"})$;\6
\4\\{pdf\_colorstack\_init\_code}: \37$\\{print\_esc}(%
\.{"pdfcolorstackinit"})$;\6
\4\\{uniform\_deviate\_code}: \37$\\{print\_esc}(\.{"pdfuniformdeviate"})$;\6
\4\\{normal\_deviate\_code}: \37$\\{print\_esc}(\.{"pdfnormaldeviate"})$;\6
\4\\{pdf\_insert\_ht\_code}: \37$\\{print\_esc}(\.{"pdfinsertht"})$;\6
\4\\{pdf\_ximage\_bbox\_code}: \37$\\{print\_esc}(\.{"pdfximagebbox"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"jobname"})$\2\6
\&{endcases};\par
\fi

\M496. The procedure \\{conv\_toks} uses \\{str\_toks} to insert the token list
for \\{convert} functions into the scanner; `\.{\\outer}' control sequences
are allowed to follow `\.{\\string}' and `\.{\\meaning}'.

The extra temp string \|u is needed because \\{pdf\_scan\_ext\_toks}
incorporates
any pending string in its output. In order to save such a pending string,
we have to create a temporary string that is destroyed immediately after.

\Y\P\D \37$\\{save\_cur\_string}\S$\1\6
\&{if} $\\{str\_start}[\\{str\_ptr}]<\\{pool\_ptr}$ \1\&{then}\5
$\|u\K\\{make\_string}$\2\2\par
\P\D \37$\\{restore\_cur\_string}\S$\1\6
\&{if} $\|u\I0$ \1\&{then}\6
\&{begin} \37$\\{decr}(\\{str\_ptr})$;\5
$\|u\K0$;\6
\&{end}\2\2\par
\Y\P\4\&{procedure}\1\  \37\\{conv\_toks};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector}
setting}\6
$\|p,\39\|q$: \37\\{pointer};\5
\|c: \37$\\{number\_code}\to\\{job\_name\_code}$;\C{desired type of conversion}%
\6
\\{save\_scanner\_status}: \37\\{small\_number};\C{\\{scanner\_status} upon
entry}\6
\\{save\_def\_ref}: \37\\{pointer};\C{\\{def\_ref} upon entry, important if
inside `\.{\\message}'}\6
\\{save\_warning\_index}: \37\\{pointer};\5
\\{bool}: \37\\{boolean};\C{temp boolean}\6
\|i: \37\\{integer};\C{first temp integer}\6
\|j: \37\\{integer};\C{second temp integer}\6
\|b: \37\\{pool\_pointer};\C{base of temporary string}\6
\|s: \37\\{str\_number};\C{first temp string}\6
\|t: \37\\{str\_number};\C{second temp string}\6
\|u: \37\\{str\_number};\C{saved current string string}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
$\|u\K0$;\C{ will become non-nil if a string is already being built}\6
\X497:Scan the argument for command \|c\X;\6
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\|b\K\\{pool\_ptr}$;\5
\X498:Print the result of command \|c\X;\6
$\\{selector}\K\\{old\_setting}$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M497. \P$\X497:Scan the argument for command \|c\X\S$\6
\&{case} $\|c$ \1\&{of}\6
\4$\\{number\_code},\39\\{roman\_numeral\_code}$: \37\\{scan\_int};\6
\4$\\{string\_code},\39\\{meaning\_code}$: \37\&{begin} \37$\\{save\_scanner%
\_status}\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_token};\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{end};\6
\4\\{font\_name\_code}: \37\\{scan\_font\_ident};\6
\4\\{eTeX\_revision\_code}: \37\\{do\_nothing};\6
\4\\{expanded\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner%
\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\\{ins\_list}(\\{link}(\\{def\_ref}))$;\5
$\\{free\_avail}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdftex\_revision\_code}: \37\\{do\_nothing};\6
\4\\{pdftex\_banner\_code}: \37\\{do\_nothing};\6
\4$\\{pdf\_font\_name\_code},\39\\{pdf\_font\_objnum\_code},\39\\{pdf\_font%
\_size\_code}$: \37\&{begin} \37\\{scan\_font\_ident};\6
\&{if} $\\{cur\_val}=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"invalid\ font\ identifier"})$;\2\6
\&{if} $\|c\I\\{pdf\_font\_size\_code}$ \1\&{then}\6
\&{begin} \37\\{pdf\_check\_vf\_cur\_val};\6
\&{if} $\R\\{font\_used}[\\{cur\_val}]$ \1\&{then}\5
\\{pdf\_init\_font\_cur\_val};\2\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_page\_ref\_code}: \37\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"pageref"},\39\.{"invalid\ page\ number"})$;\2\6
\&{end};\6
\4$\\{left\_margin\_kern\_code},\39\\{right\_margin\_kern\_code}$: \37\&{begin}
\37\\{scan\_register\_num};\5
$\\{fetch\_box}(\|p)$;\6
\&{if} $(\|p=\\{null})\V(\\{type}(\|p)\I\\{hlist\_node})$ \1\&{then}\5
$\\{pdf\_error}(\.{"marginkern"},\39\.{"a\ non-empty\ hbox\ expected"})$\2\6
\&{end};\6
\4\\{pdf\_xform\_name\_code}: \37\&{begin} \37\\{scan\_int};\5
$\\{pdf\_check\_obj}(\\{obj\_type\_xform},\39\\{cur\_val})$;\6
\&{end};\6
\4\\{pdf\_escape\_string\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{escapestring}(\\{str\_start}[\|s])$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_escape\_name\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{escapename}(\\{str\_start}[\|s])$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_escape\_hex\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{escapehex}(\\{str\_start}[\|s])$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_unescape\_hex\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{unescapehex}(\\{str\_start}[\|s])$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_creation\_date\_code}: \37\&{begin} \37$\|b\K\\{pool\_ptr}$;\5
\\{getcreationdate};\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\&{return};\6
\&{end};\6
\4\\{pdf\_file\_mod\_date\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{getfilemoddate}(\|s)$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_file\_size\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{getfilesize}(\|s)$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_mdfive\_sum\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
$\\{bool}\K\\{scan\_keyword}(\.{"file"})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{getmd5sum}(\|s,\39\\{bool})$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_file\_dump\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\C{scan offset}\6
$\\{cur\_val}\K0$;\6
\&{if} $(\\{scan\_keyword}(\.{"offset"}))$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ file\ offset"})$;\5
$\\{help2}(\.{"A\ file\ offset\ must\ be\ between\ 0\ and\ 2\^\{31\}-1,"})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\2\6
$\|i\K\\{cur\_val}$;\C{scan length}\6
$\\{cur\_val}\K0$;\6
\&{if} $(\\{scan\_keyword}(\.{"length"}))$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ dump\ length"})$;\5
$\\{help2}(\.{"A\ dump\ length\ must\ be\ between\ 0\ and\ 2\^\{31\}-1,"})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\2\6
$\|j\K\\{cur\_val}$;\C{scan file name}\6
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{getfiledump}(\|s,\39\|i,\39\|j)$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_match\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner%
\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\C{scan for icase}\6
$\\{bool}\K\\{scan\_keyword}(\.{"icase"})$;\C{scan for subcount}\6
$\|i\K-1$;\C{default for subcount}\6
\&{if} $\\{scan\_keyword}(\.{"subcount"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\|i\K\\{cur\_val}$;\6
\&{end};\2\6
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\|t\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\\{matchstrings}(\|s,\39\|t,\39\|i,\39\\{bool})$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{flush\_str}(\|t)$;\5
$\\{flush\_str}(\|s)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\\{restore\_cur\_string};\5
\&{return};\6
\&{end};\6
\4\\{pdf\_last\_match\_code}: \37\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ match\ number"})$;\5
$\\{help2}(\.{"Since\ I\ expected\ zero\ or\ a\ positive\ number,"})$\6
$(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
$\|b\K\\{pool\_ptr}$;\5
$\\{getmatch}(\\{cur\_val})$;\5
$\\{link}(\\{garbage})\K\\{str\_toks}(\|b)$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
\&{return};\6
\&{end};\6
\4\\{pdf\_strcmp\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner%
\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{compare\_strings};\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
\\{restore\_cur\_string};\6
\&{end};\6
\4\\{pdf\_colorstack\_init\_code}: \37\&{begin} \37$\\{bool}\K\\{scan%
\_keyword}(\.{"page"})$;\6
\&{if} $\\{scan\_keyword}(\.{"direct"})$ \1\&{then}\5
$\\{cur\_val}\K\\{direct\_always}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"page"})$ \1\&{then}\5
$\\{cur\_val}\K\\{direct\_page}$\6
\4\&{else} $\\{cur\_val}\K\\{set\_origin}$;\2\2\6
$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{save\_warning\_index}\K\\{warning\_index}$;\5
$\\{save\_def\_ref}\K\\{def\_ref}$;\5
\\{save\_cur\_string};\5
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_ref}\K\\{save\_def\_ref}$;\5
$\\{warning\_index}\K\\{save\_warning\_index}$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\5
$\\{cur\_val}\K\\{newcolorstack}(\|s,\39\\{cur\_val},\39\\{bool})$;\5
$\\{flush\_str}(\|s)$;\5
$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Too\ many\ color\ stacks"})$;\5
$\\{help2}(\.{"The\ number\ of\ color\ stacks\ is\ limited\ to\ 32768."})$\6
$(\.{"I\'ll\ use\ the\ default\ color\ stack\ 0\ here."})$;\5
\\{error};\5
$\\{cur\_val}\K0$;\5
\\{restore\_cur\_string};\6
\&{end};\2\6
\&{end};\6
\4\\{job\_name\_code}: \37\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\2\6
\4\\{uniform\_deviate\_code}: \37\\{scan\_int};\6
\4\\{normal\_deviate\_code}: \37\\{do\_nothing};\6
\4\\{pdf\_insert\_ht\_code}: \37\\{scan\_register\_num};\6
\4\\{pdf\_ximage\_bbox\_code}: \37\&{begin} \37\\{scan\_int};\5
$\\{pdf\_check\_obj}(\\{obj\_type\_ximage},\39\\{cur\_val})$;\5
$\|i\K\\{obj\_ximage\_data}(\\{cur\_val})$;\5
\\{scan\_int};\5
$\|j\K\\{cur\_val}$;\6
\&{if} $(\|j<1)\V(\|j>4)$ \1\&{then}\5
$\\{pdf\_error}(\.{"pdfximagebbox"},\39\.{"invalid\ parameter"})$;\2\6
\&{end};\2\6
\&{end}\C{there are no other cases}\par
\U496.\fi

\M498. \P$\X498:Print the result of command \|c\X\S$\6
\&{case} $\|c$ \1\&{of}\6
\4\\{number\_code}: \37$\\{print\_int}(\\{cur\_val})$;\6
\4\\{roman\_numeral\_code}: \37$\\{print\_roman\_int}(\\{cur\_val})$;\6
\4\\{string\_code}: \37\&{if} $\\{cur\_cs}\I0$ \1\&{then}\5
$\\{sprint\_cs}(\\{cur\_cs})$\6
\4\&{else} $\\{print\_char}(\\{cur\_chr})$;\2\6
\4\\{meaning\_code}: \37\\{print\_meaning};\6
\4\\{font\_name\_code}: \37\&{begin} \37$\\{print}(\\{font\_name}[\\{cur%
\_val}])$;\6
\&{if} $\\{font\_size}[\\{cur\_val}]\I\\{font\_dsize}[\\{cur\_val}]$ \1\&{then}%
\6
\&{begin} \37$\\{print}(\.{"\ at\ "})$;\5
$\\{print\_scaled}(\\{font\_size}[\\{cur\_val}])$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\2\6
\&{end};\6
\4\\{eTeX\_revision\_code}: \37$\\{print}(\\{eTeX\_revision})$;\6
\4\\{pdftex\_revision\_code}: \37$\\{print}(\\{pdftex\_revision})$;\6
\4\\{pdftex\_banner\_code}: \37$\\{print}(\\{pdftex\_banner})$;\6
\4$\\{pdf\_font\_name\_code},\39\\{pdf\_font\_objnum\_code}$: \37\&{begin} \37$%
\\{set\_ff}(\\{cur\_val})$;\6
\&{if} $\|c=\\{pdf\_font\_name\_code}$ \1\&{then}\5
$\\{print\_int}(\\{obj\_info}(\\{pdf\_font\_num}[\\{ff}]))$\6
\4\&{else} $\\{print\_int}(\\{pdf\_font\_num}[\\{ff}])$;\2\6
\&{end};\6
\4\\{pdf\_font\_size\_code}: \37\&{begin} \37$\\{print\_scaled}(\\{font\_size}[%
\\{cur\_val}])$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{pdf\_page\_ref\_code}: \37$\\{print\_int}(\\{get\_obj}(\\{obj\_type%
\_page},\39\\{cur\_val},\39\\{false}))$;\6
\4\\{left\_margin\_kern\_code}: \37\&{begin} \37$\|p\K\\{list\_ptr}(\|p)$;\6
\&{while} $(\|p\I\\{null})\W(\\{cp\_skipable}(\|p)\V((\R\\{is\_char\_node}(%
\|p))\W(\\{type}(\|p)=\\{glue\_node})\W(\\{subtype}(\|p)=\\{left\_skip%
\_code}+1)))$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
\&{if} $(\|p\I\\{null})\W(\R\\{is\_char\_node}(\|p))\W(\\{type}(\|p)=\\{margin%
\_kern\_node})\W(\\{subtype}(\|p)=\\{left\_side})$ \1\&{then}\5
$\\{print\_scaled}(\\{width}(\|p))$\6
\4\&{else} $\\{print}(\.{"0"})$;\2\6
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{right\_margin\_kern\_code}: \37\&{begin} \37$\|q\K\\{list\_ptr}(\|p)$;\5
$\|p\K\\{prev\_rightmost}(\|q,\39\\{null})$;\6
\&{while} $(\|p\I\\{null})\W(\\{cp\_skipable}(\|p)\V((\R\\{is\_char\_node}(%
\|p))\W(\\{type}(\|p)=\\{glue\_node})\W(\\{subtype}(\|p)=\\{right\_skip%
\_code}+1)))$ \1\&{do}\5
$\|p\K\\{prev\_rightmost}(\|q,\39\|p)$;\2\6
\&{if} $(\|p\I\\{null})\W(\R\\{is\_char\_node}(\|p))\W(\\{type}(\|p)=\\{margin%
\_kern\_node})\W(\\{subtype}(\|p)=\\{right\_side})$ \1\&{then}\5
$\\{print\_scaled}(\\{width}(\|p))$\6
\4\&{else} $\\{print}(\.{"0"})$;\2\6
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{pdf\_xform\_name\_code}: \37$\\{print\_int}(\\{obj\_info}(\\{cur\_val}))$;%
\6
\4\\{pdf\_strcmp\_code}: \37$\\{print\_int}(\\{cur\_val})$;\6
\4\\{pdf\_colorstack\_init\_code}: \37$\\{print\_int}(\\{cur\_val})$;\6
\4\\{uniform\_deviate\_code}: \37$\\{print\_int}(\\{unif\_rand}(\\{cur%
\_val}))$;\6
\4\\{normal\_deviate\_code}: \37$\\{print\_int}(\\{norm\_rand})$;\6
\4\\{pdf\_insert\_ht\_code}: \37\&{begin} \37$\|i\K\\{qi}(\\{cur\_val})$;\5
$\|p\K\\{page\_ins\_head}$;\6
\&{while} $\|i\G\\{subtype}(\\{link}(\|p))$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
\&{if} $\\{subtype}(\|p)=\|i$ \1\&{then}\5
$\\{print\_scaled}(\\{height}(\|p))$\6
\4\&{else} $\\{print}(\.{"0"})$;\2\6
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{pdf\_ximage\_bbox\_code}: \37\&{begin} \37\&{if} $\\{is\_pdf\_image}(\|i)$
\1\&{then}\6
\&{begin} \37\&{case} $\|j$ \1\&{of}\6
\41: \37$\\{print\_scaled}(\\{epdf\_orig\_x}(\|i))$;\6
\42: \37$\\{print\_scaled}(\\{epdf\_orig\_y}(\|i))$;\6
\43: \37$\\{print\_scaled}(\\{epdf\_orig\_x}(\|i)+\\{image\_width}(\|i))$;\6
\44: \37$\\{print\_scaled}(\\{epdf\_orig\_y}(\|i)+\\{image\_height}(\|i))$;\2\6
\&{endcases};\6
\&{end}\6
\4\&{else} $\\{print\_scaled}(0)$;\2\6
$\\{print}(\.{"pt"})$;\6
\&{end};\6
\4\\{job\_name\_code}: \37$\\{print}(\\{job\_name})$;\2\6
\&{end}\C{there are no other cases}\par
\U496.\fi

\M499. Now we can't postpone the difficulties any longer; we must bravely
tackle
\\{scan\_toks}. This function returns a pointer to the tail of a new token
list, and it also makes \\{def\_ref} point to the reference count at the
head of that list.

There are two boolean parameters, \\{macro\_def} and \\{xpand}. If \\{macro%
\_def}
is true, the goal is to create the token list for a macro definition;
otherwise the goal is to create the token list for some other \TeX\
primitive: \.{\\mark}, \.{\\output}, \.{\\everypar}, \.{\\lowercase},
\.{\\uppercase}, \.{\\message}, \.{\\errmessage}, \.{\\write}, or
\.{\\special}. In the latter cases a left brace must be scanned next; this
left brace will not be part of the token list, nor will the matching right
brace that comes at the end. If \\{xpand} is false, the token list will
simply be copied from the input using \\{get\_token}. Otherwise all expandable
tokens will be expanded until unexpandable tokens are left, except that
the results of expanding `\.{\\the}' are not expanded further.
If both \\{macro\_def} and \\{xpand} are true, the expansion applies
only to the macro body (i.e., to the material following the first
\\{left\_brace} character).

The value of \\{cur\_cs} when \\{scan\_toks} begins should be the \\{eqtb}
address of the control sequence to display in ``runaway'' error
messages.

\Y\P\4\&{function}\1\  \37$\\{scan\_toks}(\\{macro\_def},\39\\{xpand}:%
\\{boolean})$: \37\\{pointer};\6
\4\&{label} \37$\\{found},\39\\{continue},\39\\{done},\39\\{done1},\39%
\\{done2}$;\6
\4\&{var} \37\|t: \37\\{halfword};\C{token representing the highest parameter
number}\6
\|s: \37\\{halfword};\C{saved token}\6
\|p: \37\\{pointer};\C{tail of the token list being built}\6
\|q: \37\\{pointer};\C{new node being added to the token list via \\{store\_new%
\_token}}\6
\\{unbalance}: \37\\{halfword};\C{number of unmatched left braces}\6
\\{hash\_brace}: \37\\{halfword};\C{possible `\.{\#\{}' token}\2\6
\&{begin} \37\&{if} $\\{macro\_def}$ \1\&{then}\5
$\\{scanner\_status}\K\\{defining}$\ \&{else} $\\{scanner\_status}\K%
\\{absorbing}$;\2\6
$\\{warning\_index}\K\\{cur\_cs}$;\5
$\\{def\_ref}\K\\{get\_avail}$;\5
$\\{token\_ref\_count}(\\{def\_ref})\K\\{null}$;\5
$\|p\K\\{def\_ref}$;\5
$\\{hash\_brace}\K0$;\5
$\|t\K\\{zero\_token}$;\6
\&{if} $\\{macro\_def}$ \1\&{then}\5
\X500:Scan and build the parameter part of the macro definition\X\6
\4\&{else} \\{scan\_left\_brace};\C{remove the compulsory left brace}\2\6
\X503:Scan and build the body of the token list; \&{goto} \\{found} when
finished\X;\6
\4\\{found}: \37$\\{scanner\_status}\K\\{normal}$;\6
\&{if} $\\{hash\_brace}\I0$ \1\&{then}\5
$\\{store\_new\_token}(\\{hash\_brace})$;\2\6
$\\{scan\_toks}\K\|p$;\6
\&{end};\par
\fi

\M500. \P$\X500:Scan and build the parameter part of the macro definition\X\S$\6
\&{begin} \37\~ \1\&{loop}\6
\&{begin} \37\\{continue}: \37\\{get\_token};\C{set \\{cur\_cmd}, \\{cur\_chr},
\\{cur\_tok}}\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $\\{cur\_cmd}=\\{mac\_param}$ \1\&{then}\5
\X502:If the next character is a parameter number, make \\{cur\_tok} a %
\\{match} token; but if it is a left brace, store `\\{left\_brace}, \\{end%
\_match}', set \\{hash\_brace}, and \&{goto} \\{done}\X;\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end};\2\6
\4\\{done1}: \37$\\{store\_new\_token}(\\{end\_match\_token})$;\6
\&{if} $\\{cur\_cmd}=\\{right\_brace}$ \1\&{then}\5
\X501:Express shock at the missing left brace; \&{goto} \\{found}\X;\2\6
\4\\{done}: \37\&{end}\par
\U499.\fi

\M501. \P$\X501:Express shock at the missing left brace; \&{goto} \\{found}\X%
\S$\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \{\ inserted"})$;\5
$\\{incr}(\\{align\_state})$;\5
$\\{help2}(\.{"Where\ was\ the\ left\ brace?\ You\ said\ something\ like\ \`%
\\def\\a\}\',"})$\6
$(\.{"which\ I\'m\ going\ to\ interpret\ as\ \`\\def\\a\{\}\'."})$;\5
\\{error};\5
\&{goto} \37\\{found};\6
\&{end}\par
\U500.\fi

\M502. \P$\X502:If the next character is a parameter number, make \\{cur\_tok}
a \\{match} token; but if it is a left brace, store `\\{left\_brace}, \\{end%
\_match}', set \\{hash\_brace}, and \&{goto} \\{done}\X\S$\6
\&{begin} \37$\|s\K\\{match\_token}+\\{cur\_chr}$;\5
\\{get\_token};\6
\&{if} $\\{cur\_tok}<\\{left\_brace\_limit}$ \1\&{then}\6
\&{begin} \37$\\{hash\_brace}\K\\{cur\_tok}$;\5
$\\{store\_new\_token}(\\{cur\_tok})$;\5
$\\{store\_new\_token}(\\{end\_match\_token})$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
\&{if} $\|t=\\{zero\_token}+9$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"You\ already\ have\ nine\ parameters"})$;\5
$\\{help2}(\.{"I\'m\ going\ to\ ignore\ the\ \#\ sign\ you\ just\ used,"})$\6
$(\.{"as\ well\ as\ the\ token\ that\ followed\ it."})$;\5
\\{error};\5
\&{goto} \37\\{continue};\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{incr}(\|t)$;\6
\&{if} $\\{cur\_tok}\I\|t$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Parameters\ must\ be\ numbered\
consecutively"})$;\5
$\\{help2}(\.{"I\'ve\ inserted\ the\ digit\ you\ should\ have\ used\ after\ the%
\ \#."})$\6
$(\.{"Type\ \`1\'\ to\ delete\ what\ you\ did\ use."})$;\5
\\{back\_error};\6
\&{end};\2\6
$\\{cur\_tok}\K\|s$;\6
\&{end};\2\6
\&{end}\par
\U500.\fi

\M503. \P$\X503:Scan and build the body of the token list; \&{goto} \\{found}
when finished\X\S$\6
$\\{unbalance}\K1$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{xpand}$ \1\&{then}\5
\X504:Expand the next part of the input\X\6
\4\&{else} \\{get\_token};\2\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}<\\{right\_brace}$ \1\&{then}\5
$\\{incr}(\\{unbalance})$\6
\4\&{else} \&{begin} \37$\\{decr}(\\{unbalance})$;\6
\&{if} $\\{unbalance}=0$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{end}\2\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{mac\_param}$ \1\&{then}\6
\&{if} $\\{macro\_def}$ \1\&{then}\5
\X505:Look for parameter number or \.{\#\#}\X;\2\2\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end}\2\par
\U499.\fi

\M504. Here we insert an entire token list created by \\{the\_toks} without
expanding it further.

\Y\P$\4\X504:Expand the next part of the input\X\S$\6
\&{begin} \37\~ \1\&{loop}\6
\&{begin} \37\\{get\_next};\6
\&{if} $\\{cur\_cmd}\G\\{call}$ \1\&{then}\6
\&{if} $\\{info}(\\{link}(\\{cur\_chr}))=\\{protected\_token}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{relax}$;\5
$\\{cur\_chr}\K\\{no\_expand\_flag}$;\6
\&{end};\2\2\6
\&{if} $\\{cur\_cmd}\L\\{max\_command}$ \1\&{then}\5
\&{goto} \37\\{done2};\2\6
\&{if} $\\{cur\_cmd}\I\\{the}$ \1\&{then}\5
\\{expand}\6
\4\&{else} \&{begin} \37$\|q\K\\{the\_toks}$;\6
\&{if} $\\{link}(\\{temp\_head})\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|p)\K\\{link}(\\{temp\_head})$;\5
$\|p\K\|q$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\4\\{done2}: \37\\{x\_token}\6
\&{end}\par
\U503.\fi

\M505. \P$\X505:Look for parameter number or \.{\#\#}\X\S$\6
\&{begin} \37$\|s\K\\{cur\_tok}$;\6
\&{if} $\\{xpand}$ \1\&{then}\5
\\{get\_x\_token}\6
\4\&{else} \\{get\_token};\2\6
\&{if} $\\{cur\_cmd}\I\\{mac\_param}$ \1\&{then}\6
\&{if} $(\\{cur\_tok}\L\\{zero\_token})\V(\\{cur\_tok}>\|t)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ parameter\ number\ in\ definition\ of%
\ "})$;\5
$\\{sprint\_cs}(\\{warning\_index})$;\5
$\\{help3}(\.{"You\ meant\ to\ type\ \#\#\ instead\ of\ \#,\ right?"})$\6
$(\.{"Or\ maybe\ a\ \}\ was\ forgotten\ somewhere\ earlier,\ and\ things"})$\6
$(\.{"are\ all\ screwed\ up?\ I\'m\ going\ to\ assume\ that\ you\ meant\ \#%
\#."})$;\5
\\{back\_error};\5
$\\{cur\_tok}\K\|s$;\6
\&{end}\6
\4\&{else} $\\{cur\_tok}\K\\{out\_param\_token}-\.{"0"}+\\{cur\_chr}$;\2\2\6
\&{end}\par
\U503.\fi

\M506. Another way to create a token list is via the \.{\\read} command. The
sixteen files potentially usable for reading appear in the following
global variables. The value of $\\{read\_open}[\|n]$ will be \\{closed} if
stream number \|n has not been opened or if it has been fully read;
\\{just\_open} if an \.{\\openin} but not a \.{\\read} has been done;
and \\{normal} if it is open and ready to read the next line.

\Y\P\D \37$\\{closed}=2$\C{not open, or at end of file}\par
\P\D \37$\\{just\_open}=1$\C{newly opened, first line not yet read}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{read\_file}: \37\&{array} $[0\to15]$ \1\&{of}\5
\\{alpha\_file};\C{used for \.{\\read}}\2\6
\4\\{read\_open}: \37\&{array} $[0\to16]$ \1\&{of}\5
$\\{normal}\to\\{closed}$;\C{state of $\\{read\_file}[\|n]$}\2\par
\fi

\M507. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|k\K0\mathrel{\&{to}}16$ \1\&{do}\5
$\\{read\_open}[\|k]\K\\{closed}$;\2\par
\fi

\M508. The \\{read\_toks} procedure constructs a token list like that for any
macro definition, and makes \\{cur\_val} point to it. Parameter \|r points
to the control sequence that will receive this token list.

\Y\P\4\&{procedure}\1\  \37$\\{read\_toks}(\|n:\\{integer};\,\35\|r:%
\\{pointer};\,\35\|j:\\{halfword})$;\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\|p: \37\\{pointer};\C{tail of the token list}\6
\|q: \37\\{pointer};\C{new node being added to the token list via \\{store\_new%
\_token}}\6
\|s: \37\\{integer};\C{saved value of \\{align\_state}}\6
\|m: \37\\{small\_number};\C{stream number}\2\6
\&{begin} \37$\\{scanner\_status}\K\\{defining}$;\5
$\\{warning\_index}\K\|r$;\5
$\\{def\_ref}\K\\{get\_avail}$;\5
$\\{token\_ref\_count}(\\{def\_ref})\K\\{null}$;\5
$\|p\K\\{def\_ref}$;\C{the reference count}\6
$\\{store\_new\_token}(\\{end\_match\_token})$;\6
\&{if} $(\|n<0)\V(\|n>15)$ \1\&{then}\5
$\|m\K16$\ \&{else} $\|m\K\|n$;\2\6
$\|s\K\\{align\_state}$;\5
$\\{align\_state}\K1000000$;\C{disable tab marks, etc.}\6
\1\&{repeat} \37\X509:Input and store tokens from the next line of the file\X;\6
\4\&{until}\5
$\\{align\_state}=1000000$;\2\6
$\\{cur\_val}\K\\{def\_ref}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
$\\{align\_state}\K\|s$;\6
\&{end};\par
\fi

\M509. \P$\X509:Input and store tokens from the next line of the file\X\S$\6
\\{begin\_file\_reading};\5
$\\{name}\K\|m+1$;\6
\&{if} $\\{read\_open}[\|m]=\\{closed}$ \1\&{then}\5
\X510:Input for \.{\\read} from the terminal\X\6
\4\&{else} \&{if} $\\{read\_open}[\|m]=\\{just\_open}$ \1\&{then}\5
\X511:Input the first line of $\\{read\_file}[\|m]$\X\6
\4\&{else} \X512:Input the next line of $\\{read\_file}[\|m]$\X;\2\2\6
$\\{limit}\K\\{last}$;\6
\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{decr}(\\{limit})$\6
\4\&{else} $\\{buffer}[\\{limit}]\K\\{end\_line\_char}$;\2\6
$\\{first}\K\\{limit}+1$;\5
$\\{loc}\K\\{start}$;\5
$\\{state}\K\\{new\_line}$;\6
\X1761:Handle \.{\\readline} and \&{goto} \\{done}\X;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_token};\6
\&{if} $\\{cur\_tok}=0$ \1\&{then}\5
\&{goto} \37\\{done};\C{$\\{cur\_cmd}=\\{cur\_chr}=0$ will occur at the end of
the line}\2\6
\&{if} $\\{align\_state}<1000000$ \1\&{then}\C{unmatched `\.\}' aborts the
line}\6
\&{begin} \37\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{cur\_tok}=0$;\2\6
$\\{align\_state}\K1000000$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end};\2\6
\4\\{done}: \37\\{end\_file\_reading}\par
\U508.\fi

\M510. Here we input on-line into the \\{buffer} array, prompting the user
explicitly
if $\|n\G0$.  The value of \|n is set negative so that additional prompts
will not be given in the case of multi-line input.

\Y\P$\4\X510:Input for \.{\\read} from the terminal\X\S$\6
\&{if} $\\{interaction}>\\{nonstop\_mode}$ \1\&{then}\6
\&{if} $\|n<0$ \1\&{then}\5
$\\{prompt\_input}(\.{""})$\6
\4\&{else} \&{begin} \37\\{wake\_up\_terminal};\5
\\{print\_ln};\5
$\\{sprint\_cs}(\|r)$;\5
$\\{prompt\_input}(\.{"="})$;\5
$\|n\K-1$;\6
\&{end}\2\6
\4\&{else} $\\{fatal\_error}(\.{"***\ (cannot\ \\read\ from\ terminal\ in\
nonstop\ modes)"})$\2\par
\U509.\fi

\M511. The first line of a file must be treated specially, since \\{input\_ln}
must be told not to start with \\{get}.

\Y\P$\4\X511:Input the first line of $\\{read\_file}[\|m]$\X\S$\6
\&{if} $\\{input\_ln}(\\{read\_file}[\|m],\39\\{false})$ \1\&{then}\5
$\\{read\_open}[\|m]\K\\{normal}$\6
\4\&{else} \&{begin} \37$\\{a\_close}(\\{read\_file}[\|m])$;\5
$\\{read\_open}[\|m]\K\\{closed}$;\6
\&{end}\2\par
\U509.\fi

\M512. An empty line is appended at the end of a \\{read\_file}.

\Y\P$\4\X512:Input the next line of $\\{read\_file}[\|m]$\X\S$\6
\&{begin} \37\&{if} $\R\\{input\_ln}(\\{read\_file}[\|m],\39\\{true})$ \1%
\&{then}\6
\&{begin} \37$\\{a\_close}(\\{read\_file}[\|m])$;\5
$\\{read\_open}[\|m]\K\\{closed}$;\6
\&{if} $\\{align\_state}\I1000000$ \1\&{then}\6
\&{begin} \37\\{runaway};\5
$\\{print\_err}(\.{"File\ ended\ within\ "})$;\5
$\\{print\_esc}(\.{"read"})$;\5
$\\{help1}(\.{"This\ \\read\ has\ unbalanced\ braces."})$;\5
$\\{align\_state}\K1000000$;\5
$\\{limit}\K0$;\5
\\{error};\6
\&{end};\2\6
\&{end};\2\6
\&{end}\par
\U509.\fi

\N513.  \[28] Conditional processing.
We consider now the way \TeX\ handles various kinds of \.{\\if} commands.

\Y\P\D \37$\\{unless\_code}=32$\C{amount added for `\.{\\unless}' prefix}\Y\par
\P\D \37$\\{if\_char\_code}=0$\C{ `\.{\\if}' }\par
\P\D \37$\\{if\_cat\_code}=1$\C{ `\.{\\ifcat}' }\par
\P\D \37$\\{if\_int\_code}=2$\C{ `\.{\\ifnum}' }\par
\P\D \37$\\{if\_dim\_code}=3$\C{ `\.{\\ifdim}' }\par
\P\D \37$\\{if\_odd\_code}=4$\C{ `\.{\\ifodd}' }\par
\P\D \37$\\{if\_vmode\_code}=5$\C{ `\.{\\ifvmode}' }\par
\P\D \37$\\{if\_hmode\_code}=6$\C{ `\.{\\ifhmode}' }\par
\P\D \37$\\{if\_mmode\_code}=7$\C{ `\.{\\ifmmode}' }\par
\P\D \37$\\{if\_inner\_code}=8$\C{ `\.{\\ifinner}' }\par
\P\D \37$\\{if\_void\_code}=9$\C{ `\.{\\ifvoid}' }\par
\P\D \37$\\{if\_hbox\_code}=10$\C{ `\.{\\ifhbox}' }\par
\P\D \37$\\{if\_vbox\_code}=11$\C{ `\.{\\ifvbox}' }\par
\P\D \37$\\{ifx\_code}=12$\C{ `\.{\\ifx}' }\par
\P\D \37$\\{if\_eof\_code}=13$\C{ `\.{\\ifeof}' }\par
\P\D \37$\\{if\_true\_code}=14$\C{ `\.{\\iftrue}' }\par
\P\D \37$\\{if\_false\_code}=15$\C{ `\.{\\iffalse}' }\par
\P\D \37$\\{if\_case\_code}=16$\C{ `\.{\\ifcase}' }\par
\P\D \37$\\{if\_pdfprimitive\_code}=21$\C{ `\.{\\ifpdfprimitive}' }\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"if"},\39\\{if\_test},\39\\{if\_char\_code})$;\5
$\\{primitive}(\.{"ifcat"},\39\\{if\_test},\39\\{if\_cat\_code})$;\5
$\\{primitive}(\.{"ifnum"},\39\\{if\_test},\39\\{if\_int\_code})$;\5
$\\{primitive}(\.{"ifdim"},\39\\{if\_test},\39\\{if\_dim\_code})$;\5
$\\{primitive}(\.{"ifodd"},\39\\{if\_test},\39\\{if\_odd\_code})$;\5
$\\{primitive}(\.{"ifvmode"},\39\\{if\_test},\39\\{if\_vmode\_code})$;\5
$\\{primitive}(\.{"ifhmode"},\39\\{if\_test},\39\\{if\_hmode\_code})$;\5
$\\{primitive}(\.{"ifmmode"},\39\\{if\_test},\39\\{if\_mmode\_code})$;\5
$\\{primitive}(\.{"ifinner"},\39\\{if\_test},\39\\{if\_inner\_code})$;\5
$\\{primitive}(\.{"ifvoid"},\39\\{if\_test},\39\\{if\_void\_code})$;\5
$\\{primitive}(\.{"ifhbox"},\39\\{if\_test},\39\\{if\_hbox\_code})$;\5
$\\{primitive}(\.{"ifvbox"},\39\\{if\_test},\39\\{if\_vbox\_code})$;\5
$\\{primitive}(\.{"ifx"},\39\\{if\_test},\39\\{ifx\_code})$;\5
$\\{primitive}(\.{"ifeof"},\39\\{if\_test},\39\\{if\_eof\_code})$;\5
$\\{primitive}(\.{"iftrue"},\39\\{if\_test},\39\\{if\_true\_code})$;\5
$\\{primitive}(\.{"iffalse"},\39\\{if\_test},\39\\{if\_false\_code})$;\5
$\\{primitive}(\.{"ifcase"},\39\\{if\_test},\39\\{if\_case\_code})$;\5
$\\{primitive}(\.{"ifpdfprimitive"},\39\\{if\_test},\39\\{if\_pdfprimitive%
\_code})$;\par
\fi

\M514. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{if\_test}: \37\&{begin} \37\&{if} $\\{chr\_code}\G\\{unless\_code}$ \1%
\&{then}\5
$\\{print\_esc}(\.{"unless"})$;\2\6
\&{case} $\\{chr\_code}\mathbin{\&{mod}}\\{unless\_code}$ \1\&{of}\6
\4\\{if\_cat\_code}: \37$\\{print\_esc}(\.{"ifcat"})$;\6
\4\\{if\_int\_code}: \37$\\{print\_esc}(\.{"ifnum"})$;\6
\4\\{if\_dim\_code}: \37$\\{print\_esc}(\.{"ifdim"})$;\6
\4\\{if\_odd\_code}: \37$\\{print\_esc}(\.{"ifodd"})$;\6
\4\\{if\_vmode\_code}: \37$\\{print\_esc}(\.{"ifvmode"})$;\6
\4\\{if\_hmode\_code}: \37$\\{print\_esc}(\.{"ifhmode"})$;\6
\4\\{if\_mmode\_code}: \37$\\{print\_esc}(\.{"ifmmode"})$;\6
\4\\{if\_inner\_code}: \37$\\{print\_esc}(\.{"ifinner"})$;\6
\4\\{if\_void\_code}: \37$\\{print\_esc}(\.{"ifvoid"})$;\6
\4\\{if\_hbox\_code}: \37$\\{print\_esc}(\.{"ifhbox"})$;\6
\4\\{if\_vbox\_code}: \37$\\{print\_esc}(\.{"ifvbox"})$;\6
\4\\{ifx\_code}: \37$\\{print\_esc}(\.{"ifx"})$;\6
\4\\{if\_eof\_code}: \37$\\{print\_esc}(\.{"ifeof"})$;\6
\4\\{if\_true\_code}: \37$\\{print\_esc}(\.{"iftrue"})$;\6
\4\\{if\_false\_code}: \37$\\{print\_esc}(\.{"iffalse"})$;\6
\4\\{if\_case\_code}: \37$\\{print\_esc}(\.{"ifcase"})$;\6
\4\\{if\_pdfprimitive\_code}: \37$\\{print\_esc}(\.{"ifpdfprimitive"})$;\6
\X1764:Cases of \\{if\_test} for \\{print\_cmd\_chr}\X\6
\4\&{othercases} \37$\\{print\_esc}(\.{"if"})$\2\6
\&{endcases};\6
\&{end};\par
\fi

\M515. Conditions can be inside conditions, and this nesting has a stack
that is independent of the \\{save\_stack}.

Four global variables represent the top of the condition stack:
\\{cond\_ptr} points to pushed-down entries, if any; \\{if\_limit} specifies
the largest code of a \\{fi\_or\_else} command that is syntactically legal;
\\{cur\_if} is the name of the current type of conditional; and \\{if\_line}
is the line number at which it began.

If no conditions are currently in progress, the condition stack has the
special state $\\{cond\_ptr}=\\{null}$, $\\{if\_limit}=\\{normal}$, $\\{cur%
\_if}=0$, $\\{if\_line}=0$.
Otherwise \\{cond\_ptr} points to a two-word node; the \\{type}, \\{subtype},
and
\\{link} fields of the first word contain \\{if\_limit}, \\{cur\_if}, and
\\{cond\_ptr} at the next level, and the second word contains the
corresponding \\{if\_line}.

\Y\P\D \37$\\{if\_node\_size}=2$\C{number of words in stack entry for
conditionals}\par
\P\D \37$\\{if\_line\_field}(\#)\S\\{mem}[\#+1].\\{int}$\par
\P\D \37$\\{if\_code}=1$\C{code for \.{\\if...} being evaluated}\par
\P\D \37$\\{fi\_code}=2$\C{code for \.{\\fi}}\par
\P\D \37$\\{else\_code}=3$\C{code for \.{\\else}}\par
\P\D \37$\\{or\_code}=4$\C{code for \.{\\or}}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cond\_ptr}: \37\\{pointer};\C{top of the condition stack}\6
\4\\{if\_limit}: \37$\\{normal}\to\\{or\_code}$;\C{upper bound on \\{fi\_or%
\_else} codes}\6
\4\\{cur\_if}: \37\\{small\_number};\C{type of conditional being worked on}\6
\4\\{if\_line}: \37\\{integer};\C{line where that conditional began}\par
\fi

\M516. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{cond\_ptr}\K\\{null}$;\5
$\\{if\_limit}\K\\{normal}$;\5
$\\{cur\_if}\K0$;\5
$\\{if\_line}\K0$;\par
\fi

\M517. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"fi"},\39\\{fi\_or\_else},\39\\{fi\_code})$;\5
$\\{text}(\\{frozen\_fi})\K\.{"fi"}$;\5
$\\{eqtb}[\\{frozen\_fi}]\K\\{eqtb}[\\{cur\_val}]$;\5
$\\{primitive}(\.{"or"},\39\\{fi\_or\_else},\39\\{or\_code})$;\5
$\\{primitive}(\.{"else"},\39\\{fi\_or\_else},\39\\{else\_code})$;\par
\fi

\M518. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{fi\_or\_else}: \37\&{if} $\\{chr\_code}=\\{fi\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"fi"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{or\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"or"})$\6
\4\&{else} $\\{print\_esc}(\.{"else"})$;\2\2\par
\fi

\M519. When we skip conditional text, we keep track of the line number
where skipping began, for use in error messages.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{skip\_line}: \37\\{integer};\C{skipping began here}\par
\fi

\M520. Here is a procedure that ignores text until coming to an \.{\\or},
\.{\\else}, or \.{\\fi} at the current level of $\.{\\if}\ldots\.{\\fi}$
nesting. After it has acted, \\{cur\_chr} will indicate the token that
was found, but \\{cur\_tok} will not be set (because this makes the
procedure run faster).

\Y\P\4\&{procedure}\1\  \37\\{pass\_text};\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\|l: \37\\{integer};\C{level of $\.{\\if}\ldots\.{\\fi}$ nesting}\6
\\{save\_scanner\_status}: \37\\{small\_number};\C{\\{scanner\_status} upon
entry}\2\6
\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{skipping}$;\5
$\|l\K0$;\5
$\\{skip\_line}\K\\{line}$;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_next};\6
\&{if} $\\{cur\_cmd}=\\{fi\_or\_else}$ \1\&{then}\6
\&{begin} \37\&{if} $\|l=0$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{if} $\\{cur\_chr}=\\{fi\_code}$ \1\&{then}\5
$\\{decr}(\|l)$;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{if\_test}$ \1\&{then}\5
$\\{incr}(\|l)$;\2\2\6
\&{end};\2\6
\4\\{done}: \37$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{if} $\\{tracing\_ifs}>0$ \1\&{then}\5
\\{show\_cur\_cmd\_chr};\2\6
\&{end};\par
\fi

\M521. When we begin to process a new \.{\\if}, we set $\\{if\_limit}\K\\{if%
\_code}$; then
if\/ \.{\\or} or \.{\\else} or \.{\\fi} occurs before the current \.{\\if}
condition has been evaluated, \.{\\relax} will be inserted.
For example, a sequence of commands like `\.{\\ifvoid1\\else...\\fi}'
would otherwise require something after the `\.1'.

\Y\P$\4\X521:Push the condition stack\X\S$\6
\&{begin} \37$\|p\K\\{get\_node}(\\{if\_node\_size})$;\5
$\\{link}(\|p)\K\\{cond\_ptr}$;\5
$\\{type}(\|p)\K\\{if\_limit}$;\5
$\\{subtype}(\|p)\K\\{cur\_if}$;\5
$\\{if\_line\_field}(\|p)\K\\{if\_line}$;\5
$\\{cond\_ptr}\K\|p$;\5
$\\{cur\_if}\K\\{cur\_chr}$;\5
$\\{if\_limit}\K\\{if\_code}$;\5
$\\{if\_line}\K\\{line}$;\6
\&{end}\par
\U524.\fi

\M522. \P$\X522:Pop the condition stack\X\S$\6
\&{begin} \37\&{if} $\\{if\_stack}[\\{in\_open}]=\\{cond\_ptr}$ \1\&{then}\5
\\{if\_warning};\C{conditionals possibly not properly nested with files}\2\6
$\|p\K\\{cond\_ptr}$;\5
$\\{if\_line}\K\\{if\_line\_field}(\|p)$;\5
$\\{cur\_if}\K\\{subtype}(\|p)$;\5
$\\{if\_limit}\K\\{type}(\|p)$;\5
$\\{cond\_ptr}\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{if\_node\_size})$;\6
\&{end}\par
\Us524, 526, 535\ETs536.\fi

\M523. Here's a procedure that changes the \\{if\_limit} code corresponding to
a given value of \\{cond\_ptr}.

\Y\P\4\&{procedure}\1\  \37$\\{change\_if\_limit}(\|l:\\{small\_number};\,\35%
\|p:\\{pointer})$;\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|q: \37\\{pointer};\2\6
\&{begin} \37\&{if} $\|p=\\{cond\_ptr}$ \1\&{then}\5
$\\{if\_limit}\K\|l$\C{that's the easy case}\6
\4\&{else} \&{begin} \37$\|q\K\\{cond\_ptr}$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"if"})$;\2\6
\&{if} $\\{link}(\|q)=\|p$ \1\&{then}\6
\&{begin} \37$\\{type}(\|q)\K\|l$;\5
\&{return};\6
\&{end};\2\6
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M524. A condition is started when the \\{expand} procedure encounters
an \\{if\_test} command; in that case \\{expand} reduces to \\{conditional},
which is a recursive procedure.

\Y\P\4\&{procedure}\1\  \37\\{conditional};\6
\4\&{label} \37$\\{exit},\39\\{common\_ending}$;\6
\4\&{var} \37\|b: \37\\{boolean};\C{is the condition true?}\6
\|e: \37\\{boolean};\C{keep track of nested csnames}\6
\|r: \37$\.{"<"}\to\.{">"}$;\C{relation to be evaluated}\6
$\|m,\39\|n$: \37\\{integer};\C{to be tested against the second operand}\6
$\|p,\39\|q$: \37\\{pointer};\C{for traversing token lists in \.{\\ifx} tests}\6
\\{save\_scanner\_status}: \37\\{small\_number};\C{\\{scanner\_status} upon
entry}\6
\\{save\_cond\_ptr}: \37\\{pointer};\C{\\{cond\_ptr} corresponding to this
conditional}\6
\\{this\_if}: \37\\{small\_number};\C{type of this conditional}\6
\\{is\_unless}: \37\\{boolean};\C{was this if preceded by `\.{\\unless}' ?}\2\6
\&{begin} \37\&{if} $\\{tracing\_ifs}>0$ \1\&{then}\6
\&{if} $\\{tracing\_commands}\L1$ \1\&{then}\5
\\{show\_cur\_cmd\_chr};\2\2\6
\X521:Push the condition stack\X;\ $\\{save\_cond\_ptr}\K\\{cond\_ptr}$;\5
$\\{is\_unless}\K(\\{cur\_chr}\G\\{unless\_code})$;\5
$\\{this\_if}\K\\{cur\_chr}\mathbin{\&{mod}}\\{unless\_code}$;\6
\X527:Either process \.{\\ifcase} or set \|b to the value of a boolean
condition\X;\6
\&{if} $\\{is\_unless}$ \1\&{then}\5
$\|b\K\R\|b$;\2\6
\&{if} $\\{tracing\_commands}>1$ \1\&{then}\5
\X528:Display the value of \|b\X;\2\6
\&{if} $\|b$ \1\&{then}\6
\&{begin} \37$\\{change\_if\_limit}(\\{else\_code},\39\\{save\_cond\_ptr})$;\5
\&{return};\C{wait for \.{\\else} or \.{\\fi}}\6
\&{end};\2\6
\X526:Skip to \.{\\else} or \.{\\fi}, then \&{goto} \\{common\_ending}\X;\6
\4\\{common\_ending}: \37\&{if} $\\{cur\_chr}=\\{fi\_code}$ \1\&{then}\5
\X522:Pop the condition stack\X\6
\4\&{else} $\\{if\_limit}\K\\{fi\_code}$;\C{wait for \.{\\fi}}\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M525. In a construction like `\.{\\if\\iftrue abc\\else d\\fi}', the first
\.{\\else} that we come to after learning that the \.{\\if} is false is
not the \.{\\else} we're looking for. Hence the following curious
logic is needed.

\fi

\M526. \P$\X526:Skip to \.{\\else} or \.{\\fi}, then \&{goto} \\{common%
\_ending}\X\S$\6
\~ \1\&{loop}\ \&{begin} \37\\{pass\_text};\6
\&{if} $\\{cond\_ptr}=\\{save\_cond\_ptr}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_chr}\I\\{or\_code}$ \1\&{then}\5
\&{goto} \37\\{common\_ending};\2\6
$\\{print\_err}(\.{"Extra\ "})$;\5
$\\{print\_esc}(\.{"or"})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ this;\ it\ doesn\'t\ match\ any\ \\if."})$;\5
\\{error};\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_chr}=\\{fi\_code}$ \1\&{then}\5
\X522:Pop the condition stack\X;\2\2\6
\&{end}\2\par
\U524.\fi

\M527. \P$\X527:Either process \.{\\ifcase} or set \|b to the value of a
boolean condition\X\S$\6
\&{case} $\\{this\_if}$ \1\&{of}\6
\4$\\{if\_char\_code},\39\\{if\_cat\_code}$: \37\X532:Test if two characters
match\X;\6
\4$\\{if\_int\_code},\39\\{if\_dim\_code}$: \37\X529:Test relation between
integers or dimensions\X;\6
\4\\{if\_odd\_code}: \37\X530:Test if an integer is odd\X;\6
\4\\{if\_vmode\_code}: \37$\|b\K(\\{abs}(\\{mode})=\\{vmode})$;\6
\4\\{if\_hmode\_code}: \37$\|b\K(\\{abs}(\\{mode})=\\{hmode})$;\6
\4\\{if\_mmode\_code}: \37$\|b\K(\\{abs}(\\{mode})=\\{mmode})$;\6
\4\\{if\_inner\_code}: \37$\|b\K(\\{mode}<0)$;\6
\4$\\{if\_void\_code},\39\\{if\_hbox\_code},\39\\{if\_vbox\_code}$: \37%
\X531:Test box register status\X;\6
\4\\{ifx\_code}: \37\X533:Test if two tokens match\X;\6
\4\\{if\_eof\_code}: \37\&{begin} \37\\{scan\_four\_bit\_int};\5
$\|b\K(\\{read\_open}[\\{cur\_val}]=\\{closed})$;\6
\&{end};\6
\4\\{if\_true\_code}: \37$\|b\K\\{true}$;\6
\4\\{if\_false\_code}: \37$\|b\K\\{false}$;\6
\X1766:Cases for \\{conditional}\X\6
\4\\{if\_case\_code}: \37\X535:Select the appropriate case and \&{return} or %
\&{goto} \\{common\_ending}\X;\6
\4\\{if\_pdfprimitive\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K%
\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_next};\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{if} $\\{cur\_cs}<\\{hash\_base}$ \1\&{then}\5
$\|m\K\\{prim\_lookup}(\\{cur\_cs}-\\{single\_base})$\6
\4\&{else} $\|m\K\\{prim\_lookup}(\\{text}(\\{cur\_cs}))$;\2\6
$\|b\K((\\{cur\_cmd}\I\\{undefined\_cs})\W(\|m\I\\{undefined\_primitive})\W(%
\\{cur\_cmd}=\\{prim\_eq\_type}(\|m))\W(\\{cur\_chr}=\\{prim\_equiv}(\|m)))$;\6
\&{end};\2\6
\&{end}\C{there are no other cases}\par
\U524.\fi

\M528. \P$\X528:Display the value of \|b\X\S$\6
\&{begin} \37\\{begin\_diagnostic};\6
\&{if} $\|b$ \1\&{then}\5
$\\{print}(\.{"\{true\}"})$\ \&{else} $\\{print}(\.{"\{false\}"})$;\2\6
$\\{end\_diagnostic}(\\{false})$;\6
\&{end}\par
\U524.\fi

\M529. Here we use the fact that \.{"<"}, \.{"="}, and \.{">"} are consecutive
ASCII
codes.

\Y\P$\4\X529:Test relation between integers or dimensions\X\S$\6
\&{begin} \37\&{if} $\\{this\_if}=\\{if\_int\_code}$ \1\&{then}\5
\\{scan\_int}\ \&{else} \\{scan\_normal\_dimen};\2\6
$\|n\K\\{cur\_val}$;\5
\X432:Get the next non-blank non-call token\X;\6
\&{if} $(\\{cur\_tok}\G\\{other\_token}+\.{"<"})\W(\\{cur\_tok}\L\\{other%
\_token}+\.{">"})$ \1\&{then}\5
$\|r\K\\{cur\_tok}-\\{other\_token}$\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Missing\ =\ inserted\ for\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{this\_if})$;\5
$\\{help1}(\.{"I\ was\ expecting\ to\ see\ \`<\',\ \`=\',\ or\ \`>\'.\ Didn%
\'t."})$;\5
\\{back\_error};\5
$\|r\K\.{"="}$;\6
\&{end};\2\6
\&{if} $\\{this\_if}=\\{if\_int\_code}$ \1\&{then}\5
\\{scan\_int}\ \&{else} \\{scan\_normal\_dimen};\2\6
\&{case} $\|r$ \1\&{of}\6
\4\.{"<"}: \37$\|b\K(\|n<\\{cur\_val})$;\6
\4\.{"="}: \37$\|b\K(\|n=\\{cur\_val})$;\6
\4\.{">"}: \37$\|b\K(\|n>\\{cur\_val})$;\2\6
\&{end};\6
\&{end}\par
\U527.\fi

\M530. \P$\X530:Test if an integer is odd\X\S$\6
\&{begin} \37\\{scan\_int};\5
$\|b\K\\{odd}(\\{cur\_val})$;\6
\&{end}\par
\U527.\fi

\M531. \P$\X531:Test box register status\X\S$\6
\&{begin} \37\\{scan\_register\_num};\5
$\\{fetch\_box}(\|p)$;\6
\&{if} $\\{this\_if}=\\{if\_void\_code}$ \1\&{then}\5
$\|b\K(\|p=\\{null})$\6
\4\&{else} \&{if} $\|p=\\{null}$ \1\&{then}\5
$\|b\K\\{false}$\6
\4\&{else} \&{if} $\\{this\_if}=\\{if\_hbox\_code}$ \1\&{then}\5
$\|b\K(\\{type}(\|p)=\\{hlist\_node})$\6
\4\&{else} $\|b\K(\\{type}(\|p)=\\{vlist\_node})$;\2\2\2\6
\&{end}\par
\U527.\fi

\M532. An active character will be treated as category 13 following
\.{\\if\\noexpand} or following \.{\\ifcat\\noexpand}. We use the fact that
active characters have the smallest tokens, among all control sequences.

\Y\P\D \37$\\{get\_x\_token\_or\_active\_char}\S\hbox{}$\6
\&{begin} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cmd}=\\{relax}$ \1\&{then}\6
\&{if} $\\{cur\_chr}=\\{no\_expand\_flag}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{active\_char}$;\5
$\\{cur\_chr}\K\\{cur\_tok}-\\{cs\_token\_flag}-\\{active\_base}$;\6
\&{end};\2\2\6
\&{end}\par
\Y\P$\4\X532:Test if two characters match\X\S$\6
\&{begin} \37\\{get\_x\_token\_or\_active\_char};\6
\&{if} $(\\{cur\_cmd}>\\{active\_char})\V(\\{cur\_chr}>255)$ \1\&{then}\C{not a
character}\6
\&{begin} \37$\|m\K\\{relax}$;\5
$\|n\K256$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|m\K\\{cur\_cmd}$;\5
$\|n\K\\{cur\_chr}$;\6
\&{end};\2\6
\\{get\_x\_token\_or\_active\_char};\6
\&{if} $(\\{cur\_cmd}>\\{active\_char})\V(\\{cur\_chr}>255)$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{relax}$;\5
$\\{cur\_chr}\K256$;\6
\&{end};\2\6
\&{if} $\\{this\_if}=\\{if\_char\_code}$ \1\&{then}\5
$\|b\K(\|n=\\{cur\_chr})$\ \&{else} $\|b\K(\|m=\\{cur\_cmd})$;\2\6
\&{end}\par
\U527.\fi

\M533. Note that `\.{\\ifx}' will declare two macros different if one is %
\\{long}
or \\{outer} and the other isn't, even though the texts of the macros are
the same.

We need to reset \\{scanner\_status}, since \.{\\outer} control sequences
are allowed, but we might be scanning a macro definition or preamble.

\Y\P$\4\X533:Test if two tokens match\X\S$\6
\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_next};\5
$\|n\K\\{cur\_cs}$;\5
$\|p\K\\{cur\_cmd}$;\5
$\|q\K\\{cur\_chr}$;\5
\\{get\_next};\6
\&{if} $\\{cur\_cmd}\I\|p$ \1\&{then}\5
$\|b\K\\{false}$\6
\4\&{else} \&{if} $\\{cur\_cmd}<\\{call}$ \1\&{then}\5
$\|b\K(\\{cur\_chr}=\|q)$\6
\4\&{else} \X534:Test if two macro texts match\X;\2\2\6
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{end}\par
\U527.\fi

\M534. Note also that `\.{\\ifx}' decides that macros \.{\\a} and \.{\\b} are
different in examples like this:
$$\vbox{\halign{\.{#}\hfil&\qquad\.{#}\hfil\cr
{}\\def\\a\{\\c\}&
{}\\def\\c\{\}\cr
{}\\def\\b\{\\d\}&
{}\\def\\d\{\}\cr}}$$

\Y\P$\4\X534:Test if two macro texts match\X\S$\6
\&{begin} \37$\|p\K\\{link}(\\{cur\_chr})$;\5
$\|q\K\\{link}(\\{equiv}(\|n))$;\C{omit reference counts}\6
\&{if} $\|p=\|q$ \1\&{then}\5
$\|b\K\\{true}$\6
\4\&{else} \&{begin} \37\&{while} $(\|p\I\\{null})\W(\|q\I\\{null})$ \1\&{do}\6
\&{if} $\\{info}(\|p)\I\\{info}(\|q)$ \1\&{then}\5
$\|p\K\\{null}$\6
\4\&{else} \&{begin} \37$\|p\K\\{link}(\|p)$;\5
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\2\6
$\|b\K((\|p=\\{null})\W(\|q=\\{null}))$;\6
\&{end};\2\6
\&{end}\par
\U533.\fi

\M535. \P$\X535:Select the appropriate case and \&{return} or \&{goto} %
\\{common\_ending}\X\S$\6
\&{begin} \37\\{scan\_int};\5
$\|n\K\\{cur\_val}$;\C{\|n is the number of cases to pass}\6
\&{if} $\\{tracing\_commands}>1$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print}(\.{"\{case\ "})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print\_char}(\.{"\}"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\2\6
\&{while} $\|n\I0$ \1\&{do}\6
\&{begin} \37\\{pass\_text};\6
\&{if} $\\{cond\_ptr}=\\{save\_cond\_ptr}$ \1\&{then}\6
\&{if} $\\{cur\_chr}=\\{or\_code}$ \1\&{then}\5
$\\{decr}(\|n)$\6
\4\&{else} \&{goto} \37\\{common\_ending}\2\6
\4\&{else} \&{if} $\\{cur\_chr}=\\{fi\_code}$ \1\&{then}\5
\X522:Pop the condition stack\X;\2\2\6
\&{end};\2\6
$\\{change\_if\_limit}(\\{or\_code},\39\\{save\_cond\_ptr})$;\5
\&{return};\C{wait for \.{\\or}, \.{\\else}, or \.{\\fi}}\6
\&{end}\par
\U527.\fi

\M536. The processing of conditionals is complete except for the following
code, which is actually part of \\{expand}. It comes into play when
\.{\\or}, \.{\\else}, or \.{\\fi} is scanned.

\Y\P$\4\X536:Terminate the current conditional and skip to \.{\\fi}\X\S$\6
\&{begin} \37\&{if} $\\{tracing\_ifs}>0$ \1\&{then}\6
\&{if} $\\{tracing\_commands}\L1$ \1\&{then}\5
\\{show\_cur\_cmd\_chr};\2\2\6
\&{if} $\\{cur\_chr}>\\{if\_limit}$ \1\&{then}\6
\&{if} $\\{if\_limit}=\\{if\_code}$ \1\&{then}\5
\\{insert\_relax}\C{condition not yet evaluated}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Extra\ "})$;\5
$\\{print\_cmd\_chr}(\\{fi\_or\_else},\39\\{cur\_chr})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ this;\ it\ doesn\'t\ match\ any\ \\if."})$;\5
\\{error};\6
\&{end}\2\6
\4\&{else} \&{begin} \37\&{while} $\\{cur\_chr}\I\\{fi\_code}$ \1\&{do}\5
\\{pass\_text};\C{skip to \.{\\fi}}\2\6
\X522:Pop the condition stack\X;\6
\&{end};\2\6
\&{end}\par
\U391.\fi

\N537.  \[29] File names.
It's time now to fret about file names.  Besides the fact that different
operating systems treat files in different ways, we must cope with the
fact that completely different naming conventions are used by different
groups of people. The following programs show what is required for one
particular operating system; similar routines for other systems are not
difficult to devise.

\TeX\ assumes that a file name has three parts: the name proper; its
``extension''; and a ``file area'' where it is found in an external file
system.  The extension of an input file or a write file is assumed to be
`\.{.tex}' unless otherwise specified; it is `\.{.log}' on the
transcript file that records each run of \TeX; it is `\.{.tfm}' on the font
metric files that describe characters in the fonts \TeX\ uses; it is
`\.{.dvi}' on the output files that specify typesetting information; and it
is `\.{.fmt}' on the format files written by \.{INITEX} to initialize \TeX.
The file area can be arbitrary on input files, but files are usually
output to the user's current area.  If an input file cannot be
found on the specified area, \TeX\ will look for it on a special system
area; this special area is intended for commonly used input files like
\.{webmac.tex}.

Simple uses of \TeX\ refer only to file names that have no explicit
extension or area. For example, a person usually says `\.{\\input} \.{paper}'
or `\.{\\font\\tenrm} \.= \.{helvetica}' instead of `\.{\\input}
\.{paper.new}' or `\.{\\font\\tenrm} \.= \.{<csd.knuth>test}'. Simple file
names are best, because they make the \TeX\ source files portable;
whenever a file name consists entirely of letters and digits, it should be
treated in the same way by all implementations of \TeX. However, users
need the ability to refer to other files in their environment, especially
when responding to error messages concerning unopenable files; therefore
we want to let them use the syntax that appears in their favorite
operating system.

The following procedures don't allow spaces to be part of
file names; but some users seem to like names that are spaced-out.
System-dependent changes to allow such things should probably
be made with reluctance, and only when an entire file name that
includes spaces is ``quoted'' somehow.

\fi

\M538. In order to isolate the system-dependent aspects of file names, the
system-independent parts of \TeX\ are expressed in terms
of three system-dependent
procedures called \\{begin\_name}, \\{more\_name}, and \\{end\_name}. In
essence, if the user-specified characters of the file name are $c_1\ldots c_n$,
the system-independent driver program does the operations
$$\\{begin\_name};\,\\{more\_name}(c_1);\,\ldots\,;\,\\{more\_name}(c_n);
\,\\{end\_name}.$$
These three procedures communicate with each other via global variables.
Afterwards the file name will appear in the string pool as three strings
called \\{cur\_name}\penalty10000\hskip-.05em,
\\{cur\_area}, and \\{cur\_ext}; the latter two are null (i.e.,
\.{""}), unless they were explicitly specified by the user.

Actually the situation is slightly more complicated, because \TeX\ needs
to know when the file name ends. The \\{more\_name} routine is a function
(with side effects) that returns \\{true} on the calls \\{more\_name}$(c_1)$,
\dots, \\{more\_name}$(c_{n-1})$. The final call \\{more\_name}$(c_n)$
returns \\{false}; or, it returns \\{true} and the token following $c_n$ is
something like `\.{\\hbox}' (i.e., not a character). In other words,
\\{more\_name} is supposed to return \\{true} unless it is sure that the
file name has been completely scanned; and \\{end\_name} is supposed to be able
to finish the assembly of \\{cur\_name}, \\{cur\_area}, and \\{cur\_ext}
regardless of
whether $\\{more\_name}(c_n)$ returned \\{true} or \\{false}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_name}: \37\\{str\_number};\C{name of file just scanned}\6
\4\\{cur\_area}: \37\\{str\_number};\C{file area just scanned, or \.{""}}\6
\4\\{cur\_ext}: \37\\{str\_number};\C{file extension just scanned, or \.{""}}%
\par
\fi

\M539. The file names we shall deal with for illustrative purposes have the
following structure:  If the name contains `\.>' or `\.:', the file area
consists of all characters up to and including the final such character;
otherwise the file area is null.  If the remaining file name contains
`\..', the file extension consists of all such characters from the first
remaining `\..' to the end, otherwise the file extension is null.

We can scan such file names easily by using two global variables that keep
track
of the occurrences of area and extension delimiters:

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{area\_delimiter}: \37\\{pool\_pointer};\C{the most recent `\.>' or `\.:',
if any}\6
\4\\{ext\_delimiter}: \37\\{pool\_pointer};\C{the relevant `\..', if any}\par
\fi

\M540. Input files that can't be found in the user's area may appear in a
standard
system area called \\{TEX\_area}. Font metric files whose areas are not given
explicitly are assumed to appear in a standard system area called
\\{TEX\_font\_area}.  These system area names will, of course, vary from place
to place.

\Y\P\D \37$\\{TEX\_area}\S\.{"TeXinputs:"}$\par
\P\D \37$\\{TEX\_font\_area}\S\.{"TeXfonts:"}$\par
\fi

\M541. Here now is the first of the system-dependent routines for file name
scanning.

\Y\P\4\&{procedure}\1\  \37\\{begin\_name};\2\6
\&{begin} \37$\\{area\_delimiter}\K0$;\5
$\\{ext\_delimiter}\K0$;\6
\&{end};\par
\fi

\M542. And here's the second. The string pool might change as the file name is
being scanned, since a new \.{\\csname} might be entered; therefore we keep
\\{area\_delimiter} and \\{ext\_delimiter} relative to the beginning of the
current
string, instead of assigning an absolute address like \\{pool\_ptr} to them.

\Y\P\4\&{function}\1\  \37$\\{more\_name}(\|c:\\{ASCII\_code})$: \37%
\\{boolean};\2\6
\&{begin} \37\&{if} $\|c=\.{"\ "}$ \1\&{then}\5
$\\{more\_name}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{str\_room}(1)$;\5
$\\{append\_char}(\|c)$;\C{contribute \|c to the current string}\6
\&{if} $(\|c=\.{">"})\V(\|c=\.{":"})$ \1\&{then}\6
\&{begin} \37$\\{area\_delimiter}\K\\{cur\_length}$;\5
$\\{ext\_delimiter}\K0$;\6
\&{end}\6
\4\&{else} \&{if} $(\|c=\.{"."})\W(\\{ext\_delimiter}=0)$ \1\&{then}\5
$\\{ext\_delimiter}\K\\{cur\_length}$;\2\2\6
$\\{more\_name}\K\\{true}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M543. The third.

\Y\P\4\&{procedure}\1\  \37\\{end\_name};\2\6
\&{begin} \37\&{if} $\\{str\_ptr}+3>\\{max\_strings}$ \1\&{then}\5
$\\{overflow}(\.{"number\ of\ strings"},\39\\{max\_strings}-\\{init\_str%
\_ptr})$;\2\6
\&{if} $\\{area\_delimiter}=0$ \1\&{then}\5
$\\{cur\_area}\K\.{""}$\6
\4\&{else} \&{begin} \37$\\{cur\_area}\K\\{str\_ptr}$;\5
$\\{str\_start}[\\{str\_ptr}+1]\K\\{str\_start}[\\{str\_ptr}]+\\{area%
\_delimiter}$;\5
$\\{incr}(\\{str\_ptr})$;\6
\&{end};\2\6
\&{if} $\\{ext\_delimiter}=0$ \1\&{then}\6
\&{begin} \37$\\{cur\_ext}\K\.{""}$;\5
$\\{cur\_name}\K\\{make\_string}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_name}\K\\{str\_ptr}$;\5
$\\{str\_start}[\\{str\_ptr}+1]\K\\{str\_start}[\\{str\_ptr}]+\\{ext%
\_delimiter}-\\{area\_delimiter}-1$;\5
$\\{incr}(\\{str\_ptr})$;\5
$\\{cur\_ext}\K\\{make\_string}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M544. Conversely, here is a routine that takes three strings and prints a file
name that might have produced them. (The routine is system dependent, because
some operating systems put the file area last instead of first.)

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_file\_name}(\|n,\39\|a,\39\|e:\\{integer})$;%
\2\6
\&{begin} \37$\\{slow\_print}(\|a)$;\5
$\\{slow\_print}(\|n)$;\5
$\\{slow\_print}(\|e)$;\6
\&{end};\par
\fi

\M545. Another system-dependent routine is needed to convert three internal
\TeX\ strings
into the \\{name\_of\_file} value that is used to open files. The present code
allows both lowercase and uppercase letters in the file name.

\Y\P\D \37$\\{append\_to\_name}(\#)\S$\1\6
\&{begin} \37$\|c\K\#$;\5
$\\{incr}(\|k)$;\6
\&{if} $\|k\L\\{file\_name\_size}$ \1\&{then}\5
$\\{name\_of\_file}[\|k]\K\\{xchr}[\|c]$;\2\6
\&{end}\2\par
\Y\P\4\&{procedure}\1\  \37$\\{pack\_file\_name}(\|n,\39\|a,\39\|e:\\{str%
\_number})$;\6
\4\&{var} \37\|k: \37\\{integer};\C{number of positions filled in \\{name\_of%
\_file}}\6
\|c: \37\\{ASCII\_code};\C{character being packed}\6
\|j: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\2\6
\&{begin} \37$\|k\K0$;\6
\&{for} $\|j\K\\{str\_start}[\|a]\mathrel{\&{to}}\\{str\_start}[\|a+1]-1$ \1%
\&{do}\5
$\\{append\_to\_name}(\\{so}(\\{str\_pool}[\|j]))$;\2\6
\&{for} $\|j\K\\{str\_start}[\|n]\mathrel{\&{to}}\\{str\_start}[\|n+1]-1$ \1%
\&{do}\5
$\\{append\_to\_name}(\\{so}(\\{str\_pool}[\|j]))$;\2\6
\&{for} $\|j\K\\{str\_start}[\|e]\mathrel{\&{to}}\\{str\_start}[\|e+1]-1$ \1%
\&{do}\5
$\\{append\_to\_name}(\\{so}(\\{str\_pool}[\|j]))$;\2\6
\&{if} $\|k\L\\{file\_name\_size}$ \1\&{then}\5
$\\{name\_length}\K\|k$\ \&{else} $\\{name\_length}\K\\{file\_name\_size}$;\2\6
\&{for} $\|k\K\\{name\_length}+1\mathrel{\&{to}}\\{file\_name\_size}$ \1\&{do}\5
$\\{name\_of\_file}[\|k]\K\.{\'\ \'}$;\2\6
\&{end};\par
\fi

\M546. A messier routine is also needed, since format file names must be
scanned
before \TeX's string mechanism has been initialized. We shall use the
global variable \\{TEX\_format\_default} to supply the text for default system
areas
and extensions related to format files.

\Y\P\D \37$\\{format\_default\_length}=20$\C{length of the \\{TEX\_format%
\_default} string}\par
\P\D \37$\\{format\_area\_length}=11$\C{length of its area part}\par
\P\D \37$\\{format\_ext\_length}=4$\C{length of its `\.{.fmt}' part}\par
\P\D \37$\\{format\_extension}=\.{".fmt"}$\C{the extension, as a \.{WEB}
constant}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{TEX\_format\_default}: \37\&{packed} \37\&{array} $[1\to\\{format\_default%
\_length}]$ \1\&{of}\5
\\{char};\2\par
\fi

\M547. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{TEX\_format\_default}\K\.{\'TeXformats:plain.fmt\'}$;\par
\fi

\M548. \P$\X14:Check the ``constant'' values for consistency\X\mathrel{+}\S$\6
\&{if} $\\{format\_default\_length}>\\{file\_name\_size}$ \1\&{then}\5
$\\{bad}\K31$;\2\par
\fi

\M549. Here is the messy routine that was just mentioned. It sets \\{name\_of%
\_file}
from the first \|n characters of \\{TEX\_format\_default}, followed by
$\\{buffer}[\|a\to\|b]$, followed by the last \\{format\_ext\_length}
characters of
\\{TEX\_format\_default}.

We dare not give error messages here, since \TeX\ calls this routine before
the \\{error} routine is ready to roll. Instead, we simply drop excess
characters,
since the error will be detected in another way when a strange file name
isn't found.

\Y\P\4\&{procedure}\1\  \37$\\{pack\_buffered\_name}(\|n:\\{small\_number};\,%
\35\|a,\39\|b:\\{integer})$;\6
\4\&{var} \37\|k: \37\\{integer};\C{number of positions filled in \\{name\_of%
\_file}}\6
\|c: \37\\{ASCII\_code};\C{character being packed}\6
\|j: \37\\{integer};\C{index into \\{buffer} or \\{TEX\_format\_default}}\2\6
\&{begin} \37\&{if} $\|n+\|b-\|a+1+\\{format\_ext\_length}>\\{file\_name%
\_size}$ \1\&{then}\5
$\|b\K\|a+\\{file\_name\_size}-\|n-1-\\{format\_ext\_length}$;\2\6
$\|k\K0$;\6
\&{for} $\|j\K1\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{append\_to\_name}(\\{xord}[\\{TEX\_format\_default}[\|j]])$;\2\6
\&{for} $\|j\K\|a\mathrel{\&{to}}\|b$ \1\&{do}\5
$\\{append\_to\_name}(\\{buffer}[\|j])$;\2\6
\&{for} $\|j\K\\{format\_default\_length}-\\{format\_ext\_length}+1\mathrel{%
\&{to}}\\{format\_default\_length}$ \1\&{do}\5
$\\{append\_to\_name}(\\{xord}[\\{TEX\_format\_default}[\|j]])$;\2\6
\&{if} $\|k\L\\{file\_name\_size}$ \1\&{then}\5
$\\{name\_length}\K\|k$\ \&{else} $\\{name\_length}\K\\{file\_name\_size}$;\2\6
\&{for} $\|k\K\\{name\_length}+1\mathrel{\&{to}}\\{file\_name\_size}$ \1\&{do}\5
$\\{name\_of\_file}[\|k]\K\.{\'\ \'}$;\2\6
\&{end};\par
\fi

\M550. Here is the only place we use \\{pack\_buffered\_name}. This part of the
program
becomes active when a ``virgin'' \TeX\ is trying to get going, just after
the preliminary initialization, or when the user is substituting another
format file by typing `\.\&' after the initial `\.{**}' prompt.  The buffer
contains the first line of input in $\\{buffer}[\\{loc}\to(\\{last}-1)]$, where
$\\{loc}<\\{last}$ and $\\{buffer}[\\{loc}]\I\.{"\ "}$.

\Y\P$\4\X550:Declare the function called \\{open\_fmt\_file}\X\S$\6
\4\&{function}\1\  \37\\{open\_fmt\_file}: \37\\{boolean};\6
\4\&{label} \37$\\{found},\39\\{exit}$;\6
\4\&{var} \37\|j: \37$0\to\\{buf\_size}$;\C{the first space after the format
file name}\2\6
\&{begin} \37$\|j\K\\{loc}$;\6
\&{if} $\\{buffer}[\\{loc}]=\.{"\&"}$ \1\&{then}\6
\&{begin} \37$\\{incr}(\\{loc})$;\5
$\|j\K\\{loc}$;\5
$\\{buffer}[\\{last}]\K\.{"\ "}$;\6
\&{while} $\\{buffer}[\|j]\I\.{"\ "}$ \1\&{do}\5
$\\{incr}(\|j)$;\2\6
$\\{pack\_buffered\_name}(0,\39\\{loc},\39\|j-1)$;\C{try first without the
system file area}\6
\&{if} $\\{w\_open\_in}(\\{fmt\_file})$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
$\\{pack\_buffered\_name}(\\{format\_area\_length},\39\\{loc},\39\|j-1)$;\C{now
try the system format file area}\6
\&{if} $\\{w\_open\_in}(\\{fmt\_file})$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\\{wake\_up\_terminal};\5
$\\{wterm\_ln}(\.{\'Sorry,\ I\ can\'}\.{\'t\ find\ that\ format;\'},\39\.{\'\
will\ try\ PLAIN.\'})$;\5
\\{update\_terminal};\6
\&{end};\C{now pull out all the stops: try for the system \.{plain} file}\2\6
$\\{pack\_buffered\_name}(\\{format\_default\_length}-\\{format\_ext\_length},%
\391,\390)$;\6
\&{if} $\R\\{w\_open\_in}(\\{fmt\_file})$ \1\&{then}\6
\&{begin} \37\\{wake\_up\_terminal};\5
$\\{wterm\_ln}(\.{\'I\ can\'}\.{\'t\ find\ the\ PLAIN\ format\ file!\'})$;\5
$\\{open\_fmt\_file}\K\\{false}$;\5
\&{return};\6
\&{end};\2\6
\4\\{found}: \37$\\{loc}\K\|j$;\5
$\\{open\_fmt\_file}\K\\{true}$;\6
\4\\{exit}: \37\&{end};\par
\U1481.\fi

\M551. Operating systems often make it possible to determine the exact name
(and
possible version number) of a file that has been opened. The following routine,
which simply makes a \TeX\ string from the value of \\{name\_of\_file}, should
ideally be changed to deduce the full name of file~\|f, which is the file
most recently opened, if it is possible to do this in a \PASCAL\ program.

This routine might be called after string memory has overflowed, hence
we dare not use `\\{str\_room}'.

\Y\P\4\&{function}\1\  \37\\{make\_name\_string}: \37\\{str\_number};\6
\4\&{var} \37\|k: \37$1\to\\{file\_name\_size}$;\C{index into \\{name\_of%
\_file}}\2\6
\&{begin} \37\&{if} $(\\{pool\_ptr}+\\{name\_length}>\\{pool\_size})\V(\\{str%
\_ptr}=\\{max\_strings})\V(\\{cur\_length}>0)$ \1\&{then}\5
$\\{make\_name\_string}\K\.{"?"}$\6
\4\&{else} \&{begin} \37\&{for} $\|k\K1\mathrel{\&{to}}\\{name\_length}$ \1%
\&{do}\5
$\\{append\_char}(\\{xord}[\\{name\_of\_file}[\|k]])$;\2\6
$\\{make\_name\_string}\K\\{make\_string}$;\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{a\_make\_name\_string}(\mathop{\&{var}}\|f:\\{alpha%
\_file})$: \37\\{str\_number};\2\6
\&{begin} \37$\\{a\_make\_name\_string}\K\\{make\_name\_string}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{b\_make\_name\_string}(\mathop{\&{var}}\|f:\\{byte%
\_file})$: \37\\{str\_number};\2\6
\&{begin} \37$\\{b\_make\_name\_string}\K\\{make\_name\_string}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{w\_make\_name\_string}(\mathop{\&{var}}\|f:\\{word%
\_file})$: \37\\{str\_number};\2\6
\&{begin} \37$\\{w\_make\_name\_string}\K\\{make\_name\_string}$;\6
\&{end};\par
\fi

\M552. Now let's consider the ``driver''
routines by which \TeX\ deals with file names
in a system-independent manner.  First comes a procedure that looks for a
file name in the input by calling \\{get\_x\_token} for the information.

\Y\P\4\&{procedure}\1\  \37\\{scan\_file\_name};\6
\4\&{label} \37\\{done};\2\6
\&{begin} \37$\\{name\_in\_progress}\K\\{true}$;\5
\\{begin\_name};\5
\X432:Get the next non-blank non-call token\X;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $(\\{cur\_cmd}>\\{other\_char})\V(\\{cur%
\_chr}>255)$ \1\&{then}\C{not a character}\6
\&{begin} \37\\{back\_input};\5
\&{goto} \37\\{done};\6
\&{end};\2\6
\&{if} $\R\\{more\_name}(\\{cur\_chr})$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\\{get\_x\_token};\6
\&{end};\2\6
\4\\{done}: \37\\{end\_name};\5
$\\{name\_in\_progress}\K\\{false}$;\6
\&{end};\par
\fi

\M553. The global variable \\{name\_in\_progress} is used to prevent recursive
use of \\{scan\_file\_name}, since the \\{begin\_name} and other procedures
communicate via global variables. Recursion would arise only by
devious tricks like `\.{\\input\\input f}'; such attempts at sabotage
must be thwarted. Furthermore, \\{name\_in\_progress} prevents \.{\\input}
from being initiated when a font size specification is being scanned.

Another global variable, \\{job\_name}, contains the file name that was first
\.{\\input} by the user. This name is extended by `\.{.log}' and `\.{.dvi}'
and `\.{.fmt}' in the names of \TeX's output files.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{name\_in\_progress}: \37\\{boolean};\C{is a file name being scanned?}\6
\4\\{job\_name}: \37\\{str\_number};\C{principal file name}\6
\4\\{log\_opened}: \37\\{boolean};\C{has the transcript file been opened?}\par
\fi

\M554. Initially $\\{job\_name}=0$; it becomes nonzero as soon as the true name
is known.
We have $\\{job\_name}=0$ if and only if the `\.{log}' file has not been
opened,
except of course for a short time just after \\{job\_name} has become nonzero.

\Y\P$\4\X55:Initialize the output routines\X\mathrel{+}\S$\6
$\\{job\_name}\K0$;\5
$\\{name\_in\_progress}\K\\{false}$;\5
$\\{log\_opened}\K\\{false}$;\par
\fi

\M555. Here is a routine that manufactures the output file names, assuming that
$\\{job\_name}\I0$. It ignores and changes the current settings of \\{cur%
\_area}
and \\{cur\_ext}.

\Y\P\D \37$\\{pack\_cur\_name}\S\\{pack\_file\_name}(\\{cur\_name},\39\\{cur%
\_area},\39\\{cur\_ext})$\par
\Y\P\4\&{procedure}\1\  \37$\\{pack\_job\_name}(\|s:\\{str\_number})$;\C{$\|s=%
\.{".log"}$, \.{".dvi"}, or   \\{format\_extension}}\2\6
\&{begin} \37$\\{cur\_area}\K\.{""}$;\5
$\\{cur\_ext}\K\|s$;\5
$\\{cur\_name}\K\\{job\_name}$;\5
\\{pack\_cur\_name};\6
\&{end};\par
\fi

\M556. If some trouble arises when \TeX\ tries to open a file, the following
routine calls upon the user to supply another file name. Parameter~\|s
is used in the error message to identify the type of file; parameter~\|e
is the default extension if none is given. Upon exit from the routine,
variables \\{cur\_name}, \\{cur\_area}, \\{cur\_ext}, and \\{name\_of\_file}
are
ready for another attempt at file opening.

\Y\P\4\&{procedure}\1\  \37$\\{prompt\_file\_name}(\|s,\39\|e:\\{str%
\_number})$;\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\|k: \37$0\to\\{buf\_size}$;\C{index into \\{buffer}}\2\6
\&{begin} \37\&{if} $\\{interaction}=\\{scroll\_mode}$ \1\&{then}\5
\\{wake\_up\_terminal};\2\6
\&{if} $\|s=\.{"input\ file\ name"}$ \1\&{then}\5
$\\{print\_err}(\.{"I\ can\'t\ find\ file\ \`"})$\6
\4\&{else} $\\{print\_err}(\.{"I\ can\'t\ write\ on\ file\ \`"})$;\2\6
$\\{print\_file\_name}(\\{cur\_name},\39\\{cur\_area},\39\\{cur\_ext})$;\5
$\\{print}(\.{"\'."})$;\6
\&{if} $\|e=\.{".tex"}$ \1\&{then}\5
\\{show\_context};\2\6
$\\{print\_nl}(\.{"Please\ type\ another\ "})$;\5
$\\{print}(\|s)$;\6
\&{if} $\\{interaction}<\\{scroll\_mode}$ \1\&{then}\5
$\\{fatal\_error}(\.{"***\ (job\ aborted,\ file\ error\ in\ nonstop\ mode)"})$;%
\2\6
\\{clear\_terminal};\5
$\\{prompt\_input}(\.{":\ "})$;\5
\X557:Scan file name in the buffer\X;\6
\&{if} $\\{cur\_ext}=\.{""}$ \1\&{then}\5
$\\{cur\_ext}\K\|e$;\2\6
\\{pack\_cur\_name};\6
\&{end};\par
\fi

\M557. \P$\X557:Scan file name in the buffer\X\S$\6
\&{begin} \37\\{begin\_name};\5
$\|k\K\\{first}$;\6
\&{while} $(\\{buffer}[\|k]=\.{"\ "})\W(\|k<\\{last})$ \1\&{do}\5
$\\{incr}(\|k)$;\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\|k=\\{last}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{if} $\R\\{more\_name}(\\{buffer}[\|k])$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\\{incr}(\|k)$;\6
\&{end};\2\6
\4\\{done}: \37\\{end\_name};\6
\&{end}\par
\U556.\fi

\M558. Here's an example of how these conventions are used. Whenever it is time
to
ship out a box of stuff, we shall use the macro \\{ensure\_dvi\_open}.

\Y\P\D \37$\\{ensure\_dvi\_open}\S$\1\6
\&{if} $\\{output\_file\_name}=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\2\6
$\\{pack\_job\_name}(\.{".dvi"})$;\6
\&{while} $\R\\{b\_open\_out}(\\{dvi\_file})$ \1\&{do}\5
$\\{prompt\_file\_name}(\.{"file\ name\ for\ output"},\39\.{".dvi"})$;\2\6
$\\{output\_file\_name}\K\\{b\_make\_name\_string}(\\{dvi\_file})$;\6
\&{end}\2\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{dvi\_file}: \37\\{byte\_file};\C{the device-independent output goes here}\6
\4\\{output\_file\_name}: \37\\{str\_number};\C{full name of the output file}\6
\4\\{log\_name}: \37\\{str\_number};\C{full name of the log file}\par
\fi

\M559. \P$\X55:Initialize the output routines\X\mathrel{+}\S$\6
$\\{output\_file\_name}\K0$;\par
\fi

\M560. The \\{open\_log\_file} routine is used to open the transcript file and
to help
it catch up to what has previously been printed on the terminal.

\Y\P\4\&{procedure}\1\  \37\\{open\_log\_file};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{previous %
\\{selector} setting}\6
\|k: \37$0\to\\{buf\_size}$;\C{index into \\{months} and \\{buffer}}\6
\|l: \37$0\to\\{buf\_size}$;\C{end of first input line}\6
\\{months}: \37\&{packed} \37\&{array} $[1\to36]$ \1\&{of}\5
\\{char};\C{abbreviations of month names}\2\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\6
\&{if} $\\{job\_name}=0$ \1\&{then}\5
$\\{job\_name}\K\.{"texput"}$;\2\6
$\\{pack\_job\_name}(\.{".log"})$;\6
\&{while} $\R\\{a\_open\_out}(\\{log\_file})$ \1\&{do}\5
\X561:Try to get a different log file name\X;\2\6
$\\{log\_name}\K\\{a\_make\_name\_string}(\\{log\_file})$;\5
$\\{selector}\K\\{log\_only}$;\5
$\\{log\_opened}\K\\{true}$;\5
\X562:Print the banner line, including the date and time\X;\6
$\\{input\_stack}[\\{input\_ptr}]\K\\{cur\_input}$;\C{make sure bottom level is
in memory}\6
$\\{print\_nl}(\.{"**"})$;\5
$\|l\K\\{input\_stack}[0].\\{limit\_field}$;\C{last position of first line}\6
\&{if} $\\{buffer}[\|l]=\\{end\_line\_char}$ \1\&{then}\5
$\\{decr}(\|l)$;\2\6
\&{for} $\|k\K1\mathrel{\&{to}}\|l$ \1\&{do}\5
$\\{print}(\\{buffer}[\|k])$;\2\6
\\{print\_ln};\C{now the transcript file contains the first line of input}\6
$\\{selector}\K\\{old\_setting}+2$;\C{\\{log\_only} or \\{term\_and\_log}}\6
\&{end};\par
\fi

\M561. Sometimes \\{open\_log\_file} is called at awkward moments when \TeX\ is
unable to print error messages or even to \\{show\_context}.
The \\{prompt\_file\_name} routine can result in a \\{fatal\_error}, but the %
\\{error}
routine will not be invoked because \\{log\_opened} will be false.

The normal idea of \\{batch\_mode} is that nothing at all should be written
on the terminal. However, in the unusual case that
no log file could be opened, we make an exception and allow
an explanatory message to be seen.

Incidentally, the program always refers to the log file as a `\.{transcript
file}', because some systems cannot use the extension `\.{.log}' for
this file.

\Y\P$\4\X561:Try to get a different log file name\X\S$\6
\&{begin} \37$\\{selector}\K\\{term\_only}$;\5
$\\{prompt\_file\_name}(\.{"transcript\ file\ name"},\39\.{".log"})$;\6
\&{end}\par
\U560.\fi

\M562. \P$\X562:Print the banner line, including the date and time\X\S$\6
\&{begin} \37$\\{wlog}(\\{banner})$;\5
$\\{slow\_print}(\\{format\_ident})$;\5
$\\{print}(\.{"\ \ "})$;\5
$\\{print\_int}(\\{sys\_day})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{months}\K\.{\'JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC\'}$;\6
\&{for} $\|k\K3\ast\\{sys\_month}-2\mathrel{\&{to}}3\ast\\{sys\_month}$ \1%
\&{do}\5
$\\{wlog}(\\{months}[\|k])$;\2\6
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\\{sys\_year})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_two}(\\{sys\_time}\mathbin{\&{div}}60)$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_two}(\\{sys\_time}\mathbin{\&{mod}}60)$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37;\5
\\{wlog\_cr};\5
$\\{wlog}(\.{\'entering\ extended\ mode\'})$;\6
\&{end};\2\6
\&{end}\par
\U560.\fi

\M563. Let's turn now to the procedure that is used to initiate file reading
when an `\.{\\input}' command is being processed.
Beware: For historic reasons, this code foolishly conserves a tiny bit
of string pool space; but that can confuse the interactive `\.E' option.

\Y\P\4\&{procedure}\1\  \37\\{start\_input};\C{\TeX\ will \.{\\input}
something}\6
\4\&{label} \37\\{done};\2\6
\&{begin} \37\\{scan\_file\_name};\C{set \\{cur\_name} to desired file name}\6
\&{if} $\\{cur\_ext}=\.{""}$ \1\&{then}\5
$\\{cur\_ext}\K\.{".tex"}$;\2\6
\\{pack\_cur\_name};\6
\~ \1\&{loop}\ \&{begin} \37\\{begin\_file\_reading};\C{set up \\{cur\_file}
and new level of input}\6
\&{if} $\\{a\_open\_in}(\\{cur\_file})$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{if} $\\{cur\_area}=\.{""}$ \1\&{then}\6
\&{begin} \37$\\{pack\_file\_name}(\\{cur\_name},\39\\{TEX\_area},\39\\{cur%
\_ext})$;\6
\&{if} $\\{a\_open\_in}(\\{cur\_file})$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{end};\2\6
\\{end\_file\_reading};\C{remove the level that didn't work}\6
$\\{prompt\_file\_name}(\.{"input\ file\ name"},\39\.{".tex"})$;\6
\&{end};\2\6
\4\\{done}: \37$\\{name}\K\\{a\_make\_name\_string}(\\{cur\_file})$;\6
\&{if} $\\{job\_name}=0$ \1\&{then}\6
\&{begin} \37$\\{job\_name}\K\\{cur\_name}$;\5
\\{open\_log\_file};\6
\&{end};\C{\\{open\_log\_file} doesn't \\{show\_context}, so \\{limit}     and %
\\{loc} needn't be set to meaningful values yet}\2\6
\&{if} $\\{term\_offset}+\\{length}(\\{name})>\\{max\_print\_line}-2$ \1%
\&{then}\5
\\{print\_ln}\6
\4\&{else} \&{if} $(\\{term\_offset}>0)\V(\\{file\_offset}>0)$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\2\6
$\\{print\_char}(\.{"("})$;\5
$\\{incr}(\\{open\_parens})$;\5
$\\{slow\_print}(\\{name})$;\5
\\{update\_terminal};\5
$\\{state}\K\\{new\_line}$;\6
\&{if} $\\{name}=\\{str\_ptr}-1$ \1\&{then}\C{conserve string pool space (but
see note above)}\6
\&{begin} \37\\{flush\_string};\5
$\\{name}\K\\{cur\_name}$;\6
\&{end};\2\6
\X564:Read the first line of the new file\X;\6
\&{end};\par
\fi

\M564. Here we have to remember to tell the \\{input\_ln} routine not to
start with a \\{get}. If the file is empty, it is considered to
contain a single blank line.

\Y\P$\4\X564:Read the first line of the new file\X\S$\6
\&{begin} \37$\\{line}\K1$;\6
\&{if} $\\{input\_ln}(\\{cur\_file},\39\\{false})$ \1\&{then}\5
\\{do\_nothing};\2\6
\\{firm\_up\_the\_line};\6
\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{decr}(\\{limit})$\6
\4\&{else} $\\{buffer}[\\{limit}]\K\\{end\_line\_char}$;\2\6
$\\{first}\K\\{limit}+1$;\5
$\\{loc}\K\\{start}$;\6
\&{end}\par
\U563.\fi

\N565.  \[30] Font metric data.
\TeX\ gets its knowledge about fonts from font metric files, also called
\.{TFM} files; the `\.T' in `\.{TFM}' stands for \TeX,
but other programs know about them too.

The information in a \.{TFM} file appears in a sequence of 8-bit bytes.
Since the number of bytes is always a multiple of 4, we could
also regard the file as a sequence of 32-bit words, but \TeX\ uses the
byte interpretation. The format of \.{TFM} files was designed by
Lyle Ramshaw in 1980. The intent is to convey a lot of different kinds
of information in a compact but useful form.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{tfm\_file}: \37\\{byte\_file};\par
\fi

\M566. The first 24 bytes (6 words) of a \.{TFM} file contain twelve 16-bit
integers that give the lengths of the various subsequent portions
of the file. These twelve integers are, in order:
$$\vbox{\halign{\hfil#&$\null=\null$#\hfil\cr
\\{lf}&length of the entire file, in words;\cr
\\{lh}&length of the header data, in words;\cr
\\{bc}&smallest character code in the font;\cr
\\{ec}&largest character code in the font;\cr
\\{nw}&number of words in the width table;\cr
\\{nh}&number of words in the height table;\cr
\\{nd}&number of words in the depth table;\cr
\\{ni}&number of words in the italic correction table;\cr
\\{nl}&number of words in the lig/kern table;\cr
\\{nk}&number of words in the kern table;\cr
\\{ne}&number of words in the extensible character table;\cr
\\{np}&number of font parameter words.\cr}}$$
They are all nonnegative and less than $2^{15}$. We must have $\\{bc}-1\L\\{ec}%
\L255$,
and
$$\hbox{$\\{lf}=6+\\{lh}+(\\{ec}-\\{bc}+1)+\\{nw}+\\{nh}+\\{nd}+\\{ni}+\\{nl}+%
\\{nk}+\\{ne}+\\{np}$.}$$
Note that a font may contain as many as 256 characters (if $\\{bc}=0$ and $%
\\{ec}=255$),
and as few as 0 characters (if $\\{bc}=\\{ec}+1$).

Incidentally, when two or more 8-bit bytes are combined to form an integer of
16 or more bits, the most significant bytes appear first in the file.
This is called BigEndian order.

\fi

\M567. The rest of the \.{TFM} file may be regarded as a sequence of ten data
arrays having the informal specification
$$\def\arr$[#1]#2${\&{array} $[#1]$ \&{of} #2}
\vbox{\halign{\hfil\\{#}&$\,:\,$\arr#\hfil\cr
header&$[0\to\\{lh}-1]\hbox{\\{stuff}}$\cr
char\_info&$[\\{bc}\to\\{ec}]\\{char\_info\_word}$\cr
width&$[0\to\\{nw}-1]\\{fix\_word}$\cr
height&$[0\to\\{nh}-1]\\{fix\_word}$\cr
depth&$[0\to\\{nd}-1]\\{fix\_word}$\cr
italic&$[0\to\\{ni}-1]\\{fix\_word}$\cr
lig\_kern&$[0\to\\{nl}-1]\\{lig\_kern\_command}$\cr
kern&$[0\to\\{nk}-1]\\{fix\_word}$\cr
exten&$[0\to\\{ne}-1]\\{extensible\_recipe}$\cr
param&$[1\to\\{np}]\\{fix\_word}$\cr}}$$
The most important data type used here is a \\{fix\_word}, which is
a 32-bit representation of a binary fraction. A \\{fix\_word} is a signed
quantity, with the two's complement of the entire word used to represent
negation. Of the 32 bits in a \\{fix\_word}, exactly 12 are to the left of the
binary point; thus, the largest \\{fix\_word} value is $2048-2^{-20}$, and
the smallest is $-2048$. We will see below, however, that all but two of
the \\{fix\_word} values must lie between $-16$ and $+16$.

\fi

\M568. The first data array is a block of header information, which contains
general facts about the font. The header must contain at least two words,
$\\{header}[0]$ and $\\{header}[1]$, whose meaning is explained below.
Additional header information of use to other software routines might
also be included, but \TeX82 does not need to know about such details.
For example, 16 more words of header information are in use at the Xerox
Palo Alto Research Center; the first ten specify the character coding
scheme used (e.g., `\.{XEROX text}' or `\.{TeX math symbols}'), the next five
give the font identifier (e.g., `\.{HELVETICA}' or `\.{CMSY}'), and the
last gives the ``face byte.'' The program that converts \.{DVI} files
to Xerox printing format gets this information by looking at the \.{TFM}
file, which it needs to read anyway because of other information that
is not explicitly repeated in \.{DVI}~format.

\yskip\hang$\\{header}[0]$ is a 32-bit check sum that \TeX\ will copy into
the \.{DVI} output file. Later on when the \.{DVI} file is printed,
possibly on another computer, the actual font that gets used is supposed
to have a check sum that agrees with the one in the \.{TFM} file used by
\TeX. In this way, users will be warned about potential incompatibilities.
(However, if the check sum is zero in either the font file or the \.{TFM}
file, no check is made.)  The actual relation between this check sum and
the rest of the \.{TFM} file is not important; the check sum is simply an
identification number with the property that incompatible fonts almost
always have distinct check sums.

\yskip\hang$\\{header}[1]$ is a \\{fix\_word} containing the design size of
the font, in units of \TeX\ points. This number must be at least 1.0; it is
fairly arbitrary, but usually the design size is 10.0 for a ``10 point''
font, i.e., a font that was designed to look best at a 10-point size,
whatever that really means. When a \TeX\ user asks for a font
`\.{at} $\delta$ \.{pt}', the effect is to override the design size
and replace it by $\delta$, and to multiply the $x$ and~$y$ coordinates
of the points in the font image by a factor of $\delta$ divided by the
design size.  {\sl All other dimensions in the\/ \.{TFM} file are
\\{fix\_word}\kern-1pt\ numbers in design-size units}, with the exception of
$\\{param}[1]$ (which denotes the slant ratio). Thus, for example, the value
of $\\{param}[6]$, which defines the \.{em} unit, is often the \\{fix\_word}
value
$2^{20}=1.0$, since many fonts have a design size equal to one em.
The other dimensions must be less than 16 design-size units in absolute
value; thus, $\\{header}[1]$ and $\\{param}[1]$ are the only \\{fix\_word}
entries in the whole \.{TFM} file whose first byte might be something
besides 0 or 255.

\fi

\M569. Next comes the \\{char\_info} array, which contains one \\{char\_info%
\_word}
per character. Each word in this part of the file contains six fields
packed into four bytes as follows.

\yskip\hang first byte: \\{width\_index} (8 bits)\par
\hang second byte: \\{height\_index} (4 bits) times 16, plus \\{depth\_index}
(4~bits)\par
\hang third byte: \\{italic\_index} (6 bits) times 4, plus \\{tag}
(2~bits)\par
\hang fourth byte: \\{remainder} (8 bits)\par
\yskip\noindent
The actual width of a character is \\{width}$[\\{width\_index}]$, in
design-size
units; this is a device for compressing information, since many characters
have the same width. Since it is quite common for many characters
to have the same height, depth, or italic correction, the \.{TFM} format
imposes a limit of 16 different heights, 16 different depths, and
64 different italic corrections.

The italic correction of a character has two different uses.
(a)~In ordinary text, the italic correction is added to the width only if
the \TeX\ user specifies `\.{\\/}' after the character.
(b)~In math formulas, the italic correction is always added to the width,
except with respect to the positioning of subscripts.

Incidentally, the relation $\\{width}[0]=\\{height}[0]=\\{depth}[0]=
\\{italic}[0]=0$ should always hold, so that an index of zero implies a
value of zero.  The \\{width\_index} should never be zero unless the
character does not exist in the font, since a character is valid if and
only if it lies between \\{bc} and \\{ec} and has a nonzero \\{width\_index}.

\fi

\M570. The \\{tag} field in a \\{char\_info\_word} has four values that explain
how to
interpret the \\{remainder} field.

\yskip\hangg$\\{tag}=0$ (\\{no\_tag}) means that \\{remainder} is unused.\par
\hangg$\\{tag}=1$ (\\{lig\_tag}) means that this character has a
ligature/kerning
program starting at position \\{remainder} in the \\{lig\_kern} array.\par
\hangg$\\{tag}=2$ (\\{list\_tag}) means that this character is part of a chain
of
characters of ascending sizes, and not the largest in the chain.  The
\\{remainder} field gives the character code of the next larger character.\par
\hangg$\\{tag}=3$ (\\{ext\_tag}) means that this character code represents an
extensible character, i.e., a character that is built up of smaller pieces
so that it can be made arbitrarily large. The pieces are specified in
$\\{exten}[\\{remainder}]$.\par
\yskip\noindent
Characters with $\\{tag}=2$ and $\\{tag}=3$ are treated as characters with $%
\\{tag}=0$
unless they are used in special circumstances in math formulas. For example,
the \.{\\sum} operation looks for a \\{list\_tag}, and the \.{\\left}
operation looks for both \\{list\_tag} and \\{ext\_tag}.

\Y\P\D \37$\\{no\_tag}=0$\C{vanilla character}\par
\P\D \37$\\{lig\_tag}=1$\C{character has a ligature/kerning program}\par
\P\D \37$\\{list\_tag}=2$\C{character has a successor in a charlist}\par
\P\D \37$\\{ext\_tag}=3$\C{character is extensible}\par
\fi

\M571. The \\{lig\_kern} array contains instructions in a simple programming
language
that explains what to do for special letter pairs. Each word in this array is a
\\{lig\_kern\_command} of four bytes.

\yskip\hang first byte: \\{skip\_byte}, indicates that this is the final
program
step if the byte is 128 or more, otherwise the next step is obtained by
skipping this number of intervening steps.\par
\hang second byte: \\{next\_char}, ``if \\{next\_char} follows the current
character,
then perform the operation and stop, otherwise continue.''\par
\hang third byte: \\{op\_byte}, indicates a ligature step if less than~128,
a kern step otherwise.\par
\hang fourth byte: \\{remainder}.\par
\yskip\noindent
In a kern step, an
additional space equal to $\\{kern}[256\ast(\\{op\_byte}-128)+\\{remainder}]$
is inserted
between the current character and \\{next\_char}. This amount is
often negative, so that the characters are brought closer together
by kerning; but it might be positive.

There are eight kinds of ligature steps, having \\{op\_byte} codes $4a+2b+c$
where
$0\le a\le b+c$ and $0\le b,c\le1$. The character whose code is
\\{remainder} is inserted between the current character and \\{next\_char};
then the current character is deleted if $b=0$, and \\{next\_char} is
deleted if $c=0$; then we pass over $a$~characters to reach the next
current character (which may have a ligature/kerning program of its own).

If the very first instruction of the \\{lig\_kern} array has $\\{skip%
\_byte}=255$,
the \\{next\_char} byte is the so-called boundary character of this font;
the value of \\{next\_char} need not lie between \\{bc} and~\\{ec}.
If the very last instruction of the \\{lig\_kern} array has $\\{skip%
\_byte}=255$,
there is a special ligature/kerning program for a boundary character at the
left, beginning at location $256\ast\\{op\_byte}+\\{remainder}$.
The interpretation is that \TeX\ puts implicit boundary characters
before and after each consecutive string of characters from the same font.
These implicit characters do not appear in the output, but they can affect
ligatures and kerning.

If the very first instruction of a character's \\{lig\_kern} program has
$\\{skip\_byte}>128$, the program actually begins in location
$256\ast\\{op\_byte}+\\{remainder}$. This feature allows access to large \\{lig%
\_kern}
arrays, because the first instruction must otherwise
appear in a location $\L255$.

Any instruction with $\\{skip\_byte}>128$ in the \\{lig\_kern} array must
satisfy
the condition
$$\hbox{$256\ast\\{op\_byte}+\\{remainder}<\\{nl}$.}$$
If such an instruction is encountered during
normal program execution, it denotes an unconditional halt; no ligature
or kerning command is performed.

\Y\P\D \37$\\{stop\_flag}\S\\{qi}(128)$\C{value indicating `\.{STOP}' in a
lig/kern program}\par
\P\D \37$\\{kern\_flag}\S\\{qi}(128)$\C{op code for a kern step}\par
\P\D \37$\\{skip\_byte}(\#)\S\#.\\{b0}$\par
\P\D \37$\\{next\_char}(\#)\S\#.\\{b1}$\par
\P\D \37$\\{op\_byte}(\#)\S\#.\\{b2}$\par
\P\D \37$\\{rem\_byte}(\#)\S\#.\\{b3}$\par
\fi

\M572. Extensible characters are specified by an \\{extensible\_recipe}, which
consists of four bytes called \\{top}, \\{mid}, \\{bot}, and \\{rep} (in this
order). These bytes are the character codes of individual pieces used to
build up a large symbol.  If \\{top}, \\{mid}, or \\{bot} are zero, they are
not
present in the built-up result. For example, an extensible vertical line is
like an extensible bracket, except that the top and bottom pieces are missing.

Let $T$, $M$, $B$, and $R$ denote the respective pieces, or an empty box
if the piece isn't present. Then the extensible characters have the form
$TR^kMR^kB$ from top to bottom, for some $\|k\G0$, unless $M$ is absent;
in the latter case we can have $TR^kB$ for both even and odd values of~\|k.
The width of the extensible character is the width of $R$; and the
height-plus-depth is the sum of the individual height-plus-depths of the
components used, since the pieces are butted together in a vertical list.

\Y\P\D \37$\\{ext\_top}(\#)\S\#.\\{b0}$\C{\\{top} piece in a recipe}\par
\P\D \37$\\{ext\_mid}(\#)\S\#.\\{b1}$\C{\\{mid} piece in a recipe}\par
\P\D \37$\\{ext\_bot}(\#)\S\#.\\{b2}$\C{\\{bot} piece in a recipe}\par
\P\D \37$\\{ext\_rep}(\#)\S\#.\\{b3}$\C{\\{rep} piece in a recipe}\par
\fi

\M573. The final portion of a \.{TFM} file is the \\{param} array, which is
another
sequence of \\{fix\_word} values.

\yskip\hang$\\{param}[1]=\\{slant}$ is the amount of italic slant, which is
used
to help position accents. For example, $\\{slant}=.25$ means that when you go
up one unit, you also go .25 units to the right. The \\{slant} is a pure
number; it's the only \\{fix\_word} other than the design size itself that is
not scaled by the design size.

\hang$\\{param}[2]=\\{space}$ is the normal spacing between words in text.
Note that character \.{"\ "} in the font need not have anything to do with
blank spaces.

\hang$\\{param}[3]=\\{space\_stretch}$ is the amount of glue stretching between
words.

\hang$\\{param}[4]=\\{space\_shrink}$ is the amount of glue shrinking between
words.

\hang$\\{param}[5]=\\{x\_height}$ is the size of one ex in the font; it is also
the height of letters for which accents don't have to be raised or lowered.

\hang$\\{param}[6]=\\{quad}$ is the size of one em in the font.

\hang$\\{param}[7]=\\{extra\_space}$ is the amount added to $\\{param}[2]$ at
the
ends of sentences.

\yskip\noindent
If fewer than seven parameters are present, \TeX\ sets the missing parameters
to zero. Fonts used for math symbols are required to have
additional parameter information, which is explained later.

\Y\P\D \37$\\{slant\_code}=1$\par
\P\D \37$\\{space\_code}=2$\par
\P\D \37$\\{space\_stretch\_code}=3$\par
\P\D \37$\\{space\_shrink\_code}=4$\par
\P\D \37$\\{x\_height\_code}=5$\par
\P\D \37$\\{quad\_code}=6$\par
\P\D \37$\\{extra\_space\_code}=7$\par
\fi

\M574. So that is what \.{TFM} files hold. Since \TeX\ has to absorb such
information
about lots of fonts, it stores most of the data in a large array called
\\{font\_info}. Each item of \\{font\_info} is a \\{memory\_word}; the \\{fix%
\_word}
data gets converted into \\{scaled} entries, while everything else goes into
words of type \\{four\_quarters}.

When the user defines \.{\\font\\f}, say, \TeX\ assigns an internal number
to the user's font~\.{\\f}. Adding this number to \\{font\_id\_base} gives the
\\{eqtb} location of a ``frozen'' control sequence that will always select
the font.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{internal\_font\_number}=\\{font\_base}\to\\{font\_max}$;\C{\\{font} in a %
\\{char\_node}}\6
$\\{font\_index}=0\to\\{font\_mem\_size}$;\C{index into \\{font\_info}}\par
\fi

\M575. Here now is the (rather formidable) array of font arrays.

\Y\P\D \37$\\{non\_char}\S\\{qi}(256)$\C{a \\{halfword} code that can't match a
real character}\par
\P\D \37$\\{non\_address}=0$\C{a spurious \\{bchar\_label}}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{font\_info}: \37\&{array} $[\\{font\_index}]$ \1\&{of}\5
\\{memory\_word};\C{the big collection of font data}\2\6
\4\\{fmem\_ptr}: \37\\{font\_index};\C{first unused word of \\{font\_info}}\6
\4\\{font\_ptr}: \37\\{internal\_font\_number};\C{largest internal font number
in use}\6
\4\\{font\_check}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{four\_quarters};\C{check sum}\2\6
\4\\{font\_size}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{scaled};\C{``at'' size}\2\6
\4\\{font\_dsize}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{scaled};\C{``design'' size}\2\6
\4\\{font\_params}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{font\_index};\C{how many font   parameters are present}\2\6
\4\\{font\_name}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{str\_number};\C{name of the font}\2\6
\4\\{font\_area}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{str\_number};\C{area of the font}\2\6
\4\\{font\_bc}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{eight\_bits};\C{beginning (smallest) character code}\2\6
\4\\{font\_ec}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{eight\_bits};\C{ending (largest) character code}\2\6
\4\\{font\_glue}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{pointer};\C{glue specification for interword space, \\{null} if not
allocated}\2\6
\4\\{font\_used}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{boolean};\C{has a character from this font actually appeared in the output?}%
\2\6
\4\\{hyphen\_char}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{current \.{\\hyphenchar} values}\2\6
\4\\{skew\_char}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{current \.{\\skewchar} values}\2\6
\4\\{bchar\_label}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{font\_index};\C{start of \\{lig\_kern} program for left boundary character,
 \\{non\_address} if there is none}\2\6
\4\\{font\_bchar}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
$\\{min\_quarterword}\to\\{non\_char}$;\C{boundary character, \\{non\_char} if
there is none}\2\6
\4\\{font\_false\_bchar}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
$\\{min\_quarterword}\to\\{non\_char}$;\C{\\{font\_bchar} if it doesn't exist
in the font, otherwise \\{non\_char}}\2\par
\fi

\M576. Besides the arrays just enumerated, we have directory arrays that make
it
easy to get at the individual entries in \\{font\_info}. For example, the
\\{char\_info} data for character \|c in font \|f will be in
$\\{font\_info}[\\{char\_base}[\|f]+\|c].\\{qqqq}$; and if \|w is the \\{width%
\_index}
part of this word (the \\{b0} field), the width of the character is
$\\{font\_info}[\\{width\_base}[\|f]+\|w].\\{sc}$. (These formulas assume that
\\{min\_quarterword} has already been added to \|c and to \|w, since \TeX\
stores its quarterwords that way.)

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{char\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for \\{char\_info}}\2\6
\4\\{width\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for widths}\2\6
\4\\{height\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for heights}\2\6
\4\\{depth\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for depths}\2\6
\4\\{italic\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for italic corrections}\2\6
\4\\{lig\_kern\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for ligature/kerning programs}\2\6
\4\\{kern\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for kerns}\2\6
\4\\{exten\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for extensible recipes}\2\6
\4\\{param\_base}: \37\&{array} $[\\{internal\_font\_number}]$ \1\&{of}\5
\\{integer};\C{base addresses for font parameters}\2\par
\fi

\M577. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|k\K\\{font\_base}\mathrel{\&{to}}\\{font\_max}$ \1\&{do}\5
$\\{font\_used}[\|k]\K\\{false}$;\2\par
\fi

\M578. \TeX\ always knows at least one font, namely the null font. It has no
characters, and its seven parameters are all equal to zero.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{font\_ptr}\K\\{null\_font}$;\5
$\\{fmem\_ptr}\K7$;\5
$\\{font\_name}[\\{null\_font}]\K\.{"nullfont"}$;\5
$\\{font\_area}[\\{null\_font}]\K\.{""}$;\5
$\\{hyphen\_char}[\\{null\_font}]\K\.{"-"}$;\5
$\\{skew\_char}[\\{null\_font}]\K-1$;\5
$\\{bchar\_label}[\\{null\_font}]\K\\{non\_address}$;\5
$\\{font\_bchar}[\\{null\_font}]\K\\{non\_char}$;\5
$\\{font\_false\_bchar}[\\{null\_font}]\K\\{non\_char}$;\5
$\\{font\_bc}[\\{null\_font}]\K1$;\5
$\\{font\_ec}[\\{null\_font}]\K0$;\5
$\\{font\_size}[\\{null\_font}]\K0$;\5
$\\{font\_dsize}[\\{null\_font}]\K0$;\5
$\\{char\_base}[\\{null\_font}]\K0$;\5
$\\{width\_base}[\\{null\_font}]\K0$;\5
$\\{height\_base}[\\{null\_font}]\K0$;\5
$\\{depth\_base}[\\{null\_font}]\K0$;\5
$\\{italic\_base}[\\{null\_font}]\K0$;\5
$\\{lig\_kern\_base}[\\{null\_font}]\K0$;\5
$\\{kern\_base}[\\{null\_font}]\K0$;\5
$\\{exten\_base}[\\{null\_font}]\K0$;\5
$\\{font\_glue}[\\{null\_font}]\K\\{null}$;\5
$\\{font\_params}[\\{null\_font}]\K7$;\5
$\\{param\_base}[\\{null\_font}]\K-1$;\6
\&{for} $\|k\K0\mathrel{\&{to}}6$ \1\&{do}\5
$\\{font\_info}[\|k].\\{sc}\K0$;\2\par
\fi

\M579. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"nullfont"},\39\\{set\_font},\39\\{null\_font})$;\5
$\\{text}(\\{frozen\_null\_font})\K\.{"nullfont"}$;\5
$\\{eqtb}[\\{frozen\_null\_font}]\K\\{eqtb}[\\{cur\_val}]$;\par
\fi

\M580. Of course we want to define macros that suppress the detail of how font
information is actually packed, so that we don't have to write things like
$$\hbox{$\\{font\_info}[\\{width\_base}[\|f]+\\{font\_info}[\\{char\_base}[%
\|f]+\|c].\\{qqqq}.\\{b0}].\\{sc}$}$$
too often. The \.{WEB} definitions here make $\\{char\_info}(\|f)(\|c)$ the
\\{four\_quarters} word of font information corresponding to character
\|c of font \|f. If \|q is such a word, $\\{char\_width}(\|f)(\|q)$ will be
the character's width; hence the long formula above is at least
abbreviated to
$$\hbox{$\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$.}$$
Usually, of course, we will fetch \|q first and look at several of its
fields at the same time.

The italic correction of a character will be denoted by
$\\{char\_italic}(\|f)(\|q)$, so it is analogous to \\{char\_width}.  But we
will get
at the height and depth in a slightly different way, since we usually want
to compute both height and depth if we want either one.  The value of
$\\{height\_depth}(\|q)$ will be the 8-bit quantity
$$b=\\{height\_index}\times16+\\{depth\_index},$$ and if \|b is such a byte we
will write $\\{char\_height}(\|f)(\|b)$ and $\\{char\_depth}(\|f)(\|b)$ for the
height and
depth of the character \|c for which $\|q=\\{char\_info}(\|f)(\|c)$. Got that?

The tag field will be called $\\{char\_tag}(\|q)$; the remainder byte will be
called $\\{rem\_byte}(\|q)$, using a macro that we have already defined above.

Access to a character's \\{width}, \\{height}, \\{depth}, and \\{tag} fields is
part of \TeX's inner loop, so we want these macros to produce code that is
as fast as possible under the circumstances.

\Y\P\D \37$\\{char\_info\_end}(\#)\S\#$ ] .\\{qqqq}\par
\P\D $\\{char\_info}(\#)\S\\{font\_info}$ [ $\\{char\_base}[\#]+\\{char\_info%
\_end}$\par
\P\D \37$\\{char\_width\_end}(\#)\S\#.\\{b0}$ ] .\\{sc}\par
\P\D $\\{char\_width}(\#)\S\\{font\_info}$ [ $\\{width\_base}[\#]+\\{char%
\_width\_end}$\par
\P\D \37$\\{char\_exists}(\#)\S(\#.\\{b0}>\\{min\_quarterword})$\par
\P\D \37$\\{char\_italic\_end}(\#)\S(\\{qo}(\#.\\{b2}))\mathbin{\&{div}}4$ ] .%
\\{sc}\par
\P\D $\\{char\_italic}(\#)\S\\{font\_info}$ [ $\\{italic\_base}[\#]+\\{char%
\_italic\_end}$\par
\P\D \37$\\{height\_depth}(\#)\S\\{qo}(\#.\\{b1})$\par
\P\D \37$\\{char\_height\_end}(\#)\S(\#)\mathbin{\&{div}}16$ ] .\\{sc}\par
\P\D $\\{char\_height}(\#)\S\\{font\_info}$ [ $\\{height\_base}[\#]+\\{char%
\_height\_end}$\par
\P\D \37$\\{char\_depth\_end}(\#)\S(\#)\mathbin{\&{mod}}16$ ] .\\{sc}\par
\P\D $\\{char\_depth}(\#)\S\\{font\_info}$ [ $\\{depth\_base}[\#]+\\{char%
\_depth\_end}$\par
\P\D \37$\\{char\_tag}(\#)\S((\\{qo}(\#.\\{b2}))\mathbin{\&{mod}}4)$\par
\fi

\M581. The global variable \\{null\_character} is set up to be a word of
\\{char\_info} for a character that doesn't exist. Such a word provides a
convenient way to deal with erroneous situations.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{null\_character}: \37\\{four\_quarters};\C{nonexistent character
information}\par
\fi

\M582. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{null\_character}.\\{b0}\K\\{min\_quarterword}$;\5
$\\{null\_character}.\\{b1}\K\\{min\_quarterword}$;\5
$\\{null\_character}.\\{b2}\K\\{min\_quarterword}$;\5
$\\{null\_character}.\\{b3}\K\\{min\_quarterword}$;\par
\fi

\M583. Here are some macros that help process ligatures and kerns.
We write $\\{char\_kern}(\|f)(\|j)$ to find the amount of kerning specified by
kerning command~\|j in font~\|f. If \|j is the \\{char\_info} for a character
with a ligature/kern program, the first instruction of that program is either
$\|i=\\{font\_info}[\\{lig\_kern\_start}(\|f)(\|j)]$ or $\\{font\_info}[\\{lig%
\_kern\_restart}(\|f)(\|i)]$,
depending on whether or not $\\{skip\_byte}(\|i)\L\\{stop\_flag}$.

The constant \\{kern\_base\_offset} should be simplified, for \PASCAL\
compilers
that do not do local optimization.

\Y\P\D \37$\\{char\_kern\_end}(\#)\S256\ast\\{op\_byte}(\#)+\\{rem\_byte}(\#)$
] .\\{sc}\par
\P\D $\\{char\_kern}(\#)\S\\{font\_info}$ [ $\\{kern\_base}[\#]+\\{char\_kern%
\_end}$\par
\P\D \37$\\{kern\_base\_offset}\S256\ast(128+\\{min\_quarterword})$\par
\P\D \37$\\{lig\_kern\_start}(\#)\S\\{lig\_kern\_base}[\#]+\\{rem\_byte}$%
\C{beginning of lig/kern program}\par
\P\D \37$\\{lig\_kern\_restart\_end}(\#)\S256\ast\\{op\_byte}(\#)+\\{rem%
\_byte}(\#)+32768-\\{kern\_base\_offset}$\par
\P\D \37$\\{lig\_kern\_restart}(\#)\S\\{lig\_kern\_base}[\#]+\\{lig\_kern%
\_restart\_end}$\par
\fi

\M584. Font parameters are referred to as $\\{slant}(\|f)$, $\\{space}(\|f)$,
etc.

\Y\P\D \37$\\{param\_end}(\#)\S\\{param\_base}[\#]$ ] .\\{sc}\par
\P\D $\\{param}(\#)\S\\{font\_info}$ [ $\#+\\{param\_end}$\par
\P\D \37$\\{slant}\S\\{param}(\\{slant\_code})$\C{slant to the right, per unit
distance upward}\par
\P\D \37$\\{space}\S\\{param}(\\{space\_code})$\C{normal space between words}%
\par
\P\D \37$\\{space\_stretch}\S\\{param}(\\{space\_stretch\_code})$\C{stretch
between words}\par
\P\D \37$\\{space\_shrink}\S\\{param}(\\{space\_shrink\_code})$\C{shrink
between words}\par
\P\D \37$\\{x\_height}\S\\{param}(\\{x\_height\_code})$\C{one ex}\par
\P\D \37$\\{quad}\S\\{param}(\\{quad\_code})$\C{one em}\par
\P\D \37$\\{extra\_space}\S\\{param}(\\{extra\_space\_code})$\C{additional
space at end of sentence}\par
\Y\P$\4\X584:The em width for \\{cur\_font}\X\S$\6
$\\{quad}(\\{cur\_font})$\par
\U481.\fi

\M585. \P$\X585:The x-height for \\{cur\_font}\X\S$\6
$\\{x\_height}(\\{cur\_font})$\par
\U481.\fi

\M586. \TeX\ checks the information of a \.{TFM} file for validity as the
file is being read in, so that no further checks will be needed when
typesetting is going on. The somewhat tedious subroutine that does this
is called \\{read\_font\_info}. It has four parameters: the user font
identifier~\|u, the file name and area strings \\{nom} and \\{aire}, and the
``at'' size~\|s. If \|s~is negative, it's the negative of a scale factor
to be applied to the design size; $\|s=-1000$ is the normal case.
Otherwise \|s will be substituted for the design size; in this
case, \|s must be positive and less than $2048\rm\,pt$
(i.e., it must be less than $2^{27}$ when considered as an integer).

The subroutine opens and closes a global file variable called \\{tfm\_file}.
It returns the value of the internal font number that was just loaded.
If an error is detected, an error message is issued and no font
information is stored; \\{null\_font} is returned in this case.

\Y\P\D \37$\\{bad\_tfm}=11$\C{label for \\{read\_font\_info}}\par
\P\D \37$\\{abort}\S$\1\5
\&{goto} \37\\{bad\_tfm}\C{do this when the \.{TFM} data is wrong}\2\par
\Y\P\4\&{function}\1\  \37$\\{read\_font\_info}(\|u:\\{pointer};\,\35\\{nom},%
\39\\{aire}:\\{str\_number};\,\35\|s:\\{scaled})$: \37\\{internal\_font%
\_number};\C{input a \.{TFM} file}\6
\4\&{label} \37$\\{done},\39\\{bad\_tfm},\39\\{not\_found}$;\6
\4\&{var} \37\|k: \37\\{font\_index};\C{index into \\{font\_info}}\6
\\{file\_opened}: \37\\{boolean};\C{was \\{tfm\_file} successfully opened?}\6
$\\{lf},\39\\{lh},\39\\{bc},\39\\{ec},\39\\{nw},\39\\{nh},\39\\{nd},\39\\{ni},%
\39\\{nl},\39\\{nk},\39\\{ne},\39\\{np}$: \37\\{halfword};\C{sizes of subfiles}%
\6
\|f: \37\\{internal\_font\_number};\C{the new font's number}\6
\|g: \37\\{internal\_font\_number};\C{the number to return}\6
$\|a,\39\|b,\39\|c,\39\|d$: \37\\{eight\_bits};\C{byte variables}\6
\\{qw}: \37\\{four\_quarters};\5
\\{sw}: \37\\{scaled};\C{accumulators}\6
\\{bch\_label}: \37\\{integer};\C{left boundary start location, or infinity}\6
\\{bchar}: \37$0\to256$;\C{boundary character, or 256}\6
\|z: \37\\{scaled};\C{the design size or the ``at'' size}\6
\\{alpha}: \37\\{integer};\5
\\{beta}: \37$1\to16$;\C{auxiliary quantities used in fixed-point
multiplication}\2\6
\&{begin} \37$\|g\K\\{null\_font}$;\6
\X588:Read and check the font data; \\{abort} if the \.{TFM} file is malformed;
if there's no room for this font, say so and \&{goto} \\{done}; otherwise $%
\\{incr}(\\{font\_ptr})$ and \&{goto} \\{done}\X;\6
\4\\{bad\_tfm}: \37\X587:Report that the font won't be loaded\X;\6
\4\\{done}: \37\&{if} $\\{file\_opened}$ \1\&{then}\5
$\\{b\_close}(\\{tfm\_file})$;\2\6
$\\{read\_font\_info}\K\|g$;\6
\&{end};\par
\fi

\M587. There are programs called \.{TFtoPL} and \.{PLtoTF} that convert
between the \.{TFM} format and a symbolic property-list format
that can be easily edited. These programs contain extensive
diagnostic information, so \TeX\ does not have to bother giving
precise details about why it rejects a particular \.{TFM} file.

\Y\P\D \37$\\{start\_font\_error\_message}\S\\{print\_err}(\.{"Font\ "})$;\5
$\\{sprint\_cs}(\|u)$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_file\_name}(\\{nom},\39\\{aire},\39\.{""})$;\6
\&{if} $\|s\G0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ at\ "})$;\5
$\\{print\_scaled}(\|s)$;\5
$\\{print}(\.{"pt"})$;\6
\&{end}\6
\4\&{else} \&{if} $\|s\I-1000$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ scaled\ "})$;\5
$\\{print\_int}(-\|s)$;\6
\&{end}\2\2\par
\Y\P$\4\X587:Report that the font won't be loaded\X\S$\6
\\{start\_font\_error\_message};\6
\&{if} $\\{file\_opened}$ \1\&{then}\5
$\\{print}(\.{"\ not\ loadable:\ Bad\ metric\ (TFM)\ file"})$\6
\4\&{else} $\\{print}(\.{"\ not\ loadable:\ Metric\ (TFM)\ file\ not\
found"})$;\2\6
$\\{help5}(\.{"I\ wasn\'t\ able\ to\ read\ the\ size\ data\ for\ this\
font,"})$\6
$(\.{"so\ I\ will\ ignore\ the\ font\ specification."})$\6
$(\.{"[Wizards\ can\ fix\ TFM\ files\ using\ TFtoPL/PLtoTF.]"})$\6
$(\.{"You\ might\ try\ inserting\ a\ different\ font\ spec;"})$\6
$(\.{"e.g.,\ type\ \`I\\font<same\ font\ id>=<substitute\ font\ name>\'."})$;\5
\\{error}\par
\U586.\fi

\M588. \P$\X588:Read and check the font data; \\{abort} if the \.{TFM} file is
malformed; if there's no room for this font, say so and \&{goto} \\{done};
otherwise $\\{incr}(\\{font\_ptr})$ and \&{goto} \\{done}\X\S$\6
\X589:Open \\{tfm\_file} for input\X;\6
\X591:Read the {\.{TFM}} size fields\X;\6
\X592:Use size fields to allocate font information\X;\6
\X594:Read the {\.{TFM}} header\X;\6
\X595:Read character data\X;\6
\X598:Read box dimensions\X;\6
\X600:Read ligature/kern program\X;\6
\X601:Read extensible character recipes\X;\6
\X602:Read font parameters\X;\6
\X603:Make final adjustments and \&{goto} \\{done}\X\par
\U586.\fi

\M589. \P$\X589:Open \\{tfm\_file} for input\X\S$\6
$\\{file\_opened}\K\\{false}$;\6
\&{if} $\\{aire}=\.{""}$ \1\&{then}\5
$\\{pack\_file\_name}(\\{nom},\39\\{TEX\_font\_area},\39\.{".tfm"})$\6
\4\&{else} $\\{pack\_file\_name}(\\{nom},\39\\{aire},\39\.{".tfm"})$;\2\6
\&{if} $\R\\{b\_open\_in}(\\{tfm\_file})$ \1\&{then}\5
\\{abort};\2\6
$\\{file\_opened}\K\\{true}$\par
\U588.\fi

\M590. Note: A malformed \.{TFM} file might be shorter than it claims to be;
thus $\\{eof}(\\{tfm\_file})$ might be true when \\{read\_font\_info} refers to
$\\{tfm\_file}\^$ or when it says $\\{get}(\\{tfm\_file})$. If such
circumstances
cause system error messages, you will have to defeat them somehow,
for example by defining \\{fget} to be `\ignorespaces \&{begin} $\\{get}(\\{tfm%
\_file})$;
 \&{if} $\\{eof}(\\{tfm\_file})$ \&{then} \\{abort}; \&{end} \unskip'.

\Y\P\D \37$\\{fget}\S\\{get}(\\{tfm\_file})$\par
\P\D \37$\\{fbyte}\S\\{tfm\_file}\^$\par
\P\D \37$\\{read\_sixteen}(\#)\S$\1\6
\&{begin} \37$\#\K\\{fbyte}$;\6
\&{if} $\#>127$ \1\&{then}\5
\\{abort};\2\6
\\{fget};\5
$\#\K\#\ast\O{400}+\\{fbyte}$;\6
\&{end}\2\par
\P\D \37$\\{store\_four\_quarters}(\#)\S$\1\6
\&{begin} \37\\{fget};\5
$\|a\K\\{fbyte}$;\5
$\\{qw}.\\{b0}\K\\{qi}(\|a)$;\5
\\{fget};\5
$\|b\K\\{fbyte}$;\5
$\\{qw}.\\{b1}\K\\{qi}(\|b)$;\5
\\{fget};\5
$\|c\K\\{fbyte}$;\5
$\\{qw}.\\{b2}\K\\{qi}(\|c)$;\5
\\{fget};\5
$\|d\K\\{fbyte}$;\5
$\\{qw}.\\{b3}\K\\{qi}(\|d)$;\5
$\#\K\\{qw}$;\6
\&{end}\2\par
\fi

\M591. \P$\X591:Read the {\.{TFM}} size fields\X\S$\6
\&{begin} \37$\\{read\_sixteen}(\\{lf})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{lh})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{bc})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{ec})$;\6
\&{if} $(\\{bc}>\\{ec}+1)\V(\\{ec}>255)$ \1\&{then}\5
\\{abort};\2\6
\&{if} $\\{bc}>255$ \1\&{then}\C{$\\{bc}=256$ and $\\{ec}=255$}\6
\&{begin} \37$\\{bc}\K1$;\5
$\\{ec}\K0$;\6
\&{end};\2\6
\\{fget};\5
$\\{read\_sixteen}(\\{nw})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{nh})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{nd})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{ni})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{nl})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{nk})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{ne})$;\5
\\{fget};\5
$\\{read\_sixteen}(\\{np})$;\6
\&{if} $\\{lf}\I6+\\{lh}+(\\{ec}-\\{bc}+1)+\\{nw}+\\{nh}+\\{nd}+\\{ni}+\\{nl}+%
\\{nk}+\\{ne}+\\{np}$ \1\&{then}\5
\\{abort};\2\6
\&{if} $(\\{nw}=0)\V(\\{nh}=0)\V(\\{nd}=0)\V(\\{ni}=0)$ \1\&{then}\5
\\{abort};\2\6
\&{end}\par
\U588.\fi

\M592. The preliminary settings of the index-offset variables \\{char\_base},
\\{width\_base}, \\{lig\_kern\_base}, \\{kern\_base}, and \\{exten\_base} will
be
corrected later by subtracting \\{min\_quarterword} from them; and we will
subtract 1 from \\{param\_base} too. It's best to forget about such anomalies
until later.

\Y\P$\4\X592:Use size fields to allocate font information\X\S$\6
$\\{lf}\K\\{lf}-6-\\{lh}$;\C{\\{lf} words should be loaded into \\{font\_info}}%
\6
\&{if} $\\{np}<7$ \1\&{then}\5
$\\{lf}\K\\{lf}+7-\\{np}$;\C{at least seven parameters will appear}\2\6
\&{if} $(\\{font\_ptr}=\\{font\_max})\V(\\{fmem\_ptr}+\\{lf}>\\{font\_mem%
\_size})$ \1\&{then}\5
\X593:Apologize for not loading the font, \&{goto} \\{done}\X;\2\6
$\|f\K\\{font\_ptr}+1$;\5
$\\{char\_base}[\|f]\K\\{fmem\_ptr}-\\{bc}$;\5
$\\{width\_base}[\|f]\K\\{char\_base}[\|f]+\\{ec}+1$;\5
$\\{height\_base}[\|f]\K\\{width\_base}[\|f]+\\{nw}$;\5
$\\{depth\_base}[\|f]\K\\{height\_base}[\|f]+\\{nh}$;\5
$\\{italic\_base}[\|f]\K\\{depth\_base}[\|f]+\\{nd}$;\5
$\\{lig\_kern\_base}[\|f]\K\\{italic\_base}[\|f]+\\{ni}$;\5
$\\{kern\_base}[\|f]\K\\{lig\_kern\_base}[\|f]+\\{nl}-\\{kern\_base\_offset}$;\5
$\\{exten\_base}[\|f]\K\\{kern\_base}[\|f]+\\{kern\_base\_offset}+\\{nk}$;\5
$\\{param\_base}[\|f]\K\\{exten\_base}[\|f]+\\{ne}$\par
\U588.\fi

\M593. \P$\X593:Apologize for not loading the font, \&{goto} \\{done}\X\S$\6
\&{begin} \37\\{start\_font\_error\_message};\5
$\\{print}(\.{"\ not\ loaded:\ Not\ enough\ room\ left"})$;\5
$\\{help4}(\.{"I\'m\ afraid\ I\ won\'t\ be\ able\ to\ make\ use\ of\ this\
font,"})$\6
$(\.{"because\ my\ memory\ for\ character-size\ data\ is\ too\ small."})$\6
$(\.{"If\ you\'re\ really\ stuck,\ ask\ a\ wizard\ to\ enlarge\ me."})$\6
$(\.{"Or\ maybe\ try\ \`I\\font<same\ font\ id>=<name\ of\ loaded\ font>%
\'."})$;\5
\\{error};\5
\&{goto} \37\\{done};\6
\&{end}\par
\U592.\fi

\M594. Only the first two words of the header are needed by \TeX82.

\Y\P$\4\X594:Read the {\.{TFM}} header\X\S$\6
\&{begin} \37\&{if} $\\{lh}<2$ \1\&{then}\5
\\{abort};\2\6
$\\{store\_four\_quarters}(\\{font\_check}[\|f])$;\5
\\{fget};\5
$\\{read\_sixteen}(\|z)$;\C{this rejects a negative design size}\6
\\{fget};\5
$\|z\K\|z\ast\O{400}+\\{fbyte}$;\5
\\{fget};\5
$\|z\K(\|z\ast\O{20})+(\\{fbyte}\mathbin{\&{div}}\O{20})$;\6
\&{if} $\|z<\\{unity}$ \1\&{then}\5
\\{abort};\2\6
\&{while} $\\{lh}>2$ \1\&{do}\6
\&{begin} \37\\{fget};\5
\\{fget};\5
\\{fget};\5
\\{fget};\5
$\\{decr}(\\{lh})$;\C{ignore the rest of the header}\6
\&{end};\2\6
$\\{font\_dsize}[\|f]\K\|z$;\6
\&{if} $\|s\I-1000$ \1\&{then}\6
\&{if} $\|s\G0$ \1\&{then}\5
$\|z\K\|s$\6
\4\&{else} $\|z\K\\{xn\_over\_d}(\|z,\39-\|s,\391000)$;\2\2\6
$\\{font\_size}[\|f]\K\|z$;\6
\&{end}\par
\U588.\fi

\M595. \P$\X595:Read character data\X\S$\6
\&{for} $\|k\K\\{fmem\_ptr}\mathrel{\&{to}}\\{width\_base}[\|f]-1$ \1\&{do}\6
\&{begin} \37$\\{store\_four\_quarters}(\\{font\_info}[\|k].\\{qqqq})$;\6
\&{if} $(\|a\G\\{nw})\V(\|b\mathbin{\&{div}}\O{20}\G\\{nh})\V(\|b\mathbin{%
\&{mod}}\O{20}\G\\{nd})\V(\|c\mathbin{\&{div}}4\G\\{ni})$ \1\&{then}\5
\\{abort};\2\6
\&{case} $\|c\mathbin{\&{mod}}4$ \1\&{of}\6
\4\\{lig\_tag}: \37\&{if} $\|d\G\\{nl}$ \1\&{then}\5
\\{abort};\2\6
\4\\{ext\_tag}: \37\&{if} $\|d\G\\{ne}$ \1\&{then}\5
\\{abort};\2\6
\4\\{list\_tag}: \37\X596:Check for charlist cycle\X;\6
\4\&{othercases} \37\\{do\_nothing}\C{\\{no\_tag}}\2\6
\&{endcases};\6
\&{end}\2\par
\U588.\fi

\M596. We want to make sure that there is no cycle of characters linked
together
by \\{list\_tag} entries, since such a cycle would get \TeX\ into an endless
loop. If such a cycle exists, the routine here detects it when processing
the largest character code in the cycle.

\Y\P\D \37$\\{check\_byte\_range}(\#)\S$\1\6
\&{begin} \37\&{if} $(\#<\\{bc})\V(\#>\\{ec})$ \1\&{then}\5
\\{abort}\ \2\6
\&{end}\2\par
\P\D \37$\\{current\_character\_being\_worked\_on}\S\|k+\\{bc}-\\{fmem\_ptr}$%
\par
\Y\P$\4\X596:Check for charlist cycle\X\S$\6
\&{begin} \37$\\{check\_byte\_range}(\|d)$;\6
\&{while} $\|d<\\{current\_character\_being\_worked\_on}$ \1\&{do}\6
\&{begin} \37$\\{qw}\K\\{char\_info}(\|f)(\|d)$;\C{N.B.: not $\\{qi}(\|d)$,
since $\\{char\_base}[\|f]$ hasn't been adjusted yet}\6
\&{if} $\\{char\_tag}(\\{qw})\I\\{list\_tag}$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
$\|d\K\\{qo}(\\{rem\_byte}(\\{qw}))$;\C{next character on the list}\6
\&{end};\2\6
\&{if} $\|d=\\{current\_character\_being\_worked\_on}$ \1\&{then}\5
\\{abort};\C{yes, there's a cycle}\2\6
\4\\{not\_found}: \37\&{end}\par
\U595.\fi

\M597. A \\{fix\_word} whose four bytes are $(a,b,c,d)$ from left to right
represents
the number
$$x=\left\{\vcenter{\halign{$#$,\hfil\qquad&if $#$\hfil\cr
b\cdot2^{-4}+c\cdot2^{-12}+d\cdot2^{-20}&a=0;\cr
-16+b\cdot2^{-4}+c\cdot2^{-12}+d\cdot2^{-20}&a=255.\cr}}\right.$$
(No other choices of \|a are allowed, since the magnitude of a number in
design-size units must be less than 16.)  We want to multiply this
quantity by the integer~\|z, which is known to be less than $2^{27}$.
If $\|z<2^{23}$, the individual multiplications $b\cdot z$,
$c\cdot z$, $d\cdot z$ cannot overflow; otherwise we will divide \|z by 2,
4, 8, or 16, to obtain a multiplier less than $2^{23}$, and we can
compensate for this later. If \|z has thereby been replaced by
$\|z^\prime=\|z/2^e$, let $\beta=2^{4-e}$; we shall compute
$$\lfloor(b+c\cdot2^{-8}+d\cdot2^{-16})\,z^\prime/\beta\rfloor$$
if $a=0$, or the same quantity minus $\alpha=2^{4+e}z^\prime$ if $a=255$.
This calculation must be done exactly, in order to guarantee portability
of \TeX\ between computers.

\Y\P\D \37$\\{store\_scaled}(\#)\S$\1\6
\&{begin} \37\\{fget};\5
$\|a\K\\{fbyte}$;\5
\\{fget};\5
$\|b\K\\{fbyte}$;\5
\\{fget};\5
$\|c\K\\{fbyte}$;\5
\\{fget};\5
$\|d\K\\{fbyte}$;\6
$\\{sw}\K(((((\|d\ast\|z)\mathbin{\&{div}}\O{400})+(\|c\ast\|z))\mathbin{%
\&{div}}\O{400})+(\|b\ast\|z))\mathbin{\&{div}}\\{beta}$;\6
\&{if} $\|a=0$ \1\&{then}\5
$\#\K\\{sw}$\ \&{else} \&{if} $\|a=255$ \1\&{then}\5
$\#\K\\{sw}-\\{alpha}$\ \&{else} \\{abort};\2\2\6
\&{end}\2\par
\Y\P\4\&{function}\1\  \37$\\{store\_scaled\_f}(\\{sq},\39\|z:\\{scaled})$: \37%
\\{scaled};\6
\4\&{var} \37$\|a,\39\|b,\39\|c,\39\|d$: \37\\{eight\_bits};\5
\\{sw}: \37\\{scaled};\5
\\{alpha}: \37\\{integer};\5
\\{beta}: \37$1\to16$;\2\6
\&{begin} \37$\\{alpha}\K16$;\6
\&{if} $\|z\G\O{1000000000}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"size\ is\ too\ large"})$;\2\6
\&{while} $\|z\G\O{40000000}$ \1\&{do}\6
\&{begin} \37$\|z\K\|z\mathbin{\&{div}}2$;\5
$\\{alpha}\K\\{alpha}+\\{alpha}$;\6
\&{end};\2\6
$\\{beta}\K256\mathbin{\&{div}}\\{alpha}$;\5
$\\{alpha}\K\\{alpha}\ast\|z$;\6
\&{if} $\\{sq}\G0$ \1\&{then}\6
\&{begin} \37$\|d\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\C{any "mod 256" not really needed, would
typecast alone be safe?}\6
$\|c\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\5
$\|b\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\5
$\|a\K\\{sq}\mathbin{\&{mod}}256$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{sq}\K(\\{sq}+1073741824)+1073741824$;\C{braces for
optimizing compiler}\6
$\|d\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\5
$\|c\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\5
$\|b\K\\{sq}\mathbin{\&{mod}}256$;\5
$\\{sq}\K\\{sq}\mathbin{\&{div}}256$;\5
$\|a\K(\\{sq}+128)\mathbin{\&{mod}}256$;\6
\&{end};\2\6
$\\{sw}\K(((((\|d\ast\|z)\mathbin{\&{div}}\O{400})+(\|c\ast\|z))\mathbin{%
\&{div}}\O{400})+(\|b\ast\|z))\mathbin{\&{div}}\\{beta}$;\6
\&{if} $\|a=0$ \1\&{then}\5
$\\{store\_scaled\_f}\K\\{sw}$\ \&{else} \&{if} $\|a=255$ \1\&{then}\5
$\\{store\_scaled\_f}\K\\{sw}-\\{alpha}$\ \&{else} $\\{pdf\_error}(\.{"store%
\_scaled\_f"},\39\.{"vf\ scaling"})$;\2\2\6
\&{end};\par
\fi

\M598. \P$\X598:Read box dimensions\X\S$\6
\&{begin} \37\X599:Replace \|z by $\|z^\prime$ and compute $\alpha,\beta$\X;\6
\&{for} $\|k\K\\{width\_base}[\|f]\mathrel{\&{to}}\\{lig\_kern\_base}[\|f]-1$ %
\1\&{do}\5
$\\{store\_scaled}(\\{font\_info}[\|k].\\{sc})$;\2\6
\&{if} $\\{font\_info}[\\{width\_base}[\|f]].\\{sc}\I0$ \1\&{then}\5
\\{abort};\C{\\{width}[0] must be zero}\2\6
\&{if} $\\{font\_info}[\\{height\_base}[\|f]].\\{sc}\I0$ \1\&{then}\5
\\{abort};\C{\\{height}[0] must be zero}\2\6
\&{if} $\\{font\_info}[\\{depth\_base}[\|f]].\\{sc}\I0$ \1\&{then}\5
\\{abort};\C{\\{depth}[0] must be zero}\2\6
\&{if} $\\{font\_info}[\\{italic\_base}[\|f]].\\{sc}\I0$ \1\&{then}\5
\\{abort};\C{\\{italic}[0] must be zero}\2\6
\&{end}\par
\U588.\fi

\M599. \P$\X599:Replace \|z by $\|z^\prime$ and compute $\alpha,\beta$\X\S$\6
\&{begin} \37$\\{alpha}\K16$;\6
\&{if} $\|z\G\O{1000000000}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"size\ is\ too\ large"})$;\2\6
\&{while} $\|z\G\O{40000000}$ \1\&{do}\6
\&{begin} \37$\|z\K\|z\mathbin{\&{div}}2$;\5
$\\{alpha}\K\\{alpha}+\\{alpha}$;\6
\&{end};\2\6
$\\{beta}\K256\mathbin{\&{div}}\\{alpha}$;\5
$\\{alpha}\K\\{alpha}\ast\|z$;\6
\&{end}\par
\U598.\fi

\M600. \P\D \37$\\{check\_existence}(\#)\S\hbox{}$\6
\&{begin} \37$\\{check\_byte\_range}(\#)$;\5
$\\{qw}\K\\{char\_info}(\|f)(\#)$;\C{N.B.: not $\\{qi}(\#)$}\6
\&{if} $\R\\{char\_exists}(\\{qw})$ \1\&{then}\5
\\{abort};\2\6
\&{end}\par
\Y\P$\4\X600:Read ligature/kern program\X\S$\6
$\\{bch\_label}\K\O{77777}$;\5
$\\{bchar}\K256$;\6
\&{if} $\\{nl}>0$ \1\&{then}\6
\&{begin} \37\&{for} $\|k\K\\{lig\_kern\_base}[\|f]\mathrel{\&{to}}\\{kern%
\_base}[\|f]+\\{kern\_base\_offset}-1$ \1\&{do}\6
\&{begin} \37$\\{store\_four\_quarters}(\\{font\_info}[\|k].\\{qqqq})$;\6
\&{if} $\|a>128$ \1\&{then}\6
\&{begin} \37\&{if} $256\ast\|c+\|d\G\\{nl}$ \1\&{then}\5
\\{abort};\2\6
\&{if} $\|a=255$ \1\&{then}\6
\&{if} $\|k=\\{lig\_kern\_base}[\|f]$ \1\&{then}\5
$\\{bchar}\K\|b$;\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\|b\I\\{bchar}$ \1\&{then}\5
$\\{check\_existence}(\|b)$;\2\6
\&{if} $\|c<128$ \1\&{then}\5
$\\{check\_existence}(\|d)$\C{check ligature}\6
\4\&{else} \&{if} $256\ast(\|c-128)+\|d\G\\{nk}$ \1\&{then}\5
\\{abort};\C{check kern}\2\2\6
\&{if} $\|a<128$ \1\&{then}\6
\&{if} $\|k-\\{lig\_kern\_base}[\|f]+\|a+1\G\\{nl}$ \1\&{then}\5
\\{abort};\2\2\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\|a=255$ \1\&{then}\5
$\\{bch\_label}\K256\ast\|c+\|d$;\2\6
\&{end};\2\6
\&{for} $\|k\K\\{kern\_base}[\|f]+\\{kern\_base\_offset}\mathrel{\&{to}}%
\\{exten\_base}[\|f]-1$ \1\&{do}\5
$\\{store\_scaled}(\\{font\_info}[\|k].\\{sc})$;\2\par
\U588.\fi

\M601. \P$\X601:Read extensible character recipes\X\S$\6
\&{for} $\|k\K\\{exten\_base}[\|f]\mathrel{\&{to}}\\{param\_base}[\|f]-1$ \1%
\&{do}\6
\&{begin} \37$\\{store\_four\_quarters}(\\{font\_info}[\|k].\\{qqqq})$;\6
\&{if} $\|a\I0$ \1\&{then}\5
$\\{check\_existence}(\|a)$;\2\6
\&{if} $\|b\I0$ \1\&{then}\5
$\\{check\_existence}(\|b)$;\2\6
\&{if} $\|c\I0$ \1\&{then}\5
$\\{check\_existence}(\|c)$;\2\6
$\\{check\_existence}(\|d)$;\6
\&{end}\2\par
\U588.\fi

\M602. We check to see that the \.{TFM} file doesn't end prematurely; but
no error message is given for files having more than \\{lf} words.

\Y\P$\4\X602:Read font parameters\X\S$\6
\&{begin} \37\&{for} $\|k\K1\mathrel{\&{to}}\\{np}$ \1\&{do}\6
\&{if} $\|k=1$ \1\&{then}\C{the \\{slant} parameter is a pure number}\6
\&{begin} \37\\{fget};\5
$\\{sw}\K\\{fbyte}$;\6
\&{if} $\\{sw}>127$ \1\&{then}\5
$\\{sw}\K\\{sw}-256$;\2\6
\\{fget};\5
$\\{sw}\K\\{sw}\ast\O{400}+\\{fbyte}$;\5
\\{fget};\5
$\\{sw}\K\\{sw}\ast\O{400}+\\{fbyte}$;\5
\\{fget};\5
$\\{font\_info}[\\{param\_base}[\|f]].\\{sc}\K(\\{sw}\ast\O{20})+(\\{fbyte}%
\mathbin{\&{div}}\O{20})$;\6
\&{end}\6
\4\&{else} $\\{store\_scaled}(\\{font\_info}[\\{param\_base}[\|f]+\|k-1].%
\\{sc})$;\2\2\6
\&{if} $\\{eof}(\\{tfm\_file})$ \1\&{then}\5
\\{abort};\2\6
\&{for} $\|k\K\\{np}+1\mathrel{\&{to}}7$ \1\&{do}\5
$\\{font\_info}[\\{param\_base}[\|f]+\|k-1].\\{sc}\K0$;\2\6
\&{end}\par
\U588.\fi

\M603. Now to wrap it up, we have checked all the necessary things about the %
\.{TFM}
file, and all we need to do is put the finishing touches on the data for
the new font.

\Y\P\D \37$\\{adjust}(\#)\S\#[\|f]\K\\{qo}(\#[\|f])$\C{correct for the excess %
\\{min\_quarterword} that was added}\par
\Y\P$\4\X603:Make final adjustments and \&{goto} \\{done}\X\S$\6
\&{if} $\\{np}\G7$ \1\&{then}\5
$\\{font\_params}[\|f]\K\\{np}$\ \&{else} $\\{font\_params}[\|f]\K7$;\2\6
$\\{hyphen\_char}[\|f]\K\\{default\_hyphen\_char}$;\5
$\\{skew\_char}[\|f]\K\\{default\_skew\_char}$;\6
\&{if} $\\{bch\_label}<\\{nl}$ \1\&{then}\5
$\\{bchar\_label}[\|f]\K\\{bch\_label}+\\{lig\_kern\_base}[\|f]$\6
\4\&{else} $\\{bchar\_label}[\|f]\K\\{non\_address}$;\2\6
$\\{font\_bchar}[\|f]\K\\{qi}(\\{bchar})$;\5
$\\{font\_false\_bchar}[\|f]\K\\{qi}(\\{bchar})$;\6
\&{if} $\\{bchar}\L\\{ec}$ \1\&{then}\6
\&{if} $\\{bchar}\G\\{bc}$ \1\&{then}\6
\&{begin} \37$\\{qw}\K\\{char\_info}(\|f)(\\{bchar})$;\C{N.B.: not $\\{qi}(%
\\{bchar})$}\6
\&{if} $\\{char\_exists}(\\{qw})$ \1\&{then}\5
$\\{font\_false\_bchar}[\|f]\K\\{non\_char}$;\2\6
\&{end};\2\2\6
$\\{font\_name}[\|f]\K\\{nom}$;\5
$\\{font\_area}[\|f]\K\\{aire}$;\5
$\\{font\_bc}[\|f]\K\\{bc}$;\5
$\\{font\_ec}[\|f]\K\\{ec}$;\5
$\\{font\_glue}[\|f]\K\\{null}$;\5
$\\{adjust}(\\{char\_base})$;\5
$\\{adjust}(\\{width\_base})$;\5
$\\{adjust}(\\{lig\_kern\_base})$;\5
$\\{adjust}(\\{kern\_base})$;\5
$\\{adjust}(\\{exten\_base})$;\5
$\\{decr}(\\{param\_base}[\|f])$;\5
$\\{fmem\_ptr}\K\\{fmem\_ptr}+\\{lf}$;\5
$\\{font\_ptr}\K\|f$;\5
$\|g\K\|f$;\5
\&{goto} \37\\{done}\par
\U588.\fi

\M604. Before we forget about the format of these tables, let's deal with two
of \TeX's basic scanning routines related to font information.

\Y\P$\4\X604:Declare procedures that scan font-related stuff\X\S$\6
\4\&{function}\1\  \37$\\{test\_no\_ligatures}(\|f:\\{internal\_font%
\_number})$: \37\\{integer};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|c: \37\\{integer};\2\6
\&{begin} \37$\\{test\_no\_ligatures}\K1$;\6
\&{for} $\|c\K\\{font\_bc}[\|f]\mathrel{\&{to}}\\{font\_ec}[\|f]$ \1\&{do}\6
\&{if} $\\{char\_exists}(\\{orig\_char\_info}(\|f)(\|c))$ \1\&{then}\6
\&{if} $\\{odd}(\\{char\_tag}(\\{orig\_char\_info}(\|f)(\|c)))$ \1\&{then}\6
\&{begin} \37$\\{test\_no\_ligatures}\K0$;\5
\&{return};\6
\&{end};\2\2\2\6
\4\\{exit}: \37\&{end};\6
\4\&{function}\1\  \37$\\{get\_tag\_code}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{integer};\6
\4\&{var} \37\|i: \37\\{small\_number};\2\6
\&{begin} \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\6
\&{begin} \37$\|i\K\\{char\_tag}(\\{char\_info}(\|f)(\|c))$;\6
\&{if} $\|i=\\{lig\_tag}$ \1\&{then}\5
$\\{get\_tag\_code}\K1$\6
\4\&{else} \&{if} $\|i=\\{list\_tag}$ \1\&{then}\5
$\\{get\_tag\_code}\K2$\6
\4\&{else} \&{if} $\|i=\\{ext\_tag}$ \1\&{then}\5
$\\{get\_tag\_code}\K4$\6
\4\&{else} $\\{get\_tag\_code}\K0$;\2\2\2\6
\&{end}\6
\4\&{else} $\\{get\_tag\_code}\K-1$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{scan\_font\_ident};\6
\4\&{var} \37\|f: \37\\{internal\_font\_number};\5
\|m: \37\\{halfword};\2\6
\&{begin} \37\X432:Get the next non-blank non-call token\X;\6
\&{if} $(\\{cur\_cmd}=\\{def\_font})\V(\\{cur\_cmd}=\\{letterspace\_font})\V(%
\\{cur\_cmd}=\\{pdf\_copy\_font})$ \1\&{then}\5
$\|f\K\\{cur\_font}$\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{set\_font}$ \1\&{then}\5
$\|f\K\\{cur\_chr}$\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{def\_family}$ \1\&{then}\6
\&{begin} \37$\|m\K\\{cur\_chr}$;\5
\\{scan\_four\_bit\_int};\5
$\|f\K\\{equiv}(\|m+\\{cur\_val})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Missing\ font\ identifier"})$;\5
$\\{help2}(\.{"I\ was\ looking\ for\ a\ control\ sequence\ whose"})$\6
$(\.{"current\ meaning\ has\ been\ defined\ by\ \\font."})$;\5
\\{back\_error};\5
$\|f\K\\{null\_font}$;\6
\&{end};\2\2\2\6
$\\{cur\_val}\K\|f$;\6
\&{end};\par
\A605.
\U435.\fi

\M605. The following routine is used to implement `\.{\\fontdimen} \|n \|f'.
The boolean parameter \\{writing} is set \\{true} if the calling program
intends to change the parameter value.

\Y\P$\4\X604:Declare procedures that scan font-related stuff\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{find\_font\_dimen}(\\{writing}:\\{boolean})$;\C{sets
\\{cur\_val} to \\{font\_info} location}\6
\4\&{var} \37\|f: \37\\{internal\_font\_number};\5
\|n: \37\\{integer};\C{the parameter number}\2\6
\&{begin} \37\\{scan\_int};\5
$\|n\K\\{cur\_val}$;\5
\\{scan\_font\_ident};\5
$\|f\K\\{cur\_val}$;\6
\&{if} $\|n\L0$ \1\&{then}\5
$\\{cur\_val}\K\\{fmem\_ptr}$\6
\4\&{else} \&{begin} \37\&{if} $\\{writing}\W(\|n\L\\{space\_shrink\_code})\W%
\30(\|n\G\\{space\_code})\W(\\{font\_glue}[\|f]\I\\{null})$ \1\&{then}\6
\&{begin} \37$\\{delete\_glue\_ref}(\\{font\_glue}[\|f])$;\5
$\\{font\_glue}[\|f]\K\\{null}$;\6
\&{end};\2\6
\&{if} $\|n>\\{font\_params}[\|f]$ \1\&{then}\6
\&{if} $\|f<\\{font\_ptr}$ \1\&{then}\5
$\\{cur\_val}\K\\{fmem\_ptr}$\6
\4\&{else} \X607:Increase the number of parameters in the last font\X\2\6
\4\&{else} $\\{cur\_val}\K\|n+\\{param\_base}[\|f]$;\2\6
\&{end};\2\6
\X606:Issue an error message if $\\{cur\_val}=\\{fmem\_ptr}$\X;\6
\&{end};\par
\fi

\M606. \P$\X606:Issue an error message if $\\{cur\_val}=\\{fmem\_ptr}$\X\S$\6
\&{if} $\\{cur\_val}=\\{fmem\_ptr}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Font\ "})$;\5
$\\{print\_esc}(\\{font\_id\_text}(\|f))$;\5
$\\{print}(\.{"\ has\ only\ "})$;\5
$\\{print\_int}(\\{font\_params}[\|f])$;\5
$\\{print}(\.{"\ fontdimen\ parameters"})$;\5
$\\{help2}(\.{"To\ increase\ the\ number\ of\ font\ parameters,\ you\ must"})$\6
$(\.{"use\ \\fontdimen\ immediately\ after\ the\ \\font\ is\ loaded."})$;\5
\\{error};\6
\&{end}\2\par
\U605.\fi

\M607. \P$\X607:Increase the number of parameters in the last font\X\S$\6
\&{begin} \37\1\&{repeat} \37\&{if} $\\{fmem\_ptr}=\\{font\_mem\_size}$ \1%
\&{then}\5
$\\{overflow}(\.{"font\ memory"},\39\\{font\_mem\_size})$;\2\6
$\\{font\_info}[\\{fmem\_ptr}].\\{sc}\K0$;\5
$\\{incr}(\\{fmem\_ptr})$;\5
$\\{incr}(\\{font\_params}[\|f])$;\6
\4\&{until}\5
$\|n=\\{font\_params}[\|f]$;\2\6
$\\{cur\_val}\K\\{fmem\_ptr}-1$;\C{this equals $\\{param\_base}[\|f]+\\{font%
\_params}[\|f]$}\6
\&{end}\par
\U605.\fi

\M608. When \TeX\ wants to typeset a character that doesn't exist, the
character node is not created; thus the output routine can assume
that characters exist when it sees them. The following procedure
prints a warning message unless the user has suppressed it.

\Y\P\4\&{procedure}\1\  \37$\\{char\_warning}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits})$;\6
\4\&{var} \37\\{old\_setting}: \37\\{integer};\C{saved value of \\{tracing%
\_online}}\2\6
\&{begin} \37\&{if} $\\{tracing\_lost\_chars}>0$ \1\&{then}\6
\&{begin} \37$\\{old\_setting}\K\\{tracing\_online}$;\6
\&{if} $\\{eTeX\_ex}\W(\\{tracing\_lost\_chars}>1)$ \1\&{then}\5
$\\{tracing\_online}\K1$;\2\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"Missing\ character:\ There\ is\ no\ "})$;\5
$\\{print\_ASCII}(\|c)$;\5
$\\{print}(\.{"\ in\ font\ "})$;\5
$\\{slow\_print}(\\{font\_name}[\|f])$;\5
$\\{print\_char}(\.{"!"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\5
$\\{tracing\_online}\K\\{old\_setting}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M609. Here is a function that returns a pointer to a character node for a
given character in a given font. If that character doesn't exist,
\\{null} is returned instead.

\Y\P\4\&{function}\1\  \37$\\{new\_character}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits})$: \37\\{pointer};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{newly allocated node}\2\6
\&{begin} \37\&{if} $\\{font\_bc}[\|f]\L\|c$ \1\&{then}\6
\&{if} $\\{font\_ec}[\|f]\G\|c$ \1\&{then}\6
\&{if} $\\{char\_exists}(\\{char\_info}(\|f)(\\{qi}(\|c)))$ \1\&{then}\6
\&{begin} \37$\|p\K\\{get\_avail}$;\5
$\\{font}(\|p)\K\|f$;\5
$\\{character}(\|p)\K\\{qi}(\|c)$;\5
$\\{new\_character}\K\|p$;\5
\&{return};\6
\&{end};\2\2\2\6
$\\{char\_warning}(\|f,\39\|c)$;\5
$\\{new\_character}\K\\{null}$;\6
\4\\{exit}: \37\&{end};\par
\fi

\N610.  \[31] Device-independent file format.
The most important output produced by a run of \TeX\ is the ``device
independent'' (\.{DVI}) file that specifies where characters and rules
are to appear on printed pages. The form of these files was designed by
David R. Fuchs in 1979. Almost any reasonable typesetting device can be
driven by a program that takes \.{DVI} files as input, and dozens of such
\.{DVI}-to-whatever programs have been written. Thus, it is possible to
print the output of \TeX\ on many different kinds of equipment, using \TeX\
as a device-independent ``front end.''

A \.{DVI} file is a stream of 8-bit bytes, which may be regarded as a
series of commands in a machine-like language. The first byte of each command
is the operation code, and this code is followed by zero or more bytes
that provide parameters to the command. The parameters themselves may consist
of several consecutive bytes; for example, the `\\{set\_rule}' command has two
parameters, each of which is four bytes long. Parameters are usually
regarded as nonnegative integers; but four-byte-long parameters,
and shorter parameters that denote distances, can be
either positive or negative. Such parameters are given in two's complement
notation. For example, a two-byte-long distance parameter has a value between
$-2^{15}$ and $2^{15}-1$. As in \.{TFM} files, numbers that occupy
more than one byte position appear in BigEndian order.

A \.{DVI} file consists of a ``preamble,'' followed by a sequence of one
or more ``pages,'' followed by a ``postamble.'' The preamble is simply a
\\{pre} command, with its parameters that define the dimensions used in the
file; this must come first.  Each ``page'' consists of a \\{bop} command,
followed by any number of other commands that tell where characters are to
be placed on a physical page, followed by an \\{eop} command. The pages
appear in the order that \TeX\ generated them. If we ignore \\{nop} commands
and \\{fnt\_def} commands (which are allowed between any two commands in
the file), each \\{eop} command is immediately followed by a \\{bop} command,
or by a \\{post} command; in the latter case, there are no more pages in the
file, and the remaining bytes form the postamble.  Further details about
the postamble will be explained later.

Some parameters in \.{DVI} commands are ``pointers.'' These are four-byte
quantities that give the location number of some other byte in the file;
the first byte is number~0, then comes number~1, and so on. For example,
one of the parameters of a \\{bop} command points to the previous \\{bop};
this makes it feasible to read the pages in backwards order, in case the
results are being directed to a device that stacks its output face up.
Suppose the preamble of a \.{DVI} file occupies bytes 0 to 99. Now if the
first page occupies bytes 100 to 999, say, and if the second
page occupies bytes 1000 to 1999, then the \\{bop} that starts in byte 1000
points to 100 and the \\{bop} that starts in byte 2000 points to 1000. (The
very first \\{bop}, i.e., the one starting in byte 100, has a pointer of~$-1$.)

\fi

\M611. The \.{DVI} format is intended to be both compact and easily interpreted
by a machine. Compactness is achieved by making most of the information
implicit instead of explicit. When a \.{DVI}-reading program reads the
commands for a page, it keeps track of several quantities: (a)~The current
font \|f is an integer; this value is changed only
by \\{fnt} and \\{fnt\_num} commands. (b)~The current position on the page
is given by two numbers called the horizontal and vertical coordinates,
\|h and \|v. Both coordinates are zero at the upper left corner of the page;
moving to the right corresponds to increasing the horizontal coordinate, and
moving down corresponds to increasing the vertical coordinate. Thus, the
coordinates are essentially Cartesian, except that vertical directions are
flipped; the Cartesian version of $(\|h,\|v)$ would be $(\|h,-\|v)$.  (c)~The
current spacing amounts are given by four numbers \|w, \|x, \|y, and \|z,
where \|w and~\|x are used for horizontal spacing and where \|y and~\|z
are used for vertical spacing. (d)~There is a stack containing
$(\|h,\|v,\|w,\|x,\|y,\|z)$ values; the \.{DVI} commands \\{push} and \\{pop}
are used to
change the current level of operation. Note that the current font~\|f is
not pushed and popped; the stack contains only information about
positioning.

The values of \|h, \|v, \|w, \|x, \|y, and \|z are signed integers having up
to 32 bits, including the sign. Since they represent physical distances,
there is a small unit of measurement such that increasing \|h by~1 means
moving a certain tiny distance to the right. The actual unit of
measurement is variable, as explained below; \TeX\ sets things up so that
its \.{DVI} output is in sp units, i.e., scaled points, in agreement with
all the \\{scaled} dimensions in \TeX's data structures.

\fi

\M612. Here is a list of all the commands that may appear in a \.{DVI} file.
Each
command is specified by its symbolic name (e.g., \\{bop}), its opcode byte
(e.g., 139), and its parameters (if any). The parameters are followed
by a bracketed number telling how many bytes they occupy; for example,
`$\|p[4]$' means that parameter \|p is four bytes long.

\yskip\hang\\{set\_char\_0} 0. Typeset character number~0 from font~\|f
such that the reference point of the character is at $(\|h,\|v)$. Then
increase \|h by the width of that character. Note that a character may
have zero or negative width, so one cannot be sure that \|h will advance
after this command; but \|h usually does increase.

\yskip\hang\\{set\_char\_1} through \\{set\_char\_127} (opcodes 1 to 127).
Do the operations of \\{set\_char\_0}; but use the character whose number
matches the opcode, instead of character~0.

\yskip\hang\\{set1} 128 $\|c[1]$. Same as \\{set\_char\_0}, except that
character
number~\|c is typeset. \TeX82 uses this command for characters in the
range $128\L\|c<256$.

\yskip\hang\\{set2} 129 $\|c[2]$. Same as \\{set1}, except that \|c~is two
bytes long, so it is in the range $0\L\|c<65536$. \TeX82 never uses this
command, but it should come in handy for extensions of \TeX\ that deal
with oriental languages.

\yskip\hang\\{set3} 130 $\|c[3]$. Same as \\{set1}, except that \|c~is three
bytes long, so it can be as large as $2^{24}-1$. Not even the Chinese
language has this many characters, but this command might prove useful
in some yet unforeseen extension.

\yskip\hang\\{set4} 131 $\|c[4]$. Same as \\{set1}, except that \|c~is four
bytes long. Imagine that.

\yskip\hang\\{set\_rule} 132 $\|a[4]$ $\|b[4]$. Typeset a solid black rectangle
of height~\|a and width~\|b, with its bottom left corner at $(\|h,\|v)$. Then
set $\|h\K\|h+\|b$. If either $\|a\L0$ or $\|b\L0$, nothing should be typeset.
Note
that if $\|b<0$, the value of \|h will decrease even though nothing else
happens.
See below for details about how to typeset rules so that consistency with
\MF\ is guaranteed.

\yskip\hang\\{put1} 133 $\|c[1]$. Typeset character number~\|c from font~\|f
such that the reference point of the character is at $(\|h,\|v)$. (The `put'
commands are exactly like the `set' commands, except that they simply put out a
character or a rule without moving the reference point afterwards.)

\yskip\hang\\{put2} 134 $\|c[2]$. Same as \\{set2}, except that \|h is not
changed.

\yskip\hang\\{put3} 135 $\|c[3]$. Same as \\{set3}, except that \|h is not
changed.

\yskip\hang\\{put4} 136 $\|c[4]$. Same as \\{set4}, except that \|h is not
changed.

\yskip\hang\\{put\_rule} 137 $\|a[4]$ $\|b[4]$. Same as \\{set\_rule}, except
that
\|h is not changed.

\yskip\hang\\{nop} 138. No operation, do nothing. Any number of \\{nop}'s
may occur between \.{DVI} commands, but a \\{nop} cannot be inserted between
a command and its parameters or between two parameters.

\yskip\hang\\{bop} 139 $c_0[4]$ $c_1[4]$ $\ldots$ $c_9[4]$ $p[4]$. Beginning
of a page: Set $(\|h,\|v,\|w,\|x,\|y,\|z)\K(0,0,0,0,0,0)$ and set the stack
empty. Set
the current font \|f to an undefined value.  The ten $c_i$ parameters hold
the values of \.{\\count0} $\ldots$ \.{\\count9} in \TeX\ at the time
\.{\\shipout} was invoked for this page; they can be used to identify
pages, if a user wants to print only part of a \.{DVI} file. The parameter
\|p points to the previous \\{bop} in the file; the first
\\{bop} has $p=-1$.

\yskip\hang\\{eop} 140.  End of page: Print what you have read since the
previous \\{bop}. At this point the stack should be empty. (The \.{DVI}-reading
programs that drive most output devices will have kept a buffer of the
material that appears on the page that has just ended. This material is
largely, but not entirely, in order by \|v coordinate and (for fixed \|v) by
\|h~coordinate; so it usually needs to be sorted into some order that is
appropriate for the device in question.)

\yskip\hang\\{push} 141. Push the current values of $(\|h,\|v,\|w,\|x,\|y,\|z)$
onto the
top of the stack; do not change any of these values. Note that \|f is
not pushed.

\yskip\hang\\{pop} 142. Pop the top six values off of the stack and assign
them respectively to $(\|h,\|v,\|w,\|x,\|y,\|z)$. The number of pops should
never
exceed the number of pushes, since it would be highly embarrassing if the
stack were empty at the time of a \\{pop} command.

\yskip\hang\\{right1} 143 $\|b[1]$. Set $\|h\K\|h+\|b$, i.e., move right \|b
units.
The parameter is a signed number in two's complement notation, $-128\L\|b<128$;
if $\|b<0$, the reference point moves left.

\yskip\hang\\{right2} 144 $\|b[2]$. Same as \\{right1}, except that \|b is a
two-byte quantity in the range $-32768\L\|b<32768$.

\yskip\hang\\{right3} 145 $\|b[3]$. Same as \\{right1}, except that \|b is a
three-byte quantity in the range $\hbox{$-2^{23}$}\L\|b<\hbox{$2^{23}$}$.

\yskip\hang\\{right4} 146 $\|b[4]$. Same as \\{right1}, except that \|b is a
four-byte quantity in the range $\hbox{$-2^{31}$}\L\|b<\hbox{$2^{31}$}$.

\yskip\hang\\{w0} 147. Set $\|h\K\|h+\|w$; i.e., move right \|w units. With
luck,
this parameterless command will usually suffice, because the same kind of
motion
will occur several times in succession; the following commands explain how
\|w gets particular values.

\yskip\hang\\{w1} 148 $\|b[1]$. Set $\|w\K\|b$ and $\|h\K\|h+\|b$. The value of
\|b is a
signed quantity in two's complement notation, $-128\L\|b<128$. This command
changes the current \|w~spacing and moves right by \|b.

\yskip\hang\\{w2} 149 $\|b[2]$. Same as \\{w1}, but \|b is two bytes long,
$-32768\L\|b<32768$.

\yskip\hang\\{w3} 150 $\|b[3]$. Same as \\{w1}, but \|b is three bytes long,
$\hbox{$-2^{23}$}\L\|b<\hbox{$2^{23}$}$.

\yskip\hang\\{w4} 151 $\|b[4]$. Same as \\{w1}, but \|b is four bytes long,
$\hbox{$-2^{31}$}\L\|b<\hbox{$2^{31}$}$.

\yskip\hang\\{x0} 152. Set $\|h\K\|h+\|x$; i.e., move right \|x units. The `%
\|x'
commands are like the `\|w' commands except that they involve \|x instead
of \|w.

\yskip\hang\\{x1} 153 $\|b[1]$. Set $\|x\K\|b$ and $\|h\K\|h+\|b$. The value of
\|b is a
signed quantity in two's complement notation, $-128\L\|b<128$. This command
changes the current \|x~spacing and moves right by \|b.

\yskip\hang\\{x2} 154 $\|b[2]$. Same as \\{x1}, but \|b is two bytes long,
$-32768\L\|b<32768$.

\yskip\hang\\{x3} 155 $\|b[3]$. Same as \\{x1}, but \|b is three bytes long,
$\hbox{$-2^{23}$}\L\|b<\hbox{$2^{23}$}$.

\yskip\hang\\{x4} 156 $\|b[4]$. Same as \\{x1}, but \|b is four bytes long,
$\hbox{$-2^{31}$}\L\|b<\hbox{$2^{31}$}$.

\yskip\hang\\{down1} 157 $\|a[1]$. Set $\|v\K\|v+\|a$, i.e., move down \|a
units.
The parameter is a signed number in two's complement notation, $-128\L\|a<128$;
if $\|a<0$, the reference point moves up.

\yskip\hang\\{down2} 158 $\|a[2]$. Same as \\{down1}, except that \|a is a
two-byte quantity in the range $-32768\L\|a<32768$.

\yskip\hang\\{down3} 159 $\|a[3]$. Same as \\{down1}, except that \|a is a
three-byte quantity in the range $\hbox{$-2^{23}$}\L\|a<\hbox{$2^{23}$}$.

\yskip\hang\\{down4} 160 $\|a[4]$. Same as \\{down1}, except that \|a is a
four-byte quantity in the range $\hbox{$-2^{31}$}\L\|a<\hbox{$2^{31}$}$.

\yskip\hang\\{y0} 161. Set $\|v\K\|v+\|y$; i.e., move down \|y units. With
luck,
this parameterless command will usually suffice, because the same kind of
motion
will occur several times in succession; the following commands explain how
\|y gets particular values.

\yskip\hang\\{y1} 162 $\|a[1]$. Set $\|y\K\|a$ and $\|v\K\|v+\|a$. The value of
\|a is a
signed quantity in two's complement notation, $-128\L\|a<128$. This command
changes the current \|y~spacing and moves down by \|a.

\yskip\hang\\{y2} 163 $\|a[2]$. Same as \\{y1}, but \|a is two bytes long,
$-32768\L\|a<32768$.

\yskip\hang\\{y3} 164 $\|a[3]$. Same as \\{y1}, but \|a is three bytes long,
$\hbox{$-2^{23}$}\L\|a<\hbox{$2^{23}$}$.

\yskip\hang\\{y4} 165 $\|a[4]$. Same as \\{y1}, but \|a is four bytes long,
$\hbox{$-2^{31}$}\L\|a<\hbox{$2^{31}$}$.

\yskip\hang\\{z0} 166. Set $\|v\K\|v+\|z$; i.e., move down \|z units. The `\|z'
commands
are like the `\|y' commands except that they involve \|z instead of \|y.

\yskip\hang\\{z1} 167 $\|a[1]$. Set $\|z\K\|a$ and $\|v\K\|v+\|a$. The value of
\|a is a
signed quantity in two's complement notation, $-128\L\|a<128$. This command
changes the current \|z~spacing and moves down by \|a.

\yskip\hang\\{z2} 168 $\|a[2]$. Same as \\{z1}, but \|a is two bytes long,
$-32768\L\|a<32768$.

\yskip\hang\\{z3} 169 $\|a[3]$. Same as \\{z1}, but \|a is three bytes long,
$\hbox{$-2^{23}$}\L\|a<\hbox{$2^{23}$}$.

\yskip\hang\\{z4} 170 $\|a[4]$. Same as \\{z1}, but \|a is four bytes long,
$\hbox{$-2^{31}$}\L\|a<\hbox{$2^{31}$}$.

\yskip\hang\\{fnt\_num\_0} 171. Set $\|f\K0$. Font 0 must previously have been
defined by a \\{fnt\_def} instruction, as explained below.

\yskip\hang\\{fnt\_num\_1} through \\{fnt\_num\_63} (opcodes 172 to 234). Set
$\|f\K1$, \dots, \hbox{$\|f\K63$}, respectively.

\yskip\hang\\{fnt1} 235 $\|k[1]$. Set $\|f\K\|k$. \TeX82 uses this command for
font
numbers in the range $64\L\|k<256$.

\yskip\hang\\{fnt2} 236 $\|k[2]$. Same as \\{fnt1}, except that \|k~is two
bytes long, so it is in the range $0\L\|k<65536$. \TeX82 never generates this
command, but large font numbers may prove useful for specifications of
color or texture, or they may be used for special fonts that have fixed
numbers in some external coding scheme.

\yskip\hang\\{fnt3} 237 $\|k[3]$. Same as \\{fnt1}, except that \|k~is three
bytes long, so it can be as large as $2^{24}-1$.

\yskip\hang\\{fnt4} 238 $\|k[4]$. Same as \\{fnt1}, except that \|k~is four
bytes long; this is for the really big font numbers (and for the negative
ones).

\yskip\hang\\{xxx1} 239 $\|k[1]$ $\|x[\|k]$. This command is undefined in
general; it functions as a $(k+2)$-byte \\{nop} unless special \.{DVI}-reading
programs are being used. \TeX82 generates \\{xxx1} when a short enough
\.{\\special} appears, setting \|k to the number of bytes being sent. It
is recommended that \|x be a string having the form of a keyword followed
by possible parameters relevant to that keyword.

\yskip\hang\\{xxx2} 240 $\|k[2]$ $\|x[\|k]$. Like \\{xxx1}, but $0\L\|k<65536$.

\yskip\hang\\{xxx3} 241 $\|k[3]$ $\|x[\|k]$. Like \\{xxx1}, but $0\L\|k<%
\hbox{$2^{24}$}$.

\yskip\hang\\{xxx4} 242 $\|k[4]$ $\|x[\|k]$. Like \\{xxx1}, but \|k can be
ridiculously
large. \TeX82 uses \\{xxx4} when sending a string of length 256 or more.

\yskip\hang\\{fnt\_def1} 243 $\|k[1]$ $\|c[4]$ $\|s[4]$ $\|d[4]$ $\|a[1]$ $%
\|l[1]$ $\|n[\|a+\|l]$.
Define font \|k, where $0\L\|k<256$; font definitions will be explained
shortly.

\yskip\hang\\{fnt\_def2} 244 $\|k[2]$ $\|c[4]$ $\|s[4]$ $\|d[4]$ $\|a[1]$ $%
\|l[1]$ $\|n[\|a+\|l]$.
Define font \|k, where $0\L\|k<65536$.

\yskip\hang\\{fnt\_def3} 245 $\|k[3]$ $\|c[4]$ $\|s[4]$ $\|d[4]$ $\|a[1]$ $%
\|l[1]$ $\|n[\|a+\|l]$.
Define font \|k, where $0\L\|k<\hbox{$2^{24}$}$.

\yskip\hang\\{fnt\_def4} 246 $\|k[4]$ $\|c[4]$ $\|s[4]$ $\|d[4]$ $\|a[1]$ $%
\|l[1]$ $\|n[\|a+\|l]$.
Define font \|k, where $\hbox{$-2^{31}$}\L\|k<\hbox{$2^{31}$}$.

\yskip\hang\\{pre} 247 $\|i[1]$ $\\{num}[4]$ $\\{den}[4]$ $\\{mag}[4]$ $\|k[1]$
$\|x[\|k]$.
Beginning of the preamble; this must come at the very beginning of the
file. Parameters \|i, \\{num}, \\{den}, \\{mag}, \|k, and \|x are explained
below.

\yskip\hang\\{post} 248. Beginning of the postamble, see below.

\yskip\hang\\{post\_post} 249. Ending of the postamble, see below.

\yskip\noindent Commands 250--255 are undefined at the present time.

\fi

\M613. \P\D \37$\\{set\_char\_0}=0$\C{typeset character 0 and move right}\par
\P\D \37$\\{set1}=128$\C{typeset a character and move right}\par
\P\D \37$\\{set\_rule}=132$\C{typeset a rule and move right}\par
\P\D \37$\\{put\_rule}=137$\C{typeset a rule}\par
\P\D \37$\\{nop}=138$\C{no operation}\par
\P\D \37$\\{bop}=139$\C{beginning of page}\par
\P\D \37$\\{eop}=140$\C{ending of page}\par
\P\D \37$\\{push}=141$\C{save the current positions}\par
\P\D \37$\\{pop}=142$\C{restore previous positions}\par
\P\D \37$\\{right1}=143$\C{move right}\par
\P\D \37$\\{w0}=147$\C{move right by \|w}\par
\P\D \37$\\{w1}=148$\C{move right and set \|w}\par
\P\D \37$\\{x0}=152$\C{move right by \|x}\par
\P\D \37$\\{x1}=153$\C{move right and set \|x}\par
\P\D \37$\\{down1}=157$\C{move down}\par
\P\D \37$\\{y0}=161$\C{move down by \|y}\par
\P\D \37$\\{y1}=162$\C{move down and set \|y}\par
\P\D \37$\\{z0}=166$\C{move down by \|z}\par
\P\D \37$\\{z1}=167$\C{move down and set \|z}\par
\P\D \37$\\{fnt\_num\_0}=171$\C{set current font to 0}\par
\P\D \37$\\{fnt1}=235$\C{set current font}\par
\P\D \37$\\{xxx1}=239$\C{extension to \.{DVI} primitives}\par
\P\D \37$\\{xxx4}=242$\C{potentially long extension to \.{DVI} primitives}\par
\P\D \37$\\{fnt\_def1}=243$\C{define the meaning of a font number}\par
\P\D \37$\\{pre}=247$\C{preamble}\par
\P\D \37$\\{post}=248$\C{postamble beginning}\par
\P\D \37$\\{post\_post}=249$\C{postamble ending}\par
\fi

\M614. The preamble contains basic information about the file as a whole. As
stated above, there are six parameters:
$$\hbox{$\|i[1]$ $\\{num}[4]$ $\\{den}[4]$ $\\{mag}[4]$ $\|k[1]$ $\|x[\|k]$.}$$
The \|i byte identifies \.{DVI} format; currently this byte is always set
to~2. (The value $\|i=3$ is currently used for an extended format that
allows a mixture of right-to-left and left-to-right typesetting.
Some day we will set $\|i=4$, when \.{DVI} format makes another
incompatible change---perhaps in the year 2048.)

The next two parameters, \\{num} and \\{den}, are positive integers that define
the units of measurement; they are the numerator and denominator of a
fraction by which all dimensions in the \.{DVI} file could be multiplied
in order to get lengths in units of $10^{-7}$ meters. Since $\rm 7227{pt} =
254{cm}$, and since \TeX\ works with scaled points where there are $2^{16}$
sp in a point, \TeX\ sets
$\\{num}/\\{den}=(254\cdot10^5)/(7227\cdot2^{16})=25400000/473628672$.

The \\{mag} parameter is what \TeX\ calls \.{\\mag}, i.e., 1000 times the
desired magnification. The actual fraction by which dimensions are
multiplied is therefore $\\{mag}\cdot\\{num}/1000\\{den}$. Note that if a \TeX\
source document does not call for any `\.{true}' dimensions, and if you
change it only by specifying a different \.{\\mag} setting, the \.{DVI}
file that \TeX\ creates will be completely unchanged except for the value
of \\{mag} in the preamble and postamble. (Fancy \.{DVI}-reading programs allow
users to override the \\{mag}~setting when a \.{DVI} file is being printed.)

Finally, \|k and \|x allow the \.{DVI} writer to include a comment, which is
not
interpreted further. The length of comment \|x is \|k, where $0\L\|k<256$.

\Y\P\D \37$\\{id\_byte}=2$\C{identifies the kind of \.{DVI} files described
here}\par
\fi

\M615. Font definitions for a given font number \|k contain further parameters
$$\hbox{$\|c[4]$ $\|s[4]$ $\|d[4]$ $\|a[1]$ $\|l[1]$ $\|n[\|a+\|l]$.}$$
The four-byte value \|c is the check sum that \TeX\ found in the \.{TFM}
file for this font; \|c should match the check sum of the font found by
programs that read this \.{DVI} file.

Parameter \|s contains a fixed-point scale factor that is applied to
the character widths in font \|k; font dimensions in \.{TFM} files and
other font files are relative to this quantity, which is called the
``at size'' elsewhere in this documentation. The value of \|s is
always positive and less than $2^{27}$. It is given in the same units
as the other \.{DVI} dimensions, i.e., in sp when \TeX82 has made the
file.  Parameter \|d is similar to \|s; it is the ``design size,'' and
(like~\|s) it is given in \.{DVI} units. Thus, font \|k is to be used
at $\\{mag}\cdot s/1000d$ times its normal size.

The remaining part of a font definition gives the external name of the font,
which is an ASCII string of length $\|a+\|l$. The number \|a is the length
of the ``area'' or directory, and \|l is the length of the font name itself;
the standard local system font area is supposed to be used when $\|a=0$.
The \|n field contains the area in its first \|a bytes.

Font definitions must appear before the first use of a particular font number.
Once font \|k is defined, it must not be defined again; however, we
shall see below that font definitions appear in the postamble as well as
in the pages, so in this sense each font number is defined exactly twice,
if at all. Like \\{nop} commands, font definitions can
appear before the first \\{bop}, or between an \\{eop} and a \\{bop}.

\fi

\M616. Sometimes it is desirable to make horizontal or vertical rules line up
precisely with certain features in characters of a font. It is possible to
guarantee the correct matching between \.{DVI} output and the characters
generated by \MF\ by adhering to the following principles: (1)~The \MF\
characters should be positioned so that a bottom edge or left edge that is
supposed to line up with the bottom or left edge of a rule appears at the
reference point, i.e., in row~0 and column~0 of the \MF\ raster. This
ensures that the position of the rule will not be rounded differently when
the pixel size is not a perfect multiple of the units of measurement in
the \.{DVI} file. (2)~A typeset rule of height $a>0$ and width $b>0$
should be equivalent to a \MF-generated character having black pixels in
precisely those raster positions whose \MF\ coordinates satisfy
$0\L\|x<\hbox{$\alpha$}\|b$ and $0\L\|y<\hbox{$\alpha$}\|a$, where $\alpha$ is
the number
of pixels per \.{DVI} unit.

\fi

\M617. The last page in a \.{DVI} file is followed by `\\{post}'; this command
introduces the postamble, which summarizes important facts that \TeX\ has
accumulated about the file, making it possible to print subsets of the data
with reasonable efficiency. The postamble has the form
$$\vbox{\halign{\hbox{#\hfil}\cr
\\{post} $\|p[4]$ $\\{num}[4]$ $\\{den}[4]$ $\\{mag}[4]$ $\|l[4]$ $\|u[4]$ $%
\|s[2]$ $\|t[2]$\cr
$\langle\,$font definitions$\,\rangle$\cr
\\{post\_post} $\|q[4]$ $\|i[1]$ 223's$[{\G}4]$\cr}}$$
Here \|p is a pointer to the final \\{bop} in the file. The next three
parameters, \\{num}, \\{den}, and \\{mag}, are duplicates of the quantities
that
appeared in the preamble.

Parameters \|l and \|u give respectively the height-plus-depth of the tallest
page and the width of the widest page, in the same units as other dimensions
of the file. These numbers might be used by a \.{DVI}-reading program to
position individual ``pages'' on large sheets of film or paper; however,
the standard convention for output on normal size paper is to position each
page so that the upper left-hand corner is exactly one inch from the left
and the top. Experience has shown that it is unwise to design %
\.{DVI}-to-printer
software that attempts cleverly to center the output; a fixed position of
the upper left corner is easiest for users to understand and to work with.
Therefore \|l and~\|u are often ignored.

Parameter \|s is the maximum stack depth (i.e., the largest excess of
\\{push} commands over \\{pop} commands) needed to process this file. Then
comes \|t, the total number of pages (\\{bop} commands) present.

The postamble continues with font definitions, which are any number of
\\{fnt\_def} commands as described above, possibly interspersed with \\{nop}
commands. Each font number that is used in the \.{DVI} file must be defined
exactly twice: Once before it is first selected by a \\{fnt} command, and once
in the postamble.

\fi

\M618. The last part of the postamble, following the \\{post\_post} byte that
signifies the end of the font definitions, contains \|q, a pointer to the
\\{post} command that started the postamble.  An identification byte, \|i,
comes next; this currently equals~2, as in the preamble.

The \|i byte is followed by four or more bytes that are all equal to
the decimal number 223 (i.e., \O{337} in octal). \TeX\ puts out four to seven
of
these trailing bytes, until the total length of the file is a multiple of
four bytes, since this works out best on machines that pack four bytes per
word; but any number of 223's is allowed, as long as there are at least four
of them. In effect, 223 is a sort of signature that is added at the very end.

This curious way to finish off a \.{DVI} file makes it feasible for
\.{DVI}-reading programs to find the postamble first, on most computers,
even though \TeX\ wants to write the postamble last. Most operating
systems permit random access to individual words or bytes of a file, so
the \.{DVI} reader can start at the end and skip backwards over the 223's
until finding the identification byte. Then it can back up four bytes, read
\|q, and move to byte \|q of the file. This byte should, of course,
contain the value 248 (\\{post}); now the postamble can be read, so the
\.{DVI} reader can discover all the information needed for typesetting the
pages. Note that it is also possible to skip through the \.{DVI} file at
reasonably high speed to locate a particular page, if that proves
desirable. This saves a lot of time, since \.{DVI} files used in production
jobs tend to be large.

Unfortunately, however, standard \PASCAL\ does not include the ability to
access a random position in a file, or even to determine the length of a file.
Almost all systems nowadays provide the necessary capabilities, so \.{DVI}
format has been designed to work most efficiently with modern operating
systems.
But if \.{DVI} files have to be processed under the restrictions of standard
\PASCAL, one can simply read them from front to back, since the necessary
header information is present in the preamble and in the font definitions.
(The \|l and \|u and \|s and \|t parameters, which appear only in the
postamble, are ``frills'' that are handy but not absolutely necessary.)

\fi

\N619.  \[32] Shipping pages out.
After considering \TeX's eyes and stomach, we come now to the bowels.

The \\{ship\_out} procedure is given a pointer to a box; its mission is
to describe that box in \.{DVI} form, outputting a ``page'' to \\{dvi\_file}.
The \.{DVI} coordinates $(h,v)=(0,0)$ should correspond to the upper left
corner of the box being shipped.

Since boxes can be inside of boxes inside of boxes, the main work of
\\{ship\_out} is done by two mutually recursive routines, \\{hlist\_out}
and \\{vlist\_out}, which traverse the hlists and vlists inside of horizontal
and vertical boxes.

As individual pages are being processed, we need to accumulate
information about the entire set of pages, since such statistics must be
reported in the postamble. The global variables \\{total\_pages}, \\{max\_v},
\\{max\_h}, \\{max\_push}, and \\{last\_bop} are used to record this
information.

The variable \\{doing\_leaders} is \\{true} while leaders are being output.
The variable \\{dead\_cycles} contains the number of times an output routine
has been initiated since the last \\{ship\_out}.

A few additional global variables are also defined here for use in
\\{vlist\_out} and \\{hlist\_out}. They could have been local variables, but
that would waste stack space when boxes are deeply nested, since the
values of these variables are not needed during recursive calls.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{total\_pages}: \37\\{integer};\C{the number of pages that have been
shipped out}\6
\4\\{max\_v}: \37\\{scaled};\C{maximum height-plus-depth of pages shipped so
far}\6
\4\\{max\_h}: \37\\{scaled};\C{maximum width of pages shipped so far}\6
\4\\{max\_push}: \37\\{integer};\C{deepest nesting of \\{push} commands
encountered so far}\6
\4\\{last\_bop}: \37\\{integer};\C{location of previous \\{bop} in the \.{DVI}
output}\6
\4\\{dead\_cycles}: \37\\{integer};\C{recent outputs that didn't ship anything
out}\6
\4\\{doing\_leaders}: \37\\{boolean};\C{are we inside a leader box?}\7
\4$\|c,\39\|f$: \37\\{quarterword};\C{character and font in current \\{char%
\_node}}\6
\4$\\{rule\_ht},\39\\{rule\_dp},\39\\{rule\_wd}$: \37\\{scaled};\C{size of
current rule being output}\6
\4\|g: \37\\{pointer};\C{current glue specification}\6
\4$\\{lq},\39\\{lr}$: \37\\{integer};\C{quantities used in calculations for
leaders}\par
\fi

\M620. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{total\_pages}\K0$;\5
$\\{max\_v}\K0$;\5
$\\{max\_h}\K0$;\5
$\\{max\_push}\K0$;\5
$\\{last\_bop}\K-1$;\5
$\\{doing\_leaders}\K\\{false}$;\5
$\\{dead\_cycles}\K0$;\5
$\\{cur\_s}\K-1$;\par
\fi

\M621. The \.{DVI} bytes are output to a buffer instead of being written
directly
to the output file. This makes it possible to reduce the overhead of
subroutine calls, thereby measurably speeding up the computation, since
output of \.{DVI} bytes is part of \TeX's inner loop. And it has another
advantage as well, since we can change instructions in the buffer in order to
make the output more compact. For example, a `\\{down2}' command can be
changed to a `\\{y2}', thereby making a subsequent `\\{y0}' command possible,
saving two bytes.

The output buffer is divided into two parts of equal size; the bytes found
in $\\{dvi\_buf}[0\to\\{half\_buf}-1]$ constitute the first half, and those in
$\\{dvi\_buf}[\\{half\_buf}\to\\{dvi\_buf\_size}-1]$ constitute the second. The
global
variable \\{dvi\_ptr} points to the position that will receive the next
output byte. When \\{dvi\_ptr} reaches \\{dvi\_limit}, which is always equal
to one of the two values \\{half\_buf} or \\{dvi\_buf\_size}, the half buffer
that
is about to be invaded next is sent to the output and \\{dvi\_limit} is
changed to its other value. Thus, there is always at least a half buffer's
worth of information present, except at the very beginning of the job.

Bytes of the \.{DVI} file are numbered sequentially starting with 0;
the next byte to be generated will be number $\\{dvi\_offset}+\\{dvi\_ptr}$.
A byte is present in the buffer only if its number is $\G\\{dvi\_gone}$.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{dvi\_index}=0\to\\{dvi\_buf\_size}$;\C{an index into the output buffer}\par
\fi

\M622. Some systems may find it more efficient to make \\{dvi\_buf} a %
\&{packed}
array, since output of four bytes at once may be facilitated.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{dvi\_buf}: \37\&{array} $[\\{dvi\_index}]$ \1\&{of}\5
\\{eight\_bits};\C{buffer for \.{DVI} output}\2\6
\4\\{half\_buf}: \37\\{dvi\_index};\C{half of \\{dvi\_buf\_size}}\6
\4\\{dvi\_limit}: \37\\{dvi\_index};\C{end of the current half buffer}\6
\4\\{dvi\_ptr}: \37\\{dvi\_index};\C{the next available buffer address}\6
\4\\{dvi\_offset}: \37\\{integer};\C{\\{dvi\_buf\_size} times the number of
times the   output buffer has been fully emptied}\6
\4\\{dvi\_gone}: \37\\{integer};\C{the number of bytes already output to \\{dvi%
\_file}}\par
\fi

\M623. Initially the buffer is all in one piece; we will output half of it only
after it first fills up.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{half\_buf}\K\\{dvi\_buf\_size}\mathbin{\&{div}}2$;\5
$\\{dvi\_limit}\K\\{dvi\_buf\_size}$;\5
$\\{dvi\_ptr}\K0$;\5
$\\{dvi\_offset}\K0$;\5
$\\{dvi\_gone}\K0$;\par
\fi

\M624. The actual output of $\\{dvi\_buf}[\|a\to\|b]$ to \\{dvi\_file} is
performed by calling
$\\{write\_dvi}(\|a,\|b)$. For best results, this procedure should be optimized
to
run as fast as possible on each particular system, since it is part of
\TeX's inner loop. It is safe to assume that \|a and $\|b+1$ will both be
multiples of 4 when $\\{write\_dvi}(\|a,\|b)$ is called; therefore it is
possible on
many machines to use efficient methods to pack four bytes per word and to
output an array of words with one system call.

\Y\P\4\&{procedure}\1\  \37$\\{write\_dvi}(\|a,\39\|b:\\{dvi\_index})$;\6
\4\&{var} \37\|k: \37\\{dvi\_index};\2\6
\&{begin} \37\&{for} $\|k\K\|a\mathrel{\&{to}}\|b$ \1\&{do}\5
$\\{write}(\\{dvi\_file},\39\\{dvi\_buf}[\|k])$;\2\6
\&{end};\par
\fi

\M625. To put a byte in the buffer without paying the cost of invoking a
procedure
each time, we use the macro \\{dvi\_out}.

\Y\P\D \37$\\{dvi\_out}(\#)\S$\ \&{begin} \37$\\{dvi\_buf}[\\{dvi\_ptr}]\K\#$;\5
$\\{incr}(\\{dvi\_ptr})$;\6
\&{if} $\\{dvi\_ptr}=\\{dvi\_limit}$ \1\&{then}\5
\\{dvi\_swap};\2\6
\&{end}\par
\Y\P\4\&{procedure}\1\  \37\\{dvi\_swap};\C{outputs half of the buffer}\2\6
\&{begin} \37\&{if} $\\{dvi\_limit}=\\{dvi\_buf\_size}$ \1\&{then}\6
\&{begin} \37$\\{write\_dvi}(0,\39\\{half\_buf}-1)$;\5
$\\{dvi\_limit}\K\\{half\_buf}$;\5
$\\{dvi\_offset}\K\\{dvi\_offset}+\\{dvi\_buf\_size}$;\5
$\\{dvi\_ptr}\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{write\_dvi}(\\{half\_buf},\39\\{dvi\_buf%
\_size}-1)$;\5
$\\{dvi\_limit}\K\\{dvi\_buf\_size}$;\6
\&{end};\2\6
$\\{dvi\_gone}\K\\{dvi\_gone}+\\{half\_buf}$;\6
\&{end};\par
\fi

\M626. Here is how we clean out the buffer when \TeX\ is all through; \\{dvi%
\_ptr}
will be a multiple of~4.

\Y\P$\4\X626:Empty the last bytes out of \\{dvi\_buf}\X\S$\6
\&{if} $\\{dvi\_limit}=\\{half\_buf}$ \1\&{then}\5
$\\{write\_dvi}(\\{half\_buf},\39\\{dvi\_buf\_size}-1)$;\2\6
\&{if} $\\{dvi\_ptr}>0$ \1\&{then}\5
$\\{write\_dvi}(0,\39\\{dvi\_ptr}-1)$\2\par
\U670.\fi

\M627. The \\{dvi\_four} procedure outputs four bytes in two's complement
notation,
without risking arithmetic overflow.

\Y\P\4\&{procedure}\1\  \37$\\{dvi\_four}(\|x:\\{integer})$;\2\6
\&{begin} \37\&{if} $\|x\G0$ \1\&{then}\5
$\\{dvi\_out}(\|x\mathbin{\&{div}}\O{100000000})$\6
\4\&{else} \&{begin} \37$\|x\K\|x+\O{10000000000}$;\5
$\|x\K\|x+\O{10000000000}$;\5
$\\{dvi\_out}((\|x\mathbin{\&{div}}\O{100000000})+128)$;\6
\&{end};\2\6
$\|x\K\|x\mathbin{\&{mod}}\O{100000000}$;\5
$\\{dvi\_out}(\|x\mathbin{\&{div}}\O{200000})$;\5
$\|x\K\|x\mathbin{\&{mod}}\O{200000}$;\5
$\\{dvi\_out}(\|x\mathbin{\&{div}}\O{400})$;\5
$\\{dvi\_out}(\|x\mathbin{\&{mod}}\O{400})$;\6
\&{end};\par
\fi

\M628. A mild optimization of the output is performed by the \\{dvi\_pop}
routine, which issues a \\{pop} unless it is possible to cancel a
`\\{push} \\{pop}' pair. The parameter to \\{dvi\_pop} is the byte address
following the old \\{push} that matches the new \\{pop}.

\Y\P\4\&{procedure}\1\  \37$\\{dvi\_pop}(\|l:\\{integer})$;\2\6
\&{begin} \37\&{if} $(\|l=\\{dvi\_offset}+\\{dvi\_ptr})\W(\\{dvi\_ptr}>0)$ \1%
\&{then}\5
$\\{decr}(\\{dvi\_ptr})$\6
\4\&{else} $\\{dvi\_out}(\\{pop})$;\2\6
\&{end};\par
\fi

\M629. Here's a procedure that outputs a font definition. Since \TeX82 uses at
most 256 different fonts per job, \\{fnt\_def1} is always used as the command
code.

\Y\P\4\&{procedure}\1\  \37$\\{dvi\_font\_def}(\|f:\\{internal\_font%
\_number})$;\6
\4\&{var} \37\|k: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\2\6
\&{begin} \37$\\{dvi\_out}(\\{fnt\_def1})$;\5
$\\{dvi\_out}(\|f-\\{font\_base}-1)$;\6
$\\{dvi\_out}(\\{qo}(\\{font\_check}[\|f].\\{b0}))$;\5
$\\{dvi\_out}(\\{qo}(\\{font\_check}[\|f].\\{b1}))$;\5
$\\{dvi\_out}(\\{qo}(\\{font\_check}[\|f].\\{b2}))$;\5
$\\{dvi\_out}(\\{qo}(\\{font\_check}[\|f].\\{b3}))$;\6
$\\{dvi\_four}(\\{font\_size}[\|f])$;\5
$\\{dvi\_four}(\\{font\_dsize}[\|f])$;\6
$\\{dvi\_out}(\\{length}(\\{font\_area}[\|f]))$;\5
$\\{dvi\_out}(\\{length}(\\{font\_name}[\|f]))$;\5
\X630:Output the font name whose internal number is \|f\X;\6
\&{end};\par
\fi

\M630. \P$\X630:Output the font name whose internal number is \|f\X\S$\6
\&{for} $\|k\K\\{str\_start}[\\{font\_area}[\|f]]\mathrel{\&{to}}\\{str%
\_start}[\\{font\_area}[\|f]+1]-1$ \1\&{do}\5
$\\{dvi\_out}(\\{so}(\\{str\_pool}[\|k]))$;\2\6
\&{for} $\|k\K\\{str\_start}[\\{font\_name}[\|f]]\mathrel{\&{to}}\\{str%
\_start}[\\{font\_name}[\|f]+1]-1$ \1\&{do}\5
$\\{dvi\_out}(\\{so}(\\{str\_pool}[\|k]))$\2\par
\U629.\fi

\M631. Versions of \TeX\ intended for small computers might well choose to omit
the ideas in the next few parts of this program, since it is not really
necessary to optimize the \.{DVI} code by making use of the \\{w0}, \\{x0},
\\{y0}, and \\{z0} commands. Furthermore, the algorithm that we are about to
describe does not pretend to give an optimum reduction in the length
of the \.{DVI} code; after all, speed is more important than compactness.
But the method is surprisingly effective, and it takes comparatively little
time.

We can best understand the basic idea by first considering a simpler problem
that has the same essential characteristics. Given a sequence of digits,
say $3\,1\,4\,1\,5\,9\,2\,6\,5\,3\,5\,8\,9$, we want to assign subscripts
$d$, $y$, or $z$ to each digit so as to maximize the number of ``$y$-hits''
and ``$z$-hits''; a $y$-hit is an instance of two appearances of the same
digit with the subscript $y$, where no $y$'s intervene between the two
appearances, and a $z$-hit is defined similarly. For example, the sequence
above could be decorated with subscripts as follows:
$$3_z\,1_y\,4_d\,1_y\,5_y\,9_d\,2_d\,6_d\,5_y\,3_z\,5_y\,8_d\,9_d.$$
There are three $y$-hits ($1_y\ldots1_y$ and $5_y\ldots5_y\ldots5_y$) and
one $z$-hit ($3_z\ldots3_z$); there are no $d$-hits, since the two appearances
of $9_d$ have $d$'s between them, but we don't count $d$-hits so it doesn't
matter how many there are. These subscripts are analogous to the \.{DVI}
commands called \\{down}, $y$, and $z$, and the digits are analogous to
different amounts of vertical motion; a $y$-hit or $z$-hit corresponds to
the opportunity to use the one-byte commands \\{y0} or \\{z0} in a \.{DVI}
file.

\TeX's method of assigning subscripts works like this: Append a new digit,
say $\delta$, to the right of the sequence. Now look back through the
sequence until one of the following things happens: (a)~You see
$\delta_y$ or $\delta_z$, and this was the first time you encountered a
$y$ or $z$ subscript, respectively.  Then assign $y$ or $z$ to the new
$\delta$; you have scored a hit. (b)~You see $\delta_d$, and no $y$
subscripts have been encountered so far during this search.  Then change
the previous $\delta_d$ to $\delta_y$ (this corresponds to changing a
command in the output buffer), and assign $y$ to the new $\delta$; it's
another hit.  (c)~You see $\delta_d$, and a $y$ subscript has been seen
but not a $z$.  Change the previous $\delta_d$ to $\delta_z$ and assign
$z$ to the new $\delta$. (d)~You encounter both $y$ and $z$ subscripts
before encountering a suitable $\delta$, or you scan all the way to the
front of the sequence. Assign $d$ to the new $\delta$; this assignment may
be changed later.

The subscripts $3_z\,1_y\,4_d\ldots\,$ in the example above were, in fact,
produced by this procedure, as the reader can verify. (Go ahead and try it.)

\fi

\M632. In order to implement such an idea, \TeX\ maintains a stack of pointers
to the \\{down}, $y$, and $z$ commands that have been generated for the
current page. And there is a similar stack for \\{right}, \|w, and \|x
commands. These stacks are called the down stack and right stack, and their
top elements are maintained in the variables \\{down\_ptr} and \\{right\_ptr}.

Each entry in these stacks contains four fields: The \\{width} field is
the amount of motion down or to the right; the \\{location} field is the
byte number of the \.{DVI} command in question (including the appropriate
\\{dvi\_offset}); the \\{link} field points to the next item below this one
on the stack; and the \\{info} field encodes the options for possible change
in the \.{DVI} command.

\Y\P\D \37$\\{movement\_node\_size}=3$\C{number of words per entry in the down
and right stacks}\par
\P\D \37$\\{location}(\#)\S\\{mem}[\#+2].\\{int}$\C{\.{DVI} byte number for a
movement command}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4$\\{down\_ptr},\39\\{right\_ptr}$: \37\\{pointer};\C{heads of the down and
right stacks}\par
\fi

\M633. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{down\_ptr}\K\\{null}$;\5
$\\{right\_ptr}\K\\{null}$;\par
\fi

\M634. Here is a subroutine that produces a \.{DVI} command for some specified
downward or rightward motion. It has two parameters: \|w is the amount
of motion, and \|o is either \\{down1} or \\{right1}. We use the fact that
the command codes have convenient arithmetic properties: $\\{y1}-\\{down1}=%
\\{w1}-\\{right1}$
and $\\{z1}-\\{down1}=\\{x1}-\\{right1}$.

\Y\P\4\&{procedure}\1\  \37$\\{movement}(\|w:\\{scaled};\,\35\|o:\\{eight%
\_bits})$;\6
\4\&{label} \37$\\{exit},\39\\{found},\39\\{not\_found},\392,\391$;\6
\4\&{var} \37\\{mstate}: \37\\{small\_number};\C{have we seen a \|y or \|z?}\6
$\|p,\39\|q$: \37\\{pointer};\C{current and top nodes on the stack}\6
\|k: \37\\{integer};\C{index into \\{dvi\_buf}, modulo \\{dvi\_buf\_size}}\2\6
\&{begin} \37$\|q\K\\{get\_node}(\\{movement\_node\_size})$;\C{new node for the
top of the stack}\6
$\\{width}(\|q)\K\|w$;\5
$\\{location}(\|q)\K\\{dvi\_offset}+\\{dvi\_ptr}$;\6
\&{if} $\|o=\\{down1}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|q)\K\\{down\_ptr}$;\5
$\\{down\_ptr}\K\|q$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{link}(\|q)\K\\{right\_ptr}$;\5
$\\{right\_ptr}\K\|q$;\6
\&{end};\2\6
\X638:Look at the other stack entries until deciding what sort of \.{DVI}
command to generate; \&{goto} \\{found} if node \|p is a ``hit''\X;\6
\X637:Generate a \\{down} or \\{right} command for \|w and \&{return}\X;\6
\4\\{found}: \37\X636:Generate a \\{y0} or \\{z0} command in order to reuse a
previous appearance of~\|w\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M635. The \\{info} fields in the entries of the down stack or the right stack
have six possible settings: \\{y\_here} or \\{z\_here} mean that the \.{DVI}
command refers to \|y or \|z, respectively (or to \|w or \|x, in the
case of horizontal motion); \\{yz\_OK} means that the \.{DVI} command is
\\{down} (or \\{right}) but can be changed to either \|y or \|z (or
to either \|w or \|x); \\{y\_OK} means that it is \\{down} and can be changed
to \|y but not \|z; \\{z\_OK} is similar; and \\{d\_fixed} means it must stay
\\{down}.

The four settings \\{yz\_OK}, \\{y\_OK}, \\{z\_OK}, \\{d\_fixed} would not need
to
be distinguished from each other if we were simply solving the
digit-subscripting problem mentioned above. But in \TeX's case there is
a complication because of the nested structure of \\{push} and \\{pop}
commands. Suppose we add parentheses to the digit-subscripting problem,
redefining hits so that $\delta_y\ldots \delta_y$ is a hit if all $y$'s between
the $\delta$'s are enclosed in properly nested parentheses, and if the
parenthesis level of the right-hand $\delta_y$ is deeper than or equal to
that of the left-hand one. Thus, `(' and `)' correspond to `\\{push}'
and `\\{pop}'. Now if we want to assign a subscript to the final 1 in the
sequence
$$2_y\,7_d\,1_d\,(\,8_z\,2_y\,8_z\,)\,1$$
we cannot change the previous $1_d$ to $1_y$, since that would invalidate
the $2_y\ldots2_y$ hit. But we can change it to $1_z$, scoring a hit
since the intervening $8_z$'s are enclosed in parentheses.

The program below removes movement nodes that are introduced after a \\{push},
before it outputs the corresponding \\{pop}.

\Y\P\D \37$\\{y\_here}=1$\C{\\{info} when the movement entry points to a \|y
command}\par
\P\D \37$\\{z\_here}=2$\C{\\{info} when the movement entry points to a \|z
command}\par
\P\D \37$\\{yz\_OK}=3$\C{\\{info} corresponding to an unconstrained \\{down}
command}\par
\P\D \37$\\{y\_OK}=4$\C{\\{info} corresponding to a \\{down} that can't become
a \|z}\par
\P\D \37$\\{z\_OK}=5$\C{\\{info} corresponding to a \\{down} that can't become
a \|y}\par
\P\D \37$\\{d\_fixed}=6$\C{\\{info} corresponding to a \\{down} that can't
change}\par
\fi

\M636. When the \\{movement} procedure gets to the label \\{found}, the value
of
$\\{info}(\|p)$ will be either \\{y\_here} or \\{z\_here}. If it is, say, \\{y%
\_here},
the procedure generates a \\{y0} command (or a \\{w0} command), and marks
all \\{info} fields between \|q and \|p so that \|y is not OK in that range.

\Y\P$\4\X636:Generate a \\{y0} or \\{z0} command in order to reuse a previous
appearance of~\|w\X\S$\6
$\\{info}(\|q)\K\\{info}(\|p)$;\6
\&{if} $\\{info}(\|q)=\\{y\_here}$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\|o+\\{y0}-\\{down1})$;\C{\\{y0} or \\{w0}}\6
\&{while} $\\{link}(\|q)\I\|p$ \1\&{do}\6
\&{begin} \37$\|q\K\\{link}(\|q)$;\6
\&{case} $\\{info}(\|q)$ \1\&{of}\6
\4\\{yz\_OK}: \37$\\{info}(\|q)\K\\{z\_OK}$;\6
\4\\{y\_OK}: \37$\\{info}(\|q)\K\\{d\_fixed}$;\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{dvi\_out}(\|o+\\{z0}-\\{down1})$;\C{\\{z0} or %
\\{x0}}\6
\&{while} $\\{link}(\|q)\I\|p$ \1\&{do}\6
\&{begin} \37$\|q\K\\{link}(\|q)$;\6
\&{case} $\\{info}(\|q)$ \1\&{of}\6
\4\\{yz\_OK}: \37$\\{info}(\|q)\K\\{y\_OK}$;\6
\4\\{z\_OK}: \37$\\{info}(\|q)\K\\{d\_fixed}$;\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{end};\2\6
\&{end}\2\par
\U634.\fi

\M637. \P$\X637:Generate a \\{down} or \\{right} command for \|w and \&{return}%
\X\S$\6
$\\{info}(\|q)\K\\{yz\_OK}$;\6
\&{if} $\\{abs}(\|w)\G\O{40000000}$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\|o+3)$;\C{\\{down4} or \\{right4}}\6
$\\{dvi\_four}(\|w)$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{abs}(\|w)\G\O{100000}$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\|o+2)$;\C{\\{down3} or \\{right3}}\6
\&{if} $\|w<0$ \1\&{then}\5
$\|w\K\|w+\O{100000000}$;\2\6
$\\{dvi\_out}(\|w\mathbin{\&{div}}\O{200000})$;\5
$\|w\K\|w\mathbin{\&{mod}}\O{200000}$;\5
\&{goto} \372;\6
\&{end};\2\6
\&{if} $\\{abs}(\|w)\G\O{200}$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\|o+1)$;\C{\\{down2} or \\{right2}}\6
\&{if} $\|w<0$ \1\&{then}\5
$\|w\K\|w+\O{200000}$;\2\6
\&{goto} \372;\6
\&{end};\2\6
$\\{dvi\_out}(\|o)$;\C{\\{down1} or \\{right1}}\6
\&{if} $\|w<0$ \1\&{then}\5
$\|w\K\|w+\O{400}$;\2\6
\&{goto} \371;\6
\42: \37$\\{dvi\_out}(\|w\mathbin{\&{div}}\O{400})$;\6
\41: \37$\\{dvi\_out}(\|w\mathbin{\&{mod}}\O{400})$;\5
\&{return}\par
\U634.\fi

\M638. As we search through the stack, we are in one of three states,
\\{y\_seen}, \\{z\_seen}, or \\{none\_seen}, depending on whether we have
encountered \\{y\_here} or \\{z\_here} nodes. These states are encoded as
multiples of 6, so that they can be added to the \\{info} fields for quick
decision-making.

\Y\P\D \37$\\{none\_seen}=0$\C{no \\{y\_here} or \\{z\_here} nodes have been
encountered yet}\par
\P\D \37$\\{y\_seen}=6$\C{we have seen \\{y\_here} but not \\{z\_here}}\par
\P\D \37$\\{z\_seen}=12$\C{we have seen \\{z\_here} but not \\{y\_here}}\par
\Y\P$\4\X638:Look at the other stack entries until deciding what sort of %
\.{DVI} command to generate; \&{goto} \\{found} if node \|p is a ``hit''\X\S$\6
$\|p\K\\{link}(\|q)$;\5
$\\{mstate}\K\\{none\_seen}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{width}(\|p)=\|w$ \1\&{then}\5
\X639:Consider a node with matching width; \&{goto} \\{found} if it's a hit\X\6
\4\&{else} \&{case} $\\{mstate}+\\{info}(\|p)$ \1\&{of}\6
\4$\\{none\_seen}+\\{y\_here}$: \37$\\{mstate}\K\\{y\_seen}$;\6
\4$\\{none\_seen}+\\{z\_here}$: \37$\\{mstate}\K\\{z\_seen}$;\6
\4$\\{y\_seen}+\\{z\_here},\39\\{z\_seen}+\\{y\_here}$: \37\&{goto} \37\\{not%
\_found};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\4\\{not\_found}: \37\par
\U634.\fi

\M639. We might find a valid hit in a \|y or \|z byte that is already gone
from the buffer. But we can't change bytes that are gone forever; ``the
moving finger writes, $\ldots\,\,$.''

\Y\P$\4\X639:Consider a node with matching width; \&{goto} \\{found} if it's a
hit\X\S$\6
\&{case} $\\{mstate}+\\{info}(\|p)$ \1\&{of}\6
\4$\\{none\_seen}+\\{yz\_OK},\39\\{none\_seen}+\\{y\_OK},\39\\{z\_seen}+\\{yz%
\_OK},\39\\{z\_seen}+\\{y\_OK}$: \37\hbox{}\6
\&{if} $\\{location}(\|p)<\\{dvi\_gone}$ \1\&{then}\5
\&{goto} \37\\{not\_found}\6
\4\&{else} \X640:Change buffered instruction to \|y or \|w and \&{goto} %
\\{found}\X;\2\6
\4$\\{none\_seen}+\\{z\_OK},\39\\{y\_seen}+\\{yz\_OK},\39\\{y\_seen}+\\{z%
\_OK}$: \37\hbox{}\6
\&{if} $\\{location}(\|p)<\\{dvi\_gone}$ \1\&{then}\5
\&{goto} \37\\{not\_found}\6
\4\&{else} \X641:Change buffered instruction to \|z or \|x and \&{goto} %
\\{found}\X;\2\6
\4$\\{none\_seen}+\\{y\_here},\39\\{none\_seen}+\\{z\_here},\39\\{y\_seen}+\\{z%
\_here},\39\\{z\_seen}+\\{y\_here}$: \37\&{goto} \37\\{found};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases}\par
\U638.\fi

\M640. \P$\X640:Change buffered instruction to \|y or \|w and \&{goto} %
\\{found}\X\S$\6
\&{begin} \37$\|k\K\\{location}(\|p)-\\{dvi\_offset}$;\6
\&{if} $\|k<0$ \1\&{then}\5
$\|k\K\|k+\\{dvi\_buf\_size}$;\2\6
$\\{dvi\_buf}[\|k]\K\\{dvi\_buf}[\|k]+\\{y1}-\\{down1}$;\5
$\\{info}(\|p)\K\\{y\_here}$;\5
\&{goto} \37\\{found};\6
\&{end}\par
\U639.\fi

\M641. \P$\X641:Change buffered instruction to \|z or \|x and \&{goto} %
\\{found}\X\S$\6
\&{begin} \37$\|k\K\\{location}(\|p)-\\{dvi\_offset}$;\6
\&{if} $\|k<0$ \1\&{then}\5
$\|k\K\|k+\\{dvi\_buf\_size}$;\2\6
$\\{dvi\_buf}[\|k]\K\\{dvi\_buf}[\|k]+\\{z1}-\\{down1}$;\5
$\\{info}(\|p)\K\\{z\_here}$;\5
\&{goto} \37\\{found};\6
\&{end}\par
\U639.\fi

\M642. In case you are wondering when all the movement nodes are removed from
\TeX's memory, the answer is that they are recycled just before
\\{hlist\_out} and \\{vlist\_out} finish outputting a box. This restores the
down and right stacks to the state they were in before the box was output,
except that some \\{info}'s may have become more restrictive.

\Y\P\4\&{procedure}\1\  \37$\\{prune\_movements}(\|l:\\{integer})$;\C{delete
movement nodes with $\\{location}\G\|l$}\6
\4\&{label} \37$\\{done},\39\\{exit}$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{node being deleted}\2\6
\&{begin} \37\&{while} $\\{down\_ptr}\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{location}(\\{down\_ptr})<\|l$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|p\K\\{down\_ptr}$;\5
$\\{down\_ptr}\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{movement\_node\_size})$;\6
\&{end};\2\6
\4\\{done}: \37\&{while} $\\{right\_ptr}\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{location}(\\{right\_ptr})<\|l$ \1\&{then}\5
\&{return};\2\6
$\|p\K\\{right\_ptr}$;\5
$\\{right\_ptr}\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{movement\_node\_size})$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M643. The actual distances by which we want to move might be computed as the
sum of several separate movements. For example, there might be several
glue nodes in succession, or we might want to move right by the width of
some box plus some amount of glue. More importantly, the baselineskip
distances are computed in terms of glue together with the depth and
height of adjacent boxes, and we want the \.{DVI} file to lump these
three quantities together into a single motion.

Therefore, \TeX\ maintains two pairs of global variables: \\{dvi\_h} and \\{dvi%
\_v}
are the \|h and \|v coordinates corresponding to the commands actually
output to the \.{DVI} file, while \\{cur\_h} and \\{cur\_v} are the coordinates
corresponding to the current state of the output routines. Coordinate
changes will accumulate in \\{cur\_h} and \\{cur\_v} without being reflected
in the output, until such a change becomes necessary or desirable; we
can call the \\{movement} procedure whenever we want to make $\\{dvi\_h}=\\{cur%
\_h}$
or $\\{dvi\_v}=\\{cur\_v}$.

The current font reflected in the \.{DVI} output is called \\{dvi\_f};
there is no need for a `\\{cur\_f}' variable.

The depth of nesting of \\{hlist\_out} and \\{vlist\_out} is called \\{cur\_s};
this is essentially the depth of \\{push} commands in the \.{DVI} output.

For mixed direction text (\TeXXeT) the current text direction is called
\\{cur\_dir}. As the box being shipped out will never be used again and
soon be recycled, we can simply reverse any R-text (i.e., right-to-left)
segments of hlist nodes as well as complete hlist nodes embedded in such
segments. Moreover this can be done iteratively rather than recursively.
There are, however, two complications related to leaders that require
some additional bookkeeping: (1)~One and the same hlist node might be
used more than once (but never inside both L- and R-text); and
(2)~leader boxes inside hlists must be aligned with respect to the left
edge of the original hlist.

A math node is changed into a kern node whenever the text direction
remains the same, it is replaced by an \\{edge\_node} if the text direction
changes; the subtype of an an \\{hlist\_node} inside R-text is changed to
\\{reversed} once its hlist has been reversed.

\Y\P\D \37$\\{reversed}=1$\C{subtype for an \\{hlist\_node} whose hlist has
been reversed}\par
\P\D \37$\\{dlist}=2$\C{subtype for an \\{hlist\_node} from display math mode}%
\par
\P\D \37$\\{box\_lr}(\#)\S(\\{qo}(\\{subtype}(\#)))$\C{direction mode of a box}%
\par
\P\D \37$\\{set\_box\_lr}(\#)\S\\{subtype}(\#)\K\\{set\_box\_lr\_end}$\par
\P\D \37$\\{set\_box\_lr\_end}(\#)\S\\{qi}(\#)$\Y\par
\P\D \37$\\{left\_to\_right}=0$\par
\P\D \37$\\{right\_to\_left}=1$\par
\P\D \37$\\{reflected}\S1-\\{cur\_dir}$\C{the opposite of \\{cur\_dir}}\Y\par
\P\D \37$\\{synch\_h}\S$\1\6
\&{if} $\\{cur\_h}\I\\{dvi\_h}$ \1\&{then}\6
\&{begin} \37$\\{movement}(\\{cur\_h}-\\{dvi\_h},\39\\{right1})$;\5
$\\{dvi\_h}\K\\{cur\_h}$;\6
\&{end}\2\2\par
\P\D \37$\\{synch\_v}\S$\1\6
\&{if} $\\{cur\_v}\I\\{dvi\_v}$ \1\&{then}\6
\&{begin} \37$\\{movement}(\\{cur\_v}-\\{dvi\_v},\39\\{down1})$;\5
$\\{dvi\_v}\K\\{cur\_v}$;\6
\&{end}\2\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4$\\{dvi\_h},\39\\{dvi\_v}$: \37\\{scaled};\C{a \.{DVI} reader program thinks
we are here}\6
\4$\\{cur\_h},\39\\{cur\_v}$: \37\\{scaled};\C{\TeX\ thinks we are here}\6
\4\\{dvi\_f}: \37\\{internal\_font\_number};\C{the current font}\6
\4\\{cur\_s}: \37\\{integer};\C{current depth of output box nesting, initially
$-1$}\par
\fi

\M644. \P$\X644:Calculate DVI page dimensions and margins\X\S$\6
$\\{cur\_h\_offset}\K\\{h\_offset}$;\5
$\\{cur\_v\_offset}\K\\{v\_offset}$;\6
\&{if} $\\{pdf\_page\_width}\I0$ \1\&{then}\5
$\\{cur\_page\_width}\K\\{pdf\_page\_width}$\6
\4\&{else} $\\{cur\_page\_width}\K\\{width}(\|p)+2\ast\\{cur\_h\_offset}+2%
\ast4736286$;\C{4736286 = 1in, the funny DVI origin offset}\2\6
\&{if} $\\{pdf\_page\_height}\I0$ \1\&{then}\5
$\\{cur\_page\_height}\K\\{pdf\_page\_height}$\6
\4\&{else} $\\{cur\_page\_height}\K\\{height}(\|p)+\\{depth}(\|p)+2\ast\\{cur%
\_v\_offset}+2\ast4736286$\C{4736286 = 1in, the funny DVI origin offset}\2\par
\U645.\fi

\M645. \P$\X645:Initialize variables as \\{ship\_out} begins\X\S$\6
$\\{dvi\_h}\K0$;\5
$\\{dvi\_v}\K0$;\5
$\\{cur\_h}\K\\{h\_offset}$;\5
$\\{dvi\_f}\K\\{null\_font}$;\5
\X644:Calculate DVI page dimensions and margins\X;\6
\\{ensure\_dvi\_open};\6
\&{if} $\\{total\_pages}=0$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\\{pre})$;\5
$\\{dvi\_out}(\\{id\_byte})$;\C{output the preamble}\6
$\\{dvi\_four}(25400000)$;\5
$\\{dvi\_four}(473628672)$;\C{conversion ratio for sp}\6
\\{prepare\_mag};\5
$\\{dvi\_four}(\\{mag})$;\C{magnification factor is frozen}\6
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\.{"\ TeX\ output\ "})$;\5
$\\{print\_int}(\\{year})$;\5
$\\{print\_char}(\.{"."})$;\5
$\\{print\_two}(\\{month})$;\5
$\\{print\_char}(\.{"."})$;\5
$\\{print\_two}(\\{day})$;\5
$\\{print\_char}(\.{":"})$;\5
$\\{print\_two}(\\{time}\mathbin{\&{div}}60)$;\5
$\\{print\_two}(\\{time}\mathbin{\&{mod}}60)$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{dvi\_out}(\\{cur\_length})$;\6
\&{for} $\|s\K\\{str\_start}[\\{str\_ptr}]\mathrel{\&{to}}\\{pool\_ptr}-1$ \1%
\&{do}\5
$\\{dvi\_out}(\\{so}(\\{str\_pool}[\|s]))$;\2\6
$\\{pool\_ptr}\K\\{str\_start}[\\{str\_ptr}]$;\C{flush the current string}\6
\&{end}\2\par
\U668.\fi

\M646. When \\{hlist\_out} is called, its duty is to output the box represented
by the \\{hlist\_node} pointed to by \\{temp\_ptr}. The reference point of that
box has coordinates $(\\{cur\_h},\\{cur\_v})$.

Similarly, when \\{vlist\_out} is called, its duty is to output the box
represented
by the \\{vlist\_node} pointed to by \\{temp\_ptr}. The reference point of that
box has coordinates $(\\{cur\_h},\\{cur\_v})$.

\Y\P\4\&{procedure}\1\  \37\\{vlist\_out};\5
\\{forward};\C{\\{hlist\_out} and \\{vlist\_out} are mutually   recursive}\par
\fi

\M647. The recursive procedures \\{hlist\_out} and \\{vlist\_out} each have
local variables
\\{save\_h} and \\{save\_v} to hold the values of \\{dvi\_h} and \\{dvi\_v}
just before
entering a new level of recursion.  In effect, the values of \\{save\_h} and
\\{save\_v} on \TeX's run-time stack correspond to the values of \|h and \|v
that a \.{DVI}-reading program will push onto its coordinate stack.

\Y\P\D \37$\\{move\_past}=13$\C{go to this label when advancing past glue or a
rule}\par
\P\D \37$\\{fin\_rule}=14$\C{go to this label to finish processing a rule}\par
\P\D \37$\\{next\_p}=15$\C{go to this label when finished with node \|p}\par
\Y\P\hbox{\4}\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}%
\X\hbox{}\6
\4\&{procedure}\1\  \37\\{hlist\_out};\C{output an \\{hlist\_node} box}\6
\4\&{label} \37$\\{reswitch},\39\\{move\_past},\39\\{fin\_rule},\39\\{next%
\_p}$;\6
\4\&{var} \37\\{base\_line}: \37\\{scaled};\C{the baseline coordinate for this
box}\6
\\{left\_edge}: \37\\{scaled};\C{the left coordinate for this box}\6
$\\{save\_h},\39\\{save\_v}$: \37\\{scaled};\C{what \\{dvi\_h} and \\{dvi\_v}
should pop to}\6
\\{this\_box}: \37\\{pointer};\C{pointer to containing box}\6
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\|p: \37\\{pointer};\C{current position in the hlist}\6
\\{save\_loc}: \37\\{integer};\C{\.{DVI} byte location upon entry}\6
\\{leader\_box}: \37\\{pointer};\C{the leader box being replicated}\6
\\{leader\_wd}: \37\\{scaled};\C{width of leader box being replicated}\6
\\{lx}: \37\\{scaled};\C{extra space between leader boxes}\6
\\{outer\_doing\_leaders}: \37\\{boolean};\C{were we doing leaders?}\6
\\{edge}: \37\\{scaled};\C{right edge of sub-box or leader space}\6
\\{prev\_p}: \37\\{pointer};\C{one step behind \|p}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
\\{cur\_glue}: \37\\{real};\C{glue seen so far}\6
\\{cur\_g}: \37\\{scaled};\C{rounded equivalent of \\{cur\_glue} times the glue
ratio}\2\6
\&{begin} \37$\\{cur\_g}\K0$;\5
$\\{cur\_glue}\K\\{float\_constant}(0)$;\5
$\\{this\_box}\K\\{temp\_ptr}$;\5
$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\5
$\|p\K\\{list\_ptr}(\\{this\_box})$;\5
$\\{incr}(\\{cur\_s})$;\6
\&{if} $\\{cur\_s}>0$ \1\&{then}\5
$\\{dvi\_out}(\\{push})$;\2\6
\&{if} $\\{cur\_s}>\\{max\_push}$ \1\&{then}\5
$\\{max\_push}\K\\{cur\_s}$;\2\6
$\\{save\_loc}\K\\{dvi\_offset}+\\{dvi\_ptr}$;\5
$\\{base\_line}\K\\{cur\_v}$;\5
$\\{prev\_p}\K\\{this\_box}+\\{list\_offset}$;\5
\X1714:Initialize \\{hlist\_out} for mixed direction typesetting\X;\6
$\\{left\_edge}\K\\{cur\_h}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X648:Output node \|p for \\{hlist\_out} and move to the next node, maintaining
the condition $\\{cur\_v}=\\{base\_line}$\X;\2\6
\X1715:Finish \\{hlist\_out} for mixed direction typesetting\X;\6
$\\{prune\_movements}(\\{save\_loc})$;\6
\&{if} $\\{cur\_s}>0$ \1\&{then}\5
$\\{dvi\_pop}(\\{save\_loc})$;\2\6
$\\{decr}(\\{cur\_s})$;\6
\&{end};\par
\fi

\M648. We ought to give special care to the efficiency of one part of \\{hlist%
\_out},
since it belongs to \TeX's inner loop. When a \\{char\_node} is encountered,
we save a little time by processing several nodes in succession until
reaching a non-\\{char\_node}. The program uses the fact that $\\{set\_char%
\_0}=0$.

\Y\P$\4\X648:Output node \|p for \\{hlist\_out} and move to the next node,
maintaining the condition $\\{cur\_v}=\\{base\_line}$\X\S$\6
\4\\{reswitch}: \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37\\{synch\_h};\5
\\{synch\_v};\6
\1\&{repeat} \37$\|f\K\\{font}(\|p)$;\5
$\|c\K\\{character}(\|p)$;\6
\&{if} $\|f\I\\{dvi\_f}$ \1\&{then}\5
\X649:Change font \\{dvi\_f} to \|f\X;\2\6
\&{if} $\|c\G\\{qi}(128)$ \1\&{then}\5
$\\{dvi\_out}(\\{set1})$;\2\6
$\\{dvi\_out}(\\{qo}(\|c))$;\6
$\\{cur\_h}\K\\{cur\_h}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$;\5
$\\{prev\_p}\K\\{link}(\\{prev\_p})$;\C{N.B.: not $\\{prev\_p}\K\|p$, \|p might
be \\{lig\_trick}}\6
$\|p\K\\{link}(\|p)$;\6
\4\&{until}\5
$\R\\{is\_char\_node}(\|p)$;\2\6
$\\{dvi\_h}\K\\{cur\_h}$;\6
\&{end}\6
\4\&{else} \X650:Output the non-\\{char\_node} \|p for \\{hlist\_out} and move
to the next node\X\2\par
\U647.\fi

\M649. \P$\X649:Change font \\{dvi\_f} to \|f\X\S$\6
\&{begin} \37\&{if} $\R\\{font\_used}[\|f]$ \1\&{then}\6
\&{begin} \37$\\{dvi\_font\_def}(\|f)$;\5
$\\{font\_used}[\|f]\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|f\L64+\\{font\_base}$ \1\&{then}\5
$\\{dvi\_out}(\|f-\\{font\_base}-1+\\{fnt\_num\_0})$\6
\4\&{else} \&{begin} \37$\\{dvi\_out}(\\{fnt1})$;\5
$\\{dvi\_out}(\|f-\\{font\_base}-1)$;\6
\&{end};\2\6
$\\{dvi\_f}\K\|f$;\6
\&{end}\par
\U648.\fi

\M650. \P$\X650:Output the non-\\{char\_node} \|p for \\{hlist\_out} and move
to the next node\X\S$\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node}$: \37\X651:Output a box in an hlist\X;\6
\4\\{rule\_node}: \37\&{begin} \37$\\{rule\_ht}\K\\{height}(\|p)$;\5
$\\{rule\_dp}\K\\{depth}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|p)$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1614:Output the whatsit node \|p in an hlist\X;\6
\4\\{glue\_node}: \37\X653:Move right or output leaders\X;\6
\4$\\{margin\_kern\_node},\39\\{kern\_node}$: \37$\\{cur\_h}\K\\{cur\_h}+%
\\{width}(\|p)$;\6
\4\\{math\_node}: \37\X1716:Handle a math node in \\{hlist\_out}\X;\6
\4\\{ligature\_node}: \37\X826:Make node \|p look like a \\{char\_node} and %
\&{goto} \\{reswitch}\X;\6
\X1720:Cases of \\{hlist\_out} that arise in mixed direction text only\X\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{goto} \37\\{next\_p};\6
\4\\{fin\_rule}: \37\X652:Output a rule in an hlist\X;\6
\4\\{move\_past}: \37$\\{cur\_h}\K\\{cur\_h}+\\{rule\_wd}$;\6
\4\\{next\_p}: \37$\\{prev\_p}\K\|p$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U648.\fi

\M651. \P$\X651:Output a box in an hlist\X\S$\6
\&{if} $\\{list\_ptr}(\|p)=\\{null}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{width}(\|p)$\6
\4\&{else} \&{begin} \37$\\{save\_h}\K\\{dvi\_h}$;\5
$\\{save\_v}\K\\{dvi\_v}$;\5
$\\{cur\_v}\K\\{base\_line}+\\{shift\_amount}(\|p)$;\C{shift the box down}\6
$\\{temp\_ptr}\K\|p$;\5
$\\{edge}\K\\{cur\_h}+\\{width}(\|p)$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{edge}$;\2\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{vlist\_out}\ \&{else} \\{hlist\_out};\2\6
$\\{dvi\_h}\K\\{save\_h}$;\5
$\\{dvi\_v}\K\\{save\_v}$;\5
$\\{cur\_h}\K\\{edge}$;\5
$\\{cur\_v}\K\\{base\_line}$;\6
\&{end}\2\par
\U650.\fi

\M652. \P$\X652:Output a rule in an hlist\X\S$\6
\&{if} $\\{is\_running}(\\{rule\_ht})$ \1\&{then}\5
$\\{rule\_ht}\K\\{height}(\\{this\_box})$;\2\6
\&{if} $\\{is\_running}(\\{rule\_dp})$ \1\&{then}\5
$\\{rule\_dp}\K\\{depth}(\\{this\_box})$;\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{rule\_dp}$;\C{this is the rule thickness}\6
\&{if} $(\\{rule\_ht}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\C{we don't output empty
rules}\6
\&{begin} \37\\{synch\_h};\5
$\\{cur\_v}\K\\{base\_line}+\\{rule\_dp}$;\5
\\{synch\_v};\5
$\\{dvi\_out}(\\{set\_rule})$;\5
$\\{dvi\_four}(\\{rule\_ht})$;\5
$\\{dvi\_four}(\\{rule\_wd})$;\5
$\\{cur\_v}\K\\{base\_line}$;\5
$\\{dvi\_h}\K\\{dvi\_h}+\\{rule\_wd}$;\6
\&{end}\2\par
\U650.\fi

\M653. \P\D \37$\\{billion}\S\\{float\_constant}(1000000000)$\par
\P\D \37$\\{vet\_glue}(\#)\S\\{glue\_temp}\K\#$;\6
\&{if} $\\{glue\_temp}>\\{billion}$ \1\&{then}\5
$\\{glue\_temp}\K\\{billion}$\6
\4\&{else} \&{if} $\\{glue\_temp}<-\\{billion}$ \1\&{then}\5
$\\{glue\_temp}\K-\\{billion}$\2\2\par
\P\D \37$\\{round\_glue}\S\|g\K\\{glue\_ptr}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|g)-\\{cur\_g}$;\6
\&{if} $\\{g\_sign}\I\\{normal}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{g\_sign}=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}+\\{stretch}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{shrink\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}-\\{shrink}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\2\6
\&{end};\2\6
$\\{rule\_wd}\K\\{rule\_wd}+\\{cur\_g}$\par
\Y\P$\4\X653:Move right or output leaders\X\S$\6
\&{begin} \37\\{round\_glue};\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1699:Handle a glue node for mixed direction typesetting\X;\2\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\X654:Output leaders in an hlist, \&{goto} \\{fin\_rule} if a rule or to %
\\{next\_p} if done\X;\2\6
\&{goto} \37\\{move\_past};\6
\&{end}\par
\U650.\fi

\M654. \P$\X654:Output leaders in an hlist, \&{goto} \\{fin\_rule} if a rule or
to \\{next\_p} if done\X\S$\6
\&{begin} \37$\\{leader\_box}\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{rule\_node}$ \1\&{then}\6
\&{begin} \37$\\{rule\_ht}\K\\{height}(\\{leader\_box})$;\5
$\\{rule\_dp}\K\\{depth}(\\{leader\_box})$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\2\6
$\\{leader\_wd}\K\\{width}(\\{leader\_box})$;\6
\&{if} $(\\{leader\_wd}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\6
\&{begin} \37$\\{rule\_wd}\K\\{rule\_wd}+10$;\C{compensate for floating-point
rounding}\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}-10$;\2\6
$\\{edge}\K\\{cur\_h}+\\{rule\_wd}$;\5
$\\{lx}\K0$;\5
\X655:Let \\{cur\_h} be the position of the first box, and set $\\{leader\_wd}+%
\\{lx}$ to the spacing between corresponding parts of boxes\X;\6
\&{while} $\\{cur\_h}+\\{leader\_wd}\L\\{edge}$ \1\&{do}\5
\X656:Output a leader box at \\{cur\_h}, then advance \\{cur\_h} by $\\{leader%
\_wd}+\\{lx}$\X;\2\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{edge}$\6
\4\&{else} $\\{cur\_h}\K\\{edge}-10$;\2\6
\&{goto} \37\\{next\_p};\6
\&{end};\2\6
\&{end}\par
\U653.\fi

\M655. The calculations related to leaders require a bit of care. First, in the
case of \\{a\_leaders} (aligned leaders), we want to move \\{cur\_h} to
\\{left\_edge} plus the smallest multiple of \\{leader\_wd} for which the
result
is not less than the current value of \\{cur\_h}; i.e., \\{cur\_h} should
become
$\\{left\_edge}+\\{leader\_wd}\times\lceil
(\\{cur\_h}-\\{left\_edge})/\\{leader\_wd}\rceil$.  The program here should
work in
all cases even though some implementations of \PASCAL\ give nonstandard
results for the $\mathbin{\&{div}}$ operation when \\{cur\_h} is less than %
\\{left\_edge}.

In the case of \\{c\_leaders} (centered leaders), we want to increase \\{cur%
\_h}
by half of the excess space not occupied by the leaders; and in the
case of \\{x\_leaders} (expanded leaders) we increase \\{cur\_h}
by $1/(q+1)$ of this excess space, where $q$ is the number of times the
leader box will be replicated. Slight inaccuracies in the division might
accumulate; half of this rounding error is placed at each end of the leaders.

\Y\P$\4\X655:Let \\{cur\_h} be the position of the first box, and set $%
\\{leader\_wd}+\\{lx}$ to the spacing between corresponding parts of boxes\X\S$%
\6
\&{if} $\\{subtype}(\|p)=\\{a\_leaders}$ \1\&{then}\6
\&{begin} \37$\\{save\_h}\K\\{cur\_h}$;\5
$\\{cur\_h}\K\\{left\_edge}+\\{leader\_wd}\ast((\\{cur\_h}-\\{left\_edge})%
\mathbin{\&{div}}\\{leader\_wd})$;\6
\&{if} $\\{cur\_h}<\\{save\_h}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{leader\_wd}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{lq}\K\\{rule\_wd}\mathbin{\&{div}}\\{leader\_wd}$;%
\C{the number of box copies}\6
$\\{lr}\K\\{rule\_wd}\mathbin{\&{mod}}\\{leader\_wd}$;\C{the remaining space}\6
\&{if} $\\{subtype}(\|p)=\\{c\_leaders}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+(\\{lr}\mathbin{\&{div}}2)$\6
\4\&{else} \&{begin} \37$\\{lx}\K\\{lr}\mathbin{\&{div}}(\\{lq}+1)$;\5
$\\{cur\_h}\K\\{cur\_h}+((\\{lr}-(\\{lq}-1)\ast\\{lx})\mathbin{\&{div}}2)$;\6
\&{end};\2\6
\&{end}\2\par
\Us654\ET736.\fi

\M656. The `\\{synch}' operations here are intended to decrease the number of
bytes needed to specify horizontal and vertical motion in the \.{DVI} output.

\Y\P$\4\X656:Output a leader box at \\{cur\_h}, then advance \\{cur\_h} by $%
\\{leader\_wd}+\\{lx}$\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{base\_line}+\\{shift\_amount}(\\{leader\_box})$;\5
\\{synch\_v};\5
$\\{save\_v}\K\\{dvi\_v}$;\6
\\{synch\_h};\5
$\\{save\_h}\K\\{dvi\_h}$;\5
$\\{temp\_ptr}\K\\{leader\_box}$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{leader\_wd}$;\2\6
$\\{outer\_doing\_leaders}\K\\{doing\_leaders}$;\5
$\\{doing\_leaders}\K\\{true}$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{vlist\_node}$ \1\&{then}\5
\\{vlist\_out}\ \&{else} \\{hlist\_out};\2\6
$\\{doing\_leaders}\K\\{outer\_doing\_leaders}$;\5
$\\{dvi\_v}\K\\{save\_v}$;\5
$\\{dvi\_h}\K\\{save\_h}$;\5
$\\{cur\_v}\K\\{base\_line}$;\5
$\\{cur\_h}\K\\{save\_h}+\\{leader\_wd}+\\{lx}$;\6
\&{end}\par
\U654.\fi

\M657. The \\{vlist\_out} routine is similar to \\{hlist\_out}, but a bit
simpler.

\Y\P\4\&{procedure}\1\  \37\\{vlist\_out};\C{output a \\{vlist\_node} box}\6
\4\&{label} \37$\\{move\_past},\39\\{fin\_rule},\39\\{next\_p}$;\6
\4\&{var} \37\\{left\_edge}: \37\\{scaled};\C{the left coordinate for this box}%
\6
\\{top\_edge}: \37\\{scaled};\C{the top coordinate for this box}\6
$\\{save\_h},\39\\{save\_v}$: \37\\{scaled};\C{what \\{dvi\_h} and \\{dvi\_v}
should pop to}\6
\\{this\_box}: \37\\{pointer};\C{pointer to containing box}\6
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\|p: \37\\{pointer};\C{current position in the vlist}\6
\\{save\_loc}: \37\\{integer};\C{\.{DVI} byte location upon entry}\6
\\{leader\_box}: \37\\{pointer};\C{the leader box being replicated}\6
\\{leader\_ht}: \37\\{scaled};\C{height of leader box being replicated}\6
\\{lx}: \37\\{scaled};\C{extra space between leader boxes}\6
\\{outer\_doing\_leaders}: \37\\{boolean};\C{were we doing leaders?}\6
\\{edge}: \37\\{scaled};\C{bottom boundary of leader space}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
\\{cur\_glue}: \37\\{real};\C{glue seen so far}\6
\\{cur\_g}: \37\\{scaled};\C{rounded equivalent of \\{cur\_glue} times the glue
ratio}\2\6
\&{begin} \37$\\{cur\_g}\K0$;\5
$\\{cur\_glue}\K\\{float\_constant}(0)$;\5
$\\{this\_box}\K\\{temp\_ptr}$;\5
$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\5
$\|p\K\\{list\_ptr}(\\{this\_box})$;\5
$\\{incr}(\\{cur\_s})$;\6
\&{if} $\\{cur\_s}>0$ \1\&{then}\5
$\\{dvi\_out}(\\{push})$;\2\6
\&{if} $\\{cur\_s}>\\{max\_push}$ \1\&{then}\5
$\\{max\_push}\K\\{cur\_s}$;\2\6
$\\{save\_loc}\K\\{dvi\_offset}+\\{dvi\_ptr}$;\5
$\\{left\_edge}\K\\{cur\_h}$;\5
$\\{cur\_v}\K\\{cur\_v}-\\{height}(\\{this\_box})$;\5
$\\{top\_edge}\K\\{cur\_v}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X658:Output node \|p for \\{vlist\_out} and move to the next node, maintaining
the condition $\\{cur\_h}=\\{left\_edge}$\X;\2\6
$\\{prune\_movements}(\\{save\_loc})$;\6
\&{if} $\\{cur\_s}>0$ \1\&{then}\5
$\\{dvi\_pop}(\\{save\_loc})$;\2\6
$\\{decr}(\\{cur\_s})$;\6
\&{end};\par
\fi

\M658. \P$\X658:Output node \|p for \\{vlist\_out} and move to the next node,
maintaining the condition $\\{cur\_h}=\\{left\_edge}$\X\S$\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{confusion}(\.{"vlistout"})$\6
\4\&{else} \X659:Output the non-\\{char\_node} \|p for \\{vlist\_out}\X;\2\6
\4\\{next\_p}: \37$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U657.\fi

\M659. \P$\X659:Output the non-\\{char\_node} \|p for \\{vlist\_out}\X\S$\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node}$: \37\X660:Output a box in a vlist\X;\6
\4\\{rule\_node}: \37\&{begin} \37$\\{rule\_ht}\K\\{height}(\|p)$;\5
$\\{rule\_dp}\K\\{depth}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|p)$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1613:Output the whatsit node \|p in a vlist\X;\6
\4\\{glue\_node}: \37\X662:Move down or output leaders\X;\6
\4\\{kern\_node}: \37$\\{cur\_v}\K\\{cur\_v}+\\{width}(\|p)$;\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{goto} \37\\{next\_p};\6
\4\\{fin\_rule}: \37\X661:Output a rule in a vlist, \&{goto} \\{next\_p}\X;\6
\4\\{move\_past}: \37$\\{cur\_v}\K\\{cur\_v}+\\{rule\_ht}$;\6
\&{end}\par
\U658.\fi

\M660. The \\{synch\_v} here allows the \.{DVI} output to use one-byte commands
for adjusting \|v in most cases, since the baselineskip distance will
usually be constant.

\Y\P$\4\X660:Output a box in a vlist\X\S$\6
\&{if} $\\{list\_ptr}(\|p)=\\{null}$ \1\&{then}\5
$\\{cur\_v}\K\\{cur\_v}+\\{height}(\|p)+\\{depth}(\|p)$\6
\4\&{else} \&{begin} \37$\\{cur\_v}\K\\{cur\_v}+\\{height}(\|p)$;\5
\\{synch\_v};\5
$\\{save\_h}\K\\{dvi\_h}$;\5
$\\{save\_v}\K\\{dvi\_v}$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{left\_edge}-\\{shift\_amount}(\|p)$\6
\4\&{else} $\\{cur\_h}\K\\{left\_edge}+\\{shift\_amount}(\|p)$;\C{shift the box
right}\2\6
$\\{temp\_ptr}\K\|p$;\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{vlist\_out}\ \&{else} \\{hlist\_out};\2\6
$\\{dvi\_h}\K\\{save\_h}$;\5
$\\{dvi\_v}\K\\{save\_v}$;\5
$\\{cur\_v}\K\\{save\_v}+\\{depth}(\|p)$;\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end}\2\par
\U659.\fi

\M661. \P$\X661:Output a rule in a vlist, \&{goto} \\{next\_p}\X\S$\6
\&{if} $\\{is\_running}(\\{rule\_wd})$ \1\&{then}\5
$\\{rule\_wd}\K\\{width}(\\{this\_box})$;\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{rule\_dp}$;\C{this is the rule thickness}\6
$\\{cur\_v}\K\\{cur\_v}+\\{rule\_ht}$;\6
\&{if} $(\\{rule\_ht}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\C{we don't output empty
rules}\6
\&{begin} \37\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}-\\{rule\_wd}$;\2\6
\\{synch\_h};\5
\\{synch\_v};\5
$\\{dvi\_out}(\\{put\_rule})$;\5
$\\{dvi\_four}(\\{rule\_ht})$;\5
$\\{dvi\_four}(\\{rule\_wd})$;\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end};\2\6
\&{goto} \37\\{next\_p}\par
\U659.\fi

\M662. \P$\X662:Move down or output leaders\X\S$\6
\&{begin} \37$\|g\K\\{glue\_ptr}(\|p)$;\5
$\\{rule\_ht}\K\\{width}(\|g)-\\{cur\_g}$;\6
\&{if} $\\{g\_sign}\I\\{normal}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{g\_sign}=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}+\\{stretch}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{shrink\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}-\\{shrink}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\2\6
\&{end};\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{cur\_g}$;\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\X663:Output leaders in a vlist, \&{goto} \\{fin\_rule} if a rule or to \\{next%
\_p} if done\X;\2\6
\&{goto} \37\\{move\_past};\6
\&{end}\par
\U659.\fi

\M663. \P$\X663:Output leaders in a vlist, \&{goto} \\{fin\_rule} if a rule or
to \\{next\_p} if done\X\S$\6
\&{begin} \37$\\{leader\_box}\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{rule\_node}$ \1\&{then}\6
\&{begin} \37$\\{rule\_wd}\K\\{width}(\\{leader\_box})$;\5
$\\{rule\_dp}\K0$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\2\6
$\\{leader\_ht}\K\\{height}(\\{leader\_box})+\\{depth}(\\{leader\_box})$;\6
\&{if} $(\\{leader\_ht}>0)\W(\\{rule\_ht}>0)$ \1\&{then}\6
\&{begin} \37$\\{rule\_ht}\K\\{rule\_ht}+10$;\C{compensate for floating-point
rounding}\6
$\\{edge}\K\\{cur\_v}+\\{rule\_ht}$;\5
$\\{lx}\K0$;\5
\X664:Let \\{cur\_v} be the position of the first box, and set $\\{leader\_ht}+%
\\{lx}$ to the spacing between corresponding parts of boxes\X;\6
\&{while} $\\{cur\_v}+\\{leader\_ht}\L\\{edge}$ \1\&{do}\5
\X665:Output a leader box at \\{cur\_v}, then advance \\{cur\_v} by $\\{leader%
\_ht}+\\{lx}$\X;\2\6
$\\{cur\_v}\K\\{edge}-10$;\5
\&{goto} \37\\{next\_p};\6
\&{end};\2\6
\&{end}\par
\U662.\fi

\M664. \P$\X664:Let \\{cur\_v} be the position of the first box, and set $%
\\{leader\_ht}+\\{lx}$ to the spacing between corresponding parts of boxes\X\S$%
\6
\&{if} $\\{subtype}(\|p)=\\{a\_leaders}$ \1\&{then}\6
\&{begin} \37$\\{save\_v}\K\\{cur\_v}$;\5
$\\{cur\_v}\K\\{top\_edge}+\\{leader\_ht}\ast((\\{cur\_v}-\\{top\_edge})%
\mathbin{\&{div}}\\{leader\_ht})$;\6
\&{if} $\\{cur\_v}<\\{save\_v}$ \1\&{then}\5
$\\{cur\_v}\K\\{cur\_v}+\\{leader\_ht}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{lq}\K\\{rule\_ht}\mathbin{\&{div}}\\{leader\_ht}$;%
\C{the number of box copies}\6
$\\{lr}\K\\{rule\_ht}\mathbin{\&{mod}}\\{leader\_ht}$;\C{the remaining space}\6
\&{if} $\\{subtype}(\|p)=\\{c\_leaders}$ \1\&{then}\5
$\\{cur\_v}\K\\{cur\_v}+(\\{lr}\mathbin{\&{div}}2)$\6
\4\&{else} \&{begin} \37$\\{lx}\K\\{lr}\mathbin{\&{div}}(\\{lq}+1)$;\5
$\\{cur\_v}\K\\{cur\_v}+((\\{lr}-(\\{lq}-1)\ast\\{lx})\mathbin{\&{div}}2)$;\6
\&{end};\2\6
\&{end}\2\par
\Us663\ET745.\fi

\M665. When we reach this part of the program, \\{cur\_v} indicates the top of
a
leader box, not its baseline.

\Y\P$\4\X665:Output a leader box at \\{cur\_v}, then advance \\{cur\_v} by $%
\\{leader\_ht}+\\{lx}$\X\S$\6
\&{begin} \37\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{left\_edge}-\\{shift\_amount}(\\{leader\_box})$\6
\4\&{else} $\\{cur\_h}\K\\{left\_edge}+\\{shift\_amount}(\\{leader\_box})$;\2\6
\\{synch\_h};\5
$\\{save\_h}\K\\{dvi\_h}$;\6
$\\{cur\_v}\K\\{cur\_v}+\\{height}(\\{leader\_box})$;\5
\\{synch\_v};\5
$\\{save\_v}\K\\{dvi\_v}$;\5
$\\{temp\_ptr}\K\\{leader\_box}$;\5
$\\{outer\_doing\_leaders}\K\\{doing\_leaders}$;\5
$\\{doing\_leaders}\K\\{true}$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{vlist\_node}$ \1\&{then}\5
\\{vlist\_out}\ \&{else} \\{hlist\_out};\2\6
$\\{doing\_leaders}\K\\{outer\_doing\_leaders}$;\5
$\\{dvi\_v}\K\\{save\_v}$;\5
$\\{dvi\_h}\K\\{save\_h}$;\5
$\\{cur\_h}\K\\{left\_edge}$;\5
$\\{cur\_v}\K\\{save\_v}-\\{height}(\\{leader\_box})+\\{leader\_ht}+\\{lx}$;\6
\&{end}\par
\U663.\fi

\M666. The \\{hlist\_out} and \\{vlist\_out} procedures are now complete, so we
are
ready for the \\{dvi\_ship\_out} routine that gets them started in the first
place.

\Y\P\4\&{procedure}\1\  \37$\\{dvi\_ship\_out}(\|p:\\{pointer})$;\C{output the
box \|p}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37\\{page\_loc}: \37\\{integer};\C{location of the current \\{bop}}\6
$\|j,\39\|k$: \37$0\to9$;\C{indices to first ten count registers}\6
\|s: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\6
\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{saved \\{selector} setting}\2\6
\&{begin} \37\&{if} $\\{tracing\_output}>0$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{""})$;\5
\\{print\_ln};\5
$\\{print}(\.{"Completed\ box\ being\ shipped\ out"})$;\6
\&{end};\2\6
\&{if} $\\{term\_offset}>\\{max\_print\_line}-9$ \1\&{then}\5
\\{print\_ln}\6
\4\&{else} \&{if} $(\\{term\_offset}>0)\V(\\{file\_offset}>0)$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\2\6
$\\{print\_char}(\.{"["})$;\5
$\|j\K9$;\6
\&{while} $(\\{count}(\|j)=0)\W(\|j>0)$ \1\&{do}\5
$\\{decr}(\|j)$;\2\6
\&{for} $\|k\K0\mathrel{\&{to}}\|j$ \1\&{do}\6
\&{begin} \37$\\{print\_int}(\\{count}(\|k))$;\6
\&{if} $\|k<\|j$ \1\&{then}\5
$\\{print\_char}(\.{"."})$;\2\6
\&{end};\2\6
\\{update\_terminal};\6
\&{if} $\\{tracing\_output}>0$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"]"})$;\5
\\{begin\_diagnostic};\5
$\\{show\_box}(\|p)$;\5
$\\{end\_diagnostic}(\\{true})$;\6
\&{end};\2\6
\X668:Ship box \|p out\X;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1730:Check for LR anomalies at the end of \\{ship\_out}\X;\2\6
\&{if} $\\{tracing\_output}\L0$ \1\&{then}\5
$\\{print\_char}(\.{"]"})$;\2\6
$\\{dead\_cycles}\K0$;\5
\\{update\_terminal};\C{progress report}\6
\X667:Flush the box from memory, showing statistics if requested\X;\6
\&{end};\par
\fi

\M667. \P$\X667:Flush the box from memory, showing statistics if requested\X\S$%
\6
\&{stat} \37\&{if} $\\{tracing\_stats}>1$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Memory\ usage\ before:\ "})$;\5
$\\{print\_int}(\\{var\_used})$;\5
$\\{print\_char}(\.{"\&"})$;\5
$\\{print\_int}(\\{dyn\_used})$;\5
$\\{print\_char}(\.{";"})$;\6
\&{end};\2\6
\&{tats}\6
$\\{flush\_node\_list}(\|p)$;\6
\&{stat} \37\&{if} $\\{tracing\_stats}>1$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ after:\ "})$;\5
$\\{print\_int}(\\{var\_used})$;\5
$\\{print\_char}(\.{"\&"})$;\5
$\\{print\_int}(\\{dyn\_used})$;\5
$\\{print}(\.{";\ still\ untouched:\ "})$;\5
$\\{print\_int}(\\{hi\_mem\_min}-\\{lo\_mem\_max}-1)$;\5
\\{print\_ln};\6
\&{end};\2\6
\&{tats}\par
\Us666\ET750.\fi

\M668. \P$\X668:Ship box \|p out\X\S$\6
\X669:Update the values of \\{max\_h} and \\{max\_v}; but if the page is too
large, \&{goto} \\{done}\X;\6
\X645:Initialize variables as \\{ship\_out} begins\X;\6
$\\{page\_loc}\K\\{dvi\_offset}+\\{dvi\_ptr}$;\5
$\\{dvi\_out}(\\{bop})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}9$ \1\&{do}\5
$\\{dvi\_four}(\\{count}(\|k))$;\2\6
$\\{dvi\_four}(\\{last\_bop})$;\5
$\\{last\_bop}\K\\{page\_loc}$;\5
$\\{cur\_v}\K\\{height}(\|p)+\\{v\_offset}$;\5
$\\{temp\_ptr}\K\|p$;\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{vlist\_out}\ \&{else} \\{hlist\_out};\2\6
$\\{dvi\_out}(\\{eop})$;\5
$\\{incr}(\\{total\_pages})$;\5
$\\{cur\_s}\K-1$;\6
\4\\{done}: \37\par
\U666.\fi

\M669. Sometimes the user will generate a huge page because other error
messages
are being ignored. Such pages are not output to the \.{dvi} file, since they
may confuse the printing software.

\Y\P$\4\X669:Update the values of \\{max\_h} and \\{max\_v}; but if the page is
too large, \&{goto} \\{done}\X\S$\6
\&{if} $(\\{height}(\|p)>\\{max\_dimen})\V\30(\\{depth}(\|p)>\\{max\_dimen})\V%
\30(\\{height}(\|p)+\\{depth}(\|p)+\\{v\_offset}>\\{max\_dimen})\V\30(%
\\{width}(\|p)+\\{h\_offset}>\\{max\_dimen})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Huge\ page\ cannot\ be\ shipped\ out"})$;\5
$\\{help2}(\.{"The\ page\ just\ created\ is\ more\ than\ 18\ feet\ tall\ or"})$%
\6
$(\.{"more\ than\ 18\ feet\ wide,\ so\ I\ suspect\ something\ went\ wrong."})$;%
\5
\\{error};\6
\&{if} $\\{tracing\_output}\L0$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"The\ following\ box\ has\ been\ deleted:"})$;\5
$\\{show\_box}(\|p)$;\5
$\\{end\_diagnostic}(\\{true})$;\6
\&{end};\2\6
\&{goto} \37\\{done};\6
\&{end};\2\6
\&{if} $\\{height}(\|p)+\\{depth}(\|p)+\\{v\_offset}>\\{max\_v}$ \1\&{then}\5
$\\{max\_v}\K\\{height}(\|p)+\\{depth}(\|p)+\\{v\_offset}$;\2\6
\&{if} $\\{width}(\|p)+\\{h\_offset}>\\{max\_h}$ \1\&{then}\5
$\\{max\_h}\K\\{width}(\|p)+\\{h\_offset}$\2\par
\Us668\ET751.\fi

\M670. At the end of the program, we must finish things off by writing the
post\-amble. If $\\{total\_pages}=0$, the \.{DVI} file was never opened.
If $\\{total\_pages}\G65536$, the \.{DVI} file will lie. And if
$\\{max\_push}\G65536$, the user deserves whatever chaos might ensue.

An integer variable \|k will be declared for use by this routine.

\Y\P$\4\X670:Finish the \.{DVI} file\X\S$\6
\&{while} $\\{cur\_s}>-1$ \1\&{do}\6
\&{begin} \37\&{if} $\\{cur\_s}>0$ \1\&{then}\5
$\\{dvi\_out}(\\{pop})$\6
\4\&{else} \&{begin} \37$\\{dvi\_out}(\\{eop})$;\5
$\\{incr}(\\{total\_pages})$;\6
\&{end};\2\6
$\\{decr}(\\{cur\_s})$;\6
\&{end};\2\6
\&{if} $\\{total\_pages}=0$ \1\&{then}\5
$\\{print\_nl}(\.{"No\ pages\ of\ output."})$\6
\4\&{else} \&{begin} \37$\\{dvi\_out}(\\{post})$;\C{beginning of the postamble}%
\6
$\\{dvi\_four}(\\{last\_bop})$;\5
$\\{last\_bop}\K\\{dvi\_offset}+\\{dvi\_ptr}-5$;\C{\\{post} location}\6
$\\{dvi\_four}(25400000)$;\5
$\\{dvi\_four}(473628672)$;\C{conversion ratio for sp}\6
\\{prepare\_mag};\5
$\\{dvi\_four}(\\{mag})$;\C{magnification factor}\6
$\\{dvi\_four}(\\{max\_v})$;\5
$\\{dvi\_four}(\\{max\_h})$;\6
$\\{dvi\_out}(\\{max\_push}\mathbin{\&{div}}256)$;\5
$\\{dvi\_out}(\\{max\_push}\mathbin{\&{mod}}256)$;\6
$\\{dvi\_out}((\\{total\_pages}\mathbin{\&{div}}256)\mathbin{\&{mod}}256)$;\5
$\\{dvi\_out}(\\{total\_pages}\mathbin{\&{mod}}256)$;\6
\X671:Output the font definitions for all fonts that were used\X;\6
$\\{dvi\_out}(\\{post\_post})$;\5
$\\{dvi\_four}(\\{last\_bop})$;\5
$\\{dvi\_out}(\\{id\_byte})$;\6
$\|k\K4+((\\{dvi\_buf\_size}-\\{dvi\_ptr})\mathbin{\&{mod}}4)$;\C{the number of
223's}\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{dvi\_out}(223)$;\5
$\\{decr}(\|k)$;\6
\&{end};\2\6
\X626:Empty the last bytes out of \\{dvi\_buf}\X;\6
$\\{print\_nl}(\.{"Output\ written\ on\ "})$;\5
$\\{slow\_print}(\\{output\_file\_name})$;\5
$\\{print}(\.{"\ ("})$;\5
$\\{print\_int}(\\{total\_pages})$;\5
$\\{print}(\.{"\ page"})$;\6
\&{if} $\\{total\_pages}\I1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
$\\{print}(\.{",\ "})$;\5
$\\{print\_int}(\\{dvi\_offset}+\\{dvi\_ptr})$;\5
$\\{print}(\.{"\ bytes)."})$;\5
$\\{b\_close}(\\{dvi\_file})$;\6
\&{end}\2\par
\U1513.\fi

\M671. \P$\X671:Output the font definitions for all fonts that were used\X\S$\6
\&{while} $\\{font\_ptr}>\\{font\_base}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{font\_used}[\\{font\_ptr}]$ \1\&{then}\5
$\\{dvi\_font\_def}(\\{font\_ptr})$;\2\6
$\\{decr}(\\{font\_ptr})$;\6
\&{end}\2\par
\U670.\fi

\N672.  \[32a] \pdfTeX\ basic.  Initialize \pdfTeX's parameters to some useful
default value.  Helpful in case one forgets to set them during \.{INITEX} run.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{pdf\_h\_origin}\K(\\{one\_hundred\_inch}+50)\mathbin{\&{div}}100$;\5
$\\{pdf\_v\_origin}\K(\\{one\_hundred\_inch}+50)\mathbin{\&{div}}100$;\5
$\\{pdf\_compress\_level}\K9$;\5
$\\{pdf\_objcompresslevel}\K0$;\5
$\\{pdf\_decimal\_digits}\K3$;\5
$\\{pdf\_image\_resolution}\K72$;\5
$\\{pdf\_major\_version}\K1$;\5
$\\{pdf\_minor\_version}\K4$;\5
$\\{pdf\_gamma}\K1000$;\5
$\\{pdf\_image\_gamma}\K2200$;\5
$\\{pdf\_image\_hicolor}\K1$;\5
$\\{pdf\_image\_apply\_gamma}\K0$;\5
$\\{pdf\_px\_dimen}\K\\{one\_bp}$;\5
$\\{pdf\_draftmode}\K0$;\par
\fi

\M673. The subroutines define the corresponding macros so we can use them
in C.

\Y\P\D \37$\\{flushable}(\#)\S(\#=\\{str\_ptr}-1)$\par
\P\D \37$\\{is\_valid\_char}(\#)\S((\\{font\_bc}[\|f]\L\#)\W(\#\L\\{font\_ec}[%
\|f])\W\\{char\_exists}(\\{char\_info}(\|f)(\#)))$\par
\Y\P\4\&{function}\1\  \37\\{get\_pdf\_compress\_level}: \37\\{integer};\2\6
\&{begin} \37$\\{get\_pdf\_compress\_level}\K\\{pdf\_compress\_level}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_pdf\_suppress\_warning\_dup\_map}: \37%
\\{integer};\2\6
\&{begin} \37$\\{get\_pdf\_suppress\_warning\_dup\_map}\K\\{pdf\_suppress%
\_warning\_dup\_map}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_pdf\_suppress\_warning\_page\_group}: \37%
\\{integer};\2\6
\&{begin} \37$\\{get\_pdf\_suppress\_warning\_page\_group}\K\\{pdf\_suppress%
\_warning\_page\_group}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_pdf\_suppress\_ptex\_info}: \37\\{integer};\2\6
\&{begin} \37$\\{get\_pdf\_suppress\_ptex\_info}\K\\{pdf\_suppress\_ptex%
\_info}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_pdf\_omit\_charset}: \37\\{integer};\2\6
\&{begin} \37$\\{get\_pdf\_omit\_charset}\K\\{pdf\_omit\_charset}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_ptex\_use\_underscore}: \37\\{boolean};\2\6
\&{begin} \37$\\{get\_ptex\_use\_underscore}\K(\\{pdf\_ptex\_use%
\_underscore}>0)\V(\\{pdf\_major\_version}\G2)$\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_nullfont}: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\\{get\_nullfont}\K\\{null\_font}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_fontbase}: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\\{get\_fontbase}\K\\{font\_base}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_nullcs}: \37\\{pointer};\2\6
\&{begin} \37$\\{get\_nullcs}\K\\{null\_cs}$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_nullptr}: \37\\{pointer};\2\6
\&{begin} \37$\\{get\_nullptr}\K\\{null}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_tex\_int}(\\{code}:\\{integer})$: \37%
\\{integer};\2\6
\&{begin} \37$\\{get\_tex\_int}\K\\{int\_par}(\\{code})$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_tex\_dimen}(\\{code}:\\{integer})$: \37%
\\{scaled};\2\6
\&{begin} \37$\\{get\_tex\_dimen}\K\\{dimen\_par}(\\{code})$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_x\_height}(\|f:\\{internal\_font\_number})$: \37%
\\{scaled};\2\6
\&{begin} \37$\\{get\_x\_height}\K\\{x\_height}(\|f)$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_charwidth}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{scaled};\2\6
\&{begin} \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\5
$\\{get\_charwidth}\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$\6
\4\&{else} $\\{get\_charwidth}\K0$;\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_charheight}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{scaled};\2\6
\&{begin} \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\5
$\\{get\_charheight}\K\\{char\_height}(\|f)(\\{height\_depth}(\\{char\_info}(%
\|f)(\|c)))$\6
\4\&{else} $\\{get\_charheight}\K0$;\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_chardepth}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{scaled};\2\6
\&{begin} \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\5
$\\{get\_chardepth}\K\\{char\_depth}(\|f)(\\{height\_depth}(\\{char\_info}(%
\|f)(\|c)))$\6
\4\&{else} $\\{get\_chardepth}\K0$;\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_quad}(\|f:\\{internal\_font\_number})$: \37%
\\{scaled};\2\6
\&{begin} \37$\\{get\_quad}\K\\{quad}(\|f)$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_slant}(\|f:\\{internal\_font\_number})$: \37%
\\{scaled};\2\6
\&{begin} \37$\\{get\_slant}\K\\{slant}(\|f)$;\6
\&{end};\par
\fi

\M674. Helper for debugging purposes:

\Y\P\4\&{procedure}\1\  \37$\\{short\_display\_n}(\|p,\39\|m:\\{integer})$;%
\C{prints highlights of list \|p}\6
\4\&{var} \37\|n: \37\\{integer};\C{for replacement counts}\6
\|i: \37\\{integer};\2\6
\&{begin} \37$\|i\K0$;\5
$\\{font\_in\_short\_display}\K\\{null\_font}$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{while} $\|p>\\{mem\_min}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37\&{if} $\|p\L\\{mem\_end}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{font}(\|p)\I\\{font\_in\_short\_display}$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{font}(\|p)<\\{font\_base})\V(\\{font}(\|p)>\\{font%
\_max})$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} $\\{print\_font\_identifier}(\\{font}(\|p))$;\2\6
$\\{print\_char}(\.{"\ "})$;\5
$\\{font\_in\_short\_display}\K\\{font}(\|p)$;\6
\&{end};\2\6
$\\{print\_ASCII}(\\{qo}(\\{character}(\|p)))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $(\\{type}(\|p)=\\{glue\_node})\V(\\{type}(\|p)=%
\\{disc\_node})\V(\\{type}(\|p)=\\{penalty\_node})\V((\\{type}(\|p)=\\{kern%
\_node})\W(\\{subtype}(\|p)=\\{explicit}))$ \1\&{then}\5
$\\{incr}(\|i)$;\2\6
\&{if} $\|i\G\|m$ \1\&{then}\5
\&{return};\2\6
\&{if} $(\\{type}(\|p)=\\{disc\_node})$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"|"})$;\5
$\\{short\_display}(\\{pre\_break}(\|p))$;\5
$\\{print}(\.{"|"})$;\5
$\\{short\_display}(\\{post\_break}(\|p))$;\5
$\\{print}(\.{"|"})$;\5
$\|n\K\\{replace\_count}(\|p)$;\6
\&{while} $\|n>0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{link}(\|p)\I\\{null}$ \1\&{then}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{decr}(\|n)$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \X193:Print a short indication of the contents of node \|p\X;\2\6
\&{end};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{end};\2\6
\\{update\_terminal};\6
\&{end};\par
\fi

\M675. Sometimes it is necessary to allocate memory for PDF output that cannot
be deallocated then, so we use \\{pdf\_mem} for this purpose.

\Y\P$\4\X11:Constants in the outer block\X\mathrel{+}\S$\6
$\\{inf\_pdf\_mem\_size}=10000$;\C{min size of the \\{pdf\_mem} array}\6
$\\{sup\_pdf\_mem\_size}=10000000$;\C{max size of the \\{pdf\_mem} array}\par
\fi

\M676. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_mem\_size}: \37\\{integer};\6
\4\\{pdf\_mem}: \37$\^\\{integer}$;\6
\4\\{pdf\_mem\_ptr}: \37\\{integer};\par
\fi

\M677. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pdf\_mem\_ptr}\K1$;\C{the first word is not used so we can use zero as a
value for testing whether a pointer to \\{pdf\_mem} is valid}\6
$\\{pdf\_mem\_size}\K\\{inf\_pdf\_mem\_size}$;\C{allocated size of \\{pdf\_mem}
array}\par
\fi

\M678. We use \\{pdf\_get\_mem} to allocate memory in \\{pdf\_mem}.

\Y\P\4\&{function}\1\  \37$\\{pdf\_get\_mem}(\|s:\\{integer})$: \37\\{integer};%
\C{allocate \|s words in \\{pdf\_mem}}\6
\4\&{var} \37\|a: \37\\{integer};\2\6
\&{begin} \37\&{if} $\|s>\\{sup\_pdf\_mem\_size}-\\{pdf\_mem\_ptr}$ \1\&{then}\5
$\\{overflow}(\.{"PDF\ memory\ size\ (pdf\_mem\_size)"},\39\\{pdf\_mem%
\_size})$;\2\6
\&{if} $\\{pdf\_mem\_ptr}+\|s>\\{pdf\_mem\_size}$ \1\&{then}\6
\&{begin} \37$\|a\K0.2\ast\\{pdf\_mem\_size}$;\6
\&{if} $\\{pdf\_mem\_ptr}+\|s>\\{pdf\_mem\_size}+\|a$ \1\&{then}\5
$\\{pdf\_mem\_size}\K\\{pdf\_mem\_ptr}+\|s$\6
\4\&{else} \&{if} $\\{pdf\_mem\_size}<\\{sup\_pdf\_mem\_size}-\|a$ \1\&{then}\5
$\\{pdf\_mem\_size}\K\\{pdf\_mem\_size}+\|a$\6
\4\&{else} $\\{pdf\_mem\_size}\K\\{sup\_pdf\_mem\_size}$;\2\2\6
$\\{pdf\_mem}\K\\{xrealloc\_array}(\\{pdf\_mem},\39\\{integer},\39\\{pdf\_mem%
\_size})$;\6
\&{end};\2\6
$\\{pdf\_get\_mem}\K\\{pdf\_mem\_ptr}$;\5
$\\{pdf\_mem\_ptr}\K\\{pdf\_mem\_ptr}+\|s$;\6
\&{end};\par
\fi

\N679.  \[32b] \pdfTeX\ output low-level subroutines.
We use the similar subroutines to handle the output buffer for
PDF output. When compress is used, the state of writing to buffer
is held in \\{zip\_write\_state}. We must write the header of PDF
output file in initialization to ensure that it will be the first
written bytes.

\Y\P$\4\X11:Constants in the outer block\X\mathrel{+}\S$\6
$\\{pdf\_op\_buf\_size}=16384$;\C{size of the PDF output buffer}\6
$\\{inf\_pdf\_os\_buf\_size}=1$;\C{initial value of \\{pdf\_os\_buf\_size}}\6
$\\{sup\_pdf\_os\_buf\_size}=5000000$;\C{arbitrary upper hard limit of \\{pdf%
\_os\_buf\_size}}\6
$\\{pdf\_os\_max\_objs}=100$;\C{maximum number of objects in object stream}\par
\fi

\M680. The following macros are similar as for \.{DVI} buffer handling:

\Y\P\D \37$\\{pdf\_offset}\S(\\{pdf\_gone}+\\{pdf\_ptr})$\C{the file offset of
last byte in PDF buffer that \\{pdf\_ptr} points to}\par
\P\D \37$\\{no\_zip}\S0$\C{no \.{ZIP} compression}\par
\P\D \37$\\{zip\_writing}\S1$\C{\.{ZIP} compression being used}\par
\P\D \37$\\{zip\_finish}\S2$\C{finish \.{ZIP} compression}\par
\P\D \37$\\{pdf\_quick\_out}(\#)\S$\C{output a byte to PDF buffer without
checking of overflow}\6
\&{begin} \37$\\{pdf\_buf}[\\{pdf\_ptr}]\K\#$;\5
$\\{incr}(\\{pdf\_ptr})$;\6
\&{end}\par
\P\D \37$\\{pdf\_room}(\#)\S$\C{make sure that there are at least \|n bytes
free in PDF buffer}\6
\&{begin} \37\&{if} $\\{pdf\_os\_mode}\W(\#+\\{pdf\_ptr}>\\{pdf\_buf\_size})$ %
\1\&{then}\5
$\\{pdf\_os\_get\_os\_buf}(\#)$\6
\4\&{else} \&{if} $\R\\{pdf\_os\_mode}\W(\#>\\{pdf\_buf\_size})$ \1\&{then}\5
$\\{overflow}(\.{"PDF\ output\ buffer"},\39\\{pdf\_op\_buf\_size})$\6
\4\&{else} \&{if} $\R\\{pdf\_os\_mode}\W(\#+\\{pdf\_ptr}>\\{pdf\_buf\_size})$ %
\1\&{then}\5
\\{pdf\_flush};\2\2\2\6
\&{end}\par
\P\D \37$\\{pdf\_out}(\#)\S$\C{do the same as \\{pdf\_quick\_out} and flush the
PDF buffer if necessary}\6
\&{begin} \37$\\{pdf\_room}(1)$;\5
$\\{pdf\_quick\_out}(\#)$;\6
\&{end}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_file}: \37\\{byte\_file};\C{the PDF output file}\6
\4\\{pdf\_buf}: \37$\^\\{eight\_bits}$;\C{pointer to the PDF output buffer or
PDF object stream buffer}\6
\4\\{pdf\_buf\_size}: \37\\{integer};\C{end of PDF output buffer or PDF object
stream buffer}\6
\4\\{pdf\_ptr}: \37\\{integer};\C{pointer to the first unused byte in the PDF
buffer or object stream buffer}\6
\4\\{pdf\_op\_buf}: \37$\^\\{eight\_bits}$;\C{the PDF output buffer}\6
\4\\{pdf\_os\_buf}: \37$\^\\{eight\_bits}$;\C{the PDF object stream buffer}\6
\4\\{pdf\_os\_buf\_size}: \37\\{integer};\C{current size of the PDF object
stream buffer, grows dynamically}\6
\4\\{pdf\_os\_objnum}: \37$\^\\{integer}$;\C{array of object numbers within
object stream}\6
\4\\{pdf\_os\_objoff}: \37$\^\\{integer}$;\C{array of object offsets within
object stream}\6
\4\\{pdf\_os\_objidx}: \37\\{pointer};\C{pointer into \\{pdf\_os\_objnum} and %
\\{pdf\_os\_objoff}}\6
\4\\{pdf\_os\_cntr}: \37\\{integer};\C{counter for object stream objects}\6
\4\\{pdf\_op\_ptr}: \37\\{integer};\C{store for PDF buffer \\{pdf\_ptr} while
inside object streams}\6
\4\\{pdf\_os\_ptr}: \37\\{integer};\C{store for object stream \\{pdf\_ptr}
while outside object streams}\6
\4\\{pdf\_os\_mode}: \37\\{boolean};\C{true if producing object stream}\6
\4\\{pdf\_os\_enable}: \37\\{boolean};\C{true if object streams are globally
enabled}\6
\4\\{pdf\_os\_cur\_objnum}: \37\\{integer};\C{number of current object stream
object}\6
\4\\{pdf\_gone}: \37\\{longinteger};\C{number of bytes that were flushed to
output}\6
\4\\{pdf\_save\_offset}: \37\\{longinteger};\C{to save \\{pdf\_offset}}\6
\4\\{zip\_write\_state}: \37\\{integer};\C{which state of compression we are
in}\6
\4\\{fixed\_pdf\_major\_version}: \37\\{integer};\C{fixed major part of the PDF
version}\6
\4\\{fixed\_pdf\_minor\_version}: \37\\{integer};\C{fixed minor part of the PDF
version}\6
\4\\{fixed\_pdf\_objcompresslevel}: \37\\{integer};\C{fixed level for
activating PDF object streams}\6
\4\\{pdf\_version\_written}: \37\\{boolean};\C{flag if the PDF version has been
written}\6
\4\\{fixed\_pdfoutput}: \37\\{integer};\C{fixed output format}\6
\4\\{fixed\_pdfoutput\_set}: \37\\{boolean};\C{\\{fixed\_pdfoutput} has been
set?}\6
\4\\{fixed\_gamma}: \37\\{integer};\6
\4\\{fixed\_image\_gamma}: \37\\{integer};\6
\4\\{fixed\_image\_hicolor}: \37\\{boolean};\6
\4\\{fixed\_image\_apply\_gamma}: \37\\{integer};\6
\4\\{epochseconds}: \37\\{integer};\6
\4\\{microseconds}: \37\\{integer};\6
\4\\{fixed\_pdf\_draftmode}: \37\\{integer};\C{fixed \\pdfdraftmode}\6
\4\\{fixed\_pdf\_draftmode\_set}: \37\\{boolean};\C{\\{fixed\_pdf\_draftmode}
has been set?}\6
\4\\{pdf\_page\_group\_val}: \37\\{integer};\par
\fi

\M681. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pdf\_gone}\K0$;\5
$\\{pdf\_os\_mode}\K\\{false}$;\5
$\\{pdf\_ptr}\K0$;\5
$\\{pdf\_op\_ptr}\K0$;\5
$\\{pdf\_os\_ptr}\K0$;\5
$\\{pdf\_os\_cur\_objnum}\K0$;\5
$\\{pdf\_os\_cntr}\K0$;\5
$\\{pdf\_buf\_size}\K\\{pdf\_op\_buf\_size}$;\5
$\\{pdf\_os\_buf\_size}\K\\{inf\_pdf\_os\_buf\_size}$;\5
$\\{pdf\_buf}\K\\{pdf\_op\_buf}$;\5
$\\{pdf\_seek\_write\_length}\K\\{false}$;\5
$\\{zip\_write\_state}\K\\{no\_zip}$;\5
$\\{pdf\_version\_written}\K\\{false}$;\5
$\\{fixed\_pdfoutput\_set}\K\\{false}$;\5
$\\{fixed\_pdf\_draftmode\_set}\K\\{false}$;\par
\fi

\M682. \P\6
\4\&{function}\1\  \37$\\{fix\_int}(\\{val},\39\\{min},\39\\{max}:%
\\{integer})$: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{val}<\\{min}$ \1\&{then}\5
$\\{fix\_int}\K\\{min}$\6
\4\&{else} \&{if} $\\{val}>\\{max}$ \1\&{then}\5
$\\{fix\_int}\K\\{max}$\6
\4\&{else} $\\{fix\_int}\K\\{val}$;\2\2\6
\&{end};\par
\fi

\M683. This ensures that \\{pdf\_major\_version} and \\{pdf\_minor\_version}
are set
to reasonable values before any bytes have been written to the generated
PDF file. We also save their current values in case the user tries to
change them later, along with \\{pdf\_objcompresslevel},
\\{pdf\_image\_hicolor}, and various other parameters that must be fixed
before any PDF output happens.

Here also the PDF file is opened by \\{ensure\_pdf\_open} and the PDF header
is written.

\Y\P\4\&{procedure}\1\  \37\\{check\_pdfversion};\2\6
\&{begin} \37\&{if} $\R\\{pdf\_version\_written}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_version\_written}\K\\{true}$;\6
\&{if} $\\{pdf\_major\_version}<1$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"pdfTeX\ error\ (invalid\ pdfmajorversion)"})$;%
\5
\\{print\_ln};\5
$\\{help2}(\.{"The\ pdfmajorversion\ must\ be\ 1\ or\ greater."})$\6
$(\.{"I\ changed\ this\ to\ 1."})$;\5
$\\{int\_error}(\\{pdf\_major\_version})$;\5
$\\{pdf\_major\_version}\K1$;\6
\&{end};\2\6
\&{if} $(\\{pdf\_minor\_version}<0)\V(\\{pdf\_minor\_version}>9)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"pdfTeX\ error\ (invalid\ pdfminorversion)"})$;%
\5
\\{print\_ln};\5
$\\{help2}(\.{"The\ pdfminorversion\ must\ be\ between\ 0\ and\ 9."})$\6
$(\.{"I\ changed\ this\ to\ 4."})$;\5
$\\{int\_error}(\\{pdf\_minor\_version})$;\5
$\\{pdf\_minor\_version}\K4$;\6
\&{end};\2\6
$\\{fixed\_pdf\_major\_version}\K\\{pdf\_major\_version}$;\5
$\\{fixed\_pdf\_minor\_version}\K\\{pdf\_minor\_version}$;\5
$\\{fixed\_gamma}\K\\{fix\_int}(\\{pdf\_gamma},\390,\391000000)$;\5
$\\{fixed\_image\_gamma}\K\\{fix\_int}(\\{pdf\_image\_gamma},\390,\391000000)$;%
\5
$\\{fixed\_image\_hicolor}\K\\{fix\_int}(\\{pdf\_image\_hicolor},\390,\391)$;\5
$\\{fixed\_image\_apply\_gamma}\K\\{fix\_int}(\\{pdf\_image\_apply\_gamma},%
\390,\391)$;\5
$\\{fixed\_pdf\_objcompresslevel}\K\\{fix\_int}(\\{pdf\_objcompresslevel},\390,%
\393)$;\5
$\\{fixed\_pdf\_draftmode}\K\\{fix\_int}(\\{pdf\_draftmode},\390,\391)$;\5
$\\{fixed\_inclusion\_copy\_font}\K\\{fix\_int}(\\{pdf\_inclusion\_copy\_font},%
\390,\391)$;\6
\&{if} $((\\{fixed\_pdf\_major\_version}>1)\V(\\{fixed\_pdf\_minor\_version}%
\G5))\W(\\{fixed\_pdf\_objcompresslevel}>0)$ \1\&{then}\5
$\\{pdf\_os\_enable}\K\\{true}$\6
\4\&{else} \&{begin} \37\&{if} $\\{fixed\_pdf\_objcompresslevel}>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"Object\ streams"},\39\.{"%
\\pdfobjcompresslevel\ >\ 0\ requires\ PDF-1.5\ or\ greater.\ Object\ streams\
disabled\ now."},\39\\{true},\39\\{true})$;\5
$\\{fixed\_pdf\_objcompresslevel}\K0$;\6
\&{end};\2\6
$\\{pdf\_os\_enable}\K\\{false}$;\6
\&{end};\2\6
\\{ensure\_pdf\_open};\5
\\{fix\_pdfoutput};\5
$\\{pdf\_print}(\.{"\%PDF-"})$;\5
$\\{pdf\_print\_int}(\\{fixed\_pdf\_major\_version})$;\5
$\\{pdf\_print}(\.{"."})$;\5
$\\{pdf\_print\_int\_ln}(\\{fixed\_pdf\_minor\_version})$;\5
$\\{pdf\_print}(\.{"\%"})$;\5
$\\{pdf\_out}(208)$;\C{'P' + 128}\6
$\\{pdf\_out}(212)$;\C{'T' + 128}\6
$\\{pdf\_out}(197)$;\C{'E' + 128}\6
$\\{pdf\_out}(216)$;\C{'X' + 128}\6
\\{pdf\_print\_nl};\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $(\\{fixed\_pdf\_minor\_version}\I\\{pdf\_minor%
\_version})\V(\\{fixed\_pdf\_major\_version}\I\\{pdf\_major\_version})$ \1%
\&{then}\5
$\\{pdf\_error}(\.{"setup"},\39\.{"PDF\ version\ cannot\ be\ changed\ after\
data\ is\ written\ to\ the\ PDF\ file"})$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M684. Checks that we have a name for the generated PDF file and that it's
open.

\Y\P\4\&{procedure}\1\  \37\\{ensure\_pdf\_open};\2\6
\&{begin} \37\&{if} $\\{output\_file\_name}\I0$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\2\6
$\\{pack\_job\_name}(\.{".pdf"})$;\6
\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\6
\&{while} $\R\\{b\_open\_out}(\\{pdf\_file})$ \1\&{do}\5
$\\{prompt\_file\_name}(\.{"file\ name\ for\ output"},\39\.{".pdf"})$;\2\2\6
$\\{output\_file\_name}\K\\{b\_make\_name\_string}(\\{pdf\_file})$;\6
\&{end};\par
\fi

\M685. The PDF buffer is flushed by calling \\{pdf\_flush}, which checks the
variable \\{zip\_write\_state} and will compress the buffer before flushing if
necessary. We call \\{pdf\_begin\_stream} to begin a stream  and \\{pdf\_end%
\_stream}
to finish it. The stream contents will be compressed if compression is turn on.

\Y\P\4\&{procedure}\1\  \37\\{pdf\_flush};\C{flush out the \\{pdf\_buf}}\6
\4\&{var} \37\\{saved\_pdf\_gone}: \37\\{longinteger};\2\6
\&{begin} \37\&{if} $\R\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37$\\{saved\_pdf\_gone}\K\\{pdf\_gone}$;\6
\&{case} $\\{zip\_write\_state}$ \1\&{of}\6
\4\\{no\_zip}: \37\&{if} $\\{pdf\_ptr}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\5
$\\{write\_pdf}(0,\39\\{pdf\_ptr}-1)$;\2\6
$\\{pdf\_gone}\K\\{pdf\_gone}+\\{pdf\_ptr}$;\5
$\\{pdf\_last\_byte}\K\\{pdf\_buf}[\\{pdf\_ptr}-1]$;\6
\&{end};\2\6
\4\\{zip\_writing}: \37\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\5
$\\{write\_zip}(\\{false})$;\2\6
\4\\{zip\_finish}: \37\&{begin} \37\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1%
\&{then}\5
$\\{write\_zip}(\\{true})$;\2\6
$\\{zip\_write\_state}\K\\{no\_zip}$;\6
\&{end};\2\6
\&{end};\5
$\\{pdf\_ptr}\K0$;\6
\&{if} $\\{saved\_pdf\_gone}>\\{pdf\_gone}$ \1\&{then}\5
$\\{pdf\_error}(\.{"file\ size"},\39\.{"File\ size\ exceeds\ architectural\
limits\ (pdf\_gone\ wraps\ around)"})$;\2\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_begin\_stream};\C{begin a stream}\2\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{"/Length\ \ \ \ \ \ \ \ \ \ \ "})$;\5
$\\{pdf\_seek\_write\_length}\K\\{true}$;\C{fill in length at \\{pdf\_end%
\_stream} call}\6
$\\{pdf\_stream\_length\_offset}\K\\{pdf\_offset}-11$;\5
$\\{pdf\_stream\_length}\K0$;\5
$\\{pdf\_last\_byte}\K0$;\6
\&{if} $\\{pdf\_compress\_level}>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{"/Filter\ /FlateDecode"})$;\5
$\\{pdf\_print\_ln}(\.{">>"})$;\5
$\\{pdf\_print\_ln}(\.{"stream"})$;\5
\\{pdf\_flush};\5
$\\{zip\_write\_state}\K\\{zip\_writing}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_ln}(\.{">>"})$;\5
$\\{pdf\_print\_ln}(\.{"stream"})$;\5
$\\{pdf\_save\_offset}\K\\{pdf\_offset}$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_stream};\C{end a stream}\2\6
\&{begin} \37\&{if} $\\{zip\_write\_state}=\\{zip\_writing}$ \1\&{then}\5
$\\{zip\_write\_state}\K\\{zip\_finish}$\6
\4\&{else} $\\{pdf\_stream\_length}\K\\{pdf\_offset}-\\{pdf\_save\_offset}$;\2\6
\\{pdf\_flush};\6
\&{if} $\\{pdf\_seek\_write\_length}$ \1\&{then}\5
$\\{write\_stream\_length}(\\{pdf\_stream\_length},\39\\{pdf\_stream\_length%
\_offset})$;\2\6
$\\{pdf\_seek\_write\_length}\K\\{false}$;\5
$\\{pdf\_out}(\\{pdf\_new\_line\_char})$;\5
$\\{pdf\_print\_ln}(\.{"endstream"})$;\5
\\{pdf\_end\_obj};\6
\&{end};\par
\fi

\M686. Basic printing procedures for PDF output are very similar to \TeX\ basic
printing ones but the output is going to PDF buffer. Subroutines with
suffix $\_\\{ln}$ append a new-line character to the PDF output.

\Y\P\D \37$\\{pdf\_new\_line\_char}\S10$\C{new-line character for UNIX
platforms}\par
\P\D \37$\\{pdf\_print\_nl}\S$\C{output a new-line character to PDF buffer}\6
$\\{pdf\_out}(\\{pdf\_new\_line\_char})$\par
\P\D \37$\\{pdf\_print\_ln}(\#)\S$\C{print out a string to PDF buffer followed
by a new-line character}\6
\&{begin} \37$\\{pdf\_print}(\#)$;\5
\\{pdf\_print\_nl};\6
\&{end}\par
\P\D \37$\\{pdf\_print\_int\_ln}(\#)\S$\C{print out an integer to PDF buffer
followed by a new-line character}\6
\&{begin} \37$\\{pdf\_print\_int}(\#)$;\5
\\{pdf\_print\_nl};\6
\&{end}\par
\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\S$\6
\4\&{procedure}\1\  \37$\\{pdf\_error}(\|t,\39\|p:\\{str\_number})$;\2\6
\&{begin} \37\\{normalize\_selector};\5
$\\{print\_err}(\.{"pdfTeX\ error"})$;\6
\&{if} $\|t\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\5
$\\{print}(\|t)$;\5
$\\{print}(\.{")"})$;\6
\&{end};\2\6
$\\{print}(\.{":\ "})$;\5
$\\{print}(\|p)$;\5
\\{succumb};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_warning}(\|t,\39\|p:\\{str\_number};\,\35%
\\{prepend\_nl},\39\\{append\_nl}:\\{boolean})$;\2\6
\&{begin} \37\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
\\{wake\_up\_terminal};\2\6
\&{if} $\\{prepend\_nl}$ \1\&{then}\5
\\{print\_ln};\2\6
$\\{print}(\.{"pdfTeX\ warning"})$;\6
\&{if} $\|t\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ ("})$;\5
$\\{print}(\|t)$;\5
$\\{print}(\.{")"})$;\6
\&{end};\2\6
$\\{print}(\.{":\ "})$;\5
$\\{print}(\|p)$;\6
\&{if} $\\{append\_nl}$ \1\&{then}\5
\\{print\_ln};\2\6
\&{if} $\\{history}=\\{spotless}$ \1\&{then}\5
$\\{history}\K\\{warning\_issued}$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_os\_get\_os\_buf}(\|s:\\{integer})$;\C{check
that \|s bytes more fit into \\{pdf\_os\_buf}; increase it if required}\6
\4\&{var} \37\|a: \37\\{integer};\2\6
\&{begin} \37\&{if} $\|s>\\{sup\_pdf\_os\_buf\_size}-\\{pdf\_ptr}$ \1\&{then}\5
$\\{overflow}(\.{"PDF\ object\ stream\ buffer"},\39\\{pdf\_os\_buf\_size})$;\2\6
\&{if} $\\{pdf\_ptr}+\|s>\\{pdf\_os\_buf\_size}$ \1\&{then}\6
\&{begin} \37$\|a\K0.2\ast\\{pdf\_os\_buf\_size}$;\6
\&{if} $\\{pdf\_ptr}+\|s>\\{pdf\_os\_buf\_size}+\|a$ \1\&{then}\5
$\\{pdf\_os\_buf\_size}\K\\{pdf\_ptr}+\|s$\6
\4\&{else} \&{if} $\\{pdf\_os\_buf\_size}<\\{sup\_pdf\_os\_buf\_size}-\|a$ \1%
\&{then}\5
$\\{pdf\_os\_buf\_size}\K\\{pdf\_os\_buf\_size}+\|a$\6
\4\&{else} $\\{pdf\_os\_buf\_size}\K\\{sup\_pdf\_os\_buf\_size}$;\2\2\6
$\\{pdf\_os\_buf}\K\\{xrealloc\_array}(\\{pdf\_os\_buf},\39\\{eight\_bits},\39%
\\{pdf\_os\_buf\_size})$;\5
$\\{pdf\_buf}\K\\{pdf\_os\_buf}$;\5
$\\{pdf\_buf\_size}\K\\{pdf\_os\_buf\_size}$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{remove\_last\_space};\2\6
\&{begin} \37\&{if} $(\\{pdf\_ptr}>0)\W(\\{pdf\_buf}[\\{pdf\_ptr}-1]=32)$ \1%
\&{then}\5
$\\{decr}(\\{pdf\_ptr})$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_octal}(\|n:\\{integer})$;\C{prints an
integer in octal form to PDF buffer}\6
\4\&{var} \37\|k: \37$0\to23$;\C{index to current digit; we assume that $%
\|n<10^{23}$}\2\6
\&{begin} \37$\|k\K0$;\6
\1\&{repeat} \37$\\{dig}[\|k]\K\|n\mathbin{\&{mod}}8$;\5
$\|n\K\|n\mathbin{\&{div}}8$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|n=0$;\2\6
\&{if} $\|k=1$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"0"})$;\5
$\\{pdf\_out}(\.{"0"})$;\6
\&{end};\2\6
\&{if} $\|k=2$ \1\&{then}\5
$\\{pdf\_out}(\.{"0"})$;\2\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\5
$\\{pdf\_out}(\.{"0"}+\\{dig}[\|k])$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_char}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{integer})$;\C{ print out a character to PDF buffer; the character
will be printed in octal   form in the following cases: chars <= 32, backslash
(92), left parenthesis   (40) and  right parenthesis (41) }\2\6
\&{begin} \37$\\{pdf\_mark\_char}(\|f,\39\|c)$;\6
\&{if} $(\|c\L32)\V(\|c=92)\V(\|c=40)\V(\|c=41)\V(\|c>127)$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(92)$;\C{output a backslash}\6
$\\{pdf\_print\_octal}(\|c)$;\6
\&{end}\6
\4\&{else} $\\{pdf\_out}(\|c)$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print}(\|s:\\{str\_number})$;\C{print out a
string to PDF buffer}\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{current character code position}\6
\|c: \37\\{integer};\2\6
\&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\|c\K\\{str\_pool}[\|j]$;\5
$\\{pdf\_out}(\|c)$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{str\_in\_str}(\|s,\39\|r:\\{str\_number};\,\35\|i:%
\\{integer})$: \37\\{boolean};\C{test equality of strings}\6
\4\&{label} \37\\{not\_found};\C{loop exit}\6
\4\&{var} \37$\|j,\39\|k$: \37\\{pool\_pointer};\C{running indices}\2\6
\&{begin} \37$\\{str\_in\_str}\K\\{false}$;\6
\&{if} $\\{length}(\|s)<\|i+\\{length}(\|r)$ \1\&{then}\5
\&{return};\2\6
$\|j\K\|i+\\{str\_start}[\|s]$;\5
$\|k\K\\{str\_start}[\|r]$;\6
\&{while} $(\|j<\\{str\_start}[\|s+1])\W(\|k<\\{str\_start}[\|r+1])$ \1\&{do}\6
\&{begin} \37\&{if} $\\{str\_pool}[\|j]\I\\{str\_pool}[\|k]$ \1\&{then}\5
\&{return};\2\6
$\\{incr}(\|j)$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{str\_in\_str}\K\\{true}$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_int}(\|n:\\{longinteger})$;\C{print out
a integer to PDF buffer}\6
\4\&{var} \37\|k: \37\\{integer};\C{index to current digit ($0\le k\le23$); we
assume that $\|n<10^{23}$}\6
\|m: \37\\{longinteger};\C{used to negate \|n in possibly dangerous cases}\2\6
\&{begin} \37$\|k\K0$;\6
\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"-"})$;\6
\&{if} $\|n>-100000000$ \1\&{then}\5
$\\{negate}(\|n)$\6
\4\&{else} \&{begin} \37$\|m\K-1-\|n$;\5
$\|n\K\|m\mathbin{\&{div}}10$;\5
$\|m\K(\|m\mathbin{\&{mod}}10)+1$;\5
$\|k\K1$;\6
\&{if} $\|m<10$ \1\&{then}\5
$\\{dig}[0]\K\|m$\6
\4\&{else} \&{begin} \37$\\{dig}[0]\K0$;\5
$\\{incr}(\|n)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\1\&{repeat} \37$\\{dig}[\|k]\K\|n\mathbin{\&{mod}}10$;\5
$\|n\K\|n\mathbin{\&{div}}10$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|n=0$;\2\6
$\\{pdf\_room}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\5
$\\{pdf\_quick\_out}(\.{"0"}+\\{dig}[\|k])$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_two}(\|n:\\{integer})$;\C{prints two
least significant digits in decimal form to PDF buffer}\2\6
\&{begin} \37$\|n\K\\{abs}(\|n)\mathbin{\&{mod}}100$;\5
$\\{pdf\_out}(\.{"0"}+(\|n\mathbin{\&{div}}10))$;\5
$\\{pdf\_out}(\.{"0"}+(\|n\mathbin{\&{mod}}10))$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{tokens\_to\_string}(\|p:\\{pointer})$: \37\\{str%
\_number};\C{return a string from tokens list}\2\6
\&{begin} \37\&{if} $\\{selector}=\\{new\_string}$ \1\&{then}\5
$\\{pdf\_error}(\.{"tokens"},\39\.{"tokens\_to\_string()\ called\ while\
selector\ =\ new\_string"})$;\2\6
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\|p),\39\\{null},\39\\{pool\_size}-\\{pool%
\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{last\_tokens\_string}\K\\{make\_string}$;\5
$\\{tokens\_to\_string}\K\\{last\_tokens\_string}$;\6
\&{end};\par
\As689, 698, 699, 700, 703, 1545\ETs1555.
\U190.\fi

\M687. To print \\{scaled} value to PDF output we need some subroutines to
ensure
accuracy.

\Y\P\D \37$\\{max\_integer}\S\H{7FFFFFFF}$\C{$2^{31}-1$}\par
\P\D \37$\\{call\_func}(\#)\S$\1\6
\&{begin} \37\&{if} $\#\I0$ \1\&{then}\5
\\{do\_nothing}\2\6
\&{end}\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{one\_bp}: \37\\{scaled};\C{scaled value corresponds to 1bp}\6
\4\\{one\_hundred\_bp}: \37\\{scaled};\C{scaled value corresponds to 100bp}\6
\4\\{one\_hundred\_inch}: \37\\{scaled};\C{scaled value corresponds to 100in}\6
\4\\{ten\_pow}: \37\&{array} $[0\to9]$ \1\&{of}\5
\\{integer};\C{$10^0..10^9$}\2\6
\4\\{scaled\_out}: \37\\{integer};\C{amount of \\{scaled} that was taken out in
\\{divide\_scaled}}\6
\4\\{init\_pdf\_output}: \37\\{boolean};\6
\4\\{adv\_char\_width\_s}: \37\\{integer};\C{to save result of calculation done
in \\{adv\_char\_width} }\6
\4\\{adv\_char\_width\_s\_out}: \37\\{scaled};\par
\fi

\M688. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{one\_bp}\K65782$;\C{65781.76}\6
$\\{one\_hundred\_bp}\K6578176$;\5
$\\{one\_hundred\_inch}\K473628672$;\5
$\\{ten\_pow}[0]\K1$;\6
\&{for} $\|i\K1\mathrel{\&{to}}9$ \1\&{do}\5
$\\{ten\_pow}[\|i]\K10\ast\\{ten\_pow}[\|i-1]$;\2\6
$\\{init\_pdf\_output}\K\\{false}$;\par
\fi

\M689. The following function divides \|s by \|m. \\{dd} is number of decimal
digits.

\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{divide\_scaled}(\|s,\39\|m:\\{scaled};\,\35\\{dd}:%
\\{integer})$: \37\\{scaled};\6
\4\&{var} \37$\|q,\39\|r$: \37\\{scaled};\5
$\\{sign},\39\|i$: \37\\{integer};\2\6
\&{begin} \37$\\{sign}\K1$;\6
\&{if} $\|s<0$ \1\&{then}\6
\&{begin} \37$\\{sign}\K-\\{sign}$;\5
$\|s\K-\|s$;\6
\&{end};\2\6
\&{if} $\|m<0$ \1\&{then}\6
\&{begin} \37$\\{sign}\K-\\{sign}$;\5
$\|m\K-\|m$;\6
\&{end};\2\6
\&{if} $\|m=0$ \1\&{then}\5
$\\{pdf\_error}(\.{"arithmetic"},\39\.{"divided\ by\ zero"})$\6
\4\&{else} \&{if} $\|m\G(\\{max\_integer}\mathbin{\&{div}}10)$ \1\&{then}\5
$\\{pdf\_error}(\.{"arithmetic"},\39\.{"number\ too\ big"})$;\2\2\6
$\|q\K\|s\mathbin{\&{div}}\|m$;\5
$\|r\K\|s\mathbin{\&{mod}}\|m$;\6
\&{for} $\|i\K1\mathrel{\&{to}}\\{dd}$ \1\&{do}\6
\&{begin} \37$\|q\K10\ast\|q+(10\ast\|r)\mathbin{\&{div}}\|m$;\5
$\|r\K(10\ast\|r)\mathbin{\&{mod}}\|m$;\6
\&{end};\2\6
\&{if} $2\ast\|r\G\|m$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|q)$;\5
$\|r\K\|r-\|m$;\6
\&{end};\2\6
$\\{scaled\_out}\K\\{sign}\ast(\|s-(\|r\mathbin{\&{div}}\\{ten\_pow}[%
\\{dd}]))$;\5
$\\{divide\_scaled}\K\\{sign}\ast\|q$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{round\_xn\_over\_d}(\|x:\\{scaled};\,\35\|n,\39\|d:%
\\{integer})$: \37\\{scaled};\6
\4\&{var} \37\\{positive}: \37\\{boolean};\C{was $\|x\G0$?}\6
$\|t,\39\|u,\39\|v$: \37\\{nonnegative\_integer};\C{intermediate quantities}\2\6
\&{begin} \37\&{if} $\|x\G0$ \1\&{then}\5
$\\{positive}\K\\{true}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|x)$;\5
$\\{positive}\K\\{false}$;\6
\&{end};\2\6
$\|t\K(\|x\mathbin{\&{mod}}\O{100000})\ast\|n$;\5
$\|u\K(\|x\mathbin{\&{div}}\O{100000})\ast\|n+(\|t\mathbin{\&{div}}%
\O{100000})$;\5
$\|v\K(\|u\mathbin{\&{mod}}\|d)\ast\O{100000}+(\|t\mathbin{\&{mod}}%
\O{100000})$;\6
\&{if} $\|u\mathbin{\&{div}}\|d\G\O{100000}$ \1\&{then}\5
$\\{arith\_error}\K\\{true}$\6
\4\&{else} $\|u\K\O{100000}\ast(\|u\mathbin{\&{div}}\|d)+(\|v\mathbin{\&{div}}%
\|d)$;\2\6
$\|v\K\|v\mathbin{\&{mod}}\|d$;\6
\&{if} $2\ast\|v\G\|d$ \1\&{then}\5
$\\{incr}(\|u)$;\2\6
\&{if} $\\{positive}$ \1\&{then}\5
$\\{round\_xn\_over\_d}\K\|u$\6
\4\&{else} $\\{round\_xn\_over\_d}\K-\|u$;\2\6
\&{end};\par
\fi

\M690. Next subroutines are needed for controlling spacing in PDF page
description.
For a given character \|c from a font \|f,
the procedure \\{adv\_char\_width} advances \\{pdf\_h}
by {\it about\/} the amount \|w, which is the character width.
But we cannot simply add \|w to \\{pdf\_h}.
Instead we have to bring the required shift into the same raster,
on which also the \.{/Widths} array values,
as they appear in the PDF file, are based.
The \\{scaled\_out} value is the \|w value moved into this raster.
The \.{/Widths} values are used by the PDF reader independently
to update its positions.
So one has to be sure, that calculations are properly synchronized.
Currently the \.{/Widths} array values are output
with one digit after the decimal point,
therefore the raster on which \\{adv\_char\_width} is operating
is $1/10000$ of the \\{pdf\_font\_size}.

For PK fonts things are more complicated,
as we have to deal with scaling bitmaps as well.

\Y\P\4\&{procedure}\1\  \37$\\{adv\_char\_width}(\|f:\\{internal\_font%
\_number};\,\35\|c:\\{eight\_bits};\,\35\\{dd}:\\{eight\_bits})$;\C{update %
\\{pdf\_delta\_h} by character width \|w from font \|f}\6
\4\&{var} \37$\|w,\39\\{s\_out}$: \37\\{scaled};\5
\|s: \37\\{integer};\2\6
\&{begin} \37$\|w\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$;\6
\&{if} $\\{isscalable}(\|f)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_cur\_Tm\_a}=0$ \1\&{then}\6
\&{begin} \37$\|s\K\\{divide\_scaled}(\|w,\39\\{pdf\_font\_size}[\|f],\39%
\\{dd})$;\5
$\\{s\_out}\K\\{scaled\_out}$;\5
$\\{pdf\_delta\_h}\K\\{pdf\_delta\_h}+\\{s\_out}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|s\K\\{divide\_scaled}(\\{round\_xn\_over\_d}(\|w,%
\391000,\391000+\\{pdf\_cur\_Tm\_a}),\39\\{pdf\_font\_size}[\|f],\39\\{dd})$;\5
$\\{s\_out}\K\\{round\_xn\_over\_d}(\\{round\_xn\_over\_d}(\\{pdf\_font\_size}[%
\|f],\39\\{abs}(\|s),\3910000),\391000+\\{pdf\_cur\_Tm\_a},\391000)$;\6
\&{if} $\|s<0$ \1\&{then}\5
$\\{s\_out}\K-\\{s\_out}$;\2\6
$\\{pdf\_delta\_h}\K\\{pdf\_delta\_h}+\\{s\_out}$;\6
\&{end};\2\6
$\\{adv\_char\_width\_s}\K\|s$;\5
$\\{adv\_char\_width\_s\_out}\K\\{s\_out}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_delta\_h}\K\\{pdf\_delta\_h}+\\{get\_pk\_char\_width}(\|f,%
\39\|w)$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_real}(\|m,\39\|d:\\{integer})$;\C{print
$m/10^d$ as real}\2\6
\&{begin} \37\&{if} $\|m<0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"-"})$;\5
$\|m\K-\|m$;\6
\&{end};\2\6
$\\{pdf\_print\_int}(\|m\mathbin{\&{div}}\\{ten\_pow}[\|d])$;\5
$\|m\K\|m\mathbin{\&{mod}}\\{ten\_pow}[\|d]$;\6
\&{if} $\|m>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"."})$;\5
$\\{decr}(\|d)$;\6
\&{while} $\|m<\\{ten\_pow}[\|d]$ \1\&{do}\6
\&{begin} \37$\\{pdf\_out}(\.{"0"})$;\5
$\\{decr}(\|d)$;\6
\&{end};\2\6
\&{while} $\|m\mathbin{\&{mod}}10=0$ \1\&{do}\5
$\|m\K\|m\mathbin{\&{div}}10$;\2\6
$\\{pdf\_print\_int}(\|m)$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_bp}(\|s:\\{scaled})$;\C{print scaled as %
\\{bp}}\2\6
\&{begin} \37$\\{pdf\_print\_real}(\\{divide\_scaled}(\|s,\39\\{one\_hundred%
\_bp},\39\\{fixed\_decimal\_digits}+2),\39\\{fixed\_decimal\_digits})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_mag\_bp}(\|s:\\{scaled})$;\C{take %
\\{mag} into account}\2\6
\&{begin} \37\\{prepare\_mag};\6
\&{if} $\\{mag}\I1000$ \1\&{then}\5
$\|s\K\\{round\_xn\_over\_d}(\|s,\39\\{mag},\391000)$;\2\6
$\\{pdf\_print\_bp}(\|s)$;\6
\&{end};\par
\fi

\N691.  \[32c] PDF page description.

\Y\P\D \37$\\{pdf\_x}(\#)\S((\#)-\\{pdf\_origin\_h})$\C{convert $x$-coordinate
from \.{DVI} to PDF}\par
\P\D \37$\\{pdf\_y}(\#)\S(\\{pdf\_origin\_v}-(\#))$\C{convert $y$-coordinate
from \.{DVI} to PDF}\par
\P\D \37$\\{dvi\_x}(\#)\S((\#)+\\{pdf\_origin\_h})$\C{convert $x$-coordinate
from \.{PDF} to DVI}\par
\P\D \37$\\{dvi\_y}(\#)\S(\\{pdf\_origin\_v}-(\#))$\C{convert $y$-coordinate
from \.{PDF} to DVI}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_f}: \37\\{internal\_font\_number};\C{the current font in PDF output
page}\6
\4\\{pdf\_h}: \37\\{scaled};\C{current horizontal coordinate in PDF output
page}\6
\4\\{pdf\_v}: \37\\{scaled};\C{current vertical coordinate in PDF output page}\6
\4\\{pdf\_tj\_start\_h}: \37\\{scaled};\C{horizontal coordinate in PDF output
page just before \.{TJ} array start}\6
\4\\{cur\_delta\_h}: \37\\{scaled};\C{horizontal \\{cur\_h} offset from \\{pdf%
\_tj\_start\_h}}\6
\4\\{pdf\_delta\_h}: \37\\{scaled};\C{horizontal offset from \\{pdf\_tj\_start%
\_h}}\6
\4\\{pdf\_origin\_h}: \37\\{scaled};\C{current horizontal origin in PDF output
page}\6
\4\\{pdf\_origin\_v}: \37\\{scaled};\C{current vertical origin in PDF output
page}\6
\4\\{pdf\_doing\_string}: \37\\{boolean};\C{we are writing string to PDF file?}%
\6
\4\\{pdf\_doing\_text}: \37\\{boolean};\C{we are writing text section to PDF
file?}\6
\4\\{min\_bp\_val}: \37\\{scaled};\6
\4\\{min\_font\_val}: \37\\{scaled};\C{(TJ array system)}\6
\4\\{fixed\_pk\_resolution}: \37\\{integer};\6
\4\\{fixed\_decimal\_digits}: \37\\{integer};\6
\4\\{fixed\_gen\_tounicode}: \37\\{integer};\6
\4\\{fixed\_inclusion\_copy\_font}: \37\\{integer};\6
\4\\{pk\_scale\_factor}: \37\\{integer};\6
\4\\{pdf\_output\_option}: \37\\{integer};\6
\4\\{pdf\_output\_value}: \37\\{integer};\6
\4\\{pdf\_draftmode\_option}: \37\\{integer};\6
\4\\{pdf\_draftmode\_value}: \37\\{integer};\6
\4\\{pdf\_cur\_Tm\_a}: \37\\{integer};\C{\|a value of the current text matrix,
i.e., the current                           horizontal scaling factor}\6
\4\\{pdf\_last\_f}: \37\\{internal\_font\_number};\C{last font in PDF output
page}\6
\4\\{pdf\_last\_fs}: \37\\{internal\_font\_number};\C{last font size in PDF
output page}\6
\4\\{pdf\_dummy\_font}: \37\\{internal\_font\_number};\C{font used to insert
artificial interword spaces}\par
\fi

\M692. Following procedures implement low-level subroutines to convert \TeX{}
internal structures to PDF page description.

\Y\P\4\&{procedure}\1\  \37$\\{pdf\_set\_origin}(\|h,\39\|v:\\{scaled})$;\C{set
the origin to \|h, \|v}\2\6
\&{begin} \37\&{if} $(\\{abs}(\|h-\\{pdf\_origin\_h})\G\\{min\_bp\_val})\V(%
\\{abs}(\|v-\\{pdf\_origin\_v})\G\\{min\_bp\_val})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"1\ 0\ 0\ 1\ "})$;\5
$\\{pdf\_print\_bp}(\|h-\\{pdf\_origin\_h})$;\5
$\\{pdf\_origin\_h}\K\\{pdf\_origin\_h}+\\{scaled\_out}$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_origin\_v}-\|v)$;\5
$\\{pdf\_origin\_v}\K\\{pdf\_origin\_v}-\\{scaled\_out}$;\5
$\\{pdf\_print\_ln}(\.{"\ cm"})$;\6
\&{end};\2\6
$\\{pdf\_h}\K\\{pdf\_origin\_h}$;\5
$\\{pdf\_tj\_start\_h}\K\\{pdf\_h}$;\5
$\\{pdf\_v}\K\\{pdf\_origin\_v}$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_set\_origin\_temp}(\|h,\39\|v:\\{scaled})$;%
\C{set the origin to \|h, \|v inside group}\2\6
\&{begin} \37\&{if} $(\\{abs}(\|h-\\{pdf\_origin\_h})\G\\{min\_bp\_val})\V(%
\\{abs}(\|v-\\{pdf\_origin\_v})\G\\{min\_bp\_val})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"1\ 0\ 0\ 1\ "})$;\5
$\\{pdf\_print\_bp}(\|h-\\{pdf\_origin\_h})$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_origin\_v}-\|v)$;\5
$\\{pdf\_print\_ln}(\.{"\ cm"})$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_string};\C{end the current string}\2\6
\&{begin} \37\&{if} $\\{pdf\_doing\_string}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{")]TJ"})$;\5
$\\{pdf\_doing\_string}\K\\{false}$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_string\_nl};\C{end the current string, with
new-line}\2\6
\&{begin} \37\&{if} $\\{pdf\_doing\_string}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{")]TJ"})$;\5
$\\{pdf\_doing\_string}\K\\{false}$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_set\_textmatrix}(\|v,\39\\{v\_out}:\\{scaled};%
\,\35\|f:\\{internal\_font\_number})$;\C{set the next starting point to \\{cur%
\_h}, \\{cur\_v}}\6
\4\&{var} \37\\{pdf\_new\_Tm\_a}: \37\\{integer};\C{\|a value of the new text
matrix}\2\6
\&{begin} \37$\\{pdf\_out}(\.{"\ "})$;\6
\&{if} $\|f=\\{pdf\_f}$ \1\&{then}\5
$\\{pdf\_new\_Tm\_a}\K\\{pdf\_cur\_Tm\_a}$\6
\4\&{else} \&{if} $\R\\{pdf\_font\_auto\_expand}[\|f]$ \1\&{then}\5
$\\{pdf\_new\_Tm\_a}\K0$\6
\4\&{else} $\\{pdf\_new\_Tm\_a}\K\\{pdf\_font\_expand\_ratio}[\|f]$;\2\2\6
\&{if} $(\\{pdf\_new\_Tm\_a}\I0)\V((\\{pdf\_new\_Tm\_a}=0)\W(\\{pdf\_cur\_Tm%
\_a}\I0))$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_real}(1000+\\{pdf\_new\_Tm\_a},\393)$;\5
$\\{pdf\_print}(\.{"\ 0\ 0\ 1\ "})$;\5
$\\{pdf\_print\_bp}(\\{cur\_h}-\\{pdf\_origin\_h})$;\5
$\\{pdf\_h}\K\\{pdf\_origin\_h}+\\{scaled\_out}$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_origin\_v}-\\{cur\_v})$;\5
$\\{pdf\_v}\K\\{pdf\_origin\_v}-\\{scaled\_out}$;\5
$\\{pdf\_print}(\.{"\ Tm"})$;\5
$\\{pdf\_cur\_Tm\_a}\K\\{pdf\_new\_Tm\_a}$;\5
$\\{pdfassert}(\\{pdf\_cur\_Tm\_a}>-1000)$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_bp}(\\{cur\_h}-\\{pdf\_tj\_start\_h})$;%
\C{works only for unexpanded fonts}\6
$\\{pdf\_h}\K\\{pdf\_tj\_start\_h}+\\{scaled\_out}$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_real}(\|v,\39\\{fixed\_decimal\_digits})$;\C{use \|v and \\{v%
\_out} to avoid duplicate calculation}\6
$\\{pdf\_v}\K\\{pdf\_v}-\\{v\_out}$;\5
$\\{pdf\_print}(\.{"\ Td"})$;\6
\&{end};\2\6
$\\{pdf\_tj\_start\_h}\K\\{pdf\_h}$;\5
$\\{pdf\_delta\_h}\K0$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_use\_font}(\|f:\\{internal\_font\_number};\,\35%
\\{fontnum}:\\{integer})$;\C{mark \|f as a used font; set $\\{font\_used}[%
\|f]$, $\\{pdf\_font\_size}[\|f]$ and $\\{pdf\_font\_num}[\|f]$}\2\6
\&{begin} \37$\\{call\_func}(\\{divide\_scaled}(\\{font\_size}[\|f],\39\\{one%
\_hundred\_bp},\396))$;\5
$\\{pdf\_font\_size}[\|f]\K\\{scaled\_out}$;\5
$\\{font\_used}[\|f]\K\\{true}$;\5
$\\{pdfassert}((\\{fontnum}>0)\V((\\{fontnum}<0)\W(\\{pdf\_font\_num}[-%
\\{fontnum}]>0)))$;\5
$\\{pdf\_font\_num}[\|f]\K\\{fontnum}$;\6
\&{if} $\\{pdf\_move\_chars}>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(0,\39\.{"Primitive\ \\pdfmovechars\ is\
obsolete."},\39\\{true},\39\\{true})$;\5
$\\{pdf\_move\_chars}\K0$;\C{warn only once}\6
\&{end};\2\6
\&{end};\par
\fi

\M693. To set PDF font we need to find out fonts with the same name, because %
\TeX\
can load the same font several times for various sizes. For such fonts we
define only one font resource. The array \\{pdf\_font\_num} holds the object
number of font resource. A negative value of an entry of \\{pdf\_font\_num}
indicates that the corresponding font shares the font resource with the font.

\Y\P\D \37$\\{pdf\_print\_resname\_prefix}\S$\1\6
\&{if} $\\{pdf\_resname\_prefix}\I0$ \1\&{then}\5
$\\{pdf\_print}(\\{pdf\_resname\_prefix})$\2\2\par
\Y\P\4\&{procedure}\1\  \37$\\{pdf\_init\_font}(\|f:\\{internal\_font%
\_number})$;\C{create a font object}\6
\4\&{var} \37$\|k,\39\|b$: \37\\{internal\_font\_number};\5
\|i: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}(\R\\{font\_used}[\|f])$;\C{if \|f is auto expanded
then ensure the base font is initialized}\6
\&{if} $\\{pdf\_font\_auto\_expand}[\|f]\W(\\{pdf\_font\_blink}[\|f]\I\\{null%
\_font})$ \1\&{then}\6
\&{begin} \37$\|b\K\\{pdf\_font\_blink}[\|f]$;\6
\&{if} $\R\\{isscalable}(\|b)$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"auto\ expansion\ is\ only\
possible\ with\ scalable\ fonts"})$;\2\6
\&{if} $\R\\{font\_used}[\|b]$ \1\&{then}\5
$\\{pdf\_init\_font}(\|b)$;\2\6
$\\{pdf\_font\_map}[\|f]\K\\{pdf\_font\_map}[\|b]$;\6
\&{end};\C{check whether \|f can share the font object with some \|k: we have 2
cases     here: 1) \|f and \|k have the same tfm name (so they have been loaded
at     different sizes, e.g., 'cmr10' and 'cmr10 at 11pt'); 2) \|f has been
auto     expanded from \|k}\2\6
\&{if} $\\{isscalable}(\|f)$ \1\&{then}\6
\&{begin} \37$\|i\K\\{head\_tab}[\\{obj\_type\_font}]$;\6
\&{while} $\|i\I0$ \1\&{do}\6
\&{begin} \37$\|k\K\\{obj\_info}(\|i)$;\6
\&{if} $\\{isscalable}(\|k)\W(\\{pdf\_font\_map}[\|k]=\\{pdf\_font\_map}[\|f])%
\W(\\{str\_eq\_str}(\\{font\_name}[\|k],\39\\{font\_name}[\|f])\V(\\{pdf\_font%
\_auto\_expand}[\|f]\W(\\{pdf\_font\_blink}[\|f]\I\\{null\_font})\W\\{str\_eq%
\_str}(\\{font\_name}[\|k],\39\\{font\_name}[\\{pdf\_font\_blink}[\|f]])))$ \1%
\&{then}\6
\&{begin} \37$\\{pdfassert}(\\{pdf\_font\_num}[\|k]\I0)$;\6
\&{if} $\\{pdf\_font\_num}[\|k]<0$ \1\&{then}\5
$\\{pdf\_use\_font}(\|f,\39\\{pdf\_font\_num}[\|k])$\6
\4\&{else} $\\{pdf\_use\_font}(\|f,\39-\|k)$;\2\6
\&{return};\6
\&{end};\2\6
$\|i\K\\{obj\_link}(\|i)$;\6
\&{end};\2\6
\&{end};\C{create a new font object for \|f}\2\6
$\\{pdf\_create\_obj}(\\{obj\_type\_font},\39\|f)$;\5
$\\{pdf\_font\_has\_space\_char}[\|f]\K\\{hasspacechar}(\|f)$;\5
$\\{pdf\_use\_font}(\|f,\39\\{obj\_ptr})$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_init\_font\_cur\_val};\2\6
\&{begin} \37$\\{pdf\_init\_font}(\\{cur\_val})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_set\_font}(\|f:\\{internal\_font\_number})$;%
\C{set the actual font on PDF page}\6
\4\&{label} \37$\\{found},\39\\{found1}$;\6
\4\&{var} \37\|p: \37\\{pointer};\5
\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37\&{if} $\R\\{font\_used}[\|f]$ \1\&{then}\5
$\\{pdf\_init\_font}(\|f)$;\2\6
$\\{set\_ff}(\|f)$;\C{set \\{ff} to the tfm number of the font sharing the font
object                 with \|f; \\{ff} is either \|f or some font with the
same tfm name                 at different size and/or expansion}\6
$\|k\K\\{ff}$;\5
$\|p\K\\{pdf\_font\_list}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{set\_ff}(\\{info}(\|p))$;\6
\&{if} $\\{ff}=\|k$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{pdf\_append\_list}(\|f)(\\{pdf\_font\_list})$;\C{\|f not found in \\{pdf%
\_font\_list}, append it now}\6
\4\\{found}: \37\&{if} $(\|k=\\{pdf\_last\_f})\W(\\{font\_size}[\|f]=\\{pdf%
\_last\_fs})$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_print}(\.{"/F"})$;\5
$\\{pdf\_print\_int}(\|k)$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_real}(\\{divide\_scaled}(\\{font\_size}[\|f],\39\\{one\_hundred%
\_bp},\396),\394)$;\5
$\\{pdf\_print}(\.{"\ Tf"})$;\5
$\\{pdf\_last\_f}\K\|k$;\5
$\\{pdf\_last\_fs}\K\\{font\_size}[\|f]$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_begin\_text};\C{begin a text section}\2\6
\&{begin} \37$\\{pdf\_set\_origin}(0,\39\\{cur\_page\_height})$;\5
$\\{pdf\_print\_ln}(\.{"BT"})$;\5
$\\{pdf\_doing\_text}\K\\{true}$;\5
$\\{pdf\_f}\K\\{null\_font}$;\5
$\\{pdf\_last\_f}\K\\{null\_font}$;\5
$\\{pdf\_last\_fs}\K0$;\5
$\\{pdf\_doing\_string}\K\\{false}$;\5
$\\{pdf\_cur\_Tm\_a}\K0$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_read\_dummy\_font};\2\6
\&{begin} \37\&{if} $\\{pdf\_dummy\_font}=\\{null\_font}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_dummy\_font}\K\\{read\_font\_info}(\\{null\_cs},\39\\{pdf%
\_space\_font\_name},\39\.{""},\39-1000)$;\5
\\{pdfmaplinesp};\5
$\\{pdf\_mark\_char}(\\{pdf\_dummy\_font},\3932)$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_insert\_interword\_space};\C{insert an
artificial interword space}\2\6
\&{begin} \37\\{pdf\_read\_dummy\_font};\5
$\\{pdf\_set\_font}(\\{pdf\_dummy\_font})$;\5
$\\{pdf\_print}(\.{"(\ )Tj"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_begin\_string}(\|f:\\{internal\_font%
\_number})$;\C{begin to draw a string}\6
\4\&{var} \37$\\{s\_out},\39\|v,\39\\{v\_out}$: \37\\{scaled};\5
\\{save\_pdf\_delta\_h}: \37\\{scaled};\5
\|s: \37\\{integer};\5
\\{must\_end\_string}: \37\\{boolean};\C{must we end the current string?}\6
\\{must\_insert\_space}: \37\\{boolean};\C{must we insert an interword space?}%
\2\6
\&{begin} \37\&{if} $\R\\{pdf\_doing\_text}$ \1\&{then}\5
\\{pdf\_begin\_text};\2\6
\&{if} $\|f\I\\{pdf\_f}$ \1\&{then}\6
\&{begin} \37\\{pdf\_end\_string};\5
$\\{pdf\_set\_font}(\|f)$;\6
\&{end};\2\6
\&{if} $\\{pdf\_cur\_Tm\_a}=0$ \1\&{then}\6
\&{begin} \37$\|s\K\\{divide\_scaled}(\\{cur\_h}-(\\{pdf\_tj\_start\_h}+\\{pdf%
\_delta\_h}),\39\\{pdf\_font\_size}[\|f],\393)$;\5
$\\{s\_out}\K\\{scaled\_out}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|s\K\\{divide\_scaled}(\\{round\_xn\_over\_d}(\\{cur%
\_h}-(\\{pdf\_tj\_start\_h}+\\{pdf\_delta\_h}),\391000,\391000+\\{pdf\_cur\_Tm%
\_a}),\39\\{pdf\_font\_size}[\|f],\393)$;\6
\&{if} $\\{abs}(\|s)<\O{100000}$ \1\&{then}\6
\&{begin} \37$\\{s\_out}\K\\{round\_xn\_over\_d}(\\{round\_xn\_over\_d}(\\{pdf%
\_font\_size}[\|f],\39\\{abs}(\|s),\391000),\391000+\\{pdf\_cur\_Tm\_a},%
\391000)$;\6
\&{if} $\|s<0$ \1\&{then}\5
$\\{s\_out}\K-\\{s\_out}$;\2\6
\&{end};\C{no need to calculate \\{s\_out} when $\\{abs}(\|s)\G\O{100000}$,
since the text          matrix will be reset below}\2\6
\&{end};\2\6
\&{if} $\\{abs}(\\{cur\_v}-\\{pdf\_v})\G\\{min\_bp\_val}$ \1\&{then}\6
\&{begin} \37$\|v\K\\{divide\_scaled}(\\{pdf\_v}-\\{cur\_v},\39\\{one\_hundred%
\_bp},\39\\{fixed\_decimal\_digits}+2)$;\5
$\\{v\_out}\K\\{scaled\_out}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|v\K0$;\5
$\\{v\_out}\K0$;\6
\&{end};\2\6
$\\{must\_insert\_space}\K\\{false}$;\5
$\\{must\_end\_string}\K\\{false}$;\6
\&{if} $(\|f\I\\{pdf\_f})\V(\|v\I0)\V(\\{abs}(\|s)\G\O{100000})$ \1\&{then}\6
\&{begin} \37$\\{must\_end\_string}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\\{gen\_faked\_interword\_space}\W\\{pdf\_doing\_string}\W(\R\\{must%
\_end\_string})\W(\\{s\_out}>\\{space}(\|f)-\\{space\_shrink}(\|f)-65536)\W(%
\|v=0)$ \1\&{then}\6
\&{begin} \37$\\{must\_insert\_space}\K\\{true}$;\6
\&{end};\2\6
\&{if} $(\\{must\_insert\_space})$ \1\&{then}\6
\&{begin} \37\C{insert a real space char from the font when possible}\6
\&{if} $\\{pdf\_font\_has\_space\_char}[\|f]$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"\ "})$;\5
$\\{save\_pdf\_delta\_h}\K\\{pdf\_delta\_h}$;\5
$\\{adv\_char\_width}(\|f,\3932,\393)$;\C{ to get \\{adv\_char\_width\_s} and %
\\{adv\_char\_width\_s\_out}}\6
$\|s\K\|s-\\{adv\_char\_width\_s}$;\5
$\\{s\_out}\K\\{s\_out}-\\{adv\_char\_width\_s\_out}$;\5
$\\{pdf\_mark\_char}(\|f,\3932)$;\6
\&{end}\6
\4\&{else} $\\{must\_end\_string}\K\\{true}$;\2\6
\&{end};\2\6
\&{if} $\\{must\_end\_string}$ \1\&{then}\6
\&{begin} \37\\{pdf\_end\_string};\C{insert a space char from the dummy font if
needed}\6
\&{if} $(\\{must\_insert\_space})\W(\R\\{pdf\_font\_has\_space\_char}[\|f])$ \1%
\&{then}\6
\&{begin} \37\\{pdf\_insert\_interword\_space};\C{this will change \\{pdf\_f}}\6
$\\{pdf\_set\_font}(\|f)$;\6
\&{end};\2\6
$\\{pdf\_set\_textmatrix}(\|v,\39\\{v\_out},\39\|f)$;\5
$\\{pdf\_f}\K\|f$;\5
$\|s\K0$;\6
\&{end};\2\6
\&{if} $\R\\{pdf\_doing\_string}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"\ ["})$;\6
\&{if} $\|s=0$ \1\&{then}\5
$\\{pdf\_out}(\.{"("})$;\2\6
\&{end};\2\6
\&{if} $\|s\I0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_doing\_string}$ \1\&{then}\5
$\\{pdf\_out}(\.{")"})$;\2\6
$\\{pdf\_print\_int}(-\|s)$;\5
$\\{pdf\_out}(\.{"("})$;\5
$\\{pdf\_delta\_h}\K\\{pdf\_delta\_h}+\\{s\_out}$;\6
\&{end};\2\6
$\\{pdf\_doing\_string}\K\\{true}$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_insert\_fake\_space};\6
\4\&{var} \37\|s: \37\\{integer};\C{to save \\{gen\_faked\_interword\_space}}\2%
\6
\&{begin} \37$\|s\K\\{gen\_faked\_interword\_space}$;\5
$\\{gen\_faked\_interword\_space}\K0$;\C{to prevent inserting another fake
space in \\{pdf\_begin\_string}}\6
\\{pdf\_read\_dummy\_font};\5
$\\{pdf\_begin\_string}(\\{pdf\_dummy\_font})$;\5
$\\{pdf\_print}(\.{"\ "})$;\5
\\{pdf\_end\_string\_nl};\5
$\\{gen\_faked\_interword\_space}\K\|s$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_text};\C{end a text section}\2\6
\&{begin} \37\&{if} $\\{pdf\_doing\_text}$ \1\&{then}\6
\&{begin} \37\\{pdf\_end\_string\_nl};\5
$\\{pdf\_print\_ln}(\.{"ET"})$;\5
$\\{pdf\_doing\_text}\K\\{false}$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_set\_rule}(\|x,\39\|y,\39\|w,\39\|h:%
\\{scaled})$;\C{draw a rule}\2\6
\&{begin} \37\\{pdf\_end\_text};\5
$\\{pdf\_print\_ln}(\.{"q"})$;\6
\&{if} $\|h\L\\{one\_bp}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_set\_origin\_temp}(\|x,\39\|y-(\|h+1)/2)$;\5
$\\{pdf\_print}(\.{"[]0\ d\ 0\ J\ "})$;\5
$\\{pdf\_print\_bp}(\|h)$;\5
$\\{pdf\_print}(\.{"\ w\ 0\ 0\ m\ "})$;\5
$\\{pdf\_print\_bp}(\|w)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ l\ S"})$;\6
\&{end}\6
\4\&{else} \&{if} $\|w\L\\{one\_bp}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_set\_origin\_temp}(\|x+(\|w+1)/2,\39\|y)$;\5
$\\{pdf\_print}(\.{"[]0\ d\ 0\ J\ "})$;\5
$\\{pdf\_print\_bp}(\|w)$;\5
$\\{pdf\_print}(\.{"\ w\ 0\ 0\ m\ 0\ "})$;\5
$\\{pdf\_print\_bp}(\|h)$;\5
$\\{pdf\_print\_ln}(\.{"\ l\ S"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_set\_origin\_temp}(\|x,\39\|y)$;\5
$\\{pdf\_print}(\.{"0\ 0\ "})$;\5
$\\{pdf\_print\_bp}(\|w)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\|h)$;\5
$\\{pdf\_print\_ln}(\.{"\ re\ f"})$;\6
\&{end};\2\2\6
$\\{pdf\_print\_ln}(\.{"Q"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_rectangle}(\\{left},\39\\{top},\39\\{right},\39%
\\{bottom}:\\{scaled})$;\C{output a rectangle specification to PDF file}\2\6
\&{begin} \37\\{prepare\_mag};\5
$\\{pdf\_print}(\.{"/Rect\ ["})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{left}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{bottom}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{right}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{top}))$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{end};\C{Prints first \\{len} characters of string \|s (if it's that long).
There must be a better way to print a substring?}\6
\4\&{procedure}\1\  \37$\\{slow\_print\_substr}(\|s,\39\\{max\_len}:%
\\{integer})$;\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{current character code position}\2\6
\&{begin} \37\&{if} $(\|s\G\\{str\_ptr})\V(\|s<256)$ \1\&{then}\5
$\\{print}(\|s)$\6
\4\&{else} \&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{while} $(\|j<\\{str\_start}[\|s+1])\W(\|j\L\\{str\_start}[\|s]+\\{max%
\_len})$ \1\&{do}\6
\&{begin} \37$\\{print}(\\{so}(\\{str\_pool}[\|j]))$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\|j<\\{str\_start}[\|s+1]$ \1\&{then}\5
$\\{print}(\.{"..."})$;\C{indicate truncation}\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{literal}(\|s:\\{str\_number};\,\35\\{literal\_mode}:%
\\{integer};\,\35\\{warn}:\\{boolean})$;\6
\4\&{var} \37\|j: \37\\{pool\_pointer};\C{current character code position}\2\6
\&{begin} \37$\|j\K\\{str\_start}[\|s]$;\6
\&{if} $\\{literal\_mode}=\\{scan\_special}$ \1\&{then}\6
\&{begin} \37\&{if} $\R(\\{str\_in\_str}(\|s,\39\.{"PDF:"},\390)\V\\{str\_in%
\_str}(\|s,\39\.{"pdf:"},\390))$ \1\&{then}\6
\&{begin} \37\&{if} $\\{warn}\W\R(\\{str\_in\_str}(\|s,\39\.{"SRC:"},\390)\V%
\\{str\_in\_str}(\|s,\39\.{"src:"},\390)\V(\\{length}(\|s)=0))$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Non-PDF\ special\ ignored!"})$;\5
$\\{print\_nl}(\.{"<special>\ "})$;\5
$\\{slow\_print\_substr}(\|s,\3964)$;\C{length of printed line should be <=78;
good enough.}\6
\\{print\_ln};\6
\&{end};\2\6
\&{return};\6
\&{end};\2\6
$\|j\K\|j+\\{length}(\.{"PDF:"})$;\6
\&{if} $\\{str\_in\_str}(\|s,\39\.{"direct:"},\39\\{length}(\.{"PDF:"}))$ \1%
\&{then}\6
\&{begin} \37$\|j\K\|j+\\{length}(\.{"direct:"})$;\5
$\\{literal\_mode}\K\\{direct\_always}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{str\_in\_str}(\|s,\39\.{"page:"},\39\\{length}(%
\.{"PDF:"}))$ \1\&{then}\6
\&{begin} \37$\|j\K\|j+\\{length}(\.{"page:"})$;\5
$\\{literal\_mode}\K\\{direct\_page}$;\6
\&{end}\6
\4\&{else} $\\{literal\_mode}\K\\{set\_origin}$;\2\2\6
\&{end};\2\6
\&{case} $\\{literal\_mode}$ \1\&{of}\6
\4\\{set\_origin}: \37\&{begin} \37\\{pdf\_end\_text};\5
$\\{pdf\_set\_origin}(\\{cur\_h},\39\\{cur\_v})$;\6
\&{end};\6
\4\\{direct\_page}: \37\\{pdf\_end\_text};\6
\4\\{direct\_always}: \37\\{pdf\_end\_string\_nl};\6
\4\&{othercases} \37$\\{confusion}(\.{"literal1"})$\2\6
\&{endcases};\6
\&{while} $\|j<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\\{pdf\_out}(\\{str\_pool}[\|j])$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
\\{pdf\_print\_nl};\6
\&{end};\par
\fi

\N694.  \[32d] The cross-reference table.  The cross-reference table \\{obj%
\_tab} is an
array of \\{obj\_tab\_size} of \\{obj\_entry}. Each entry contains five integer
fields
and represents an object in PDF file whose object number is the index of this
entry in \\{obj\_tab}.  Objects in \\{obj\_tab} maybe linked into list; objects
in
such a linked list have the same type.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{obj\_entry}=$\1\5
\1\&{record} \37$\\{int0},\39\\{int1}$: \37\\{integer};\6
\4\\{int2}: \37\\{longinteger};\6
\4$\\{int3},\39\\{int4}$: \37\\{integer};\2\6
\&{end};\2\par
\fi

\M695. The first field contains information representing identifier of this
object.
It is usually a number for most of object types, but it may be a string number
for named destination or named thread.

The second field of \\{obj\_entry} contains link to the next
object in \\{obj\_tab} if this object is linked in a list.

The third field holds the byte offset of the object in the output PDF file,
or its byte offset within an object stream. As long as the object is not
written, this field is used for flags about the write status of the object;
then it has a negative value.

The fourth field holds the object number of the object stream, into which
the object is included.

The last field usually represents the pointer to some auxiliary data
structure depending on the object type; however it may be used as a counter as
well.

\Y\P\D \37$\\{obj\_info}(\#)\S\\{obj\_tab}[\#].\\{int0}$\C{information
representing identifier of this object}\par
\P\D \37$\\{obj\_link}(\#)\S\\{obj\_tab}[\#].\\{int1}$\C{link to the next entry
in linked list}\par
\P\D \37$\\{obj\_offset}(\#)\S\\{obj\_tab}[\#].\\{int2}$\C{negative (flags), or
byte offset for this object in PDF output file, or object stream number for
this object}\par
\P\D \37$\\{obj\_os\_idx}(\#)\S\\{obj\_tab}[\#].\\{int3}$\C{index of this
object in object stream}\par
\P\D \37$\\{obj\_aux}(\#)\S\\{obj\_tab}[\#].\\{int4}$\C{auxiliary pointer}\par
\P\D \37$\\{set\_obj\_fresh}(\#)\S\\{obj\_offset}(\#)\K-2$\par
\P\D \37$\\{set\_obj\_scheduled}(\#)\S$\1\6
\&{if} $\\{obj\_offset}(\#)=-2$ \1\&{then}\5
$\\{obj\_offset}(\#)\K-1$\2\2\par
\P\D \37$\\{is\_obj\_scheduled}(\#)\S(\\{obj\_offset}(\#)>-2)$\par
\P\D \37$\\{is\_obj\_written}(\#)\S(\\{obj\_offset}(\#)>-1)$\7
\C{types of objects}\par
\P\D \37$\\{obj\_type\_others}\S0$\C{objects which are not linked in any list}%
\par
\P\D \37$\\{obj\_type\_page}\S1$\C{index of linked list of Page objects}\par
\P\D \37$\\{obj\_type\_pages}\S2$\C{index of linked list of Pages objects}\par
\P\D \37$\\{obj\_type\_font}\S3$\C{index of linked list of Fonts objects}\par
\P\D \37$\\{obj\_type\_outline}\S4$\C{index of linked list of outline objects}%
\par
\P\D \37$\\{obj\_type\_dest}\S5$\C{index of linked list of destination objects}%
\par
\P\D \37$\\{obj\_type\_struct\_dest}\S6$\C{index of linked list of structure
destination objects}\par
\P\D \37$\\{obj\_type\_obj}\S7$\C{index of linked list of raw objects}\par
\P\D \37$\\{obj\_type\_xform}\S8$\C{index of linked list of XObject forms}\par
\P\D \37$\\{obj\_type\_ximage}\S9$\C{index of linked list of XObject image}\par
\P\D \37$\\{obj\_type\_thread}\S10$\C{index of linked list of num article
threads}\par
\P\D \37$\\{head\_tab\_max}\S\\{obj\_type\_thread}$\C{max index of \\{head%
\_tab}}\7
\C{max number of kids for balanced trees}\par
\P\D \37$\\{pages\_tree\_kids\_max}\S6$\C{max number of kids of Pages tree
node}\par
\P\D \37$\\{name\_tree\_kids\_max}\S6$\C{max number of kids of node of name
tree for name destinations}\7
\C{when a whatsit node representing annotation is created, words $1\to3$ are
width, height and depth of this annotation; after shipping out words $1\to4$
are rectangle specification of annotation. For whatsit node representing
destination \\{pdf\_left} and \\{pdf\_top} are used for some types of
destinations}\7
\C{coordinates of destinations/threads/annotations (in whatsit node)}\par
\P\D \37$\\{pdf\_left}(\#)\S\\{mem}[\#+1].\\{sc}$\par
\P\D \37$\\{pdf\_top}(\#)\S\\{mem}[\#+2].\\{sc}$\par
\P\D \37$\\{pdf\_right}(\#)\S\\{mem}[\#+3].\\{sc}$\par
\P\D \37$\\{pdf\_bottom}(\#)\S\\{mem}[\#+4].\\{sc}$\7
\C{dimension of destinations/threads/annotations (in whatsit node)}\par
\P\D \37$\\{pdf\_width}(\#)\S\\{mem}[\#+1].\\{sc}$\par
\P\D \37$\\{pdf\_height}(\#)\S\\{mem}[\#+2].\\{sc}$\par
\P\D \37$\\{pdf\_depth}(\#)\S\\{mem}[\#+3].\\{sc}$\7
\C{data structure for \.{\\pdfliteral}}\par
\P\D \37$\\{pdf\_literal\_data}(\#)\S\\{link}(\#+1)$\C{data}\par
\P\D \37$\\{pdf\_literal\_mode}(\#)\S\\{info}(\#+1)$\C{mode of resetting the
text matrix                               while writing data to the page
stream}\7
\C{modes of setting the current transformation matrix (CTM)}\par
\P\D \37$\\{set\_origin}\S0$\C{end text (ET) if needed, set CTM to current
point}\par
\P\D \37$\\{direct\_page}\S1$\C{end text (ET) if needed, but don't change the
CTM}\par
\P\D \37$\\{direct\_always}\S2$\C{don't end text, don't change the CTM}\par
\P\D \37$\\{scan\_special}\S3$\C{look into special text}\7
\C{data structure for \.{\\pdfcolorstack}}\par
\P\D \37$\\{pdf\_colorstack\_node\_size}\S3$\par
\P\D \37$\\{pdf\_colorstack\_setter\_node\_size}\S3$\par
\P\D \37$\\{pdf\_colorstack\_getter\_node\_size}\S2$\par
\P\D \37$\\{pdf\_colorstack\_stack}(\#)\S\\{link}(\#+1)$\C{stack number}\par
\P\D \37$\\{pdf\_colorstack\_cmd}(\#)\S\\{info}(\#+1)$\C{command: set, push,
pop, current}\par
\P\D \37$\\{pdf\_colorstack\_data}(\#)\S\\{link}(\#+2)$\C{data}\7
\C{color stack commands}\par
\P\D \37$\\{colorstack\_set}\S0$\par
\P\D \37$\\{colorstack\_push}\S1$\par
\P\D \37$\\{colorstack\_data}\S1$\C{ last value where data field is set }\par
\P\D \37$\\{colorstack\_pop}\S2$\par
\P\D \37$\\{colorstack\_current}\S3$\7
\C{data structure for \.{\\pdfsetmatrix}}\par
\P\D \37$\\{pdf\_setmatrix\_node\_size}\S2$\par
\P\D \37$\\{pdf\_setmatrix\_data}(\#)\S\\{link}(\#+1)$\C{data}\7
\C{data structure for \.{\\pdfsave}}\par
\P\D \37$\\{pdf\_save\_node\_size}\S2$\7
\C{data structure for \.{\\pdfrestore}}\par
\P\D \37$\\{pdf\_restore\_node\_size}\S2$\7
\C{data structure for \.{\\pdfobj} and \.{\\pdfrefobj}}\par
\P\D \37$\\{pdf\_refobj\_node\_size}\S2$\C{size of whatsit node representing
the raw object}\par
\P\D \37$\\{pdf\_obj\_objnum}(\#)\S\\{info}(\#+1)$\C{number of the raw object}%
\par
\P\D \37$\\{obj\_data\_ptr}\S\\{obj\_aux}$\C{pointer to \\{pdf\_mem}}\par
\P\D \37$\\{pdfmem\_obj\_size}\S4$\C{size of memory in \\{pdf\_mem} which
                        \\{obj\_data\_ptr} holds}\par
\P\D \37$\\{obj\_obj\_data}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+0]$%
\C{object data}\par
\P\D \37$\\{obj\_obj\_is\_stream}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+1]$%
\C{will this object                               be written as a stream
instead of a dictionary?}\par
\P\D \37$\\{obj\_obj\_stream\_attr}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(%
\#)+2]$\C{additional                               object attributes for
streams}\par
\P\D \37$\\{obj\_obj\_is\_file}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+3]$%
\C{data should be                               read from an external file?}\7
\C{data structure for \.{\\pdfxform} and \.{\\pdfrefxform}}\par
\P\D \37$\\{pdf\_refxform\_node\_size}\S5$\C{size of whatsit node for xform;
words 1..3 are                               form dimensions}\par
\P\D \37$\\{pdf\_xform\_objnum}(\#)\S\\{info}(\#+4)$\C{object number}\par
\P\D \37$\\{pdfmem\_xform\_size}\S6$\C{size of memory in \\{pdf\_mem} which
                          \\{obj\_data\_ptr} holds}\par
\P\D \37$\\{obj\_xform\_width}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+0]$\par
\P\D \37$\\{obj\_xform\_height}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+1]$\par
\P\D \37$\\{obj\_xform\_depth}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+2]$\par
\P\D \37$\\{obj\_xform\_box}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+3]$%
\C{this field holds                               pointer to the corresponding
box}\par
\P\D \37$\\{obj\_xform\_attr}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+4]$%
\C{additional xform                               attributes}\par
\P\D \37$\\{obj\_xform\_resources}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+5]$%
\C{additional xform                               Resources}\7
\C{data structure for \.{\\pdfximage} and \.{\\pdfrefximage}}\par
\P\D \37$\\{pdf\_refximage\_node\_size}\S5$\C{size of whatsit node for ximage;
words 1..3                                are image dimensions}\par
\P\D \37$\\{pdf\_ximage\_objnum}(\#)\S\\{info}(\#+4)$\C{object number}\par
\P\D \37$\\{pdfmem\_ximage\_size}\S5$\C{size of memory in \\{pdf\_mem} which
                           \\{obj\_data\_ptr} holds}\par
\P\D \37$\\{obj\_ximage\_width}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+0]$\par
\P\D \37$\\{obj\_ximage\_height}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+1]$%
\par
\P\D \37$\\{obj\_ximage\_depth}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+2]$\par
\P\D \37$\\{obj\_ximage\_attr}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+3]$%
\C{additional ximage attributes}\par
\P\D \37$\\{obj\_ximage\_data}(\#)\S\\{pdf\_mem}[\\{obj\_data\_ptr}(\#)+4]$%
\C{pointer to image data}\7
\C{data structure of annotations; words 1..4 represent the coordinates of
the annotation}\par
\P\D \37$\\{obj\_annot\_ptr}\S\\{obj\_aux}$\C{pointer to corresponding whatsit
node}\par
\P\D \37$\\{pdf\_annot\_node\_size}\S7$\C{size of whatsit node representing
annotation}\par
\P\D \37$\\{pdf\_annot\_data}(\#)\S\\{info}(\#+5)$\C{raw data of general
annotations}\par
\P\D \37$\\{pdf\_link\_attr}(\#)\S\\{info}(\#+5)$\C{attributes of link
annotations}\par
\P\D \37$\\{pdf\_link\_action}(\#)\S\\{link}(\#+5)$\C{pointer to action
structure}\par
\P\D \37$\\{pdf\_annot\_objnum}(\#)\S\\{mem}[\#+6].\\{int}$\C{object number of
corresponding object}\par
\P\D \37$\\{pdf\_link\_objnum}(\#)\S\\{mem}[\#+6].\\{int}$\C{object number of
corresponding object}\7
\C{types of actions}\par
\P\D \37$\\{pdf\_action\_page}\S0$\C{GoTo action}\par
\P\D \37$\\{pdf\_action\_goto}\S1$\C{GoTo action}\par
\P\D \37$\\{pdf\_action\_thread}\S2$\C{Thread action}\par
\P\D \37$\\{pdf\_action\_user}\S3$\C{user-defined action}\7
\C{data structure of actions}\par
\P\D \37$\\{pdf\_action\_size}\S4$\C{size of action structure in \\{mem}}\par
\P\D \37$\\{pdf\_action\_type}\S\\{type}$\C{action type}\par
\P\D \37$\\{pdf\_action\_named\_id}\S\\{subtype}$\C{identifier is type of name}%
\par
\P\D \37$\\{pdf\_action\_id}\S\\{link}$\C{destination/thread name identifier}%
\par
\P\D \37$\\{pdf\_action\_file}(\#)\S\\{info}(\#+1)$\C{file name for external
action}\par
\P\D \37$\\{pdf\_action\_new\_window}(\#)\S\\{link}(\#+1)$\C{open a new
window?}\par
\P\D \37$\\{pdf\_action\_page\_tokens}(\#)\S\\{info}(\#+2)$\C{specification of
GoTo page action}\par
\P\D \37$\\{pdf\_action\_user\_tokens}(\#)\S\\{info}(\#+2)$\C{user-defined
action string}\par
\P\D \37$\\{pdf\_action\_refcount}(\#)\S\\{link}(\#+2)$\C{counter of references
to this action}\par
\P\D \37$\\{pdf\_action\_struct\_id}(\#)\S\\{link}(\#+3)$\C{structure
destination identifier}\7
\C{data structure of outlines; it's not able to write out outline entries
before all outline entries are defined, so memory allocated for outline entries
can't not be deallocated and will stay in memory. For this reason we will store
data of outline entries in \\{pdf\_mem} instead of \\{mem}}\par
\P\D \37$\\{pdfmem\_outline\_size}\S8$\C{size of memory in \\{pdf\_mem} which %
\\{obj\_outline\_ptr} points to}\par
\P\D \37$\\{obj\_outline\_count}\S\\{obj\_info}$\C{count of all opened
children}\par
\P\D \37$\\{obj\_outline\_ptr}\S\\{obj\_aux}$\C{pointer to \\{pdf\_mem}}\par
\P\D \37$\\{obj\_outline\_title}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(\#)]$%
\par
\P\D \37$\\{obj\_outline\_parent}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(%
\#)+1]$\par
\P\D \37$\\{obj\_outline\_prev}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(\#)+2]$%
\par
\P\D \37$\\{obj\_outline\_next}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(\#)+3]$%
\par
\P\D \37$\\{obj\_outline\_first}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(%
\#)+4]$\par
\P\D \37$\\{obj\_outline\_last}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(\#)+5]$%
\par
\P\D \37$\\{obj\_outline\_action\_objnum}(\#)\S\\{pdf\_mem}[\\{obj\_outline%
\_ptr}(\#)+6]$\C{object number of action}\par
\P\D \37$\\{obj\_outline\_attr}(\#)\S\\{pdf\_mem}[\\{obj\_outline\_ptr}(\#)+7]$%
\7
\C{types of destinations}\par
\P\D \37$\\{pdf\_dest\_xyz}\S0$\par
\P\D \37$\\{pdf\_dest\_fit}\S1$\par
\P\D \37$\\{pdf\_dest\_fith}\S2$\par
\P\D \37$\\{pdf\_dest\_fitv}\S3$\par
\P\D \37$\\{pdf\_dest\_fitb}\S4$\par
\P\D \37$\\{pdf\_dest\_fitbh}\S5$\par
\P\D \37$\\{pdf\_dest\_fitbv}\S6$\par
\P\D \37$\\{pdf\_dest\_fitr}\S7$\7
\C{data structure of structure and regular destinations}\par
\P\D \37$\\{obj\_dest\_ptr}\S\\{obj\_aux}$\C{pointer to \\{pdf\_dest\_node}}\par
\P\D \37$\\{pdf\_dest\_node\_size}\S7$\C{size of whatsit node for destination;
words $1\to4$ hold dest dimensions, word 6 identifier type, subtype and
identifier of destination, word 6 the corresponding object number}\par
\P\D \37$\\{pdf\_dest\_type}(\#)\S\\{type}(\#+5)$\C{type of destination}\par
\P\D \37$\\{pdf\_dest\_named\_id}(\#)\S\\{subtype}(\#+5)$\C{is named
identifier?}\par
\P\D \37$\\{pdf\_dest\_id}(\#)\S\\{link}(\#+5)$\C{destination identifier}\par
\P\D \37$\\{pdf\_dest\_xyz\_zoom}(\#)\S\\{info}(\#+6)$\C{zoom factor for %
\\{destxyz} destination}\par
\P\D \37$\\{pdf\_dest\_objnum}(\#)\S\\{link}(\#+6)$\C{object number of
corresponding object}\7
\C{data structure of threads; words 1..4 represent the coordinates of the
corners}\par
\P\D \37$\\{pdf\_thread\_node\_size}\S7$\par
\P\D \37$\\{pdf\_thread\_named\_id}(\#)\S\\{subtype}(\#+5)$\C{is a named
identifier}\par
\P\D \37$\\{pdf\_thread\_id}(\#)\S\\{link}(\#+5)$\C{thread identifier}\par
\P\D \37$\\{pdf\_thread\_attr}(\#)\S\\{info}(\#+6)$\C{attributes of thread}\par
\P\D \37$\\{obj\_thread\_first}\S\\{obj\_aux}$\C{pointer to the first bead}\7
\C{data structure of beads}\par
\P\D \37$\\{pdfmem\_bead\_size}\S5$\C{size of memory in \\{pdf\_mem} which
                             \\{obj\_bead\_ptr} points to}\par
\P\D \37$\\{obj\_bead\_ptr}\S\\{obj\_aux}$\C{pointer to \\{pdf\_mem}}\par
\P\D \37$\\{obj\_bead\_rect}(\#)\S\\{pdf\_mem}[\\{obj\_bead\_ptr}(\#)]$\par
\P\D \37$\\{obj\_bead\_page}(\#)\S\\{pdf\_mem}[\\{obj\_bead\_ptr}(\#)+1]$\par
\P\D \37$\\{obj\_bead\_next}(\#)\S\\{pdf\_mem}[\\{obj\_bead\_ptr}(\#)+2]$\par
\P\D \37$\\{obj\_bead\_prev}(\#)\S\\{pdf\_mem}[\\{obj\_bead\_ptr}(\#)+3]$\par
\P\D \37$\\{obj\_bead\_attr}(\#)\S\\{pdf\_mem}[\\{obj\_bead\_ptr}(\#)+4]$\par
\P\D \37$\\{obj\_bead\_data}\S\\{obj\_bead\_rect}$\C{pointer to the
corresponding whatsit node; \\{obj\_bead\_rect} is needed only when the bead
rectangle has been written out and after that \\{obj\_bead\_data} is not needed
any more so we can use this field for both}\7
\C{data structure of snap node}\par
\P\D \37$\\{snap\_node\_size}\S3$\par
\P\D \37$\\{snap\_glue\_ptr}(\#)\S\\{info}(\#+1)$\par
\P\D \37$\\{final\_skip}(\#)\S\\{mem}[\#+2].\\{sc}$\C{the amount to skip}\7
\C{data structure of snap compensation node}\par
\P\D \37$\\{snapy\_comp\_ratio}(\#)\S\\{mem}[\#+1].\\{int}$\par
\Y\P$\4\X11:Constants in the outer block\X\mathrel{+}\S$\6
$\\{inf\_obj\_tab\_size}=1000$;\C{min size of the cross-reference table for PDF
output}\6
$\\{sup\_obj\_tab\_size}=8388607$;\C{max size of the cross-reference table for
PDF output}\6
$\\{inf\_dest\_names\_size}=1000$;\C{min size of the destination names table
for PDF output}\6
$\\{sup\_dest\_names\_size}=500000$;\C{max size of the destination names table
for PDF output}\6
$\\{inf\_pk\_dpi}=72$;\C{min PK pixel density value from \.{texmf.cnf}}\6
$\\{sup\_pk\_dpi}=8000$;\C{max PK pixel density value from \.{texmf.cnf}}\6
$\\{pdf\_objtype\_max}=\\{head\_tab\_max}$;\par
\fi

\M696. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{obj\_tab\_size}: \37\\{integer};\6
\4\\{obj\_tab}: \37$\^\\{obj\_entry}$;\6
\4\\{head\_tab}: \37\&{array} $[1\to\\{head\_tab\_max}]$ \1\&{of}\5
\\{integer};\2\6
\4\\{pages\_tail}: \37\\{integer};\6
\4\\{obj\_ptr}: \37\\{integer};\C{user objects counter}\6
\4\\{sys\_obj\_ptr}: \37\\{integer};\C{system objects counter, including object
streams}\6
\4\\{pdf\_last\_pages}: \37\\{integer};\C{pointer to most recently generated
pages object}\6
\4\\{pdf\_last\_page}: \37\\{integer};\C{pointer to most recently generated
page object}\6
\4\\{pdf\_last\_stream}: \37\\{integer};\C{pointer to most recently generated
stream}\6
\4\\{pdf\_stream\_length}: \37\\{longinteger};\C{length of most recently
generated stream}\6
\4\\{pdf\_stream\_length\_offset}: \37\\{longinteger};\C{file offset of the
last stream length}\6
\4\\{pdf\_seek\_write\_length}: \37\\{boolean};\C{flag whether to seek back and
write \.{/Length}}\6
\4\\{pdf\_last\_byte}: \37\\{eight\_bits};\C{byte most recently written to PDF
file; for \.{endstream} in new line}\6
\4\\{pdf\_append\_list\_arg}: \37\\{integer};\C{for use with \\{pdf\_append%
\_list}}\6
\4\\{ff}: \37\\{integer};\C{for use with \\{set\_ff}}\6
\4\\{pdf\_box\_spec\_media}: \37\\{integer};\6
\4\\{pdf\_box\_spec\_crop}: \37\\{integer};\6
\4\\{pdf\_box\_spec\_bleed}: \37\\{integer};\6
\4\\{pdf\_box\_spec\_trim}: \37\\{integer};\6
\4\\{pdf\_box\_spec\_art}: \37\\{integer};\par
\fi

\M697. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{obj\_ptr}\K0$;\5
$\\{sys\_obj\_ptr}\K0$;\5
$\\{obj\_tab\_size}\K\\{inf\_obj\_tab\_size}$;\C{allocated size of \\{obj\_tab}
array}\6
$\\{dest\_names\_size}\K\\{inf\_dest\_names\_size}$;\C{allocated size of %
\\{dest\_names} array}\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{head\_tab\_max}$ \1\&{do}\5
$\\{head\_tab}[\|k]\K0$;\2\6
$\\{pdf\_box\_spec\_media}\K1$;\5
$\\{pdf\_box\_spec\_crop}\K2$;\5
$\\{pdf\_box\_spec\_bleed}\K3$;\5
$\\{pdf\_box\_spec\_trim}\K4$;\5
$\\{pdf\_box\_spec\_art}\K5$;\5
$\\{pdf\_dummy\_font}\K\\{null\_font}$;\par
\fi

\M698. Here we implement subroutines for work with objects and related things.
Some of them are used in former parts too, so we need to declare them
forward.

\Y\P\D \37$\\{pdf\_append\_list\_end}(\#)\S\#\K\\{append\_ptr}(\#,\39\\{pdf%
\_append\_list\_arg})$; \6
\&{end} \par
\P\D $\\{pdf\_append\_list}(\#)\S$ \6
\&{begin} \37$\\{pdf\_append\_list\_arg}\K\#$;\5
\\{pdf\_append\_list\_end}\par
\P\D \37$\\{set\_ff}(\#)\S$\1\6
\&{begin} \37\&{if} $\\{pdf\_font\_num}[\#]<0$ \1\&{then}\5
$\\{ff}\K-\\{pdf\_font\_num}[\#]$\6
\4\&{else} $\\{ff}\K\#$;\2\6
\&{end}\2\par
\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{append\_dest\_name}(\|s:\\{str\_number};\,\35\|n:%
\\{integer})$;\6
\4\&{var} \37\|a: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{pdf\_dest\_names\_ptr}=\\{sup\_dest\_names\_size}$ \1%
\&{then}\5
$\\{overflow}(\.{"number\ of\ destination\ names\ (dest\_names\_size)"},\39%
\\{dest\_names\_size})$;\2\6
\&{if} $\\{pdf\_dest\_names\_ptr}=\\{dest\_names\_size}$ \1\&{then}\6
\&{begin} \37$\|a\K0.2\ast\\{dest\_names\_size}$;\6
\&{if} $\\{dest\_names\_size}<\\{sup\_dest\_names\_size}-\|a$ \1\&{then}\5
$\\{dest\_names\_size}\K\\{dest\_names\_size}+\|a$\6
\4\&{else} $\\{dest\_names\_size}\K\\{sup\_dest\_names\_size}$;\2\6
$\\{dest\_names}\K\\{xrealloc\_array}(\\{dest\_names},\39\\{dest\_name\_entry},%
\39\\{dest\_names\_size})$;\6
\&{end};\2\6
$\\{dest\_names}[\\{pdf\_dest\_names\_ptr}].\\{objname}\K\|s$;\5
$\\{dest\_names}[\\{pdf\_dest\_names\_ptr}].\\{objnum}\K\|n$;\5
$\\{incr}(\\{pdf\_dest\_names\_ptr})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_create\_obj}(\|t,\39\|i:\\{integer})$;\C{create
an object with type \|t and identifier \|i}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37$\|a,\39\|p,\39\|q$: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{sys\_obj\_ptr}=\\{sup\_obj\_tab\_size}$ \1\&{then}\5
$\\{overflow}(\.{"indirect\ objects\ table\ size"},\39\\{obj\_tab\_size})$;\2\6
\&{if} $\\{sys\_obj\_ptr}=\\{obj\_tab\_size}$ \1\&{then}\6
\&{begin} \37$\|a\K0.2\ast\\{obj\_tab\_size}$;\6
\&{if} $\\{obj\_tab\_size}<\\{sup\_obj\_tab\_size}-\|a$ \1\&{then}\5
$\\{obj\_tab\_size}\K\\{obj\_tab\_size}+\|a$\6
\4\&{else} $\\{obj\_tab\_size}\K\\{sup\_obj\_tab\_size}$;\2\6
$\\{obj\_tab}\K\\{xrealloc\_array}(\\{obj\_tab},\39\\{obj\_entry},\39\\{obj%
\_tab\_size})$;\6
\&{end};\2\6
$\\{incr}(\\{sys\_obj\_ptr})$;\5
$\\{obj\_ptr}\K\\{sys\_obj\_ptr}$;\5
$\\{obj\_info}(\\{obj\_ptr})\K\|i$;\5
$\\{set\_obj\_fresh}(\\{obj\_ptr})$;\5
$\\{obj\_aux}(\\{obj\_ptr})\K0$;\5
$\\{avl\_put\_obj}(\\{obj\_ptr},\39\|t)$;\6
\&{if} $\|t=\\{obj\_type\_page}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{head\_tab}[\|t]$;\C{find the right position to insert
newly created object}\6
\&{if} $(\|p=0)\V(\\{obj\_info}(\|p)<\|i)$ \1\&{then}\6
\&{begin} \37$\\{obj\_link}(\\{obj\_ptr})\K\|p$;\5
$\\{head\_tab}[\|t]\K\\{obj\_ptr}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{while} $\|p\I0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{obj\_info}(\|p)<\|i$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|q\K\|p$;\5
$\|p\K\\{obj\_link}(\|p)$;\6
\&{end};\2\6
\4\\{done}: \37$\\{obj\_link}(\|q)\K\\{obj\_ptr}$;\5
$\\{obj\_link}(\\{obj\_ptr})\K\|p$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\|t\I\\{obj\_type\_others}$ \1\&{then}\6
\&{begin} \37$\\{obj\_link}(\\{obj\_ptr})\K\\{head\_tab}[\|t]$;\5
$\\{head\_tab}[\|t]\K\\{obj\_ptr}$;\6
\&{if} $(\|t=\\{obj\_type\_dest})\W(\|i<0)$ \1\&{then}\5
$\\{append\_dest\_name}(-\\{obj\_info}(\\{obj\_ptr}),\39\\{obj\_ptr})$;\2\6
\&{end};\2\2\6
\&{end};\6
\4\&{function}\1\  \37\\{pdf\_new\_objnum}: \37\\{integer};\C{create a new
object and return its number}\2\6
\&{begin} \37$\\{pdf\_create\_obj}(\\{obj\_type\_others},\390)$;\5
$\\{pdf\_new\_objnum}\K\\{obj\_ptr}$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_os\_switch}(\\{pdf\_os}:\\{boolean})$;\C{switch
between PDF stream and object stream mode}\2\6
\&{begin} \37\&{if} $\\{pdf\_os}\W\\{pdf\_os\_enable}$ \1\&{then}\6
\&{begin} \37\&{if} $\R\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37\C{back up PDF stream variables}\6
$\\{pdf\_op\_ptr}\K\\{pdf\_ptr}$;\5
$\\{pdf\_ptr}\K\\{pdf\_os\_ptr}$;\5
$\\{pdf\_buf}\K\\{pdf\_os\_buf}$;\5
$\\{pdf\_buf\_size}\K\\{pdf\_os\_buf\_size}$;\5
$\\{pdf\_os\_mode}\K\\{true}$;\C{switch to object stream}\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37\C{back up object stream variables}\6
$\\{pdf\_os\_ptr}\K\\{pdf\_ptr}$;\5
$\\{pdf\_ptr}\K\\{pdf\_op\_ptr}$;\5
$\\{pdf\_buf}\K\\{pdf\_op\_buf}$;\5
$\\{pdf\_buf\_size}\K\\{pdf\_op\_buf\_size}$;\5
$\\{pdf\_os\_mode}\K\\{false}$;\C{switch to PDF stream}\6
\&{end};\2\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_os\_prepare\_obj}(\|i:\\{integer};\,\35\\{pdf%
\_os\_level}:\\{integer})$;\C{create new \.{/ObjStm} object if required, and
set up cross reference info}\2\6
\&{begin} \37$\\{pdf\_os\_switch}((\\{pdf\_os\_level}>0)\W(\\{fixed\_pdf%
\_objcompresslevel}\G\\{pdf\_os\_level}))$;\6
\&{if} $\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_os\_cur\_objnum}=0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_os\_cur\_objnum}\K\\{pdf\_new\_objnum}$;\5
$\\{decr}(\\{obj\_ptr})$;\C{object stream is not accessible to user}\6
$\\{incr}(\\{pdf\_os\_cntr})$;\C{only for statistics}\6
$\\{pdf\_os\_objidx}\K0$;\5
$\\{pdf\_ptr}\K0$;\C{start fresh object stream}\6
\&{end}\6
\4\&{else} $\\{incr}(\\{pdf\_os\_objidx})$;\2\6
$\\{obj\_os\_idx}(\|i)\K\\{pdf\_os\_objidx}$;\5
$\\{obj\_offset}(\|i)\K\\{pdf\_os\_cur\_objnum}$;\5
$\\{pdf\_os\_objnum}[\\{pdf\_os\_objidx}]\K\|i$;\5
$\\{pdf\_os\_objoff}[\\{pdf\_os\_objidx}]\K\\{pdf\_ptr}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{obj\_offset}(\|i)\K\\{pdf\_offset}$;\5
$\\{obj\_os\_idx}(\|i)\K-1$;\C{mark it as not included in object stream}\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_begin\_obj}(\|i:\\{integer};\,\35\\{pdf\_os%
\_level}:\\{integer})$;\C{begin a PDF object}\2\6
\&{begin} \37\\{check\_pdfversion};\5
$\\{pdf\_os\_prepare\_obj}(\|i,\39\\{pdf\_os\_level})$;\6
\&{if} $\R\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_int}(\|i)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ obj"})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{pdf\_compress\_level}=0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"\%\ "})$;\C{debugging help}\6
$\\{pdf\_print\_int}(\|i)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ obj"})$;\6
\&{end};\2\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_new\_obj}(\|t,\39\|i:\\{integer};\,\35\\{pdf%
\_os}:\\{integer})$;\C{begin a new PDF object}\2\6
\&{begin} \37$\\{pdf\_create\_obj}(\|t,\39\|i)$;\5
$\\{pdf\_begin\_obj}(\\{obj\_ptr},\39\\{pdf\_os})$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_obj};\C{end a PDF object}\2\6
\&{begin} \37\&{if} $\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_os\_objidx}=\\{pdf\_os\_max\_objs}-1$ \1\&{then}\5
\\{pdf\_os\_write\_objstream};\2\6
\&{end}\6
\4\&{else} $\\{pdf\_print\_ln}(\.{"endobj"})$;\C{end a PDF object}\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_begin\_dict}(\|i:\\{integer};\,\35\\{pdf\_os%
\_level}:\\{integer})$;\C{begin a PDF dictionary object}\2\6
\&{begin} \37\\{check\_pdfversion};\5
$\\{pdf\_os\_prepare\_obj}(\|i,\39\\{pdf\_os\_level})$;\6
\&{if} $\R\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_int}(\|i)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ obj"})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{pdf\_compress\_level}=0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"\%\ "})$;\C{debugging help}\6
$\\{pdf\_print\_int}(\|i)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ obj"})$;\6
\&{end};\2\2\6
$\\{pdf\_print\_ln}(\.{"<<"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_new\_dict}(\|t,\39\|i:\\{integer};\,\35\\{pdf%
\_os}:\\{integer})$;\C{begin a new PDF dictionary object}\2\6
\&{begin} \37$\\{pdf\_create\_obj}(\|t,\39\|i)$;\5
$\\{pdf\_begin\_dict}(\\{obj\_ptr},\39\\{pdf\_os})$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_end\_dict};\C{end a PDF dictionary object}\2\6
\&{begin} \37\&{if} $\\{pdf\_os\_mode}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{">>"})$;\6
\&{if} $\\{pdf\_os\_objidx}=\\{pdf\_os\_max\_objs}-1$ \1\&{then}\5
\\{pdf\_os\_write\_objstream};\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_ln}(\.{">>"})$;\5
$\\{pdf\_print\_ln}(\.{"endobj"})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M699. Write out an accumulated object stream.
First the object number and byte offset pairs are generated
and appended to the ready buffered object stream.
By this the value of \.{/First} can be calculated.
Then a new \.{/ObjStm} object is generated, and everything is
copied to the PDF output buffer, where also compression is done.
When calling this procedure, \\{pdf\_os\_mode} must be \\{true}.

\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{pdf\_os\_write\_objstream};\6
\4\&{var} \37$\|i,\39\|j,\39\|p,\39\|q$: \37\\{pointer};\2\6
\&{begin} \37\&{if} $\\{pdf\_os\_cur\_objnum}=0$ \1\&{then}\C{no object stream
started}\6
\&{return};\2\6
$\|p\K\\{pdf\_ptr}$;\5
$\|i\K0$;\5
$\|j\K0$;\6
\&{while} $\|i\L\\{pdf\_os\_objidx}$ \1\&{do}\6
\&{begin} \37\C{assemble object number and byte offset pairs}\6
$\\{pdf\_print\_int}(\\{pdf\_os\_objnum}[\|i])$;\5
$\\{pdf\_print}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\\{pdf\_os\_objoff}[\|i])$;\6
\&{if} $\|j=9$ \1\&{then}\6
\&{begin} \37\C{print out in groups of ten for better readability}\6
$\\{pdf\_out}(\\{pdf\_new\_line\_char})$;\5
$\|j\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print}(\.{"\ "})$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
$\\{incr}(\|i)$;\6
\&{end};\2\6
$\\{pdf\_buf}[\\{pdf\_ptr}-1]\K\\{pdf\_new\_line\_char}$;\C{no risk of flush,
as we are in \\{pdf\_os\_mode}}\6
$\|q\K\\{pdf\_ptr}$;\5
$\\{pdf\_begin\_dict}(\\{pdf\_os\_cur\_objnum},\390)$;\C{switch to PDF stream
writing}\6
$\\{pdf\_print\_ln}(\.{"/Type\ /ObjStm"})$;\5
$\\{pdf\_print}(\.{"/N\ "})$;\5
$\\{pdf\_print\_int\_ln}(\\{pdf\_os\_objidx}+1)$;\5
$\\{pdf\_print}(\.{"/First\ "})$;\5
$\\{pdf\_print\_int\_ln}(\|q-\|p)$;\5
\\{pdf\_begin\_stream};\5
$\\{pdf\_room}(\|q-\|p)$;\C{should always fit into the PDF output buffer}\6
$\|i\K\|p$;\6
\&{while} $\|i<\|q$ \1\&{do}\6
\&{begin} \37\C{write object number and byte offset pairs}\6
$\\{pdf\_quick\_out}(\\{pdf\_os\_buf}[\|i])$;\5
$\\{incr}(\|i)$;\6
\&{end};\2\6
$\|i\K0$;\6
\&{while} $\|i<\|p$ \1\&{do}\6
\&{begin} \37$\|q\K\|i+\\{pdf\_buf\_size}$;\6
\&{if} $\|q>\|p$ \1\&{then}\5
$\|q\K\|p$;\2\6
$\\{pdf\_room}(\|q-\|i)$;\6
\&{while} $\|i<\|q$ \1\&{do}\6
\&{begin} \37\C{write the buffered objects}\6
$\\{pdf\_quick\_out}(\\{pdf\_os\_buf}[\|i])$;\5
$\\{incr}(\|i)$;\6
\&{end};\2\6
\&{end};\2\6
\\{pdf\_end\_stream};\5
$\\{pdf\_os\_cur\_objnum}\K0$;\C{to force object stream generation next time}\6
\&{end};\par
\fi

\M700. \P$\X686:Declare procedures that need to be declared forward for \pdfTeX%
\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{append\_ptr}(\|p:\\{pointer};\,\35\|i:\\{integer})$: %
\37\\{pointer};\C{appends a pointer with info \|i to the end of linked list
with head \|p}\6
\4\&{var} \37\|q: \37\\{pointer};\2\6
\&{begin} \37$\\{append\_ptr}\K\|p$;\5
$\\{fast\_get\_avail}(\|q)$;\5
$\\{info}(\|q)\K\|i$;\5
$\\{link}(\|q)\K\\{null}$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{append\_ptr}\K\|q$;\5
\&{return};\6
\&{end};\2\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{link}(\|p)\K\|q$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{pdf\_lookup\_list}(\|p:\\{pointer};\,\35\|i:%
\\{integer})$: \37\\{pointer};\C{looks up for pointer with info \|i in list %
\|p}\2\6
\&{begin} \37$\\{pdf\_lookup\_list}\K\\{null}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{info}(\|p)=\|i$ \1\&{then}\6
\&{begin} \37$\\{pdf\_lookup\_list}\K\|p$;\5
\&{return};\6
\&{end};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M701. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_image\_procset}: \37\\{integer};\C{collection of image types used in
current page/form}\6
\4\\{pdf\_text\_procset}: \37\\{boolean};\C{mask of used ProcSet's in the
current page/form}\par
\fi

\M702. Subroutines to print out various PDF objects:

\Y\P\D \37$\\{is\_hex\_char}(\#)\S(((\#\G\.{\'0\'})\W(\#\L\.{\'9\'}))\V((\#\G%
\.{\'A\'})\W(\#\L\.{\'F\'}))\V((\#\G\.{\'a\'})\W(\#\L\.{\'f\'})))$\par
\Y\P\4\&{procedure}\1\  \37$\\{pdf\_print\_fw\_int}(\|n:\\{longinteger};\,\35%
\|w:\\{integer})$;\C{print out an integer with fixed width; used for outputting
cross-reference table}\6
\4\&{var} \37\|k: \37\\{integer};\C{$0\le k\le23$}\2\6
\&{begin} \37$\|k\K0$;\6
\1\&{repeat} \37$\\{dig}[\|k]\K\|n\mathbin{\&{mod}}10$;\5
$\|n\K\|n\mathbin{\&{div}}10$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|k=\|w$;\2\6
$\\{pdf\_room}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\5
$\\{pdf\_quick\_out}(\.{"0"}+\\{dig}[\|k])$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_bytes}(\|n:\\{longinteger};\,\35\|w:%
\\{integer})$;\C{print out an integer as a number of bytes; used for outputting
\.{/XRef} cross-reference stream}\6
\4\&{var} \37\|k: \37\\{integer};\5
\\{byte}: \37\&{array} $[0\to7]$ \1\&{of}\5
\\{integer};\C{digits in a number being output}\2\2\6
\&{begin} \37$\|k\K0$;\6
\1\&{repeat} \37$\\{byte}[\|k]\K\|n\mathbin{\&{mod}}256$;\5
$\|n\K\|n\mathbin{\&{div}}256$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$\|k=\|w$;\2\6
$\\{pdf\_room}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|k)$;\5
$\\{pdf\_quick\_out}(\\{byte}[\|k])$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_int\_entry}(\|s:\\{str\_number};\,\35\|v:%
\\{integer})$;\C{print out an entry in dictionary with integer value to PDF
buffer}\2\6
\&{begin} \37$\\{pdf\_out}(\.{"/"})$;\5
$\\{pdf\_print}(\|s)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\|v)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_int\_entry\_ln}(\|s:\\{str\_number};\,\35\|v:%
\\{integer})$;\2\6
\&{begin} \37$\\{pdf\_int\_entry}(\|s,\39\|v)$;\5
\\{pdf\_print\_nl};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_indirect}(\|s:\\{str\_number};\,\35\|o:%
\\{integer})$;\C{print out an indirect entry in dictionary}\2\6
\&{begin} \37$\\{pdf\_out}(\.{"/"})$;\5
$\\{pdf\_print}(\|s)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\|o)$;\5
$\\{pdf\_print}(\.{"\ 0\ R"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_indirect\_ln}(\|s:\\{str\_number};\,\35\|o:%
\\{integer})$;\2\6
\&{begin} \37$\\{pdf\_indirect}(\|s,\39\|o)$;\5
\\{pdf\_print\_nl};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_str}(\|s:\\{str\_number})$;\C{print out %
\|s as string in PDF output}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37$\|i,\39\|j$: \37\\{pool\_pointer};\5
\\{is\_hex\_string}: \37\\{boolean};\2\6
\&{begin} \37$\|i\K\\{str\_start}[\|s]$;\5
$\|j\K\|i+\\{length}(\|s)-1$;\6
\&{if} $\|i>\|j$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"()"})$;\C{null string}\6
\&{return};\6
\&{end};\2\6
\&{if} $(\\{str\_pool}[\|i]=\.{\'(\'})\W(\\{str\_pool}[\|j]=\.{\')\'})$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_print}(\|s)$;\5
\&{return};\6
\&{end};\2\6
$\\{is\_hex\_string}\K\\{false}$;\6
\&{if} $(\\{str\_pool}[\|i]\I\.{\'<\'})\V(\\{str\_pool}[\|j]\I\.{\'>\'})\V%
\\{odd}(\\{length}(\|s))$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\\{incr}(\|i)$;\5
$\\{decr}(\|j)$;\6
\&{while} $\|i<\|j$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_hex\_char}(\\{str\_pool}[\|i])\W\\{is\_hex\_char}(%
\\{str\_pool}[\|i+1])$ \1\&{then}\5
$\|i\K\|i+2$\6
\4\&{else} \&{goto} \37\\{done};\2\6
\&{end};\2\6
$\\{is\_hex\_string}\K\\{true}$;\6
\4\\{done}: \37\&{if} $\\{is\_hex\_string}$ \1\&{then}\5
$\\{pdf\_print}(\|s)$\6
\4\&{else} \&{begin} \37$\\{pdf\_out}(\.{"("})$;\5
$\\{pdf\_print}(\|s)$;\5
$\\{pdf\_out}(\.{")"})$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_str\_ln}(\|s:\\{str\_number})$;\C{print
out \|s as string in PDF output}\2\6
\&{begin} \37$\\{pdf\_print\_str}(\|s)$;\5
\\{pdf\_print\_nl};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_str\_entry}(\|s,\39\|v:\\{str\_number})$;%
\C{print out an entry in dictionary with string value to PDF buffer}\2\6
\&{begin} \37\&{if} $\|v=0$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_out}(\.{"/"})$;\5
$\\{pdf\_print}(\|s)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_str}(\|v)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_str\_entry\_ln}(\|s,\39\|v:\\{str\_number})$;\2%
\6
\&{begin} \37\&{if} $\|v=0$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_str\_entry}(\|s,\39\|v)$;\5
\\{pdf\_print\_nl};\6
\&{end};\par
\fi

\N703.  \[32e] Font processing.  As \pdfTeX{} should also act as a back-end
driver,
it needs to support virtual fonts too. Information about virtual fonts can be
found in the source of some \.{DVI}-related programs.

Whenever we want to write out a character in a font to PDF output, we
should check whether the used font is a new (has not been used yet),
virtual or real font. The array \\{pdf\_font\_type} holds a flag of each used
font. After initialization the flag of each font is set to \\{new\_font\_type}.
The first time a character of a font is written out, \pdfTeX{} looks for
the corresponding virtual font. If the corresponding virtual font exists, then
the font type is set to \\{virtual\_font\_type}; otherwise it will be set to
\\{real\_font\_type}. \\{subst\_font\_type} indicates fonts that have been
substituted
during adjusting spacing. Such fonts are linked via the \\{pdf\_font\_elink}
array.

\Y\P\D \37$\\{new\_font\_type}=0$\C{new font (has not been used yet)}\par
\P\D \37$\\{virtual\_font\_type}=1$\C{virtual font}\par
\P\D \37$\\{real\_font\_type}=2$\C{real font}\par
\P\D \37$\\{subst\_font\_type}=3$\C{substituted font}\par
\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{pdf\_check\_vf\_cur\_val};\5
\\{forward}; \6
\4\&{procedure}\1\  \37\\{pdf\_init\_font\_cur\_val};\5
\\{forward}; \6
\4\&{procedure}\1\  \37\\{scan\_pdf\_ext\_toks};\5
\\{forward};\par
\fi

\M704. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_font\_type}: \37$\^\\{eight\_bits}$;\C{the type of font}\6
\4\\{pdf\_font\_attr}: \37$\^\\{str\_number}$;\C{pointer to additional
attributes}\6
\4\\{pdf\_font\_nobuiltin\_tounicode}: \37$\^\\{boolean}$;\C{disable generating
ToUnicode for this font?}\par
\fi

\M705. Here come some subroutines to deal with expanded fonts for HZ-algorithm.

\Y\P\D \37$\\{set\_char\_and\_font}(\#)\S$\1\6
\&{if} $\\{is\_char\_node}(\#)$ \1\&{then}\6
\&{begin} \37$\|c\K\\{character}(\#)$;\5
$\|f\K\\{font}(\#)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\#)=\\{ligature\_node}$ \1\&{then}\6
\&{begin} \37$\|c\K\\{character}(\\{lig\_char}(\#))$;\5
$\|f\K\\{font}(\\{lig\_char}(\#))$;\6
\&{end}\2\2\2\par
\P\D \37$\\{non\_existent\_path}\S\.{"///..."}$\par
\Y\P\4\&{procedure}\1\  \37$\\{set\_tag\_code}(\|f:\\{internal\_font\_number};%
\,\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\6
\4\&{var} \37\\{fixedi}: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\6
\&{begin} \37$\\{fixedi}\K\\{abs}(\\{fix\_int}(\|i,\39-7,\390))$;\6
\&{if} $\\{fixedi}\G4$ \1\&{then}\6
\&{begin} \37\&{if} $\\{char\_tag}(\\{char\_info}(\|f)(\|c))=\\{ext\_tag}$ \1%
\&{then}\5
$\\{op\_byte}(\\{char\_info}(\|f)(\|c))\K(\\{op\_byte}(\\{char\_info}(\|f)(%
\|c)))-\\{ext\_tag}$;\2\6
$\\{fixedi}\K\\{fixedi}-4$;\6
\&{end};\2\6
\&{if} $\\{fixedi}\G2$ \1\&{then}\6
\&{begin} \37\&{if} $\\{char\_tag}(\\{char\_info}(\|f)(\|c))=\\{list\_tag}$ \1%
\&{then}\5
$\\{op\_byte}(\\{char\_info}(\|f)(\|c))\K(\\{op\_byte}(\\{char\_info}(\|f)(%
\|c)))-\\{list\_tag}$;\2\6
$\\{fixedi}\K\\{fixedi}-2$;\6
\&{end};\2\6
\&{if} $\\{fixedi}\G1$ \1\&{then}\6
\&{begin} \37\&{if} $\\{char\_tag}(\\{char\_info}(\|f)(\|c))=\\{lig\_tag}$ \1%
\&{then}\5
$\\{op\_byte}(\\{char\_info}(\|f)(\|c))\K(\\{op\_byte}(\\{char\_info}(\|f)(%
\|c)))-\\{lig\_tag}$;\2\6
\&{end};\2\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_no\_ligatures}(\|f:\\{internal\_font%
\_number})$;\6
\4\&{var} \37\|c: \37\\{integer};\2\6
\&{begin} \37\&{for} $\|c\K\\{font\_bc}[\|f]\mathrel{\&{to}}\\{font\_ec}[\|f]$ %
\1\&{do}\6
\&{if} $\\{char\_exists}(\\{orig\_char\_info}(\|f)(\|c))$ \1\&{then}\6
\&{if} $\\{char\_tag}(\\{orig\_char\_info}(\|f)(\|c))=\\{lig\_tag}$ \1\&{then}\5
$\\{op\_byte}(\\{orig\_char\_info}(\|f)(\|c))\K(\\{op\_byte}(\\{orig\_char%
\_info}(\|f)(\|c)))-\\{lig\_tag}$;\2\2\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{init\_font\_base}(\|v:\\{integer})$: \37\\{integer};\6
\4\&{var} \37$\|i,\39\|j$: \37\\{integer};\2\6
\&{begin} \37$\|i\K\\{pdf\_get\_mem}(256)$;\6
\&{for} $\|j\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{pdf\_mem}[\|i+\|j]\K\|v$;\2\6
$\\{init\_font\_base}\K\|i$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_lp\_code}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_lp\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_lp\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_lp\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_rp\_code}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_rp\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_rp\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_rp\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_ef\_code}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_ef\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_ef\_base}[\|f]\K\\{init\_font\_base}(1000)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_ef\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\390,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_kn\_bs\_code}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_kn\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_kn\_bs\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_st\_bs\_code}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_st\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_st\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_st\_bs\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_sh\_bs\_code}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_sh\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_sh\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_sh\_bs\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_kn\_bc\_code}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_kn\_bc\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_bc\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_kn\_bc\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_kn\_ac\_code}(\|f:\\{internal\_font\_number};\,%
\35\|c:\\{eight\_bits};\,\35\|i:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_kn\_ac\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_ac\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_mem}[\\{pdf\_font\_kn\_ac\_base}[\|f]+\|c]\K\\{fix\_int}(\|i,\39-1000,%
\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{adjust\_interword\_glue}(\|p,\39\|g:\\{pointer})$;%
\C{adjust the interword glue \|g after a character \|p}\6
\4\&{var} \37$\\{kn},\39\\{st},\39\\{sh}$: \37\\{scaled};\5
$\|q,\39\|r$: \37\\{pointer};\5
\|c: \37\\{halfword};\5
\|f: \37\\{internal\_font\_number};\2\6
\&{begin} \37\&{if} $\R(\R\\{is\_char\_node}(\|g)\W\\{type}(\|g)=\\{glue%
\_node})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"adjust\_interword\_glue"},\39\.{"g\ is\ not\
a\ glue"},\39\\{true},\39\\{true})$;\5
\&{return};\6
\&{end};\2\6
$\|c\K\\{non\_char}$;\C{no char before interword glue yet}\6
$\\{set\_char\_and\_font}(\|p)$\C{set \|f and \|c if \|p is a char or ligature}%
\6
\4\&{else} \37\&{if} $(\\{type}(\|p)=\\{kern\_node})\W(\\{subtype}(\|p)=\\{auto%
\_kern})\W(\\{save\_tail}\I\\{null})$ \1\&{then}\6
\&{begin} \37$\|r\K\\{save\_tail}$;\6
\&{while} $(\\{link}(\|r)\I\\{null})\W(\\{link}(\|r)\I\|p)$ \1\&{do}\5
$\|r\K\\{link}(\|r)$;\2\6
\&{if} $(\\{link}(\|r)=\|p)$ \1\&{then}\5
$\\{set\_char\_and\_font}(\|r)$;\C{set \|f and \|c if \|r is a char or
ligature}\2\6
\&{end};\2\6
\&{if} $(\|c=\\{non\_char})$ \1\&{then}\5
\&{return};\2\6
$\\{kn}\K\\{get\_kn\_bs\_code}(\|f,\39\|c)$;\5
$\\{st}\K\\{get\_st\_bs\_code}(\|f,\39\|c)$;\5
$\\{sh}\K\\{get\_sh\_bs\_code}(\|f,\39\|c)$;\6
\&{if} $(\\{kn}\I0)\V(\\{st}\I0)\V(\\{sh}\I0)$ \1\&{then}\6
\&{begin} \37$\|q\K\\{new\_spec}(\\{glue\_ptr}(\|g))$;\5
$\\{delete\_glue\_ref}(\\{glue\_ptr}(\|g))$;\5
$\\{width}(\|q)\K\\{width}(\|q)+\\{round\_xn\_over\_d}(\\{quad}(\|f),\39\\{kn},%
\391000)$;\5
$\\{stretch}(\|q)\K\\{stretch}(\|q)+\\{round\_xn\_over\_d}(\\{quad}(\|f),\39%
\\{st},\391000)$;\5
$\\{shrink}(\|q)\K\\{shrink}(\|q)+\\{round\_xn\_over\_d}(\\{quad}(\|f),\39%
\\{sh},\391000)$;\5
$\\{glue\_ptr}(\|g)\K\|q$;\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_auto\_kern}(\|f:\\{internal\_font\_number};\,\35%
\|l,\39\|r:\\{halfword})$: \37\\{pointer};\C{return a pointer to an auto kern
node, or \\{null}}\6
\4\&{var} \37\\{tmp\_w}: \37\\{scaled};\5
\|k: \37\\{integer};\5
\|p: \37\\{pointer};\2\6
\&{begin} \37$\\{pdfassert}((\|l\G0)\W(\|r\G0))$;\5
$\\{get\_auto\_kern}\K\\{null}$;\6
\&{if} $(\\{pdf\_append\_kern}\L0)\W(\\{pdf\_prepend\_kern}\L0)$ \1\&{then}\5
\&{return};\2\6
$\\{tmp\_w}\K0$;\6
\&{if} $(\\{pdf\_append\_kern}>0)\W(\|l<\\{non\_char})$ \1\&{then}\6
\&{begin} \37$\|k\K\\{get\_kn\_ac\_code}(\|f,\39\|l)$;\6
\&{if} $\|k\I0$ \1\&{then}\5
$\\{tmp\_w}\K\\{round\_xn\_over\_d}(\\{quad}(\|f),\39\|k,\391000)$;\2\6
\&{end};\2\6
\&{if} $(\\{pdf\_prepend\_kern}>0)\W(\|r<\\{non\_char})$ \1\&{then}\6
\&{begin} \37$\|k\K\\{get\_kn\_bc\_code}(\|f,\39\|r)$;\6
\&{if} $\|k\I0$ \1\&{then}\5
$\\{tmp\_w}\K\\{tmp\_w}+\\{round\_xn\_over\_d}(\\{quad}(\|f),\39\|k,\391000)$;%
\2\6
\&{end};\2\6
\&{if} $\\{tmp\_w}\I0$ \1\&{then}\6
\&{begin} \37$\|p\K\\{new\_kern}(\\{tmp\_w})$;\5
$\\{subtype}(\|p)\K\\{auto\_kern}$;\5
$\\{get\_auto\_kern}\K\|p$;\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{expand\_font\_name}(\|f:\\{internal\_font\_number};\,%
\35\|e:\\{integer})$: \37\\{str\_number};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector}
setting}\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\\{font\_name}[\|f])$;\6
\&{if} $\|e>0$ \1\&{then}\5
$\\{print}(\.{"+"})$;\C{minus sign will be printed by \\{print\_int}}\2\6
$\\{print\_int}(\|e)$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{expand\_font\_name}\K\\{make\_string}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{auto\_expand\_font}(\|f:\\{internal\_font\_number};\,%
\35\|e:\\{integer})$: \37\\{internal\_font\_number};\C{creates an expanded font
from the base font; doesn't load expanded tfm at all}\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\5
$\\{nw},\39\\{nk},\39\\{ni},\39\|i$: \37\\{integer};\2\6
\&{begin} \37$\|k\K\\{font\_ptr}+1$;\5
$\\{incr}(\\{font\_ptr})$;\6
\&{if} $(\\{font\_ptr}\G\\{font\_max})$ \1\&{then}\5
$\\{overflow}(\.{"maximum\ internal\ font\ number\ (font\_max)"},\39\\{font%
\_max})$;\2\6
$\\{font\_name}[\|k]\K\\{expand\_font\_name}(\|f,\39\|e)$;\5
$\\{font\_area}[\|k]\K\\{font\_area}[\|f]$;\5
$\\{font\_id\_text}(\|k)\K\\{font\_id\_text}(\|f)$;\5
$\\{hyphen\_char}[\|k]\K\\{hyphen\_char}[\|f]$;\5
$\\{skew\_char}[\|k]\K\\{skew\_char}[\|f]$;\5
$\\{font\_bchar}[\|k]\K\\{font\_bchar}[\|f]$;\5
$\\{font\_false\_bchar}[\|k]\K\\{font\_false\_bchar}[\|f]$;\5
$\\{font\_bc}[\|k]\K\\{font\_bc}[\|f]$;\5
$\\{font\_ec}[\|k]\K\\{font\_ec}[\|f]$;\5
$\\{font\_size}[\|k]\K\\{font\_size}[\|f]$;\5
$\\{font\_dsize}[\|k]\K\\{font\_dsize}[\|f]$;\5
$\\{font\_params}[\|k]\K\\{font\_params}[\|f]$;\5
$\\{font\_glue}[\|k]\K\\{font\_glue}[\|f]$;\5
$\\{bchar\_label}[\|k]\K\\{bchar\_label}[\|f]$;\5
$\\{char\_base}[\|k]\K\\{char\_base}[\|f]$;\5
$\\{height\_base}[\|k]\K\\{height\_base}[\|f]$;\5
$\\{depth\_base}[\|k]\K\\{depth\_base}[\|f]$;\5
$\\{lig\_kern\_base}[\|k]\K\\{lig\_kern\_base}[\|f]$;\5
$\\{exten\_base}[\|k]\K\\{exten\_base}[\|f]$;\5
$\\{param\_base}[\|k]\K\\{param\_base}[\|f]$;\5
$\\{nw}\K\\{height\_base}[\|f]-\\{width\_base}[\|f]$;\5
$\\{ni}\K\\{lig\_kern\_base}[\|f]-\\{italic\_base}[\|f]$;\5
$\\{nk}\K\\{exten\_base}[\|f]-(\\{kern\_base}[\|f]+\\{kern\_base\_offset})$;\6
\&{if} $(\\{fmem\_ptr}+\\{nw}+\\{ni}+\\{nk}\G\\{font\_mem\_size})$ \1\&{then}\5
$\\{overflow}(\.{"number\ of\ words\ of\ font\ memory\ (font\_mem\_size)"},\39%
\\{font\_mem\_size})$;\2\6
$\\{width\_base}[\|k]\K\\{fmem\_ptr}$;\5
$\\{italic\_base}[\|k]\K\\{width\_base}[\|k]+\\{nw}$;\5
$\\{kern\_base}[\|k]\K\\{italic\_base}[\|k]+\\{ni}-\\{kern\_base\_offset}$;\5
$\\{fmem\_ptr}\K\\{fmem\_ptr}+\\{nw}+\\{ni}+\\{nk}$;\6
\&{for} $\|i\K0\mathrel{\&{to}}\\{nw}-1$ \1\&{do}\5
$\\{font\_info}[\\{width\_base}[\|k]+\|i].\\{sc}\K\\{round\_xn\_over\_d}(%
\\{font\_info}[\\{width\_base}[\|f]+\|i].\\{sc},\391000+\|e,\391000)$;\2\6
\&{for} $\|i\K0\mathrel{\&{to}}\\{ni}-1$ \1\&{do}\5
$\\{font\_info}[\\{italic\_base}[\|k]+\|i].\\{sc}\K\\{round\_xn\_over\_d}(%
\\{font\_info}[\\{italic\_base}[\|f]+\|i].\\{sc},\391000+\|e,\391000)$;\2\6
\&{for} $\|i\K0\mathrel{\&{to}}\\{nk}-1$ \1\&{do}\5
$\\{font\_info}[\\{kern\_base}[\|k]+\\{kern\_base\_offset}+\|i].\\{sc}\K%
\\{round\_xn\_over\_d}(\\{font\_info}[\\{kern\_base}[\|f]+\\{kern\_base%
\_offset}+\|i].\\{sc},\391000+\|e,\391000)$;\2\6
$\\{auto\_expand\_font}\K\|k$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{copy\_expand\_params}(\|k,\39\|f:\\{internal\_font%
\_number};\,\35\|e:\\{integer})$;\C{set expansion-related parameters for an
expanded font \|k, based on the base font \|f and the expansion amount \|e}\2\6
\&{begin} \37\&{if} $\\{pdf\_font\_rp\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_rp\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_lp\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_lp\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_ef\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_ef\_base}[\|f]\K\\{init\_font\_base}(1000)$;\2\6
$\\{pdf\_font\_expand\_ratio}[\|k]\K\|e$;\5
$\\{pdf\_font\_step}[\|k]\K\\{pdf\_font\_step}[\|f]$;\5
$\\{pdf\_font\_auto\_expand}[\|k]\K\\{pdf\_font\_auto\_expand}[\|f]$;\5
$\\{pdf\_font\_blink}[\|k]\K\|f$;\5
$\\{pdf\_font\_lp\_base}[\|k]\K\\{pdf\_font\_lp\_base}[\|f]$;\5
$\\{pdf\_font\_rp\_base}[\|k]\K\\{pdf\_font\_rp\_base}[\|f]$;\5
$\\{pdf\_font\_ef\_base}[\|k]\K\\{pdf\_font\_ef\_base}[\|f]$;\6
\&{if} $\\{pdf\_font\_kn\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_st\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_st\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_sh\_bs\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_sh\_bs\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_kn\_bc\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_bc\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
\&{if} $\\{pdf\_font\_kn\_ac\_base}[\|f]=0$ \1\&{then}\5
$\\{pdf\_font\_kn\_ac\_base}[\|f]\K\\{init\_font\_base}(0)$;\2\6
$\\{pdf\_font\_kn\_bs\_base}[\|k]\K\\{pdf\_font\_kn\_bs\_base}[\|f]$;\5
$\\{pdf\_font\_st\_bs\_base}[\|k]\K\\{pdf\_font\_st\_bs\_base}[\|f]$;\5
$\\{pdf\_font\_sh\_bs\_base}[\|k]\K\\{pdf\_font\_sh\_bs\_base}[\|f]$;\5
$\\{pdf\_font\_kn\_bc\_base}[\|k]\K\\{pdf\_font\_kn\_bc\_base}[\|f]$;\5
$\\{pdf\_font\_kn\_ac\_base}[\|k]\K\\{pdf\_font\_kn\_ac\_base}[\|f]$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{tfm\_lookup}(\|s:\\{str\_number};\,\35\\{fs}:%
\\{scaled})$: \37\\{internal\_font\_number};\C{looks up for a TFM with name \|s
loaded at \\{fs} size; if found then flushes \|s}\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37\&{if} $\\{fs}\I0$ \1\&{then}\6
\&{begin} \37\&{for} $\|k\K\\{font\_base}+1\mathrel{\&{to}}\\{font\_ptr}$ \1%
\&{do}\6
\&{if} $(\\{font\_area}[\|k]\I\\{non\_existent\_path})\W\\{str\_eq\_str}(%
\\{font\_name}[\|k],\39\|s)\W(\\{font\_size}[\|k]=\\{fs})$ \1\&{then}\6
\&{begin} \37$\\{flush\_str}(\|s)$;\5
$\\{tfm\_lookup}\K\|k$;\5
\&{return};\6
\&{end};\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{for} $\|k\K\\{font\_base}+1\mathrel{\&{to}}\\{font%
\_ptr}$ \1\&{do}\6
\&{if} $(\\{font\_area}[\|k]\I\\{non\_existent\_path})\W\\{str\_eq\_str}(%
\\{font\_name}[\|k],\39\|s)$ \1\&{then}\6
\&{begin} \37$\\{flush\_str}(\|s)$;\5
$\\{tfm\_lookup}\K\|k$;\5
\&{return};\6
\&{end};\2\2\6
\&{end};\2\6
$\\{tfm\_lookup}\K\\{null\_font}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{load\_expand\_font}(\|f:\\{internal\_font\_number};\,%
\35\|e:\\{integer})$: \37\\{internal\_font\_number};\C{loads font \|f expanded
by \|e thousandths into font memory; \|e is nonzero and is a multiple of $%
\\{pdf\_font\_step}[\|f]$}\6
\4\&{label} \37\\{found};\6
\4\&{var} \37\|s: \37\\{str\_number};\C{font name}\6
\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\|s\K\\{expand\_font\_name}(\|f,\39\|e)$;\5
$\|k\K\\{tfm\_lookup}(\|s,\39\\{font\_size}[\|f])$;\6
\&{if} $\|k=\\{null\_font}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_font\_auto\_expand}[\|f]$ \1\&{then}\5
$\|k\K\\{auto\_expand\_font}(\|f,\39\|e)$\6
\4\&{else} $\|k\K\\{read\_font\_info}(\\{null\_cs},\39\|s,\39\.{""},\39\\{font%
\_size}[\|f])$;\2\6
\&{end};\2\6
\&{if} $\|k\I\\{null\_font}$ \1\&{then}\5
$\\{copy\_expand\_params}(\|k,\39\|f,\39\|e)$;\2\6
$\\{load\_expand\_font}\K\|k$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{fix\_expand\_value}(\|f:\\{internal\_font\_number};\,%
\35\|e:\\{integer})$: \37\\{integer};\C{return the multiple of $\\{pdf\_font%
\_step}[\|f]$ that is nearest to \|e}\6
\4\&{var} \37\\{step}: \37\\{integer};\5
\\{max\_expand}: \37\\{integer};\5
\\{neg}: \37\\{boolean};\2\6
\&{begin} \37$\\{fix\_expand\_value}\K0$;\6
\&{if} $\|e=0$ \1\&{then}\5
\&{return};\2\6
\&{if} $\|e<0$ \1\&{then}\6
\&{begin} \37$\|e\K-\|e$;\5
$\\{neg}\K\\{true}$;\5
$\\{max\_expand}\K-\\{pdf\_font\_expand\_ratio}[\\{pdf\_font\_shrink}[\|f]]$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{neg}\K\\{false}$;\5
$\\{max\_expand}\K\\{pdf\_font\_expand\_ratio}[\\{pdf\_font\_stretch}[\|f]]$;\6
\&{end};\2\6
\&{if} $\|e>\\{max\_expand}$ \1\&{then}\5
$\|e\K\\{max\_expand}$\6
\4\&{else} \&{begin} \37$\\{step}\K\\{pdf\_font\_step}[\|f]$;\6
\&{if} $\|e\mathbin{\&{mod}}\\{step}>0$ \1\&{then}\5
$\|e\K\\{step}\ast\\{round\_xn\_over\_d}(\|e,\391,\39\\{step})$;\2\6
\&{end};\2\6
\&{if} $\\{neg}$ \1\&{then}\5
$\|e\K-\|e$;\2\6
$\\{fix\_expand\_value}\K\|e$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_expand\_font}(\|f:\\{internal\_font\_number};\,%
\35\|e:\\{integer})$: \37\\{internal\_font\_number};\C{look up and create if
not found an expanded version of \|f; \|f is an expandable font; \|e is nonzero
and is a multiple of $\\{pdf\_font\_step}[\|f]$}\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\|k\K\\{pdf\_font\_elink}[\|f]$;\6
\&{while} $\|k\I\\{null\_font}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{pdf\_font\_expand\_ratio}[\|k]=\|e$ \1\&{then}\6
\&{begin} \37$\\{get\_expand\_font}\K\|k$;\5
\&{return};\6
\&{end};\2\6
$\|k\K\\{pdf\_font\_elink}[\|k]$;\6
\&{end};\2\6
$\|k\K\\{load\_expand\_font}(\|f,\39\|e)$;\5
$\\{pdf\_font\_elink}[\|k]\K\\{pdf\_font\_elink}[\|f]$;\5
$\\{pdf\_font\_elink}[\|f]\K\|k$;\5
$\\{get\_expand\_font}\K\|k$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{expand\_font}(\|f:\\{internal\_font\_number};\,\35%
\|e:\\{integer})$: \37\\{internal\_font\_number};\C{looks up for font \|f
expanded by \|e thousandths, \|e is an arbitrary value between max stretch and
max shrink of \|f; if not found then creates it}\2\6
\&{begin} \37$\\{expand\_font}\K\|f$;\6
\&{if} $\|e=0$ \1\&{then}\5
\&{return};\2\6
$\|e\K\\{fix\_expand\_value}(\|f,\39\|e)$;\6
\&{if} $\|e=0$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{pdf\_font\_elink}[\|f]=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"uninitialized\ pdf\_font%
\_elink"})$;\2\6
$\\{expand\_font}\K\\{get\_expand\_font}(\|f,\39\|e)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_expand\_params}(\|f:\\{internal\_font\_number};%
\,\35\\{auto\_expand}:\\{boolean};\,\35\\{stretch\_limit},\39\\{shrink\_limit},%
\39\\{font\_step},\39\\{expand\_ratio}:\\{integer})$;\C{expand a font with
given parameters}\2\6
\&{begin} \37$\\{pdf\_font\_step}[\|f]\K\\{font\_step}$;\5
$\\{pdf\_font\_auto\_expand}[\|f]\K\\{auto\_expand}$;\6
\&{if} $\\{stretch\_limit}>0$ \1\&{then}\5
$\\{pdf\_font\_stretch}[\|f]\K\\{get\_expand\_font}(\|f,\39\\{stretch%
\_limit})$;\2\6
\&{if} $\\{shrink\_limit}>0$ \1\&{then}\5
$\\{pdf\_font\_shrink}[\|f]\K\\{get\_expand\_font}(\|f,\39-\\{shrink\_limit})$;%
\2\6
\&{if} $\\{expand\_ratio}\I0$ \1\&{then}\5
$\\{pdf\_font\_expand\_ratio}[\|f]\K\\{expand\_ratio}$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{vf\_expand\_local\_fonts}(\|f:\\{internal\_font%
\_number})$;\6
\4\&{var} \37\\{lf}: \37\\{internal\_font\_number};\5
\|k: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}(\\{pdf\_font\_type}[\|f]=\\{virtual\_font\_type})$;%
\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{vf\_local\_font\_num}[\|f]-1$ \1\&{do}\6
\&{begin} \37$\\{lf}\K\\{vf\_i\_fnts}[\\{vf\_default\_font}[\|f]+\|k]$;\5
$\\{set\_expand\_params}(\\{lf},\39\\{pdf\_font\_auto\_expand}[\|f],\39\\{pdf%
\_font\_expand\_ratio}[\\{pdf\_font\_stretch}[\|f]],\39-\\{pdf\_font\_expand%
\_ratio}[\\{pdf\_font\_shrink}[\|f]],\39\\{pdf\_font\_step}[\|f],\39\\{pdf%
\_font\_expand\_ratio}[\|f])$;\6
\&{if} $\\{pdf\_font\_type}[\\{lf}]=\\{virtual\_font\_type}$ \1\&{then}\5
$\\{vf\_expand\_local\_fonts}(\\{lf})$;\2\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{read\_expand\_font};\C{read font expansion spec and
load expanded font}\6
\4\&{var} \37$\\{shrink\_limit},\39\\{stretch\_limit},\39\\{font\_step}$: \37%
\\{integer};\5
\|f: \37\\{internal\_font\_number};\5
\\{auto\_expand}: \37\\{boolean};\2\6
\&{begin} \37\C{read font expansion parameters}\6
\\{scan\_font\_ident};\5
$\|f\K\\{cur\_val}$;\6
\&{if} $\|f=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"invalid\ font\ identifier"})$;\2\6
\&{if} $\\{pdf\_font\_blink}[\|f]\I\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"\\pdffontexpand\ cannot\ be\ used\
this\ way\ (the\ base\ font\ has\ been\ expanded)"})$;\2\6
\\{scan\_optional\_equals};\5
\\{scan\_int};\5
$\\{stretch\_limit}\K\\{fix\_int}(\\{cur\_val},\390,\391000)$;\5
\\{scan\_int};\5
$\\{shrink\_limit}\K\\{fix\_int}(\\{cur\_val},\390,\39500)$;\5
\\{scan\_int};\5
$\\{font\_step}\K\\{fix\_int}(\\{cur\_val},\390,\39100)$;\6
\&{if} $\\{font\_step}=0$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"invalid\ step"})$;\2\6
$\\{stretch\_limit}\K\\{stretch\_limit}-\\{stretch\_limit}\mathbin{\&{mod}}%
\\{font\_step}$;\6
\&{if} $\\{stretch\_limit}<0$ \1\&{then}\5
$\\{stretch\_limit}\K0$;\2\6
$\\{shrink\_limit}\K\\{shrink\_limit}-\\{shrink\_limit}\mathbin{\&{mod}}\\{font%
\_step}$;\6
\&{if} $\\{shrink\_limit}<0$ \1\&{then}\5
$\\{shrink\_limit}\K0$;\2\6
\&{if} $(\\{stretch\_limit}=0)\W(\\{shrink\_limit}=0)$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"invalid\ limit(s)"})$;\2\6
$\\{auto\_expand}\K\\{false}$;\6
\&{if} $\\{scan\_keyword}(\.{"autoexpand"})$ \1\&{then}\6
\&{begin} \37$\\{auto\_expand}\K\\{true}$;\5
\X469:Scan an optional space\X;\6
\&{end};\C{check if the font can be expanded}\2\6
\&{if} $(\\{pdf\_font\_expand\_ratio}[\|f]\I0)$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"this\ font\ has\ been\ expanded\
by\ another\ font\ so\ it\ cannot\ be\ used\ now"})$;\2\6
\&{if} $(\\{pdf\_font\_step}[\|f]\I0)$ \1\&{then}\C{this font has been
expanded, ensure the expansion parameters are identical}\6
\&{begin} \37\&{if} $\\{pdf\_font\_step}[\|f]\I\\{font\_step}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"font\ has\ been\ expanded\ with\
different\ expansion\ step"})$;\2\6
\&{if} $((\\{pdf\_font\_stretch}[\|f]=\\{null\_font})\W(\\{stretch\_limit}\I0))%
\V((\\{pdf\_font\_stretch}[\|f]\I\\{null\_font})\W(\\{pdf\_font\_expand%
\_ratio}[\\{pdf\_font\_stretch}[\|f]]\I\\{stretch\_limit}))$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"font\ has\ been\ expanded\ with\
different\ stretch\ limit"})$;\2\6
\&{if} $((\\{pdf\_font\_shrink}[\|f]=\\{null\_font})\W(\\{shrink\_limit}\I0))%
\V((\\{pdf\_font\_shrink}[\|f]\I\\{null\_font})\W(-\\{pdf\_font\_expand%
\_ratio}[\\{pdf\_font\_shrink}[\|f]]\I\\{shrink\_limit}))$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"font\ has\ been\ expanded\ with\
different\ shrink\ limit"})$;\2\6
\&{if} $\\{pdf\_font\_auto\_expand}[\|f]\I\\{auto\_expand}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"font\ has\ been\ expanded\ with\
different\ auto\ expansion\ value"})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $(\\{pdf\_font\_type}[\|f]\I\\{new\_font\_type})%
\W(\\{pdf\_font\_type}[\|f]\I\\{virtual\_font\_type})$ \1\&{then}\5
$\\{pdf\_warning}(\.{"font\ expansion"},\39\.{"font\ should\ be\ expanded\
before\ its\ first\ use"},\39\\{true},\39\\{true})$;\2\6
$\\{set\_expand\_params}(\|f,\39\\{auto\_expand},\39\\{stretch\_limit},\39%
\\{shrink\_limit},\39\\{font\_step},\390)$;\6
\&{if} $\\{pdf\_font\_type}[\|f]=\\{virtual\_font\_type}$ \1\&{then}\5
$\\{vf\_expand\_local\_fonts}(\|f)$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M706. We implement robust letter spacing using virtual font.

\Y\P\D \37$\\{vf\_replace\_z}\S$\1\6
\&{begin} \37$\\{vf\_alpha}\K16$;\6
\&{while} $\\{vf\_z}\G\O{40000000}$ \1\&{do}\6
\&{begin} \37$\\{vf\_z}\K\\{vf\_z}\mathbin{\&{div}}2$;\5
$\\{vf\_alpha}\K\\{vf\_alpha}+\\{vf\_alpha}$;\6
\&{end};\2\6
$\\{vf\_beta}\K256\mathbin{\&{div}}\\{vf\_alpha}$;\5
$\\{vf\_alpha}\K\\{vf\_alpha}\ast\\{vf\_z}$;\6
\&{end}\2\par
\Y\P\4\&{function}\1\  \37$\\{letter\_space\_font}(\|u:\\{pointer};\,\35\|f:%
\\{internal\_font\_number};\,\35\|e:\\{integer})$: \37\\{internal\_font%
\_number};\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\5
$\|w,\39\|r$: \37\\{scaled};\5
\|s: \37\\{str\_number};\5
$\|i,\39\\{nw}$: \37\\{integer};\5
\\{old\_setting}: \37$0\to\\{max\_selector}$;\5
\\{vf\_z}: \37\\{integer};\5
\\{vf\_alpha}: \37\\{integer};\5
\\{vf\_beta}: \37$1\to16$;\2\6
\&{begin} \37\C{read a new font and expand the character widths}\6
$\|k\K\\{read\_font\_info}(\|u,\39\\{font\_name}[\|f],\39\.{""},\39\\{font%
\_size}[\|f])$;\6
\&{if} $\\{scan\_keyword}(\.{"nolig"})$ \1\&{then}\5
$\\{set\_no\_ligatures}(\|k)$;\C{disable ligatures for letter-spaced fonts}\2\6
$\\{nw}\K\\{height\_base}[\|k]-\\{width\_base}[\|k]$;\6
\&{if} $(\\{quad}(\|k)=0)\W(\\{quad}(\|f)>0)$ \1\&{then}\5
$\\{quad}(\|k)\K\\{quad}(\|f)$;\2\6
\&{if} $\\{quad}(\|k)=0$ \1\&{then}\5
$\\{pdf\_warning}(\.{"\\letterspacefont"},\39\.{"font\ has\ zero\ em\ size\ (%
\\fontdimen6)"},\39\\{true},\39\\{true})$;\2\6
\&{for} $\|i\K0\mathrel{\&{to}}\\{nw}-1$ \1\&{do}\5
$\\{font\_info}[\\{width\_base}[\|k]+\|i].\\{sc}\K\\{font\_info}[\\{width%
\_base}[\|k]+\|i].\\{sc}+\\{round\_xn\_over\_d}(\\{quad}(\|k),\39\|e,\391000)$;%
\C{append, e.g., '+100ls' to font name}\2\6
$\\{str\_room}(\\{length}(\\{font\_name}[\|k])+7)$;\C{$\\{abs}(\|e)\L1000$}\6
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\\{font\_name}[\|k])$;\6
\&{if} $\|e>0$ \1\&{then}\5
$\\{print}(\.{"+"})$;\C{minus sign will be printed by \\{print\_int}}\2\6
$\\{print\_int}(\|e)$;\5
$\\{print}(\.{"ls"})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{font\_name}[\|k]\K\\{make\_string}$;\C{create the corresponding virtual
font}\6
\\{allocvffnts};\5
$\\{vf\_e\_fnts}[\\{vf\_nf}]\K0$;\5
$\\{vf\_i\_fnts}[\\{vf\_nf}]\K\|f$;\5
$\\{incr}(\\{vf\_nf})$;\5
$\\{vf\_local\_font\_num}[\|k]\K1$;\5
$\\{vf\_default\_font}[\|k]\K\\{vf\_nf}-1$;\5
$\\{pdf\_font\_type}[\|k]\K\\{virtual\_font\_type}$;\5
$\\{vf\_z}\K\\{font\_size}[\|f]$;\5
\\{vf\_replace\_z};\5
$\|w\K\\{round\_xn\_over\_d}(\\{quad}(\|f),\39\|e,\392000)$;\6
\&{if} $\|w\G0$ \1\&{then}\5
$\\{tmp\_b0}\K0$\6
\4\&{else} \&{begin} \37$\\{tmp\_b0}\K255$;\5
$\|w\K\\{vf\_alpha}+\|w$;\6
\&{end};\2\6
$\|r\K\|w\ast\\{vf\_beta}$;\5
$\\{tmp\_b1}\K\|r\mathbin{\&{div}}\\{vf\_z}$;\5
$\|r\K\|r\mathbin{\&{mod}}\\{vf\_z}$;\6
\&{if} $\|r=0$ \1\&{then}\5
$\\{tmp\_b2}\K0$\6
\4\&{else} \&{begin} \37$\|r\K\|r\ast256$;\5
$\\{tmp\_b2}\K\|r\mathbin{\&{div}}\\{vf\_z}$;\5
$\|r\K\|r\mathbin{\&{mod}}\\{vf\_z}$;\6
\&{end};\2\6
\&{if} $\|r=0$ \1\&{then}\5
$\\{tmp\_b3}\K0$\6
\4\&{else} \&{begin} \37$\|r\K\|r\ast256$;\5
$\\{tmp\_b3}\K\|r\mathbin{\&{div}}\\{vf\_z}$;\6
\&{end};\2\6
$\\{vf\_packet\_base}[\|k]\K\\{new\_vf\_packet}(\|k)$;\6
\&{for} $\|c\K\\{font\_bc}[\|k]\mathrel{\&{to}}\\{font\_ec}[\|k]$ \1\&{do}\6
\&{begin} \37$\\{str\_room}(12)$;\5
$\\{append\_char}(\\{right1}+3)$;\5
$\\{append\_char}(\\{tmp\_b0})$;\5
$\\{append\_char}(\\{tmp\_b1})$;\5
$\\{append\_char}(\\{tmp\_b2})$;\5
$\\{append\_char}(\\{tmp\_b3})$;\6
\&{if} $\|c<\\{set1}$ \1\&{then}\5
$\\{append\_char}(\|c)$\6
\4\&{else} \&{begin} \37$\\{append\_char}(\\{set1})$;\5
$\\{append\_char}(\|c)$;\6
\&{end};\2\6
$\\{append\_char}(\\{right1}+3)$;\5
$\\{append\_char}(\\{tmp\_b0})$;\5
$\\{append\_char}(\\{tmp\_b1})$;\5
$\\{append\_char}(\\{tmp\_b2})$;\5
$\\{append\_char}(\\{tmp\_b3})$;\5
$\|s\K\\{make\_string}$;\5
$\\{storepacket}(\|k,\39\|c,\39\|s)$;\5
$\\{flush\_str}(\|s)$;\6
\&{end};\2\6
$\\{letter\_space\_font}\K\|k$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{new\_letterspaced\_font}(\|a:\\{small\_number})$;%
\C{letter-space a font by creating a virtual font}\6
\4\&{var} \37\|u: \37\\{pointer};\C{user's font identifier}\6
\|t: \37\\{str\_number};\C{name for the frozen font identifier}\6
\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector} setting}\6
$\|f,\39\|k$: \37\\{internal\_font\_number};\2\6
\&{begin} \37\\{get\_r\_token};\5
$\|u\K\\{cur\_cs}$;\6
\&{if} $\|u\G\\{hash\_base}$ \1\&{then}\5
$\|t\K\\{text}(\|u)$\6
\4\&{else} \&{if} $\|u\G\\{single\_base}$ \1\&{then}\6
\&{if} $\|u=\\{null\_cs}$ \1\&{then}\5
$\|t\K\.{"FONT"}$\ \&{else} $\|t\K\|u-\\{single\_base}$\2\6
\4\&{else} \&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\.{"FONT"})$;\5
$\\{print}(\|u-\\{active\_base})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{str\_room}(1)$;\5
$\|t\K\\{make\_string}$;\6
\&{end};\2\2\6
$\\{define}(\|u,\39\\{set\_font},\39\\{null\_font})$;\5
\\{scan\_optional\_equals};\5
\\{scan\_font\_ident};\5
$\|k\K\\{cur\_val}$;\5
\\{scan\_int};\5
$\|f\K\\{letter\_space\_font}(\|u,\39\|k,\39\\{fix\_int}(\\{cur\_val},\39-1000,%
\391000))$;\5
$\\{equiv}(\|u)\K\|f$;\5
$\\{eqtb}[\\{font\_id\_base}+\|f]\K\\{eqtb}[\|u]$;\5
$\\{font\_id\_text}(\|f)\K\|t$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{is\_letterspaced\_font}(\|f:\\{internal\_font%
\_number})$: \37\\{boolean};\6
\4\&{label} \37\\{done};\6
\4\&{var} \37$\|i,\39\|j$: \37\\{pool\_pointer};\2\6
\&{begin} \37$\\{is\_letterspaced\_font}\K\\{false}$;\6
\&{if} $\\{pdf\_font\_type}[\|f]\I\\{virtual\_font\_type}$ \1\&{then}\5
\&{return};\2\6
$\|i\K\\{str\_start}[\\{font\_name}[\|f]+1]-1$;\5
$\|j\K\\{str\_start}[\\{font\_name}[\|f]]$;\6
\&{if} $(\\{str\_pool}[\|i-1]\I\.{\'l\'})\V(\\{str\_pool}[\|i]\I\.{\'s\'})$ \1%
\&{then}\5
\&{return};\2\6
$\|i\K\|i-2$;\6
\&{while} $\|i\G\|j$ \1\&{do}\6
\&{begin} \37\&{if} $(\\{str\_pool}[\|i]<\.{\'0\'})\V(\\{str\_pool}[\|i]>\.{\'9%
\'})$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|i\K\|i-1$;\6
\&{end};\2\6
\4\\{done}: \37\&{if} $\|i<\|j$ \1\&{then}\5
\&{return};\2\6
\&{if} $(\\{str\_pool}[\|i]\I\.{\'+\'})\W(\\{str\_pool}[\|i]\I\.{\'-\'})$ \1%
\&{then}\5
\&{return};\2\6
$\\{is\_letterspaced\_font}\K\\{true}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{copy\_font\_info}(\|f:\\{internal\_font\_number})$: %
\37\\{internal\_font\_number};\C{create a copy of \|f in the font mem}\6
\4\&{var} \37$\\{lf},\39\\{bc},\39\\{ec},\39\|i$: \37\\{halfword};\5
\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37\&{if} $(\\{pdf\_font\_expand\_ratio}[\|f]\I0)\V(\\{pdf\_font%
\_step}[\|f]\I0)$ \1\&{then}\5
$\\{pdf\_error}(\.{"\\pdfcopyfont"},\39\.{"cannot\ copy\ an\ expanded\
font"})$;\2\6
\&{if} $\\{is\_letterspaced\_font}(\|f)$ \1\&{then}\5
$\\{pdf\_error}(\.{"\\pdfcopyfont"},\39\.{"cannot\ copy\ a\ letterspaced\
font"})$;\2\6
$\|k\K\\{font\_ptr}+1$;\5
$\\{incr}(\\{font\_ptr})$;\6
\&{if} $(\\{font\_ptr}\G\\{font\_max})$ \1\&{then}\5
$\\{overflow}(\.{"maximum\ internal\ font\ number\ (font\_max)"},\39\\{font%
\_max})$;\2\6
$\\{font\_name}[\|k]\K\\{font\_name}[\|f]$;\5
$\\{font\_area}[\|k]\K\\{non\_existent\_path}$;\C{to avoid interferences with $%
\\{new\_font}(\,)$ and $\\{tfm\_lookup}(\,)$}\6
$\\{hyphen\_char}[\|k]\K\\{hyphen\_char}[\|f]$;\5
$\\{skew\_char}[\|k]\K\\{skew\_char}[\|f]$;\5
$\\{font\_bchar}[\|k]\K\\{font\_bchar}[\|f]$;\5
$\\{font\_false\_bchar}[\|k]\K\\{font\_false\_bchar}[\|f]$;\5
$\\{font\_bc}[\|k]\K\\{font\_bc}[\|f]$;\5
$\\{font\_ec}[\|k]\K\\{font\_ec}[\|f]$;\5
$\\{font\_size}[\|k]\K\\{font\_size}[\|f]$;\5
$\\{font\_dsize}[\|k]\K\\{font\_dsize}[\|f]$;\5
$\\{font\_params}[\|k]\K\\{font\_params}[\|f]$;\5
$\\{font\_glue}[\|k]\K\\{font\_glue}[\|f]$;\5
$\\{bchar\_label}[\|k]\K\\{bchar\_label}[\|f]$;\C{set base addresses}\6
$\\{bc}\K\\{font\_bc}[\|f]$;\5
$\\{ec}\K\\{font\_ec}[\|f]$;\5
$\\{char\_base}[\|k]\K\\{fmem\_ptr}-\\{bc}$;\5
$\\{width\_base}[\|k]\K\\{char\_base}[\|k]+\\{ec}+1$;\5
$\\{height\_base}[\|k]\K\\{width\_base}[\|k]+(\\{height\_base}[\|f]-\\{width%
\_base}[\|f])$;\5
$\\{depth\_base}[\|k]\K\\{height\_base}[\|k]+(\\{depth\_base}[\|f]-\\{height%
\_base}[\|f])$;\5
$\\{italic\_base}[\|k]\K\\{depth\_base}[\|k]+(\\{italic\_base}[\|f]-\\{depth%
\_base}[\|f])$;\5
$\\{lig\_kern\_base}[\|k]\K\\{italic\_base}[\|k]+(\\{lig\_kern\_base}[\|f]-%
\\{italic\_base}[\|f])$;\5
$\\{kern\_base}[\|k]\K\\{lig\_kern\_base}[\|k]+(\\{kern\_base}[\|f]-\\{lig%
\_kern\_base}[\|f])$;\5
$\\{exten\_base}[\|k]\K\\{kern\_base}[\|k]+(\\{exten\_base}[\|f]-\\{kern%
\_base}[\|f])$;\5
$\\{param\_base}[\|k]\K\\{exten\_base}[\|k]+(\\{param\_base}[\|f]-\\{exten%
\_base}[\|f])$;\C{allocate memory for the new font \|k and copy data from \|f}\6
$\\{lf}\K(\\{param\_base}[\|f]-\\{char\_base}[\|f])+\\{font\_params}[\|f]+1$;\6
\&{if} $(\\{fmem\_ptr}+\\{lf}\G\\{font\_mem\_size})$ \1\&{then}\5
$\\{overflow}(\.{"number\ of\ words\ of\ font\ memory\ (font\_mem\_size)"},\39%
\\{font\_mem\_size})$;\2\6
\&{for} $\|i\K0\mathrel{\&{to}}\\{lf}-1$ \1\&{do}\5
$\\{font\_info}[\\{char\_base}[\|k]+\\{bc}+\|i]\K\\{font\_info}[\\{char\_base}[%
\|f]+\\{bc}+\|i]$;\2\6
$\\{fmem\_ptr}\K\\{fmem\_ptr}+\\{lf}$;\5
$\\{copy\_font\_info}\K\|k$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{make\_font\_copy}(\|a:\\{small\_number})$;\C{make a
font copy for further use with font expansion}\6
\4\&{var} \37\|u: \37\\{pointer};\C{user's font identifier}\6
\|t: \37\\{str\_number};\C{name for the frozen font identifier}\6
\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector} setting}\6
$\|f,\39\|k$: \37\\{internal\_font\_number};\2\6
\&{begin} \37\\{get\_r\_token};\5
$\|u\K\\{cur\_cs}$;\6
\&{if} $\|u\G\\{hash\_base}$ \1\&{then}\5
$\|t\K\\{text}(\|u)$\6
\4\&{else} \&{if} $\|u\G\\{single\_base}$ \1\&{then}\6
\&{if} $\|u=\\{null\_cs}$ \1\&{then}\5
$\|t\K\.{"FONT"}$\ \&{else} $\|t\K\|u-\\{single\_base}$\2\6
\4\&{else} \&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\.{"FONT"})$;\5
$\\{print}(\|u-\\{active\_base})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{str\_room}(1)$;\5
$\|t\K\\{make\_string}$;\6
\&{end};\2\2\6
$\\{define}(\|u,\39\\{set\_font},\39\\{null\_font})$;\5
\\{scan\_optional\_equals};\5
\\{scan\_font\_ident};\5
$\|k\K\\{cur\_val}$;\5
$\|f\K\\{copy\_font\_info}(\|k)$;\5
$\\{equiv}(\|u)\K\|f$;\5
$\\{eqtb}[\\{font\_id\_base}+\|f]\K\\{eqtb}[\|u]$;\5
$\\{font\_id\_text}(\|f)\K\|t$;\6
\&{end};\par
\fi

\M707. We need to hold information about used characters in each font for
partial
downloading.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{char\_used\_array}=$\1\5
\&{array} $[0\to31]$ \1\&{of}\5
\\{eight\_bits};\2\2\6
$\\{char\_map\_array}=$\1\5
\&{array} $[0\to32]$ \1\&{of}\5
\\{eight\_bits};\C{move chars in range 0..32}\2\2\6
$\\{fm\_entry\_ptr}=\^\\{integer}$;\par
\fi

\M708. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_char\_used}: \37$\^\\{char\_used\_array}$;\C{to mark used chars}\6
\4\\{pdf\_font\_size}: \37$\^\\{scaled}$;\C{used size of font in PDF file}\6
\4\\{pdf\_font\_num}: \37$\^\\{integer}$;\C{mapping between internal font
number in \TeX\ and     font name defined in resources in PDF file}\6
\4\\{pdf\_font\_map}: \37$\^\\{fm\_entry\_ptr}$;\C{pointer into AVL tree of
font mappings}\6
\4\\{pdf\_font\_list}: \37\\{pointer};\C{list of used fonts in current page}\6
\4\\{pdf\_resname\_prefix}: \37\\{str\_number};\C{global prefix of resources
name}\6
\4\\{last\_tokens\_string}: \37\\{str\_number};\C{the number of the most
recently string created by \\{tokens\_to\_string}}\par
\fi

\M709. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pdf\_resname\_prefix}\K0$;\5
$\\{last\_tokens\_string}\K0$;\par
\fi

\M710. Here we implement reading information from \.{VF} file.

\Y\P\D \37$\\{vf\_max\_packet\_length}=10000$\C{max length of character packet
in \.{VF} file}\Y\par
\P\D \37$\\{do\_char}=70$\C{label to go to typesetting a character of virtual
font}\Y\par
\P\D \37$\\{long\_char}=242$\C{\.{VF} command for general character packet}\par
\P\D \37$\\{vf\_id}=202$\C{identifies \.{VF} files}\par
\P\D \37$\\{put1}=133$\C{typeset a character}\par
\P\D \37$\\{four\_cases}(\#)\S\#,\39\#+1,\39\#+2,\39\#+3$\Y\par
\P\D \37$\\{tmp\_b0}\S\\{tmp\_w}.\\{qqqq}.\\{b0}$\par
\P\D \37$\\{tmp\_b1}\S\\{tmp\_w}.\\{qqqq}.\\{b1}$\par
\P\D \37$\\{tmp\_b2}\S\\{tmp\_w}.\\{qqqq}.\\{b2}$\par
\P\D \37$\\{tmp\_b3}\S\\{tmp\_w}.\\{qqqq}.\\{b3}$\par
\P\D \37$\\{tmp\_int}\S\\{tmp\_w}.\\{int}$\Y\par
\P\D \37$\\{bad\_vf}(\#)\S\\{vf\_error}(\\{font\_name}[\|f],\39\#)$\C{quit with
an error message telling the vf filename}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{vf\_packet\_base}: \37$\^\\{integer}$;\C{base addresses of character
packets from virtual fonts}\6
\4\\{vf\_default\_font}: \37$\^\\{internal\_font\_number}$;\C{default font in a
\.{VF} file}\6
\4\\{vf\_local\_font\_num}: \37$\^\\{internal\_font\_number}$;\C{number of
local fonts in a \.{VF} file}\6
\4\\{vf\_packet\_length}: \37\\{integer};\C{length of the current packet}\6
\4\\{vf\_file}: \37\\{byte\_file};\6
\4\\{vf\_nf}: \37\\{internal\_font\_number};\C{the local fonts counter}\6
\4\\{vf\_e\_fnts}: \37$\^\\{integer}$;\C{external font numbers}\6
\4\\{vf\_i\_fnts}: \37$\^\\{internal\_font\_number}$;\C{corresponding internal
font numbers}\6
\4\\{tmp\_w}: \37\\{memory\_word};\C{accumulator}\par
\fi

\M711. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{vf\_nf}\K0$;\par
\fi

\M712. The \\{do\_vf} procedure attempts to read the \.{VF} file for a font,
and sets
\\{pdf\_font\_type} to \\{real\_font\_type} if the \.{VF} file could not be
found
or loaded, otherwise sets \\{pdf\_font\_type} to \\{virtual\_font\_type}. To
process font definitions in virtual font we call \\{vf\_def\_font}.

\Y\P\4\&{procedure}\1\  \37$\\{vf\_error}(\\{filename},\39\\{msg}:\\{str%
\_number})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|s: \37\\{str\_number};\2\6
\&{begin} \37$\\{str\_room}(\\{length}(\\{filename})+3)$;\5
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\\{filename})$;\5
$\\{print}(\.{".vf"})$;\5
$\|s\K\\{make\_string}$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{pdf\_error}(\|s,\39\\{msg})$;\6
\&{end};\6
\4\&{function}\1\  \37\\{vf\_byte}: \37\\{eight\_bits};\C{read a byte from %
\\{vf\_file}}\6
\4\&{var} \37\|i: \37\\{integer};\2\6
\&{begin} \37$\|i\K\\{getc}(\\{vf\_file})$;\6
\&{if} $\|i<0$ \1\&{then}\5
$\\{pdf\_error}(\.{"vf"},\39\.{"unexpected\ EOF\ or\ error"})$;\2\6
$\\{vf\_byte}\K\|i$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{vf\_read\_signed}(\|k:\\{integer})$: \37\\{integer};%
\C{read \|k bytes as an signed integer from \.{VF} file}\6
\4\&{var} \37\|i: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}((\|k>0)\W(\|k\L4))$;\5
$\|i\K\\{vf\_byte}$;\6
\&{if} $\|i\G128$ \1\&{then}\5
$\|i\K\|i-256$;\2\6
$\\{decr}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\|i\K\|i\ast256+\\{vf\_byte}$;\5
$\\{decr}(\|k)$;\6
\&{end};\2\6
$\\{vf\_read\_signed}\K\|i$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{vf\_read\_unsigned}(\|k:\\{integer})$: \37%
\\{integer};\C{read \|k bytes as an unsigned integer from \.{VF} file}\6
\4\&{var} \37\|i: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}((\|k>0)\W(\|k\L4))$;\5
$\|i\K\\{vf\_byte}$;\6
\&{if} $(\|k=4)\W(\|i\G128)$ \1\&{then}\5
$\\{bad\_vf}(\.{"number\ too\ big"})$;\2\6
$\\{decr}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\|i\K\|i\ast256+\\{vf\_byte}$;\5
$\\{decr}(\|k)$;\6
\&{end};\2\6
$\\{vf\_read\_unsigned}\K\|i$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{vf\_local\_font\_warning}(\|f,\39\|k:\\{internal%
\_font\_number};\,\35\|s:\\{str\_number})$;\C{print a warning message if an
error occurs during processing local fonts in \.{VF} file}\2\6
\&{begin} \37$\\{print\_nl}(\|s)$;\5
$\\{print}(\.{"\ in\ local\ font\ "})$;\5
$\\{print}(\\{font\_name}[\|k])$;\5
$\\{print}(\.{"\ in\ virtual\ font\ "})$;\5
$\\{print}(\\{font\_name}[\|f])$;\5
$\\{print}(\.{".vf\ ignored."})$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{vf\_def\_font}(\|f:\\{internal\_font\_number})$: \37%
\\{internal\_font\_number};\C{process a local font in \.{VF} file}\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\5
\|s: \37\\{str\_number};\5
$\\{ds},\39\\{fs}$: \37\\{scaled};\5
\\{cs}: \37\\{four\_quarters};\2\6
\&{begin} \37$\\{cs}.\\{b0}\K\\{vf\_byte}$;\5
$\\{cs}.\\{b1}\K\\{vf\_byte}$;\5
$\\{cs}.\\{b2}\K\\{vf\_byte}$;\5
$\\{cs}.\\{b3}\K\\{vf\_byte}$;\5
$\\{fs}\K\\{store\_scaled\_f}(\\{vf\_read\_signed}(4),\39\\{font\_size}[\|f])$;%
\5
$\\{ds}\K\\{vf\_read\_signed}(4)\mathbin{\&{div}}\O{20}$;\5
$\\{tmp\_b0}\K\\{vf\_byte}$;\5
$\\{tmp\_b1}\K\\{vf\_byte}$;\6
\&{while} $\\{tmp\_b0}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{tmp\_b0})$;\5
$\\{call\_func}(\\{vf\_byte})$;\C{skip the font path}\6
\&{end};\2\6
$\\{str\_room}(\\{tmp\_b1})$;\6
\&{while} $\\{tmp\_b1}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{tmp\_b1})$;\5
$\\{append\_char}(\\{vf\_byte})$;\6
\&{end};\2\6
$\|s\K\\{make\_string}$;\5
$\|k\K\\{tfm\_lookup}(\|s,\39\\{fs})$;\6
\&{if} $\|k=\\{null\_font}$ \1\&{then}\5
$\|k\K\\{read\_font\_info}(\\{null\_cs},\39\|s,\39\.{""},\39\\{fs})$;\2\6
\&{if} $\|k\I\\{null\_font}$ \1\&{then}\6
\&{begin} \37\&{if} $((\\{cs}.\\{b0}\I0)\V(\\{cs}.\\{b1}\I0)\V(\\{cs}.\\{b2}%
\I0)\V(\\{cs}.\\{b3}\I0))\W((\\{font\_check}[\|k].\\{b0}\I0)\V(\\{font\_check}[%
\|k].\\{b1}\I0)\V(\\{font\_check}[\|k].\\{b2}\I0)\V(\\{font\_check}[\|k].\\{b3}%
\I0))\W((\\{cs}.\\{b0}\I\\{font\_check}[\|k].\\{b0})\V(\\{cs}.\\{b1}\I\\{font%
\_check}[\|k].\\{b1})\V(\\{cs}.\\{b2}\I\\{font\_check}[\|k].\\{b2})\V(\\{cs}.%
\\{b3}\I\\{font\_check}[\|k].\\{b3}))$ \1\&{then}\5
$\\{vf\_local\_font\_warning}(\|f,\39\|k,\39\.{"checksum\ mismatch"})$;\2\6
\&{if} $\\{ds}\I\\{font\_dsize}[\|k]$ \1\&{then}\5
$\\{vf\_local\_font\_warning}(\|f,\39\|k,\39\.{"design\ size\ mismatch"})$;\2\6
\&{if} $(\\{pdf\_font\_step}[\|f]\I0)$ \1\&{then}\5
$\\{set\_expand\_params}(\|k,\39\\{pdf\_font\_auto\_expand}[\|f],\39\\{pdf%
\_font\_expand\_ratio}[\\{pdf\_font\_stretch}[\|f]],\39-\\{pdf\_font\_expand%
\_ratio}[\\{pdf\_font\_shrink}[\|f]],\39\\{pdf\_font\_step}[\|f],\39\\{pdf%
\_font\_expand\_ratio}[\|f])$;\2\6
\&{end};\2\6
$\\{vf\_def\_font}\K\|k$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_vf}(\|f:\\{internal\_font\_number})$;\C{process %
\.{VF} file with font internal number \|f}\6
\4\&{var} \37$\\{cmd},\39\|k,\39\|n$: \37\\{integer};\5
$\\{cc},\39\\{cmd\_length},\39\\{packet\_length}$: \37\\{integer};\5
\\{tfm\_width}: \37\\{scaled};\5
\|s: \37\\{str\_number};\5
\\{stack\_level}: \37\\{vf\_stack\_index};\5
\\{save\_vf\_nf}: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\\{pdf\_font\_type}[\|f]\K\\{real\_font\_type}$;\6
\&{if} $\\{auto\_expand\_vf}(\|f)$ \1\&{then}\5
\&{return};\C{auto-expanded virtual font}\2\6
$\\{stack\_level}\K0$;\5
\X713:Open \\{vf\_file}, return if not found\X;\6
\X714:Process the preamble\X;\6
\X715:Process the font definitions\X;\6
\X716:Allocate memory for the new virtual font\X;\6
\&{while} $\\{cmd}\L\\{long\_char}$ \1\&{do}\6
\&{begin} \37\X717:Build a character packet\X;\6
\&{end};\2\6
\&{if} $\\{cmd}\I\\{post}$ \1\&{then}\5
$\\{bad\_vf}(\.{"POST\ command\ expected"})$;\2\6
$\\{b\_close}(\\{vf\_file})$;\5
$\\{pdf\_font\_type}[\|f]\K\\{virtual\_font\_type}$;\6
\&{end};\par
\fi

\M713. \P$\X713:Open \\{vf\_file}, return if not found\X\S$\6
$\\{pack\_file\_name}(\\{font\_name}[\|f],\39\.{""},\39\.{".vf"})$;\6
\&{if} $\R\\{vf\_b\_open\_in}(\\{vf\_file})$ \1\&{then}\5
\&{return}\2\par
\U712.\fi

\M714. \P$\X714:Process the preamble\X\S$\6
\&{if} $\\{vf\_byte}\I\\{pre}$ \1\&{then}\5
$\\{bad\_vf}(\.{"PRE\ command\ expected"})$;\2\6
\&{if} $\\{vf\_byte}\I\\{vf\_id}$ \1\&{then}\5
$\\{bad\_vf}(\.{"wrong\ id\ byte"})$;\2\6
$\\{cmd\_length}\K\\{vf\_byte}$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{cmd\_length}$ \1\&{do}\5
$\\{call\_func}(\\{vf\_byte})$;\C{skip the comment}\2\6
$\\{tmp\_b0}\K\\{vf\_byte}$;\5
$\\{tmp\_b1}\K\\{vf\_byte}$;\5
$\\{tmp\_b2}\K\\{vf\_byte}$;\5
$\\{tmp\_b3}\K\\{vf\_byte}$;\6
\&{if} $((\\{tmp\_b0}\I0)\V(\\{tmp\_b1}\I0)\V(\\{tmp\_b2}\I0)\V(\\{tmp\_b3}%
\I0))\W((\\{font\_check}[\|f].\\{b0}\I0)\V(\\{font\_check}[\|f].\\{b1}\I0)\V(%
\\{font\_check}[\|f].\\{b2}\I0)\V(\\{font\_check}[\|f].\\{b3}\I0))\W((\\{tmp%
\_b0}\I\\{font\_check}[\|f].\\{b0})\V(\\{tmp\_b1}\I\\{font\_check}[\|f].\\{b1})%
\V(\\{tmp\_b2}\I\\{font\_check}[\|f].\\{b2})\V(\\{tmp\_b3}\I\\{font\_check}[%
\|f].\\{b3}))$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"checksum\ mismatch\ in\ font\ "})$;\5
$\\{print}(\\{font\_name}[\|f])$;\5
$\\{print}(\.{".vf\ ignored"})$;\6
\&{end};\2\6
\&{if} $\\{vf\_read\_signed}(4)\mathbin{\&{div}}\O{20}\I\\{font\_dsize}[\|f]$ %
\1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"design\ size\ mismatch\ in\ font\ "})$;\5
$\\{print}(\\{font\_name}[\|f])$;\5
$\\{print}(\.{".vf\ ignored"})$;\6
\&{end};\2\6
\\{update\_terminal}\par
\U712.\fi

\M715. \P$\X715:Process the font definitions\X\S$\6
$\\{cmd}\K\\{vf\_byte}$;\5
$\\{save\_vf\_nf}\K\\{vf\_nf}$;\6
\&{while} $(\\{cmd}\G\\{fnt\_def1})\W(\\{cmd}\L\\{fnt\_def1}+3)$ \1\&{do}\6
\&{begin} \37\\{allocvffnts};\5
$\\{vf\_e\_fnts}[\\{vf\_nf}]\K\\{vf\_read\_unsigned}(\\{cmd}-\\{fnt\_def1}+1)$;%
\5
$\\{vf\_i\_fnts}[\\{vf\_nf}]\K\\{vf\_def\_font}(\|f)$;\5
$\\{incr}(\\{vf\_nf})$;\5
$\\{cmd}\K\\{vf\_byte}$;\6
\&{end};\2\6
$\\{vf\_default\_font}[\|f]\K\\{save\_vf\_nf}$;\5
$\\{vf\_local\_font\_num}[\|f]\K\\{vf\_nf}-\\{save\_vf\_nf}$;\par
\U712.\fi

\M716. \P$\X716:Allocate memory for the new virtual font\X\S$\6
$\\{vf\_packet\_base}[\|f]\K\\{new\_vf\_packet}(\|f)$\par
\U712.\fi

\M717. \P$\X717:Build a character packet\X\S$\6
\&{if} $\\{cmd}=\\{long\_char}$ \1\&{then}\6
\&{begin} \37$\\{packet\_length}\K\\{vf\_read\_unsigned}(4)$;\5
$\\{cc}\K\\{vf\_read\_unsigned}(4)$;\6
\&{if} $\R\\{is\_valid\_char}(\\{cc})$ \1\&{then}\5
$\\{bad\_vf}(\.{"invalid\ character\ code"})$;\2\6
$\\{tfm\_width}\K\\{store\_scaled\_f}(\\{vf\_read\_signed}(4),\39\\{font%
\_size}[\|f])$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{packet\_length}\K\\{cmd}$;\5
$\\{cc}\K\\{vf\_byte}$;\6
\&{if} $\R\\{is\_valid\_char}(\\{cc})$ \1\&{then}\5
$\\{bad\_vf}(\.{"invalid\ character\ code"})$;\2\6
$\\{tfm\_width}\K\\{store\_scaled\_f}(\\{vf\_read\_unsigned}(3),\39\\{font%
\_size}[\|f])$;\6
\&{end};\2\6
\&{if} $\\{packet\_length}<0$ \1\&{then}\5
$\\{bad\_vf}(\.{"negative\ packet\ length"})$;\2\6
\&{if} $\\{packet\_length}>\\{vf\_max\_packet\_length}$ \1\&{then}\5
$\\{bad\_vf}(\.{"packet\ length\ too\ long"})$;\2\6
\&{if} $\\{tfm\_width}\I\\{char\_width}(\|f)(\\{char\_info}(\|f)(\\{cc}))$ \1%
\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"character\ width\ mismatch\ in\ font\ "})$;\5
$\\{print}(\\{font\_name}[\|f])$;\5
$\\{print}(\.{".vf\ ignored"})$;\6
\&{end};\2\6
$\\{str\_room}(\\{packet\_length})$;\6
\&{while} $\\{packet\_length}>0$ \1\&{do}\6
\&{begin} \37$\\{cmd}\K\\{vf\_byte}$;\5
$\\{decr}(\\{packet\_length})$;\5
\X719:Cases of \.{DVI} commands that can appear in character packet\X;\6
\&{if} $\\{cmd}\I\\{nop}$ \1\&{then}\5
$\\{append\_char}(\\{cmd})$;\2\6
$\\{packet\_length}\K\\{packet\_length}-\\{cmd\_length}$;\6
\&{while} $\\{cmd\_length}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{cmd\_length})$;\5
$\\{append\_char}(\\{vf\_byte})$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{stack\_level}\I0$ \1\&{then}\5
$\\{bad\_vf}(\.{"more\ PUSHs\ than\ POPs\ in\ character\ packet"})$;\2\6
\&{if} $\\{packet\_length}\I0$ \1\&{then}\5
$\\{bad\_vf}(\.{"invalid\ packet\ length\ or\ DVI\ command\ in\ packet"})$;\2\6
\X718:Store the packet being built\X;\6
$\\{cmd}\K\\{vf\_byte}$\par
\U712.\fi

\M718. \P$\X718:Store the packet being built\X\S$\6
$\|s\K\\{make\_string}$;\5
$\\{storepacket}(\|f,\39\\{cc},\39\|s)$;\5
$\\{flush\_str}(\|s)$\par
\U717.\fi

\M719. \P$\X719:Cases of \.{DVI} commands that can appear in character packet\X%
\S$\6
\&{if} $(\\{cmd}\G\\{set\_char\_0})\W(\\{cmd}\L\\{set\_char\_0}+127)$ \1%
\&{then}\5
$\\{cmd\_length}\K0$\6
\4\&{else} \&{if} $((\\{fnt\_num\_0}\L\\{cmd})\W(\\{cmd}\L\\{fnt\_num\_0}+63))%
\V((\\{fnt1}\L\\{cmd})\W(\\{cmd}\L\\{fnt1}+3))$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cmd}\G\\{fnt1}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{vf\_read\_unsigned}(\\{cmd}-\\{fnt1}+1)$;\5
$\\{packet\_length}\K\\{packet\_length}-(\\{cmd}-\\{fnt1}+1)$;\6
\&{end}\6
\4\&{else} $\|k\K\\{cmd}-\\{fnt\_num\_0}$;\2\6
\&{if} $\|k\G256$ \1\&{then}\5
$\\{bad\_vf}(\.{"too\ many\ local\ fonts"})$;\2\6
$\|n\K0$;\6
\&{while} $(\|n<\\{vf\_local\_font\_num}[\|f])\W(\\{vf\_e\_fnts}[\\{vf\_default%
\_font}[\|f]+\|n]\I\|k)$ \1\&{do}\5
$\\{incr}(\|n)$;\2\6
\&{if} $\|n=\\{vf\_local\_font\_num}[\|f]$ \1\&{then}\5
$\\{bad\_vf}(\.{"undefined\ local\ font"})$;\2\6
\&{if} $\|k\L63$ \1\&{then}\5
$\\{append\_char}(\\{fnt\_num\_0}+\|k)$\6
\4\&{else} \&{begin} \37$\\{append\_char}(\\{fnt1})$;\5
$\\{append\_char}(\|k)$;\6
\&{end};\2\6
$\\{cmd\_length}\K0$;\5
$\\{cmd}\K\\{nop}$;\6
\&{end}\6
\4\&{else} \&{case} $\\{cmd}$ \1\&{of}\6
\4$\\{set\_rule},\39\\{put\_rule}$: \37$\\{cmd\_length}\K8$;\6
\4$\\{four\_cases}(\\{set1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{set1}+1$;\6
\4$\\{four\_cases}(\\{put1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{put1}+1$;\6
\4$\\{four\_cases}(\\{right1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{right1}+1$;\6
\4$\\{four\_cases}(\\{w1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{w1}+1$;\6
\4$\\{four\_cases}(\\{x1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{x1}+1$;\6
\4$\\{four\_cases}(\\{down1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{down1}+1$;\6
\4$\\{four\_cases}(\\{y1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{y1}+1$;\6
\4$\\{four\_cases}(\\{z1})$: \37$\\{cmd\_length}\K\\{cmd}-\\{z1}+1$;\6
\4$\\{four\_cases}(\\{xxx1})$: \37\&{begin} \37$\\{cmd\_length}\K\\{vf\_read%
\_unsigned}(\\{cmd}-\\{xxx1}+1)$;\5
$\\{packet\_length}\K\\{packet\_length}-(\\{cmd}-\\{xxx1}+1)$;\6
\&{if} $\\{cmd\_length}>\\{vf\_max\_packet\_length}$ \1\&{then}\5
$\\{bad\_vf}(\.{"packet\ length\ too\ long"})$;\2\6
\&{if} $\\{cmd\_length}<0$ \1\&{then}\5
$\\{bad\_vf}(\.{"string\ of\ negative\ length"})$;\2\6
$\\{append\_char}(\\{xxx1})$;\5
$\\{append\_char}(\\{cmd\_length})$;\5
$\\{cmd}\K\\{nop}$;\C{\\{cmd} has been already stored above as \\{xxx1}}\6
\&{end};\6
\4$\\{w0},\39\\{x0},\39\\{y0},\39\\{z0},\39\\{nop}$: \37$\\{cmd\_length}\K0$;\6
\4$\\{push},\39\\{pop}$: \37\&{begin} \37$\\{cmd\_length}\K0$;\6
\&{if} $\\{cmd}=\\{push}$ \1\&{then}\6
\&{if} $\\{stack\_level}=\\{vf\_stack\_size}$ \1\&{then}\5
$\\{overflow}(\.{"virtual\ font\ stack\ size"},\39\\{vf\_stack\_size})$\6
\4\&{else} $\\{incr}(\\{stack\_level})$\2\6
\4\&{else} \&{if} $\\{stack\_level}=0$ \1\&{then}\5
$\\{bad\_vf}(\.{"more\ POPs\ than\ PUSHs\ in\ character"})$\6
\4\&{else} $\\{decr}(\\{stack\_level})$;\2\2\6
\&{end};\6
\4\&{othercases} \37$\\{bad\_vf}(\.{"improver\ DVI\ command"})$;\2\6
\&{endcases}\2\2\par
\U717.\fi

\M720. \P\6
\4\&{procedure}\1\  \37\\{pdf\_check\_vf\_cur\_val};\6
\4\&{var} \37\|f: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\|f\K\\{cur\_val}$;\5
$\\{do\_vf}(\|f)$;\6
\&{if} $\\{pdf\_font\_type}[\|f]=\\{virtual\_font\_type}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"command\ cannot\ be\ used\ with\ virtual\
font"})$;\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{auto\_expand\_vf}(\|f:\\{internal\_font\_number})$: %
\37\\{boolean};\C{check for a virtual auto-expanded font}\6
\4\&{var} \37$\\{bf},\39\\{lf}$: \37\\{internal\_font\_number};\5
$\|e,\39\|k$: \37\\{integer};\2\6
\&{begin} \37$\\{auto\_expand\_vf}\K\\{false}$;\6
\&{if} $(\R\\{pdf\_font\_auto\_expand}[\|f])\V(\\{pdf\_font\_blink}[\|f]=%
\\{null\_font})$ \1\&{then}\5
\&{return};\C{not an auto-expanded font}\2\6
$\\{bf}\K\\{pdf\_font\_blink}[\|f]$;\6
\&{if} $\\{pdf\_font\_type}[\\{bf}]=\\{new\_font\_type}$ \1\&{then}\C{we must
process the base font first}\6
$\\{do\_vf}(\\{bf})$;\2\6
\&{if} $\\{pdf\_font\_type}[\\{bf}]\I\\{virtual\_font\_type}$ \1\&{then}\5
\&{return};\C{not a virtual font}\2\6
$\|e\K\\{pdf\_font\_expand\_ratio}[\|f]$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{vf\_local\_font\_num}[\\{bf}]-1$ \1\&{do}\6
\&{begin} \37$\\{lf}\K\\{vf\_default\_font}[\\{bf}]+\|k$;\5
\\{allocvffnts};\C{copy vf local font numbers:}\6
$\\{vf\_e\_fnts}[\\{vf\_nf}]\K\\{vf\_e\_fnts}[\\{lf}]$;\C{definition of local
vf fonts are expanded from base fonts:}\6
$\\{vf\_i\_fnts}[\\{vf\_nf}]\K\\{auto\_expand\_font}(\\{vf\_i\_fnts}[\\{lf}],%
\39\|e)$;\5
$\\{copy\_expand\_params}(\\{vf\_i\_fnts}[\\{vf\_nf}],\39\\{vf\_i\_fnts}[%
\\{lf}],\39\|e)$;\5
$\\{incr}(\\{vf\_nf})$;\6
\&{end};\2\6
$\\{vf\_packet\_base}[\|f]\K\\{vf\_packet\_base}[\\{bf}]$;\5
$\\{vf\_local\_font\_num}[\|f]\K\\{vf\_local\_font\_num}[\\{bf}]$;\5
$\\{vf\_default\_font}[\|f]\K\\{vf\_nf}-\\{vf\_local\_font\_num}[\|f]$;\5
$\\{pdf\_font\_type}[\|f]\K\\{virtual\_font\_type}$;\5
$\\{auto\_expand\_vf}\K\\{true}$;\6
\&{end};\par
\fi

\M721. The \\{do\_vf\_packet} procedure is called in order to interpret the
character packet for a virtual character. Such a packet may contain the
instruction to typeset a character from the same or an other virtual
font; in such cases \\{do\_vf\_packet} calls itself recursively. The
recursion level, i.e., the number of times this has happened, is kept
in the global variable \\{vf\_cur\_s} and should not exceed \\{vf\_max%
\_recursion}.

\Y\P$\4\X11:Constants in the outer block\X\mathrel{+}\S$\6
$\\{vf\_max\_recursion}=10$;\C{\.{VF} files shouldn't recurse beyond this
level}\6
$\\{vf\_stack\_size}=100$;\C{\.{DVI} files shouldn't \\{push} beyond this
depth}\par
\fi

\M722. \P$\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{vf\_stack\_index}=0\to\\{vf\_stack\_size}$;\C{an index into the stack}\6
$\\{vf\_stack\_record}=$\1\5
\1\&{record} \37$\\{stack\_h},\39\\{stack\_v},\39\\{stack\_w},\39\\{stack\_x},%
\39\\{stack\_y},\39\\{stack\_z}$: \37\\{scaled};\2\6
\&{end};\2\par
\fi

\M723. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{vf\_cur\_s}: \37$0\to\\{vf\_max\_recursion}$;\C{current recursion level}\6
\4\\{vf\_stack}: \37\&{array} $[\\{vf\_stack\_index}]$ \1\&{of}\5
\\{vf\_stack\_record};\2\6
\4\\{vf\_stack\_ptr}: \37\\{vf\_stack\_index};\C{pointer into \\{vf\_stack}}\par
\fi

\M724. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{vf\_cur\_s}\K0$;\5
$\\{vf\_stack\_ptr}\K0$;\par
\fi

\M725. Some functions for processing character packets.

\Y\P\4\&{function}\1\  \37$\\{packet\_read\_signed}(\|k:\\{integer})$: \37%
\\{integer};\C{read \|k bytes as a signed integer from character packet}\6
\4\&{var} \37\|i: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}((\|k>0)\W(\|k\L4))$;\5
$\|i\K\\{packet\_byte}$;\6
\&{if} $\|i\G128$ \1\&{then}\5
$\|i\K\|i-256$;\2\6
$\\{decr}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\|i\K\|i\ast256+\\{packet\_byte}$;\5
$\\{decr}(\|k)$;\6
\&{end};\2\6
$\\{packet\_read\_signed}\K\|i$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{packet\_read\_unsigned}(\|k:\\{integer})$: \37%
\\{integer};\C{read \|k bytes as an unsigned integer from character packet}\6
\4\&{var} \37\|i: \37\\{integer};\2\6
\&{begin} \37$\\{pdfassert}((\|k>0)\W(\|k\L4))$;\5
$\|i\K\\{packet\_byte}$;\6
\&{if} $(\|k=4)\W(\|i\G128)$ \1\&{then}\5
$\\{bad\_vf}(\.{"number\ too\ big"})$;\2\6
$\\{decr}(\|k)$;\6
\&{while} $\|k>0$ \1\&{do}\6
\&{begin} \37$\|i\K\|i\ast256+\\{packet\_byte}$;\5
$\\{decr}(\|k)$;\6
\&{end};\2\6
$\\{packet\_read\_unsigned}\K\|i$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{packet\_scaled}(\|k:\\{integer};\,\35\\{fs}:%
\\{scaled})$: \37\\{scaled};\C{get \|k bytes from packet as scaled}\2\6
\&{begin} \37$\\{packet\_scaled}\K\\{store\_scaled\_f}(\\{packet\_read%
\_signed}(\|k),\39\\{fs})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_vf\_packet}(\\{vf\_f}:\\{internal\_font%
\_number};\,\35\|c:\\{eight\_bits})$;\C{typeset the \.{DVI} commands in the
character packet for character \|c in current font \|f}\6
\4\&{label} \37$\\{do\_char},\39\\{continue}$;\6
\4\&{var} \37$\|f,\39\|k,\39\|n$: \37\\{internal\_font\_number};\5
$\\{save\_cur\_h},\39\\{save\_cur\_v}$: \37\\{scaled};\5
\\{cmd}: \37\\{integer};\5
\\{char\_move}: \37\\{boolean};\5
$\|w,\39\|x,\39\|y,\39\|z$: \37\\{scaled};\5
\|s: \37\\{str\_number};\2\6
\&{begin} \37$\\{incr}(\\{vf\_cur\_s})$;\6
\&{if} $\\{vf\_cur\_s}>\\{vf\_max\_recursion}$ \1\&{then}\5
$\\{overflow}(\.{"max\ level\ recursion\ of\ virtual\ fonts"},\39\\{vf\_max%
\_recursion})$;\2\6
$\\{save\_cur\_v}\K\\{cur\_v}$;\5
$\\{save\_cur\_h}\K\\{cur\_h}$;\5
\\{push\_packet\_state};\C{save pointer and length of the current packet}\6
$\\{start\_packet}(\\{vf\_f},\39\|c)$;\C{set pointer and length of the new
packet}\6
$\|f\K\\{vf\_i\_fnts}[\\{vf\_default\_font}[\\{vf\_f}]]$;\5
$\|w\K0$;\5
$\|x\K0$;\5
$\|y\K0$;\5
$\|z\K0$;\6
\&{while} $\\{vf\_packet\_length}>0$ \1\&{do}\6
\&{begin} \37$\\{cmd}\K\\{packet\_byte}$;\5
\X726:Do typesetting the \.{DVI} commands in virtual character packet\X;\6
\4\\{continue}: \37\&{end};\2\6
\\{pop\_packet\_state};\C{restore pointer and length of the previous packet}\6
$\\{cur\_v}\K\\{save\_cur\_v}$;\5
$\\{cur\_h}\K\\{save\_cur\_h}$;\5
$\\{decr}(\\{vf\_cur\_s})$;\6
\&{end};\par
\fi

\M726. The following code typesets a character to PDF output.

\Y\P\D \37$\\{output\_one\_char}(\#)\S$\1\6
\&{begin} \37\&{if} $\\{pdf\_font\_type}[\|f]=\\{new\_font\_type}$ \1\&{then}\5
$\\{do\_vf}(\|f)$;\2\6
\&{if} $\\{pdf\_font\_type}[\|f]=\\{virtual\_font\_type}$ \1\&{then}\5
$\\{do\_vf\_packet}(\|f,\39\#)$\6
\4\&{else} \&{begin} \37$\\{pdf\_begin\_string}(\|f)$;\5
$\\{pdf\_print\_char}(\|f,\39\#)$;\5
$\\{adv\_char\_width}(\|f,\39\#,\394)$;\6
\&{end};\2\6
\&{end}\2\par
\Y\P$\4\X726:Do typesetting the \.{DVI} commands in virtual character packet\X%
\S$\6
\&{if} $(\\{cmd}\G\\{set\_char\_0})\W(\\{cmd}\L\\{set\_char\_0}+127)$ \1%
\&{then}\6
\&{begin} \37\&{if} $\R\\{is\_valid\_char}(\\{cmd})$ \1\&{then}\6
\&{begin} \37$\\{char\_warning}(\|f,\39\\{cmd})$;\5
\&{goto} \37\\{continue};\6
\&{end};\2\6
$\|c\K\\{cmd}$;\5
$\\{char\_move}\K\\{true}$;\5
\&{goto} \37\\{do\_char};\6
\&{end}\6
\4\&{else} \&{if} $((\\{fnt\_num\_0}\L\\{cmd})\W(\\{cmd}\L\\{fnt\_num\_0}+63))%
\V(\\{cmd}=\\{fnt1})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cmd}=\\{fnt1}$ \1\&{then}\5
$\|k\K\\{packet\_byte}$\6
\4\&{else} $\|k\K\\{cmd}-\\{fnt\_num\_0}$;\2\6
$\|n\K0$;\6
\&{while} $(\|n<\\{vf\_local\_font\_num}[\\{vf\_f}])\W(\\{vf\_e\_fnts}[\\{vf%
\_default\_font}[\\{vf\_f}]+\|n]\I\|k)$ \1\&{do}\5
$\\{incr}(\|n)$;\2\6
\&{if} $(\|n=\\{vf\_local\_font\_num}[\\{vf\_f}])$ \1\&{then}\5
$\\{pdf\_error}(\.{"vf"},\39\.{"local\ font\ not\ found"})$\6
\4\&{else} $\|f\K\\{vf\_i\_fnts}[\\{vf\_default\_font}[\\{vf\_f}]+\|n]$;\2\6
\&{end}\6
\4\&{else} \&{case} $\\{cmd}$ \1\&{of}\6
\4\\{push}: \37\&{begin} \37$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_h}\K%
\\{cur\_h}$;\5
$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_v}\K\\{cur\_v}$;\5
$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_w}\K\|w$;\5
$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_x}\K\|x$;\5
$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_y}\K\|y$;\5
$\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_z}\K\|z$;\5
$\\{incr}(\\{vf\_stack\_ptr})$;\6
\&{end};\6
\4\\{pop}: \37\&{begin} \37$\\{decr}(\\{vf\_stack\_ptr})$;\5
$\\{cur\_h}\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_h}$;\5
$\\{cur\_v}\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_v}$;\5
$\|w\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_w}$;\5
$\|x\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_x}$;\5
$\|y\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_y}$;\5
$\|z\K\\{vf\_stack}[\\{vf\_stack\_ptr}].\\{stack\_z}$;\6
\&{end};\6
\4$\\{four\_cases}(\\{set1}),\39\\{four\_cases}(\\{put1})$: \37\&{begin} \37%
\&{if} $(\\{set1}\L\\{cmd})\W(\\{cmd}\L\\{set1}+3)$ \1\&{then}\6
\&{begin} \37$\\{tmp\_int}\K\\{packet\_read\_unsigned}(\\{cmd}-\\{set1}+1)$;\5
$\\{char\_move}\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{tmp\_int}\K\\{packet\_read\_unsigned}(\\{cmd}-%
\\{put1}+1)$;\5
$\\{char\_move}\K\\{false}$;\6
\&{end};\2\6
\&{if} $\R\\{is\_valid\_char}(\\{tmp\_int})$ \1\&{then}\6
\&{begin} \37$\\{char\_warning}(\|f,\39\\{tmp\_int})$;\5
\&{goto} \37\\{continue};\6
\&{end};\2\6
$\|c\K\\{tmp\_int}$;\5
\&{goto} \37\\{do\_char};\6
\&{end};\6
\4$\\{set\_rule},\39\\{put\_rule}$: \37\&{begin} \37$\\{rule\_ht}\K\\{packet%
\_scaled}(4,\39\\{font\_size}[\\{vf\_f}])$;\5
$\\{rule\_wd}\K\\{packet\_scaled}(4,\39\\{font\_size}[\\{vf\_f}])$;\6
\&{if} $(\\{rule\_wd}>0)\W(\\{rule\_ht}>0)$ \1\&{then}\6
\&{begin} \37$\\{pdf\_set\_rule}(\\{cur\_h},\39\\{cur\_v},\39\\{rule\_wd},\39%
\\{rule\_ht})$;\6
\&{if} $\\{cmd}=\\{set\_rule}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{rule\_wd}$;\2\6
\&{end};\2\6
\&{end};\6
\4$\\{four\_cases}(\\{right1})$: \37$\\{cur\_h}\K\\{cur\_h}+\\{packet\_scaled}(%
\\{cmd}-\\{right1}+1,\39\\{font\_size}[\\{vf\_f}])$;\6
\4$\\{w0},\39\\{four\_cases}(\\{w1})$: \37\&{begin} \37\&{if} $\\{cmd}>\\{w0}$ %
\1\&{then}\5
$\|w\K\\{packet\_scaled}(\\{cmd}-\\{w0},\39\\{font\_size}[\\{vf\_f}])$;\2\6
$\\{cur\_h}\K\\{cur\_h}+\|w$;\6
\&{end};\6
\4$\\{x0},\39\\{four\_cases}(\\{x1})$: \37\&{begin} \37\&{if} $\\{cmd}>\\{x0}$ %
\1\&{then}\5
$\|x\K\\{packet\_scaled}(\\{cmd}-\\{x0},\39\\{font\_size}[\\{vf\_f}])$;\2\6
$\\{cur\_h}\K\\{cur\_h}+\|x$;\6
\&{end};\6
\4$\\{four\_cases}(\\{down1})$: \37$\\{cur\_v}\K\\{cur\_v}+\\{packet\_scaled}(%
\\{cmd}-\\{down1}+1,\39\\{font\_size}[\\{vf\_f}])$;\6
\4$\\{y0},\39\\{four\_cases}(\\{y1})$: \37\&{begin} \37\&{if} $\\{cmd}>\\{y0}$ %
\1\&{then}\5
$\|y\K\\{packet\_scaled}(\\{cmd}-\\{y0},\39\\{font\_size}[\\{vf\_f}])$;\2\6
$\\{cur\_v}\K\\{cur\_v}+\|y$;\6
\&{end};\6
\4$\\{z0},\39\\{four\_cases}(\\{z1})$: \37\&{begin} \37\&{if} $\\{cmd}>\\{z0}$ %
\1\&{then}\5
$\|z\K\\{packet\_scaled}(\\{cmd}-\\{z0},\39\\{font\_size}[\\{vf\_f}])$;\2\6
$\\{cur\_v}\K\\{cur\_v}+\|z$;\6
\&{end};\6
\4$\\{four\_cases}(\\{xxx1})$: \37\&{begin} \37$\\{tmp\_int}\K\\{packet\_read%
\_unsigned}(\\{cmd}-\\{xxx1}+1)$;\5
$\\{str\_room}(\\{tmp\_int})$;\6
\&{while} $\\{tmp\_int}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{tmp\_int})$;\5
$\\{append\_char}(\\{packet\_byte})$;\6
\&{end};\2\6
$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{scan\_special},\39\\{false})$;\5
$\\{flush\_str}(\|s)$;\6
\&{end};\6
\4\&{othercases} \37$\\{pdf\_error}(\.{"vf"},\39\.{"invalid\ DVI\ command"})$;%
\2\6
\&{endcases};\2\2\6
\&{goto} \37\\{continue};\6
\4\\{do\_char}: \37\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\5
$\\{output\_one\_char}(\|c)$\6
\4\&{else} $\\{char\_warning}(\|f,\39\|c)$;\2\6
\&{if} $\\{char\_move}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$\2\par
\U725.\fi

\N727.  \[32f] PDF shipping out.
To ship out a \TeX\ box to PDF page description we need to implement
\\{pdf\_hlist\_out}, \\{pdf\_vlist\_out} and \\{pdf\_ship\_out}, which are
equivalent to
the \TeX' original \\{hlist\_out}, \\{vlist\_out} and \\{ship\_out} resp. But
first we
need to declare some procedures needed in \\{pdf\_hlist\_out} and \\{pdf\_vlist%
\_out}.

\Y\P$\4\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\S$\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_literal}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|s: \37\\{str\_number};\5
\|h: \37\\{halfword};\5
$\|q,\39\|r$: \37\\{pointer};\C{temporary variables for list manipulation}\6
\\{old\_mode}: \37\\{integer};\C{saved \\{mode}}\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\6
\&{if} $\\{subtype}(\|p)=\\{pdf\_lateliteral\_node}$ \1\&{then}\6
\&{begin} \37\X1618:Expand macros in the token list and make $\\{link}(\\{def%
\_ref})$ point to the result\X;\6
$\|h\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\|h\K\\{pdf\_literal\_data}(\|p)$;\2\6
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\|h),\39\\{null},\39\\{pool\_size}-\\{pool%
\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{pdf\_literal\_mode}(\|p),\39\\{false})$;\5
$\\{flush\_str}(\|s)$;\6
\&{if} $\\{subtype}(\|p)=\\{pdf\_lateliteral\_node}$ \1\&{then}\5
$\\{flush\_list}(\\{def\_ref})$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_colorstack}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|s: \37\\{str\_number};\5
\\{cmd}: \37\\{integer};\5
\\{stack\_no}: \37\\{integer};\5
\\{literal\_mode}: \37\\{integer};\2\6
\&{begin} \37$\\{cmd}\K\\{pdf\_colorstack\_cmd}(\|p)$;\5
$\\{stack\_no}\K\\{pdf\_colorstack\_stack}(\|p)$;\6
\&{if} $\\{stack\_no}\G\\{colorstackused}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{""})$;\5
$\\{print}(\.{"Color\ stack\ "})$;\5
$\\{print\_int}(\\{stack\_no})$;\5
$\\{print}(\.{"\ is\ not\ initialized\ for\ use!"})$;\5
$\\{print\_nl}(\.{""})$;\5
\&{return};\6
\&{end};\2\6
\&{case} $\\{cmd}$ \1\&{of}\6
\4$\\{colorstack\_set},\39\\{colorstack\_push}$: \37\&{begin} \37$\\{old%
\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\\{pdf\_colorstack\_data}(\|p)),\39\\{null},\39%
\\{pool\_size}-\\{pool\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\|s\K\\{make\_string}$;\6
\&{if} $\\{cmd}=\\{colorstack\_set}$ \1\&{then}\5
$\\{literal\_mode}\K\\{colorstackset}(\\{stack\_no},\39\|s)$\6
\4\&{else} $\\{literal\_mode}\K\\{colorstackpush}(\\{stack\_no},\39\|s)$;\2\6
\&{if} $\\{length}(\|s)>0$ \1\&{then}\5
$\\{literal}(\|s,\39\\{literal\_mode},\39\\{false})$;\2\6
$\\{flush\_str}(\|s)$;\5
\&{return};\6
\&{end};\6
\4\\{colorstack\_pop}: \37$\\{literal\_mode}\K\\{colorstackpop}(\\{stack%
\_no})$;\6
\4\\{colorstack\_current}: \37$\\{literal\_mode}\K\\{colorstackcurrent}(%
\\{stack\_no})$;\6
\4\&{othercases} \37$\\{confusion}(\.{"pdfcolorstack"})$\2\6
\&{endcases};\6
\&{if} $\\{cur\_length}>0$ \1\&{then}\6
\&{begin} \37$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{literal\_mode},\39\\{false})$;\5
$\\{flush\_str}(\|s)$;\6
\&{end}\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pdf\_out\_colorstack\_startpage};\6
\4\&{var} \37\|i: \37\\{integer};\5
\\{max}: \37\\{integer};\5
\\{start\_status}: \37\\{integer};\5
\\{literal\_mode}: \37\\{integer};\5
\|s: \37\\{str\_number};\2\6
\&{begin} \37$\|i\K0$;\5
$\\{max}\K\\{colorstackused}$;\6
\&{while} $\|i<\\{max}$ \1\&{do}\6
\&{begin} \37$\\{start\_status}\K\\{colorstackskippagestart}(\|i)$;\6
\&{if} $\\{start\_status}=0$ \1\&{then}\6
\&{begin} \37$\\{literal\_mode}\K\\{colorstackcurrent}(\|i)$;\6
\&{if} $\\{cur\_length}>0$ \1\&{then}\6
\&{begin} \37$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{literal\_mode},\39\\{false})$;\5
$\\{flush\_str}(\|s)$;\6
\&{end};\2\6
\&{end};\2\6
$\\{incr}(\|i)$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_setmatrix}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|s: \37\\{str\_number};\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\\{pdf\_setmatrix\_data}(\|p)),\39\\{null},\39%
\\{pool\_size}-\\{pool\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{str\_room}(7)$;\5
$\\{str\_pool}[\\{pool\_ptr}]\K0$;\C{ make C string for pdfsetmatrix }\6
\&{if} $\\{pdfsetmatrix}(\\{str\_start}[\\{str\_ptr}],\39\\{cur\_h},\39\\{cur%
\_page\_height}-\\{cur\_v})=1$ \1\&{then}\6
\&{begin} \37$\\{str\_room}(7)$;\5
$\\{append\_char}(\.{"\ "})$;\5
$\\{append\_char}(\.{"0"})$;\5
$\\{append\_char}(\.{"\ "})$;\5
$\\{append\_char}(\.{"0"})$;\5
$\\{append\_char}(\.{"\ "})$;\5
$\\{append\_char}(\.{"c"})$;\5
$\\{append\_char}(\.{"m"})$;\5
$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{set\_origin},\39\\{false})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_error}(\.{"\\pdfsetmatrix"},\39%
\.{"Unrecognized\ format."})$;\6
\&{end};\2\6
$\\{flush\_str}(\|s)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_save}(\|p:\\{pointer})$;\2\6
\&{begin} \37$\\{checkpdfsave}(\\{cur\_h},\39\\{cur\_v})$;\5
$\\{literal}(\.{"q"},\39\\{set\_origin},\39\\{false})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_out\_restore}(\|p:\\{pointer})$;\2\6
\&{begin} \37$\\{checkpdfrestore}(\\{cur\_h},\39\\{cur\_v})$;\5
$\\{literal}(\.{"Q"},\39\\{set\_origin},\39\\{false})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_special}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|s: \37\\{str\_number};\5
\|h: \37\\{halfword};\5
$\|q,\39\|r$: \37\\{pointer};\C{temporary variables for list manipulation}\6
\\{old\_mode}: \37\\{integer};\C{saved \\{mode}}\2\6
\&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{selector}$;\6
\&{if} $\\{subtype}(\|p)=\\{latespecial\_node}$ \1\&{then}\6
\&{begin} \37\X1618:Expand macros in the token list and make $\\{link}(\\{def%
\_ref})$ point to the result\X;\6
$\|h\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\|h\K\\{write\_tokens}(\|p)$;\2\6
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\|h),\39\\{null},\39\\{pool\_size}-\\{pool%
\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\|s\K\\{make\_string}$;\5
$\\{literal}(\|s,\39\\{scan\_special},\39\\{true})$;\5
$\\{flush\_str}(\|s)$;\6
\&{if} $\\{subtype}(\|p)=\\{latespecial\_node}$ \1\&{then}\5
$\\{flush\_list}(\\{def\_ref})$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_toks}(\|p:\\{pointer})$;\C{print tokens
list \|p}\6
\4\&{var} \37\|s: \37\\{str\_number};\2\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\|p)$;\6
\&{if} $\\{length}(\|s)>0$ \1\&{then}\5
$\\{pdf\_print}(\|s)$;\2\6
$\\{flush\_str}(\|s)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_toks\_ln}(\|p:\\{pointer})$;\C{print
tokens list \|p}\6
\4\&{var} \37\|s: \37\\{str\_number};\2\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\|p)$;\6
\&{if} $\\{length}(\|s)>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\|s)$;\6
\&{end};\2\6
$\\{flush\_str}(\|s)$;\6
\&{end};\par
\As772, 778, 785, 1564, 1630, 1635, 1636\ETs1637.
\U729.\fi

\M728. Similar to \\{vlist\_out}, \\{pdf\_vlist\_out} needs to be declared
forward.

\Y\P\4\&{procedure}\1\  \37\\{pdf\_vlist\_out};\5
\\{forward};\par
\fi

\M729. The implementation of procedure \\{pdf\_hlist\_out} is similar to %
\\{hlist\_out}.

\Y\P\hbox{\4}\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf%
\_vlist\_out}\X\hbox{}\6
\4\&{procedure}\1\  \37\\{pdf\_hlist\_out};\C{output an \\{hlist\_node} box}\6
\4\&{label} \37$\\{reswitch},\39\\{move\_past},\39\\{fin\_rule},\39\\{next%
\_p}$;\6
\4\&{var} \37\\{base\_line}: \37\\{scaled};\C{the baseline coordinate for this
box}\6
\\{left\_edge}: \37\\{scaled};\C{the left coordinate for this box}\6
\\{save\_h}: \37\\{scaled};\C{what \\{cur\_h} should pop to}\6
\\{this\_box}: \37\\{pointer};\C{pointer to containing box}\6
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\|p: \37\\{pointer};\C{current position in the hlist}\6
\\{leader\_box}: \37\\{pointer};\C{the leader box being replicated}\6
\\{leader\_wd}: \37\\{scaled};\C{width of leader box being replicated}\6
\\{lx}: \37\\{scaled};\C{extra space between leader boxes}\6
\\{outer\_doing\_leaders}: \37\\{boolean};\C{were we doing leaders?}\6
\\{edge}: \37\\{scaled};\C{right edge of sub-box or leader space}\6
\\{prev\_p}: \37\\{pointer};\C{one step behind \|p}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
\\{cur\_glue}: \37\\{real};\C{glue seen so far}\6
\\{cur\_g}: \37\\{scaled};\C{rounded equivalent of \\{cur\_glue} times the glue
ratio}\6
\|i: \37\\{small\_number};\C{index to scan \\{pdf\_link\_stack}}\2\6
\&{begin} \37$\\{cur\_g}\K0$;\5
$\\{cur\_glue}\K\\{float\_constant}(0)$;\5
$\\{this\_box}\K\\{temp\_ptr}$;\5
$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\5
$\|p\K\\{list\_ptr}(\\{this\_box})$;\5
$\\{incr}(\\{cur\_s})$;\5
$\\{base\_line}\K\\{cur\_v}$;\5
$\\{prev\_p}\K\\{this\_box}+\\{list\_offset}$;\5
\X1714:Initialize \\{hlist\_out} for mixed direction typesetting\X;\6
$\\{left\_edge}\K\\{cur\_h}$;\5
\X730:Create link annotations for the current hbox if needed\X;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X731:Output node \|p for \\{pdf\_hlist\_out} and move to the next node,
maintaining the condition $\\{cur\_v}=\\{base\_line}$\X;\2\6
\X1715:Finish \\{hlist\_out} for mixed direction typesetting\X;\6
$\\{decr}(\\{cur\_s})$;\6
\&{end};\par
\fi

\M730. \P$\X730:Create link annotations for the current hbox if needed\X\S$\6
\&{for} $\|i\K1\mathrel{\&{to}}\\{pdf\_link\_stack\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{pdfassert}(\\{is\_running}(\\{pdf\_width}(\\{pdf\_link%
\_stack}[\|i].\\{link\_node})))$;\6
\&{if} $(\\{pdf\_link\_stack}[\|i].\\{nesting\_level}=\\{cur\_s})\W\\{gen%
\_running\_link}$ \1\&{then}\5
$\\{append\_link}(\\{this\_box},\39\\{left\_edge},\39\\{base\_line},\39\|i)$;\2%
\6
\&{end}\2\par
\U729.\fi

\M731. \P$\X731:Output node \|p for \\{pdf\_hlist\_out} and move to the next
node, maintaining the condition $\\{cur\_v}=\\{base\_line}$\X\S$\6
\4\\{reswitch}: \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37\1\&{repeat} \37$\|f\K\\{font}(\|p)$;\5
$\|c\K\\{character}(\|p)$;\6
\&{if} $\\{is\_valid\_char}(\|c)$ \1\&{then}\5
$\\{output\_one\_char}(\|c)$\6
\4\&{else} $\\{char\_warning}(\|f,\39\|c)$;\2\6
$\\{cur\_h}\K\\{cur\_h}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$;\5
$\\{prev\_p}\K\\{link}(\\{prev\_p})$;\C{N.B.: not $\\{prev\_p}\K\|p$, \|p might
be \\{lig\_trick}}\6
$\|p\K\\{link}(\|p)$;\6
\4\&{until}\5
$\R\\{is\_char\_node}(\|p)$;\2\6
\&{end}\6
\4\&{else} \X732:Output the non-\\{char\_node} \|p for \\{pdf\_hlist\_out} and
move to the next node\X\2\par
\U729.\fi

\M732. \P$\X732:Output the non-\\{char\_node} \|p for \\{pdf\_hlist\_out} and
move to the next node\X\S$\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node}$: \37\X733:(\pdfTeX) Output a box in an
hlist\X;\6
\4\\{rule\_node}: \37\&{begin} \37$\\{rule\_ht}\K\\{height}(\|p)$;\5
$\\{rule\_dp}\K\\{depth}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|p)$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1645:Output the whatsit node \|p in \\{pdf\_hlist%
\_out}\X;\6
\4\\{glue\_node}: \37\X735:(\pdfTeX) Move right or output leaders\X;\6
\4$\\{margin\_kern\_node},\39\\{kern\_node}$: \37$\\{cur\_h}\K\\{cur\_h}+%
\\{width}(\|p)$;\6
\4\\{math\_node}: \37\X1716:Handle a math node in \\{hlist\_out}\X;\6
\4\\{ligature\_node}: \37\X826:Make node \|p look like a \\{char\_node} and %
\&{goto} \\{reswitch}\X;\6
\X1720:Cases of \\{hlist\_out} that arise in mixed direction text only\X\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{goto} \37\\{next\_p};\6
\4\\{fin\_rule}: \37\X734:(\pdfTeX) Output a rule in an hlist\X;\6
\4\\{move\_past}: \37$\\{cur\_h}\K\\{cur\_h}+\\{rule\_wd}$;\6
\4\\{next\_p}: \37$\\{prev\_p}\K\|p$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U731.\fi

\M733. \P$\X733:(\pdfTeX) Output a box in an hlist\X\S$\6
\&{if} $\\{list\_ptr}(\|p)=\\{null}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{width}(\|p)$\6
\4\&{else} \&{begin} \37$\\{cur\_v}\K\\{base\_line}+\\{shift\_amount}(\|p)$;%
\C{shift the box down}\6
$\\{temp\_ptr}\K\|p$;\5
$\\{edge}\K\\{cur\_h}+\\{width}(\|p)$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{edge}$;\2\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{pdf\_vlist\_out}\ \&{else} \\{pdf\_hlist\_out};\2\6
$\\{cur\_h}\K\\{edge}$;\5
$\\{cur\_v}\K\\{base\_line}$;\6
\&{end}\2\par
\U732.\fi

\M734. \P$\X734:(\pdfTeX) Output a rule in an hlist\X\S$\6
\&{if} $\\{is\_running}(\\{rule\_ht})$ \1\&{then}\5
$\\{rule\_ht}\K\\{height}(\\{this\_box})$;\2\6
\&{if} $\\{is\_running}(\\{rule\_dp})$ \1\&{then}\5
$\\{rule\_dp}\K\\{depth}(\\{this\_box})$;\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{rule\_dp}$;\C{this is the rule thickness}\6
\&{if} $(\\{rule\_ht}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\C{we don't output empty
rules}\6
\&{begin} \37$\\{cur\_v}\K\\{base\_line}+\\{rule\_dp}$;\5
$\\{pdf\_set\_rule}(\\{cur\_h},\39\\{cur\_v},\39\\{rule\_wd},\39\\{rule\_ht})$;%
\5
$\\{cur\_v}\K\\{base\_line}$;\6
\&{end}\2\par
\U732.\fi

\M735. \P$\X735:(\pdfTeX) Move right or output leaders\X\S$\6
\&{begin} \37$\|g\K\\{glue\_ptr}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|g)-\\{cur\_g}$;\6
\&{if} $\\{g\_sign}\I\\{normal}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{g\_sign}=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}+\\{stretch}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{shrink\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}-\\{shrink}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\2\6
\&{end};\2\6
$\\{rule\_wd}\K\\{rule\_wd}+\\{cur\_g}$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1699:Handle a glue node for mixed direction typesetting\X;\2\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\X736:(\pdfTeX) Output leaders in an hlist, \&{goto} \\{fin\_rule} if a rule or
to \\{next\_p} if done\X;\2\6
\&{goto} \37\\{move\_past};\6
\&{end}\par
\U732.\fi

\M736. \P$\X736:(\pdfTeX) Output leaders in an hlist, \&{goto} \\{fin\_rule} if
a rule or to \\{next\_p} if done\X\S$\6
\&{begin} \37$\\{leader\_box}\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{rule\_node}$ \1\&{then}\6
\&{begin} \37$\\{rule\_ht}\K\\{height}(\\{leader\_box})$;\5
$\\{rule\_dp}\K\\{depth}(\\{leader\_box})$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\2\6
$\\{leader\_wd}\K\\{width}(\\{leader\_box})$;\6
\&{if} $(\\{leader\_wd}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\6
\&{begin} \37$\\{rule\_wd}\K\\{rule\_wd}+10$;\C{compensate for floating-point
rounding}\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}-10$;\2\6
$\\{edge}\K\\{cur\_h}+\\{rule\_wd}$;\5
$\\{lx}\K0$;\5
\X655:Let \\{cur\_h} be the position of the first box, and set $\\{leader\_wd}+%
\\{lx}$ to the spacing between corresponding parts of boxes\X;\6
\&{while} $\\{cur\_h}+\\{leader\_wd}\L\\{edge}$ \1\&{do}\5
\X737:(\pdfTeX) Output a leader box at \\{cur\_h}, then advance \\{cur\_h} by $%
\\{leader\_wd}+\\{lx}$\X;\2\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{edge}$\6
\4\&{else} $\\{cur\_h}\K\\{edge}-10$;\2\6
\&{goto} \37\\{next\_p};\6
\&{end};\2\6
\&{end}\par
\U735.\fi

\M737. \P$\X737:(\pdfTeX) Output a leader box at \\{cur\_h}, then advance %
\\{cur\_h} by $\\{leader\_wd}+\\{lx}$\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{base\_line}+\\{shift\_amount}(\\{leader\_box})$;\6
$\\{save\_h}\K\\{cur\_h}$;\5
$\\{temp\_ptr}\K\\{leader\_box}$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}+\\{leader\_wd}$;\2\6
$\\{outer\_doing\_leaders}\K\\{doing\_leaders}$;\5
$\\{doing\_leaders}\K\\{true}$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{vlist\_node}$ \1\&{then}\5
\\{pdf\_vlist\_out}\ \&{else} \\{pdf\_hlist\_out};\2\6
$\\{doing\_leaders}\K\\{outer\_doing\_leaders}$;\5
$\\{cur\_v}\K\\{base\_line}$;\5
$\\{cur\_h}\K\\{save\_h}+\\{leader\_wd}+\\{lx}$;\6
\&{end}\par
\U736.\fi

\M738. The \\{pdf\_vlist\_out} routine is similar to \\{pdf\_hlist\_out}, but a
bit simpler.
\Y\P\4\&{procedure}\1\  \37\\{pdf\_vlist\_out};\C{output a \\{pdf\_vlist\_node}
box}\6
\4\&{label} \37$\\{move\_past},\39\\{fin\_rule},\39\\{next\_p}$;\6
\4\&{var} \37\\{left\_edge}: \37\\{scaled};\C{the left coordinate for this box}%
\6
\\{top\_edge}: \37\\{scaled};\C{the top coordinate for this box}\6
\\{save\_v}: \37\\{scaled};\C{what \\{cur\_v} should pop to}\6
\\{this\_box}: \37\\{pointer};\C{pointer to containing box}\6
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\|p: \37\\{pointer};\C{current position in the vlist}\6
\\{leader\_box}: \37\\{pointer};\C{the leader box being replicated}\6
\\{leader\_ht}: \37\\{scaled};\C{height of leader box being replicated}\6
\\{lx}: \37\\{scaled};\C{extra space between leader boxes}\6
\\{outer\_doing\_leaders}: \37\\{boolean};\C{were we doing leaders?}\6
\\{edge}: \37\\{scaled};\C{bottom boundary of leader space}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
\\{cur\_glue}: \37\\{real};\C{glue seen so far}\6
\\{cur\_g}: \37\\{scaled};\C{rounded equivalent of \\{cur\_glue} times the glue
ratio}\2\6
\&{begin} \37$\\{cur\_g}\K0$;\5
$\\{cur\_glue}\K\\{float\_constant}(0)$;\5
$\\{this\_box}\K\\{temp\_ptr}$;\5
$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\5
$\|p\K\\{list\_ptr}(\\{this\_box})$;\5
$\\{incr}(\\{cur\_s})$;\5
$\\{left\_edge}\K\\{cur\_h}$;\5
$\\{cur\_v}\K\\{cur\_v}-\\{height}(\\{this\_box})$;\5
$\\{top\_edge}\K\\{cur\_v}$;\5
\X739:Create thread for the current vbox if needed\X;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X740:Output node \|p for \\{pdf\_vlist\_out} and move to the next node,
maintaining the condition $\\{cur\_h}=\\{left\_edge}$\X;\2\6
$\\{decr}(\\{cur\_s})$;\6
\&{end};\par
\fi

\M739. \P$\X739:Create thread for the current vbox if needed\X\S$\6
\&{if} $(\\{last\_thread}\I\\{null})\W\\{is\_running}(\\{pdf\_thread\_dp})\W(%
\\{pdf\_thread\_level}=\\{cur\_s})$ \1\&{then}\5
$\\{append\_thread}(\\{this\_box},\39\\{left\_edge},\39\\{top\_edge}+%
\\{height}(\\{this\_box}))$\2\par
\U738.\fi

\M740. \P$\X740:Output node \|p for \\{pdf\_vlist\_out} and move to the next
node, maintaining the condition $\\{cur\_h}=\\{left\_edge}$\X\S$\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{confusion}(\.{"pdfvlistout"})$\6
\4\&{else} \X741:Output the non-\\{char\_node} \|p for \\{pdf\_vlist\_out}\X;\2%
\6
\4\\{next\_p}: \37$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U738.\fi

\M741. \P$\X741:Output the non-\\{char\_node} \|p for \\{pdf\_vlist\_out}\X\S$\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node}$: \37\X742:(\pdfTeX) Output a box in a
vlist\X;\6
\4\\{rule\_node}: \37\&{begin} \37$\\{rule\_ht}\K\\{height}(\|p)$;\5
$\\{rule\_dp}\K\\{depth}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|p)$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1639:Output the whatsit node \|p in \\{pdf\_vlist%
\_out}\X;\6
\4\\{glue\_node}: \37\X744:(\pdfTeX) Move down or output leaders\X;\6
\4\\{kern\_node}: \37$\\{cur\_v}\K\\{cur\_v}+\\{width}(\|p)$;\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{goto} \37\\{next\_p};\6
\4\\{fin\_rule}: \37\X743:(\pdfTeX) Output a rule in a vlist, \&{goto} \\{next%
\_p}\X;\6
\4\\{move\_past}: \37$\\{cur\_v}\K\\{cur\_v}+\\{rule\_ht}$;\6
\&{end}\par
\U740.\fi

\M742. \P$\X742:(\pdfTeX) Output a box in a vlist\X\S$\6
\&{if} $\\{list\_ptr}(\|p)=\\{null}$ \1\&{then}\5
$\\{cur\_v}\K\\{cur\_v}+\\{height}(\|p)+\\{depth}(\|p)$\6
\4\&{else} \&{begin} \37$\\{cur\_v}\K\\{cur\_v}+\\{height}(\|p)$;\5
$\\{save\_v}\K\\{cur\_v}$;\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{left\_edge}-\\{shift\_amount}(\|p)$\6
\4\&{else} $\\{cur\_h}\K\\{left\_edge}+\\{shift\_amount}(\|p)$;\C{shift the box
right}\2\6
$\\{temp\_ptr}\K\|p$;\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{pdf\_vlist\_out}\ \&{else} \\{pdf\_hlist\_out};\2\6
$\\{cur\_v}\K\\{save\_v}+\\{depth}(\|p)$;\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end}\2\par
\U741.\fi

\M743. \P$\X743:(\pdfTeX) Output a rule in a vlist, \&{goto} \\{next\_p}\X\S$\6
\&{if} $\\{is\_running}(\\{rule\_wd})$ \1\&{then}\5
$\\{rule\_wd}\K\\{width}(\\{this\_box})$;\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{rule\_dp}$;\C{this is the rule thickness}\6
$\\{cur\_v}\K\\{cur\_v}+\\{rule\_ht}$;\6
\&{if} $(\\{rule\_ht}>0)\W(\\{rule\_wd}>0)$ \1\&{then}\C{we don't output empty
rules}\6
\&{begin} \37\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{cur\_h}-\\{rule\_wd}$;\2\6
$\\{pdf\_set\_rule}(\\{cur\_h},\39\\{cur\_v},\39\\{rule\_wd},\39\\{rule\_ht})$;%
\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end};\2\6
\&{goto} \37\\{next\_p}\par
\U741.\fi

\M744. \P$\X744:(\pdfTeX) Move down or output leaders\X\S$\6
\&{begin} \37$\|g\K\\{glue\_ptr}(\|p)$;\5
$\\{rule\_ht}\K\\{width}(\|g)-\\{cur\_g}$;\6
\&{if} $\\{g\_sign}\I\\{normal}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{g\_sign}=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}+\\{stretch}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{shrink\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}-\\{shrink}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\2\6
\&{end};\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{cur\_g}$;\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\X745:(\pdfTeX) Output leaders in a vlist, \&{goto} \\{fin\_rule} if a rule or
to \\{next\_p} if done\X;\2\6
\&{goto} \37\\{move\_past};\6
\&{end}\par
\U741.\fi

\M745. \P$\X745:(\pdfTeX) Output leaders in a vlist, \&{goto} \\{fin\_rule} if
a rule or to \\{next\_p} if done\X\S$\6
\&{begin} \37$\\{leader\_box}\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{rule\_node}$ \1\&{then}\6
\&{begin} \37$\\{rule\_wd}\K\\{width}(\\{leader\_box})$;\5
$\\{rule\_dp}\K0$;\5
\&{goto} \37\\{fin\_rule};\6
\&{end};\2\6
$\\{leader\_ht}\K\\{height}(\\{leader\_box})+\\{depth}(\\{leader\_box})$;\6
\&{if} $(\\{leader\_ht}>0)\W(\\{rule\_ht}>0)$ \1\&{then}\6
\&{begin} \37$\\{rule\_ht}\K\\{rule\_ht}+10$;\C{compensate for floating-point
rounding}\6
$\\{edge}\K\\{cur\_v}+\\{rule\_ht}$;\5
$\\{lx}\K0$;\5
\X664:Let \\{cur\_v} be the position of the first box, and set $\\{leader\_ht}+%
\\{lx}$ to the spacing between corresponding parts of boxes\X;\6
\&{while} $\\{cur\_v}+\\{leader\_ht}\L\\{edge}$ \1\&{do}\5
\X746:(\pdfTeX) Output a leader box at \\{cur\_v}, then advance \\{cur\_v} by $%
\\{leader\_ht}+\\{lx}$\X;\2\6
$\\{cur\_v}\K\\{edge}-10$;\5
\&{goto} \37\\{next\_p};\6
\&{end};\2\6
\&{end}\par
\U744.\fi

\M746. \P$\X746:(\pdfTeX) Output a leader box at \\{cur\_v}, then advance %
\\{cur\_v} by $\\{leader\_ht}+\\{lx}$\X\S$\6
\&{begin} \37\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\5
$\\{cur\_h}\K\\{left\_edge}-\\{shift\_amount}(\\{leader\_box})$\6
\4\&{else} $\\{cur\_h}\K\\{left\_edge}+\\{shift\_amount}(\\{leader\_box})$;\2\6
$\\{cur\_v}\K\\{cur\_v}+\\{height}(\\{leader\_box})$;\5
$\\{save\_v}\K\\{cur\_v}$;\5
$\\{temp\_ptr}\K\\{leader\_box}$;\5
$\\{outer\_doing\_leaders}\K\\{doing\_leaders}$;\5
$\\{doing\_leaders}\K\\{true}$;\6
\&{if} $\\{type}(\\{leader\_box})=\\{vlist\_node}$ \1\&{then}\5
\\{pdf\_vlist\_out}\ \&{else} \\{pdf\_hlist\_out};\2\6
$\\{doing\_leaders}\K\\{outer\_doing\_leaders}$;\5
$\\{cur\_h}\K\\{left\_edge}$;\5
$\\{cur\_v}\K\\{save\_v}-\\{height}(\\{leader\_box})+\\{leader\_ht}+\\{lx}$;\6
\&{end}\par
\U745.\fi

\M747. \\{fix\_pdfoutput} freezes \\{pdfoutput} when something has been written
to
the output.

\Y\P\4\&{procedure}\1\  \37\\{fix\_pdfoutput};\2\6
\&{begin} \37\&{if} $\R\\{fixed\_pdfoutput\_set}$ \1\&{then}\6
\&{begin} \37$\\{fixed\_pdfoutput}\K\\{pdf\_output}$;\5
$\\{fixed\_pdfoutput\_set}\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{fixed\_pdfoutput}\I\\{pdf\_output}$ \1\&{then}\5
$\\{pdf\_error}(\.{"setup"},\39\.{"\\pdfoutput\ can\ only\ be\ changed\ before\
anything\ is\ written\ to\ the\ output"})$;\2\2\6
\&{if} $\\{fixed\_pdfoutput\_set}$ \1\&{then}\5
\\{fix\_pdf\_draftmode};\2\6
\&{end};\par
\fi

\M748. \\{fix\_pdf\_draftmode} freezes \\{pdfdraftmode} when something has been
written to
the output and also switches some things off when draftmode is on.
\Y\P\4\&{procedure}\1\  \37\\{fix\_pdf\_draftmode};\2\6
\&{begin} \37\&{if} $\R\\{fixed\_pdf\_draftmode\_set}$ \1\&{then}\6
\&{begin} \37$\\{fixed\_pdf\_draftmode}\K\\{pdf\_draftmode}$;\5
$\\{fixed\_pdf\_draftmode\_set}\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{fixed\_pdf\_draftmode}\I\\{pdf\_draftmode}$ \1\&{then}\5
$\\{pdf\_error}(\.{"setup"},\39\.{"\\pdfdraftmode\ can\ only\ be\ changed\
before\ anything\ is\ written\ to\ the\ output"})$;\2\2\6
\&{if} $\\{fixed\_pdf\_draftmode\_set}\W\\{fixed\_pdf\_draftmode}>0$ \1\&{then}%
\6
\&{begin} \37$\\{fixed\_pdf\_draftmode\_set}\K\\{true}$;\5
$\\{pdf\_compress\_level}\K0$;\5
$\\{fixed\_pdf\_objcompresslevel}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M749. \\{substr\_of\_str} is used in \\{pdf\_ship\_out} and \\{pdf\_print%
\_info}.
\Y\P\4\&{function}\1\  \37$\\{substr\_of\_str}(\|s,\39\|t:\\{str\_number})$: %
\37\\{boolean};\6
\4\&{label} \37$\\{continue},\39\\{exit}$;\6
\4\&{var} \37$\|j,\39\|k,\39\\{kk}$: \37\\{pool\_pointer};\C{running indices}\2%
\6
\&{begin} \37$\|k\K\\{str\_start}[\|t]$;\6
\&{while} $(\|k<\\{str\_start}[\|t+1]-\\{length}(\|s))$ \1\&{do}\6
\&{begin} \37$\|j\K\\{str\_start}[\|s]$;\5
$\\{kk}\K\|k$;\6
\&{while} $(\|j<\\{str\_start}[\|s+1])$ \1\&{do}\6
\&{begin} \37\&{if} $\\{str\_pool}[\|j]\I\\{str\_pool}[\\{kk}]$ \1\&{then}\5
\&{goto} \37\\{continue};\2\6
$\\{incr}(\|j)$;\5
$\\{incr}(\\{kk})$;\6
\&{end};\2\6
$\\{substr\_of\_str}\K\\{true}$;\5
\&{return};\6
\4\\{continue}: \37$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{substr\_of\_str}\K\\{false}$;\6
\&{end};\par
\fi

\M750. \\{pdf\_ship\_out} is used instead of \\{ship\_out} to shipout a box to
PDF
output. If \\{shipping\_page} is not set then the output will be a Form object,
otherwise it will be a Page object.

\Y\P\4\&{procedure}\1\  \37$\\{pdf\_ship\_out}(\|p:\\{pointer};\,\35\\{shipping%
\_page}:\\{boolean})$;\C{output the box \|p}\6
\4\&{label} \37$\\{done},\39\\{done1}$;\6
\4\&{var} \37$\|i,\39\|j,\39\|k$: \37\\{integer};\C{general purpose
accumulators}\6
\|s: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\6
\\{mediabox\_given}: \37\\{boolean};\5
\\{save\_font\_list}: \37\\{pointer};\C{to save \\{pdf\_font\_list} during
flushing pending forms}\6
\\{save\_obj\_list}: \37\\{pointer};\C{to save \\{pdf\_obj\_list}}\6
\\{save\_ximage\_list}: \37\\{pointer};\C{to save \\{pdf\_ximage\_list}}\6
\\{save\_xform\_list}: \37\\{pointer};\C{to save \\{pdf\_xform\_list}}\6
\\{save\_image\_procset}: \37\\{integer};\C{to save \\{pdf\_image\_procset}}\6
\\{save\_text\_procset}: \37\\{integer};\C{to save \\{pdf\_text\_procset}}\6
\\{pdf\_last\_resources}: \37\\{integer};\C{pointer to most recently generated
Resources object}\2\6
\&{begin} \37\&{if} $\\{tracing\_output}>0$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{""})$;\5
\\{print\_ln};\5
$\\{print}(\.{"Completed\ box\ being\ shipped\ out"})$;\6
\&{end};\2\6
\&{if} $\R\\{init\_pdf\_output}$ \1\&{then}\6
\&{begin} \37\X792:Initialize variables for \.{PDF} output\X;\6
$\\{init\_pdf\_output}\K\\{true}$;\6
\&{end};\2\6
$\\{is\_shipping\_page}\K\\{shipping\_page}$;\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{term\_offset}>\\{max\_print\_line}-9$ \1\&{then}\5
\\{print\_ln}\6
\4\&{else} \&{if} $(\\{term\_offset}>0)\V(\\{file\_offset}>0)$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\2\6
$\\{print\_char}(\.{"["})$;\5
$\|j\K9$;\6
\&{while} $(\\{count}(\|j)=0)\W(\|j>0)$ \1\&{do}\5
$\\{decr}(\|j)$;\2\6
\&{for} $\|k\K0\mathrel{\&{to}}\|j$ \1\&{do}\6
\&{begin} \37$\\{print\_int}(\\{count}(\|k))$;\6
\&{if} $\|k<\|j$ \1\&{then}\5
$\\{print\_char}(\.{"."})$;\2\6
\&{end};\2\6
\\{update\_terminal};\6
\&{end};\2\6
\&{if} $\\{tracing\_output}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{shipping\_page}$ \1\&{then}\5
$\\{print\_char}(\.{"]"})$;\2\6
\\{begin\_diagnostic};\5
$\\{show\_box}(\|p)$;\5
$\\{end\_diagnostic}(\\{true})$;\6
\&{end};\2\6
\X751:(\pdfTeX) Ship box \|p out\X;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1730:Check for LR anomalies at the end of \\{ship\_out}\X;\2\6
\&{if} $(\\{tracing\_output}\L0)\W\\{shipping\_page}$ \1\&{then}\5
$\\{print\_char}(\.{"]"})$;\2\6
$\\{dead\_cycles}\K0$;\5
\\{update\_terminal};\C{progress report}\6
\X667:Flush the box from memory, showing statistics if requested\X;\6
\&{end};\par
\fi

\M751. \P$\X751:(\pdfTeX) Ship box \|p out\X\S$\6
\X669:Update the values of \\{max\_h} and \\{max\_v}; but if the page is too
large, \&{goto} \\{done}\X;\6
\X752:Initialize variables as \\{pdf\_ship\_out} begins\X;\6
\&{if} $\\{type}(\|p)=\\{vlist\_node}$ \1\&{then}\5
\\{pdf\_vlist\_out}\ \&{else} \\{pdf\_hlist\_out};\2\6
\&{if} $\\{shipping\_page}$ \1\&{then}\5
$\\{incr}(\\{total\_pages})$;\2\6
$\\{cur\_s}\K-1$;\5
\X759:Finish shipping\X;\6
\4\\{done}: \37\par
\U750.\fi

\M752. \P$\X752:Initialize variables as \\{pdf\_ship\_out} begins\X\S$\6
\\{fix\_pdfoutput};\5
$\\{temp\_ptr}\K\|p$;\5
\\{prepare\_mag};\5
$\\{pdf\_last\_resources}\K\\{pdf\_new\_objnum}$;\5
$\\{pdf\_page\_group\_val}\K0$;\5
\X753:Reset resource lists\X;\6
\&{if} $\R\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_xform\_width}\K\\{width}(\|p)$;\5
$\\{pdf\_xform\_height}\K\\{height}(\|p)$;\5
$\\{pdf\_xform\_depth}\K\\{depth}(\|p)$;\5
$\\{pdf\_begin\_dict}(\\{pdf\_cur\_form},\390)$;\5
$\\{pdf\_last\_stream}\K\\{pdf\_cur\_form}$;\5
$\\{cur\_v}\K\\{height}(\|p)$;\5
$\\{cur\_h}\K0$;\5
$\\{pdf\_origin\_h}\K0$;\5
$\\{pdf\_origin\_v}\K\\{pdf\_xform\_height}+\\{pdf\_xform\_depth}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\X755:Calculate page dimensions and margins\X;\6
$\\{pdf\_last\_page}\K\\{get\_obj}(\\{obj\_type\_page},\39\\{total\_pages}+1,%
\390)$;\5
$\\{obj\_aux}(\\{pdf\_last\_page})\K1$;\C{mark that this page has been created}%
\6
$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\390)$;\5
$\\{pdf\_last\_stream}\K\\{obj\_ptr}$;\5
$\\{cur\_h}\K\\{cur\_h\_offset}$;\5
$\\{cur\_v}\K\\{height}(\|p)+\\{cur\_v\_offset}$;\5
$\\{pdf\_origin\_h}\K0$;\5
$\\{pdf\_origin\_v}\K\\{cur\_page\_height}$;\5
\X754:Reset PDF mark lists\X;\6
\&{end};\2\6
\&{if} $\R\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\X756:Write out Form stream header\X;\6
\&{end};\2\6
\X757:Start stream of page/form contents\X\par
\U751.\fi

\M753. \P$\X753:Reset resource lists\X\S$\6
$\\{pdf\_font\_list}\K\\{null}$;\5
$\\{pdf\_obj\_list}\K\\{null}$;\5
$\\{pdf\_xform\_list}\K\\{null}$;\5
$\\{pdf\_ximage\_list}\K\\{null}$;\5
$\\{pdf\_text\_procset}\K\\{false}$;\5
$\\{pdf\_image\_procset}\K0$\par
\Us752\ET775.\fi

\M754. \P$\X754:Reset PDF mark lists\X\S$\6
$\\{pdf\_annot\_list}\K\\{null}$;\5
$\\{pdf\_link\_list}\K\\{null}$;\5
$\\{pdf\_dest\_list}\K\\{null}$;\5
$\\{pdf\_bead\_list}\K\\{null}$;\5
$\\{last\_thread}\K\\{null}$\par
\U752.\fi

\M755. \P$\X755:Calculate page dimensions and margins\X\S$\6
$\\{cur\_h\_offset}\K\\{pdf\_h\_origin}+\\{h\_offset}$;\5
$\\{cur\_v\_offset}\K\\{pdf\_v\_origin}+\\{v\_offset}$;\6
\&{if} $\\{pdf\_page\_width}\I0$ \1\&{then}\5
$\\{cur\_page\_width}\K\\{pdf\_page\_width}$\6
\4\&{else} $\\{cur\_page\_width}\K\\{width}(\|p)+2\ast\\{cur\_h\_offset}$;\2\6
\&{if} $\\{pdf\_page\_height}\I0$ \1\&{then}\5
$\\{cur\_page\_height}\K\\{pdf\_page\_height}$\6
\4\&{else} $\\{cur\_page\_height}\K\\{height}(\|p)+\\{depth}(\|p)+2\ast\\{cur%
\_v\_offset}$\2\par
\U752.\fi

\M756. Here we write out the header for Form.

\Y\P$\4\X756:Write out Form stream header\X\S$\6
$\\{pdf\_print\_ln}(\.{"/Type\ /XObject"})$;\5
$\\{pdf\_print\_ln}(\.{"/Subtype\ /Form"})$;\6
\&{if} $\\{obj\_xform\_attr}(\\{pdf\_cur\_form})\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{obj\_xform\_attr}(\\{pdf\_cur%
\_form}))$;\5
$\\{delete\_toks}(\\{obj\_xform\_attr}(\\{pdf\_cur\_form}))$;\6
\&{end};\2\6
$\\{pdf\_print}(\.{"/BBox\ ["})$;\5
$\\{pdf\_print}(\.{"0\ 0\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_xform\_width})$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_xform\_height}+\\{pdf\_xform\_depth})$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
$\\{pdf\_print\_ln}(\.{"/FormType\ 1"})$;\5
$\\{pdf\_print\_ln}(\.{"/Matrix\ [1\ 0\ 0\ 1\ 0\ 0]"})$;\5
$\\{pdf\_indirect\_ln}(\.{"Resources"},\39\\{pdf\_last\_resources})$\par
\U752.\fi

\M757. \P$\X757:Start stream of page/form contents\X\S$\6
\\{pdf\_begin\_stream};\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\X758:Adjust transformation matrix for the magnification ratio\X;\6
\&{end};\2\6
$\\{pdfshipoutbegin}(\\{shipping\_page})$;\6
\&{if} $\\{shipping\_page}$ \1\&{then}\5
\\{pdf\_out\_colorstack\_startpage};\2\par
\U752.\fi

\M758. \P$\X758:Adjust transformation matrix for the magnification ratio\X\S$\6
\\{prepare\_mag};\6
\&{if} $\\{mag}\I1000$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_real}(\\{mag},\393)$;\5
$\\{pdf\_print}(\.{"\ 0\ 0\ "})$;\5
$\\{pdf\_print\_real}(\\{mag},\393)$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ 0\ cm"})$;\6
\&{end}\2\par
\U757.\fi

\M759. \P$\X759:Finish shipping\X\S$\6
\X760:Finish stream of page/form contents\X;\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\X769:Write out page object\X;\6
\&{end};\2\6
\X761:Write out resource lists\X;\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\X780:Write out pending PDF marks\X;\6
\&{end};\2\6
\X762:Write out resources dictionary\X;\6
\X764:Flush resource lists\X;\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\X765:Flush PDF mark lists\X;\6
\&{end}\2\par
\U751.\fi

\M760. \P$\X760:Finish stream of page/form contents\X\S$\6
\\{pdf\_end\_text};\5
$\\{pdfshipoutend}(\\{shipping\_page})$;\5
\\{pdf\_end\_stream}\par
\U759.\fi

\M761. We need to write forms last, since the recursive call to \\{ship\_out}
would reset global state such as \\{pdfpagegroupval}, which is needed
while writing images.

\Y\P$\4\X761:Write out resource lists\X\S$\6
\X773:Write out pending raw objects\X;\6
\X779:Write out pending images\X;\6
\X775:Write out pending forms\X\par
\U759.\fi

\M762. \P$\X762:Write out resources dictionary\X\S$\6
$\\{pdf\_begin\_dict}(\\{pdf\_last\_resources},\391)$;\5
\X763:Print additional resources\X;\6
\X766:Generate font resources\X;\6
\X767:Generate XObject resources\X;\6
\X768:Generate ProcSet if desired\X;\6
\\{pdf\_end\_dict}\par
\U759.\fi

\M763. \P$\X763:Print additional resources\X\S$\6
\&{if} $\\{shipping\_page}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_page\_resources}\I\\{null}$ \1\&{then}\5
$\\{pdf\_print\_toks\_ln}(\\{pdf\_page\_resources})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{obj\_xform\_resources}(\\{pdf\_cur\_form})\I%
\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{obj\_xform\_resources}(\\{pdf\_cur%
\_form}))$;\5
$\\{delete\_toks}(\\{obj\_xform\_resources}(\\{pdf\_cur\_form}))$;\6
\&{end};\2\6
\&{end}\2\par
\U762.\fi

\M764. In the end of shipping out a page we reset all the lists holding objects
have been created during the page shipping.

\Y\P\D \37$\\{delete\_toks}(\#)\S$\1\6
\&{begin} \37$\\{delete\_token\_ref}(\#)$;\5
$\#\K\\{null}$;\6
\&{end}\2\par
\Y\P$\4\X764:Flush resource lists\X\S$\6
$\\{flush\_list}(\\{pdf\_font\_list})$;\5
$\\{flush\_list}(\\{pdf\_obj\_list})$;\5
$\\{flush\_list}(\\{pdf\_xform\_list})$;\5
$\\{flush\_list}(\\{pdf\_ximage\_list})$\par
\U759.\fi

\M765. \P$\X765:Flush PDF mark lists\X\S$\6
$\\{flush\_list}(\\{pdf\_annot\_list})$;\5
$\\{flush\_list}(\\{pdf\_link\_list})$;\5
$\\{flush\_list}(\\{pdf\_dest\_list})$;\5
$\\{flush\_list}(\\{pdf\_bead\_list})$\par
\U759.\fi

\M766. \P$\X766:Generate font resources\X\S$\6
\&{if} $\\{pdf\_font\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/Font\ <<\ "})$;\5
$\|k\K\\{pdf\_font\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print}(\.{"/F"})$;\5
$\\{set\_ff}(\\{info}(\|k))$;\5
$\\{pdf\_print\_int}(\\{ff})$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\\{pdf\_font\_num}[\\{ff}])$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{">>"})$;\5
$\\{pdf\_text\_procset}\K\\{true}$;\6
\&{end}\2\par
\U762.\fi

\M767. \P$\X767:Generate XObject resources\X\S$\6
\&{if} $(\\{pdf\_xform\_list}\I\\{null})\V(\\{pdf\_ximage\_list}\I\\{null})$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/XObject\ <<\ "})$;\5
$\|k\K\\{pdf\_xform\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print}(\.{"/Fm"})$;\5
$\\{pdf\_print\_int}(\\{obj\_info}(\\{info}(\|k)))$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\\{info}(\|k))$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\|k\K\\{pdf\_ximage\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print}(\.{"/Im"})$;\5
$\\{pdf\_print\_int}(\\{obj\_info}(\\{info}(\|k)))$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\\{info}(\|k))$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\\{update\_image\_procset}(\\{obj\_ximage\_data}(\\{info}(\|k)))$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{">>"})$;\6
\&{end}\2\par
\U762.\fi

\M768. \P$\X768:Generate ProcSet if desired\X\S$\6
\&{if} $(\\{pdf\_omit\_procset}<0)\V((\\{pdf\_omit\_procset}=0)\W(\\{pdf\_major%
\_version}<2))$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/ProcSet\ [\ /PDF"})$;\6
\&{if} $\\{pdf\_text\_procset}$ \1\&{then}\5
$\\{pdf\_print}(\.{"\ /Text"})$;\2\6
\&{if} $\\{check\_image\_b}(\\{pdf\_image\_procset})$ \1\&{then}\5
$\\{pdf\_print}(\.{"\ /ImageB"})$;\2\6
\&{if} $\\{check\_image\_c}(\\{pdf\_image\_procset})$ \1\&{then}\5
$\\{pdf\_print}(\.{"\ /ImageC"})$;\2\6
\&{if} $\\{check\_image\_i}(\\{pdf\_image\_procset})$ \1\&{then}\5
$\\{pdf\_print}(\.{"\ /ImageI"})$;\2\6
$\\{pdf\_print\_ln}(\.{"\ ]"})$\6
\&{end}\2\par
\U762.\fi

\M769. \P$\X769:Write out page object\X\S$\6
$\\{pdf\_begin\_dict}(\\{pdf\_last\_page},\391)$;\5
$\\{pdf\_print\_ln}(\.{"/Type\ /Page"})$;\5
$\\{pdf\_indirect\_ln}(\.{"Contents"},\39\\{pdf\_last\_stream})$;\5
$\\{pdf\_indirect\_ln}(\.{"Resources"},\39\\{pdf\_last\_resources})$;\5
$\\{mediabox\_given}\K\\{false}$;\6
\&{if} $\\{pdf\_page\_attr}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\\{pdf\_page\_attr})$;\5
$\\{mediabox\_given}\K\\{substr\_of\_str}(\.{"/MediaBox"},\39\|s)$;\5
$\\{flush\_str}(\|s)$;\6
\&{end};\2\6
\&{if} $\R\\{mediabox\_given}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/MediaBox\ [0\ 0\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{cur\_page\_width})$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{cur\_page\_height})$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_page\_attr}\I\\{null}$ \1\&{then}\5
$\\{pdf\_print\_toks\_ln}(\\{pdf\_page\_attr})$;\2\6
\X770:Generate parent pages object\X;\6
\&{if} $\\{pdf\_page\_group\_val}>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/Group\ "})$;\5
$\\{pdf\_print\_int}(\\{pdf\_page\_group\_val})$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ R"})$;\6
\&{end};\2\6
\X771:Generate array of annotations or beads in page\X;\6
\\{pdf\_end\_dict}\par
\U759.\fi

\M770. \P$\X770:Generate parent pages object\X\S$\6
\&{if} $\\{total\_pages}\mathbin{\&{mod}}\\{pages\_tree\_kids\_max}=1$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_create\_obj}(\\{obj\_type\_pages},\39\\{pages\_tree\_kids%
\_max})$;\5
$\\{pdf\_last\_pages}\K\\{obj\_ptr}$;\6
\&{end};\2\6
$\\{pdf\_indirect\_ln}(\.{"Parent"},\39\\{pdf\_last\_pages})$\par
\U769.\fi

\M771. \P$\X771:Generate array of annotations or beads in page\X\S$\6
\&{if} $(\\{pdf\_annot\_list}\I\\{null})\V(\\{pdf\_link\_list}\I\\{null})$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/Annots\ [\ "})$;\5
$\|k\K\\{pdf\_annot\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print\_int}(\\{info}(\|k))$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\|k\K\\{pdf\_link\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print\_int}(\\{info}(\|k))$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_bead\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_bead\_list}$;\5
$\\{pdf\_print}(\.{"/B\ [\ "})$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print\_int}(\\{info}(\|k))$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{end}\2\par
\U769.\fi

\M772. \P$\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{pdf\_write\_obj}(\|n:\\{integer})$;\C{write a raw
PDF object}\6
\4\&{var} \37\|s: \37\\{str\_number};\5
\|f: \37\\{byte\_file};\2\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\\{obj\_obj\_data}(\|n))$;\5
$\\{delete\_toks}(\\{obj\_obj\_data}(\|n))$;\6
\&{if} $\\{obj\_obj\_is\_stream}(\|n)>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_begin\_dict}(\|n,\390)$;\6
\&{if} $\\{obj\_obj\_stream\_attr}(\|n)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{obj\_obj\_stream\_attr}(\|n))$;\5
$\\{delete\_toks}(\\{obj\_obj\_stream\_attr}(\|n))$;\6
\&{end};\2\6
\\{pdf\_begin\_stream};\6
\&{end}\6
\4\&{else} $\\{pdf\_begin\_obj}(\|n,\391)$;\2\6
\&{if} $\\{obj\_obj\_is\_file}(\|n)>0$ \1\&{then}\6
\&{begin} \37$\\{cur\_name}\K\|s$;\5
$\\{cur\_area}\K\.{""}$;\5
$\\{cur\_ext}\K\.{""}$;\5
\\{pack\_cur\_name};\6
\&{if} $\R\\{tex\_b\_openin}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"!\ "})$;\5
$\\{print}(\|s)$;\5
$\\{print}(\.{"\ not\ found."})$;\5
$\\{pdf\_error}(\.{"ext5"},\39\.{"cannot\ open\ file\ for\ embedding"})$;\6
\&{end};\2\6
$\\{print}(\.{"<<"})$;\5
$\\{print}(\|s)$;\6
\&{if} $\R\\{eof}(\|f)$ \1\&{then}\6
\&{begin} \37\C{at least one byte available}\6
\&{while} $\R\\{eof}(\|f)$ \1\&{do}\5
$\\{pdf\_out}(\\{getc}(\|f))$;\2\6
\&{if} $(\R\\{obj\_obj\_is\_stream}(\|n))\W(\\{pdf\_ptr}>0)\W(\\{pdf\_buf}[%
\\{pdf\_ptr}-1]\I10)$ \1\&{then}\5
$\\{pdf\_out}(10)$;\2\6
\&{end};\2\6
$\\{print}(\.{">>"})$;\5
$\\{b\_close}(\|f)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{obj\_obj\_is\_stream}(\|n)>0$ \1\&{then}\5
$\\{pdf\_print}(\|s)$\6
\4\&{else} $\\{pdf\_print\_ln}(\|s)$;\2\2\6
\&{if} $\\{obj\_obj\_is\_stream}(\|n)>0$ \1\&{then}\5
\\{pdf\_end\_stream}\6
\4\&{else} \\{pdf\_end\_obj};\2\6
$\\{flush\_str}(\|s)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{flush\_whatsit\_node}(\|p:\\{pointer};\,\35\|s:%
\\{small\_number})$;\2\6
\&{begin} \37$\\{type}(\|p)\K\\{whatsit\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\6
\&{if} $\\{link}(\|p)\I\\{null}$ \1\&{then}\5
$\\{pdf\_error}(\.{"flush\_whatsit\_node"},\39\.{"link(p)\ is\ not\ null"})$;\2%
\6
$\\{flush\_node\_list}(\|p)$;\6
\&{end};\par
\fi

\M773. \P$\X773:Write out pending raw objects\X\S$\6
\&{if} $\\{pdf\_obj\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_obj\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_obj\_written}(\\{info}(\|k))$ \1\&{then}\5
$\\{pdf\_write\_obj}(\\{info}(\|k))$;\2\6
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U761.\fi

\M774. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{saved\_pdf\_cur\_form}: \37\\{integer};\par
\fi

\M775. When flushing pending forms we need to save and restore resource lists
(\\{pdf\_font\_list}, \\{pdf\_obj\_list}, \\{pdf\_xform\_list} and \\{pdf%
\_ximage\_list}),
which are also used by page shipping.

\Y\P$\4\X775:Write out pending forms\X\S$\6
\&{if} $\\{pdf\_xform\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_xform\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_obj\_written}(\\{info}(\|k))$ \1\&{then}\6
\&{begin} \37$\\{saved\_pdf\_cur\_form}\K\\{pdf\_cur\_form}$;\5
$\\{pdf\_cur\_form}\K\\{info}(\|k)$;\5
\X776:Save resource lists\X;\6
\X753:Reset resource lists\X;\6
$\\{pdf\_ship\_out}(\\{obj\_xform\_box}(\\{pdf\_cur\_form}),\39\\{false})$;\5
$\\{pdf\_cur\_form}\K\\{saved\_pdf\_cur\_form}$;\5
\X777:Restore resource lists\X;\6
\&{end};\2\6
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U761.\fi

\M776. \P$\X776:Save resource lists\X\S$\6
$\\{save\_font\_list}\K\\{pdf\_font\_list}$;\5
$\\{save\_obj\_list}\K\\{pdf\_obj\_list}$;\5
$\\{save\_xform\_list}\K\\{pdf\_xform\_list}$;\5
$\\{save\_ximage\_list}\K\\{pdf\_ximage\_list}$;\5
$\\{save\_text\_procset}\K\\{pdf\_text\_procset}$;\5
$\\{save\_image\_procset}\K\\{pdf\_image\_procset}$\par
\U775.\fi

\M777. \P$\X777:Restore resource lists\X\S$\6
$\\{pdf\_font\_list}\K\\{save\_font\_list}$;\5
$\\{pdf\_obj\_list}\K\\{save\_obj\_list}$;\5
$\\{pdf\_xform\_list}\K\\{save\_xform\_list}$;\5
$\\{pdf\_ximage\_list}\K\\{save\_ximage\_list}$;\5
$\\{pdf\_text\_procset}\K\\{save\_text\_procset}$;\5
$\\{pdf\_image\_procset}\K\\{save\_image\_procset}$\par
\U775.\fi

\M778. \P$\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{pdf\_write\_image}(\|n:\\{integer})$;\C{write an
image}\2\6
\&{begin} \37$\\{pdf\_begin\_dict}(\|n,\390)$;\6
\&{if} $\\{obj\_ximage\_attr}(\|n)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{obj\_ximage\_attr}(\|n))$;\5
$\\{delete\_toks}(\\{obj\_ximage\_attr}(\|n))$;\6
\&{end};\2\6
\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\5
$\\{write\_image}(\\{obj\_ximage\_data}(\|n))$;\2\6
$\\{delete\_image}(\\{obj\_ximage\_data}(\|n))$;\6
\&{end};\par
\fi

\M779. \P$\X779:Write out pending images\X\S$\6
\&{if} $\\{pdf\_ximage\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_ximage\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_obj\_written}(\\{info}(\|k))$ \1\&{then}\5
$\\{pdf\_write\_image}(\\{info}(\|k))$;\2\6
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U761.\fi

\M780. \P$\X780:Write out pending PDF marks\X\S$\6
$\\{pdf\_origin\_h}\K0$;\5
$\\{pdf\_origin\_v}\K\\{cur\_page\_height}$;\5
\X781:Write out PDF annotations\X;\6
\X782:Write out PDF link annotations\X;\6
\X784:Write out PDF mark destinations\X;\6
\X786:Write out PDF bead rectangle specifications\X\par
\U759.\fi

\M781. \P$\X781:Write out PDF annotations\X\S$\6
\&{if} $\\{pdf\_annot\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_annot\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|i\K\\{obj\_annot\_ptr}(\\{info}(\|k))$;\C{\|i points to \\{pdf%
\_annot\_node}}\6
$\\{pdf\_begin\_dict}(\\{info}(\|k),\391)$;\5
$\\{pdf\_print\_ln}(\.{"/Type\ /Annot"})$;\5
$\\{pdf\_print\_toks\_ln}(\\{pdf\_annot\_data}(\|i))$;\5
$\\{pdf\_rectangle}(\\{pdf\_left}(\|i),\39\\{pdf\_top}(\|i),\39\\{pdf\_right}(%
\|i),\39\\{pdf\_bottom}(\|i))$;\5
\\{pdf\_end\_dict};\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U780.\fi

\M782. \P$\X782:Write out PDF link annotations\X\S$\6
\&{if} $\\{pdf\_link\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_link\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|i\K\\{obj\_annot\_ptr}(\\{info}(\|k))$;\5
$\\{pdf\_begin\_dict}(\\{info}(\|k),\391)$;\5
$\\{pdf\_print\_ln}(\.{"/Type\ /Annot"})$;\6
\&{if} $\\{pdf\_action\_type}(\\{pdf\_link\_action}(\|i))\I\\{pdf\_action%
\_user}$ \1\&{then}\5
$\\{pdf\_print\_ln}(\.{"/Subtype\ /Link"})$;\2\6
\&{if} $\\{pdf\_link\_attr}(\|i)\I\\{null}$ \1\&{then}\5
$\\{pdf\_print\_toks\_ln}(\\{pdf\_link\_attr}(\|i))$;\2\6
$\\{pdf\_rectangle}(\\{pdf\_left}(\|i),\39\\{pdf\_top}(\|i),\39\\{pdf\_right}(%
\|i),\39\\{pdf\_bottom}(\|i))$;\6
\&{if} $\\{pdf\_action\_type}(\\{pdf\_link\_action}(\|i))\I\\{pdf\_action%
\_user}$ \1\&{then}\5
$\\{pdf\_print}(\.{"/A\ "})$;\2\6
$\\{write\_action}(\\{pdf\_link\_action}(\|i))$;\5
\\{pdf\_end\_dict};\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\X783:Flush \\{pdf\_start\_link\_node}'s created by \\{append\_link}\X;\6
\&{end}\2\par
\U780.\fi

\M783. \P$\X783:Flush \\{pdf\_start\_link\_node}'s created by \\{append\_link}%
\X\S$\6
$\|k\K\\{pdf\_link\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|i\K\\{obj\_annot\_ptr}(\\{info}(\|k))$;\C{nodes with $\\{info}=%
\\{max\_halfword}$ were created by \\{append\_link} and      must be flushed
here, as they are not linked in any list}\6
\&{if} $\\{info}(\|i)=\\{max\_halfword}$ \1\&{then}\5
$\\{flush\_whatsit\_node}(\|i,\39\\{pdf\_start\_link\_node})$;\2\6
$\|k\K\\{link}(\|k)$;\6
\&{end}\2\par
\U782.\fi

\M784. \P$\X784:Write out PDF mark destinations\X\S$\6
\&{if} $\\{pdf\_dest\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_dest\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_obj\_written}(\\{info}(\|k))$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext5"},\39\.{"destination\ has\ been\ already\ written\
(this\ shouldn\'t\ happen)"})$\6
\4\&{else} \&{begin} \37$\|i\K\\{obj\_dest\_ptr}(\\{info}(\|k))$;\6
\&{if} $(\\{pdf\_dest\_named\_id}(\|i)>0)\W(\\{pdf\_dest\_objnum}(\|i)=%
\\{null})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_begin\_dict}(\\{info}(\|k),\391)$;\5
$\\{pdf\_print}(\.{"/D\ "})$;\6
\&{end}\6
\4\&{else} $\\{pdf\_begin\_obj}(\\{info}(\|k),\391)$;\2\6
$\\{pdf\_out}(\.{"["})$;\6
\&{if} $\\{pdf\_dest\_objnum}(\|i)=\\{null}$ \1\&{then}\5
$\\{pdf\_print\_int}(\\{pdf\_last\_page})$\6
\4\&{else} $\\{pdf\_print\_int}(\\{pdf\_dest\_objnum}(\|i))$;\2\6
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\6
\&{case} $\\{pdf\_dest\_type}(\|i)$ \1\&{of}\6
\4\\{pdf\_dest\_xyz}: \37\&{begin} \37$\\{pdf\_print}(\.{"/XYZ\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{pdf\_left}(\|i)))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{pdf\_top}(\|i)))$;\5
$\\{pdf\_out}(\.{"\ "})$;\6
\&{if} $\\{pdf\_dest\_xyz\_zoom}(\|i)=\\{null}$ \1\&{then}\5
$\\{pdf\_print}(\.{"null"})$\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_int}(\\{pdf\_dest\_xyz\_zoom}(\|i)%
\mathbin{\&{div}}1000)$;\5
$\\{pdf\_out}(\.{"."})$;\5
$\\{pdf\_print\_int}((\\{pdf\_dest\_xyz\_zoom}(\|i)\mathbin{\&{mod}}1000))$;\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_dest\_fit}: \37$\\{pdf\_print}(\.{"/Fit"})$;\6
\4\\{pdf\_dest\_fith}: \37\&{begin} \37$\\{pdf\_print}(\.{"/FitH\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{pdf\_top}(\|i)))$;\6
\&{end};\6
\4\\{pdf\_dest\_fitv}: \37\&{begin} \37$\\{pdf\_print}(\.{"/FitV\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{pdf\_left}(\|i)))$;\6
\&{end};\6
\4\\{pdf\_dest\_fitb}: \37$\\{pdf\_print}(\.{"/FitB"})$;\6
\4\\{pdf\_dest\_fitbh}: \37\&{begin} \37$\\{pdf\_print}(\.{"/FitBH\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{pdf\_top}(\|i)))$;\6
\&{end};\6
\4\\{pdf\_dest\_fitbv}: \37\&{begin} \37$\\{pdf\_print}(\.{"/FitBV\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{pdf\_left}(\|i)))$;\6
\&{end};\6
\4\\{pdf\_dest\_fitr}: \37\&{begin} \37$\\{pdf\_print}(\.{"/FitR\ "})$;\5
$\\{pdf\_print\_rect\_spec}(\|i)$;\6
\&{end};\6
\4\&{othercases} \37$\\{pdf\_error}(\.{"ext5"},\39\.{"unknown\ dest\ type"})$;%
\2\6
\&{endcases};\5
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{if} $(\\{pdf\_dest\_named\_id}(\|i)>0)\W(\\{pdf\_dest\_objnum}(\|i)=%
\\{null})$ \1\&{then}\5
\\{pdf\_end\_dict}\6
\4\&{else} \\{pdf\_end\_obj};\2\6
\&{end};\2\6
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U780.\fi

\M785. \P$\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{pdf\_print\_rect\_spec}(\|r:\\{pointer})$;\C{prints
a rect spec}\2\6
\&{begin} \37$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{pdf\_left}(\|r)))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{pdf\_bottom}(\|r)))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_x}(\\{pdf\_right}(\|r)))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_mag\_bp}(\\{pdf\_y}(\\{pdf\_top}(\|r)))$;\6
\&{end};\par
\fi

\M786. \P$\X786:Write out PDF bead rectangle specifications\X\S$\6
\&{if} $\\{pdf\_bead\_list}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{pdf\_bead\_list}$;\6
\&{while} $\|k\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{pdf\_new\_obj}(\\{obj\_type\_others},\390,\391)$;\5
$\\{pdf\_out}(\.{"["})$;\5
$\|i\K\\{obj\_bead\_data}(\\{info}(\|k))$;\C{pointer to a whatsit or
whatsit-like node}\6
$\\{pdf\_print\_rect\_spec}(\|i)$;\6
\&{if} $\\{info}(\|i)=\\{max\_halfword}$ \1\&{then}\C{not a whatsit node, so
must be destroyed here}\6
$\\{flush\_whatsit\_node}(\|i,\39\\{pdf\_start\_thread\_node})$;\2\6
$\\{pdf\_print\_ln}(\.{"]"})$;\5
$\\{obj\_bead\_rect}(\\{info}(\|k))\K\\{obj\_ptr}$;\C{rewrite \\{obj\_bead%
\_data}}\6
\\{pdf\_end\_obj};\5
$\|k\K\\{link}(\|k)$;\6
\&{end};\2\6
\&{end}\2\par
\U780.\fi

\M787. In the end we must flush PDF objects that cannot be written out
immediately after shipping out pages.

\fi

\M788. \P$\X788:Output outlines\X\S$\6
\&{if} $\\{pdf\_first\_outline}\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\391)$;\5
$\\{outlines}\K\\{obj\_ptr}$;\5
$\|l\K\\{pdf\_first\_outline}$;\5
$\|k\K0$;\6
\1\&{repeat} \37$\\{incr}(\|k)$;\5
$\|a\K\\{open\_subentries}(\|l)$;\6
\&{if} $\\{obj\_outline\_count}(\|l)>0$ \1\&{then}\5
$\|k\K\|k+\|a$;\2\6
$\\{obj\_outline\_parent}(\|l)\K\\{obj\_ptr}$;\5
$\|l\K\\{obj\_outline\_next}(\|l)$;\6
\4\&{until}\5
$\|l=0$;\2\6
$\\{pdf\_print\_ln}(\.{"/Type\ /Outlines"})$;\5
$\\{pdf\_indirect\_ln}(\.{"First"},\39\\{pdf\_first\_outline})$;\5
$\\{pdf\_indirect\_ln}(\.{"Last"},\39\\{pdf\_last\_outline})$;\5
$\\{pdf\_int\_entry\_ln}(\.{"Count"},\39\|k)$;\5
\\{pdf\_end\_dict};\5
\X789:Output PDF outline entries\X;\6
\&{end}\6
\4\&{else} $\\{outlines}\K0$\2\par
\U794.\fi

\M789. \P$\X789:Output PDF outline entries\X\S$\6
$\|k\K\\{head\_tab}[\\{obj\_type\_outline}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{obj\_outline\_parent}(\|k)=\\{pdf\_parent\_outline}$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{obj\_outline\_prev}(\|k)=0$ \1\&{then}\5
$\\{pdf\_first\_outline}\K\|k$;\2\6
\&{if} $\\{obj\_outline\_next}(\|k)=0$ \1\&{then}\5
$\\{pdf\_last\_outline}\K\|k$;\2\6
\&{end};\2\6
$\\{pdf\_begin\_dict}(\|k,\391)$;\5
$\\{pdf\_indirect\_ln}(\.{"Title"},\39\\{obj\_outline\_title}(\|k))$;\5
$\\{pdf\_indirect\_ln}(\.{"A"},\39\\{obj\_outline\_action\_objnum}(\|k))$;\6
\&{if} $\\{obj\_outline\_parent}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Parent"},\39\\{obj\_outline\_parent}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_prev}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Prev"},\39\\{obj\_outline\_prev}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_next}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Next"},\39\\{obj\_outline\_next}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_first}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"First"},\39\\{obj\_outline\_first}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_last}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Last"},\39\\{obj\_outline\_last}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_count}(\|k)\I0$ \1\&{then}\5
$\\{pdf\_int\_entry\_ln}(\.{"Count"},\39\\{obj\_outline\_count}(\|k))$;\2\6
\&{if} $\\{obj\_outline\_attr}(\|k)\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{obj\_outline\_attr}(\|k))$;\5
$\\{delete\_toks}(\\{obj\_outline\_attr}(\|k))$;\6
\&{end};\2\6
\\{pdf\_end\_dict};\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end}\2\par
\U788.\fi

\M790. \P$\X790:Output article threads\X\S$\6
\&{if} $\\{head\_tab}[\\{obj\_type\_thread}]\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_new\_obj}(\\{obj\_type\_others},\390,\391)$;\5
$\\{threads}\K\\{obj\_ptr}$;\5
$\\{pdf\_out}(\.{"["})$;\5
$\|k\K\\{head\_tab}[\\{obj\_type\_thread}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37$\\{pdf\_print\_int}(\|k)$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end};\2\6
\\{remove\_last\_space};\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
\\{pdf\_end\_obj};\5
$\|k\K\\{head\_tab}[\\{obj\_type\_thread}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37$\\{out\_thread}(\|k)$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\\{threads}\K0$\2\par
\U794.\fi

\M791. Now we are ready to declare our new procedure \\{ship\_out}.  It will
call
\\{pdf\_ship\_out} if the integer parameter \\{pdf\_output} is positive;
otherwise it
will call \\{dvi\_ship\_out}, which is the \TeX\ original \\{ship\_out}.

\Y\P\4\&{procedure}\1\  \37$\\{ship\_out}(\|p:\\{pointer})$;\C{output the box %
\|p}\2\6
\&{begin} \37\\{fix\_pdfoutput};\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_ship\_out}(\|p,\39\\{true})$\6
\4\&{else} $\\{dvi\_ship\_out}(\|p)$;\2\6
\&{end};\par
\fi

\M792. \P$\X792:Initialize variables for \.{PDF} output\X\S$\6
\\{check\_pdfversion};\5
\\{prepare\_mag};\5
$\\{fixed\_decimal\_digits}\K\\{fix\_int}(\\{pdf\_decimal\_digits},\390,\394)$;%
\5
$\\{min\_bp\_val}\K\\{divide\_scaled}(\\{one\_hundred\_bp},\39\\{ten\_pow}[%
\\{fixed\_decimal\_digits}+2],\390)$;\6
\&{if} $\\{pdf\_pk\_resolution}=0$ \1\&{then}\C{if not set from format file or
by user}\6
$\\{pdf\_pk\_resolution}\K\\{pk\_dpi}$;\C{take it from \.{texmf.cnf}}\2\6
$\\{fixed\_pk\_resolution}\K\\{fix\_int}(\\{pdf\_pk\_resolution},\3972,%
\398000)$;\5
$\\{pk\_scale\_factor}\K\\{divide\_scaled}(72,\39\\{fixed\_pk\_resolution},%
\395+\\{fixed\_decimal\_digits})$;\6
\&{if} $\\{pdf\_pk\_mode}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{kpse\_init\_prog}(\.{\'PDFTEX\'},\39\\{fixed\_pk\_resolution},%
\39\\{make\_cstring}(\\{tokens\_to\_string}(\\{pdf\_pk\_mode})),\39\&{nil})$;\5
\\{flush\_string};\6
\&{end}\6
\4\&{else} $\\{kpse\_init\_prog}(\.{\'PDFTEX\'},\39\\{fixed\_pk\_resolution},%
\39\&{nil},\39\&{nil})$;\2\6
$\\{kpse\_set\_program\_enabled}(\\{kpse\_pk\_format},\391,\39\\{kpse\_src%
\_compile})$;\5
$\\{set\_job\_id}(\\{year},\39\\{month},\39\\{day},\39\\{time})$;\6
\&{if} $(\\{pdf\_unique\_resname}>0)\W(\\{pdf\_resname\_prefix}=0)$ \1\&{then}\5
$\\{pdf\_resname\_prefix}\K\\{get\_resname\_prefix}$\2\par
\U750.\fi

\M793. Finishing the PDF output file.

The following procedures sort the table of destination names.
\Y\P\D \37$\\{get\_next\_char}(\#)\S\|c\J\#\K\\{str\_pool}[\|j\J\#]$;\5
$\\{incr}(\|j\J\#)$;\6
\&{if} $(\|c\J\#=92)\W(\|j\J\#<\|e\J\#)$ \1\&{then}\6
\&{begin} \37$\|c\J\#\K\\{str\_pool}[\|j\J\#]$;\5
$\\{incr}(\|j\J\#)$;\6
\&{if} $(\|c\J\#\G48)\W(\|c\J\#\L55)$ \1\&{then}\6
\&{begin} \37$\|c\J\#\K\|c\J\#-48$;\6
\&{if} $(\|j\J\#<\|e\J\#)\W(\\{str\_pool}[\|j\J\#]\G48)\W(\\{str\_pool}[\|j\J%
\#]\L55)$ \1\&{then}\6
\&{begin} \37$\|c\J\#\K8\ast\|c\J\#+\\{str\_pool}[\|j\J\#]-48$;\5
$\\{incr}(\|j\J\#)$;\6
\&{if} $(\|j\J\#<\|e\J\#)\W(\\{str\_pool}[\|j\J\#]\G48)\W(\\{str\_pool}[\|j\J%
\#]\L55)\W(\|c\J\#<32)$ \1\&{then}\6
\&{begin} \37$\|c\J\#\K8\ast\|c\J\#+\\{str\_pool}[\|j\J\#]-48$;\5
$\\{incr}(\|j\J\#)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{case} $\|c\J\#$ \1\&{of}\6
\498: \37$\|c\J\#\K8$;\C{`\.b': backspace}\6
\4102: \37$\|c\J\#\K12$;\C{`\.f': form feed}\6
\4110: \37$\|c\J\#\K10$;\C{`\.n': line feed}\6
\4114: \37$\|c\J\#\K13$;\C{`\.r': carriage return}\6
\4116: \37$\|c\J\#\K9$;\C{`\.t': horizontal tab}\6
\C{nothing to do for `\.{\\}', `\.(', `\.)'}\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\&{end};\2\6
\&{end}\2\par
\Y\P\4\&{function}\1\  \37$\\{str\_less\_str}(\\{s1},\39\\{s2}:\\{str%
\_number})$: \37\\{boolean};\C{compare two pdf strings}\6
\4\&{var} \37$\\{j1},\39\\{j2},\39\\{e1},\39\\{e2}$: \37\\{pool\_pointer};\5
$\\{c1},\39\\{c2}$: \37\\{packed\_ASCII\_code};\2\6
\&{begin} \37\C{Minimal requirement: output of \.{\\pdfescapestring} must be
supported.}\6
\C{This implementation also supports all escape sequences}\6
\C{listed in the table `Escape sequences in literal strings'}\6
\C{of the pdf specification.}\6
\C{End-of-line markers are not detected:}\6
\C{The marker is not replaced by `\.{\\n}' or removed if it is escaped.}\6
$\\{j1}\K\\{str\_start}[\\{s1}]$;\5
$\\{j2}\K\\{str\_start}[\\{s2}]$;\5
$\\{e1}\K\\{j1}+\\{length}(\\{s1})$;\5
$\\{e2}\K\\{j2}+\\{length}(\\{s2})$;\6
\&{while} $(\\{j1}<\\{e1})\W(\\{j2}<\\{e2})$ \1\&{do}\6
\&{begin} \37\C{get next character of first string}\6
$\\{get\_next\_char}(1)$;\C{get next character of second string}\6
$\\{get\_next\_char}(2)$;\C{compare characters}\6
\&{if} $\\{c1}<\\{c2}$ \1\&{then}\6
\&{begin} \37$\\{str\_less\_str}\K\\{true}$;\5
\&{return};\6
\&{end}\6
\4\&{else} \&{if} $\\{c1}>\\{c2}$ \1\&{then}\6
\&{begin} \37$\\{str\_less\_str}\K\\{false}$;\5
\&{return};\6
\&{end};\2\2\6
\&{end};\C{compare string lengths}\2\6
\&{if} $(\\{j1}\G\\{e1})\W(\\{j2}<\\{e2})$ \1\&{then}\5
$\\{str\_less\_str}\K\\{true}$\6
\4\&{else} $\\{str\_less\_str}\K\\{false}$;\2\6
\4\\{exit}: \37\&{end};\6
\4\&{procedure}\1\  \37$\\{sort\_dest\_names}(\|l,\39\|r:\\{integer})$;\C{sorts
\\{dest\_names} by names}\6
\4\&{var} \37$\|i,\39\|j$: \37\\{integer};\5
\|s: \37\\{str\_number};\5
\|e: \37\\{dest\_name\_entry};\2\6
\&{begin} \37$\|i\K\|l$;\5
$\|j\K\|r$;\5
$\|s\K\\{dest\_names}[(\|l+\|r)\mathbin{\&{div}}2].\\{objname}$;\6
\1\&{repeat} \37\&{while} $\\{str\_less\_str}(\\{dest\_names}[\|i].\\{objname},%
\39\|s)$ \1\&{do}\5
$\\{incr}(\|i)$;\2\6
\&{while} $\\{str\_less\_str}(\|s,\39\\{dest\_names}[\|j].\\{objname})$ \1%
\&{do}\5
$\\{decr}(\|j)$;\2\6
\&{if} $\|i\L\|j$ \1\&{then}\6
\&{begin} \37$\|e\K\\{dest\_names}[\|i]$;\5
$\\{dest\_names}[\|i]\K\\{dest\_names}[\|j]$;\5
$\\{dest\_names}[\|j]\K\|e$;\5
$\\{incr}(\|i)$;\5
$\\{decr}(\|j)$;\6
\&{end};\2\6
\4\&{until}\5
$\|i>\|j$;\2\6
\&{if} $\|l<\|j$ \1\&{then}\5
$\\{sort\_dest\_names}(\|l,\39\|j)$;\2\6
\&{if} $\|i<\|r$ \1\&{then}\5
$\\{sort\_dest\_names}(\|i,\39\|r)$;\2\6
\&{end};\par
\fi

\M794.  Now the finish of PDF output file. At this moment all Page objects
are already written completely to PDF output file.

\Y\P$\4\X794:Finish the PDF file\X\S$\6
\&{if} $\\{total\_pages}=0$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"No\ pages\ of\ output."})$;\6
\&{if} $\\{pdf\_gone}>0$ \1\&{then}\5
\\{garbage\_warning};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\6
\&{begin} \37\\{pdf\_flush};\C{to make sure that the output file name has been
already         created}\6
\&{if} $\\{total\_pages}\mathbin{\&{mod}}\\{pages\_tree\_kids\_max}\I0$ \1%
\&{then}\5
$\\{obj\_info}(\\{pdf\_last\_pages})\K\\{total\_pages}\mathbin{\&{mod}}\\{pages%
\_tree\_kids\_max}$;\C{last pages object may have less than \\{pages\_tree%
\_kids\_max} children}\2\6
\\{flush\_jbig2\_page0\_objects};\C{flush page 0 objects from JBIG2 images, if
any}\6
\X799:Check for non-existing pages\X;\6
\X800:Reverse the linked list of Page and Pages objects\X;\6
\X796:Check for non-existing destinations\X;\6
\X798:Check for non-existing structure destinations\X;\6
\X801:Output fonts definition\X;\6
\X802:Output pages tree\X;\6
\X788:Output outlines\X;\6
\X804:Output name tree\X;\6
\X790:Output article threads\X;\6
\X806:Output the catalog object\X;\6
\&{if} $\\{pdf\_omit\_info\_dict}=0$ \1\&{then}\5
\\{pdf\_print\_info};\C{last candidate for object stream}\2\6
\&{if} $\\{pdf\_os\_enable}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_os\_switch}(\\{true})$;\5
\\{pdf\_os\_write\_objstream};\5
\\{pdf\_flush};\5
$\\{pdf\_os\_switch}(\\{false})$;\5
\X814:Output the cross-reference stream dictionary\X;\6
\\{pdf\_flush};\6
\&{end}\6
\4\&{else} \&{begin} \37\X813:Output the \\{obj\_tab}\X;\6
\&{end};\2\6
\X815:Output the trailer\X;\6
\\{pdf\_flush};\5
$\\{print\_nl}(\.{"Output\ written\ on\ "})$;\5
$\\{print\_file\_name}(0,\39\\{output\_file\_name},\390)$;\5
$\\{print}(\.{"\ ("})$;\5
$\\{print\_int}(\\{total\_pages})$;\5
$\\{print}(\.{"\ page"})$;\6
\&{if} $\\{total\_pages}\I1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
$\\{print}(\.{",\ "})$;\5
$\\{print\_int}(\\{pdf\_offset})$;\5
$\\{print}(\.{"\ bytes)."})$;\6
\&{end};\2\6
\\{libpdffinish};\6
\&{if} $\\{fixed\_pdf\_draftmode}=0$ \1\&{then}\5
$\\{b\_close}(\\{pdf\_file})$\6
\4\&{else} $\\{pdf\_warning}(0,\39\.{"\\pdfdraftmode\ enabled,\ not\ changing\
output\ pdf"},\39\\{true},\39\\{true})$\2\6
\&{end}\2\par
\U1513.\fi

\M795. Destinations that have been referenced but don't exists have
$\\{obj\_dest\_ptr}=\\{null}$. Leaving them undefined might cause troubles for
PDF browsers, so we need to fix them.

\Y\P\4\&{procedure}\1\  \37$\\{pdf\_fix\_dest}(\|k:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{obj\_dest\_ptr}(\|k)\I\\{null}$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_warning}(\.{"dest"},\39\.{""},\39\\{true},\39\\{false})$;\6
\&{if} $\\{obj\_info}(\|k)<0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"name\{"})$;\5
$\\{print}(-\\{obj\_info}(\|k))$;\5
$\\{print}(\.{"\}"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"num"})$;\5
$\\{print\_int}(\\{obj\_info}(\|k))$;\6
\&{end};\2\6
$\\{print}(\.{"\ has\ been\ referenced\ but\ does\ not\ exist,\ replaced\ by\ a%
\ fixed\ one"})$;\5
\\{print\_ln};\5
\\{print\_ln};\5
$\\{pdf\_begin\_obj}(\|k,\391)$;\5
$\\{pdf\_out}(\.{"["})$;\5
$\\{pdf\_print\_int}(\\{head\_tab}[\\{obj\_type\_page}])$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ R\ /Fit]"})$;\5
\\{pdf\_end\_obj};\6
\&{end};\par
\fi

\M796. \P$\X796:Check for non-existing destinations\X\S$\6
$\|k\K\\{head\_tab}[\\{obj\_type\_dest}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37$\\{pdf\_fix\_dest}(\|k)$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end}\2\par
\U794.\fi

\M797. The same for structure destinations, except that there is no sensible
default
object to point to.

\Y\P\4\&{procedure}\1\  \37$\\{pdf\_fix\_struct\_dest}(\|k:\\{integer})$;\2\6
\&{begin} \37\&{if} $\\{obj\_dest\_ptr}(\|k)\I\\{null}$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_warning}(\.{"structure\ dest"},\39\.{""},\39\\{false},\39\\{false})$;\6
\&{if} $\\{obj\_info}(\|k)<0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"name\{"})$;\5
$\\{print}(-\\{obj\_info}(\|k))$;\5
$\\{print}(\.{"\}"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"num"})$;\5
$\\{print\_int}(\\{obj\_info}(\|k))$;\6
\&{end};\2\6
$\\{print}(\.{"\ has\ been\ referenced\ but\ does\ not\ exist"})$;\5
\\{print\_ln};\5
\\{print\_ln};\5
$\B\\{pdf\_begin\_obj}(\|k,\391)$;\5
$\\{pdf\_out}(\.{"["})$;\5
$\\{pdf\_print\_int}(\\{head\_tab}[\\{obj\_type\_page}])$;\5
$\\{pdf\_print\_ln}(\.{"\ 0\ R\ /Fit]"})$;\5
\\{pdf\_end\_obj};\5
$\T$\6
\&{end};\par
\fi

\M798. \P$\X798:Check for non-existing structure destinations\X\S$\6
$\|k\K\\{head\_tab}[\\{obj\_type\_struct\_dest}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37$\\{pdf\_fix\_struct\_dest}(\|k)$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end}\2\par
\U794.\fi

\M799. \P$\X799:Check for non-existing pages\X\S$\6
$\|k\K\\{head\_tab}[\\{obj\_type\_page}]$;\6
\&{while} $\\{obj\_aux}(\|k)=0$ \1\&{do}\6
\&{begin} \37$\\{pdf\_warning}(\.{"dest"},\39\.{"Page\ "},\39\\{true},\39%
\\{false})$;\5
$\\{print\_int}(\\{obj\_info}(\|k))$;\5
$\\{print}(\.{"\ has\ been\ referenced\ but\ does\ not\ exist!"})$;\5
\\{print\_ln};\5
\\{print\_ln};\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end};\2\6
$\\{head\_tab}[\\{obj\_type\_page}]\K\|k$\par
\U794.\fi

\M800. \P$\X800:Reverse the linked list of Page and Pages objects\X\S$\6
$\|k\K\\{head\_tab}[\\{obj\_type\_page}]$;\5
$\|l\K0$;\6
\1\&{repeat} \37$\|i\K\\{obj\_link}(\|k)$;\5
$\\{obj\_link}(\|k)\K\|l$;\5
$\|l\K\|k$;\5
$\|k\K\|i$;\6
\4\&{until}\5
$\|k=0$;\2\6
$\\{head\_tab}[\\{obj\_type\_page}]\K\|l$;\5
$\|k\K\\{head\_tab}[\\{obj\_type\_pages}]$;\5
$\\{pages\_tail}\K\|k$;\5
$\|l\K0$;\6
\1\&{repeat} \37$\|i\K\\{obj\_link}(\|k)$;\5
$\\{obj\_link}(\|k)\K\|l$;\5
$\|l\K\|k$;\5
$\|k\K\|i$;\6
\4\&{until}\5
$\|k=0$;\2\6
$\\{head\_tab}[\\{obj\_type\_pages}]\K\|l$\par
\U794.\fi

\M801. \P$\X801:Output fonts definition\X\S$\6
\&{for} $\|k\K\\{font\_base}+1\mathrel{\&{to}}\\{font\_ptr}$ \1\&{do}\6
\&{if} $\\{font\_used}[\|k]\W\\{hasfmentry}(\|k)\W(\\{pdf\_font\_num}[\|k]<0)$ %
\1\&{then}\6
\&{begin} \37$\|i\K-\\{pdf\_font\_num}[\|k]$;\5
$\\{pdfassert}(\\{pdf\_font\_num}[\|i]>0)$;\6
\&{for} $\|j\K0\mathrel{\&{to}}255$ \1\&{do}\6
\&{if} $\\{pdf\_char\_marked}(\|k,\39\|j)$ \1\&{then}\5
$\\{pdf\_mark\_char}(\|i,\39\|j)$;\2\2\6
\&{if} $(\\{length}(\\{pdf\_font\_attr}[\|i])=0)\W(\\{length}(\\{pdf\_font%
\_attr}[\|k])\I0)$ \1\&{then}\5
$\\{pdf\_font\_attr}[\|i]\K\\{pdf\_font\_attr}[\|k]$\6
\4\&{else} \&{if} $(\\{length}(\\{pdf\_font\_attr}[\|k])=0)\W(\\{length}(\\{pdf%
\_font\_attr}[\|i])\I0)$ \1\&{then}\5
$\\{pdf\_font\_attr}[\|k]\K\\{pdf\_font\_attr}[\|i]$\6
\4\&{else} \&{if} $(\\{length}(\\{pdf\_font\_attr}[\|i])\I0)\W(\\{length}(%
\\{pdf\_font\_attr}[\|k])\I0)\W\R\\{str\_eq\_str}(\\{pdf\_font\_attr}[\|i],\39%
\\{pdf\_font\_attr}[\|k])$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"\\pdffontattr"},\39\.{"fonts\ "},\39%
\\{true},\39\\{false})$;\5
$\\{print\_font\_identifier}(\|i)$;\5
$\\{print}(\.{"\ and\ "})$;\5
$\\{print\_font\_identifier}(\|k)$;\5
$\\{print}(\.{"\ have\ conflicting\ attributes;\ I\ will\ ignore\ the\
attributes\ assigned\ to\ "})$;\5
$\\{print\_font\_identifier}(\|i)$;\5
\\{print\_ln};\5
\\{print\_ln};\6
\&{end};\2\2\2\6
\&{end};\2\2\6
$\\{fixed\_gen\_tounicode}\K\\{pdf\_gen\_tounicode}$;\5
$\|k\K\\{head\_tab}[\\{obj\_type\_font}]$;\6
\&{while} $\|k\I0$ \1\&{do}\6
\&{begin} \37$\|f\K\\{obj\_info}(\|k)$;\5
$\\{pdfassert}(\\{pdf\_font\_num}[\|f]>0)$;\5
$\\{do\_pdf\_font}(\|k,\39\|f)$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\&{end};\2\6
\\{write\_fontstuff}\par
\U794.\fi

\M802. We will generate in each single step the parents of all Pages/Page
objects in
the previous level. These new generated Pages object will create a new level of
the Pages tree. We will repeat this until we have only one Pages object. This
one will be the Root object.

\Y\P$\4\X802:Output pages tree\X\S$\6
$\|a\K\\{sys\_obj\_ptr}+1$;\C{all Pages objects whose children are not Page
objects                        should have index greater than \|a}\6
$\|l\K\\{head\_tab}[\\{obj\_type\_pages}]$;\C{\|l is the index of current Pages
object                                 which is being output}\6
$\|k\K\\{head\_tab}[\\{obj\_type\_page}]$;\C{\|k is the index of current child
of \|l}\6
$\|b\K0$;\6
\1\&{repeat} \37$\|i\K0$;\C{counter of Pages object in current level}\6
$\|c\K0$;\C{first Pages object in previous level}\6
\&{if} $\\{obj\_link}(\|l)=0$ \1\&{then}\5
$\\{is\_root}\K\\{true}$\C{only Pages object; total pages is
      not greater than \\{pages\_tree\_kids\_max}}\6
\4\&{else} $\\{is\_root}\K\\{false}$;\2\6
\1\&{repeat} \37\&{if} $\R\\{is\_root}$ \1\&{then}\6
\&{begin} \37\&{if} $\|i\mathbin{\&{mod}}\\{pages\_tree\_kids\_max}=0$ \1%
\&{then}\6
\&{begin} \37\C{create a new Pages object
                   for next level}\6
$\\{pdf\_last\_pages}\K\\{pdf\_new\_objnum}$;\6
\&{if} $\|c=0$ \1\&{then}\5
$\|c\K\\{pdf\_last\_pages}$;\2\6
$\\{obj\_link}(\\{pages\_tail})\K\\{pdf\_last\_pages}$;\5
$\\{pages\_tail}\K\\{pdf\_last\_pages}$;\5
$\\{obj\_link}(\\{pdf\_last\_pages})\K0$;\5
$\\{obj\_info}(\\{pdf\_last\_pages})\K\\{obj\_info}(\|l)$;\6
\&{end}\6
\4\&{else} $\\{obj\_info}(\\{pdf\_last\_pages})\K\\{obj\_info}(\\{pdf\_last%
\_pages})+\\{obj\_info}(\|l)$;\2\6
\&{end};\2\6
\X803:Output the current Pages object in this level\X;\6
$\\{incr}(\|i)$;\5
$\|l\K\\{obj\_link}(\|l)$;\6
\4\&{until}\5
$(\|l=\|c)$;\2\6
$\|b\K\|c$;\6
\&{if} $\|l=0$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\4\&{until}\5
\\{false};\2\6
\4\\{done}: \37\par
\U794.\fi

\M803. \P$\X803:Output the current Pages object in this level\X\S$\6
$\\{pdf\_begin\_dict}(\|l,\391)$;\5
$\\{pdf\_print\_ln}(\.{"/Type\ /Pages"})$;\5
$\\{pdf\_int\_entry\_ln}(\.{"Count"},\39\\{obj\_info}(\|l))$;\6
\&{if} $\R\\{is\_root}$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Parent"},\39\\{pdf\_last\_pages})$;\2\6
$\\{pdf\_print}(\.{"/Kids\ ["})$;\5
$\|j\K0$;\6
\1\&{repeat} \37$\\{pdf\_print\_int}(\|k)$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\|k\K\\{obj\_link}(\|k)$;\5
$\\{incr}(\|j)$;\6
\4\&{until}\5
$((\|l<\|a)\W(\|j=\\{obj\_info}(\|l)))\V(\|k=0)\V((\|k=\|b)\W(\|b\I0))\V(\|j=%
\\{pages\_tree\_kids\_max})$;\2\6
\\{remove\_last\_space};\5
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{if} $\|k=0$ \1\&{then}\6
\&{begin} \37$\|k\K\\{head\_tab}[\\{obj\_type\_pages}]$;\5
$\\{head\_tab}[\\{obj\_type\_pages}]\K0$;\6
\&{end};\2\6
\&{if} $\\{is\_root}\W(\\{pdf\_pages\_attr}\I\\{null})$ \1\&{then}\5
$\\{pdf\_print\_toks\_ln}(\\{pdf\_pages\_attr})$;\2\6
\\{pdf\_end\_dict};\par
\U802.\fi

\M804. The name tree is very similar to Pages tree so its construction should
be
certain from Pages tree construction. For intermediate node \\{obj\_info} will
be
the first name and \\{obj\_link} will be the last name in \.{\\Limits} array.
Note that \\{pdf\_dest\_names\_ptr} will be less than \\{obj\_ptr}, so we test
if
$\|k<\\{pdf\_dest\_names\_ptr}$ then \|k is index of leaf in \\{dest\_names};
else
\|k will be index in \\{obj\_tab} of some intermediate node.

\Y\P$\4\X804:Output name tree\X\S$\6
\&{if} $\\{pdf\_dest\_names\_ptr}=0$ \1\&{then}\6
\&{begin} \37$\\{dests}\K0$;\5
\&{goto} \37\\{done1};\6
\&{end};\2\6
$\\{sort\_dest\_names}(0,\39\\{pdf\_dest\_names\_ptr}-1)$;\5
$\\{names\_head}\K0$;\5
$\\{names\_tail}\K0$;\5
$\|k\K0$;\C{index of current child of \|l; if $\|k<\\{pdf\_dest\_names\_ptr}$
       then this is pointer to \\{dest\_names} array;          otherwise it is
the pointer to \\{obj\_tab} (object number)}\6
$\\{is\_names}\K\\{true}$;\C{flag whether Names or Kids}\6
$\|b\K0$;\6
\1\&{repeat} \37\1\&{repeat} \37$\\{pdf\_create\_obj}(\\{obj\_type\_others},%
\390)$;\C{create a new node}\6
$\|l\K\\{obj\_ptr}$;\6
\&{if} $\|b=0$ \1\&{then}\5
$\|b\K\|l$;\C{first in this level}\2\6
\&{if} $\\{names\_head}=0$ \1\&{then}\6
\&{begin} \37$\\{names\_head}\K\|l$;\5
$\\{names\_tail}\K\|l$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{obj\_link}(\\{names\_tail})\K\|l$;\5
$\\{names\_tail}\K\|l$;\6
\&{end};\2\6
$\\{obj\_link}(\\{names\_tail})\K0$;\5
\X805:Output the current node in this level\X;\6
\4\&{until}\5
$\|b=0$;\2\6
\&{if} $\|k=\|l$ \1\&{then}\6
\&{begin} \37$\\{dests}\K\|l$;\5
\&{goto} \37\\{done1};\6
\&{end};\2\6
\4\&{until}\5
\\{false};\2\6
\4\\{done1}: \37\&{if} $(\\{dests}\I0)\V(\\{pdf\_names\_toks}\I\\{null})$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\391)$;\6
\&{if} $(\\{dests}\I0)$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Dests"},\39\\{dests})$;\2\6
\&{if} $\\{pdf\_names\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{pdf\_names\_toks})$;\5
$\\{delete\_toks}(\\{pdf\_names\_toks})$;\6
\&{end};\2\6
\\{pdf\_end\_dict};\5
$\\{names\_tree}\K\\{obj\_ptr}$;\6
\&{end}\6
\4\&{else} $\\{names\_tree}\K0$\2\par
\U794.\fi

\M805. \P$\X805:Output the current node in this level\X\S$\6
$\\{pdf\_begin\_dict}(\|l,\391)$;\5
$\|j\K0$;\6
\&{if} $\\{is\_names}$ \1\&{then}\6
\&{begin} \37$\\{obj\_info}(\|l)\K\\{dest\_names}[\|k].\\{objname}$;\5
$\\{pdf\_print}(\.{"/Names\ ["})$;\6
\1\&{repeat} \37$\\{pdf\_print\_str}(\\{dest\_names}[\|k].\\{objname})$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_int}(\\{dest\_names}[\|k].\\{objnum})$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\\{incr}(\|j)$;\5
$\\{incr}(\|k)$;\6
\4\&{until}\5
$(\|j=\\{name\_tree\_kids\_max})\V(\|k=\\{pdf\_dest\_names\_ptr})$;\2\6
\\{remove\_last\_space};\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
$\\{obj\_aux}(\|l)\K\\{dest\_names}[\|k-1].\\{objname}$;\6
\&{if} $\|k=\\{pdf\_dest\_names\_ptr}$ \1\&{then}\6
\&{begin} \37$\\{is\_names}\K\\{false}$;\5
$\|k\K\\{names\_head}$;\5
$\|b\K0$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{obj\_info}(\|l)\K\\{obj\_info}(\|k)$;\5
$\\{pdf\_print}(\.{"/Kids\ ["})$;\6
\1\&{repeat} \37$\\{pdf\_print\_int}(\|k)$;\5
$\\{pdf\_print}(\.{"\ 0\ R\ "})$;\5
$\\{incr}(\|j)$;\5
$\\{obj\_aux}(\|l)\K\\{obj\_aux}(\|k)$;\5
$\|k\K\\{obj\_link}(\|k)$;\6
\4\&{until}\5
$(\|j=\\{name\_tree\_kids\_max})\V(\|k=\|b)\V(\\{obj\_link}(\|k)=0)$;\2\6
\\{remove\_last\_space};\5
$\\{pdf\_print\_ln}(\.{"]"})$;\6
\&{if} $\|k=\|b$ \1\&{then}\5
$\|b\K0$;\2\6
\&{end};\2\6
$\\{pdf\_print}(\.{"/Limits\ ["})$;\5
$\\{pdf\_print\_str}(\\{obj\_info}(\|l))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_str}(\\{obj\_aux}(\|l))$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
\\{pdf\_end\_dict};\par
\U804.\fi

\M806. \P$\X806:Output the catalog object\X\S$\6
$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\391)$;\5
$\\{root}\K\\{obj\_ptr}$;\5
$\\{pdf\_print\_ln}(\.{"/Type\ /Catalog"})$;\5
$\\{pdf\_indirect\_ln}(\.{"Pages"},\39\\{pdf\_last\_pages})$;\6
\&{if} $\\{threads}\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Threads"},\39\\{threads})$;\2\6
\&{if} $\\{outlines}\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Outlines"},\39\\{outlines})$;\2\6
\&{if} $\\{names\_tree}\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Names"},\39\\{names\_tree})$;\2\6
\&{if} $\\{pdf\_catalog\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{pdf\_catalog\_toks})$;\5
$\\{delete\_toks}(\\{pdf\_catalog\_toks})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_catalog\_openaction}\I0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"OpenAction"},\39\\{pdf\_catalog\_openaction})$;\2\6
\\{pdf\_end\_dict}\par
\U794.\fi

\M807. If the same keys in a dictionary are given several times, then it is not
defined which value is chosen by an application.  Therefore the keys
$/\\{Producer}$ and $/\\{Creator}$ are only set if the token list
\\{pdf\_info\_toks} converted to a string does not contain these key strings.

\Y\P\4\&{procedure}\1\  \37\\{pdf\_print\_info};\C{print info object}\6
\4\&{var} \37\|s: \37\\{str\_number};\5
$\\{creator\_given},\39\\{producer\_given},\39\\{creationdate\_given},\39%
\\{moddate\_given},\39\\{trapped\_given}$: \37\\{boolean};\2\6
\&{begin} \37$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\393)$;\C{keep Info
readable unless explicitly forced}\6
$\\{creator\_given}\K\\{false}$;\5
$\\{producer\_given}\K\\{false}$;\5
$\\{creationdate\_given}\K\\{false}$;\5
$\\{moddate\_given}\K\\{false}$;\5
$\\{trapped\_given}\K\\{false}$;\6
\&{if} $\\{pdf\_info\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\\{pdf\_info\_toks})$;\5
$\\{creator\_given}\K\\{substr\_of\_str}(\.{"/Creator"},\39\|s)$;\5
$\\{producer\_given}\K\\{substr\_of\_str}(\.{"/Producer"},\39\|s)$;\5
$\\{creationdate\_given}\K\\{substr\_of\_str}(\.{"/CreationDate"},\39\|s)$;\5
$\\{moddate\_given}\K\\{substr\_of\_str}(\.{"/ModDate"},\39\|s)$;\5
$\\{trapped\_given}\K\\{substr\_of\_str}(\.{"/Trapped"},\39\|s)$;\6
\&{end};\2\6
\&{if} $\R\\{producer\_given}$ \1\&{then}\6
\&{begin} \37\X808:Print the Producer key\X;\6
\&{end};\2\6
\&{if} $\\{pdf\_info\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{length}(\|s)>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\|s)$;\6
\&{end};\2\6
$\\{flush\_str}(\|s)$;\5
$\\{delete\_toks}(\\{pdf\_info\_toks})$;\6
\&{end};\2\6
\&{if} $\R\\{creator\_given}$ \1\&{then}\5
$\\{pdf\_str\_entry\_ln}(\.{"Creator"},\39\.{"TeX"})$;\2\6
\&{if} $\\{pdf\_info\_omit\_date}=0$ \1\&{then}\6
\&{begin} \37\&{if} $\R\\{creationdate\_given}$ \1\&{then}\6
\&{begin} \37\X809:Print the CreationDate key\X;\6
\&{end};\2\6
\&{if} $\R\\{moddate\_given}$ \1\&{then}\6
\&{begin} \37\X810:Print the ModDate key\X;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\R\\{trapped\_given}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{"/Trapped\ /False"})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_suppress\_ptex\_info}\mathbin{\&{mod}}2=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{get\_ptex\_use\_underscore}$ \1\&{then}\5
$\\{pdf\_str\_entry\_ln}(\.{"PTEX\_Fullbanner"},\39\\{pdftex\_banner})$\6
\4\&{else} $\\{pdf\_str\_entry\_ln}(\.{"PTEX.Fullbanner"},\39\\{pdftex%
\_banner})$;\2\6
\&{end};\2\6
\\{pdf\_end\_dict};\6
\&{end};\par
\fi

\M808. \P$\X808:Print the Producer key\X\S$\6
$\\{pdf\_print}(\.{"/Producer\ (pdfTeX-"})$;\5
$\\{pdf\_print\_int}(\\{pdftex\_version}\mathbin{\&{div}}100)$;\5
$\\{pdf\_out}(\.{"."})$;\5
$\\{pdf\_print\_int}(\\{pdftex\_version}\mathbin{\&{mod}}100)$;\5
$\\{pdf\_out}(\.{"."})$;\5
$\\{pdf\_print}(\\{pdftex\_revision})$;\5
$\\{pdf\_print\_ln}(\.{")"})$\par
\U807.\fi

\M809. \P$\X809:Print the CreationDate key\X\S$\6
\\{print\_creation\_date};\par
\U807.\fi

\M810. \P$\X810:Print the ModDate key\X\S$\6
\\{print\_mod\_date};\par
\U807.\fi

\M811. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdftex\_banner}: \37\\{str\_number};\C{the complete banner}\par
\fi

\M812. \P$\X812:Build a linked list of free objects\X\S$\6
$\|l\K0$;\5
$\\{set\_obj\_fresh}(\|l)$;\C{null object at begin of list of free objects}\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{sys\_obj\_ptr}$ \1\&{do}\6
\&{if} $\R\\{is\_obj\_written}(\|k)$ \1\&{then}\6
\&{begin} \37$\\{obj\_link}(\|l)\K\|k$;\5
$\|l\K\|k$;\6
\&{end};\2\2\6
$\\{obj\_link}(\|l)\K0$\par
\Us813\ET814.\fi

\M813. \P$\X813:Output the \\{obj\_tab}\X\S$\6
\X812:Build a linked list of free objects\X;\6
$\\{pdf\_save\_offset}\K\\{pdf\_offset}$;\5
$\\{pdf\_print\_ln}(\.{"xref"})$;\5
$\\{pdf\_print}(\.{"0\ "})$;\5
$\\{pdf\_print\_int\_ln}(\\{obj\_ptr}+1)$;\5
$\\{pdf\_print\_fw\_int}(\\{obj\_link}(0),\3910)$;\5
$\\{pdf\_print\_ln}(\.{"\ 65535\ f\ "})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{obj\_ptr}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_obj\_written}(\|k)$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_fw\_int}(\\{obj\_link}(\|k),\3910)$;\5
$\\{pdf\_print\_ln}(\.{"\ 00000\ f\ "})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_fw\_int}(\\{obj\_offset}(\|k),\3910)$;\5
$\\{pdf\_print\_ln}(\.{"\ 00000\ n\ "})$;\6
\&{end};\2\6
\&{end}\2\par
\U794.\fi

\M814. \P$\X814:Output the cross-reference stream dictionary\X\S$\6
$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\390)$;\6
\&{if} $((\\{obj\_offset}(\\{sys\_obj\_ptr})/256)>16777215)$ \1\&{then}\5
$\\{xref\_offset\_width}\K5$\6
\4\&{else} \&{if} $\\{obj\_offset}(\\{sys\_obj\_ptr})>16777215$ \1\&{then}\5
$\\{xref\_offset\_width}\K4$\6
\4\&{else} \&{if} $\\{obj\_offset}(\\{sys\_obj\_ptr})>65535$ \1\&{then}\5
$\\{xref\_offset\_width}\K3$\6
\4\&{else} $\\{xref\_offset\_width}\K2$;\2\2\2\6
\X812:Build a linked list of free objects\X;\6
$\\{pdf\_print\_ln}(\.{"/Type\ /XRef"})$;\5
$\\{pdf\_print}(\.{"/Index\ [0\ "})$;\5
$\\{pdf\_print\_int}(\\{obj\_ptr}+1)$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
$\\{pdf\_int\_entry\_ln}(\.{"Size"},\39\\{obj\_ptr}+1)$;\5
$\\{pdf\_print}(\.{"/W\ [1\ "})$;\5
$\\{pdf\_print\_int}(\\{xref\_offset\_width})$;\5
$\\{pdf\_print\_ln}(\.{"\ 1]"})$;\5
$\\{pdf\_indirect\_ln}(\.{"Root"},\39\\{root})$;\6
\&{if} $\\{pdf\_omit\_info\_dict}=0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Info"},\39\\{obj\_ptr}-1)$;\2\6
\&{if} $\\{pdf\_trailer\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{pdf\_trailer\_toks})$;\5
$\\{delete\_toks}(\\{pdf\_trailer\_toks})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_trailer\_id\_toks}\I\\{null}$ \1\&{then}\5
$\\{print\_ID\_alt}(\\{pdf\_trailer\_id\_toks})$\6
\4\&{else} $\\{print\_ID}(\\{output\_file\_name})$;\2\6
\\{pdf\_print\_nl};\5
\\{pdf\_begin\_stream};\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{sys\_obj\_ptr}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_obj\_written}(\|k)$ \1\&{then}\6
\&{begin} \37\C{a free object}\6
$\\{pdf\_out}(0)$;\5
$\\{pdf\_out\_bytes}(\\{obj\_link}(\|k),\39\\{xref\_offset\_width})$;\5
$\\{pdf\_out}(255)$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{obj\_os\_idx}(\|k)=-1$ \1\&{then}\6
\&{begin} \37\C{object not in object stream}\6
$\\{pdf\_out}(1)$;\5
$\\{pdf\_out\_bytes}(\\{obj\_offset}(\|k),\39\\{xref\_offset\_width})$;\5
$\\{pdf\_out}(0)$;\6
\&{end}\6
\4\&{else} \&{begin} \37\C{object in object stream}\6
$\\{pdf\_out}(2)$;\5
$\\{pdf\_out\_bytes}(\\{obj\_offset}(\|k),\39\\{xref\_offset\_width})$;\5
$\\{pdf\_out}(\\{obj\_os\_idx}(\|k))$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\\{pdf\_end\_stream};\par
\U794.\fi

\M815. \P$\X815:Output the trailer\X\S$\6
\&{if} $\R\\{pdf\_os\_enable}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_ln}(\.{"trailer"})$;\5
$\\{pdf\_print}(\.{"<<\ "})$;\5
$\\{pdf\_int\_entry\_ln}(\.{"Size"},\39\\{sys\_obj\_ptr}+1)$;\5
$\\{pdf\_indirect\_ln}(\.{"Root"},\39\\{root})$;\6
\&{if} $\\{pdf\_omit\_info\_dict}=0$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"Info"},\39\\{sys\_obj\_ptr})$;\2\6
\&{if} $\\{pdf\_trailer\_toks}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{pdf\_trailer\_toks})$;\5
$\\{delete\_toks}(\\{pdf\_trailer\_toks})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_trailer\_id\_toks}\I\\{null}$ \1\&{then}\5
$\\{print\_ID\_alt}(\\{pdf\_trailer\_id\_toks})$\6
\4\&{else} $\\{print\_ID}(\\{output\_file\_name})$;\2\6
$\\{pdf\_print\_ln}(\.{"\ >>"})$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{"startxref"})$;\6
\&{if} $\\{pdf\_os\_enable}$ \1\&{then}\5
$\\{pdf\_print\_int\_ln}(\\{obj\_offset}(\\{sys\_obj\_ptr}))$\6
\4\&{else} $\\{pdf\_print\_int\_ln}(\\{pdf\_save\_offset})$;\2\6
$\\{pdf\_print\_ln}(\.{"\%\%EOF"})$\par
\U794.\fi

\N816.  \[33] Packaging.
We're essentially done with the parts of \TeX\ that are concerned with
the input (\\{get\_next}) and the output (\\{ship\_out}). So it's time to
get heavily into the remaining part, which does the real work of typesetting.

After lists are constructed, \TeX\ wraps them up and puts them into boxes.
Two major subroutines are given the responsibility for this task: \\{hpack}
applies to horizontal lists (hlists) and \\{vpack} applies to vertical lists
(vlists). The main duty of \\{hpack} and \\{vpack} is to compute the dimensions
of the resulting boxes, and to adjust the glue if one of those dimensions
is pre-specified. The computed sizes normally enclose all of the material
inside the new box; but some items may stick out if negative glue is used,
if the box is overfull, or if a \.{\\vbox} includes other boxes that have
been shifted left.

The subroutine call $\\{hpack}(\|p,\|w,\|m)$ returns a pointer to an \\{hlist%
\_node}
for a box containing the hlist that starts at \|p. Parameter \|w specifies
a width; and parameter \|m is either `\\{exactly}' or `\\{additional}'.  Thus,
$\\{hpack}(\|p,\|w,\\{exactly})$ produces a box whose width is exactly \|w,
while
$\\{hpack}(\|p,\|w,\\{additional})$ yields a box whose width is the natural
width plus
\|w.  It is convenient to define a macro called `\\{natural}' to cover the
most common case, so that we can say $\\{hpack}(\|p,\\{natural})$ to get a box
that
has the natural width of list \|p.

Similarly, $\\{vpack}(\|p,\|w,\|m)$ returns a pointer to a \\{vlist\_node} for
a
box containing the vlist that starts at \|p. In this case \|w represents
a height instead of a width; the parameter \|m is interpreted as in \\{hpack}.

\Y\P\D \37$\\{exactly}=0$\C{a box dimension is pre-specified}\par
\P\D \37$\\{additional}=1$\C{a box dimension is increased from the natural one}%
\par
\P\D \37$\\{natural}\S0,\39\\{additional}$\C{shorthand for parameters to %
\\{hpack} and \\{vpack}}\par
\fi

\M817. The parameters to \\{hpack} and \\{vpack} correspond to \TeX's
primitives
like `\.{\\hbox} \.{to} \.{300pt}', `\.{\\hbox} \.{spread} \.{10pt}'; note
that `\.{\\hbox}' with no dimension following it is equivalent to
`\.{\\hbox} \.{spread} \.{0pt}'.  The \\{scan\_spec} subroutine scans such
constructions in the user's input, including the mandatory left brace that
follows them, and it puts the specification onto \\{save\_stack} so that the
desired box can later be obtained by executing the following code:
$$\vbox{\halign{#\hfil\cr
$\\{save\_ptr}\K\\{save\_ptr}-2$;\cr
$\\{hpack}(\|p,\\{saved}(1),\\{saved}(0)).$\cr}}$$
Special care is necessary to ensure that the special \\{save\_stack} codes
are placed just below the new group code, because scanning can change
\\{save\_stack} when \.{\\csname} appears.

\Y\P\4\&{procedure}\1\  \37$\\{scan\_spec}(\|c:\\{group\_code};\,\35\\{three%
\_codes}:\\{boolean})$;\C{scans a box specification and left brace}\6
\4\&{label} \37\\{found};\6
\4\&{var} \37\|s: \37\\{integer};\C{temporarily saved value}\6
\\{spec\_code}: \37$\\{exactly}\to\\{additional}$;\2\6
\&{begin} \37\&{if} $\\{three\_codes}$ \1\&{then}\5
$\|s\K\\{saved}(0)$;\2\6
\&{if} $\\{scan\_keyword}(\.{"to"})$ \1\&{then}\5
$\\{spec\_code}\K\\{exactly}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"spread"})$ \1\&{then}\5
$\\{spec\_code}\K\\{additional}$\6
\4\&{else} \&{begin} \37$\\{spec\_code}\K\\{additional}$;\5
$\\{cur\_val}\K0$;\5
\&{goto} \37\\{found};\6
\&{end};\2\2\6
\\{scan\_normal\_dimen};\6
\4\\{found}: \37\&{if} $\\{three\_codes}$ \1\&{then}\6
\&{begin} \37$\\{saved}(0)\K\|s$;\5
$\\{incr}(\\{save\_ptr})$;\6
\&{end};\2\6
$\\{saved}(0)\K\\{spec\_code}$;\5
$\\{saved}(1)\K\\{cur\_val}$;\5
$\\{save\_ptr}\K\\{save\_ptr}+2$;\5
$\\{new\_save\_level}(\|c)$;\5
\\{scan\_left\_brace};\6
\&{end};\par
\fi

\M818. To figure out the glue setting, \\{hpack} and \\{vpack} determine how
much
stretchability and shrinkability are present, considering all four orders
of infinity. The highest order of infinity that has a nonzero coefficient
is then used as if no other orders were present.

For example, suppose that the given list contains six glue nodes with
the respective stretchabilities 3pt, 8fill, 5fil, 6pt, $-3$fil, $-8$fill.
Then the total is essentially 2fil; and if a total additional space of 6pt
is to be achieved by stretching, the actual amounts of stretch will be
0pt, 0pt, 15pt, 0pt, $-9$pt, and 0pt, since only `fil' glue will be
considered. (The `fill' glue is therefore not really stretching infinitely
with respect to `fil'; nobody would actually want that to happen.)

The arrays \\{total\_stretch} and \\{total\_shrink} are used to determine how
much
glue of each kind is present. A global variable \\{last\_badness} is used
to implement \.{\\badness}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4$\\{total\_stretch},\39\\{total\_shrink}$: \37\&{array} $[\\{glue\_ord}]$ \1%
\&{of}\5
\\{scaled};\C{glue found by \\{hpack} or \\{vpack}}\2\6
\4\\{last\_badness}: \37\\{integer};\C{badness of the most recently packaged
box}\par
\fi

\M819. If the global variable \\{adjust\_tail} is non-null, the \\{hpack}
routine
also removes all occurrences of \\{ins\_node}, \\{mark\_node}, and \\{adjust%
\_node}
items and appends the resulting material onto the list that ends at
location \\{adjust\_tail}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{adjust\_tail}: \37\\{pointer};\C{tail of adjustment list}\par
\fi

\M820. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{adjust\_tail}\K\\{null}$;\5
$\\{last\_badness}\K0$;\par
\fi

\M821. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_font\_blink}: \37$\^\\{internal\_font\_number}$;\C{link to base font
(used for expanded fonts only)}\6
\4\\{pdf\_font\_elink}: \37$\^\\{internal\_font\_number}$;\C{link to expanded
fonts (used for base fonts only)}\6
\4\\{pdf\_font\_has\_space\_char}: \37$\^\\{boolean}$;\C{has font a real space
char?}\6
\4\\{pdf\_font\_stretch}: \37$\^\\{integer}$;\C{link to font expanded by
stretch limi}\6
\4\\{pdf\_font\_shrink}: \37$\^\\{integer}$;\C{link to font expanded by shrink
limit}\6
\4\\{pdf\_font\_step}: \37$\^\\{integer}$;\C{amount of one step of expansion}\6
\4\\{pdf\_font\_expand\_ratio}: \37$\^\\{integer}$;\C{expansion ratio of a
particular font}\6
\4\\{pdf\_font\_auto\_expand}: \37$\^\\{boolean}$;\C{this font is
auto-expanded?}\6
\4\\{pdf\_font\_lp\_base}: \37$\^\\{integer}$;\C{base of left-protruding
factor}\6
\4\\{pdf\_font\_rp\_base}: \37$\^\\{integer}$;\C{base of right-protruding
factor}\6
\4\\{pdf\_font\_ef\_base}: \37$\^\\{integer}$;\C{base of font expansion factor}%
\6
\4\\{pdf\_font\_kn\_bs\_base}: \37$\^\\{integer}$;\C{base of kern before space}%
\6
\4\\{pdf\_font\_st\_bs\_base}: \37$\^\\{integer}$;\C{base of stretch before
space}\6
\4\\{pdf\_font\_sh\_bs\_base}: \37$\^\\{integer}$;\C{base of shrink before
space}\6
\4\\{pdf\_font\_kn\_bc\_base}: \37$\^\\{integer}$;\C{base of kern before
character}\6
\4\\{pdf\_font\_kn\_ac\_base}: \37$\^\\{integer}$;\C{base of kern after
character}\6
\4\\{font\_expand\_ratio}: \37\\{integer};\C{current expansion ratio}\6
\4\\{last\_leftmost\_char}: \37\\{pointer};\6
\4\\{last\_rightmost\_char}: \37\\{pointer};\6
\4\\{hlist\_stack}: \37\&{array} $[0\to\\{max\_hlist\_stack}]$ \1\&{of}\5
\\{pointer};\C{stack for $\\{find\_protchar\_left}(\,)$ and $\\{find\_protchar%
\_right}(\,)$}\2\6
\4\\{hlist\_stack\_level}: \37$0\to\\{max\_hlist\_stack}$;\C{fill level for %
\\{hlist\_stack}}\par
\fi

\M822. \P\D \37$\\{cal\_margin\_kern\_var}(\#)\S$\1\6
\&{begin} \37$\\{character}(\\{cp})\K\\{character}(\#)$;\5
$\\{font}(\\{cp})\K\\{font}(\#)$;\5
$\\{do\_subst\_font}(\\{cp},\391000)$;\6
\&{if} $\\{font}(\\{cp})\I\\{font}(\#)$ \1\&{then}\5
$\\{margin\_kern\_stretch}\K\\{margin\_kern\_stretch}+\\{left\_pw}(\#)-\\{left%
\_pw}(\\{cp})$;\2\6
$\\{font}(\\{cp})\K\\{font}(\#)$;\5
$\\{do\_subst\_font}(\\{cp},\39-1000)$;\6
\&{if} $\\{font}(\\{cp})\I\\{font}(\#)$ \1\&{then}\5
$\\{margin\_kern\_shrink}\K\\{margin\_kern\_shrink}+\\{left\_pw}(\\{cp})-%
\\{left\_pw}(\#)$;\2\6
\&{end}\2\par
\Y\P$\4\X822:Calculate variations of marginal kerns\X\S$\6
\&{begin} \37$\\{lp}\K\\{last\_leftmost\_char}$;\5
$\\{rp}\K\\{last\_rightmost\_char}$;\5
$\\{fast\_get\_avail}(\\{cp})$;\6
\&{if} $\\{lp}\I\\{null}$ \1\&{then}\5
$\\{cal\_margin\_kern\_var}(\\{lp})$;\2\6
\&{if} $\\{rp}\I\\{null}$ \1\&{then}\5
$\\{cal\_margin\_kern\_var}(\\{rp})$;\2\6
$\\{free\_avail}(\\{cp})$;\6
\&{end}\par
\U1027.\fi

\M823. Here is \\{hpack}, which is place where we do font substituting when
font expansion is being used. We define some constants used when calling
\\{hpack} to deal with font expansion.

\Y\P\D \37$\\{cal\_expand\_ratio}\S2$\C{calculate amount for font expansion
after breaking                              paragraph into lines}\par
\P\D \37$\\{subst\_ex\_font}\S3$\C{substitute fonts}\par
\P\D \37$\\{substituted}=3$\C{\\{subtype} of kern nodes that should be
substituted}\par
\P\D \37$\\{left\_pw}(\#)\S\\{char\_pw}(\#,\39\\{left\_side})$\par
\P\D \37$\\{right\_pw}(\#)\S\\{char\_pw}(\#,\39\\{right\_side})$\par
\Y\P\4\&{function}\1\  \37$\\{check\_expand\_pars}(\|f:\\{internal\_font%
\_number})$: \37\\{boolean};\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\2\6
\&{begin} \37$\\{check\_expand\_pars}\K\\{false}$;\6
\&{if} $(\\{pdf\_font\_step}[\|f]=0)\V((\\{pdf\_font\_stretch}[\|f]=\\{null%
\_font})\W(\\{pdf\_font\_shrink}[\|f]=\\{null\_font}))$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{cur\_font\_step}<0$ \1\&{then}\5
$\\{cur\_font\_step}\K\\{pdf\_font\_step}[\|f]$\6
\4\&{else} \&{if} $\\{cur\_font\_step}\I\\{pdf\_font\_step}[\|f]$ \1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"using\ fonts\ with\ different\
step\ of\ expansion\ in\ one\ paragraph\ is\ not\ allowed"})$;\2\2\6
$\|k\K\\{pdf\_font\_stretch}[\|f]$;\6
\&{if} $\|k\I\\{null\_font}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{max\_stretch\_ratio}<0$ \1\&{then}\5
$\\{max\_stretch\_ratio}\K\\{pdf\_font\_expand\_ratio}[\|k]$\6
\4\&{else} \&{if} $\\{max\_stretch\_ratio}\I\\{pdf\_font\_expand\_ratio}[\|k]$ %
\1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"using\ fonts\ with\ different\
limit\ of\ expansion\ in\ one\ paragraph\ is\ not\ allowed"})$;\2\2\6
\&{end};\2\6
$\|k\K\\{pdf\_font\_shrink}[\|f]$;\6
\&{if} $\|k\I\\{null\_font}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{max\_shrink\_ratio}<0$ \1\&{then}\5
$\\{max\_shrink\_ratio}\K-\\{pdf\_font\_expand\_ratio}[\|k]$\6
\4\&{else} \&{if} $\\{max\_shrink\_ratio}\I-\\{pdf\_font\_expand\_ratio}[\|k]$ %
\1\&{then}\5
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"using\ fonts\ with\ different\
limit\ of\ expansion\ in\ one\ paragraph\ is\ not\ allowed"})$;\2\2\6
\&{end};\2\6
$\\{check\_expand\_pars}\K\\{true}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{char\_stretch}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{scaled};\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\5
\\{dw}: \37\\{scaled};\5
\\{ef}: \37\\{integer};\2\6
\&{begin} \37$\\{char\_stretch}\K0$;\5
$\|k\K\\{pdf\_font\_stretch}[\|f]$;\5
$\\{ef}\K\\{get\_ef\_code}(\|f,\39\|c)$;\6
\&{if} $(\|k\I\\{null\_font})\W(\\{ef}>0)$ \1\&{then}\6
\&{begin} \37$\\{dw}\K\\{char\_width}(\|k)(\\{char\_info}(\|k)(\|c))-\\{char%
\_width}(\|f)(\\{char\_info}(\|f)(\|c))$;\6
\&{if} $\\{dw}>0$ \1\&{then}\5
$\\{char\_stretch}\K\\{round\_xn\_over\_d}(\\{dw},\39\\{ef},\391000)$;\2\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{char\_shrink}(\|f:\\{internal\_font\_number};\,\35%
\|c:\\{eight\_bits})$: \37\\{scaled};\6
\4\&{var} \37\|k: \37\\{internal\_font\_number};\5
\\{dw}: \37\\{scaled};\5
\\{ef}: \37\\{integer};\2\6
\&{begin} \37$\\{char\_shrink}\K0$;\5
$\|k\K\\{pdf\_font\_shrink}[\|f]$;\5
$\\{ef}\K\\{get\_ef\_code}(\|f,\39\|c)$;\6
\&{if} $(\|k\I\\{null\_font})\W(\\{ef}>0)$ \1\&{then}\6
\&{begin} \37$\\{dw}\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))-\\{char%
\_width}(\|k)(\\{char\_info}(\|k)(\|c))$;\6
\&{if} $\\{dw}>0$ \1\&{then}\5
$\\{char\_shrink}\K\\{round\_xn\_over\_d}(\\{dw},\39\\{ef},\391000)$;\2\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_kern}(\|f:\\{internal\_font\_number};\,\35%
\\{lc},\39\\{rc}:\\{eight\_bits})$: \37\\{scaled};\6
\4\&{label} \37\\{continue};\6
\4\&{var} \37\|i: \37\\{four\_quarters};\5
\|j: \37\\{four\_quarters};\5
\|k: \37\\{font\_index};\2\6
\&{begin} \37$\\{get\_kern}\K0$;\5
$\|i\K\\{char\_info}(\|f)(\\{lc})$;\6
\&{if} $\\{char\_tag}(\|i)\I\\{lig\_tag}$ \1\&{then}\5
\&{return};\2\6
$\|k\K\\{lig\_kern\_start}(\|f)(\|i)$;\5
$\|j\K\\{font\_info}[\|k].\\{qqqq}$;\6
\&{if} $\\{skip\_byte}(\|j)\L\\{stop\_flag}$ \1\&{then}\5
\&{goto} \37$\\{continue}+1$;\2\6
$\|k\K\\{lig\_kern\_restart}(\|f)(\|j)$;\6
\4\\{continue}: \37$\|j\K\\{font\_info}[\|k].\\{qqqq}$;\6
\4$\\{continue}+1$: \37\&{if} $(\\{next\_char}(\|j)=\\{rc})\W(\\{skip\_byte}(%
\|j)\L\\{stop\_flag})\W(\\{op\_byte}(\|j)\G\\{kern\_flag})$ \1\&{then}\6
\&{begin} \37$\\{get\_kern}\K\\{char\_kern}(\|f)(\|j)$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{skip\_byte}(\|j)=\\{qi}(0)$ \1\&{then}\5
$\\{incr}(\|k)$\6
\4\&{else} \&{begin} \37\&{if} $\\{skip\_byte}(\|j)\G\\{stop\_flag}$ \1\&{then}%
\5
\&{return};\2\6
$\|k\K\|k+\\{qo}(\\{skip\_byte}(\|j))+1$;\6
\&{end};\2\6
\&{goto} \37\\{continue};\6
\&{end};\6
\4\&{function}\1\  \37$\\{kern\_stretch}(\|p:\\{pointer})$: \37\\{scaled};\6
\4\&{var} \37$\|l,\39\|r$: \37\\{pointer};\5
\|d: \37\\{scaled};\2\6
\&{begin} \37$\\{kern\_stretch}\K0$;\6
\&{if} $(\\{prev\_char\_p}=\\{null})\V(\\{link}(\\{prev\_char\_p})\I\|p)\V(%
\\{link}(\|p)=\\{null})$ \1\&{then}\5
\&{return};\2\6
$\|l\K\\{prev\_char\_p}$;\5
$\|r\K\\{link}(\|p)$;\6
\&{if} $\R\\{is\_char\_node}(\|l)$ \1\&{then}\6
\&{if} $\\{type}(\|l)=\\{ligature\_node}$ \1\&{then}\5
$\|l\K\\{lig\_char}(\|l)$\6
\4\&{else} \&{return};\2\2\6
\&{if} $\R\\{is\_char\_node}(\|r)$ \1\&{then}\6
\&{if} $\\{type}(\|r)=\\{ligature\_node}$ \1\&{then}\5
$\|r\K\\{lig\_char}(\|r)$\6
\4\&{else} \&{return};\2\2\6
\&{if} $\R((\\{font}(\|l)=\\{font}(\|r))\W(\\{pdf\_font\_stretch}[\\{font}(%
\|l)]\I\\{null\_font}))$ \1\&{then}\5
\&{return};\2\6
$\|d\K\\{get\_kern}(\\{pdf\_font\_stretch}[\\{font}(\|l)],\39\\{character}(%
\|l),\39\\{character}(\|r))$;\5
$\\{kern\_stretch}\K\\{round\_xn\_over\_d}(\|d-\\{width}(\|p),\39\\{get\_ef%
\_code}(\\{font}(\|l),\39\\{character}(\|l)),\391000)$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{kern\_shrink}(\|p:\\{pointer})$: \37\\{scaled};\6
\4\&{var} \37$\|l,\39\|r$: \37\\{pointer};\5
\|d: \37\\{scaled};\2\6
\&{begin} \37$\\{kern\_shrink}\K0$;\6
\&{if} $(\\{prev\_char\_p}=\\{null})\V(\\{link}(\\{prev\_char\_p})\I\|p)\V(%
\\{link}(\|p)=\\{null})$ \1\&{then}\5
\&{return};\2\6
$\|l\K\\{prev\_char\_p}$;\5
$\|r\K\\{link}(\|p)$;\6
\&{if} $\R\\{is\_char\_node}(\|l)$ \1\&{then}\6
\&{if} $\\{type}(\|l)=\\{ligature\_node}$ \1\&{then}\5
$\|l\K\\{lig\_char}(\|l)$\6
\4\&{else} \&{return};\2\2\6
\&{if} $\R\\{is\_char\_node}(\|r)$ \1\&{then}\6
\&{if} $\\{type}(\|r)=\\{ligature\_node}$ \1\&{then}\5
$\|r\K\\{lig\_char}(\|r)$\6
\4\&{else} \&{return};\2\2\6
\&{if} $\R((\\{font}(\|l)=\\{font}(\|r))\W(\\{pdf\_font\_shrink}[\\{font}(\|l)]%
\I\\{null\_font}))$ \1\&{then}\5
\&{return};\2\6
$\|d\K\\{get\_kern}(\\{pdf\_font\_shrink}[\\{font}(\|l)],\39\\{character}(\|l),%
\39\\{character}(\|r))$;\5
$\\{kern\_shrink}\K\\{round\_xn\_over\_d}(\\{width}(\|p)-\|d,\39\\{get\_ef%
\_code}(\\{font}(\|l),\39\\{character}(\|l)),\391000)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_subst\_font}(\|p:\\{pointer};\,\35\\{ex\_ratio}:%
\\{integer})$;\6
\4\&{var} \37$\|f,\39\|k$: \37\\{internal\_font\_number};\5
\|r: \37\\{pointer};\5
\\{ef}: \37\\{integer};\2\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\|p)\W(\\{type}(\|p)=\\{disc\_node})$
\1\&{then}\6
\&{begin} \37$\|r\K\\{pre\_break}(\|p)$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|r)\V(\\{type}(\|r)=\\{ligature%
\_node})$ \1\&{then}\5
$\\{do\_subst\_font}(\|r,\39\\{ex\_ratio})$;\2\6
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
$\|r\K\\{post\_break}(\|p)$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|r)\V(\\{type}(\|r)=\\{ligature%
\_node})$ \1\&{then}\5
$\\{do\_subst\_font}(\|r,\39\\{ex\_ratio})$;\2\6
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{return};\6
\&{end};\2\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\|r\K\|p$\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{ligature\_node}$ \1\&{then}\5
$\|r\K\\{lig\_char}(\|p)$\6
\4\&{else} \&{begin} \37\C{$\\{short\_display\_n}(\|p,5)$;}\6
$\\{pdf\_error}(\.{"font\ expansion"},\39\.{"invalid\ node\ type"})$;\6
\&{end};\2\2\6
$\|f\K\\{font}(\|r)$;\5
$\\{ef}\K\\{get\_ef\_code}(\|f,\39\\{character}(\|r))$;\6
\&{if} $\\{ef}=0$ \1\&{then}\5
\&{return};\2\6
\&{if} $(\\{pdf\_font\_stretch}[\|f]\I\\{null\_font})\W(\\{ex\_ratio}>0)$ \1%
\&{then}\5
$\|k\K\\{expand\_font}(\|f,\39\\{ext\_xn\_over\_d}(\\{ex\_ratio}\ast\\{ef},\39%
\\{pdf\_font\_expand\_ratio}[\\{pdf\_font\_stretch}[\|f]],\391000000))$\6
\4\&{else} \&{if} $(\\{pdf\_font\_shrink}[\|f]\I\\{null\_font})\W(\\{ex%
\_ratio}<0)$ \1\&{then}\5
$\|k\K\\{expand\_font}(\|f,\39\\{ext\_xn\_over\_d}(\\{ex\_ratio}\ast\\{ef},\39-%
\\{pdf\_font\_expand\_ratio}[\\{pdf\_font\_shrink}[\|f]],\391000000))$\6
\4\&{else} $\|k\K\|f$;\2\2\6
\&{if} $\|k\I\|f$ \1\&{then}\6
\&{begin} \37$\\{font}(\|r)\K\|k$;\6
\&{if} $\R\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37$\|r\K\\{lig\_ptr}(\|p)$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{font}(\|r)\K\|k$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{char\_pw}(\|p:\\{pointer};\,\35\\{side}:\\{small%
\_number})$: \37\\{scaled};\6
\4\&{var} \37\|f: \37\\{internal\_font\_number};\5
\|c: \37\\{integer};\2\6
\&{begin} \37$\\{char\_pw}\K0$;\6
\&{if} $\\{side}=\\{left\_side}$ \1\&{then}\5
$\\{last\_leftmost\_char}\K\\{null}$\6
\4\&{else} $\\{last\_rightmost\_char}\K\\{null}$;\2\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{if} $\R\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{type}(\|p)=\\{ligature\_node}$ \1\&{then}\5
$\|p\K\\{lig\_char}(\|p)$\6
\4\&{else} \&{return};\2\6
\&{end};\2\6
$\|f\K\\{font}(\|p)$;\6
\&{if} $\\{side}=\\{left\_side}$ \1\&{then}\6
\&{begin} \37$\|c\K\\{get\_lp\_code}(\|f,\39\\{character}(\|p))$;\5
$\\{last\_leftmost\_char}\K\|p$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|c\K\\{get\_rp\_code}(\|f,\39\\{character}(\|p))$;\5
$\\{last\_rightmost\_char}\K\|p$;\6
\&{end};\2\6
\&{if} $\|c=0$ \1\&{then}\5
\&{return};\2\6
$\\{char\_pw}\K\\{round\_xn\_over\_d}(\\{quad}(\|f),\39\|c,\391000)$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{new\_margin\_kern}(\|w:\\{scaled};\,\35\|p:%
\\{pointer};\,\35\\{side}:\\{small\_number})$: \37\\{pointer};\6
\4\&{var} \37\|k: \37\\{pointer};\2\6
\&{begin} \37$\|k\K\\{get\_node}(\\{margin\_kern\_node\_size})$;\5
$\\{type}(\|k)\K\\{margin\_kern\_node}$;\5
$\\{subtype}(\|k)\K\\{side}$;\5
$\\{width}(\|k)\K\|w$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{pdf\_error}(\.{"margin\ kerning"},\39\.{"invalid\ pointer\ to\ marginal\
char\ node"})$;\2\6
$\\{fast\_get\_avail}(\\{margin\_char}(\|k))$;\5
$\\{character}(\\{margin\_char}(\|k))\K\\{character}(\|p)$;\5
$\\{font}(\\{margin\_char}(\|k))\K\\{font}(\|p)$;\5
$\\{new\_margin\_kern}\K\|k$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{hpack}(\|p:\\{pointer};\,\35\|w:\\{scaled};\,\35\|m:%
\\{small\_number})$: \37\\{pointer};\6
\4\&{label} \37$\\{reswitch},\39\\{common\_ending},\39\\{exit}$;\6
\4\&{var} \37\|r: \37\\{pointer};\C{the box node that will be returned}\6
\|q: \37\\{pointer};\C{trails behind \|p}\6
$\|h,\39\|d,\39\|x$: \37\\{scaled};\C{height, depth, and natural width}\6
\|s: \37\\{scaled};\C{shift amount}\6
\|g: \37\\{pointer};\C{points to a glue specification}\6
\|o: \37\\{glue\_ord};\C{order of infinity}\6
\|f: \37\\{internal\_font\_number};\C{the font in a \\{char\_node}}\6
\|i: \37\\{four\_quarters};\C{font information about a \\{char\_node}}\6
\\{hd}: \37\\{eight\_bits};\C{height and depth indices for a character}\6
\\{font\_stretch}: \37\\{scaled};\5
\\{font\_shrink}: \37\\{scaled};\5
\|k: \37\\{scaled};\2\6
\&{begin} \37$\\{last\_badness}\K0$;\5
$\|r\K\\{get\_node}(\\{box\_node\_size})$;\5
$\\{type}(\|r)\K\\{hlist\_node}$;\5
$\\{subtype}(\|r)\K\\{min\_quarterword}$;\5
$\\{shift\_amount}(\|r)\K0$;\5
$\|q\K\|r+\\{list\_offset}$;\5
$\\{link}(\|q)\K\|p$;\6
\&{if} $\|m=\\{cal\_expand\_ratio}$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\\{null}$;\5
$\\{font\_stretch}\K0$;\5
$\\{font\_shrink}\K0$;\5
$\\{font\_expand\_ratio}\K0$;\6
\&{end};\2\6
$\|h\K0$;\5
\X824:Clear dimensions to zero\X;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1710:Initialize the LR stack\X;\2\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X825:Examine node \|p in the hlist, taking account of its effect on the
dimensions of the new box, or moving it to the adjustment list; then advance %
\|p to the next node\X;\2\6
\&{if} $\\{adjust\_tail}\I\\{null}$ \1\&{then}\5
$\\{link}(\\{adjust\_tail})\K\\{null}$;\2\6
\&{if} $\\{pre\_adjust\_tail}\I\\{null}$ \1\&{then}\5
$\\{link}(\\{pre\_adjust\_tail})\K\\{null}$;\2\6
$\\{height}(\|r)\K\|h$;\5
$\\{depth}(\|r)\K\|d$;\6
\X833:Determine the value of $\\{width}(\|r)$ and the appropriate glue setting;
then \&{return} or \&{goto} \\{common\_ending}\X;\6
\4\\{common\_ending}: \37\X839:Finish issuing a diagnostic message for an
overfull or underfull hbox\X;\6
\4\\{exit}: \37\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1712:Check for LR anomalies at the end of \\{hpack}\X;\2\6
\&{if} $(\|m=\\{cal\_expand\_ratio})\W(\\{font\_expand\_ratio}\I0)$ \1\&{then}\6
\&{begin} \37$\\{font\_expand\_ratio}\K\\{fix\_int}(\\{font\_expand\_ratio},%
\39-1000,\391000)$;\5
$\|q\K\\{list\_ptr}(\|r)$;\5
$\\{free\_node}(\|r,\39\\{box\_node\_size})$;\5
$\|r\K\\{hpack}(\|q,\39\|w,\39\\{subst\_ex\_font})$;\6
\&{end};\2\6
$\\{hpack}\K\|r$;\6
\&{end};\par
\fi

\M824. \P$\X824:Clear dimensions to zero\X\S$\6
$\|d\K0$;\5
$\|x\K0$;\5
$\\{total\_stretch}[\\{normal}]\K0$;\5
$\\{total\_shrink}[\\{normal}]\K0$;\5
$\\{total\_stretch}[\\{fil}]\K0$;\5
$\\{total\_shrink}[\\{fil}]\K0$;\5
$\\{total\_stretch}[\\{fill}]\K0$;\5
$\\{total\_shrink}[\\{fill}]\K0$;\5
$\\{total\_stretch}[\\{filll}]\K0$;\5
$\\{total\_shrink}[\\{filll}]\K0$\par
\Us823\ET844.\fi

\M825. \P$\X825:Examine node \|p in the hlist, taking account of its effect on
the dimensions of the new box, or moving it to the adjustment list; then
advance \|p to the next node\X\S$\6
\&{begin} \37\\{reswitch}: \37\&{while} $\\{is\_char\_node}(\|p)$ \1\&{do}\5
\X828:Incorporate character dimensions into the dimensions of the hbox that
will contain~it, then move to the next node\X;\2\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{unset\_node}$: %
\37\X827:Incorporate box dimensions into the dimensions of the hbox that will
contain~it\X;\6
\4$\\{ins\_node},\39\\{mark\_node},\39\\{adjust\_node}$: \37\&{if} $(\\{adjust%
\_tail}\I\\{null})\V(\\{pre\_adjust\_tail}\I\\{null})$ \1\&{then}\5
\X831:Transfer node \|p to the adjustment list\X;\2\6
\4\\{whatsit\_node}: \37\X1607:Incorporate a whatsit node into an hbox\X;\6
\4\\{glue\_node}: \37\X832:Incorporate glue into the horizontal totals\X;\6
\4\\{margin\_kern\_node}: \37\&{begin} \37\&{if} $\|m=\\{cal\_expand\_ratio}$ %
\1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\\{margin\_char}(\|p))$;\5
$\\{do\_subst\_font}(\\{margin\_char}(\|p),\391000)$;\6
\&{if} $\|f\I\\{font}(\\{margin\_char}(\|p))$ \1\&{then}\5
$\\{font\_stretch}\K\\{font\_stretch}-\\{width}(\|p)-\\{char\_pw}(\\{margin%
\_char}(\|p),\39\\{subtype}(\|p))$;\2\6
$\\{font}(\\{margin\_char}(\|p))\K\|f$;\5
$\\{do\_subst\_font}(\\{margin\_char}(\|p),\39-1000)$;\6
\&{if} $\|f\I\\{font}(\\{margin\_char}(\|p))$ \1\&{then}\5
$\\{font\_shrink}\K\\{font\_shrink}-\\{width}(\|p)-\\{char\_pw}(\\{margin%
\_char}(\|p),\39\\{subtype}(\|p))$;\2\6
$\\{font}(\\{margin\_char}(\|p))\K\|f$;\6
\&{end}\6
\4\&{else} \&{if} $\|m=\\{subst\_ex\_font}$ \1\&{then}\6
\&{begin} \37$\\{do\_subst\_font}(\\{margin\_char}(\|p),\39\\{font\_expand%
\_ratio})$;\5
$\\{width}(\|p)\K-\\{char\_pw}(\\{margin\_char}(\|p),\39\\{subtype}(\|p))$;\6
\&{end};\2\2\6
$\|x\K\|x+\\{width}(\|p)$;\6
\&{end};\6
\4\\{kern\_node}: \37\&{begin} \37\&{if} $\\{subtype}(\|p)=\\{normal}$ \1%
\&{then}\6
\&{begin} \37\&{if} $\|m=\\{cal\_expand\_ratio}$ \1\&{then}\6
\&{begin} \37$\\{font\_stretch}\K\\{font\_stretch}+\\{kern\_stretch}(\|p)$;\5
$\\{font\_shrink}\K\\{font\_shrink}+\\{kern\_shrink}(\|p)$;\6
\&{end}\6
\4\&{else} \&{if} $\|m=\\{subst\_ex\_font}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{font\_expand\_ratio}>0$ \1\&{then}\5
$\|k\K\\{kern\_stretch}(\|p)$\6
\4\&{else} \&{if} $\\{font\_expand\_ratio}<0$ \1\&{then}\5
$\|k\K\\{kern\_shrink}(\|p)$\6
\4\&{else} $\\{pdfassert}(0)$;\2\2\6
\&{if} $\|k\I0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\\{link}(\|p))$ \1\&{then}\5
$\\{width}(\|p)\K\\{get\_kern}(\\{font}(\\{prev\_char\_p}),\39\\{character}(%
\\{prev\_char\_p}),\39\\{character}(\\{link}(\|p)))$\6
\4\&{else} \&{if} $\\{type}(\\{link}(\|p))=\\{ligature\_node}$ \1\&{then}\5
$\\{width}(\|p)\K\\{get\_kern}(\\{font}(\\{prev\_char\_p}),\39\\{character}(%
\\{prev\_char\_p}),\39\\{character}(\\{lig\_char}(\\{link}(\|p))))$;\2\2\6
\&{end};\2\6
\&{end};\2\2\6
\&{end};\2\6
$\|x\K\|x+\\{width}(\|p)$;\6
\&{end};\6
\4\\{math\_node}: \37\&{begin} \37$\|x\K\|x+\\{width}(\|p)$;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1711:Adjust \(t)the LR stack for the \\{hpack} routine\X;\2\6
\&{end};\6
\4\\{ligature\_node}: \37\&{begin} \37\&{if} $\|m=\\{subst\_ex\_font}$ \1%
\&{then}\5
$\\{do\_subst\_font}(\|p,\39\\{font\_expand\_ratio})$;\2\6
\X826:Make node \|p look like a \\{char\_node} and \&{goto} \\{reswitch}\X;\6
\&{end};\6
\4\\{disc\_node}: \37\&{if} $\|m=\\{subst\_ex\_font}$ \1\&{then}\5
$\\{do\_subst\_font}(\|p,\39\\{font\_expand\_ratio})$;\6
\4\&{othercases} \\{do\_nothing}\2\2\6
\&{endcases};\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{end}\par
\U823.\fi

\M826. \P$\X826:Make node \|p look like a \\{char\_node} and \&{goto} %
\\{reswitch}\X\S$\6
\&{begin} \37$\\{mem}[\\{lig\_trick}]\K\\{mem}[\\{lig\_char}(\|p)]$;\5
$\\{link}(\\{lig\_trick})\K\\{link}(\|p)$;\5
$\|p\K\\{lig\_trick}$;\5
\&{goto} \37\\{reswitch};\6
\&{end}\par
\Us650, 732, 825\ETs1325.\fi

\M827. The code here implicitly uses the fact that running dimensions are
indicated by \\{null\_flag}, which will be ignored in the calculations
because it is a highly negative number.

\Y\P$\4\X827:Incorporate box dimensions into the dimensions of the hbox that
will contain~it\X\S$\6
\&{begin} \37$\|x\K\|x+\\{width}(\|p)$;\6
\&{if} $\\{type}(\|p)\G\\{rule\_node}$ \1\&{then}\5
$\|s\K0$\ \&{else} $\|s\K\\{shift\_amount}(\|p)$;\2\6
\&{if} $\\{height}(\|p)-\|s>\|h$ \1\&{then}\5
$\|h\K\\{height}(\|p)-\|s$;\2\6
\&{if} $\\{depth}(\|p)+\|s>\|d$ \1\&{then}\5
$\|d\K\\{depth}(\|p)+\|s$;\2\6
\&{end}\par
\U825.\fi

\M828. The following code is part of \TeX's inner loop; i.e., adding another
character of text to the user's input will cause each of these instructions
to be exercised one more time.

\Y\P$\4\X828:Incorporate character dimensions into the dimensions of the hbox
that will contain~it, then move to the next node\X\S$\6
\&{begin} \37\&{if} $\|m\G\\{cal\_expand\_ratio}$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|p$;\6
\&{case} $\|m$ \1\&{of}\6
\4\\{cal\_expand\_ratio}: \37\&{begin} \37$\|f\K\\{font}(\|p)$;\5
$\\{add\_char\_stretch}(\\{font\_stretch})(\\{character}(\|p))$;\5
$\\{add\_char\_shrink}(\\{font\_shrink})(\\{character}(\|p))$;\6
\&{end};\6
\4\\{subst\_ex\_font}: \37$\\{do\_subst\_font}(\|p,\39\\{font\_expand%
\_ratio})$;\2\6
\&{endcases};\6
\&{end};\2\6
$\|f\K\\{font}(\|p)$;\5
$\|i\K\\{char\_info}(\|f)(\\{character}(\|p))$;\5
$\\{hd}\K\\{height\_depth}(\|i)$;\5
$\|x\K\|x+\\{char\_width}(\|f)(\|i)$;\6
$\|s\K\\{char\_height}(\|f)(\\{hd})$;\ \&{if} $\|s>\|h$ \1\&{then}\5
$\|h\K\|s$;\2\6
$\|s\K\\{char\_depth}(\|f)(\\{hd})$;\ \&{if} $\|s>\|d$ \1\&{then}\5
$\|d\K\|s$;\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U825.\fi

\M829. Although node \|q is not necessarily the immediate predecessor of node %
\|p,
it always points to some node in the list preceding \|p. Thus, we can delete
nodes by moving \|q when necessary. The algorithm takes linear time, and the
extra computation does not intrude on the inner loop unless it is necessary
to make a deletion.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pre\_adjust\_tail}: \37\\{pointer};\par
\fi

\M830. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pre\_adjust\_tail}\K\\{null}$;\par
\fi

\M831. Materials in \.{\\vadjust} used with \.{pre} keyword will be appended to
\\{pre\_adjust\_tail} instead of \\{adjust\_tail}.

\Y\P\D \37$\\{update\_adjust\_list}(\#)\S$\1\6
\&{begin} \37\&{if} $\#=\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"pre\ vadjust"})$;\2\6
$\\{link}(\#)\K\\{adjust\_ptr}(\|p)$;\6
\&{while} $\\{link}(\#)\I\\{null}$ \1\&{do}\5
$\#\K\\{link}(\#)$;\2\6
\&{end}\2\par
\Y\P$\4\X831:Transfer node \|p to the adjustment list\X\S$\6
\&{begin} \37\&{while} $\\{link}(\|q)\I\|p$ \1\&{do}\5
$\|q\K\\{link}(\|q)$;\2\6
\&{if} $\\{type}(\|p)=\\{adjust\_node}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{adjust\_pre}(\|p)\I0$ \1\&{then}\5
$\\{update\_adjust\_list}(\\{pre\_adjust\_tail})$\6
\4\&{else} $\\{update\_adjust\_list}(\\{adjust\_tail})$;\2\6
$\|p\K\\{link}(\|p)$;\5
$\\{free\_node}(\\{link}(\|q),\39\\{small\_node\_size})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{link}(\\{adjust\_tail})\K\|p$;\5
$\\{adjust\_tail}\K\|p$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{link}(\|q)\K\|p$;\5
$\|p\K\|q$;\6
\&{end}\par
\U825.\fi

\M832. \P$\X832:Incorporate glue into the horizontal totals\X\S$\6
\&{begin} \37$\|g\K\\{glue\_ptr}(\|p)$;\5
$\|x\K\|x+\\{width}(\|g)$;\6
$\|o\K\\{stretch\_order}(\|g)$;\5
$\\{total\_stretch}[\|o]\K\\{total\_stretch}[\|o]+\\{stretch}(\|g)$;\5
$\|o\K\\{shrink\_order}(\|g)$;\5
$\\{total\_shrink}[\|o]\K\\{total\_shrink}[\|o]+\\{shrink}(\|g)$;\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\6
\&{begin} \37$\|g\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{height}(\|g)>\|h$ \1\&{then}\5
$\|h\K\\{height}(\|g)$;\2\6
\&{if} $\\{depth}(\|g)>\|d$ \1\&{then}\5
$\|d\K\\{depth}(\|g)$;\2\6
\&{end};\2\6
\&{end}\par
\U825.\fi

\M833. When we get to the present part of the program, \|x is the natural width
of the box being packaged.

\Y\P$\4\X833:Determine the value of $\\{width}(\|r)$ and the appropriate glue
setting; then \&{return} or \&{goto} \\{common\_ending}\X\S$\6
\&{if} $\|m=\\{additional}$ \1\&{then}\5
$\|w\K\|x+\|w$;\2\6
$\\{width}(\|r)\K\|w$;\5
$\|x\K\|w-\|x$;\C{now \|x is the excess to be made up}\6
\&{if} $\|x=0$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{glue\_order}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\5
\&{return};\6
\&{end}\6
\4\&{else} \&{if} $\|x>0$ \1\&{then}\5
\X834:Determine horizontal glue stretch setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X\6
\4\&{else} \X840:Determine horizontal glue shrink setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\2\2\par
\U823.\fi

\M834. If \\{hpack} is called with $\|m=\\{cal\_expand\_ratio}$ we calculate
\\{font\_expand\_ratio} and return without checking for overfull or underfull
box.

\Y\P$\4\X834:Determine horizontal glue stretch setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\S$\6
\&{begin} \37\X835:Determine the stretch order\X;\6
\&{if} $(\|m=\\{cal\_expand\_ratio})\W(\|o=\\{normal})\W(\\{font\_stretch}>0)$ %
\1\&{then}\6
\&{begin} \37$\\{font\_expand\_ratio}\K\\{divide\_scaled}(\|x,\39\\{font%
\_stretch},\393)$;\5
\&{return};\6
\&{end};\2\6
$\\{glue\_order}(\|r)\K\|o$;\5
$\\{glue\_sign}(\|r)\K\\{stretching}$;\6
\&{if} $\\{total\_stretch}[\|o]\I0$ \1\&{then}\5
$\\{glue\_set}(\|r)\K\\{unfloat}(\|x/\\{total\_stretch}[\|o])$\6
\4\&{else} \&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\C{there's nothing to stretch}%
\6
\&{end};\2\6
\&{if} $\|o=\\{normal}$ \1\&{then}\6
\&{if} $\\{list\_ptr}(\|r)\I\\{null}$ \1\&{then}\5
\X836:Report an underfull hbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\2\2\6
\&{return};\6
\&{end}\par
\U833.\fi

\M835. \P$\X835:Determine the stretch order\X\S$\6
\&{if} $\\{total\_stretch}[\\{filll}]\I0$ \1\&{then}\5
$\|o\K\\{filll}$\6
\4\&{else} \&{if} $\\{total\_stretch}[\\{fill}]\I0$ \1\&{then}\5
$\|o\K\\{fill}$\6
\4\&{else} \&{if} $\\{total\_stretch}[\\{fil}]\I0$ \1\&{then}\5
$\|o\K\\{fil}$\6
\4\&{else} $\|o\K\\{normal}$\2\2\2\par
\Us834, 849\ETs972.\fi

\M836. \P$\X836:Report an underfull hbox and \&{goto} \\{common\_ending}, if
this box is sufficiently bad\X\S$\6
\&{begin} \37$\\{last\_badness}\K\\{badness}(\|x,\39\\{total\_stretch}[%
\\{normal}])$;\6
\&{if} $\\{last\_badness}>\\{hbadness}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\6
\&{if} $\\{last\_badness}>100$ \1\&{then}\5
$\\{print\_nl}(\.{"Underfull"})$\ \&{else} $\\{print\_nl}(\.{"Loose"})$;\2\6
$\\{print}(\.{"\ \\hbox\ (badness\ "})$;\5
$\\{print\_int}(\\{last\_badness})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end};\2\6
\&{end}\par
\U834.\fi

\M837. In order to provide a decent indication of where an overfull or
underfull
box originated, we use a global variable \\{pack\_begin\_line} that is
set nonzero only when \\{hpack} is being called by the paragraph builder
or the alignment finishing routine.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pack\_begin\_line}: \37\\{integer};\C{source file line where the current
paragraph   or alignment began; a negative value denotes alignment}\par
\fi

\M838. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pack\_begin\_line}\K0$;\par
\fi

\M839. \P$\X839:Finish issuing a diagnostic message for an overfull or
underfull hbox\X\S$\6
\&{if} $\\{output\_active}$ \1\&{then}\5
$\\{print}(\.{")\ has\ occurred\ while\ \\output\ is\ active"})$\6
\4\&{else} \&{begin} \37\&{if} $\\{pack\_begin\_line}\I0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pack\_begin\_line}>0$ \1\&{then}\5
$\\{print}(\.{")\ in\ paragraph\ at\ lines\ "})$\6
\4\&{else} $\\{print}(\.{")\ in\ alignment\ at\ lines\ "})$;\2\6
$\\{print\_int}(\\{abs}(\\{pack\_begin\_line}))$;\5
$\\{print}(\.{"--"})$;\6
\&{end}\6
\4\&{else} $\\{print}(\.{")\ detected\ at\ line\ "})$;\2\6
$\\{print\_int}(\\{line})$;\6
\&{end};\2\6
\\{print\_ln};\6
$\\{font\_in\_short\_display}\K\\{null\_font}$;\5
$\\{short\_display}(\\{list\_ptr}(\|r))$;\5
\\{print\_ln};\6
\\{begin\_diagnostic};\5
$\\{show\_box}(\|r)$;\5
$\\{end\_diagnostic}(\\{true})$\par
\U823.\fi

\M840. \P$\X840:Determine horizontal glue shrink setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\S$\6
\&{begin} \37\X841:Determine the shrink order\X;\6
\&{if} $(\|m=\\{cal\_expand\_ratio})\W(\|o=\\{normal})\W(\\{font\_shrink}>0)$ %
\1\&{then}\6
\&{begin} \37$\\{font\_expand\_ratio}\K\\{divide\_scaled}(\|x,\39\\{font%
\_shrink},\393)$;\5
\&{return};\6
\&{end};\2\6
$\\{glue\_order}(\|r)\K\|o$;\5
$\\{glue\_sign}(\|r)\K\\{shrinking}$;\6
\&{if} $\\{total\_shrink}[\|o]\I0$ \1\&{then}\5
$\\{glue\_set}(\|r)\K\\{unfloat}((-\|x)/\\{total\_shrink}[\|o])$\6
\4\&{else} \&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\C{there's nothing to shrink}\6
\&{end};\2\6
\&{if} $(\\{total\_shrink}[\|o]<-\|x)\W(\|o=\\{normal})\W(\\{list\_ptr}(\|r)\I%
\\{null})$ \1\&{then}\6
\&{begin} \37$\\{last\_badness}\K1000000$;\5
$\\{set\_glue\_ratio\_one}(\\{glue\_set}(\|r))$;\C{use the maximum shrinkage}\6
\X842:Report an overfull hbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\6
\&{end}\6
\4\&{else} \&{if} $\|o=\\{normal}$ \1\&{then}\6
\&{if} $\\{list\_ptr}(\|r)\I\\{null}$ \1\&{then}\5
\X843:Report a tight hbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\2\2\2\6
\&{return};\6
\&{end}\par
\U833.\fi

\M841. \P$\X841:Determine the shrink order\X\S$\6
\&{if} $\\{total\_shrink}[\\{filll}]\I0$ \1\&{then}\5
$\|o\K\\{filll}$\6
\4\&{else} \&{if} $\\{total\_shrink}[\\{fill}]\I0$ \1\&{then}\5
$\|o\K\\{fill}$\6
\4\&{else} \&{if} $\\{total\_shrink}[\\{fil}]\I0$ \1\&{then}\5
$\|o\K\\{fil}$\6
\4\&{else} $\|o\K\\{normal}$\2\2\2\par
\Us840, 852\ETs972.\fi

\M842. \P$\X842:Report an overfull hbox and \&{goto} \\{common\_ending}, if
this box is sufficiently bad\X\S$\6
\&{if} $(-\|x-\\{total\_shrink}[\\{normal}]>\\{hfuzz})\V(\\{hbadness}<100)$ \1%
\&{then}\6
\&{begin} \37\&{if} $(\\{overfull\_rule}>0)\W(-\|x-\\{total\_shrink}[%
\\{normal}]>\\{hfuzz})$ \1\&{then}\6
\&{begin} \37\&{while} $\\{link}(\|q)\I\\{null}$ \1\&{do}\5
$\|q\K\\{link}(\|q)$;\2\6
$\\{link}(\|q)\K\\{new\_rule}$;\5
$\\{width}(\\{link}(\|q))\K\\{overfull\_rule}$;\6
\&{end};\2\6
\\{print\_ln};\5
$\\{print\_nl}(\.{"Overfull\ \\hbox\ ("})$;\5
$\\{print\_scaled}(-\|x-\\{total\_shrink}[\\{normal}])$;\5
$\\{print}(\.{"pt\ too\ wide"})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end}\2\par
\U840.\fi

\M843. \P$\X843:Report a tight hbox and \&{goto} \\{common\_ending}, if this
box is sufficiently bad\X\S$\6
\&{begin} \37$\\{last\_badness}\K\\{badness}(-\|x,\39\\{total\_shrink}[%
\\{normal}])$;\6
\&{if} $\\{last\_badness}>\\{hbadness}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
$\\{print\_nl}(\.{"Tight\ \\hbox\ (badness\ "})$;\5
$\\{print\_int}(\\{last\_badness})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end};\2\6
\&{end}\par
\U840.\fi

\M844. The \\{vpack} subroutine is actually a special case of a slightly more
general routine called \\{vpackage}, which has four parameters. The fourth
parameter, which is \\{max\_dimen} in the case of \\{vpack}, specifies the
maximum depth of the page box that is constructed. The depth is first
computed by the normal rules; if it exceeds this limit, the reference
point is simply moved down until the limiting depth is attained.

\Y\P\D \37$\\{vpack}(\#)\S\\{vpackage}(\#,\39\\{max\_dimen})$\C{special case of
unconstrained depth}\par
\Y\P\4\&{function}\1\  \37$\\{vpackage}(\|p:\\{pointer};\,\35\|h:\\{scaled};\,%
\35\|m:\\{small\_number};\,\35\|l:\\{scaled})$: \37\\{pointer};\6
\4\&{label} \37$\\{common\_ending},\39\\{exit}$;\6
\4\&{var} \37\|r: \37\\{pointer};\C{the box node that will be returned}\6
$\|w,\39\|d,\39\|x$: \37\\{scaled};\C{width, depth, and natural height}\6
\|s: \37\\{scaled};\C{shift amount}\6
\|g: \37\\{pointer};\C{points to a glue specification}\6
\|o: \37\\{glue\_ord};\C{order of infinity}\2\6
\&{begin} \37$\\{last\_badness}\K0$;\5
$\|r\K\\{get\_node}(\\{box\_node\_size})$;\5
$\\{type}(\|r)\K\\{vlist\_node}$;\5
$\\{subtype}(\|r)\K\\{min\_quarterword}$;\5
$\\{shift\_amount}(\|r)\K0$;\5
$\\{list\_ptr}(\|r)\K\|p$;\6
$\|w\K0$;\5
\X824:Clear dimensions to zero\X;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X845:Examine node \|p in the vlist, taking account of its effect on the
dimensions of the new box; then advance \|p to the next node\X;\2\6
$\\{width}(\|r)\K\|w$;\6
\&{if} $\|d>\|l$ \1\&{then}\6
\&{begin} \37$\|x\K\|x+\|d-\|l$;\5
$\\{depth}(\|r)\K\|l$;\6
\&{end}\6
\4\&{else} $\\{depth}(\|r)\K\|d$;\2\6
\X848:Determine the value of $\\{height}(\|r)$ and the appropriate glue
setting; then \&{return} or \&{goto} \\{common\_ending}\X;\6
\4\\{common\_ending}: \37\X851:Finish issuing a diagnostic message for an
overfull or underfull vbox\X;\6
\4\\{exit}: \37$\\{vpackage}\K\|r$;\6
\&{end};\par
\fi

\M845. \P$\X845:Examine node \|p in the vlist, taking account of its effect on
the dimensions of the new box; then advance \|p to the next node\X\S$\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{confusion}(\.{"vpack"})$\6
\4\&{else} \&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{unset\_node}$: %
\37\X846:Incorporate box dimensions into the dimensions of the vbox that will
contain~it\X;\6
\4\\{whatsit\_node}: \37\X1606:Incorporate a whatsit node into a vbox\X;\6
\4\\{glue\_node}: \37\X847:Incorporate glue into the vertical totals\X;\6
\4\\{kern\_node}: \37\&{begin} \37$\|x\K\|x+\|d+\\{width}(\|p)$;\5
$\|d\K0$;\6
\&{end};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end}\par
\U844.\fi

\M846. \P$\X846:Incorporate box dimensions into the dimensions of the vbox that
will contain~it\X\S$\6
\&{begin} \37$\|x\K\|x+\|d+\\{height}(\|p)$;\5
$\|d\K\\{depth}(\|p)$;\6
\&{if} $\\{type}(\|p)\G\\{rule\_node}$ \1\&{then}\5
$\|s\K0$\ \&{else} $\|s\K\\{shift\_amount}(\|p)$;\2\6
\&{if} $\\{width}(\|p)+\|s>\|w$ \1\&{then}\5
$\|w\K\\{width}(\|p)+\|s$;\2\6
\&{end}\par
\U845.\fi

\M847. \P$\X847:Incorporate glue into the vertical totals\X\S$\6
\&{begin} \37$\|x\K\|x+\|d$;\5
$\|d\K0$;\6
$\|g\K\\{glue\_ptr}(\|p)$;\5
$\|x\K\|x+\\{width}(\|g)$;\6
$\|o\K\\{stretch\_order}(\|g)$;\5
$\\{total\_stretch}[\|o]\K\\{total\_stretch}[\|o]+\\{stretch}(\|g)$;\5
$\|o\K\\{shrink\_order}(\|g)$;\5
$\\{total\_shrink}[\|o]\K\\{total\_shrink}[\|o]+\\{shrink}(\|g)$;\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\6
\&{begin} \37$\|g\K\\{leader\_ptr}(\|p)$;\6
\&{if} $\\{width}(\|g)>\|w$ \1\&{then}\5
$\|w\K\\{width}(\|g)$;\2\6
\&{end};\2\6
\&{end}\par
\U845.\fi

\M848. When we get to the present part of the program, \|x is the natural
height
of the box being packaged.

\Y\P$\4\X848:Determine the value of $\\{height}(\|r)$ and the appropriate glue
setting; then \&{return} or \&{goto} \\{common\_ending}\X\S$\6
\&{if} $\|m=\\{additional}$ \1\&{then}\5
$\|h\K\|x+\|h$;\2\6
$\\{height}(\|r)\K\|h$;\5
$\|x\K\|h-\|x$;\C{now \|x is the excess to be made up}\6
\&{if} $\|x=0$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{glue\_order}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\5
\&{return};\6
\&{end}\6
\4\&{else} \&{if} $\|x>0$ \1\&{then}\5
\X849:Determine vertical glue stretch setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X\6
\4\&{else} \X852:Determine vertical glue shrink setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\2\2\par
\U844.\fi

\M849. \P$\X849:Determine vertical glue stretch setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\S$\6
\&{begin} \37\X835:Determine the stretch order\X;\6
$\\{glue\_order}(\|r)\K\|o$;\5
$\\{glue\_sign}(\|r)\K\\{stretching}$;\6
\&{if} $\\{total\_stretch}[\|o]\I0$ \1\&{then}\5
$\\{glue\_set}(\|r)\K\\{unfloat}(\|x/\\{total\_stretch}[\|o])$\6
\4\&{else} \&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\C{there's nothing to stretch}%
\6
\&{end};\2\6
\&{if} $\|o=\\{normal}$ \1\&{then}\6
\&{if} $\\{list\_ptr}(\|r)\I\\{null}$ \1\&{then}\5
\X850:Report an underfull vbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\2\2\6
\&{return};\6
\&{end}\par
\U848.\fi

\M850. \P$\X850:Report an underfull vbox and \&{goto} \\{common\_ending}, if
this box is sufficiently bad\X\S$\6
\&{begin} \37$\\{last\_badness}\K\\{badness}(\|x,\39\\{total\_stretch}[%
\\{normal}])$;\6
\&{if} $\\{last\_badness}>\\{vbadness}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\6
\&{if} $\\{last\_badness}>100$ \1\&{then}\5
$\\{print\_nl}(\.{"Underfull"})$\ \&{else} $\\{print\_nl}(\.{"Loose"})$;\2\6
$\\{print}(\.{"\ \\vbox\ (badness\ "})$;\5
$\\{print\_int}(\\{last\_badness})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end};\2\6
\&{end}\par
\U849.\fi

\M851. \P$\X851:Finish issuing a diagnostic message for an overfull or
underfull vbox\X\S$\6
\&{if} $\\{output\_active}$ \1\&{then}\5
$\\{print}(\.{")\ has\ occurred\ while\ \\output\ is\ active"})$\6
\4\&{else} \&{begin} \37\&{if} $\\{pack\_begin\_line}\I0$ \1\&{then}\C{it's
actually negative}\6
\&{begin} \37$\\{print}(\.{")\ in\ alignment\ at\ lines\ "})$;\5
$\\{print\_int}(\\{abs}(\\{pack\_begin\_line}))$;\5
$\\{print}(\.{"--"})$;\6
\&{end}\6
\4\&{else} $\\{print}(\.{")\ detected\ at\ line\ "})$;\2\6
$\\{print\_int}(\\{line})$;\5
\\{print\_ln};\6
\&{end};\2\6
\\{begin\_diagnostic};\5
$\\{show\_box}(\|r)$;\5
$\\{end\_diagnostic}(\\{true})$\par
\U844.\fi

\M852. \P$\X852:Determine vertical glue shrink setting, then \&{return} or %
\hbox{\&{goto} \\{common\_ending}}\X\S$\6
\&{begin} \37\X841:Determine the shrink order\X;\6
$\\{glue\_order}(\|r)\K\|o$;\5
$\\{glue\_sign}(\|r)\K\\{shrinking}$;\6
\&{if} $\\{total\_shrink}[\|o]\I0$ \1\&{then}\5
$\\{glue\_set}(\|r)\K\\{unfloat}((-\|x)/\\{total\_shrink}[\|o])$\6
\4\&{else} \&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\C{there's nothing to shrink}\6
\&{end};\2\6
\&{if} $(\\{total\_shrink}[\|o]<-\|x)\W(\|o=\\{normal})\W(\\{list\_ptr}(\|r)\I%
\\{null})$ \1\&{then}\6
\&{begin} \37$\\{last\_badness}\K1000000$;\5
$\\{set\_glue\_ratio\_one}(\\{glue\_set}(\|r))$;\C{use the maximum shrinkage}\6
\X853:Report an overfull vbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\6
\&{end}\6
\4\&{else} \&{if} $\|o=\\{normal}$ \1\&{then}\6
\&{if} $\\{list\_ptr}(\|r)\I\\{null}$ \1\&{then}\5
\X854:Report a tight vbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X;\2\2\2\6
\&{return};\6
\&{end}\par
\U848.\fi

\M853. \P$\X853:Report an overfull vbox and \&{goto} \\{common\_ending}, if
this box is sufficiently bad\X\S$\6
\&{if} $(-\|x-\\{total\_shrink}[\\{normal}]>\\{vfuzz})\V(\\{vbadness}<100)$ \1%
\&{then}\6
\&{begin} \37\\{print\_ln};\5
$\\{print\_nl}(\.{"Overfull\ \\vbox\ ("})$;\5
$\\{print\_scaled}(-\|x-\\{total\_shrink}[\\{normal}])$;\5
$\\{print}(\.{"pt\ too\ high"})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end}\2\par
\U852.\fi

\M854. \P$\X854:Report a tight vbox and \&{goto} \\{common\_ending}, if this
box is sufficiently bad\X\S$\6
\&{begin} \37$\\{last\_badness}\K\\{badness}(-\|x,\39\\{total\_shrink}[%
\\{normal}])$;\6
\&{if} $\\{last\_badness}>\\{vbadness}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
$\\{print\_nl}(\.{"Tight\ \\vbox\ (badness\ "})$;\5
$\\{print\_int}(\\{last\_badness})$;\5
\&{goto} \37\\{common\_ending};\6
\&{end};\2\6
\&{end}\par
\U852.\fi

\M855. When a box is being appended to the current vertical list, the
baselineskip calculation is handled by the \\{append\_to\_vlist} routine.

\Y\P\4\&{procedure}\1\  \37$\\{append\_to\_vlist}(\|b:\\{pointer})$;\6
\4\&{var} \37\|d: \37\\{scaled};\C{deficiency of space between baselines}\6
\|p: \37\\{pointer};\C{a new glue node}\2\6
\&{begin} \37\&{if} $\\{prev\_depth}>\\{pdf\_ignored\_dimen}$ \1\&{then}\6
\&{begin} \37$\|d\K\\{width}(\\{baseline\_skip})-\\{prev\_depth}-\\{height}(%
\|b)$;\6
\&{if} $\|d<\\{line\_skip\_limit}$ \1\&{then}\5
$\|p\K\\{new\_param\_glue}(\\{line\_skip\_code})$\6
\4\&{else} \&{begin} \37$\|p\K\\{new\_skip\_param}(\\{baseline\_skip\_code})$;\5
$\\{width}(\\{temp\_ptr})\K\|d$;\C{$\\{temp\_ptr}=\\{glue\_ptr}(\|p)$}\6
\&{end};\2\6
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\6
\&{end};\2\6
$\\{link}(\\{tail})\K\|b$;\5
$\\{tail}\K\|b$;\5
$\\{prev\_depth}\K\\{depth}(\|b)$;\6
\&{end};\par
\fi

\N856.  \[34] Data structures for math mode.
When \TeX\ reads a formula that is enclosed between \.\$'s, it constructs an
{\sl mlist}, which is essentially a tree structure representing that
formula.  An mlist is a linear sequence of items, but we can regard it as
a tree structure because mlists can appear within mlists. For example, many
of the entries can be subscripted or superscripted, and such ``scripts''
are mlists in their own right.

An entire formula is parsed into such a tree before any of the actual
typesetting is done, because the current style of type is usually not
known until the formula has been fully scanned. For example, when the
formula `\.{\$a+b \\over c+d\$}' is being read, there is no way to tell
that `\.{a+b}' will be in script size until `\.{\\over}' has appeared.

During the scanning process, each element of the mlist being built is
classified as a relation, a binary operator, an open parenthesis, etc.,
or as a construct like `\.{\\sqrt}' that must be built up. This classification
appears in the mlist data structure.

After a formula has been fully scanned, the mlist is converted to an hlist
so that it can be incorporated into the surrounding text. This conversion is
controlled by a recursive procedure that decides all of the appropriate
styles by a ``top-down'' process starting at the outermost level and working
in towards the subformulas. The formula is ultimately pasted together using
combinations of horizontal and vertical boxes, with glue and penalty nodes
inserted as necessary.

An mlist is represented internally as a linked list consisting chiefly
of ``noads'' (pronounced ``no-adds''), to distinguish them from the somewhat
similar ``nodes'' in hlists and vlists. Certain kinds of ordinary nodes are
allowed to appear in mlists together with the noads; \TeX\ tells the difference
by means of the \\{type} field, since a noad's \\{type} is always greater than
that of a node. An mlist does not contain character nodes, hlist nodes, vlist
nodes, math nodes, ligature nodes,
or unset nodes; in particular, each mlist item appears in the
variable-size part of \\{mem}, so the \\{type} field is always present.

\fi

\M857. Each noad is four or more words long. The first word contains the %
\\{type}
and \\{subtype} and \\{link} fields that are already so familiar to us; the
second, third, and fourth words are called the noad's \\{nucleus}, \\{subscr},
and \\{supscr} fields.

Consider, for example, the simple formula `\.{\$x\^2\$}', which would be
parsed into an mlist containing a single element called an \\{ord\_noad}.
The \\{nucleus} of this noad is a representation of `\.x', the \\{subscr} is
empty, and the \\{supscr} is a representation of `\.2'.

The \\{nucleus}, \\{subscr}, and \\{supscr} fields are further broken into
subfields. If \|p points to a noad, and if \|q is one of its principal
fields (e.g., $\|q=\\{subscr}(\|p)$), there are several possibilities for the
subfields, depending on the \\{math\_type} of \|q.

\yskip\hang$\\{math\_type}(\|q)=\\{math\_char}$ means that $\\{fam}(\|q)$
refers to one of
the sixteen font families, and $\\{character}(\|q)$ is the number of a
character
within a font of that family, as in a character node.

\yskip\hang$\\{math\_type}(\|q)=\\{math\_text\_char}$ is similar, but the
character is
unsubscripted and unsuperscripted and it is followed immediately by another
character from the same font. (This \\{math\_type} setting appears only
briefly during the processing; it is used to suppress unwanted italic
corrections.)

\yskip\hang$\\{math\_type}(\|q)=\\{empty}$ indicates a field with no value (the
corresponding attribute of noad \|p is not present).

\yskip\hang$\\{math\_type}(\|q)=\\{sub\_box}$ means that $\\{info}(\|q)$ points
to a box
node (either an \\{hlist\_node} or a \\{vlist\_node}) that should be used as
the
value of the field.  The \\{shift\_amount} in the subsidiary box node is the
amount by which that box will be shifted downward.

\yskip\hang$\\{math\_type}(\|q)=\\{sub\_mlist}$ means that $\\{info}(\|q)$
points to
an mlist; the mlist must be converted to an hlist in order to obtain
the value of this field.

\yskip\noindent In the latter case, we might have $\\{info}(\|q)=\\{null}$.
This
is not the same as $\\{math\_type}(\|q)=\\{empty}$; for example, `\.{\$P\_\{\}%
\$}'
and `\.{\$P\$}' produce different results (the former will not have the
``italic correction'' added to the width of \|P, but the ``script skip''
will be added).

The definitions of subfields given here are evidently wasteful of space,
since a halfword is being used for the \\{math\_type} although only three
bits would be needed. However, there are hardly ever many noads present at
once, since they are soon converted to nodes that take up even more space,
so we can afford to represent them in whatever way simplifies the
programming.

\Y\P\D \37$\\{noad\_size}=4$\C{number of words in a normal noad}\par
\P\D \37$\\{nucleus}(\#)\S\#+1$\C{the \\{nucleus} field of a noad}\par
\P\D \37$\\{supscr}(\#)\S\#+2$\C{the \\{supscr} field of a noad}\par
\P\D \37$\\{subscr}(\#)\S\#+3$\C{the \\{subscr} field of a noad}\par
\P\D \37$\\{math\_type}\S\\{link}$\C{a \\{halfword} in \\{mem}}\par
\P\D \37$\\{fam}\S\\{font}$\C{a \\{quarterword} in \\{mem}}\par
\P\D \37$\\{math\_char}=1$\C{\\{math\_type} when the attribute is simple}\par
\P\D \37$\\{sub\_box}=2$\C{\\{math\_type} when the attribute is a box}\par
\P\D \37$\\{sub\_mlist}=3$\C{\\{math\_type} when the attribute is a formula}\par
\P\D \37$\\{math\_text\_char}=4$\C{\\{math\_type} when italic correction is
dubious}\par
\fi

\M858. Each portion of a formula is classified as Ord, Op, Bin, Rel, Open,
Close, Punct, or Inner, for purposes of spacing and line breaking. An
\\{ord\_noad}, \\{op\_noad}, \\{bin\_noad}, \\{rel\_noad}, \\{open\_noad}, %
\\{close\_noad},
\\{punct\_noad}, or \\{inner\_noad} is used to represent portions of the
various
types. For example, an `\.=' sign in a formula leads to the creation of a
\\{rel\_noad} whose \\{nucleus} field is a representation of an equals sign
(usually $\\{fam}=0$, $\\{character}=\O{75}$).  A formula preceded by \.{%
\\mathrel}
also results in a \\{rel\_noad}.  When a \\{rel\_noad} is followed by an
\\{op\_noad}, say, and possibly separated by one or more ordinary nodes (not
noads), \TeX\ will insert a penalty node (with the current \\{rel\_penalty})
just after the formula that corresponds to the \\{rel\_noad}, unless there
already was a penalty immediately following; and a ``thick space'' will be
inserted just before the formula that corresponds to the \\{op\_noad}.

A noad of type \\{ord\_noad}, \\{op\_noad}, \dots, \\{inner\_noad} usually
has a $\\{subtype}=\\{normal}$. The only exception is that an \\{op\_noad}
might
have $\\{subtype}=\\{limits}$ or \\{no\_limits}, if the normal positioning of
limits has been overridden for this operator.

\Y\P\D \37$\\{ord\_noad}=\\{unset\_node}+3$\C{\\{type} of a noad classified
Ord}\par
\P\D \37$\\{op\_noad}=\\{ord\_noad}+1$\C{\\{type} of a noad classified Op}\par
\P\D \37$\\{bin\_noad}=\\{ord\_noad}+2$\C{\\{type} of a noad classified Bin}\par
\P\D \37$\\{rel\_noad}=\\{ord\_noad}+3$\C{\\{type} of a noad classified Rel}\par
\P\D \37$\\{open\_noad}=\\{ord\_noad}+4$\C{\\{type} of a noad classified Open}%
\par
\P\D \37$\\{close\_noad}=\\{ord\_noad}+5$\C{\\{type} of a noad classified
Close}\par
\P\D \37$\\{punct\_noad}=\\{ord\_noad}+6$\C{\\{type} of a noad classified
Punct}\par
\P\D \37$\\{inner\_noad}=\\{ord\_noad}+7$\C{\\{type} of a noad classified
Inner}\par
\P\D \37$\\{limits}=1$\C{\\{subtype} of \\{op\_noad} whose scripts are to be
above, below}\par
\P\D \37$\\{no\_limits}=2$\C{\\{subtype} of \\{op\_noad} whose scripts are to
be normal}\par
\fi

\M859. A \\{radical\_noad} is five words long; the fifth word is the \\{left%
\_delimiter}
field, which usually represents a square root sign.

A \\{fraction\_noad} is six words long; it has a \\{right\_delimiter} field
as well as a \\{left\_delimiter}.

Delimiter fields are of type \\{four\_quarters}, and they have four subfields
called \\{small\_fam}, \\{small\_char}, \\{large\_fam}, \\{large\_char}. These
subfields
represent variable-size delimiters by giving the ``small'' and ``large''
starting characters, as explained in Chapter~17 of {\sl The \TeX book}.

A \\{fraction\_noad} is actually quite different from all other noads. Not
only does it have six words, it has \\{thickness}, \\{denominator}, and
\\{numerator} fields instead of \\{nucleus}, \\{subscr}, and \\{supscr}. The
\\{thickness} is a scaled value that tells how thick to make a fraction
rule; however, the special value \\{default\_code} is used to stand for the
\\{default\_rule\_thickness} of the current size. The \\{numerator} and
\\{denominator} point to mlists that define a fraction; we always have
$$\hbox{$\\{math\_type}(\\{numerator})=\\{math\_type}(\\{denominator})=\\{sub%
\_mlist}$}.$$ The
\\{left\_delimiter} and \\{right\_delimiter} fields specify delimiters that
will
be placed at the left and right of the fraction. In this way, a
\\{fraction\_noad} is able to represent all of \TeX's operators \.{\\over},
\.{\\atop}, \.{\\above}, \.{\\overwithdelims}, \.{\\atopwithdelims}, and
\.{\\abovewithdelims}.

\Y\P\D \37$\\{left\_delimiter}(\#)\S\#+4$\C{first delimiter field of a noad}\par
\P\D \37$\\{right\_delimiter}(\#)\S\#+5$\C{second delimiter field of a fraction
noad}\par
\P\D \37$\\{radical\_noad}=\\{inner\_noad}+1$\C{\\{type} of a noad for square
roots}\par
\P\D \37$\\{radical\_noad\_size}=5$\C{number of \\{mem} words in a radical
noad}\par
\P\D \37$\\{fraction\_noad}=\\{radical\_noad}+1$\C{\\{type} of a noad for
generalized fractions}\par
\P\D \37$\\{fraction\_noad\_size}=6$\C{number of \\{mem} words in a fraction
noad}\par
\P\D \37$\\{small\_fam}(\#)\S\\{mem}[\#].\\{qqqq}.\\{b0}$\C{\\{fam} for
``small'' delimiter}\par
\P\D \37$\\{small\_char}(\#)\S\\{mem}[\#].\\{qqqq}.\\{b1}$\C{\\{character} for
``small'' delimiter}\par
\P\D \37$\\{large\_fam}(\#)\S\\{mem}[\#].\\{qqqq}.\\{b2}$\C{\\{fam} for
``large'' delimiter}\par
\P\D \37$\\{large\_char}(\#)\S\\{mem}[\#].\\{qqqq}.\\{b3}$\C{\\{character} for
``large'' delimiter}\par
\P\D \37$\\{thickness}\S\\{width}$\C{\\{thickness} field in a fraction noad}\par
\P\D \37$\\{default\_code}\S\O{10000000000}$\C{denotes \\{default\_rule%
\_thickness}}\par
\P\D \37$\\{numerator}\S\\{supscr}$\C{\\{numerator} field in a fraction noad}%
\par
\P\D \37$\\{denominator}\S\\{subscr}$\C{\\{denominator} field in a fraction
noad}\par
\fi

\M860. The global variable \\{empty\_field} is set up for initialization of
empty
fields in new noads. Similarly, \\{null\_delimiter} is for the initialization
of delimiter fields.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{empty\_field}: \37\\{two\_halves};\6
\4\\{null\_delimiter}: \37\\{four\_quarters};\par
\fi

\M861. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{empty\_field}.\\{rh}\K\\{empty}$;\5
$\\{empty\_field}.\\{lh}\K\\{null}$;\6
$\\{null\_delimiter}.\\{b0}\K0$;\5
$\\{null\_delimiter}.\\{b1}\K\\{min\_quarterword}$;\6
$\\{null\_delimiter}.\\{b2}\K0$;\5
$\\{null\_delimiter}.\\{b3}\K\\{min\_quarterword}$;\par
\fi

\M862. The \\{new\_noad} function creates an \\{ord\_noad} that is completely
null.

\Y\P\4\&{function}\1\  \37\\{new\_noad}: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{noad\_size})$;\5
$\\{type}(\|p)\K\\{ord\_noad}$;\5
$\\{subtype}(\|p)\K\\{normal}$;\5
$\\{mem}[\\{nucleus}(\|p)].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{subscr}(\|p)].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{supscr}(\|p)].\\{hh}\K\\{empty\_field}$;\5
$\\{new\_noad}\K\|p$;\6
\&{end};\par
\fi

\M863. A few more kinds of noads will complete the set: An \\{under\_noad} has
its
nucleus underlined; an \\{over\_noad} has it overlined. An \\{accent\_noad}
places
an accent over its nucleus; the accent character appears as
$\\{fam}(\\{accent\_chr}(\|p))$ and $\\{character}(\\{accent\_chr}(\|p))$. A %
\\{vcenter\_noad}
centers its nucleus vertically with respect to the axis of the formula;
in such noads we always have $\\{math\_type}(\\{nucleus}(\|p))=\\{sub\_box}$.

And finally, we have \\{left\_noad} and \\{right\_noad} types, to implement
\TeX's \.{\\left} and \.{\\right} as well as \eTeX's \.{\\middle}.
The \\{nucleus} of such noads is
replaced by a \\{delimiter} field; thus, for example, `\.{\\left(}' produces
a \\{left\_noad} such that $\\{delimiter}(\|p)$ holds the family and character
codes for all left parentheses. A \\{left\_noad} never appears in an mlist
except as the first element, and a \\{right\_noad} never appears in an mlist
except as the last element; furthermore, we either have both a \\{left\_noad}
and a \\{right\_noad}, or neither one is present. The \\{subscr} and \\{supscr}
fields are always \\{empty} in a \\{left\_noad} and a \\{right\_noad}.

\Y\P\D \37$\\{under\_noad}=\\{fraction\_noad}+1$\C{\\{type} of a noad for
underlining}\par
\P\D \37$\\{over\_noad}=\\{under\_noad}+1$\C{\\{type} of a noad for overlining}%
\par
\P\D \37$\\{accent\_noad}=\\{over\_noad}+1$\C{\\{type} of a noad for accented
subformulas}\par
\P\D \37$\\{accent\_noad\_size}=5$\C{number of \\{mem} words in an accent noad}%
\par
\P\D \37$\\{accent\_chr}(\#)\S\#+4$\C{the \\{accent\_chr} field of an accent
noad}\par
\P\D \37$\\{vcenter\_noad}=\\{accent\_noad}+1$\C{\\{type} of a noad for \.{%
\\vcenter}}\par
\P\D \37$\\{left\_noad}=\\{vcenter\_noad}+1$\C{\\{type} of a noad for \.{%
\\left}}\par
\P\D \37$\\{right\_noad}=\\{left\_noad}+1$\C{\\{type} of a noad for \.{%
\\right}}\par
\P\D \37$\\{delimiter}\S\\{nucleus}$\C{\\{delimiter} field in left and right
noads}\par
\P\D \37$\\{middle\_noad}\S1$\C{\\{subtype} of right noad representing \.{%
\\middle}}\par
\P\D \37$\\{scripts\_allowed}(\#)\S(\\{type}(\#)\G\\{ord\_noad})\W(\\{type}(%
\#)<\\{left\_noad})$\par
\fi

\M864. Math formulas can also contain instructions like \.{\\textstyle} that
override \TeX's normal style rules. A \\{style\_node} is inserted into the
data structure to record such instructions; it is three words long, so it
is considered a node instead of a noad. The \\{subtype} is either \\{display%
\_style}
or \\{text\_style} or \\{script\_style} or \\{script\_script\_style}. The
second and third words of a \\{style\_node} are not used, but they are
present because a \\{choice\_node} is converted to a \\{style\_node}.

\TeX\ uses even numbers 0, 2, 4, 6 to encode the basic styles
\\{display\_style}, \dots, \\{script\_script\_style}, and adds~1 to get the
``cramped'' versions of these styles. This gives a numerical order that
is backwards from the convention of Appendix~G in {\sl The \TeX book\/};
i.e., a smaller style has a larger numerical value.

\Y\P\D \37$\\{style\_node}=\\{unset\_node}+1$\C{\\{type} of a style node}\par
\P\D \37$\\{style\_node\_size}=3$\C{number of words in a style node}\par
\P\D \37$\\{display\_style}=0$\C{\\{subtype} for \.{\\displaystyle}}\par
\P\D \37$\\{text\_style}=2$\C{\\{subtype} for \.{\\textstyle}}\par
\P\D \37$\\{script\_style}=4$\C{\\{subtype} for \.{\\scriptstyle}}\par
\P\D \37$\\{script\_script\_style}=6$\C{\\{subtype} for \.{%
\\scriptscriptstyle}}\par
\P\D \37$\\{cramped}=1$\C{add this to an uncramped style if you want to cramp
it}\par
\Y\P\4\&{function}\1\  \37$\\{new\_style}(\|s:\\{small\_number})$: \37%
\\{pointer};\C{create a style node}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{style\_node\_size})$;\5
$\\{type}(\|p)\K\\{style\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\5
$\\{width}(\|p)\K0$;\5
$\\{depth}(\|p)\K0$;\C{the \\{width} and \\{depth} are not used}\6
$\\{new\_style}\K\|p$;\6
\&{end};\par
\fi

\M865. Finally, the \.{\\mathchoice} primitive creates a \\{choice\_node},
which
has special subfields \\{display\_mlist}, \\{text\_mlist}, \\{script\_mlist},
and \\{script\_script\_mlist} pointing to the mlists for each style.

\Y\P\D \37$\\{choice\_node}=\\{unset\_node}+2$\C{\\{type} of a choice node}\par
\P\D \37$\\{display\_mlist}(\#)\S\\{info}(\#+1)$\C{mlist to be used in display
style}\par
\P\D \37$\\{text\_mlist}(\#)\S\\{link}(\#+1)$\C{mlist to be used in text style}%
\par
\P\D \37$\\{script\_mlist}(\#)\S\\{info}(\#+2)$\C{mlist to be used in script
style}\par
\P\D \37$\\{script\_script\_mlist}(\#)\S\\{link}(\#+2)$\C{mlist to be used in
scriptscript style}\par
\Y\P\4\&{function}\1\  \37\\{new\_choice}: \37\\{pointer};\C{create a choice
node}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{style\_node\_size})$;\5
$\\{type}(\|p)\K\\{choice\_node}$;\5
$\\{subtype}(\|p)\K0$;\C{the \\{subtype} is not used}\6
$\\{display\_mlist}(\|p)\K\\{null}$;\5
$\\{text\_mlist}(\|p)\K\\{null}$;\5
$\\{script\_mlist}(\|p)\K\\{null}$;\5
$\\{script\_script\_mlist}(\|p)\K\\{null}$;\5
$\\{new\_choice}\K\|p$;\6
\&{end};\par
\fi

\M866. Let's consider now the previously unwritten part of \\{show\_node\_list}
that displays the things that can only be present in mlists; this
program illustrates how to access the data structures just defined.

In the context of the following program, \|p points to a node or noad that
should be displayed, and the current string contains the ``recursion history''
that leads to this point. The recursion history consists of a dot for each
outer level in which \|p is subsidiary to some node, or in which \|p is
subsidiary to the \\{nucleus} field of some noad; the dot is replaced by
`\.\_' or `\.\^' or `\./' or `\.\\' if \|p is descended from the \\{subscr}
or \\{supscr} or \\{denominator} or \\{numerator} fields of noads. For example,
the current string would be `\.{.\^.\_/}' if \|p points to the \\{ord\_noad}
for
\|x in the (ridiculous) formula
`\.{\$\\sqrt\{a\^\{\\mathinner\{b\_\{c\\over x+y\}\}\}\}\$}'.

\Y\P$\4\X866:Cases of \\{show\_node\_list} that arise in mlists only\X\S$\6
\4\\{style\_node}: \37$\\{print\_style}(\\{subtype}(\|p))$;\6
\4\\{choice\_node}: \37\X871:Display choice node \|p\X;\6
\4$\\{ord\_noad},\39\\{op\_noad},\39\\{bin\_noad},\39\\{rel\_noad},\39\\{open%
\_noad},\39\\{close\_noad},\39\\{punct\_noad},\39\\{inner\_noad},\39\\{radical%
\_noad},\39\\{over\_noad},\39\\{under\_noad},\39\\{vcenter\_noad},\39\\{accent%
\_noad},\39\\{left\_noad},\39\\{right\_noad}$: \37\X872:Display normal noad \|p%
\X;\6
\4\\{fraction\_noad}: \37\X873:Display fraction noad \|p\X;\par
\U201.\fi

\M867. Here are some simple routines used in the display of noads.

\Y\P$\4\X867:Declare procedures needed for displaying the elements of mlists\X%
\S$\6
\4\&{procedure}\1\  \37$\\{print\_fam\_and\_char}(\|p:\\{pointer})$;\C{prints
family and character}\2\6
\&{begin} \37$\\{print\_esc}(\.{"fam"})$;\5
$\\{print\_int}(\\{fam}(\|p))$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_ASCII}(\\{qo}(\\{character}(\|p)))$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{print\_delimiter}(\|p:\\{pointer})$;\C{prints a
delimiter as 24-bit hex value}\6
\4\&{var} \37\|a: \37\\{integer};\C{accumulator}\2\6
\&{begin} \37$\|a\K\\{small\_fam}(\|p)\ast256+\\{qo}(\\{small\_char}(\|p))$;\5
$\|a\K\|a\ast\H{1000}+\\{large\_fam}(\|p)\ast256+\\{qo}(\\{large\_char}(\|p))$;%
\6
\&{if} $\|a<0$ \1\&{then}\5
$\\{print\_int}(\|a)$\C{this should never happen}\6
\4\&{else} $\\{print\_hex}(\|a)$;\2\6
\&{end};\par
\As868\ET870.
\U197.\fi

\M868. The next subroutine will descend to another level of recursion when a
subsidiary mlist needs to be displayed. The parameter \|c indicates what
character is to become part of the recursion history. An empty mlist is
distinguished from a field with $\\{math\_type}(\|p)=\\{empty}$, because these
are
not equivalent (as explained above).

\Y\P$\4\X867:Declare procedures needed for displaying the elements of mlists\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{show\_info};\5
\\{forward};\5
\hbox{\2}\C{$\\{show\_node\_list}(\\{info}(\\{temp\_ptr}))$}\6
\4\&{procedure}\1\  \37$\\{print\_subsidiary\_data}(\|p:\\{pointer};\,\35\|c:%
\\{ASCII\_code})$;\C{display a noad field}\2\6
\&{begin} \37\&{if} $\\{cur\_length}\G\\{depth\_threshold}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{math\_type}(\|p)\I\\{empty}$ \1\&{then}\5
$\\{print}(\.{"\ []"})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{append\_char}(\|c)$;\C{include \|c in the recursion
history}\6
$\\{temp\_ptr}\K\|p$;\C{prepare for \\{show\_info} if recursion is needed}\6
\&{case} $\\{math\_type}(\|p)$ \1\&{of}\6
\4\\{math\_char}: \37\&{begin} \37\\{print\_ln};\5
\\{print\_current\_string};\5
$\\{print\_fam\_and\_char}(\|p)$;\6
\&{end};\6
\4\\{sub\_box}: \37\\{show\_info};\C{recursive call}\6
\4\\{sub\_mlist}: \37\&{if} $\\{info}(\|p)=\\{null}$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\5
\\{print\_current\_string};\5
$\\{print}(\.{"\{\}"})$;\6
\&{end}\6
\4\&{else} \\{show\_info};\C{recursive call}\2\6
\4\&{othercases} \37\\{do\_nothing}\C{\\{empty}}\2\6
\&{endcases};\6
\\{flush\_char};\C{remove \|c from the recursion history}\6
\&{end};\2\6
\&{end};\par
\fi

\M869. The inelegant introduction of \\{show\_info} in the code above seems
better
than the alternative of using \PASCAL's strange \\{forward} declaration for a
procedure with parameters. The \PASCAL\ convention about dropping parameters
from a post-\\{forward} procedure is, frankly, so intolerable to the author
of \TeX\ that he would rather stoop to communication via a global temporary
variable. (A similar stupidity occurred with respect to \\{hlist\_out} and
\\{vlist\_out} above, and it will occur with respect to \\{mlist\_to\_hlist}
below.)

\Y\P\4\&{procedure}\1\  \37\\{show\_info};\C{the reader will kindly forgive
this}\2\6
\&{begin} \37$\\{show\_node\_list}(\\{info}(\\{temp\_ptr}))$;\6
\&{end};\par
\fi

\M870. \P$\X867:Declare procedures needed for displaying the elements of mlists%
\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_style}(\|c:\\{integer})$;\2\6
\&{begin} \37\&{case} $\|c\mathbin{\&{div}}2$ \1\&{of}\6
\40: \37$\\{print\_esc}(\.{"displaystyle"})$;\C{$\\{display\_style}=0$}\6
\41: \37$\\{print\_esc}(\.{"textstyle"})$;\C{$\\{text\_style}=2$}\6
\42: \37$\\{print\_esc}(\.{"scriptstyle"})$;\C{$\\{script\_style}=4$}\6
\43: \37$\\{print\_esc}(\.{"scriptscriptstyle"})$;\C{$\\{script\_script%
\_style}=6$}\6
\4\&{othercases} \37$\\{print}(\.{"Unknown\ style!"})$\2\6
\&{endcases};\6
\&{end};\par
\fi

\M871. \P$\X871:Display choice node \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"mathchoice"})$;\5
$\\{append\_char}(\.{"D"})$;\5
$\\{show\_node\_list}(\\{display\_mlist}(\|p))$;\5
\\{flush\_char};\5
$\\{append\_char}(\.{"T"})$;\5
$\\{show\_node\_list}(\\{text\_mlist}(\|p))$;\5
\\{flush\_char};\5
$\\{append\_char}(\.{"S"})$;\5
$\\{show\_node\_list}(\\{script\_mlist}(\|p))$;\5
\\{flush\_char};\5
$\\{append\_char}(\.{"s"})$;\5
$\\{show\_node\_list}(\\{script\_script\_mlist}(\|p))$;\5
\\{flush\_char};\6
\&{end}\par
\U866.\fi

\M872. \P$\X872:Display normal noad \|p\X\S$\6
\&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4\\{ord\_noad}: \37$\\{print\_esc}(\.{"mathord"})$;\6
\4\\{op\_noad}: \37$\\{print\_esc}(\.{"mathop"})$;\6
\4\\{bin\_noad}: \37$\\{print\_esc}(\.{"mathbin"})$;\6
\4\\{rel\_noad}: \37$\\{print\_esc}(\.{"mathrel"})$;\6
\4\\{open\_noad}: \37$\\{print\_esc}(\.{"mathopen"})$;\6
\4\\{close\_noad}: \37$\\{print\_esc}(\.{"mathclose"})$;\6
\4\\{punct\_noad}: \37$\\{print\_esc}(\.{"mathpunct"})$;\6
\4\\{inner\_noad}: \37$\\{print\_esc}(\.{"mathinner"})$;\6
\4\\{over\_noad}: \37$\\{print\_esc}(\.{"overline"})$;\6
\4\\{under\_noad}: \37$\\{print\_esc}(\.{"underline"})$;\6
\4\\{vcenter\_noad}: \37$\\{print\_esc}(\.{"vcenter"})$;\6
\4\\{radical\_noad}: \37\&{begin} \37$\\{print\_esc}(\.{"radical"})$;\5
$\\{print\_delimiter}(\\{left\_delimiter}(\|p))$;\6
\&{end};\6
\4\\{accent\_noad}: \37\&{begin} \37$\\{print\_esc}(\.{"accent"})$;\5
$\\{print\_fam\_and\_char}(\\{accent\_chr}(\|p))$;\6
\&{end};\6
\4\\{left\_noad}: \37\&{begin} \37$\\{print\_esc}(\.{"left"})$;\5
$\\{print\_delimiter}(\\{delimiter}(\|p))$;\6
\&{end};\6
\4\\{right\_noad}: \37\&{begin} \37\&{if} $\\{subtype}(\|p)=\\{normal}$ \1%
\&{then}\5
$\\{print\_esc}(\.{"right"})$\6
\4\&{else} $\\{print\_esc}(\.{"middle"})$;\2\6
$\\{print\_delimiter}(\\{delimiter}(\|p))$;\6
\&{end};\2\6
\&{end};\6
\&{if} $\\{type}(\|p)<\\{left\_noad}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{subtype}(\|p)\I\\{normal}$ \1\&{then}\6
\&{if} $\\{subtype}(\|p)=\\{limits}$ \1\&{then}\5
$\\{print\_esc}(\.{"limits"})$\6
\4\&{else} $\\{print\_esc}(\.{"nolimits"})$;\2\2\6
$\\{print\_subsidiary\_data}(\\{nucleus}(\|p),\39\.{"."})$;\6
\&{end};\2\6
$\\{print\_subsidiary\_data}(\\{supscr}(\|p),\39\.{"\^"})$;\5
$\\{print\_subsidiary\_data}(\\{subscr}(\|p),\39\.{"\_"})$;\6
\&{end}\par
\U866.\fi

\M873. \P$\X873:Display fraction noad \|p\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"fraction,\ thickness\ "})$;\6
\&{if} $\\{thickness}(\|p)=\\{default\_code}$ \1\&{then}\5
$\\{print}(\.{"=\ default"})$\6
\4\&{else} $\\{print\_scaled}(\\{thickness}(\|p))$;\2\6
\&{if} $(\\{small\_fam}(\\{left\_delimiter}(\|p))\I0)\V$\ $(\\{small\_char}(%
\\{left\_delimiter}(\|p))\I\\{min\_quarterword})\V\30(\\{large\_fam}(\\{left%
\_delimiter}(\|p))\I0)\V\30(\\{large\_char}(\\{left\_delimiter}(\|p))\I\\{min%
\_quarterword})$ \&{then} \6
\&{begin} \37$\\{print}(\.{",\ left-delimiter\ "})$;\5
$\\{print\_delimiter}(\\{left\_delimiter}(\|p))$;\6
\&{end};\6
\&{if} $(\\{small\_fam}(\\{right\_delimiter}(\|p))\I0)\V\30(\\{small\_char}(%
\\{right\_delimiter}(\|p))\I\\{min\_quarterword})\V\30(\\{large\_fam}(\\{right%
\_delimiter}(\|p))\I0)\V\30(\\{large\_char}(\\{right\_delimiter}(\|p))\I\\{min%
\_quarterword})$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{",\ right-delimiter\ "})$;\5
$\\{print\_delimiter}(\\{right\_delimiter}(\|p))$;\6
\&{end};\2\6
$\\{print\_subsidiary\_data}(\\{numerator}(\|p),\39\.{"\\"})$;\5
$\\{print\_subsidiary\_data}(\\{denominator}(\|p),\39\.{"/"})$; \6
\&{end} \par
\U866.\fi

\M874. That which can be displayed can also be destroyed.

\Y\P$\4\X874:Cases of \\{flush\_node\_list} that arise in mlists only\X\S$\6
\4\\{style\_node}: \37\&{begin} \37$\\{free\_node}(\|p,\39\\{style\_node%
\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{choice\_node}: \37\&{begin} \37$\\{flush\_node\_list}(\\{display\_mlist}(%
\|p))$;\5
$\\{flush\_node\_list}(\\{text\_mlist}(\|p))$;\5
$\\{flush\_node\_list}(\\{script\_mlist}(\|p))$;\5
$\\{flush\_node\_list}(\\{script\_script\_mlist}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{style\_node\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4$\\{ord\_noad},\39\\{op\_noad},\39\\{bin\_noad},\39\\{rel\_noad},\39\\{open%
\_noad},\39\\{close\_noad},\39\\{punct\_noad},\39\\{inner\_noad},\39\\{radical%
\_noad},\39\\{over\_noad},\39\\{under\_noad},\39\\{vcenter\_noad},\39\\{accent%
\_noad}$: \37\hbox{}\6
\&{begin} \37\&{if} $\\{math\_type}(\\{nucleus}(\|p))\G\\{sub\_box}$ \1\&{then}%
\5
$\\{flush\_node\_list}(\\{info}(\\{nucleus}(\|p)))$;\2\6
\&{if} $\\{math\_type}(\\{supscr}(\|p))\G\\{sub\_box}$ \1\&{then}\5
$\\{flush\_node\_list}(\\{info}(\\{supscr}(\|p)))$;\2\6
\&{if} $\\{math\_type}(\\{subscr}(\|p))\G\\{sub\_box}$ \1\&{then}\5
$\\{flush\_node\_list}(\\{info}(\\{subscr}(\|p)))$;\2\6
\&{if} $\\{type}(\|p)=\\{radical\_noad}$ \1\&{then}\5
$\\{free\_node}(\|p,\39\\{radical\_noad\_size})$\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{accent\_noad}$ \1\&{then}\5
$\\{free\_node}(\|p,\39\\{accent\_noad\_size})$\6
\4\&{else} $\\{free\_node}(\|p,\39\\{noad\_size})$;\2\2\6
\&{goto} \37\\{done};\6
\&{end};\6
\4$\\{left\_noad},\39\\{right\_noad}$: \37\&{begin} \37$\\{free\_node}(\|p,\39%
\\{noad\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\\{fraction\_noad}: \37\&{begin} \37$\\{flush\_node\_list}(\\{info}(%
\\{numerator}(\|p)))$;\5
$\\{flush\_node\_list}(\\{info}(\\{denominator}(\|p)))$;\5
$\\{free\_node}(\|p,\39\\{fraction\_noad\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\par
\U220.\fi

\N875.  \[35] Subroutines for math mode.
In order to convert mlists to hlists, i.e., noads to nodes, we need several
subroutines that are conveniently dealt with now.

Let us first introduce the macros that make it easy to get at the parameters
and
other font information. A size code, which is a multiple of 16, is added to a
family number to get an index into the table of internal font numbers
for each combination of family and size.  (Be alert: Size codes get
larger as the type gets smaller.)

\Y\P\D \37$\\{text\_size}=0$\C{size code for the largest size in a family}\par
\P\D \37$\\{script\_size}=16$\C{size code for the medium size in a family}\par
\P\D \37$\\{script\_script\_size}=32$\C{size code for the smallest size in a
family}\par
\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_size}(\|s:\\{integer})$;\2\6
\&{begin} \37\&{if} $\|s=\\{text\_size}$ \1\&{then}\5
$\\{print\_esc}(\.{"textfont"})$\6
\4\&{else} \&{if} $\|s=\\{script\_size}$ \1\&{then}\5
$\\{print\_esc}(\.{"scriptfont"})$\6
\4\&{else} $\\{print\_esc}(\.{"scriptscriptfont"})$;\2\2\6
\&{end};\par
\fi

\M876. Before an mlist is converted to an hlist, \TeX\ makes sure that
the fonts in family~2 have enough parameters to be math-symbol
fonts, and that the fonts in family~3 have enough parameters to be
math-extension fonts. The math-symbol parameters are referred to by using the
following macros, which take a size code as their parameter; for example,
$\\{num1}(\\{cur\_size})$ gives the value of the \\{num1} parameter for the
current size.

\Y\P\D \37$\\{mathsy\_end}(\#)\S\\{fam\_fnt}(2+\#)$ ] ] .\\{sc}\par
\P\D $\\{mathsy}(\#)\S\\{font\_info}$ [ $\#+\\{param\_base}$ [ $\\{mathsy%
\_end}$\par
\P\D \37$\\{math\_x\_height}\S\\{mathsy}(5)$\C{height of `\.x'}\par
\P\D \37$\\{math\_quad}\S\\{mathsy}(6)$\C{\.{18mu}}\par
\P\D \37$\\{num1}\S\\{mathsy}(8)$\C{numerator shift-up in display styles}\par
\P\D \37$\\{num2}\S\\{mathsy}(9)$\C{numerator shift-up in non-display, non-\.{%
\\atop}}\par
\P\D \37$\\{num3}\S\\{mathsy}(10)$\C{numerator shift-up in non-display \.{%
\\atop}}\par
\P\D \37$\\{denom1}\S\\{mathsy}(11)$\C{denominator shift-down in display
styles}\par
\P\D \37$\\{denom2}\S\\{mathsy}(12)$\C{denominator shift-down in non-display
styles}\par
\P\D \37$\\{sup1}\S\\{mathsy}(13)$\C{superscript shift-up in uncramped display
style}\par
\P\D \37$\\{sup2}\S\\{mathsy}(14)$\C{superscript shift-up in uncramped
non-display}\par
\P\D \37$\\{sup3}\S\\{mathsy}(15)$\C{superscript shift-up in cramped styles}\par
\P\D \37$\\{sub1}\S\\{mathsy}(16)$\C{subscript shift-down if superscript is
absent}\par
\P\D \37$\\{sub2}\S\\{mathsy}(17)$\C{subscript shift-down if superscript is
present}\par
\P\D \37$\\{sup\_drop}\S\\{mathsy}(18)$\C{superscript baseline below top of
large box}\par
\P\D \37$\\{sub\_drop}\S\\{mathsy}(19)$\C{subscript baseline below bottom of
large box}\par
\P\D \37$\\{delim1}\S\\{mathsy}(20)$\C{size of \.{\\atopwithdelims} delimiters
 in display styles}\par
\P\D \37$\\{delim2}\S\\{mathsy}(21)$\C{size of \.{\\atopwithdelims} delimiters
in non-displays}\par
\P\D \37$\\{axis\_height}\S\\{mathsy}(22)$\C{height of fraction lines above the
baseline}\par
\P\D \37$\\{total\_mathsy\_params}=22$\par
\fi

\M877. The math-extension parameters have similar macros, but the size code is
omitted (since it is always \\{cur\_size} when we refer to such parameters).

\Y\P\D \37$\\{mathex}(\#)\S\\{font\_info}[\#+\\{param\_base}[\\{fam\_fnt}(3+%
\\{cur\_size})]].\\{sc}$\par
\P\D \37$\\{default\_rule\_thickness}\S\\{mathex}(8)$\C{thickness of \.{\\over}
bars}\par
\P\D \37$\\{big\_op\_spacing1}\S\\{mathex}(9)$\C{minimum clearance above a
displayed op}\par
\P\D \37$\\{big\_op\_spacing2}\S\\{mathex}(10)$\C{minimum clearance below a
displayed op}\par
\P\D \37$\\{big\_op\_spacing3}\S\\{mathex}(11)$\C{minimum baselineskip above
displayed op}\par
\P\D \37$\\{big\_op\_spacing4}\S\\{mathex}(12)$\C{minimum baselineskip below
displayed op}\par
\P\D \37$\\{big\_op\_spacing5}\S\\{mathex}(13)$\C{padding above and below
displayed limits}\par
\P\D \37$\\{total\_mathex\_params}=13$\par
\fi

\M878. We also need to compute the change in style between mlists and their
subsidiaries. The following macros define the subsidiary style for
an overlined nucleus (\\{cramped\_style}), for a subscript or a superscript
(\\{sub\_style} or \\{sup\_style}), or for a numerator or denominator (\\{num%
\_style}
or \\{denom\_style}).

\Y\P\D \37$\\{cramped\_style}(\#)\S2\ast(\#\mathbin{\&{div}}2)+\\{cramped}$%
\C{cramp the style}\par
\P\D \37$\\{sub\_style}(\#)\S2\ast(\#\mathbin{\&{div}}4)+\\{script\_style}+%
\\{cramped}$\C{smaller and cramped}\par
\P\D \37$\\{sup\_style}(\#)\S2\ast(\#\mathbin{\&{div}}4)+\\{script\_style}+(\#%
\mathbin{\&{mod}}2)$\C{smaller}\par
\P\D \37$\\{num\_style}(\#)\S\#+2-2\ast(\#\mathbin{\&{div}}6)$\C{smaller unless
already script-script}\par
\P\D \37$\\{denom\_style}(\#)\S2\ast(\#\mathbin{\&{div}}2)+\\{cramped}+2-2\ast(%
\#\mathbin{\&{div}}6)$\C{smaller, cramped}\par
\fi

\M879. When the style changes, the following piece of program computes
associated
information:

\Y\P$\4\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on %
\\{cur\_style}\X\S$\6
\&{begin} \37\&{if} $\\{cur\_style}<\\{script\_style}$ \1\&{then}\5
$\\{cur\_size}\K\\{text\_size}$\6
\4\&{else} $\\{cur\_size}\K16\ast((\\{cur\_style}-\\{text\_style})\mathbin{%
\&{div}}2)$;\2\6
$\\{cur\_mu}\K\\{x\_over\_n}(\\{math\_quad}(\\{cur\_size}),\3918)$;\6
\&{end}\par
\Us896, 902, 903, 906, 930, 936, 938\ETs939.\fi

\M880. Here is a function that returns a pointer to a rule node having a given
thickness \|t. The rule will extend horizontally to the boundary of the vlist
that eventually contains it.

\Y\P\4\&{function}\1\  \37$\\{fraction\_rule}(\|t:\\{scaled})$: \37\\{pointer};%
\C{construct the bar for a fraction}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{new\_rule}$;\5
$\\{height}(\|p)\K\|t$;\5
$\\{depth}(\|p)\K0$;\5
$\\{fraction\_rule}\K\|p$;\6
\&{end};\par
\fi

\M881. The \\{overbar} function returns a pointer to a vlist box that consists
of
a given box \|b, above which has been placed a kern of height \|k under a
fraction rule of thickness \|t under additional space of height \|t.

\Y\P\4\&{function}\1\  \37$\\{overbar}(\|b:\\{pointer};\,\35\|k,\39\|t:%
\\{scaled})$: \37\\{pointer};\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{nodes being constructed}\2\6
\&{begin} \37$\|p\K\\{new\_kern}(\|k)$;\5
$\\{link}(\|p)\K\|b$;\5
$\|q\K\\{fraction\_rule}(\|t)$;\5
$\\{link}(\|q)\K\|p$;\5
$\|p\K\\{new\_kern}(\|t)$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{overbar}\K\\{vpack}(\|p,\39\\{natural})$;\6
\&{end};\par
\fi

\M882. The \\{var\_delimiter} function, which finds or constructs a
sufficiently
large delimiter, is the most interesting of the auxiliary functions that
currently concern us. Given a pointer \|d to a delimiter field in some noad,
together with a size code \|s and a vertical distance \|v, this function
returns a pointer to a box that contains the smallest variant of \|d whose
height plus depth is \|v or more. (And if no variant is large enough, it
returns the largest available variant.) In particular, this routine will
construct arbitrarily large delimiters from extensible components, if
\|d leads to such characters.

The value returned is a box whose \\{shift\_amount} has been set so that
the box is vertically centered with respect to the axis in the given size.
If a built-up symbol is returned, the height of the box before shifting
will be the height of its topmost component.

\Y\P\hbox{\4}\X885:Declare subprocedures for \\{var\_delimiter}\X \6
\4\&{function}\1\  \37$\\{var\_delimiter}(\|d:\\{pointer};\,\35\|s:\\{small%
\_number};\,\35\|v:\\{scaled})$: \37\\{pointer};\6
\4\&{label} \37$\\{found},\39\\{continue}$;\6
\4\&{var} \37\|b: \37\\{pointer};\C{the box that will be constructed}\6
$\|f,\39\|g$: \37\\{internal\_font\_number};\C{best-so-far and tentative font
codes}\6
$\|c,\39\|x,\39\|y$: \37\\{quarterword};\C{best-so-far and tentative character
codes}\6
$\|m,\39\|n$: \37\\{integer};\C{the number of extensible pieces}\6
\|u: \37\\{scaled};\C{height-plus-depth of a tentative character}\6
\|w: \37\\{scaled};\C{largest height-plus-depth so far}\6
\|q: \37\\{four\_quarters};\C{character info}\6
\\{hd}: \37\\{eight\_bits};\C{height-depth byte}\6
\|r: \37\\{four\_quarters};\C{extensible pieces}\6
\|z: \37\\{small\_number};\C{runs through font family members}\6
\\{large\_attempt}: \37\\{boolean};\C{are we trying the ``large'' variant?}\2\6
\&{begin} \37$\|f\K\\{null\_font}$;\5
$\|w\K0$;\5
$\\{large\_attempt}\K\\{false}$;\5
$\|z\K\\{small\_fam}(\|d)$;\5
$\|x\K\\{small\_char}(\|d)$;\6
\~ \1\&{loop}\ \&{begin} \37\X883:Look at the variants of $(\|z,\|x)$; set \|f
and \|c whenever a better character is found; \&{goto} \\{found} as soon as a
large enough variant is encountered\X;\6
\&{if} $\\{large\_attempt}$ \1\&{then}\5
\&{goto} \37\\{found};\C{there were none large enough}\2\6
$\\{large\_attempt}\K\\{true}$;\5
$\|z\K\\{large\_fam}(\|d)$;\5
$\|x\K\\{large\_char}(\|d)$;\6
\&{end};\2\6
\4\\{found}: \37\&{if} $\|f\I\\{null\_font}$ \1\&{then}\5
\X886:Make variable \|b point to a box for $(\|f,\|c)$\X\6
\4\&{else} \&{begin} \37$\|b\K\\{new\_null\_box}$;\5
$\\{width}(\|b)\K\\{null\_delimiter\_space}$;\C{use this width if no delimiter
was found}\6
\&{end};\2\6
$\\{shift\_amount}(\|b)\K\\{half}(\\{height}(\|b)-\\{depth}(\|b))-\\{axis%
\_height}(\|s)$;\5
$\\{var\_delimiter}\K\|b$;\6
\&{end};\par
\fi

\M883. The search process is complicated slightly by the facts that some of the
characters might not be present in some of the fonts, and they might not
be probed in increasing order of height.

\Y\P$\4\X883:Look at the variants of $(\|z,\|x)$; set \|f and \|c whenever a
better character is found; \&{goto} \\{found} as soon as a large enough variant
is encountered\X\S$\6
\&{if} $(\|z\I0)\V(\|x\I\\{min\_quarterword})$ \1\&{then}\6
\&{begin} \37$\|z\K\|z+\|s+16$;\6
\1\&{repeat} \37$\|z\K\|z-16$;\5
$\|g\K\\{fam\_fnt}(\|z)$;\6
\&{if} $\|g\I\\{null\_font}$ \1\&{then}\5
\X884:Look at the list of characters starting with \|x in font \|g; set \|f and
\|c whenever a better character is found; \&{goto} \\{found} as soon as a large
enough variant is encountered\X;\2\6
\4\&{until}\5
$\|z<16$;\2\6
\&{end}\2\par
\U882.\fi

\M884. \P$\X884:Look at the list of characters starting with \|x in font \|g;
set \|f and \|c whenever a better character is found; \&{goto} \\{found} as
soon as a large enough variant is encountered\X\S$\6
\&{begin} \37$\|y\K\|x$;\6
\&{if} $(\\{qo}(\|y)\G\\{font\_bc}[\|g])\W(\\{qo}(\|y)\L\\{font\_ec}[\|g])$ \1%
\&{then}\6
\&{begin} \37\\{continue}: \37$\|q\K\\{char\_info}(\|g)(\|y)$;\6
\&{if} $\\{char\_exists}(\|q)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{char\_tag}(\|q)=\\{ext\_tag}$ \1\&{then}\6
\&{begin} \37$\|f\K\|g$;\5
$\|c\K\|y$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
$\\{hd}\K\\{height\_depth}(\|q)$;\5
$\|u\K\\{char\_height}(\|g)(\\{hd})+\\{char\_depth}(\|g)(\\{hd})$;\6
\&{if} $\|u>\|w$ \1\&{then}\6
\&{begin} \37$\|f\K\|g$;\5
$\|c\K\|y$;\5
$\|w\K\|u$;\6
\&{if} $\|u\G\|v$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{end};\2\6
\&{if} $\\{char\_tag}(\|q)=\\{list\_tag}$ \1\&{then}\6
\&{begin} \37$\|y\K\\{rem\_byte}(\|q)$;\5
\&{goto} \37\\{continue};\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\&{end}\par
\U883.\fi

\M885. Here is a subroutine that creates a new box, whose list contains a
single character, and whose width includes the italic correction for
that character. The height or depth of the box will be negative, if
the height or depth of the character is negative; thus, this routine
may deliver a slightly different result than \\{hpack} would produce.

\Y\P$\4\X885:Declare subprocedures for \\{var\_delimiter}\X\S$\6
\4\&{function}\1\  \37$\\{char\_box}(\|f:\\{internal\_font\_number};\,\35\|c:%
\\{quarterword})$: \37\\{pointer};\6
\4\&{var} \37\|q: \37\\{four\_quarters};\5
\\{hd}: \37\\{eight\_bits};\C{\\{height\_depth} byte}\6
$\|b,\39\|p$: \37\\{pointer};\C{the new box and its character node}\2\6
\&{begin} \37$\|q\K\\{char\_info}(\|f)(\|c)$;\5
$\\{hd}\K\\{height\_depth}(\|q)$;\5
$\|b\K\\{new\_null\_box}$;\5
$\\{width}(\|b)\K\\{char\_width}(\|f)(\|q)+\\{char\_italic}(\|f)(\|q)$;\5
$\\{height}(\|b)\K\\{char\_height}(\|f)(\\{hd})$;\5
$\\{depth}(\|b)\K\\{char\_depth}(\|f)(\\{hd})$;\5
$\|p\K\\{get\_avail}$;\5
$\\{character}(\|p)\K\|c$;\5
$\\{font}(\|p)\K\|f$;\5
$\\{list\_ptr}(\|b)\K\|p$;\5
$\\{char\_box}\K\|b$;\6
\&{end};\par
\As887\ET888.
\U882.\fi

\M886. When the following code is executed, $\\{char\_tag}(\|q)$ will be equal
to
\\{ext\_tag} if and only if a built-up symbol is supposed to be returned.

\Y\P$\4\X886:Make variable \|b point to a box for $(\|f,\|c)$\X\S$\6
\&{if} $\\{char\_tag}(\|q)=\\{ext\_tag}$ \1\&{then}\5
\X889:Construct an extensible character in a new box \|b, using recipe $\\{rem%
\_byte}(\|q)$ and font \|f\X\6
\4\&{else} $\|b\K\\{char\_box}(\|f,\39\|c)$\2\par
\U882.\fi

\M887. When we build an extensible character, it's handy to have the
following subroutine, which puts a given character on top
of the characters already in box \|b:

\Y\P$\4\X885:Declare subprocedures for \\{var\_delimiter}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{stack\_into\_box}(\|b:\\{pointer};\,\35\|f:%
\\{internal\_font\_number};\,\35\|c:\\{quarterword})$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{new node placed into \|b}\2\6
\&{begin} \37$\|p\K\\{char\_box}(\|f,\39\|c)$;\5
$\\{link}(\|p)\K\\{list\_ptr}(\|b)$;\5
$\\{list\_ptr}(\|b)\K\|p$;\5
$\\{height}(\|b)\K\\{height}(\|p)$;\6
\&{end};\par
\fi

\M888. Another handy subroutine computes the height plus depth of
a given character:

\Y\P$\4\X885:Declare subprocedures for \\{var\_delimiter}\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{height\_plus\_depth}(\|f:\\{internal\_font\_number};%
\,\35\|c:\\{quarterword})$: \37\\{scaled};\6
\4\&{var} \37\|q: \37\\{four\_quarters};\5
\\{hd}: \37\\{eight\_bits};\C{\\{height\_depth} byte}\2\6
\&{begin} \37$\|q\K\\{char\_info}(\|f)(\|c)$;\5
$\\{hd}\K\\{height\_depth}(\|q)$;\5
$\\{height\_plus\_depth}\K\\{char\_height}(\|f)(\\{hd})+\\{char\_depth}(\|f)(%
\\{hd})$;\6
\&{end};\par
\fi

\M889. \P$\X889:Construct an extensible character in a new box \|b, using
recipe $\\{rem\_byte}(\|q)$ and font \|f\X\S$\6
\&{begin} \37$\|b\K\\{new\_null\_box}$;\5
$\\{type}(\|b)\K\\{vlist\_node}$;\5
$\|r\K\\{font\_info}[\\{exten\_base}[\|f]+\\{rem\_byte}(\|q)].\\{qqqq}$;\6
\X890:Compute the minimum suitable height, \|w, and the corresponding number of
extension steps, \|n; also set $\\{width}(\|b)$\X;\6
$\|c\K\\{ext\_bot}(\|r)$;\6
\&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\5
$\\{stack\_into\_box}(\|b,\39\|f,\39\|c)$;\2\6
$\|c\K\\{ext\_rep}(\|r)$;\6
\&{for} $\|m\K1\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{stack\_into\_box}(\|b,\39\|f,\39\|c)$;\2\6
$\|c\K\\{ext\_mid}(\|r)$;\6
\&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\6
\&{begin} \37$\\{stack\_into\_box}(\|b,\39\|f,\39\|c)$;\5
$\|c\K\\{ext\_rep}(\|r)$;\6
\&{for} $\|m\K1\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{stack\_into\_box}(\|b,\39\|f,\39\|c)$;\2\6
\&{end};\2\6
$\|c\K\\{ext\_top}(\|r)$;\6
\&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\5
$\\{stack\_into\_box}(\|b,\39\|f,\39\|c)$;\2\6
$\\{depth}(\|b)\K\|w-\\{height}(\|b)$;\6
\&{end}\par
\U886.\fi

\M890. The width of an extensible character is the width of the repeatable
module. If this module does not have positive height plus depth,
we don't use any copies of it, otherwise we use as few as possible
(in groups of two if there is a middle part).

\Y\P$\4\X890:Compute the minimum suitable height, \|w, and the corresponding
number of extension steps, \|n; also set $\\{width}(\|b)$\X\S$\6
$\|c\K\\{ext\_rep}(\|r)$;\5
$\|u\K\\{height\_plus\_depth}(\|f,\39\|c)$;\5
$\|w\K0$;\5
$\|q\K\\{char\_info}(\|f)(\|c)$;\5
$\\{width}(\|b)\K\\{char\_width}(\|f)(\|q)+\\{char\_italic}(\|f)(\|q)$;\6
$\|c\K\\{ext\_bot}(\|r)$;\ \&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\5
$\|w\K\|w+\\{height\_plus\_depth}(\|f,\39\|c)$;\2\6
$\|c\K\\{ext\_mid}(\|r)$;\ \&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\5
$\|w\K\|w+\\{height\_plus\_depth}(\|f,\39\|c)$;\2\6
$\|c\K\\{ext\_top}(\|r)$;\ \&{if} $\|c\I\\{min\_quarterword}$ \1\&{then}\5
$\|w\K\|w+\\{height\_plus\_depth}(\|f,\39\|c)$;\2\6
$\|n\K0$;\6
\&{if} $\|u>0$ \1\&{then}\6
\&{while} $\|w<\|v$ \1\&{do}\6
\&{begin} \37$\|w\K\|w+\|u$;\5
$\\{incr}(\|n)$;\6
\&{if} $\\{ext\_mid}(\|r)\I\\{min\_quarterword}$ \1\&{then}\5
$\|w\K\|w+\|u$;\2\6
\&{end}\2\2\par
\U889.\fi

\M891. The next subroutine is much simpler; it is used for numerators and
denominators of fractions as well as for displayed operators and
their limits above and below. It takes a given box~\|b and
changes it so that the new box is centered in a box of width~\|w.
The centering is done by putting \.{\\hss} glue at the left and right
of the list inside \|b, then packaging the new box; thus, the
actual box might not really be centered, if it already contains
infinite glue.

The given box might contain a single character whose italic correction
has been added to the width of the box; in this case a compensating
kern is inserted.

\Y\P\4\&{function}\1\  \37$\\{rebox}(\|b:\\{pointer};\,\35\|w:\\{scaled})$: \37%
\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{temporary register for list manipulation}\6
\|f: \37\\{internal\_font\_number};\C{font in a one-character box}\6
\|v: \37\\{scaled};\C{width of a character without italic correction}\2\6
\&{begin} \37\&{if} $(\\{width}(\|b)\I\|w)\W(\\{list\_ptr}(\|b)\I\\{null})$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{type}(\|b)=\\{vlist\_node}$ \1\&{then}\5
$\|b\K\\{hpack}(\|b,\39\\{natural})$;\2\6
$\|p\K\\{list\_ptr}(\|b)$;\6
\&{if} $(\\{is\_char\_node}(\|p))\W(\\{link}(\|p)=\\{null})$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|p)$;\5
$\|v\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\\{character}(\|p)))$;\6
\&{if} $\|v\I\\{width}(\|b)$ \1\&{then}\5
$\\{link}(\|p)\K\\{new\_kern}(\\{width}(\|b)-\|v)$;\2\6
\&{end};\2\6
$\\{free\_node}(\|b,\39\\{box\_node\_size})$;\5
$\|b\K\\{new\_glue}(\\{ss\_glue})$;\5
$\\{link}(\|b)\K\|p$;\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{link}(\|p)\K\\{new\_glue}(\\{ss\_glue})$;\5
$\\{rebox}\K\\{hpack}(\|b,\39\|w,\39\\{exactly})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{width}(\|b)\K\|w$;\5
$\\{rebox}\K\|b$;\6
\&{end};\2\6
\&{end};\par
\fi

\M892. Here is a subroutine that creates a new glue specification from another
one that is expressed in `\.{mu}', given the value of the math unit.

\Y\P\D \37$\\{mu\_mult}(\#)\S\\{nx\_plus\_y}(\|n,\39\#,\39\\{xn\_over\_d}(\#,%
\39\|f,\39\O{200000}))$\par
\Y\P\4\&{function}\1\  \37$\\{math\_glue}(\|g:\\{pointer};\,\35\|m:%
\\{scaled})$: \37\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new glue specification}\6
\|n: \37\\{integer};\C{integer part of \|m}\6
\|f: \37\\{scaled};\C{fraction part of \|m}\2\6
\&{begin} \37$\|n\K\\{x\_over\_n}(\|m,\39\O{200000})$;\5
$\|f\K\\{remainder}$;\6
\&{if} $\|f<0$ \1\&{then}\6
\&{begin} \37$\\{decr}(\|n)$;\5
$\|f\K\|f+\O{200000}$;\6
\&{end};\2\6
$\|p\K\\{get\_node}(\\{glue\_spec\_size})$;\5
$\\{width}(\|p)\K\\{mu\_mult}(\\{width}(\|g))$;\C{convert \.{mu} to \.{pt}}\6
$\\{stretch\_order}(\|p)\K\\{stretch\_order}(\|g)$;\6
\&{if} $\\{stretch\_order}(\|p)=\\{normal}$ \1\&{then}\5
$\\{stretch}(\|p)\K\\{mu\_mult}(\\{stretch}(\|g))$\6
\4\&{else} $\\{stretch}(\|p)\K\\{stretch}(\|g)$;\2\6
$\\{shrink\_order}(\|p)\K\\{shrink\_order}(\|g)$;\6
\&{if} $\\{shrink\_order}(\|p)=\\{normal}$ \1\&{then}\5
$\\{shrink}(\|p)\K\\{mu\_mult}(\\{shrink}(\|g))$\6
\4\&{else} $\\{shrink}(\|p)\K\\{shrink}(\|g)$;\2\6
$\\{math\_glue}\K\|p$;\6
\&{end};\par
\fi

\M893. The \\{math\_kern} subroutine removes \\{mu\_glue} from a kern node,
given
the value of the math unit.

\Y\P\4\&{procedure}\1\  \37$\\{math\_kern}(\|p:\\{pointer};\,\35\|m:%
\\{scaled})$;\6
\4\&{var} \37\|n: \37\\{integer};\C{integer part of \|m}\6
\|f: \37\\{scaled};\C{fraction part of \|m}\2\6
\&{begin} \37\&{if} $\\{subtype}(\|p)=\\{mu\_glue}$ \1\&{then}\6
\&{begin} \37$\|n\K\\{x\_over\_n}(\|m,\39\O{200000})$;\5
$\|f\K\\{remainder}$;\6
\&{if} $\|f<0$ \1\&{then}\6
\&{begin} \37$\\{decr}(\|n)$;\5
$\|f\K\|f+\O{200000}$;\6
\&{end};\2\6
$\\{width}(\|p)\K\\{mu\_mult}(\\{width}(\|p))$;\5
$\\{subtype}(\|p)\K\\{explicit}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M894. Sometimes it is necessary to destroy an mlist. The following
subroutine empties the current list, assuming that $\\{abs}(\\{mode})=%
\\{mmode}$.

\Y\P\4\&{procedure}\1\  \37\\{flush\_math};\2\6
\&{begin} \37$\\{flush\_node\_list}(\\{link}(\\{head}))$;\5
$\\{flush\_node\_list}(\\{incompleat\_noad})$;\5
$\\{link}(\\{head})\K\\{null}$;\5
$\\{tail}\K\\{head}$;\5
$\\{incompleat\_noad}\K\\{null}$;\6
\&{end};\par
\fi

\N895.  \[36] Typesetting math formulas.
\TeX's most important routine for dealing with formulas is called
\\{mlist\_to\_hlist}.  After a formula has been scanned and represented as an
mlist, this routine converts it to an hlist that can be placed into a box
or incorporated into the text of a paragraph. There are three implicit
parameters, passed in global variables: \\{cur\_mlist} points to the first
node or noad in the given mlist (and it might be \\{null}); \\{cur\_style} is a
style code; and \\{mlist\_penalties} is \\{true} if penalty nodes for potential
line breaks are to be inserted into the resulting hlist. After
\\{mlist\_to\_hlist} has acted, $\\{link}(\\{temp\_head})$ points to the
translated hlist.

Since mlists can be inside mlists, the procedure is recursive. And since this
is not part of \TeX's inner loop, the program has been written in a manner
that stresses compactness over efficiency.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_mlist}: \37\\{pointer};\C{beginning of mlist to be translated}\6
\4\\{cur\_style}: \37\\{small\_number};\C{style code at current place in the
list}\6
\4\\{cur\_size}: \37\\{small\_number};\C{size code corresponding to \\{cur%
\_style}}\6
\4\\{cur\_mu}: \37\\{scaled};\C{the math unit width corresponding to \\{cur%
\_size}}\6
\4\\{mlist\_penalties}: \37\\{boolean};\C{should \\{mlist\_to\_hlist} insert
penalties?}\par
\fi

\M896. The recursion in \\{mlist\_to\_hlist} is due primarily to a subroutine
called \\{clean\_box} that puts a given noad field into a box using a given
math style; \\{mlist\_to\_hlist} can call \\{clean\_box}, which can call
\\{mlist\_to\_hlist}.

The box returned by \\{clean\_box} is ``clean'' in the
sense that its \\{shift\_amount} is zero.

\Y\P\4\&{procedure}\1\  \37\\{mlist\_to\_hlist};\5
\\{forward};\5
\hbox{\2}\6
\4\&{function}\1\  \37$\\{clean\_box}(\|p:\\{pointer};\,\35\|s:\\{small%
\_number})$: \37\\{pointer};\6
\4\&{label} \37\\{found};\6
\4\&{var} \37\|q: \37\\{pointer};\C{beginning of a list to be boxed}\6
\\{save\_style}: \37\\{small\_number};\C{\\{cur\_style} to be restored}\6
\|x: \37\\{pointer};\C{box to be returned}\6
\|r: \37\\{pointer};\C{temporary pointer}\2\6
\&{begin} \37\&{case} $\\{math\_type}(\|p)$ \1\&{of}\6
\4\\{math\_char}: \37\&{begin} \37$\\{cur\_mlist}\K\\{new\_noad}$;\5
$\\{mem}[\\{nucleus}(\\{cur\_mlist})]\K\\{mem}[\|p]$;\6
\&{end};\6
\4\\{sub\_box}: \37\&{begin} \37$\|q\K\\{info}(\|p)$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4\\{sub\_mlist}: \37$\\{cur\_mlist}\K\\{info}(\|p)$;\6
\4\&{othercases} \37\&{begin} \37$\|q\K\\{new\_null\_box}$;\5
\&{goto} \37\\{found};\6
\&{end}\2\6
\&{endcases};\6
$\\{save\_style}\K\\{cur\_style}$;\5
$\\{cur\_style}\K\|s$;\5
$\\{mlist\_penalties}\K\\{false}$;\6
\\{mlist\_to\_hlist};\5
$\|q\K\\{link}(\\{temp\_head})$;\C{recursive call}\6
$\\{cur\_style}\K\\{save\_style}$;\C{restore the style}\6
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\4\\{found}: \37\&{if} $\\{is\_char\_node}(\|q)\V(\|q=\\{null})$ \1\&{then}\5
$\|x\K\\{hpack}(\|q,\39\\{natural})$\6
\4\&{else} \&{if} $(\\{link}(\|q)=\\{null})\W(\\{type}(\|q)\L\\{vlist\_node})%
\W(\\{shift\_amount}(\|q)=0)$ \1\&{then}\5
$\|x\K\|q$\C{it's already clean}\6
\4\&{else} $\|x\K\\{hpack}(\|q,\39\\{natural})$;\2\2\6
\X897:Simplify a trivial box\X;\6
$\\{clean\_box}\K\|x$;\6
\&{end};\par
\fi

\M897. Here we save memory space in a common case.

\Y\P$\4\X897:Simplify a trivial box\X\S$\6
$\|q\K\\{list\_ptr}(\|x)$;\6
\&{if} $\\{is\_char\_node}(\|q)$ \1\&{then}\6
\&{begin} \37$\|r\K\\{link}(\|q)$;\6
\&{if} $\|r\I\\{null}$ \1\&{then}\6
\&{if} $\\{link}(\|r)=\\{null}$ \1\&{then}\6
\&{if} $\R\\{is\_char\_node}(\|r)$ \1\&{then}\6
\&{if} $\\{type}(\|r)=\\{kern\_node}$ \1\&{then}\C{unneeded italic correction}\6
\&{begin} \37$\\{free\_node}(\|r,\39\\{small\_node\_size})$;\5
$\\{link}(\|q)\K\\{null}$;\6
\&{end};\2\2\2\2\6
\&{end}\2\par
\U896.\fi

\M898. It is convenient to have a procedure that converts a \\{math\_char}
field to an ``unpacked'' form. The \\{fetch} routine sets \\{cur\_f}, \\{cur%
\_c},
and \\{cur\_i} to the font code, character code, and character information
bytes of
a given noad field. It also takes care of issuing error messages for
nonexistent characters; in such cases, $\\{char\_exists}(\\{cur\_i})$ will be %
\\{false}
after \\{fetch} has acted, and the field will also have been reset to %
\\{empty}.

\Y\P\4\&{procedure}\1\  \37$\\{fetch}(\|a:\\{pointer})$;\C{unpack the \\{math%
\_char} field \|a}\2\6
\&{begin} \37$\\{cur\_c}\K\\{character}(\|a)$;\5
$\\{cur\_f}\K\\{fam\_fnt}(\\{fam}(\|a)+\\{cur\_size})$;\6
\&{if} $\\{cur\_f}=\\{null\_font}$ \1\&{then}\5
\X899:Complain about an undefined family and set \\{cur\_i} null\X\6
\4\&{else} \&{begin} \37\&{if} $(\\{qo}(\\{cur\_c})\G\\{font\_bc}[\\{cur\_f}])%
\W(\\{qo}(\\{cur\_c})\L\\{font\_ec}[\\{cur\_f}])$ \1\&{then}\5
$\\{cur\_i}\K\\{char\_info}(\\{cur\_f})(\\{cur\_c})$\6
\4\&{else} $\\{cur\_i}\K\\{null\_character}$;\2\6
\&{if} $\R(\\{char\_exists}(\\{cur\_i}))$ \1\&{then}\6
\&{begin} \37$\\{char\_warning}(\\{cur\_f},\39\\{qo}(\\{cur\_c}))$;\5
$\\{math\_type}(\|a)\K\\{empty}$;\5
$\\{cur\_i}\K\\{null\_character}$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M899. \P$\X899:Complain about an undefined family and set \\{cur\_i} null\X\S$%
\6
\&{begin} \37$\\{print\_err}(\.{""})$;\5
$\\{print\_size}(\\{cur\_size})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\\{fam}(\|a))$;\5
$\\{print}(\.{"\ is\ undefined\ (character\ "})$;\5
$\\{print\_ASCII}(\\{qo}(\\{cur\_c}))$;\5
$\\{print\_char}(\.{")"})$;\5
$\\{help4}(\.{"Somewhere\ in\ the\ math\ formula\ just\ ended,\ you\ used\
the"})$\6
$(\.{"stated\ character\ from\ an\ undefined\ font\ family.\ For\ example,"})$\6
$(\.{"plain\ TeX\ doesn\'t\ allow\ \\it\ or\ \\sl\ in\ subscripts.\
Proceed,"})$\6
$(\.{"and\ I\'ll\ try\ to\ forget\ that\ I\ needed\ that\ character."})$;\5
\\{error};\5
$\\{cur\_i}\K\\{null\_character}$;\5
$\\{math\_type}(\|a)\K\\{empty}$;\6
\&{end}\par
\U898.\fi

\M900. The outputs of \\{fetch} are placed in global variables.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_f}: \37\\{internal\_font\_number};\C{the \\{font} field of a \\{math%
\_char}}\6
\4\\{cur\_c}: \37\\{quarterword};\C{the \\{character} field of a \\{math%
\_char}}\6
\4\\{cur\_i}: \37\\{four\_quarters};\C{the \\{char\_info} of a \\{math\_char},
 or a lig/kern instruction}\par
\fi

\M901. We need to do a lot of different things, so \\{mlist\_to\_hlist} makes
two
passes over the given mlist.

The first pass does most of the processing: It removes ``mu'' spacing from
glue, it recursively evaluates all subsidiary mlists so that only the
top-level mlist remains to be handled, it puts fractions and square roots
and such things into boxes, it attaches subscripts and superscripts, and
it computes the overall height and depth of the top-level mlist so that
the size of delimiters for a \\{left\_noad} and a \\{right\_noad} will be
known.
The hlist resulting from each noad is recorded in that noad's \\{new\_hlist}
field, an integer field that replaces the \\{nucleus} or \\{thickness}.

The second pass eliminates all noads and inserts the correct glue and
penalties between nodes.

\Y\P\D \37$\\{new\_hlist}(\#)\S\\{mem}[\\{nucleus}(\#)].\\{int}$\C{the
translation of an mlist}\par
\fi

\M902. Here is the overall plan of \\{mlist\_to\_hlist}, and the list of its
local variables.

\Y\P\D \37$\\{done\_with\_noad}=80$\C{go here when a noad has been fully
translated}\par
\P\D \37$\\{done\_with\_node}=81$\C{go here when a node has been fully
converted}\par
\P\D \37$\\{check\_dimensions}=82$\C{go here to update \\{max\_h} and \\{max%
\_d}}\par
\P\D \37$\\{delete\_q}=83$\C{go here to delete \|q and move to the next node}%
\par
\Y\P\hbox{\4}\X910:Declare math construction procedures\X \6
\4\&{procedure}\1\  \37\\{mlist\_to\_hlist};\6
\4\&{label} \37$\\{reswitch},\39\\{check\_dimensions},\39\\{done\_with\_noad},%
\39\\{done\_with\_node},\39\\{delete\_q},\39\\{done}$;\6
\4\&{var} \37\\{mlist}: \37\\{pointer};\C{beginning of the given list}\6
\\{penalties}: \37\\{boolean};\C{should penalty nodes be inserted?}\6
\\{style}: \37\\{small\_number};\C{the given style}\6
\\{save\_style}: \37\\{small\_number};\C{holds \\{cur\_style} during recursion}%
\6
\|q: \37\\{pointer};\C{runs through the mlist}\6
\|r: \37\\{pointer};\C{the most recent noad preceding \|q}\6
\\{r\_type}: \37\\{small\_number};\C{the \\{type} of noad \|r, or \\{op\_noad}
if $\|r=\\{null}$}\6
\|t: \37\\{small\_number};\C{the effective \\{type} of noad \|q during the
second pass}\6
$\|p,\39\|x,\39\|y,\39\|z$: \37\\{pointer};\C{temporary registers for list
construction}\6
\\{pen}: \37\\{integer};\C{a penalty to be inserted}\6
\|s: \37\\{small\_number};\C{the size of a noad to be deleted}\6
$\\{max\_h},\39\\{max\_d}$: \37\\{scaled};\C{maximum height and depth of the
list translated so far}\6
\\{delta}: \37\\{scaled};\C{offset between subscript and superscript}\2\6
\&{begin} \37$\\{mlist}\K\\{cur\_mlist}$;\5
$\\{penalties}\K\\{mlist\_penalties}$;\5
$\\{style}\K\\{cur\_style}$;\C{tuck global parameters away as local variables}\6
$\|q\K\\{mlist}$;\5
$\|r\K\\{null}$;\5
$\\{r\_type}\K\\{op\_noad}$;\5
$\\{max\_h}\K0$;\5
$\\{max\_d}\K0$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\5
\X903:Process node-or-noad \|q as much as possible in preparation for the
second pass of \\{mlist\_to\_hlist}, then move to the next item in the mlist\X;%
\2\6
\X905:Convert \(a)a final \\{bin\_noad} to an \\{ord\_noad}\X;\6
\X936:Make a second pass over the mlist, removing all noads and inserting the
proper spacing and penalties\X;\6
\&{end};\par
\fi

\M903. We use the fact that no character nodes appear in an mlist, hence
the field $\\{type}(\|q)$ is always present.

\Y\P$\4\X903:Process node-or-noad \|q as much as possible in preparation for
the second pass of \\{mlist\_to\_hlist}, then move to the next item in the
mlist\X\S$\6
\&{begin} \37\X904:Do first-pass processing based on $\\{type}(\|q)$; \&{goto} %
\\{done\_with\_noad} if a noad has been fully processed, \&{goto} \\{check%
\_dimensions} if it has been translated into $\\{new\_hlist}(\|q)$, or \&{goto}
\\{done\_with\_node} if a node has been fully processed\X;\6
\4\\{check\_dimensions}: \37$\|z\K\\{hpack}(\\{new\_hlist}(\|q),\39%
\\{natural})$;\6
\&{if} $\\{height}(\|z)>\\{max\_h}$ \1\&{then}\5
$\\{max\_h}\K\\{height}(\|z)$;\2\6
\&{if} $\\{depth}(\|z)>\\{max\_d}$ \1\&{then}\5
$\\{max\_d}\K\\{depth}(\|z)$;\2\6
$\\{free\_node}(\|z,\39\\{box\_node\_size})$;\6
\4\\{done\_with\_noad}: \37$\|r\K\|q$;\5
$\\{r\_type}\K\\{type}(\|r)$;\6
\&{if} $\\{r\_type}=\\{right\_noad}$ \1\&{then}\6
\&{begin} \37$\\{r\_type}\K\\{left\_noad}$;\5
$\\{cur\_style}\K\\{style}$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\&{end};\2\6
\4\\{done\_with\_node}: \37$\|q\K\\{link}(\|q)$;\6
\&{end}\par
\U902.\fi

\M904. One of the things we must do on the first pass is change a \\{bin\_noad}
to
an \\{ord\_noad} if the \\{bin\_noad} is not in the context of a binary
operator.
The values of \|r and \\{r\_type} make this fairly easy.

\Y\P$\4\X904:Do first-pass processing based on $\\{type}(\|q)$; \&{goto} %
\\{done\_with\_noad} if a noad has been fully processed, \&{goto} \\{check%
\_dimensions} if it has been translated into $\\{new\_hlist}(\|q)$, or \&{goto}
\\{done\_with\_node} if a node has been fully processed\X\S$\6
\4\\{reswitch}: \37$\\{delta}\K0$;\6
\&{case} $\\{type}(\|q)$ \1\&{of}\6
\4\\{bin\_noad}: \37\&{case} $\\{r\_type}$ \1\&{of}\6
\4$\\{bin\_noad},\39\\{op\_noad},\39\\{rel\_noad},\39\\{open\_noad},\39\\{punct%
\_noad},\39\\{left\_noad}$: \37\&{begin} \37$\\{type}(\|q)\K\\{ord\_noad}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\6
\4\&{othercases} \37\\{do\_nothing}\2\6
\&{endcases};\6
\4$\\{rel\_noad},\39\\{close\_noad},\39\\{punct\_noad},\39\\{right\_noad}$: \37%
\&{begin} \37\hbox{}\6
\X905:Convert \(a)a final \\{bin\_noad} to an \\{ord\_noad}\X;\6
\&{if} $\\{type}(\|q)=\\{right\_noad}$ \1\&{then}\5
\&{goto} \37\\{done\_with\_noad};\2\6
\&{end};\6
\hbox{\4}\X909:Cases for noads that can follow a \\{bin\_noad}\X\6
\hbox{\4}\X906:Cases for nodes that can appear in an mlist, after which we %
\&{goto} \\{done\_with\_node}\X\6
\4\&{othercases} \37$\\{confusion}(\.{"mlist1"})$\2\6
\&{endcases};\6
\X930:Convert \(n)$\\{nucleus}(\|q)$ to an hlist and attach the
sub/superscripts\X\par
\U903.\fi

\M905. \P$\X905:Convert \(a)a final \\{bin\_noad} to an \\{ord\_noad}\X\S$\6
\&{if} $\\{r\_type}=\\{bin\_noad}$ \1\&{then}\5
$\\{type}(\|r)\K\\{ord\_noad}$\2\par
\Us902\ET904.\fi

\M906. \P$\X906:Cases for nodes that can appear in an mlist, after which we %
\&{goto} \\{done\_with\_node}\X\S$\6
\4\\{style\_node}: \37\&{begin} \37$\\{cur\_style}\K\\{subtype}(\|q)$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\&{goto} \37\\{done\_with\_node};\6
\&{end};\6
\4\\{choice\_node}: \37\X907:Change this node to a style node followed by the
correct choice, then \&{goto} \\{done\_with\_node}\X;\6
\4$\\{ins\_node},\39\\{mark\_node},\39\\{adjust\_node},\39\\{whatsit\_node},\39%
\\{penalty\_node},\39\\{disc\_node}$: \37\&{goto} \37\\{done\_with\_node};\6
\4\\{rule\_node}: \37\&{begin} \37\&{if} $\\{height}(\|q)>\\{max\_h}$ \1%
\&{then}\5
$\\{max\_h}\K\\{height}(\|q)$;\2\6
\&{if} $\\{depth}(\|q)>\\{max\_d}$ \1\&{then}\5
$\\{max\_d}\K\\{depth}(\|q)$;\2\6
\&{goto} \37\\{done\_with\_node};\6
\&{end};\6
\4\\{glue\_node}: \37\&{begin} \37\X908:Convert \(m)math glue to ordinary glue%
\X;\6
\&{goto} \37\\{done\_with\_node};\6
\&{end};\6
\4\\{kern\_node}: \37\&{begin} \37$\\{math\_kern}(\|q,\39\\{cur\_mu})$;\5
\&{goto} \37\\{done\_with\_node};\6
\&{end};\par
\U904.\fi

\M907. \P\D \37$\\{choose\_mlist}(\#)\S$\1\6
\&{begin} \37$\|p\K\#(\|q)$;\5
$\#(\|q)\K\\{null}$;\ \&{end}\2\par
\Y\P$\4\X907:Change this node to a style node followed by the correct choice,
then \&{goto} \\{done\_with\_node}\X\S$\6
\&{begin} \37\&{case} $\\{cur\_style}\mathbin{\&{div}}2$ \1\&{of}\6
\40: \37$\\{choose\_mlist}(\\{display\_mlist})$;\C{$\\{display\_style}=0$}\6
\41: \37$\\{choose\_mlist}(\\{text\_mlist})$;\C{$\\{text\_style}=2$}\6
\42: \37$\\{choose\_mlist}(\\{script\_mlist})$;\C{$\\{script\_style}=4$}\6
\43: \37$\\{choose\_mlist}(\\{script\_script\_mlist})$;\C{$\\{script\_script%
\_style}=6$}\2\6
\&{end};\C{there are no other cases}\6
$\\{flush\_node\_list}(\\{display\_mlist}(\|q))$;\5
$\\{flush\_node\_list}(\\{text\_mlist}(\|q))$;\5
$\\{flush\_node\_list}(\\{script\_mlist}(\|q))$;\5
$\\{flush\_node\_list}(\\{script\_script\_mlist}(\|q))$;\6
$\\{type}(\|q)\K\\{style\_node}$;\5
$\\{subtype}(\|q)\K\\{cur\_style}$;\5
$\\{width}(\|q)\K0$;\5
$\\{depth}(\|q)\K0$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|z\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\|p$;\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{link}(\|p)\K\|z$;\6
\&{end};\2\6
\&{goto} \37\\{done\_with\_node};\6
\&{end}\par
\U906.\fi

\M908. Conditional math glue (`\.{\\nonscript}') results in a \\{glue\_node}
pointing to \\{zero\_glue}, with $\\{subtype}(\|q)=\\{cond\_math\_glue}$; in
such a case
the node following will be eliminated if it is a glue or kern node and if the
current size is different from \\{text\_size}. Unconditional math glue
(`\.{\\muskip}') is converted to normal glue by multiplying the dimensions
by \\{cur\_mu}.

\Y\P$\4\X908:Convert \(m)math glue to ordinary glue\X\S$\6
\&{if} $\\{subtype}(\|q)=\\{mu\_glue}$ \1\&{then}\6
\&{begin} \37$\|x\K\\{glue\_ptr}(\|q)$;\5
$\|y\K\\{math\_glue}(\|x,\39\\{cur\_mu})$;\5
$\\{delete\_glue\_ref}(\|x)$;\5
$\\{glue\_ptr}(\|q)\K\|y$;\5
$\\{subtype}(\|q)\K\\{normal}$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{cur\_size}\I\\{text\_size})\W(\\{subtype}(\|q)=\\{cond%
\_math\_glue})$ \1\&{then}\6
\&{begin} \37$\|p\K\\{link}(\|q)$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $(\\{type}(\|p)=\\{glue\_node})\V(\\{type}(\|p)=\\{kern\_node})$ \1%
\&{then}\6
\&{begin} \37$\\{link}(\|q)\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\\{flush\_node\_list}(\|p)$;\6
\&{end};\2\2\6
\&{end}\2\2\par
\U906.\fi

\M909. \P$\X909:Cases for noads that can follow a \\{bin\_noad}\X\S$\6
\4\\{left\_noad}: \37\&{goto} \37\\{done\_with\_noad};\6
\4\\{fraction\_noad}: \37\&{begin} \37$\\{make\_fraction}(\|q)$;\5
\&{goto} \37\\{check\_dimensions};\6
\&{end};\6
\4\\{op\_noad}: \37\&{begin} \37$\\{delta}\K\\{make\_op}(\|q)$;\6
\&{if} $\\{subtype}(\|q)=\\{limits}$ \1\&{then}\5
\&{goto} \37\\{check\_dimensions};\2\6
\&{end};\6
\4\\{ord\_noad}: \37$\\{make\_ord}(\|q)$;\6
\4$\\{open\_noad},\39\\{inner\_noad}$: \37\\{do\_nothing};\6
\4\\{radical\_noad}: \37$\\{make\_radical}(\|q)$;\6
\4\\{over\_noad}: \37$\\{make\_over}(\|q)$;\6
\4\\{under\_noad}: \37$\\{make\_under}(\|q)$;\6
\4\\{accent\_noad}: \37$\\{make\_math\_accent}(\|q)$;\6
\4\\{vcenter\_noad}: \37$\\{make\_vcenter}(\|q)$;\par
\U904.\fi

\M910. Most of the actual construction work of \\{mlist\_to\_hlist} is done
by procedures with names
like \\{make\_fraction}, \\{make\_radical}, etc. To illustrate
the general setup of such procedures, let's begin with a couple of
simple ones.

\Y\P$\4\X910:Declare math construction procedures\X\S$\6
\4\&{procedure}\1\  \37$\\{make\_over}(\|q:\\{pointer})$;\2\6
\&{begin} \37$\\{info}(\\{nucleus}(\|q))\K\30\\{overbar}(\\{clean\_box}(%
\\{nucleus}(\|q),\39\\{cramped\_style}(\\{cur\_style})),\39\303\ast\\{default%
\_rule\_thickness},\39\\{default\_rule\_thickness})$;\5
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\6
\&{end};\par
\As911, 912, 913, 914, 919, 925, 928, 932\ETs938.
\U902.\fi

\M911. \P$\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_under}(\|q:\\{pointer})$;\6
\4\&{var} \37$\|p,\39\|x,\39\|y$: \37\\{pointer};\C{temporary registers for box
construction}\6
\\{delta}: \37\\{scaled};\C{overall height plus depth}\2\6
\&{begin} \37$\|x\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cur\_style})$;\5
$\|p\K\\{new\_kern}(3\ast\\{default\_rule\_thickness})$;\5
$\\{link}(\|x)\K\|p$;\5
$\\{link}(\|p)\K\\{fraction\_rule}(\\{default\_rule\_thickness})$;\5
$\|y\K\\{vpack}(\|x,\39\\{natural})$;\5
$\\{delta}\K\\{height}(\|y)+\\{depth}(\|y)+\\{default\_rule\_thickness}$;\5
$\\{height}(\|y)\K\\{height}(\|x)$;\5
$\\{depth}(\|y)\K\\{delta}-\\{height}(\|y)$;\5
$\\{info}(\\{nucleus}(\|q))\K\|y$;\5
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\6
\&{end};\par
\fi

\M912. \P$\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_vcenter}(\|q:\\{pointer})$;\6
\4\&{var} \37\|v: \37\\{pointer};\C{the box that should be centered vertically}%
\6
\\{delta}: \37\\{scaled};\C{its height plus depth}\2\6
\&{begin} \37$\|v\K\\{info}(\\{nucleus}(\|q))$;\6
\&{if} $\\{type}(\|v)\I\\{vlist\_node}$ \1\&{then}\5
$\\{confusion}(\.{"vcenter"})$;\2\6
$\\{delta}\K\\{height}(\|v)+\\{depth}(\|v)$;\5
$\\{height}(\|v)\K\\{axis\_height}(\\{cur\_size})+\\{half}(\\{delta})$;\5
$\\{depth}(\|v)\K\\{delta}-\\{height}(\|v)$;\6
\&{end};\par
\fi

\M913. According to the rules in the \.{DVI} file specifications, we ensure
alignment
between a square root sign and the rule above its nucleus by assuming that the
baseline of the square-root symbol is the same as the bottom of the rule. The
height of the square-root symbol will be the thickness of the rule, and the
depth of the square-root symbol should exceed or equal the height-plus-depth
of the nucleus plus a certain minimum clearance~\\{clr}. The symbol will be
placed so that the actual clearance is \\{clr} plus half the excess.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_radical}(\|q:\\{pointer})$;\6
\4\&{var} \37$\|x,\39\|y$: \37\\{pointer};\C{temporary registers for box
construction}\6
$\\{delta},\39\\{clr}$: \37\\{scaled};\C{dimensions involved in the
calculation}\2\6
\&{begin} \37$\|x\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cramped\_style}(\\{cur%
\_style}))$;\6
\&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\C{display style}\6
$\\{clr}\K\\{default\_rule\_thickness}+(\\{abs}(\\{math\_x\_height}(\\{cur%
\_size}))\mathbin{\&{div}}4)$\6
\4\&{else} \&{begin} \37$\\{clr}\K\\{default\_rule\_thickness}$;\5
$\\{clr}\K\\{clr}+(\\{abs}(\\{clr})\mathbin{\&{div}}4)$;\6
\&{end};\2\6
$\|y\K\\{var\_delimiter}(\\{left\_delimiter}(\|q),\39\\{cur\_size},\39%
\\{height}(\|x)+\\{depth}(\|x)+\\{clr}+\\{default\_rule\_thickness})$;\5
$\\{delta}\K\\{depth}(\|y)-(\\{height}(\|x)+\\{depth}(\|x)+\\{clr})$;\6
\&{if} $\\{delta}>0$ \1\&{then}\5
$\\{clr}\K\\{clr}+\\{half}(\\{delta})$;\C{increase the actual clearance}\2\6
$\\{shift\_amount}(\|y)\K-(\\{height}(\|x)+\\{clr})$;\5
$\\{link}(\|y)\K\\{overbar}(\|x,\39\\{clr},\39\\{height}(\|y))$;\5
$\\{info}(\\{nucleus}(\|q))\K\\{hpack}(\|y,\39\\{natural})$;\5
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\6
\&{end};\par
\fi

\M914. Slants are not considered when placing accents in math mode. The
accenter is
centered over the accentee, and the accent width is treated as zero with
respect to the size of the final box.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_math\_accent}(\|q:\\{pointer})$;\6
\4\&{label} \37$\\{done},\39\\{done1}$;\6
\4\&{var} \37$\|p,\39\|x,\39\|y$: \37\\{pointer};\C{temporary registers for box
construction}\6
\|a: \37\\{integer};\C{address of lig/kern instruction}\6
\|c: \37\\{quarterword};\C{accent character}\6
\|f: \37\\{internal\_font\_number};\C{its font}\6
\|i: \37\\{four\_quarters};\C{its \\{char\_info}}\6
\|s: \37\\{scaled};\C{amount to skew the accent to the right}\6
\|h: \37\\{scaled};\C{height of character being accented}\6
\\{delta}: \37\\{scaled};\C{space to remove between accent and accentee}\6
\|w: \37\\{scaled};\C{width of the accentee, not including sub/superscripts}\2\6
\&{begin} \37$\\{fetch}(\\{accent\_chr}(\|q))$;\6
\&{if} $\\{char\_exists}(\\{cur\_i})$ \1\&{then}\6
\&{begin} \37$\|i\K\\{cur\_i}$;\5
$\|c\K\\{cur\_c}$;\5
$\|f\K\\{cur\_f}$;\6
\X917:Compute the amount of skew\X;\6
$\|x\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cramped\_style}(\\{cur\_style}))$;\5
$\|w\K\\{width}(\|x)$;\5
$\|h\K\\{height}(\|x)$;\5
\X916:Switch to a larger accent if available and appropriate\X;\6
\&{if} $\|h<\\{x\_height}(\|f)$ \1\&{then}\5
$\\{delta}\K\|h$\ \&{else} $\\{delta}\K\\{x\_height}(\|f)$;\2\6
\&{if} $(\\{math\_type}(\\{supscr}(\|q))\I\\{empty})\V(\\{math\_type}(%
\\{subscr}(\|q))\I\\{empty})$ \1\&{then}\6
\&{if} $\\{math\_type}(\\{nucleus}(\|q))=\\{math\_char}$ \1\&{then}\5
\X918:Swap the subscript and superscript into box \|x\X;\2\2\6
$\|y\K\\{char\_box}(\|f,\39\|c)$;\5
$\\{shift\_amount}(\|y)\K\|s+\\{half}(\|w-\\{width}(\|y))$;\5
$\\{width}(\|y)\K0$;\5
$\|p\K\\{new\_kern}(-\\{delta})$;\5
$\\{link}(\|p)\K\|x$;\5
$\\{link}(\|y)\K\|p$;\5
$\|y\K\\{vpack}(\|y,\39\\{natural})$;\5
$\\{width}(\|y)\K\\{width}(\|x)$;\6
\&{if} $\\{height}(\|y)<\|h$ \1\&{then}\5
\X915:Make the height of box \|y equal to \|h\X;\2\6
$\\{info}(\\{nucleus}(\|q))\K\|y$;\5
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M915. \P$\X915:Make the height of box \|y equal to \|h\X\S$\6
\&{begin} \37$\|p\K\\{new\_kern}(\|h-\\{height}(\|y))$;\5
$\\{link}(\|p)\K\\{list\_ptr}(\|y)$;\5
$\\{list\_ptr}(\|y)\K\|p$;\5
$\\{height}(\|y)\K\|h$;\6
\&{end}\par
\U914.\fi

\M916. \P$\X916:Switch to a larger accent if available and appropriate\X\S$\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{char\_tag}(\|i)\I\\{list\_tag}$ \1%
\&{then}\5
\&{goto} \37\\{done};\2\6
$\|y\K\\{rem\_byte}(\|i)$;\5
$\|i\K\\{char\_info}(\|f)(\|y)$;\6
\&{if} $\R\\{char\_exists}(\|i)$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{if} $\\{char\_width}(\|f)(\|i)>\|w$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|c\K\|y$;\6
\&{end};\2\6
\4\\{done}: \37\par
\U914.\fi

\M917. \P$\X917:Compute the amount of skew\X\S$\6
$\|s\K0$;\6
\&{if} $\\{math\_type}(\\{nucleus}(\|q))=\\{math\_char}$ \1\&{then}\6
\&{begin} \37$\\{fetch}(\\{nucleus}(\|q))$;\6
\&{if} $\\{char\_tag}(\\{cur\_i})=\\{lig\_tag}$ \1\&{then}\6
\&{begin} \37$\|a\K\\{lig\_kern\_start}(\\{cur\_f})(\\{cur\_i})$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{if} $\\{skip\_byte}(\\{cur\_i})>\\{stop\_flag}$ \1\&{then}\6
\&{begin} \37$\|a\K\\{lig\_kern\_restart}(\\{cur\_f})(\\{cur\_i})$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{end};\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{qo}(\\{next\_char}(\\{cur\_i}))=\\{skew%
\_char}[\\{cur\_f}]$ \1\&{then}\6
\&{begin} \37\&{if} $\\{op\_byte}(\\{cur\_i})\G\\{kern\_flag}$ \1\&{then}\6
\&{if} $\\{skip\_byte}(\\{cur\_i})\L\\{stop\_flag}$ \1\&{then}\5
$\|s\K\\{char\_kern}(\\{cur\_f})(\\{cur\_i})$;\2\2\6
\&{goto} \37\\{done1};\6
\&{end};\2\6
\&{if} $\\{skip\_byte}(\\{cur\_i})\G\\{stop\_flag}$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
$\|a\K\|a+\\{qo}(\\{skip\_byte}(\\{cur\_i}))+1$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\4\\{done1}: \37\par
\U914.\fi

\M918. \P$\X918:Swap the subscript and superscript into box \|x\X\S$\6
\&{begin} \37$\\{flush\_node\_list}(\|x)$;\5
$\|x\K\\{new\_noad}$;\5
$\\{mem}[\\{nucleus}(\|x)]\K\\{mem}[\\{nucleus}(\|q)]$;\5
$\\{mem}[\\{supscr}(\|x)]\K\\{mem}[\\{supscr}(\|q)]$;\5
$\\{mem}[\\{subscr}(\|x)]\K\\{mem}[\\{subscr}(\|q)]$;\6
$\\{mem}[\\{supscr}(\|q)].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{subscr}(\|q)].\\{hh}\K\\{empty\_field}$;\6
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_mlist}$;\5
$\\{info}(\\{nucleus}(\|q))\K\|x$;\5
$\|x\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cur\_style})$;\5
$\\{delta}\K\\{delta}+\\{height}(\|x)-\|h$;\5
$\|h\K\\{height}(\|x)$;\6
\&{end}\par
\U914.\fi

\M919. The \\{make\_fraction} procedure is a bit different because it sets
$\\{new\_hlist}(\|q)$ directly rather than making a sub-box.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_fraction}(\|q:\\{pointer})$;\6
\4\&{var} \37$\|p,\39\|v,\39\|x,\39\|y,\39\|z$: \37\\{pointer};\C{temporary
registers for box construction}\6
$\\{delta},\39\\{delta1},\39\\{delta2},\39\\{shift\_up},\39\\{shift\_down},\39%
\\{clr}$: \37\\{scaled};\C{dimensions for box calculations}\2\6
\&{begin} \37\&{if} $\\{thickness}(\|q)=\\{default\_code}$ \1\&{then}\5
$\\{thickness}(\|q)\K\\{default\_rule\_thickness}$;\2\6
\X920:Create equal-width boxes \|x and \|z for the numerator and denominator,
and compute the default amounts \\{shift\_up} and \\{shift\_down} by which they
are displaced from the baseline\X;\6
\&{if} $\\{thickness}(\|q)=0$ \1\&{then}\5
\X921:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of no fraction
line\X\6
\4\&{else} \X922:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of a
fraction line\X;\2\6
\X923:Construct a vlist box for the fraction, according to \\{shift\_up} and %
\\{shift\_down}\X;\6
\X924:Put the \(f)fraction into a box with its delimiters, and make $\\{new%
\_hlist}(\|q)$ point to it\X;\6
\&{end};\par
\fi

\M920. \P$\X920:Create equal-width boxes \|x and \|z for the numerator and
denominator, and compute the default amounts \\{shift\_up} and \\{shift\_down}
by which they are displaced from the baseline\X\S$\6
$\|x\K\\{clean\_box}(\\{numerator}(\|q),\39\\{num\_style}(\\{cur\_style}))$;\5
$\|z\K\\{clean\_box}(\\{denominator}(\|q),\39\\{denom\_style}(\\{cur%
\_style}))$;\6
\&{if} $\\{width}(\|x)<\\{width}(\|z)$ \1\&{then}\5
$\|x\K\\{rebox}(\|x,\39\\{width}(\|z))$\6
\4\&{else} $\|z\K\\{rebox}(\|z,\39\\{width}(\|x))$;\2\6
\&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\C{display style}\6
\&{begin} \37$\\{shift\_up}\K\\{num1}(\\{cur\_size})$;\5
$\\{shift\_down}\K\\{denom1}(\\{cur\_size})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{shift\_down}\K\\{denom2}(\\{cur\_size})$;\6
\&{if} $\\{thickness}(\|q)\I0$ \1\&{then}\5
$\\{shift\_up}\K\\{num2}(\\{cur\_size})$\6
\4\&{else} $\\{shift\_up}\K\\{num3}(\\{cur\_size})$;\2\6
\&{end}\2\par
\U919.\fi

\M921. The numerator and denominator must be separated by a certain minimum
clearance, called \\{clr} in the following program. The difference between
\\{clr} and the actual clearance is twice \\{delta}.

\Y\P$\4\X921:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of no
fraction line\X\S$\6
\&{begin} \37\&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\5
$\\{clr}\K7\ast\\{default\_rule\_thickness}$\6
\4\&{else} $\\{clr}\K3\ast\\{default\_rule\_thickness}$;\2\6
$\\{delta}\K\\{half}(\\{clr}-((\\{shift\_up}-\\{depth}(\|x))-(\\{height}(\|z)-%
\\{shift\_down})))$;\6
\&{if} $\\{delta}>0$ \1\&{then}\6
\&{begin} \37$\\{shift\_up}\K\\{shift\_up}+\\{delta}$;\5
$\\{shift\_down}\K\\{shift\_down}+\\{delta}$;\6
\&{end};\2\6
\&{end}\par
\U919.\fi

\M922. In the case of a fraction line, the minimum clearance depends on the
actual
thickness of the line.

\Y\P$\4\X922:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of a
fraction line\X\S$\6
\&{begin} \37\&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\5
$\\{clr}\K3\ast\\{thickness}(\|q)$\6
\4\&{else} $\\{clr}\K\\{thickness}(\|q)$;\2\6
$\\{delta}\K\\{half}(\\{thickness}(\|q))$;\5
$\\{delta1}\K\\{clr}-((\\{shift\_up}-\\{depth}(\|x))-(\\{axis\_height}(\\{cur%
\_size})+\\{delta}))$;\5
$\\{delta2}\K\\{clr}-((\\{axis\_height}(\\{cur\_size})-\\{delta})-(\\{height}(%
\|z)-\\{shift\_down}))$;\6
\&{if} $\\{delta1}>0$ \1\&{then}\5
$\\{shift\_up}\K\\{shift\_up}+\\{delta1}$;\2\6
\&{if} $\\{delta2}>0$ \1\&{then}\5
$\\{shift\_down}\K\\{shift\_down}+\\{delta2}$;\2\6
\&{end}\par
\U919.\fi

\M923. \P$\X923:Construct a vlist box for the fraction, according to \\{shift%
\_up} and \\{shift\_down}\X\S$\6
$\|v\K\\{new\_null\_box}$;\5
$\\{type}(\|v)\K\\{vlist\_node}$;\5
$\\{height}(\|v)\K\\{shift\_up}+\\{height}(\|x)$;\5
$\\{depth}(\|v)\K\\{depth}(\|z)+\\{shift\_down}$;\5
$\\{width}(\|v)\K\\{width}(\|x)$;\C{this also equals $\\{width}(\|z)$}\6
\&{if} $\\{thickness}(\|q)=0$ \1\&{then}\6
\&{begin} \37$\|p\K\\{new\_kern}((\\{shift\_up}-\\{depth}(\|x))-(\\{height}(%
\|z)-\\{shift\_down}))$;\5
$\\{link}(\|p)\K\|z$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|y\K\\{fraction\_rule}(\\{thickness}(\|q))$;\6
$\|p\K\\{new\_kern}((\\{axis\_height}(\\{cur\_size})-\\{delta})-\30(\\{height}(%
\|z)-\\{shift\_down}))$;\6
$\\{link}(\|y)\K\|p$;\5
$\\{link}(\|p)\K\|z$;\6
$\|p\K\\{new\_kern}((\\{shift\_up}-\\{depth}(\|x))-(\\{axis\_height}(\\{cur%
\_size})+\\{delta}))$;\5
$\\{link}(\|p)\K\|y$;\6
\&{end};\2\6
$\\{link}(\|x)\K\|p$;\5
$\\{list\_ptr}(\|v)\K\|x$\par
\U919.\fi

\M924. \P$\X924:Put the \(f)fraction into a box with its delimiters, and make $%
\\{new\_hlist}(\|q)$ point to it\X\S$\6
\&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\5
$\\{delta}\K\\{delim1}(\\{cur\_size})$\6
\4\&{else} $\\{delta}\K\\{delim2}(\\{cur\_size})$;\2\6
$\|x\K\\{var\_delimiter}(\\{left\_delimiter}(\|q),\39\\{cur\_size},\39%
\\{delta})$;\5
$\\{link}(\|x)\K\|v$;\6
$\|z\K\\{var\_delimiter}(\\{right\_delimiter}(\|q),\39\\{cur\_size},\39%
\\{delta})$;\5
$\\{link}(\|v)\K\|z$;\6
$\\{new\_hlist}(\|q)\K\\{hpack}(\|x,\39\\{natural})$\par
\U919.\fi

\M925. If the nucleus of an \\{op\_noad} is a single character, it is to be
centered vertically with respect to the axis, after first being enlarged
(via a character list in the font) if we are in display style.  The normal
convention for placing displayed limits is to put them above and below the
operator in display style.

The italic correction is removed from the character if there is a subscript
and the limits are not being displayed. The \\{make\_op}
routine returns the value that should be used as an offset between
subscript and superscript.

After \\{make\_op} has acted, $\\{subtype}(\|q)$ will be \\{limits} if and only
if
the limits have been set above and below the operator. In that case,
$\\{new\_hlist}(\|q)$ will already contain the desired final box.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{make\_op}(\|q:\\{pointer})$: \37\\{scaled};\6
\4\&{var} \37\\{delta}: \37\\{scaled};\C{offset between subscript and
superscript}\6
$\|p,\39\|v,\39\|x,\39\|y,\39\|z$: \37\\{pointer};\C{temporary registers for
box construction}\6
\|c: \37\\{quarterword};\ \|i: \37\\{four\_quarters};\C{registers for character
examination}\6
$\\{shift\_up},\39\\{shift\_down}$: \37\\{scaled};\C{dimensions for box
calculation}\2\6
\&{begin} \37\&{if} $(\\{subtype}(\|q)=\\{normal})\W(\\{cur\_style}<\\{text%
\_style})$ \1\&{then}\5
$\\{subtype}(\|q)\K\\{limits}$;\2\6
\&{if} $\\{math\_type}(\\{nucleus}(\|q))=\\{math\_char}$ \1\&{then}\6
\&{begin} \37$\\{fetch}(\\{nucleus}(\|q))$;\6
\&{if} $(\\{cur\_style}<\\{text\_style})\W(\\{char\_tag}(\\{cur\_i})=\\{list%
\_tag})$ \1\&{then}\C{make it larger}\6
\&{begin} \37$\|c\K\\{rem\_byte}(\\{cur\_i})$;\5
$\|i\K\\{char\_info}(\\{cur\_f})(\|c)$;\6
\&{if} $\\{char\_exists}(\|i)$ \1\&{then}\6
\&{begin} \37$\\{cur\_c}\K\|c$;\5
$\\{cur\_i}\K\|i$;\5
$\\{character}(\\{nucleus}(\|q))\K\|c$;\6
\&{end};\2\6
\&{end};\2\6
$\\{delta}\K\\{char\_italic}(\\{cur\_f})(\\{cur\_i})$;\5
$\|x\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cur\_style})$;\6
\&{if} $(\\{math\_type}(\\{subscr}(\|q))\I\\{empty})\W(\\{subtype}(\|q)\I%
\\{limits})$ \1\&{then}\5
$\\{width}(\|x)\K\\{width}(\|x)-\\{delta}$;\C{remove italic correction}\2\6
$\\{shift\_amount}(\|x)\K\\{half}(\\{height}(\|x)-\\{depth}(\|x))-\\{axis%
\_height}(\\{cur\_size})$;\C{center vertically}\6
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\5
$\\{info}(\\{nucleus}(\|q))\K\|x$;\6
\&{end}\6
\4\&{else} $\\{delta}\K0$;\2\6
\&{if} $\\{subtype}(\|q)=\\{limits}$ \1\&{then}\5
\X926:Construct a box with limits above and below it, skewed by \\{delta}\X;\2\6
$\\{make\_op}\K\\{delta}$;\6
\&{end};\par
\fi

\M926. The following program builds a vlist box \|v for displayed limits. The
width of the box is not affected by the fact that the limits may be skewed.

\Y\P$\4\X926:Construct a box with limits above and below it, skewed by %
\\{delta}\X\S$\6
\&{begin} \37$\|x\K\\{clean\_box}(\\{supscr}(\|q),\39\\{sup\_style}(\\{cur%
\_style}))$;\5
$\|y\K\\{clean\_box}(\\{nucleus}(\|q),\39\\{cur\_style})$;\5
$\|z\K\\{clean\_box}(\\{subscr}(\|q),\39\\{sub\_style}(\\{cur\_style}))$;\5
$\|v\K\\{new\_null\_box}$;\5
$\\{type}(\|v)\K\\{vlist\_node}$;\5
$\\{width}(\|v)\K\\{width}(\|y)$;\6
\&{if} $\\{width}(\|x)>\\{width}(\|v)$ \1\&{then}\5
$\\{width}(\|v)\K\\{width}(\|x)$;\2\6
\&{if} $\\{width}(\|z)>\\{width}(\|v)$ \1\&{then}\5
$\\{width}(\|v)\K\\{width}(\|z)$;\2\6
$\|x\K\\{rebox}(\|x,\39\\{width}(\|v))$;\5
$\|y\K\\{rebox}(\|y,\39\\{width}(\|v))$;\5
$\|z\K\\{rebox}(\|z,\39\\{width}(\|v))$;\6
$\\{shift\_amount}(\|x)\K\\{half}(\\{delta})$;\5
$\\{shift\_amount}(\|z)\K-\\{shift\_amount}(\|x)$;\5
$\\{height}(\|v)\K\\{height}(\|y)$;\5
$\\{depth}(\|v)\K\\{depth}(\|y)$;\5
\X927:Attach the limits to \|y and adjust $\\{height}(\|v)$, $\\{depth}(\|v)$
to account for their presence\X;\6
$\\{new\_hlist}(\|q)\K\|v$;\6
\&{end}\par
\U925.\fi

\M927. We use \\{shift\_up} and \\{shift\_down} in the following program for
the
amount of glue between the displayed operator \|y and its limits \|x and
\|z. The vlist inside box \|v will consist of \|x followed by \|y followed
by \|z, with kern nodes for the spaces between and around them.

\Y\P$\4\X927:Attach the limits to \|y and adjust $\\{height}(\|v)$, $\\{depth}(%
\|v)$ to account for their presence\X\S$\6
\&{if} $\\{math\_type}(\\{supscr}(\|q))=\\{empty}$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|x,\39\\{box\_node\_size})$;\5
$\\{list\_ptr}(\|v)\K\|y$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{shift\_up}\K\\{big\_op\_spacing3}-\\{depth}(\|x)$;\6
\&{if} $\\{shift\_up}<\\{big\_op\_spacing1}$ \1\&{then}\5
$\\{shift\_up}\K\\{big\_op\_spacing1}$;\2\6
$\|p\K\\{new\_kern}(\\{shift\_up})$;\5
$\\{link}(\|p)\K\|y$;\5
$\\{link}(\|x)\K\|p$;\6
$\|p\K\\{new\_kern}(\\{big\_op\_spacing5})$;\5
$\\{link}(\|p)\K\|x$;\5
$\\{list\_ptr}(\|v)\K\|p$;\5
$\\{height}(\|v)\K\\{height}(\|v)+\\{big\_op\_spacing5}+\\{height}(\|x)+%
\\{depth}(\|x)+\\{shift\_up}$;\6
\&{end};\2\6
\&{if} $\\{math\_type}(\\{subscr}(\|q))=\\{empty}$ \1\&{then}\5
$\\{free\_node}(\|z,\39\\{box\_node\_size})$\6
\4\&{else} \&{begin} \37$\\{shift\_down}\K\\{big\_op\_spacing4}-\\{height}(%
\|z)$;\6
\&{if} $\\{shift\_down}<\\{big\_op\_spacing2}$ \1\&{then}\5
$\\{shift\_down}\K\\{big\_op\_spacing2}$;\2\6
$\|p\K\\{new\_kern}(\\{shift\_down})$;\5
$\\{link}(\|y)\K\|p$;\5
$\\{link}(\|p)\K\|z$;\6
$\|p\K\\{new\_kern}(\\{big\_op\_spacing5})$;\5
$\\{link}(\|z)\K\|p$;\5
$\\{depth}(\|v)\K\\{depth}(\|v)+\\{big\_op\_spacing5}+\\{height}(\|z)+%
\\{depth}(\|z)+\\{shift\_down}$;\6
\&{end}\2\par
\U926.\fi

\M928. A ligature found in a math formula does not create a \\{ligature\_node},
because
there is no question of hyphenation afterwards; the ligature will simply be
stored in an ordinary \\{char\_node}, after residing in an \\{ord\_noad}.

The \\{math\_type} is converted to \\{math\_text\_char} here if we would not
want to
apply an italic correction to the current character unless it belongs
to a math font (i.e., a font with $\\{space}=0$).

No boundary characters enter into these ligatures.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_ord}(\|q:\\{pointer})$;\6
\4\&{label} \37$\\{restart},\39\\{exit}$;\6
\4\&{var} \37\|a: \37\\{integer};\C{address of lig/kern instruction}\6
$\|p,\39\|r$: \37\\{pointer};\C{temporary registers for list manipulation}\2\6
\&{begin} \37\\{restart}: \37\hbox{}\6
\&{if} $\\{math\_type}(\\{subscr}(\|q))=\\{empty}$ \1\&{then}\6
\&{if} $\\{math\_type}(\\{supscr}(\|q))=\\{empty}$ \1\&{then}\6
\&{if} $\\{math\_type}(\\{nucleus}(\|q))=\\{math\_char}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{link}(\|q)$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $(\\{type}(\|p)\G\\{ord\_noad})\W(\\{type}(\|p)\L\\{punct\_noad})$ \1%
\&{then}\6
\&{if} $\\{math\_type}(\\{nucleus}(\|p))=\\{math\_char}$ \1\&{then}\6
\&{if} $\\{fam}(\\{nucleus}(\|p))=\\{fam}(\\{nucleus}(\|q))$ \1\&{then}\6
\&{begin} \37$\\{math\_type}(\\{nucleus}(\|q))\K\\{math\_text\_char}$;\5
$\\{fetch}(\\{nucleus}(\|q))$;\6
\&{if} $\\{char\_tag}(\\{cur\_i})=\\{lig\_tag}$ \1\&{then}\6
\&{begin} \37$\|a\K\\{lig\_kern\_start}(\\{cur\_f})(\\{cur\_i})$;\5
$\\{cur\_c}\K\\{character}(\\{nucleus}(\|p))$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{if} $\\{skip\_byte}(\\{cur\_i})>\\{stop\_flag}$ \1\&{then}\6
\&{begin} \37$\|a\K\\{lig\_kern\_restart}(\\{cur\_f})(\\{cur\_i})$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{end};\2\6
\~ \1\&{loop}\ \&{begin} \37\X929:If instruction \\{cur\_i} is a kern with %
\\{cur\_c}, attach the kern after~\|q; or if it is a ligature with \\{cur\_c},
combine noads \|q and~\|p appropriately; then \&{return} if the cursor has
moved past a noad, or \&{goto} \\{restart}\X;\6
\&{if} $\\{skip\_byte}(\\{cur\_i})\G\\{stop\_flag}$ \1\&{then}\5
\&{return};\2\6
$\|a\K\|a+\\{qo}(\\{skip\_byte}(\\{cur\_i}))+1$;\5
$\\{cur\_i}\K\\{font\_info}[\|a].\\{qqqq}$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\2\2\2\6
\&{end};\2\2\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M929. Note that a ligature between an \\{ord\_noad} and another kind of noad
is replaced by an \\{ord\_noad}, when the two noads collapse into one.
But we could make a parenthesis (say) change shape when it follows
certain letters. Presumably a font designer will define such
ligatures only when this convention makes sense.

\chardef\?='174 % vertical line to indicate character retention

\Y\P$\4\X929:If instruction \\{cur\_i} is a kern with \\{cur\_c}, attach the
kern after~\|q; or if it is a ligature with \\{cur\_c}, combine noads \|q and~%
\|p appropriately; then \&{return} if the cursor has moved past a noad, or %
\&{goto} \\{restart}\X\S$\6
\&{if} $\\{next\_char}(\\{cur\_i})=\\{cur\_c}$ \1\&{then}\6
\&{if} $\\{skip\_byte}(\\{cur\_i})\L\\{stop\_flag}$ \1\&{then}\6
\&{if} $\\{op\_byte}(\\{cur\_i})\G\\{kern\_flag}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{new\_kern}(\\{char\_kern}(\\{cur\_f})(\\{cur\_i}))$;\5
$\\{link}(\|p)\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\|p$;\5
\&{return};\6
\&{end}\6
\4\&{else} \&{begin} \37\\{check\_interrupt};\C{allow a way out of infinite
ligature loop}\6
\&{case} $\\{op\_byte}(\\{cur\_i})$ \1\&{of}\6
\4$\\{qi}(1),\39\\{qi}(5)$: \37$\\{character}(\\{nucleus}(\|q))\K\\{rem\_byte}(%
\\{cur\_i})$;\C{\.{=:\?}, \.{=:\?>}}\6
\4$\\{qi}(2),\39\\{qi}(6)$: \37$\\{character}(\\{nucleus}(\|p))\K\\{rem\_byte}(%
\\{cur\_i})$;\C{\.{\?=:}, \.{\?=:>}}\6
\4$\\{qi}(3),\39\\{qi}(7),\39\\{qi}(11)$: \37\&{begin} \37$\|r\K\\{new\_noad}$;%
\C{\.{\?=:\?}, \.{\?=:\?>}, \.{\?=:\?>>}}\6
$\\{character}(\\{nucleus}(\|r))\K\\{rem\_byte}(\\{cur\_i})$;\5
$\\{fam}(\\{nucleus}(\|r))\K\\{fam}(\\{nucleus}(\|q))$;\6
$\\{link}(\|q)\K\|r$;\5
$\\{link}(\|r)\K\|p$;\6
\&{if} $\\{op\_byte}(\\{cur\_i})<\\{qi}(11)$ \1\&{then}\5
$\\{math\_type}(\\{nucleus}(\|r))\K\\{math\_char}$\6
\4\&{else} $\\{math\_type}(\\{nucleus}(\|r))\K\\{math\_text\_char}$;\C{prevent
combination}\2\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37$\\{link}(\|q)\K\\{link}(\|p)$;\5
$\\{character}(\\{nucleus}(\|q))\K\\{rem\_byte}(\\{cur\_i})$;\C{\.{=:}}\6
$\\{mem}[\\{subscr}(\|q)]\K\\{mem}[\\{subscr}(\|p)]$;\5
$\\{mem}[\\{supscr}(\|q)]\K\\{mem}[\\{supscr}(\|p)]$;\6
$\\{free\_node}(\|p,\39\\{noad\_size})$;\6
\&{end}\2\6
\&{endcases};\6
\&{if} $\\{op\_byte}(\\{cur\_i})>\\{qi}(3)$ \1\&{then}\5
\&{return};\2\6
$\\{math\_type}(\\{nucleus}(\|q))\K\\{math\_char}$;\5
\&{goto} \37\\{restart};\6
\&{end}\2\2\2\par
\U928.\fi

\M930. When we get to the following part of the program, we have ``fallen
through''
from cases that did not lead to \\{check\_dimensions} or \\{done\_with\_noad}
or
\\{done\_with\_node}. Thus, \|q~points to a noad whose nucleus may need to be
converted to an hlist, and whose subscripts and superscripts need to be
appended if they are present.

If $\\{nucleus}(\|q)$ is not a \\{math\_char}, the variable \\{delta} is the
amount
by which a superscript should be moved right with respect to a subscript
when both are present.

\Y\P$\4\X930:Convert \(n)$\\{nucleus}(\|q)$ to an hlist and attach the
sub/superscripts\X\S$\6
\&{case} $\\{math\_type}(\\{nucleus}(\|q))$ \1\&{of}\6
\4$\\{math\_char},\39\\{math\_text\_char}$: \37\X931:Create a character node %
\|p for $\\{nucleus}(\|q)$, possibly followed by a kern node for the italic
correction, and set \\{delta} to the italic correction if a subscript is
present\X;\6
\4\\{empty}: \37$\|p\K\\{null}$;\6
\4\\{sub\_box}: \37$\|p\K\\{info}(\\{nucleus}(\|q))$;\6
\4\\{sub\_mlist}: \37\&{begin} \37$\\{cur\_mlist}\K\\{info}(\\{nucleus}(\|q))$;%
\5
$\\{save\_style}\K\\{cur\_style}$;\5
$\\{mlist\_penalties}\K\\{false}$;\5
\\{mlist\_to\_hlist};\C{recursive call}\6
$\\{cur\_style}\K\\{save\_style}$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
$\|p\K\\{hpack}(\\{link}(\\{temp\_head}),\39\\{natural})$;\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"mlist2"})$\2\6
\&{endcases};\6
$\\{new\_hlist}(\|q)\K\|p$;\6
\&{if} $(\\{math\_type}(\\{subscr}(\|q))=\\{empty})\W(\\{math\_type}(%
\\{supscr}(\|q))=\\{empty})$ \1\&{then}\5
\&{goto} \37\\{check\_dimensions};\2\6
$\\{make\_scripts}(\|q,\39\\{delta})$\par
\U904.\fi

\M931. \P$\X931:Create a character node \|p for $\\{nucleus}(\|q)$, possibly
followed by a kern node for the italic correction, and set \\{delta} to the
italic correction if a subscript is present\X\S$\6
\&{begin} \37$\\{fetch}(\\{nucleus}(\|q))$;\6
\&{if} $\\{char\_exists}(\\{cur\_i})$ \1\&{then}\6
\&{begin} \37$\\{delta}\K\\{char\_italic}(\\{cur\_f})(\\{cur\_i})$;\5
$\|p\K\\{new\_character}(\\{cur\_f},\39\\{qo}(\\{cur\_c}))$;\6
\&{if} $(\\{math\_type}(\\{nucleus}(\|q))=\\{math\_text\_char})\W(\\{space}(%
\\{cur\_f})\I0)$ \1\&{then}\5
$\\{delta}\K0$;\C{no italic correction in mid-word of text font}\2\6
\&{if} $(\\{math\_type}(\\{subscr}(\|q))=\\{empty})\W(\\{delta}\I0)$ \1\&{then}%
\6
\&{begin} \37$\\{link}(\|p)\K\\{new\_kern}(\\{delta})$;\5
$\\{delta}\K0$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\|p\K\\{null}$;\2\6
\&{end}\par
\U930.\fi

\M932. The purpose of $\\{make\_scripts}(\|q,\\{delta})$ is to attach the
subscript and/or
superscript of noad \|q to the list that starts at $\\{new\_hlist}(\|q)$,
given that the subscript and superscript aren't both empty. The superscript
will appear to the right of the subscript by a given distance \\{delta}.

We set \\{shift\_down} and \\{shift\_up} to the minimum amounts to shift the
baseline of subscripts and superscripts based on the given nucleus.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{make\_scripts}(\|q:\\{pointer};\,\35\\{delta}:%
\\{scaled})$;\6
\4\&{var} \37$\|p,\39\|x,\39\|y,\39\|z$: \37\\{pointer};\C{temporary registers
for box construction}\6
$\\{shift\_up},\39\\{shift\_down},\39\\{clr}$: \37\\{scaled};\C{dimensions in
the calculation}\6
\|t: \37\\{small\_number};\C{subsidiary size code}\2\6
\&{begin} \37$\|p\K\\{new\_hlist}(\|q)$;\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37$\\{shift\_up}\K0$;\5
$\\{shift\_down}\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|z\K\\{hpack}(\|p,\39\\{natural})$;\6
\&{if} $\\{cur\_style}<\\{script\_style}$ \1\&{then}\5
$\|t\K\\{script\_size}$\ \&{else} $\|t\K\\{script\_script\_size}$;\2\6
$\\{shift\_up}\K\\{height}(\|z)-\\{sup\_drop}(\|t)$;\5
$\\{shift\_down}\K\\{depth}(\|z)+\\{sub\_drop}(\|t)$;\5
$\\{free\_node}(\|z,\39\\{box\_node\_size})$;\6
\&{end};\2\6
\&{if} $\\{math\_type}(\\{supscr}(\|q))=\\{empty}$ \1\&{then}\5
\X933:Construct a subscript box \|x when there is no superscript\X\6
\4\&{else} \&{begin} \37\X934:Construct a superscript box \|x\X;\6
\&{if} $\\{math\_type}(\\{subscr}(\|q))=\\{empty}$ \1\&{then}\5
$\\{shift\_amount}(\|x)\K-\\{shift\_up}$\6
\4\&{else} \X935:Construct a sub/superscript combination box \|x, with the
superscript offset by \\{delta}\X;\2\6
\&{end};\2\6
\&{if} $\\{new\_hlist}(\|q)=\\{null}$ \1\&{then}\5
$\\{new\_hlist}(\|q)\K\|x$\6
\4\&{else} \&{begin} \37$\|p\K\\{new\_hlist}(\|q)$;\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{link}(\|p)\K\|x$;\6
\&{end};\2\6
\&{end};\par
\fi

\M933. When there is a subscript without a superscript, the top of the
subscript
should not exceed the baseline plus four-fifths of the x-height.

\Y\P$\4\X933:Construct a subscript box \|x when there is no superscript\X\S$\6
\&{begin} \37$\|x\K\\{clean\_box}(\\{subscr}(\|q),\39\\{sub\_style}(\\{cur%
\_style}))$;\5
$\\{width}(\|x)\K\\{width}(\|x)+\\{script\_space}$;\6
\&{if} $\\{shift\_down}<\\{sub1}(\\{cur\_size})$ \1\&{then}\5
$\\{shift\_down}\K\\{sub1}(\\{cur\_size})$;\2\6
$\\{clr}\K\\{height}(\|x)-(\\{abs}(\\{math\_x\_height}(\\{cur\_size})\ast4)%
\mathbin{\&{div}}5)$;\6
\&{if} $\\{shift\_down}<\\{clr}$ \1\&{then}\5
$\\{shift\_down}\K\\{clr}$;\2\6
$\\{shift\_amount}(\|x)\K\\{shift\_down}$;\6
\&{end}\par
\U932.\fi

\M934. The bottom of a superscript should never descend below the baseline plus
one-fourth of the x-height.

\Y\P$\4\X934:Construct a superscript box \|x\X\S$\6
\&{begin} \37$\|x\K\\{clean\_box}(\\{supscr}(\|q),\39\\{sup\_style}(\\{cur%
\_style}))$;\5
$\\{width}(\|x)\K\\{width}(\|x)+\\{script\_space}$;\6
\&{if} $\\{odd}(\\{cur\_style})$ \1\&{then}\5
$\\{clr}\K\\{sup3}(\\{cur\_size})$\6
\4\&{else} \&{if} $\\{cur\_style}<\\{text\_style}$ \1\&{then}\5
$\\{clr}\K\\{sup1}(\\{cur\_size})$\6
\4\&{else} $\\{clr}\K\\{sup2}(\\{cur\_size})$;\2\2\6
\&{if} $\\{shift\_up}<\\{clr}$ \1\&{then}\5
$\\{shift\_up}\K\\{clr}$;\2\6
$\\{clr}\K\\{depth}(\|x)+(\\{abs}(\\{math\_x\_height}(\\{cur\_size}))\mathbin{%
\&{div}}4)$;\6
\&{if} $\\{shift\_up}<\\{clr}$ \1\&{then}\5
$\\{shift\_up}\K\\{clr}$;\2\6
\&{end}\par
\U932.\fi

\M935. When both subscript and superscript are present, the subscript must be
separated from the superscript by at least four times \\{default\_rule%
\_thickness}.
If this condition would be violated, the subscript moves down, after which
both subscript and superscript move up so that the bottom of the superscript
is at least as high as the baseline plus four-fifths of the x-height.

\Y\P$\4\X935:Construct a sub/superscript combination box \|x, with the
superscript offset by \\{delta}\X\S$\6
\&{begin} \37$\|y\K\\{clean\_box}(\\{subscr}(\|q),\39\\{sub\_style}(\\{cur%
\_style}))$;\5
$\\{width}(\|y)\K\\{width}(\|y)+\\{script\_space}$;\6
\&{if} $\\{shift\_down}<\\{sub2}(\\{cur\_size})$ \1\&{then}\5
$\\{shift\_down}\K\\{sub2}(\\{cur\_size})$;\2\6
$\\{clr}\K4\ast\\{default\_rule\_thickness}-((\\{shift\_up}-\\{depth}(\|x))-(%
\\{height}(\|y)-\\{shift\_down}))$;\6
\&{if} $\\{clr}>0$ \1\&{then}\6
\&{begin} \37$\\{shift\_down}\K\\{shift\_down}+\\{clr}$;\5
$\\{clr}\K(\\{abs}(\\{math\_x\_height}(\\{cur\_size})\ast4)\mathbin{%
\&{div}}5)-(\\{shift\_up}-\\{depth}(\|x))$;\6
\&{if} $\\{clr}>0$ \1\&{then}\6
\&{begin} \37$\\{shift\_up}\K\\{shift\_up}+\\{clr}$;\5
$\\{shift\_down}\K\\{shift\_down}-\\{clr}$;\6
\&{end};\2\6
\&{end};\2\6
$\\{shift\_amount}(\|x)\K\\{delta}$;\C{superscript is \\{delta} to the right of
the subscript}\6
$\|p\K\\{new\_kern}((\\{shift\_up}-\\{depth}(\|x))-(\\{height}(\|y)-\\{shift%
\_down}))$;\5
$\\{link}(\|x)\K\|p$;\5
$\\{link}(\|p)\K\|y$;\5
$\|x\K\\{vpack}(\|x,\39\\{natural})$;\5
$\\{shift\_amount}(\|x)\K\\{shift\_down}$;\6
\&{end}\par
\U932.\fi

\M936. We have now tied up all the loose ends of the first pass of \\{mlist\_to%
\_hlist}.
The second pass simply goes through and hooks everything together with the
proper glue and penalties. It also handles the \\{left\_noad} and \\{right%
\_noad} that
might be present, since \\{max\_h} and \\{max\_d} are now known. Variable \|p
points
to a node at the current end of the final hlist.

\Y\P$\4\X936:Make a second pass over the mlist, removing all noads and
inserting the proper spacing and penalties\X\S$\6
$\|p\K\\{temp\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\|q\K\\{mlist}$;\5
$\\{r\_type}\K0$;\5
$\\{cur\_style}\K\\{style}$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{begin} \37\X937:If node \|q is a style node, change the style and \&{goto} %
\\{delete\_q}; otherwise if it is not a noad, put it into the hlist, advance %
\|q, and \&{goto} \\{done}; otherwise set \|s to the size of noad \|q, set \|t
to the associated type ($\\{ord\_noad}\to\\{inner\_noad}$), and set \\{pen} to
the associated penalty\X;\6
\X942:Append inter-element spacing based on \\{r\_type} and \|t\X;\6
\X943:Append any \\{new\_hlist} entries for \|q, and any appropriate penalties%
\X;\6
\&{if} $\\{type}(\|q)=\\{right\_noad}$ \1\&{then}\5
$\|t\K\\{open\_noad}$;\2\6
$\\{r\_type}\K\|t$;\6
\4\\{delete\_q}: \37$\|r\K\|q$;\5
$\|q\K\\{link}(\|q)$;\5
$\\{free\_node}(\|r,\39\|s)$;\6
\4\\{done}: \37\&{end}\2\par
\U902.\fi

\M937. Just before doing the big   \&{case}  switch in the second pass, the
program
sets up default values so that most of the branches are short.

\Y\P$\4\X937:If node \|q is a style node, change the style and \&{goto} %
\\{delete\_q}; otherwise if it is not a noad, put it into the hlist, advance %
\|q, and \&{goto} \\{done}; otherwise set \|s to the size of noad \|q, set \|t
to the associated type ($\\{ord\_noad}\to\\{inner\_noad}$), and set \\{pen} to
the associated penalty\X\S$\6
$\|t\K\\{ord\_noad}$;\5
$\|s\K\\{noad\_size}$;\5
$\\{pen}\K\\{inf\_penalty}$;\6
\&{case} $\\{type}(\|q)$ \1\&{of}\6
\4$\\{op\_noad},\39\\{open\_noad},\39\\{close\_noad},\39\\{punct\_noad},\39%
\\{inner\_noad}$: \37$\|t\K\\{type}(\|q)$;\6
\4\\{bin\_noad}: \37\&{begin} \37$\|t\K\\{bin\_noad}$;\5
$\\{pen}\K\\{bin\_op\_penalty}$;\6
\&{end};\6
\4\\{rel\_noad}: \37\&{begin} \37$\|t\K\\{rel\_noad}$;\5
$\\{pen}\K\\{rel\_penalty}$;\6
\&{end};\6
\4$\\{ord\_noad},\39\\{vcenter\_noad},\39\\{over\_noad},\39\\{under\_noad}$: %
\37\\{do\_nothing};\6
\4\\{radical\_noad}: \37$\|s\K\\{radical\_noad\_size}$;\6
\4\\{accent\_noad}: \37$\|s\K\\{accent\_noad\_size}$;\6
\4\\{fraction\_noad}: \37$\|s\K\\{fraction\_noad\_size}$;\6
\4$\\{left\_noad},\39\\{right\_noad}$: \37$\|t\K\\{make\_left\_right}(\|q,\39%
\\{style},\39\\{max\_d},\39\\{max\_h})$;\6
\4\\{style\_node}: \37\X939:Change the current style and \&{goto} \\{delete\_q}%
\X;\6
\4$\\{whatsit\_node},\39\\{penalty\_node},\39\\{rule\_node},\39\\{disc\_node},%
\39\\{adjust\_node},\39\\{ins\_node},\39\\{mark\_node},\39\\{glue\_node},\39%
\\{kern\_node}$: \37\hbox{}\6
\&{begin} \37$\\{link}(\|p)\K\|q$;\5
$\|p\K\|q$;\5
$\|q\K\\{link}(\|q)$;\5
$\\{link}(\|p)\K\\{null}$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"mlist3"})$\2\6
\&{endcases}\par
\U936.\fi

\M938. The \\{make\_left\_right} function constructs a left or right delimiter
of
the required size and returns the value \\{open\_noad} or \\{close\_noad}. The
\\{right\_noad} and \\{left\_noad} will both be based on the original %
\\{style},
so they will have consistent sizes.

We use the fact that $\\{right\_noad}-\\{left\_noad}=\\{close\_noad}-\\{open%
\_noad}$.

\Y\P$\4\X910:Declare math construction procedures\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{make\_left\_right}(\|q:\\{pointer};\,\35\\{style}:%
\\{small\_number};\,\35\\{max\_d},\39\\{max\_h}:\\{scaled})$: \37\\{small%
\_number};\6
\4\&{var} \37$\\{delta},\39\\{delta1},\39\\{delta2}$: \37\\{scaled};%
\C{dimensions used in the calculation}\2\6
\&{begin} \37$\\{cur\_style}\K\\{style}$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
$\\{delta2}\K\\{max\_d}+\\{axis\_height}(\\{cur\_size})$;\5
$\\{delta1}\K\\{max\_h}+\\{max\_d}-\\{delta2}$;\6
\&{if} $\\{delta2}>\\{delta1}$ \1\&{then}\5
$\\{delta1}\K\\{delta2}$;\C{\\{delta1} is max distance from axis}\2\6
$\\{delta}\K(\\{delta1}\mathbin{\&{div}}500)\ast\\{delimiter\_factor}$;\5
$\\{delta2}\K\\{delta1}+\\{delta1}-\\{delimiter\_shortfall}$;\6
\&{if} $\\{delta}<\\{delta2}$ \1\&{then}\5
$\\{delta}\K\\{delta2}$;\2\6
$\\{new\_hlist}(\|q)\K\\{var\_delimiter}(\\{delimiter}(\|q),\39\\{cur\_size},%
\39\\{delta})$;\5
$\\{make\_left\_right}\K\\{type}(\|q)-(\\{left\_noad}-\\{open\_noad})$;\C{%
\\{open\_noad} or \\{close\_noad}}\6
\&{end};\par
\fi

\M939. \P$\X939:Change the current style and \&{goto} \\{delete\_q}\X\S$\6
\&{begin} \37$\\{cur\_style}\K\\{subtype}(\|q)$;\5
$\|s\K\\{style\_node\_size}$;\5
\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X;\6
\&{goto} \37\\{delete\_q};\6
\&{end}\par
\U937.\fi

\M940. The inter-element spacing in math formulas depends on an $8\times8$
table that
\TeX\ preloads as a 64-digit string. The elements of this string have the
following significance:
$$\vbox{\halign{#\hfil\cr
\.0 means no space;\cr
\.1 means a conditional thin space (\.{\\nonscript\\mskip\\thinmuskip});\cr
\.2 means a thin space (\.{\\mskip\\thinmuskip});\cr
\.3 means a conditional medium space
(\.{\\nonscript\\mskip\\medmuskip});\cr
\.4 means a conditional thick space
(\.{\\nonscript\\mskip\\thickmuskip});\cr
\.* means an impossible case.\cr}}$$
This is all pretty cryptic, but {\sl The \TeX book\/} explains what is
supposed to happen, and the string makes it happen.

A global variable \\{magic\_offset} is computed so that if \|a and \|b are
in the range $\\{ord\_noad}\to\\{inner\_noad}$, then $\\{str\_pool}[\|a\ast8+%
\|b+\\{magic\_offset}]$
is the digit for spacing between noad types \|a and \|b.

If \PASCAL\ had provided a good way to preload constant arrays, this part of
the program would not have been so strange.

\Y\P\D \37$\\{math\_spacing}=$\6
\hbox{\hskip-35pt}%
\.{"0234000122*4000133**3**344*0400400*000000234000111*1111112341011"}\hbox{$ %
\hskip-35pt$}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{magic\_offset}: \37\\{integer};\C{used to find inter-element spacing}\par
\fi

\M941. \P$\X941:Compute the magic offset\X\S$\6
$\\{magic\_offset}\K\\{str\_start}[\\{math\_spacing}]-9\ast\\{ord\_noad}$\par
\U1517.\fi

\M942. \P$\X942:Append inter-element spacing based on \\{r\_type} and \|t\X\S$\6
\&{if} $\\{r\_type}>0$ \1\&{then}\C{not the first noad}\6
\&{begin} \37\&{case} $\\{so}(\\{str\_pool}[\\{r\_type}\ast8+\|t+\\{magic%
\_offset}])$ \1\&{of}\6
\4\.{"0"}: \37$\|x\K0$;\6
\4\.{"1"}: \37\&{if} $\\{cur\_style}<\\{script\_style}$ \1\&{then}\5
$\|x\K\\{thin\_mu\_skip\_code}$\ \&{else} $\|x\K0$;\2\6
\4\.{"2"}: \37$\|x\K\\{thin\_mu\_skip\_code}$;\6
\4\.{"3"}: \37\&{if} $\\{cur\_style}<\\{script\_style}$ \1\&{then}\5
$\|x\K\\{med\_mu\_skip\_code}$\ \&{else} $\|x\K0$;\2\6
\4\.{"4"}: \37\&{if} $\\{cur\_style}<\\{script\_style}$ \1\&{then}\5
$\|x\K\\{thick\_mu\_skip\_code}$\ \&{else} $\|x\K0$;\2\6
\4\&{othercases} \37$\\{confusion}(\.{"mlist4"})$\2\6
\&{endcases};\6
\&{if} $\|x\I0$ \1\&{then}\6
\&{begin} \37$\|y\K\\{math\_glue}(\\{glue\_par}(\|x),\39\\{cur\_mu})$;\5
$\|z\K\\{new\_glue}(\|y)$;\5
$\\{glue\_ref\_count}(\|y)\K\\{null}$;\5
$\\{link}(\|p)\K\|z$;\5
$\|p\K\|z$;\6
$\\{subtype}(\|z)\K\|x+1$;\C{store a symbolic subtype}\6
\&{end};\2\6
\&{end}\2\par
\U936.\fi

\M943. We insert a penalty node after the hlist entries of noad \|q if \\{pen}
is not an ``infinite'' penalty, and if the node immediately following \|q
is not a penalty node or a \\{rel\_noad} or absent entirely.

\Y\P$\4\X943:Append any \\{new\_hlist} entries for \|q, and any appropriate
penalties\X\S$\6
\&{if} $\\{new\_hlist}(\|q)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|p)\K\\{new\_hlist}(\|q)$;\6
\1\&{repeat} \37$\|p\K\\{link}(\|p)$;\6
\4\&{until}\5
$\\{link}(\|p)=\\{null}$;\2\6
\&{end};\2\6
\&{if} $\\{penalties}$ \1\&{then}\6
\&{if} $\\{link}(\|q)\I\\{null}$ \1\&{then}\6
\&{if} $\\{pen}<\\{inf\_penalty}$ \1\&{then}\6
\&{begin} \37$\\{r\_type}\K\\{type}(\\{link}(\|q))$;\6
\&{if} $\\{r\_type}\I\\{penalty\_node}$ \1\&{then}\6
\&{if} $\\{r\_type}\I\\{rel\_noad}$ \1\&{then}\6
\&{begin} \37$\|z\K\\{new\_penalty}(\\{pen})$;\5
$\\{link}(\|p)\K\|z$;\5
$\|p\K\|z$;\6
\&{end};\2\2\6
\&{end}\2\2\2\par
\U936.\fi

\N944.  \[37] Alignment.
It's sort of a miracle whenever \.{\\halign} and \.{\\valign} work, because
they cut across so many of the control structures of \TeX.

Therefore the
present page is probably not the best place for a beginner to start reading
this program; it is better to master everything else first.

Let us focus our thoughts on an example of what the input might be, in order
to get some idea about how the alignment miracle happens. The example doesn't
do anything useful, but it is sufficiently general to indicate all of the
special cases that must be dealt with; please do not be disturbed by its
apparent complexity and meaninglessness.
$$\vbox{\halign{\.{#}\hfil\cr
{}\\tabskip 2pt plus 3pt\cr
{}\\halign to 300pt\{u1\#v1\&\cr
\hskip 50pt\\tabskip 1pt plus 1fil u2\#v2\&\cr
\hskip 50pt u3\#v3\\cr\cr
\hskip 25pt a1\&\\omit a2\&\\vrule\\cr\cr
\hskip 25pt \\noalign\{\\vskip 3pt\}\cr
\hskip 25pt b1\\span b2\\cr\cr
\hskip 25pt \\omit\&c2\\span\\omit\\cr\}\cr}}$$
Here's what happens:

\yskip
(0) When `\.{\\halign to 300pt\{}' is scanned, the \\{scan\_spec} routine
places the 300pt dimension onto the \\{save\_stack}, and an \\{align\_group}
code is placed above it. This will make it possible to complete the alignment
when the matching `\.\}' is found.

(1) The preamble is scanned next. Macros in the preamble are not expanded,
except as part of a tabskip specification. For example, if \.{u2} had been
a macro in the preamble above, it would have been expanded, since \TeX\
must look for `\.{minus...}' as part of the tabskip glue. A ``preamble list''
is constructed based on the user's preamble; in our case it contains the
following seven items:
$$\vbox{\halign{\.{#}\hfil\qquad&(#)\hfil\cr
{}\\glue 2pt plus 3pt&the tabskip preceding column 1\cr
{}\\alignrecord, width $-\infty$&preamble info for column 1\cr
{}\\glue 2pt plus 3pt&the tabskip between columns 1 and 2\cr
{}\\alignrecord, width $-\infty$&preamble info for column 2\cr
{}\\glue 1pt plus 1fil&the tabskip between columns 2 and 3\cr
{}\\alignrecord, width $-\infty$&preamble info for column 3\cr
{}\\glue 1pt plus 1fil&the tabskip following column 3\cr}}$$
These ``alignrecord'' entries have the same size as an \\{unset\_node},
since they will later be converted into such nodes. However, at the
moment they have no \\{type} or \\{subtype} fields; they have \\{info} fields
instead, and these \\{info} fields are initially set to the value \\{end%
\_span},
for reasons explained below. Furthermore, the alignrecord nodes have no
\\{height} or \\{depth} fields; these are renamed \\{u\_part} and \\{v\_part},
and they point to token lists for the templates of the alignment.
For example, the \\{u\_part} field in the first alignrecord points to the
token list `\.{u1}', i.e., the template preceding the `\.\#' for column~1.

(2) \TeX\ now looks at what follows the \.{\\cr} that ended the preamble.
It is not `\.{\\noalign}' or `\.{\\omit}', so this input is put back to
be read again, and the template `\.{u1}' is fed to the scanner. Just
before reading `\.{u1}', \TeX\ goes into restricted horizontal mode.
Just after reading `\.{u1}', \TeX\ will see `\.{a1}', and then (when the
{\.\&} is sensed) \TeX\ will see `\.{v1}'. Then \TeX\ scans an \\{endv}
token, indicating the end of a column. At this point an \\{unset\_node} is
created, containing the contents of the current hlist (i.e., `\.{u1a1v1}').
The natural width of this unset node replaces the \\{width} field of the
alignrecord for column~1; in general, the alignrecords will record the
maximum natural width that has occurred so far in a given column.

(3) Since `\.{\\omit}' follows the `\.\&', the templates for column~2
are now bypassed. Again \TeX\ goes into restricted horizontal mode and
makes an \\{unset\_node} from the resulting hlist; but this time the
hlist contains simply `\.{a2}'. The natural width of the new unset box
is remembered in the \\{width} field of the alignrecord for column~2.

(4) A third \\{unset\_node} is created for column 3, using essentially the
mechanism that worked for column~1; this unset box contains `\.{u3\\vrule
v3}'. The vertical rule in this case has running dimensions that will later
extend to the height and depth of the whole first row, since each \\{unset%
\_node}
in a row will eventually inherit the height and depth of its enclosing box.

(5) The first row has now ended; it is made into a single unset box
comprising the following seven items:
$$\vbox{\halign{\hbox to 325pt{\qquad\.{#}\hfil}\cr
{}\\glue 2pt plus 3pt\cr
{}\\unsetbox for 1 column: u1a1v1\cr
{}\\glue 2pt plus 3pt\cr
{}\\unsetbox for 1 column: a2\cr
{}\\glue 1pt plus 1fil\cr
{}\\unsetbox for 1 column: u3\\vrule v3\cr
{}\\glue 1pt plus 1fil\cr}}$$
The width of this unset row is unimportant, but it has the correct height
and depth, so the correct baselineskip glue will be computed as the row
is inserted into a vertical list.

(6) Since `\.{\\noalign}' follows the current \.{\\cr}, \TeX\ appends
additional material (in this case \.{\\vskip 3pt}) to the vertical list.
While processing this material, \TeX\ will be in internal vertical
mode, and \\{no\_align\_group} will be on \\{save\_stack}.

(7) The next row produces an unset box that looks like this:
$$\vbox{\halign{\hbox to 325pt{\qquad\.{#}\hfil}\cr
{}\\glue 2pt plus 3pt\cr
{}\\unsetbox for 2 columns: u1b1v1u2b2v2\cr
{}\\glue 1pt plus 1fil\cr
{}\\unsetbox for 1 column: {\rm(empty)}\cr
{}\\glue 1pt plus 1fil\cr}}$$
The natural width of the unset box that spans columns 1~and~2 is stored
in a ``span node,'' which we will explain later; the \\{info} field of the
alignrecord for column~1 now points to the new span node, and the \\{info}
of the span node points to \\{end\_span}.

(8) The final row produces the unset box
$$\vbox{\halign{\hbox to 325pt{\qquad\.{#}\hfil}\cr
{}\\glue 2pt plus 3pt\cr
{}\\unsetbox for 1 column: {\rm(empty)}\cr
{}\\glue 2pt plus 3pt\cr
{}\\unsetbox for 2 columns: u2c2v2\cr
{}\\glue 1pt plus 1fil\cr}}$$
A new span node is attached to the alignrecord for column 2.

(9) The last step is to compute the true column widths and to change all the
unset boxes to hboxes, appending the whole works to the vertical list that
encloses the \.{\\halign}. The rules for deciding on the final widths of
each unset column box will be explained below.

\yskip\noindent
Note that as \.{\\halign} is being processed, we fearlessly give up control
to the rest of \TeX. At critical junctures, an alignment routine is
called upon to step in and do some little action, but most of the time
these routines just lurk in the background. It's something like
post-hypnotic suggestion.

\fi

\M945. We have mentioned that alignrecords contain no \\{height} or \\{depth}
fields.
Their \\{glue\_sign} and \\{glue\_order} are pre-empted as well, since it
is necessary to store information about what to do when a template ends.
This information is called the \\{extra\_info} field.

\Y\P\D \37$\\{u\_part}(\#)\S\\{mem}[\#+\\{height\_offset}].\\{int}$\C{pointer
to \<u_j> token list}\par
\P\D \37$\\{v\_part}(\#)\S\\{mem}[\#+\\{depth\_offset}].\\{int}$\C{pointer to %
\<v_j> token list}\par
\P\D \37$\\{extra\_info}(\#)\S\\{info}(\#+\\{list\_offset})$\C{info to remember
during template}\par
\fi

\M946. Alignments can occur within alignments, so a small stack is used to
access
the alignrecord information. At each level we have a \\{preamble} pointer,
indicating the beginning of the preamble list; a \\{cur\_align} pointer,
indicating the current position in the preamble list; a \\{cur\_span} pointer,
indicating the value of \\{cur\_align} at the beginning of a sequence of
spanned columns; a \\{cur\_loop} pointer, indicating the tabskip glue before
an alignrecord that should be copied next if the current list is extended;
and the \\{align\_state} variable, which indicates the nesting of braces so
that \.{\\cr} and \.{\\span} and tab marks are properly intercepted.
There also are pointers \\{cur\_head} and \\{cur\_tail} to the head and tail
of a list of adjustments being moved out from horizontal mode to
vertical~mode.

The current values of these seven quantities appear in global variables;
when they have to be pushed down, they are stored in 5-word nodes, and
\\{align\_ptr} points to the topmost such node.

\Y\P\D \37$\\{preamble}\S\\{link}(\\{align\_head})$\C{the current preamble
list}\par
\P\D \37$\\{align\_stack\_node\_size}=6$\C{number of \\{mem} words to save
alignment states}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_align}: \37\\{pointer};\C{current position in preamble list}\6
\4\\{cur\_span}: \37\\{pointer};\C{start of currently spanned columns in
preamble list}\6
\4\\{cur\_loop}: \37\\{pointer};\C{place to copy when extending a periodic
preamble}\6
\4\\{align\_ptr}: \37\\{pointer};\C{most recently pushed-down alignment stack
node}\6
\4$\\{cur\_head},\39\\{cur\_tail}$: \37\\{pointer};\C{adjustment list pointers}%
\6
\4$\\{cur\_pre\_head},\39\\{cur\_pre\_tail}$: \37\\{pointer};\C{pre-adjustment
list pointers}\par
\fi

\M947. The \\{align\_state} and \\{preamble} variables are initialized
elsewhere.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{align\_ptr}\K\\{null}$;\5
$\\{cur\_align}\K\\{null}$;\5
$\\{cur\_span}\K\\{null}$;\5
$\\{cur\_loop}\K\\{null}$;\5
$\\{cur\_head}\K\\{null}$;\5
$\\{cur\_tail}\K\\{null}$;\5
$\\{cur\_pre\_head}\K\\{null}$;\5
$\\{cur\_pre\_tail}\K\\{null}$;\par
\fi

\M948. Alignment stack maintenance is handled by a pair of trivial routines
called \\{push\_alignment} and \\{pop\_alignment}.

\Y\P\4\&{procedure}\1\  \37\\{push\_alignment};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new alignment stack node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{align\_stack\_node\_size})$;\5
$\\{link}(\|p)\K\\{align\_ptr}$;\5
$\\{info}(\|p)\K\\{cur\_align}$;\5
$\\{llink}(\|p)\K\\{preamble}$;\5
$\\{rlink}(\|p)\K\\{cur\_span}$;\5
$\\{mem}[\|p+2].\\{int}\K\\{cur\_loop}$;\5
$\\{mem}[\|p+3].\\{int}\K\\{align\_state}$;\5
$\\{info}(\|p+4)\K\\{cur\_head}$;\5
$\\{link}(\|p+4)\K\\{cur\_tail}$;\5
$\\{info}(\|p+5)\K\\{cur\_pre\_head}$;\5
$\\{link}(\|p+5)\K\\{cur\_pre\_tail}$;\5
$\\{align\_ptr}\K\|p$;\5
$\\{cur\_head}\K\\{get\_avail}$;\5
$\\{cur\_pre\_head}\K\\{get\_avail}$;\6
\&{end};\7
\4\&{procedure}\1\  \37\\{pop\_alignment};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the top alignment stack node}\2\6
\&{begin} \37$\\{free\_avail}(\\{cur\_head})$;\5
$\\{free\_avail}(\\{cur\_pre\_head})$;\5
$\|p\K\\{align\_ptr}$;\5
$\\{cur\_tail}\K\\{link}(\|p+4)$;\5
$\\{cur\_head}\K\\{info}(\|p+4)$;\5
$\\{cur\_pre\_tail}\K\\{link}(\|p+5)$;\5
$\\{cur\_pre\_head}\K\\{info}(\|p+5)$;\5
$\\{align\_state}\K\\{mem}[\|p+3].\\{int}$;\5
$\\{cur\_loop}\K\\{mem}[\|p+2].\\{int}$;\5
$\\{cur\_span}\K\\{rlink}(\|p)$;\5
$\\{preamble}\K\\{llink}(\|p)$;\5
$\\{cur\_align}\K\\{info}(\|p)$;\5
$\\{align\_ptr}\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{align\_stack\_node\_size})$;\6
\&{end};\par
\fi

\M949. \TeX\ has eight procedures that govern alignments: \\{init\_align} and
\\{fin\_align} are used at the very beginning and the very end; \\{init\_row}
and
\\{fin\_row} are used at the beginning and end of individual rows; \\{init%
\_span}
is used at the beginning of a sequence of spanned columns (possibly involving
only one column); \\{init\_col} and \\{fin\_col} are used at the beginning and
end of individual columns; and \\{align\_peek} is used after \.{\\cr} to see
whether the next item is \.{\\noalign}.

We shall consider these routines in the order they are first used during
the course of a complete \.{\\halign}, namely \\{init\_align}, \\{align\_peek},
\\{init\_row}, \\{init\_span}, \\{init\_col}, \\{fin\_col}, \\{fin\_row}, %
\\{fin\_align}.

\fi

\M950. When \.{\\halign} or \.{\\valign} has been scanned in an appropriate
mode, \TeX\ calls \\{init\_align}, whose task is to get everything off to a
good start. This mostly involves scanning the preamble and putting its
information into the preamble list.

\Y\P\hbox{\4}\X958:Declare the procedure called \\{get\_preamble\_token}\X%
\hbox{}\6
\4\&{procedure}\1\  \37\\{align\_peek};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{normal\_paragraph};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{init\_align};\6
\4\&{label} \37$\\{done},\39\\{done1},\39\\{done2},\39\\{continue}$;\6
\4\&{var} \37\\{save\_cs\_ptr}: \37\\{pointer};\C{\\{warning\_index} value for
error messages}\6
\|p: \37\\{pointer};\C{for short-term temporary use}\2\6
\&{begin} \37$\\{save\_cs\_ptr}\K\\{cur\_cs}$;\C{\.{\\halign} or \.{\\valign},
usually}\6
\\{push\_alignment};\5
$\\{align\_state}\K-1000000$;\C{enter a new alignment level}\6
\X952:Check for improper alignment in displayed math\X;\6
\\{push\_nest};\C{enter a new semantic level}\6
\X951:Change current mode to $-\\{vmode}$ for \.{\\halign}, $-\\{hmode}$ for %
\.{\\valign}\X;\6
$\\{scan\_spec}(\\{align\_group},\39\\{false})$;\6
\X953:Scan the preamble and record it in the \\{preamble} list\X;\6
$\\{new\_save\_level}(\\{align\_group})$;\6
\&{if} $\\{every\_cr}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_cr},\39\\{every\_cr\_text})$;\2\6
\\{align\_peek};\C{look for \.{\\noalign} or \.{\\omit}}\6
\&{end};\par
\fi

\M951. In vertical modes, \\{prev\_depth} already has the correct value. But
if we are in \\{mmode} (displayed formula mode), we reach out to the
enclosing vertical mode for the \\{prev\_depth} value that produces the
correct baseline calculations.

\Y\P$\4\X951:Change current mode to $-\\{vmode}$ for \.{\\halign}, $-\\{hmode}$
for \.{\\valign}\X\S$\6
\&{if} $\\{mode}=\\{mmode}$ \1\&{then}\6
\&{begin} \37$\\{mode}\K-\\{vmode}$;\5
$\\{prev\_depth}\K\\{nest}[\\{nest\_ptr}-2].\\{aux\_field}.\\{sc}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{mode}>0$ \1\&{then}\5
$\\{negate}(\\{mode})$\2\2\par
\U950.\fi

\M952. When \.{\\halign} is used as a displayed formula, there should be
no other pieces of mlists present.

\Y\P$\4\X952:Check for improper alignment in displayed math\X\S$\6
\&{if} $(\\{mode}=\\{mmode})\W((\\{tail}\I\\{head})\V(\\{incompleat\_noad}\I%
\\{null}))$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ "})$;\5
$\\{print\_esc}(\.{"halign"})$;\5
$\\{print}(\.{"\ inside\ \$\$\'s"})$;\5
$\\{help3}(\.{"Displays\ can\ use\ special\ alignments\ (like\ \\eqalignno)"})$%
\6
$(\.{"only\ if\ nothing\ but\ the\ alignment\ itself\ is\ between\ \$\$\'s."})$%
\6
$(\.{"So\ I\'ve\ deleted\ the\ formulas\ that\ preceded\ this\ alignment."})$;\5
\\{error};\5
\\{flush\_math};\6
\&{end}\2\par
\U950.\fi

\M953. \P$\X953:Scan the preamble and record it in the \\{preamble} list\X\S$\6
$\\{preamble}\K\\{null}$;\5
$\\{cur\_align}\K\\{align\_head}$;\5
$\\{cur\_loop}\K\\{null}$;\5
$\\{scanner\_status}\K\\{aligning}$;\5
$\\{warning\_index}\K\\{save\_cs\_ptr}$;\5
$\\{align\_state}\K-1000000$;\C{at this point, $\\{cur\_cmd}=\\{left\_brace}$}\6
\~ \1\&{loop}\ \&{begin} \37\X954:Append the current tabskip glue to the
preamble list\X;\6
\&{if} $\\{cur\_cmd}=\\{car\_ret}$ \1\&{then}\5
\&{goto} \37\\{done};\C{\.{\\cr} ends the preamble}\2\6
\X955:Scan preamble text until \\{cur\_cmd} is \\{tab\_mark} or \\{car\_ret},
looking for changes in the tabskip glue; append an alignrecord to the preamble
list\X;\6
\&{end};\2\6
\4\\{done}: \37$\\{scanner\_status}\K\\{normal}$\par
\U950.\fi

\M954. \P$\X954:Append the current tabskip glue to the preamble list\X\S$\6
$\\{link}(\\{cur\_align})\K\\{new\_param\_glue}(\\{tab\_skip\_code})$;\5
$\\{cur\_align}\K\\{link}(\\{cur\_align})$\par
\U953.\fi

\M955. \P$\X955:Scan preamble text until \\{cur\_cmd} is \\{tab\_mark} or %
\\{car\_ret}, looking for changes in the tabskip glue; append an alignrecord to
the preamble list\X\S$\6
\X959:Scan the template \<u_j>, putting the resulting token list in \\{hold%
\_head}\X;\6
$\\{link}(\\{cur\_align})\K\\{new\_null\_box}$;\5
$\\{cur\_align}\K\\{link}(\\{cur\_align})$;\C{a new alignrecord}\6
$\\{info}(\\{cur\_align})\K\\{end\_span}$;\5
$\\{width}(\\{cur\_align})\K\\{null\_flag}$;\5
$\\{u\_part}(\\{cur\_align})\K\\{link}(\\{hold\_head})$;\5
\X960:Scan the template \<v_j>, putting the resulting token list in \\{hold%
\_head}\X;\6
$\\{v\_part}(\\{cur\_align})\K\\{link}(\\{hold\_head})$\par
\U953.\fi

\M956. We enter `\.{\\span}' into \\{eqtb} with \\{tab\_mark} as its command
code,
and with \\{span\_code} as the command modifier. This makes \TeX\ interpret it
essentially the same as an alignment delimiter like `\.\&', yet it is
recognizably different when we need to distinguish it from a normal delimiter.
It also turns out to be useful to give a special \\{cr\_code} to `\.{\\cr}',
and an even larger \\{cr\_cr\_code} to `\.{\\crcr}'.

The end of a template is represented by two ``frozen'' control sequences
called \.{\\endtemplate}. The first has the command code \\{end\_template},
which
is $>\\{outer\_call}$, so it will not easily disappear in the presence of
errors.
The \\{get\_x\_token} routine converts the first into the second, which has %
\\{endv}
as its command code.

\Y\P\D \37$\\{span\_code}=256$\C{distinct from any character}\par
\P\D \37$\\{cr\_code}=257$\C{distinct from \\{span\_code} and from any
character}\par
\P\D \37$\\{cr\_cr\_code}=\\{cr\_code}+1$\C{this distinguishes \.{\\crcr} from %
\.{\\cr}}\par
\P\D \37$\\{end\_template\_token}\S\\{cs\_token\_flag}+\\{frozen\_end%
\_template}$\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"span"},\39\\{tab\_mark},\39\\{span\_code})$;\6
$\\{primitive}(\.{"cr"},\39\\{car\_ret},\39\\{cr\_code})$;\5
$\\{text}(\\{frozen\_cr})\K\.{"cr"}$;\5
$\\{eqtb}[\\{frozen\_cr}]\K\\{eqtb}[\\{cur\_val}]$;\6
$\\{primitive}(\.{"crcr"},\39\\{car\_ret},\39\\{cr\_cr\_code})$;\5
$\\{text}(\\{frozen\_end\_template})\K\.{"endtemplate"}$;\5
$\\{text}(\\{frozen\_endv})\K\.{"endtemplate"}$;\5
$\\{eq\_type}(\\{frozen\_endv})\K\\{endv}$;\5
$\\{equiv}(\\{frozen\_endv})\K\\{null\_list}$;\5
$\\{eq\_level}(\\{frozen\_endv})\K\\{level\_one}$;\6
$\\{eqtb}[\\{frozen\_end\_template}]\K\\{eqtb}[\\{frozen\_endv}]$;\5
$\\{eq\_type}(\\{frozen\_end\_template})\K\\{end\_template}$;\par
\fi

\M957. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{tab\_mark}: \37\&{if} $\\{chr\_code}=\\{span\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"span"})$\6
\4\&{else} $\\{chr\_cmd}(\.{"alignment\ tab\ character\ "})$;\2\6
\4\\{car\_ret}: \37\&{if} $\\{chr\_code}=\\{cr\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"cr"})$\6
\4\&{else} $\\{print\_esc}(\.{"crcr"})$;\2\par
\fi

\M958. The preamble is copied directly, except that \.{\\tabskip} causes a
change
to the tabskip glue, thereby possibly expanding macros that immediately
follow it. An appearance of \.{\\span} also causes such an expansion.

Note that if the preamble contains `\.{\\global\\tabskip}', the `\.{\\global}'
token survives in the preamble and the `\.{\\tabskip}' defines new
tabskip glue (locally).

\Y\P$\4\X958:Declare the procedure called \\{get\_preamble\_token}\X\S$\6
\4\&{procedure}\1\  \37\\{get\_preamble\_token};\6
\4\&{label} \37\\{restart};\2\6
\&{begin} \37\\{restart}: \37\\{get\_token};\6
\&{while} $(\\{cur\_chr}=\\{span\_code})\W(\\{cur\_cmd}=\\{tab\_mark})$ \1%
\&{do}\6
\&{begin} \37\\{get\_token};\C{this token will be expanded once}\6
\&{if} $\\{cur\_cmd}>\\{max\_command}$ \1\&{then}\6
\&{begin} \37\\{expand};\5
\\{get\_token};\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{cur\_cmd}=\\{endv}$ \1\&{then}\5
$\\{fatal\_error}(\.{"(interwoven\ alignment\ preambles\ are\ not\
allowed)"})$;\2\6
\&{if} $(\\{cur\_cmd}=\\{assign\_glue})\W(\\{cur\_chr}=\\{glue\_base}+\\{tab%
\_skip\_code})$ \1\&{then}\6
\&{begin} \37\\{scan\_optional\_equals};\5
$\\{scan\_glue}(\\{glue\_val})$;\6
\&{if} $\\{global\_defs}>0$ \1\&{then}\5
$\\{geq\_define}(\\{glue\_base}+\\{tab\_skip\_code},\39\\{glue\_ref},\39\\{cur%
\_val})$\6
\4\&{else} $\\{eq\_define}(\\{glue\_base}+\\{tab\_skip\_code},\39\\{glue\_ref},%
\39\\{cur\_val})$;\2\6
\&{goto} \37\\{restart};\6
\&{end};\2\6
\&{end};\par
\U950.\fi

\M959. Spaces are eliminated from the beginning of a template.

\Y\P$\4\X959:Scan the template \<u_j>, putting the resulting token list in %
\\{hold\_head}\X\S$\6
$\|p\K\\{hold\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_preamble\_token};\6
\&{if} $\\{cur\_cmd}=\\{mac\_param}$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $(\\{cur\_cmd}\L\\{car\_ret})\W(\\{cur\_cmd}\G\\{tab\_mark})\W(\\{align%
\_state}=-1000000)$ \1\&{then}\6
\&{if} $(\|p=\\{hold\_head})\W(\\{cur\_loop}=\\{null})\W(\\{cur\_cmd}=\\{tab%
\_mark})$ \1\&{then}\5
$\\{cur\_loop}\K\\{cur\_align}$\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Missing\ \#\ inserted\ in\
alignment\ preamble"})$;\5
$\\{help3}(\.{"There\ should\ be\ exactly\ one\ \#\ between\ \&\'s,\ when\
an"})$\6
$(\.{"\\halign\ or\ \\valign\ is\ being\ set\ up.\ In\ this\ case\ you\ had"})$%
\6
$(\.{"none,\ so\ I\'ve\ put\ one\ in;\ maybe\ that\ will\ work."})$;\5
\\{back\_error};\5
\&{goto} \37\\{done1};\6
\&{end}\2\6
\4\&{else} \&{if} $(\\{cur\_cmd}\I\\{spacer})\V(\|p\I\\{hold\_head})$ \1%
\&{then}\6
\&{begin} \37$\\{link}(\|p)\K\\{get\_avail}$;\5
$\|p\K\\{link}(\|p)$;\5
$\\{info}(\|p)\K\\{cur\_tok}$;\6
\&{end};\2\2\6
\&{end};\2\6
\4\\{done1}: \37\par
\U955.\fi

\M960. \P$\X960:Scan the template \<v_j>, putting the resulting token list in %
\\{hold\_head}\X\S$\6
$\|p\K\\{hold\_head}$;\5
$\\{link}(\|p)\K\\{null}$;\6
\~ \1\&{loop}\ \&{begin} \37\\{continue}: \37\\{get\_preamble\_token};\6
\&{if} $(\\{cur\_cmd}\L\\{car\_ret})\W(\\{cur\_cmd}\G\\{tab\_mark})\W(\\{align%
\_state}=-1000000)$ \1\&{then}\5
\&{goto} \37\\{done2};\2\6
\&{if} $\\{cur\_cmd}=\\{mac\_param}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Only\ one\ \#\ is\ allowed\ per\ tab"})$;\5
$\\{help3}(\.{"There\ should\ be\ exactly\ one\ \#\ between\ \&\'s,\ when\
an"})$\6
$(\.{"\\halign\ or\ \\valign\ is\ being\ set\ up.\ In\ this\ case\ you\ had"})$%
\6
$(\.{"more\ than\ one,\ so\ I\'m\ ignoring\ all\ but\ the\ first."})$;\5
\\{error};\5
\&{goto} \37\\{continue};\6
\&{end};\2\6
$\\{link}(\|p)\K\\{get\_avail}$;\5
$\|p\K\\{link}(\|p)$;\5
$\\{info}(\|p)\K\\{cur\_tok}$;\6
\&{end};\2\6
\4\\{done2}: \37$\\{link}(\|p)\K\\{get\_avail}$;\5
$\|p\K\\{link}(\|p)$;\5
$\\{info}(\|p)\K\\{end\_template\_token}$\C{put \.{\\endtemplate} at the end}%
\par
\U955.\fi

\M961. The tricky part about alignments is getting the templates into the
scanner at the right time, and recovering control when a row or column
is finished.

We usually begin a row after each \.{\\cr} has been sensed, unless that
\.{\\cr} is followed by \.{\\noalign} or by the right brace that terminates
the alignment. The \\{align\_peek} routine is used to look ahead and do
the right thing; it either gets a new row started, or gets a \.{\\noalign}
started, or finishes off the alignment.

\Y\P$\4\X961:Declare the procedure called \\{align\_peek}\X\S$\6
\4\&{procedure}\1\  \37\\{align\_peek};\6
\4\&{label} \37\\{restart};\2\6
\&{begin} \37\\{restart}: \37$\\{align\_state}\K1000000$;\6
\1\&{repeat} \37\\{get\_x\_or\_protected};\6
\4\&{until}\5
$\\{cur\_cmd}\I\\{spacer}$;\2\6
\&{if} $\\{cur\_cmd}=\\{no\_align}$ \1\&{then}\6
\&{begin} \37\\{scan\_left\_brace};\5
$\\{new\_save\_level}(\\{no\_align\_group})$;\6
\&{if} $\\{mode}=-\\{vmode}$ \1\&{then}\5
\\{normal\_paragraph};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{right\_brace}$ \1\&{then}\5
\\{fin\_align}\6
\4\&{else} \&{if} $(\\{cur\_cmd}=\\{car\_ret})\W(\\{cur\_chr}=\\{cr\_cr%
\_code})$ \1\&{then}\5
\&{goto} \37\\{restart}\C{ignore \.{\\crcr}}\6
\4\&{else} \&{begin} \37\\{init\_row};\C{start a new row}\6
\\{init\_col};\C{start a new column and replace what we peeked at}\6
\&{end};\2\2\2\6
\&{end};\par
\U976.\fi

\M962. To start a row (i.e., a `row' that rhymes with `dough' but not with
`bough'),
we enter a new semantic level, copy the first tabskip glue, and change
from internal vertical mode to restricted horizontal mode or vice versa.
The \\{space\_factor} and \\{prev\_depth} are not used on this semantic level,
but we clear them to zero just to be tidy.

\Y\P\hbox{\4}\X963:Declare the procedure called \\{init\_span}\X\hbox{}\6
\4\&{procedure}\1\  \37\\{init\_row};\2\6
\&{begin} \37\\{push\_nest};\5
$\\{mode}\K(-\\{hmode}-\\{vmode})-\\{mode}$;\6
\&{if} $\\{mode}=-\\{hmode}$ \1\&{then}\5
$\\{space\_factor}\K0$\ \&{else} $\\{prev\_depth}\K0$;\2\6
$\\{tail\_append}(\\{new\_glue}(\\{glue\_ptr}(\\{preamble})))$;\5
$\\{subtype}(\\{tail})\K\\{tab\_skip\_code}+1$;\6
$\\{cur\_align}\K\\{link}(\\{preamble})$;\5
$\\{cur\_tail}\K\\{cur\_head}$;\5
$\\{cur\_pre\_tail}\K\\{cur\_pre\_head}$;\5
$\\{init\_span}(\\{cur\_align})$;\6
\&{end};\par
\fi

\M963. The parameter to \\{init\_span} is a pointer to the alignrecord where
the
next column or group of columns will begin. A new semantic level is
entered, so that the columns will generate a list for subsequent packaging.

\Y\P$\4\X963:Declare the procedure called \\{init\_span}\X\S$\6
\4\&{procedure}\1\  \37$\\{init\_span}(\|p:\\{pointer})$;\2\6
\&{begin} \37\\{push\_nest};\6
\&{if} $\\{mode}=-\\{hmode}$ \1\&{then}\5
$\\{space\_factor}\K1000$\6
\4\&{else} \&{begin} \37$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\5
\\{normal\_paragraph};\6
\&{end};\2\6
$\\{cur\_span}\K\|p$;\6
\&{end};\par
\U962.\fi

\M964. When a column begins, we assume that \\{cur\_cmd} is either \\{omit} or
else
the current token should be put back into the input until the \<u_j>
template has been scanned.  (Note that \\{cur\_cmd} might be \\{tab\_mark} or
\\{car\_ret}.)  We also assume that \\{align\_state} is approximately 1000000
at
this time.  We remain in the same mode, and start the template if it is
called for.

\Y\P\4\&{procedure}\1\  \37\\{init\_col};\2\6
\&{begin} \37$\\{extra\_info}(\\{cur\_align})\K\\{cur\_cmd}$;\6
\&{if} $\\{cur\_cmd}=\\{omit}$ \1\&{then}\5
$\\{align\_state}\K0$\6
\4\&{else} \&{begin} \37\\{back\_input};\5
$\\{begin\_token\_list}(\\{u\_part}(\\{cur\_align}),\39\\{u\_template})$;\6
\&{end};\C{now $\\{align\_state}=1000000$}\2\6
\&{end};\par
\fi

\M965. The scanner sets \\{align\_state} to zero when the \<u_j> template ends.
When
a subsequent \.{\\cr} or \.{\\span} or tab mark occurs with $\\{align%
\_state}=0$,
the scanner activates the following code, which fires up the \<v_j> template.
We need to remember the \\{cur\_chr}, which is either \\{cr\_cr\_code}, \\{cr%
\_code},
\\{span\_code}, or a character code, depending on how the column text has
ended.

This part of the program had better not be activated when the preamble
to another alignment is being scanned, or when no alignment preamble is active.

\Y\P$\4\X965:Insert the \(v)\<v_j> template and \&{goto} \\{restart}\X\S$\6
\&{begin} \37\&{if} $(\\{scanner\_status}=\\{aligning})\V(\\{cur\_align}=%
\\{null})$ \1\&{then}\5
$\\{fatal\_error}(\.{"(interwoven\ alignment\ preambles\ are\ not\
allowed)"})$;\2\6
$\\{cur\_cmd}\K\\{extra\_info}(\\{cur\_align})$;\5
$\\{extra\_info}(\\{cur\_align})\K\\{cur\_chr}$;\6
\&{if} $\\{cur\_cmd}=\\{omit}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{omit\_template},\39\\{v\_template})$\6
\4\&{else} $\\{begin\_token\_list}(\\{v\_part}(\\{cur\_align}),\39\\{v%
\_template})$;\2\6
$\\{align\_state}\K1000000$;\5
\&{goto} \37\\{restart};\6
\&{end}\par
\U364.\fi

\M966. The token list \\{omit\_template} just referred to is a constant token
list that contains the special control sequence \.{\\endtemplate} only.

\Y\P$\4\X966:Initialize the special list heads and constant nodes\X\S$\6
$\\{info}(\\{omit\_template})\K\\{end\_template\_token}$;\C{$\\{link}(\\{omit%
\_template})=\\{null}$}\par
\As973, 996, 1158\ETs1165.
\U182.\fi

\M967. When the \\{endv} command at the end of a \<v_j> template comes through
the
scanner, things really start to happen; and it is the \\{fin\_col} routine
that makes them happen. This routine returns \\{true} if a row as well as a
column has been finished.

\Y\P\4\&{function}\1\  \37\\{fin\_col}: \37\\{boolean};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the alignrecord after the current one}\6
$\|q,\39\|r$: \37\\{pointer};\C{temporary pointers for list manipulation}\6
\|s: \37\\{pointer};\C{a new span node}\6
\|u: \37\\{pointer};\C{a new unset box}\6
\|w: \37\\{scaled};\C{natural width}\6
\|o: \37\\{glue\_ord};\C{order of infinity}\6
\|n: \37\\{halfword};\C{span counter}\2\6
\&{begin} \37\&{if} $\\{cur\_align}=\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"endv"})$;\2\6
$\|q\K\\{link}(\\{cur\_align})$;\ \&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"endv"})$;\2\6
\&{if} $\\{align\_state}<500000$ \1\&{then}\5
$\\{fatal\_error}(\.{"(interwoven\ alignment\ preambles\ are\ not\
allowed)"})$;\2\6
$\|p\K\\{link}(\|q)$;\5
\X968:If the preamble list has been traversed, check that the row has ended\X;\6
\&{if} $\\{extra\_info}(\\{cur\_align})\I\\{span\_code}$ \1\&{then}\6
\&{begin} \37\\{unsave};\5
$\\{new\_save\_level}(\\{align\_group})$;\6
\X972:Package an unset box for the current column and record its width\X;\6
\X971:Copy the tabskip glue between columns\X;\6
\&{if} $\\{extra\_info}(\\{cur\_align})\G\\{cr\_code}$ \1\&{then}\6
\&{begin} \37$\\{fin\_col}\K\\{true}$;\5
\&{return};\6
\&{end};\2\6
$\\{init\_span}(\|p)$;\6
\&{end};\2\6
$\\{align\_state}\K1000000$;\6
\1\&{repeat} \37\\{get\_x\_or\_protected};\6
\4\&{until}\5
$\\{cur\_cmd}\I\\{spacer}$;\2\6
$\\{cur\_align}\K\|p$;\5
\\{init\_col};\5
$\\{fin\_col}\K\\{false}$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M968. \P$\X968:If the preamble list has been traversed, check that the row has
ended\X\S$\6
\&{if} $(\|p=\\{null})\W(\\{extra\_info}(\\{cur\_align})<\\{cr\_code})$ \1%
\&{then}\6
\&{if} $\\{cur\_loop}\I\\{null}$ \1\&{then}\5
\X969:Lengthen the preamble periodically\X\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Extra\ alignment\ tab\ has\ been\
changed\ to\ "})$;\5
$\\{print\_esc}(\.{"cr"})$;\5
$\\{help3}(\.{"You\ have\ given\ more\ \\span\ or\ \&\ marks\ than\ there\
were"})$\6
$(\.{"in\ the\ preamble\ to\ the\ \\halign\ or\ \\valign\ now\ in\
progress."})$\6
$(\.{"So\ I\'ll\ assume\ that\ you\ meant\ to\ type\ \\cr\ instead."})$;\5
$\\{extra\_info}(\\{cur\_align})\K\\{cr\_code}$;\5
\\{error};\6
\&{end}\2\2\par
\U967.\fi

\M969. \P$\X969:Lengthen the preamble periodically\X\S$\6
\&{begin} \37$\\{link}(\|q)\K\\{new\_null\_box}$;\5
$\|p\K\\{link}(\|q)$;\C{a new alignrecord}\6
$\\{info}(\|p)\K\\{end\_span}$;\5
$\\{width}(\|p)\K\\{null\_flag}$;\5
$\\{cur\_loop}\K\\{link}(\\{cur\_loop})$;\5
\X970:Copy the templates from node \\{cur\_loop} into node \|p\X;\6
$\\{cur\_loop}\K\\{link}(\\{cur\_loop})$;\5
$\\{link}(\|p)\K\\{new\_glue}(\\{glue\_ptr}(\\{cur\_loop}))$;\5
$\\{subtype}(\\{link}(\|p))\K\\{tab\_skip\_code}+1$;\6
\&{end}\par
\U968.\fi

\M970. \P$\X970:Copy the templates from node \\{cur\_loop} into node \|p\X\S$\6
$\|q\K\\{hold\_head}$;\5
$\|r\K\\{u\_part}(\\{cur\_loop})$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{link}(\|q)\K\\{get\_avail}$;\5
$\|q\K\\{link}(\|q)$;\5
$\\{info}(\|q)\K\\{info}(\|r)$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
$\\{link}(\|q)\K\\{null}$;\5
$\\{u\_part}(\|p)\K\\{link}(\\{hold\_head})$;\5
$\|q\K\\{hold\_head}$;\5
$\|r\K\\{v\_part}(\\{cur\_loop})$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{link}(\|q)\K\\{get\_avail}$;\5
$\|q\K\\{link}(\|q)$;\5
$\\{info}(\|q)\K\\{info}(\|r)$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
$\\{link}(\|q)\K\\{null}$;\5
$\\{v\_part}(\|p)\K\\{link}(\\{hold\_head})$\par
\U969.\fi

\M971. \P$\X971:Copy the tabskip glue between columns\X\S$\6
$\\{tail\_append}(\\{new\_glue}(\\{glue\_ptr}(\\{link}(\\{cur\_align}))))$;\5
$\\{subtype}(\\{tail})\K\\{tab\_skip\_code}+1$\par
\U967.\fi

\M972. \P$\X972:Package an unset box for the current column and record its
width\X\S$\6
\&{begin} \37\&{if} $\\{mode}=-\\{hmode}$ \1\&{then}\6
\&{begin} \37$\\{adjust\_tail}\K\\{cur\_tail}$;\5
$\\{pre\_adjust\_tail}\K\\{cur\_pre\_tail}$;\5
$\|u\K\\{hpack}(\\{link}(\\{head}),\39\\{natural})$;\5
$\|w\K\\{width}(\|u)$;\5
$\\{cur\_tail}\K\\{adjust\_tail}$;\5
$\\{adjust\_tail}\K\\{null}$;\5
$\\{cur\_pre\_tail}\K\\{pre\_adjust\_tail}$;\5
$\\{pre\_adjust\_tail}\K\\{null}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|u\K\\{vpackage}(\\{link}(\\{head}),\39\\{natural},%
\390)$;\5
$\|w\K\\{height}(\|u)$;\6
\&{end};\2\6
$\|n\K\\{min\_quarterword}$;\C{this represents a span count of 1}\6
\&{if} $\\{cur\_span}\I\\{cur\_align}$ \1\&{then}\5
\X974:Update width entry for spanned columns\X\6
\4\&{else} \&{if} $\|w>\\{width}(\\{cur\_align})$ \1\&{then}\5
$\\{width}(\\{cur\_align})\K\|w$;\2\2\6
$\\{type}(\|u)\K\\{unset\_node}$;\5
$\\{span\_count}(\|u)\K\|n$;\6
\X835:Determine the stretch order\X;\6
$\\{glue\_order}(\|u)\K\|o$;\5
$\\{glue\_stretch}(\|u)\K\\{total\_stretch}[\|o]$;\6
\X841:Determine the shrink order\X;\6
$\\{glue\_sign}(\|u)\K\|o$;\5
$\\{glue\_shrink}(\|u)\K\\{total\_shrink}[\|o]$;\6
\\{pop\_nest};\5
$\\{link}(\\{tail})\K\|u$;\5
$\\{tail}\K\|u$;\6
\&{end}\par
\U967.\fi

\M973. A span node is a 2-word record containing \\{width}, \\{info}, and %
\\{link}
fields. The \\{link} field is not really a link, it indicates the number of
spanned columns; the \\{info} field points to a span node for the same
starting column, having a greater extent of spanning, or to \\{end\_span},
which has the largest possible \\{link} field; the \\{width} field holds the
largest natural width corresponding to a particular set of spanned columns.

A list of the maximum widths so far, for spanned columns starting at a
given column, begins with the \\{info} field of the alignrecord for that
column.

\Y\P\D \37$\\{span\_node\_size}=2$\C{number of \\{mem} words for a span node}%
\par
\Y\P$\4\X966:Initialize the special list heads and constant nodes\X\mathrel{+}%
\S$\6
$\\{link}(\\{end\_span})\K\\{max\_quarterword}+1$;\5
$\\{info}(\\{end\_span})\K\\{null}$;\par
\fi

\M974. \P$\X974:Update width entry for spanned columns\X\S$\6
\&{begin} \37$\|q\K\\{cur\_span}$;\6
\1\&{repeat} \37$\\{incr}(\|n)$;\5
$\|q\K\\{link}(\\{link}(\|q))$;\6
\4\&{until}\5
$\|q=\\{cur\_align}$;\2\6
\&{if} $\|n>\\{max\_quarterword}$ \1\&{then}\5
$\\{confusion}(\.{"256\ spans"})$;\C{this can happen, but won't}\2\6
$\|q\K\\{cur\_span}$;\6
\&{while} $\\{link}(\\{info}(\|q))<\|n$ \1\&{do}\5
$\|q\K\\{info}(\|q)$;\2\6
\&{if} $\\{link}(\\{info}(\|q))>\|n$ \1\&{then}\6
\&{begin} \37$\|s\K\\{get\_node}(\\{span\_node\_size})$;\5
$\\{info}(\|s)\K\\{info}(\|q)$;\5
$\\{link}(\|s)\K\|n$;\5
$\\{info}(\|q)\K\|s$;\5
$\\{width}(\|s)\K\|w$;\6
\&{end}\6
\4\&{else} \&{if} $\\{width}(\\{info}(\|q))<\|w$ \1\&{then}\5
$\\{width}(\\{info}(\|q))\K\|w$;\2\2\6
\&{end}\par
\U972.\fi

\M975. At the end of a row, we append an unset box to the current vlist (for
\.{\\halign}) or the current hlist (for \.{\\valign}). This unset box
contains the unset boxes for the columns, separated by the tabskip glue.
Everything will be set later.

\Y\P\4\&{procedure}\1\  \37\\{fin\_row};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new unset box}\2\6
\&{begin} \37\&{if} $\\{mode}=-\\{hmode}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{hpack}(\\{link}(\\{head}),\39\\{natural})$;\5
\\{pop\_nest};\6
\&{if} $\\{cur\_pre\_head}\I\\{cur\_pre\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{cur\_pre\_head})(\\{cur\_pre\_tail})$;\2\6
$\\{append\_to\_vlist}(\|p)$;\6
\&{if} $\\{cur\_head}\I\\{cur\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{cur\_head})(\\{cur\_tail})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{vpack}(\\{link}(\\{head}),\39\\{natural})$;\5
\\{pop\_nest};\5
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\5
$\\{space\_factor}\K1000$;\6
\&{end};\2\6
$\\{type}(\|p)\K\\{unset\_node}$;\5
$\\{glue\_stretch}(\|p)\K0$;\6
\&{if} $\\{every\_cr}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_cr},\39\\{every\_cr\_text})$;\2\6
\\{align\_peek};\6
\&{end};\C{note that $\\{glue\_shrink}(\|p)=0$ since $\\{glue\_shrink}\S%
\\{shift\_amount}$}\par
\fi

\M976. Finally, we will reach the end of the alignment, and we can breathe a
sigh of relief that memory hasn't overflowed. All the unset boxes will now be
set so that the columns line up, taking due account of spanned columns.

\Y\P\4\&{procedure}\1\  \37\\{do\_assignments};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{resume\_after\_display};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{build\_page};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{fin\_align};\6
\4\&{var} \37$\|p,\39\|q,\39\|r,\39\|s,\39\|u,\39\|v$: \37\\{pointer};%
\C{registers for the list operations}\6
$\|t,\39\|w$: \37\\{scaled};\C{width of column}\6
\|o: \37\\{scaled};\C{shift offset for unset boxes}\6
\|n: \37\\{halfword};\C{matching span amount}\6
\\{rule\_save}: \37\\{scaled};\C{temporary storage for \\{overfull\_rule}}\6
\\{aux\_save}: \37\\{memory\_word};\C{temporary storage for \\{aux}}\2\6
\&{begin} \37\&{if} $\\{cur\_group}\I\\{align\_group}$ \1\&{then}\5
$\\{confusion}(\.{"align1"})$;\2\6
\\{unsave};\C{that \\{align\_group} was for individual entries}\6
\&{if} $\\{cur\_group}\I\\{align\_group}$ \1\&{then}\5
$\\{confusion}(\.{"align0"})$;\2\6
\\{unsave};\C{that \\{align\_group} was for the whole alignment}\6
\&{if} $\\{nest}[\\{nest\_ptr}-1].\\{mode\_field}=\\{mmode}$ \1\&{then}\5
$\|o\K\\{display\_indent}$\6
\4\&{else} $\|o\K0$;\2\6
\X977:Go through the preamble list, determining the column widths and changing
the alignrecords to dummy unset boxes\X;\6
\X980:Package the preamble list, to determine the actual tabskip glue amounts,
and let \|p point to this prototype box\X;\6
\X981:Set the glue in all the unset boxes of the current list\X;\6
$\\{flush\_node\_list}(\|p)$;\5
\\{pop\_alignment};\5
\X988:Insert the \(c)current list into its environment\X;\6
\&{end};\6
\hbox{\4}\X961:Declare the procedure called \\{align\_peek}\X\par
\fi

\M977. It's time now to dismantle the preamble list and to compute the column
widths. Let $w_{ij}$ be the maximum of the natural widths of all entries
that span columns $i$ through $j$, inclusive. The alignrecord for column~$i$
contains $w_{ii}$ in its \\{width} field, and there is also a linked list of
the nonzero $w_{ij}$ for increasing $j$, accessible via the \\{info} field;
these span nodes contain the value $j-i+\\{min\_quarterword}$ in their
\\{link} fields. The values of $w_{ii}$ were initialized to \\{null\_flag},
which
we regard as $-\infty$.

The final column widths are defined by the formula
$$w_j=\max_{1\L i\L j}\biggl( w_{ij}-\sum_{i\L k<j}(t_k+w_k)\biggr),$$
where $t_k$ is the natural width of the tabskip glue between columns
$k$ and~$k+1$. However, if $w_{ij}=-\infty$ for all \|i in the range
$1\L\|i\L\|j$ (i.e., if every entry that involved column~\|j also involved
column~$\|j+1$), we let $w_j=0$, and we zero out the tabskip glue after
column~\|j.

\TeX\ computes these values by using the following scheme: First $w_1=w_{11}$.
Then replace $w_{2j}$ by $\max(w_{2j},w_{1j}-t_1-w_1)$, for all $j>1$.
Then $w_2=w_{22}$. Then replace $w_{3j}$ by $\max(w_{3j},w_{2j}-t_2-w_2)$
for all $j>2$; and so on. If any $w_j$ turns out to be $-\infty$, its
value is changed to zero and so is the next tabskip.

\Y\P$\4\X977:Go through the preamble list, determining the column widths and
changing the alignrecords to dummy unset boxes\X\S$\6
$\|q\K\\{link}(\\{preamble})$;\6
\1\&{repeat} \37$\\{flush\_list}(\\{u\_part}(\|q))$;\5
$\\{flush\_list}(\\{v\_part}(\|q))$;\5
$\|p\K\\{link}(\\{link}(\|q))$;\6
\&{if} $\\{width}(\|q)=\\{null\_flag}$ \1\&{then}\5
\X978:Nullify $\\{width}(\|q)$ and the tabskip glue following this column\X;\2\6
\&{if} $\\{info}(\|q)\I\\{end\_span}$ \1\&{then}\5
\X979:Merge the widths in the span nodes of \|q with those of \|p, destroying
the span nodes of \|q\X;\2\6
$\\{type}(\|q)\K\\{unset\_node}$;\5
$\\{span\_count}(\|q)\K\\{min\_quarterword}$;\5
$\\{height}(\|q)\K0$;\5
$\\{depth}(\|q)\K0$;\5
$\\{glue\_order}(\|q)\K\\{normal}$;\5
$\\{glue\_sign}(\|q)\K\\{normal}$;\5
$\\{glue\_stretch}(\|q)\K0$;\5
$\\{glue\_shrink}(\|q)\K0$;\5
$\|q\K\|p$;\6
\4\&{until}\5
$\|q=\\{null}$\2\par
\U976.\fi

\M978. \P$\X978:Nullify $\\{width}(\|q)$ and the tabskip glue following this
column\X\S$\6
\&{begin} \37$\\{width}(\|q)\K0$;\5
$\|r\K\\{link}(\|q)$;\5
$\|s\K\\{glue\_ptr}(\|r)$;\6
\&{if} $\|s\I\\{zero\_glue}$ \1\&{then}\6
\&{begin} \37$\\{add\_glue\_ref}(\\{zero\_glue})$;\5
$\\{delete\_glue\_ref}(\|s)$;\5
$\\{glue\_ptr}(\|r)\K\\{zero\_glue}$;\6
\&{end};\2\6
\&{end}\par
\U977.\fi

\M979. Merging of two span-node lists is a typical exercise in the manipulation
of
linearly linked data structures. The essential invariant in the following
 \&{repeat}  loop is that we want to dispense with node \|r, in \|q's list,
and \|u is its successor; all nodes of \|p's list up to and including \|s
have been processed, and the successor of \|s matches \|r or precedes \|r
or follows \|r, according as $\\{link}(\|r)=\|n$ or $\\{link}(\|r)>\|n$ or $%
\\{link}(\|r)<\|n$.

\Y\P$\4\X979:Merge the widths in the span nodes of \|q with those of \|p,
destroying the span nodes of \|q\X\S$\6
\&{begin} \37$\|t\K\\{width}(\|q)+\\{width}(\\{glue\_ptr}(\\{link}(\|q)))$;\5
$\|r\K\\{info}(\|q)$;\5
$\|s\K\\{end\_span}$;\5
$\\{info}(\|s)\K\|p$;\5
$\|n\K\\{min\_quarterword}+1$;\6
\1\&{repeat} \37$\\{width}(\|r)\K\\{width}(\|r)-\|t$;\5
$\|u\K\\{info}(\|r)$;\6
\&{while} $\\{link}(\|r)>\|n$ \1\&{do}\6
\&{begin} \37$\|s\K\\{info}(\|s)$;\5
$\|n\K\\{link}(\\{info}(\|s))+1$;\6
\&{end};\2\6
\&{if} $\\{link}(\|r)<\|n$ \1\&{then}\6
\&{begin} \37$\\{info}(\|r)\K\\{info}(\|s)$;\5
$\\{info}(\|s)\K\|r$;\5
$\\{decr}(\\{link}(\|r))$;\5
$\|s\K\|r$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{width}(\|r)>\\{width}(\\{info}(\|s))$ \1%
\&{then}\5
$\\{width}(\\{info}(\|s))\K\\{width}(\|r)$;\2\6
$\\{free\_node}(\|r,\39\\{span\_node\_size})$;\6
\&{end};\2\6
$\|r\K\|u$;\6
\4\&{until}\5
$\|r=\\{end\_span}$;\2\6
\&{end}\par
\U977.\fi

\M980. Now the preamble list has been converted to a list of alternating unset
boxes and tabskip glue, where the box widths are equal to the final
column sizes. In case of \.{\\valign}, we change the widths to heights,
so that a correct error message will be produced if the alignment is
overfull or underfull.

\Y\P$\4\X980:Package the preamble list, to determine the actual tabskip glue
amounts, and let \|p point to this prototype box\X\S$\6
$\\{save\_ptr}\K\\{save\_ptr}-2$;\5
$\\{pack\_begin\_line}\K-\\{mode\_line}$;\6
\&{if} $\\{mode}=-\\{vmode}$ \1\&{then}\6
\&{begin} \37$\\{rule\_save}\K\\{overfull\_rule}$;\5
$\\{overfull\_rule}\K0$;\C{prevent rule from being packaged}\6
$\|p\K\\{hpack}(\\{preamble},\39\\{saved}(1),\39\\{saved}(0))$;\5
$\\{overfull\_rule}\K\\{rule\_save}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{link}(\\{preamble})$;\6
\1\&{repeat} \37$\\{height}(\|q)\K\\{width}(\|q)$;\5
$\\{width}(\|q)\K0$;\5
$\|q\K\\{link}(\\{link}(\|q))$;\6
\4\&{until}\5
$\|q=\\{null}$;\2\6
$\|p\K\\{vpack}(\\{preamble},\39\\{saved}(1),\39\\{saved}(0))$;\5
$\|q\K\\{link}(\\{preamble})$;\6
\1\&{repeat} \37$\\{width}(\|q)\K\\{height}(\|q)$;\5
$\\{height}(\|q)\K0$;\5
$\|q\K\\{link}(\\{link}(\|q))$;\6
\4\&{until}\5
$\|q=\\{null}$;\2\6
\&{end};\2\6
$\\{pack\_begin\_line}\K0$\par
\U976.\fi

\M981. \P$\X981:Set the glue in all the unset boxes of the current list\X\S$\6
$\|q\K\\{link}(\\{head})$;\5
$\|s\K\\{head}$;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\|q)$ \1\&{then}\6
\&{if} $\\{type}(\|q)=\\{unset\_node}$ \1\&{then}\5
\X983:Set the unset box \|q and the unset boxes in it\X\6
\4\&{else} \&{if} $\\{type}(\|q)=\\{rule\_node}$ \1\&{then}\5
\X982:Make the running dimensions in rule \|q extend to the boundaries of the
alignment\X;\2\2\2\6
$\|s\K\|q$;\5
$\|q\K\\{link}(\|q)$;\6
\&{end}\2\par
\U976.\fi

\M982. \P$\X982:Make the running dimensions in rule \|q extend to the
boundaries of the alignment\X\S$\6
\&{begin} \37\&{if} $\\{is\_running}(\\{width}(\|q))$ \1\&{then}\5
$\\{width}(\|q)\K\\{width}(\|p)$;\2\6
\&{if} $\\{is\_running}(\\{height}(\|q))$ \1\&{then}\5
$\\{height}(\|q)\K\\{height}(\|p)$;\2\6
\&{if} $\\{is\_running}(\\{depth}(\|q))$ \1\&{then}\5
$\\{depth}(\|q)\K\\{depth}(\|p)$;\2\6
\&{if} $\|o\I0$ \1\&{then}\6
\&{begin} \37$\|r\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\\{null}$;\5
$\|q\K\\{hpack}(\|q,\39\\{natural})$;\5
$\\{shift\_amount}(\|q)\K\|o$;\5
$\\{link}(\|q)\K\|r$;\5
$\\{link}(\|s)\K\|q$;\6
\&{end};\2\6
\&{end}\par
\U981.\fi

\M983. The unset box \|q represents a row that contains one or more unset
boxes,
depending on how soon \.{\\cr} occurred in that row.

\Y\P$\4\X983:Set the unset box \|q and the unset boxes in it\X\S$\6
\&{begin} \37\&{if} $\\{mode}=-\\{vmode}$ \1\&{then}\6
\&{begin} \37$\\{type}(\|q)\K\\{hlist\_node}$;\5
$\\{width}(\|q)\K\\{width}(\|p)$;\6
\&{if} $\\{nest}[\\{nest\_ptr}-1].\\{mode\_field}=\\{mmode}$ \1\&{then}\5
$\\{set\_box\_lr}(\|q)(\\{dlist})$;\C{for \\{ship\_out}}\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{type}(\|q)\K\\{vlist\_node}$;\5
$\\{height}(\|q)\K\\{height}(\|p)$;\6
\&{end};\2\6
$\\{glue\_order}(\|q)\K\\{glue\_order}(\|p)$;\5
$\\{glue\_sign}(\|q)\K\\{glue\_sign}(\|p)$;\5
$\\{glue\_set}(\|q)\K\\{glue\_set}(\|p)$;\5
$\\{shift\_amount}(\|q)\K\|o$;\5
$\|r\K\\{link}(\\{list\_ptr}(\|q))$;\5
$\|s\K\\{link}(\\{list\_ptr}(\|p))$;\6
\1\&{repeat} \37\X984:Set the glue in node \|r and change it from an unset node%
\X;\6
$\|r\K\\{link}(\\{link}(\|r))$;\5
$\|s\K\\{link}(\\{link}(\|s))$;\6
\4\&{until}\5
$\|r=\\{null}$;\2\6
\&{end}\par
\U981.\fi

\M984. A box made from spanned columns will be followed by tabskip glue nodes
and
by empty boxes as if there were no spanning. This permits perfect alignment
of subsequent entries, and it prevents values that depend on floating point
arithmetic from entering into the dimensions of any boxes.

\Y\P$\4\X984:Set the glue in node \|r and change it from an unset node\X\S$\6
$\|n\K\\{span\_count}(\|r)$;\5
$\|t\K\\{width}(\|s)$;\5
$\|w\K\|t$;\5
$\|u\K\\{hold\_head}$;\5
$\\{set\_box\_lr}(\|r)(0)$;\C{for \\{ship\_out}}\6
\&{while} $\|n>\\{min\_quarterword}$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|n)$;\5
\X985:Append tabskip glue and an empty box to list \|u, and update \|s and \|t
as the prototype nodes are passed\X;\6
\&{end};\2\6
\&{if} $\\{mode}=-\\{vmode}$ \1\&{then}\5
\X986:Make the unset node \|r into an \\{hlist\_node} of width \|w, setting the
glue as if the width were \|t\X\6
\4\&{else} \X987:Make the unset node \|r into a \\{vlist\_node} of height \|w,
setting the glue as if the height were \|t\X;\2\6
$\\{shift\_amount}(\|r)\K0$;\6
\&{if} $\|u\I\\{hold\_head}$ \1\&{then}\C{append blank boxes to account for
spanned nodes}\6
\&{begin} \37$\\{link}(\|u)\K\\{link}(\|r)$;\5
$\\{link}(\|r)\K\\{link}(\\{hold\_head})$;\5
$\|r\K\|u$;\6
\&{end}\2\par
\U983.\fi

\M985. \P$\X985:Append tabskip glue and an empty box to list \|u, and update %
\|s and \|t as the prototype nodes are passed\X\S$\6
$\|s\K\\{link}(\|s)$;\5
$\|v\K\\{glue\_ptr}(\|s)$;\5
$\\{link}(\|u)\K\\{new\_glue}(\|v)$;\5
$\|u\K\\{link}(\|u)$;\5
$\\{subtype}(\|u)\K\\{tab\_skip\_code}+1$;\5
$\|t\K\|t+\\{width}(\|v)$;\6
\&{if} $\\{glue\_sign}(\|p)=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|v)=\\{glue\_order}(\|p)$ \1\&{then}\5
$\|t\K\|t+\\{round}(\\{float}(\\{glue\_set}(\|p))\ast\\{stretch}(\|v))$;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{glue\_sign}(\|p)=\\{shrinking}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{shrink\_order}(\|v)=\\{glue\_order}(\|p)$ \1\&{then}\5
$\|t\K\|t-\\{round}(\\{float}(\\{glue\_set}(\|p))\ast\\{shrink}(\|v))$;\2\6
\&{end};\2\2\6
$\|s\K\\{link}(\|s)$;\5
$\\{link}(\|u)\K\\{new\_null\_box}$;\5
$\|u\K\\{link}(\|u)$;\5
$\|t\K\|t+\\{width}(\|s)$;\6
\&{if} $\\{mode}=-\\{vmode}$ \1\&{then}\5
$\\{width}(\|u)\K\\{width}(\|s)$\ \&{else} \&{begin} \37$\\{type}(\|u)\K%
\\{vlist\_node}$;\5
$\\{height}(\|u)\K\\{width}(\|s)$;\6
\&{end}\2\par
\U984.\fi

\M986. \P$\X986:Make the unset node \|r into an \\{hlist\_node} of width \|w,
setting the glue as if the width were \|t\X\S$\6
\&{begin} \37$\\{height}(\|r)\K\\{height}(\|q)$;\5
$\\{depth}(\|r)\K\\{depth}(\|q)$;\6
\&{if} $\|t=\\{width}(\|r)$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{glue\_order}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\6
\&{end}\6
\4\&{else} \&{if} $\|t>\\{width}(\|r)$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{stretching}$;\6
\&{if} $\\{glue\_stretch}(\|r)=0$ \1\&{then}\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$\6
\4\&{else} $\\{glue\_set}(\|r)\K\\{unfloat}((\|t-\\{width}(\|r))/\\{glue%
\_stretch}(\|r))$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{glue\_order}(\|r)\K\\{glue\_sign}(\|r)$;\5
$\\{glue\_sign}(\|r)\K\\{shrinking}$;\6
\&{if} $\\{glue\_shrink}(\|r)=0$ \1\&{then}\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$\6
\4\&{else} \&{if} $(\\{glue\_order}(\|r)=\\{normal})\W(\\{width}(\|r)-\|t>%
\\{glue\_shrink}(\|r))$ \1\&{then}\5
$\\{set\_glue\_ratio\_one}(\\{glue\_set}(\|r))$\6
\4\&{else} $\\{glue\_set}(\|r)\K\\{unfloat}((\\{width}(\|r)-\|t)/\\{glue%
\_shrink}(\|r))$;\2\2\6
\&{end};\2\2\6
$\\{width}(\|r)\K\|w$;\5
$\\{type}(\|r)\K\\{hlist\_node}$;\6
\&{end}\par
\U984.\fi

\M987. \P$\X987:Make the unset node \|r into a \\{vlist\_node} of height \|w,
setting the glue as if the height were \|t\X\S$\6
\&{begin} \37$\\{width}(\|r)\K\\{width}(\|q)$;\6
\&{if} $\|t=\\{height}(\|r)$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{normal}$;\5
$\\{glue\_order}(\|r)\K\\{normal}$;\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$;\6
\&{end}\6
\4\&{else} \&{if} $\|t>\\{height}(\|r)$ \1\&{then}\6
\&{begin} \37$\\{glue\_sign}(\|r)\K\\{stretching}$;\6
\&{if} $\\{glue\_stretch}(\|r)=0$ \1\&{then}\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$\6
\4\&{else} $\\{glue\_set}(\|r)\K\\{unfloat}((\|t-\\{height}(\|r))/\\{glue%
\_stretch}(\|r))$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{glue\_order}(\|r)\K\\{glue\_sign}(\|r)$;\5
$\\{glue\_sign}(\|r)\K\\{shrinking}$;\6
\&{if} $\\{glue\_shrink}(\|r)=0$ \1\&{then}\5
$\\{set\_glue\_ratio\_zero}(\\{glue\_set}(\|r))$\6
\4\&{else} \&{if} $(\\{glue\_order}(\|r)=\\{normal})\W(\\{height}(\|r)-\|t>%
\\{glue\_shrink}(\|r))$ \1\&{then}\5
$\\{set\_glue\_ratio\_one}(\\{glue\_set}(\|r))$\6
\4\&{else} $\\{glue\_set}(\|r)\K\\{unfloat}((\\{height}(\|r)-\|t)/\\{glue%
\_shrink}(\|r))$;\2\2\6
\&{end};\2\2\6
$\\{height}(\|r)\K\|w$;\5
$\\{type}(\|r)\K\\{vlist\_node}$;\6
\&{end}\par
\U984.\fi

\M988. We now have a completed alignment, in the list that starts at \\{head}
and ends at \\{tail}. This list will be merged with the one that encloses
it. (In case the enclosing mode is \\{mmode}, for displayed formulas,
we will need to insert glue before and after the display; that part of the
program will be deferred until we're more familiar with such operations.)

In restricted horizontal mode, the \\{clang} part of \\{aux} is undefined;
an over-cautious \PASCAL\ runtime system may complain about this.

\Y\P$\4\X988:Insert the \(c)current list into its environment\X\S$\6
$\\{aux\_save}\K\\{aux}$;\5
$\|p\K\\{link}(\\{head})$;\5
$\|q\K\\{tail}$;\5
\\{pop\_nest};\6
\&{if} $\\{mode}=\\{mmode}$ \1\&{then}\5
\X1384:Finish an alignment in a display\X\6
\4\&{else} \&{begin} \37$\\{aux}\K\\{aux\_save}$;\5
$\\{link}(\\{tail})\K\|p$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{tail}\K\|q$;\2\6
\&{if} $\\{mode}=\\{vmode}$ \1\&{then}\5
\\{build\_page};\2\6
\&{end}\2\par
\U976.\fi

\N989.  \[38] Breaking paragraphs into lines.
We come now to what is probably the most interesting algorithm of \TeX:
the mechanism for choosing the ``best possible'' breakpoints that yield
the individual lines of a paragraph. \TeX's line-breaking algorithm takes
a given horizontal list and converts it to a sequence of boxes that are
appended to the current vertical list. In the course of doing this, it
creates a special data structure containing three kinds of records that are
not used elsewhere in \TeX. Such nodes are created while a paragraph is
being processed, and they are destroyed afterwards; thus, the other parts
of \TeX\ do not need to know anything about how line-breaking is done.

The method used here is based on an approach devised by Michael F. Plass and
the author in 1977, subsequently generalized and improved by the same two
people in 1980. A detailed discussion appears in {\sl Software---Practice
and Experience \bf11} (1981), 1119--1184, where it is shown that the
line-breaking problem can be regarded as a special case of the problem of
computing the shortest path in an acyclic network. The cited paper includes
numerous examples and describes the history of line breaking as it has been
practiced by printers through the ages. The present implementation adds two
new ideas to the algorithm of 1980: Memory space requirements are considerably
reduced by using smaller records for inactive nodes than for active ones,
and arithmetic overflow is avoided by using ``delta distances'' instead of
keeping track of the total distance from the beginning of the paragraph to the
current point.

\fi

\M990. The \\{line\_break} procedure should be invoked only in horizontal mode;
it
leaves that mode and places its output into the current vlist of the
enclosing vertical mode (or internal vertical mode).
There is one explicit parameter:  \|d is true for partial paragraphs
preceding display math mode; in this case the amount of additional
penalty inserted before the final line is \\{display\_widow\_penalty}
instead of \\{widow\_penalty}.

There are also a number of implicit parameters: The hlist to be broken
starts at $\\{link}(\\{head})$, and it is nonempty. The value of \\{prev\_graf}
in the
enclosing semantic level tells where the paragraph should begin in the
sequence of line numbers, in case hanging indentation or \.{\\parshape}
is in use; \\{prev\_graf} is zero unless this paragraph is being continued
after a displayed formula.  Other implicit parameters, such as the
\\{par\_shape\_ptr} and various penalties to use for hyphenation, etc., appear
in \\{eqtb}.

After \\{line\_break} has acted, it will have updated the current vlist and the
value of \\{prev\_graf}. Furthermore, the global variable \\{just\_box} will
point to the final box created by \\{line\_break}, so that the width of this
line can be ascertained when it is necessary to decide whether to use
\\{above\_display\_skip} or \\{above\_display\_short\_skip} before a displayed
formula.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{just\_box}: \37\\{pointer};\C{the \\{hlist\_node} for the last line of the
new paragraph}\par
\fi

\M991. Since \\{line\_break} is a rather lengthy procedure---sort of a small
world unto
itself---we must build it up little by little, somewhat more cautiously
than we have done with the simpler procedures of \TeX. Here is the
general outline.

\Y\P\hbox{\4}\X1002:Declare subprocedures for \\{line\_break}\X \6
\4\&{procedure}\1\  \37$\\{line\_break}(\|d:\\{boolean})$;\6
\4\&{label} \37$\\{done},\39\\{done1},\39\\{done2},\39\\{done3},\39\\{done4},%
\39\\{done5},\39\\{continue}$;\6
\4\&{var} \37\X1038:Local variables for line breaking\X\2\6
\&{begin} \37$\\{pack\_begin\_line}\K\\{mode\_line}$;\C{this is for
over/underfull box messages}\6
\X992:Get ready to start line breaking\X;\6
\X1039:Find optimal breakpoints\X;\6
\X1052:Break the paragraph at the chosen breakpoints, justify the resulting
lines to the correct widths, and append them to the current vertical list\X;\6
\X1041:Clean up the memory by removing the break nodes\X;\6
$\\{pack\_begin\_line}\K0$;\6
\&{end};\7
\hbox{\4}\X1656:Declare \eTeX\ procedures for use by \\{main\_control}\X\par
\fi

\M992. The first task is to move the list from \\{head} to \\{temp\_head} and
go
into the enclosing semantic level. We also append the \.{\\parfillskip}
glue to the end of the paragraph, removing a space (or other glue node) if
it was there, since spaces usually precede blank lines and instances of
`\.{\$\$}'. The \\{par\_fill\_skip} is preceded by an infinite penalty, so
it will never be considered as a potential breakpoint.

This code assumes that a \\{glue\_node} and a \\{penalty\_node} occupy the
same number of \\{mem}~words.

\Y\P$\4\X992:Get ready to start line breaking\X\S$\6
$\\{link}(\\{temp\_head})\K\\{link}(\\{head})$;\6
\&{if} $\\{is\_char\_node}(\\{tail})$ \1\&{then}\5
$\\{tail\_append}(\\{new\_penalty}(\\{inf\_penalty}))$\6
\4\&{else} \&{if} $\\{type}(\\{tail})\I\\{glue\_node}$ \1\&{then}\5
$\\{tail\_append}(\\{new\_penalty}(\\{inf\_penalty}))$\6
\4\&{else} \&{begin} \37$\\{type}(\\{tail})\K\\{penalty\_node}$;\5
$\\{delete\_glue\_ref}(\\{glue\_ptr}(\\{tail}))$;\5
$\\{flush\_node\_list}(\\{leader\_ptr}(\\{tail}))$;\5
$\\{penalty}(\\{tail})\K\\{inf\_penalty}$;\6
\&{end};\2\2\6
$\\{link}(\\{tail})\K\\{new\_param\_glue}(\\{par\_fill\_skip\_code})$;\5
$\\{last\_line\_fill}\K\\{link}(\\{tail})$;\5
$\\{init\_cur\_lang}\K\\{prev\_graf}\mathbin{\&{mod}}\O{200000}$;\5
$\\{init\_l\_hyf}\K\\{prev\_graf}\mathbin{\&{div}}\O{20000000}$;\5
$\\{init\_r\_hyf}\K(\\{prev\_graf}\mathbin{\&{div}}\O{200000})\mathbin{\&{mod}}%
\O{100}$;\5
\\{pop\_nest};\par
\As1003, 1010\ETs1024.
\U991.\fi

\M993. When looking for optimal line breaks, \TeX\ creates a ``break node'' for
each break that is {\sl feasible}, in the sense that there is a way to end
a line at the given place without requiring any line to stretch more than
a given tolerance. A break node is characterized by three things: the position
of the break (which is a pointer to a \\{glue\_node}, \\{math\_node}, %
\\{penalty\_node},
or \\{disc\_node}); the ordinal number of the line that will follow this
breakpoint; and the fitness classification of the line that has just
ended, i.e., \\{tight\_fit}, \\{decent\_fit}, \\{loose\_fit}, or \\{very\_loose%
\_fit}.

\Y\P\D \37$\\{tight\_fit}=3$\C{fitness classification for lines shrinking 0.5
to 1.0 of their   shrinkability}\par
\P\D \37$\\{loose\_fit}=1$\C{fitness classification for lines stretching 0.5 to
1.0 of their   stretchability}\par
\P\D \37$\\{very\_loose\_fit}=0$\C{fitness classification for lines stretching
more than   their stretchability}\par
\P\D \37$\\{decent\_fit}=2$\C{fitness classification for all other lines}\par
\fi

\M994. The algorithm essentially determines the best possible way to achieve
each feasible combination of position, line, and fitness. Thus, it answers
questions like, ``What is the best way to break the opening part of the
paragraph so that the fourth line is a tight line ending at such-and-such
a place?'' However, the fact that all lines are to be the same length
after a certain point makes it possible to regard all sufficiently large
line numbers as equivalent, when the looseness parameter is zero, and this
makes it possible for the algorithm to save space and time.

An ``active node'' and a ``passive node'' are created in \\{mem} for each
feasible breakpoint that needs to be considered. Active nodes are three
words long and passive nodes are two words long. We need active nodes only
for breakpoints near the place in the paragraph that is currently being
examined, so they are recycled within a comparatively short time after
they are created.

\fi

\M995. An active node for a given breakpoint contains six fields:

\yskip\hang\\{link} points to the next node in the list of active nodes; the
last active node has $\\{link}=\\{last\_active}$.

\yskip\hang\\{break\_node} points to the passive node associated with this
breakpoint.

\yskip\hang\\{line\_number} is the number of the line that follows this
breakpoint.

\yskip\hang\\{fitness} is the fitness classification of the line ending at this
breakpoint.

\yskip\hang\\{type} is either \\{hyphenated} or \\{unhyphenated}, depending on
whether this breakpoint is a \\{disc\_node}.

\yskip\hang\\{total\_demerits} is the minimum possible sum of demerits over all
lines leading from the beginning of the paragraph to this breakpoint.

\yskip\noindent
The value of $\\{link}(\\{active})$ points to the first active node on a linked
list
of all currently active nodes. This list is in order by \\{line\_number},
except that nodes with $\\{line\_number}>\\{easy\_line}$ may be in any order
relative
to each other.

\Y\P\D \37$\\{active\_node\_size\_normal}=3$\C{number of words in normal active
nodes}\par
\P\D \37$\\{fitness}\S\\{subtype}$\C{$\\{very\_loose\_fit}\to\\{tight\_fit}$ on
final line for this break}\par
\P\D \37$\\{break\_node}\S\\{rlink}$\C{pointer to the corresponding passive
node}\par
\P\D \37$\\{line\_number}\S\\{llink}$\C{line that begins at this breakpoint}\par
\P\D \37$\\{total\_demerits}(\#)\S\\{mem}[\#+2].\\{int}$\C{the quantity that %
\TeX\ minimizes}\par
\P\D \37$\\{unhyphenated}=0$\C{the \\{type} of a normal active break node}\par
\P\D \37$\\{hyphenated}=1$\C{the \\{type} of an active node that breaks at a %
\\{disc\_node}}\par
\P\D \37$\\{last\_active}\S\\{active}$\C{the active list ends where it begins}%
\par
\fi

\M996. \P$\X966:Initialize the special list heads and constant nodes\X%
\mathrel{+}\S$\6
$\\{type}(\\{last\_active})\K\\{hyphenated}$;\5
$\\{line\_number}(\\{last\_active})\K\\{max\_halfword}$;\5
$\\{subtype}(\\{last\_active})\K0$;\C{the \\{subtype} is never examined by the
algorithm}\par
\fi

\M997. The passive node for a given breakpoint contains only four fields:

\yskip\hang\\{link} points to the passive node created just before this one,
if any, otherwise it is \\{null}.

\yskip\hang\\{cur\_break} points to the position of this breakpoint in the
horizontal list for the paragraph being broken.

\yskip\hang\\{prev\_break} points to the passive node that should precede this
one in an optimal path to this breakpoint.

\yskip\hang\\{serial} is equal to \|n if this passive node is the \|nth
one created during the current pass. (This field is used only when
printing out detailed statistics about the line-breaking calculations.)

\yskip\noindent
There is a global variable called \\{passive} that points to the most
recently created passive node. Another global variable, \\{printed\_node},
is used to help print out the paragraph when detailed information about
the line-breaking computation is being displayed.

\Y\P\D \37$\\{passive\_node\_size}=2$\C{number of words in passive nodes}\par
\P\D \37$\\{cur\_break}\S\\{rlink}$\C{in passive node, points to position of
this breakpoint}\par
\P\D \37$\\{prev\_break}\S\\{llink}$\C{points to passive node that should
precede this one}\par
\P\D \37$\\{serial}\S\\{info}$\C{serial number for symbolic identification}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{passive}: \37\\{pointer};\C{most recent node on passive list}\6
\4\\{printed\_node}: \37\\{pointer};\C{most recent node that has been printed}\6
\4\\{pass\_number}: \37\\{halfword};\C{the number of passive nodes allocated on
this pass}\par
\fi

\M998. The active list also contains ``delta'' nodes that help the algorithm
compute the badness of individual lines. Such nodes appear only between two
active nodes, and they have $\\{type}=\\{delta\_node}$. If \|p and \|r are
active nodes
and if \|q is a delta node between them, so that $\\{link}(\|p)=\|q$ and $%
\\{link}(\|q)=\|r$,
then \|q tells the space difference between lines in the horizontal list that
start after breakpoint \|p and lines that start after breakpoint \|r. In
other words, if we know the length of the line that starts after \|p and
ends at our current position, then the corresponding length of the line that
starts after \|r is obtained by adding the amounts in node~\|q. A delta node
contains six scaled numbers, since it must record the net change in glue
stretchability with respect to all orders of infinity. The natural width
difference appears in $\\{mem}[\|q+1].\\{sc}$; the stretch differences in units
of
pt, fil, fill, and filll appear in $\\{mem}[\|q+2\to\|q+5].\\{sc}$; and the
shrink difference
appears in $\\{mem}[\|q+6].\\{sc}$. The \\{subtype} field of a delta node is
not used.

\Y\P\D \37$\\{delta\_node\_size}=9$\C{number of words in a delta node}\par
\P\D \37$\\{delta\_node}=2$\C{\\{type} field in a delta node}\par
\fi

\M999. As the algorithm runs, it maintains a set of six delta-like registers
for the length of the line following the first active breakpoint to the
current position in the given hlist. When it makes a pass through the
active list, it also maintains a similar set of six registers for the
length following the active breakpoint of current interest. A third set
holds the length of an empty line (namely, the sum of \.{\\leftskip} and
\.{\\rightskip}); and a fourth set is used to create new delta nodes.

When we pass a delta node we want to do operations like
$$\hbox{\ignorespaces \&{for} $\|k\K1\mathrel{\&{to}}6$ \&{do} $\\{cur\_active%
\_width}[\|k]\K\\{cur\_active\_width}[\|k]+\\{mem}[\|q+\|k].\\{sc}$};$$ and we
want to do this without the overhead of  \&{for}  loops. The \\{do\_all\_six}
macro makes such six-tuples convenient.

\Y\P\D \37$\\{do\_all\_six}(\#)\S\#(1)$;\5
$\#(2)$;\5
$\#(3)$;\5
$\#(4)$;\5
$\#(5)$;\5
$\#(6)$\par
\P\D \37$\\{do\_seven\_eight}(\#)\S$\1\6
\&{if} $\\{pdf\_adjust\_spacing}>1$ \1\&{then}\6
\&{begin} \37$\#(7)$;\5
$\#(8)$;\6
\&{end}\2\2\par
\P\D \37$\\{do\_all\_eight}(\#)\S\\{do\_all\_six}(\#)$;\5
$\\{do\_seven\_eight}(\#)$\par
\P\D \37$\\{do\_one\_seven\_eight}(\#)\S\#(1)$;\5
$\\{do\_seven\_eight}(\#)$\par
\P\D \37$\\{total\_font\_stretch}\S\\{cur\_active\_width}[7]$\par
\P\D \37$\\{total\_font\_shrink}\S\\{cur\_active\_width}[8]$\par
\P\D \37$\\{save\_active\_width}(\#)\S\\{prev\_active\_width}[\#]\K\\{active%
\_width}[\#]$\par
\P\D \37$\\{restore\_active\_width}(\#)\S\\{active\_width}[\#]\K\\{prev\_active%
\_width}[\#]$\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{active\_width}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{distance from first active node to~\\{cur\_p}}\2\6
\4\\{cur\_active\_width}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{distance from current active node}\2\6
\4\\{background}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{length of an ``empty'' line}\2\6
\4\\{break\_width}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{length being computed after current break}\2\6
\4\\{auto\_breaking}: \37\\{boolean};\C{make \\{auto\_breaking} accessible out
of \\{line\_break}}\6
\4\\{prev\_p}: \37\\{pointer};\C{make \\{prev\_p} accessible out of \\{line%
\_break}}\6
\4\\{first\_p}: \37\\{pointer};\C{to access the first node of the paragraph}\6
\4\\{prev\_char\_p}: \37\\{pointer};\C{pointer to the previous char of an
implicit kern}\6
\4\\{next\_char\_p}: \37\\{pointer};\C{pointer to the next char of an implicit
kern}\7
\4\\{try\_prev\_break}: \37\\{boolean};\C{force break at the previous legal
breakpoint?}\6
\4\\{prev\_legal}: \37\\{pointer};\C{the previous legal breakpoint}\6
\4\\{prev\_prev\_legal}: \37\\{pointer};\C{to save \\{prev\_p} corresponding to
\\{prev\_legal}}\6
\4\\{prev\_auto\_breaking}: \37\\{boolean};\C{to save \\{auto\_breaking}
corresponding to \\{prev\_legal}}\6
\4\\{prev\_active\_width}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{to save \\{active\_width} corresponding to \\{prev\_legal}}\2\6
\4\\{rejected\_cur\_p}: \37\\{pointer};\C{the last \\{cur\_p} that has been
rejected}\6
\4\\{before\_rejected\_cur\_p}: \37\\{boolean};\C{\\{cur\_p} is still before %
\\{rejected\_cur\_p}?}\7
\4\\{max\_stretch\_ratio}: \37\\{integer};\C{maximal stretch ratio of expanded
fonts}\6
\4\\{max\_shrink\_ratio}: \37\\{integer};\C{maximal shrink ratio of expanded
fonts}\6
\4\\{cur\_font\_step}: \37\\{integer};\C{the current step of expanded fonts}\par
\fi

\M1000. Let's state the principles of the delta nodes more precisely and
concisely,
so that the following programs will be less obscure. For each legal
breakpoint~\|p in the paragraph, we define two quantities $\alpha(p)$ and
$\beta(p)$ such that the length of material in a line from breakpoint~\|p
to breakpoint~\|q is $\gamma+\beta(q)-\alpha(p)$, for some fixed $\gamma$.
Intuitively, $\alpha(p)$ and $\beta(q)$ are the total length of material from
the beginning of the paragraph to a point ``after'' a break at \|p and to a
point ``before'' a break at \|q; and $\gamma$ is the width of an empty line,
namely the length contributed by \.{\\leftskip} and \.{\\rightskip}.

Suppose, for example, that the paragraph consists entirely of alternating
boxes and glue skips; let the boxes have widths $x_1\ldots x_n$ and
let the skips have widths $y_1\ldots y_n$, so that the paragraph can be
represented by $x_1y_1\ldots x_ny_n$. Let $p_i$ be the legal breakpoint
at $y_i$; then $\alpha(p_i)=x_1+y_1+\cdots+x_i+y_i$, and $\beta(p_i)=
x_1+y_1+\cdots+x_i$. To check this, note that the length of material from
$p_2$ to $p_5$, say, is $\gamma+x_3+y_3+x_4+y_4+x_5=\gamma+\beta(p_5)
-\alpha(p_2)$.

The quantities $\alpha$, $\beta$, $\gamma$ involve glue stretchability and
shrinkability as well as a natural width. If we were to compute $\alpha(p)$
and $\beta(p)$ for each \|p, we would need multiple precision arithmetic, and
the multiprecise numbers would have to be kept in the active nodes.
\TeX\ avoids this problem by working entirely with relative differences
or ``deltas.'' Suppose, for example, that the active list contains
$a_1\,\delta_1\,a_2\,\delta_2\,a_3$, where the \|a's are active breakpoints
and the $\delta$'s are delta nodes. Then $\delta_1=\alpha(a_1)-\alpha(a_2)$
and $\delta_2=\alpha(a_2)-\alpha(a_3)$. If the line breaking algorithm is
currently positioned at some other breakpoint \|p, the \\{active\_width} array
contains the value $\gamma+\beta(p)-\alpha(a_1)$. If we are scanning through
the list of active nodes and considering a tentative line that runs from
$a_2$ to~\|p, say, the \\{cur\_active\_width} array will contain the value
$\gamma+\beta(p)-\alpha(a_2)$. Thus, when we move from $a_2$ to $a_3$,
we want to add $\alpha(a_2)-\alpha(a_3)$ to \\{cur\_active\_width}; and this
is just $\delta_2$, which appears in the active list between $a_2$ and
$a_3$. The \\{background} array contains $\gamma$. The \\{break\_width} array
will be used to calculate values of new delta nodes when the active
list is being updated.

\fi

\M1001. Glue nodes in a horizontal list that is being paragraphed are not
supposed to
include ``infinite'' shrinkability; that is why the algorithm maintains
four registers for stretching but only one for shrinking. If the user tries to
introduce infinite shrinkability, the shrinkability will be reset to finite
and an error message will be issued. A boolean variable \\{no\_shrink\_error%
\_yet}
prevents this error message from appearing more than once per paragraph.

\Y\P\D \37$\\{check\_shrinkage}(\#)\S$\1\6
\&{if} $(\\{shrink\_order}(\#)\I\\{normal})\W(\\{shrink}(\#)\I0)$ \1\&{then}\6
\&{begin} \37$\#\K\\{finite\_shrink}(\#)$;\6
\&{end}\2\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{no\_shrink\_error\_yet}: \37\\{boolean};\C{have we complained about
infinite shrinkage?}\par
\fi

\M1002. \P$\X1002:Declare subprocedures for \\{line\_break}\X\S$\6
\4\&{function}\1\  \37$\\{finite\_shrink}(\|p:\\{pointer})$: \37\\{pointer};%
\C{recovers from infinite shrinkage}\6
\4\&{var} \37\|q: \37\\{pointer};\C{new glue specification}\2\6
\&{begin} \37\&{if} $\\{no\_shrink\_error\_yet}$ \1\&{then}\6
\&{begin} \37$\\{no\_shrink\_error\_yet}\K\\{false}$;\6
\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
$\\{end\_diagnostic}(\\{true})$;\ \2\6
\&{tats}\5
$\\{print\_err}(\.{"Infinite\ glue\ shrinkage\ found\ in\ a\ paragraph"})$;\5
$\\{help5}(\.{"The\ paragraph\ just\ ended\ includes\ some\ glue\ that\ has"})$%
\6
$(\.{"infinite\ shrinkability,\ e.g.,\ \`\\hskip\ 0pt\ minus\ 1fil\'."})$\6
$(\.{"Such\ glue\ doesn\'t\ belong\ there---it\ allows\ a\ paragraph"})$\6
$(\.{"of\ any\ length\ to\ fit\ on\ one\ line.\ But\ it\'s\ safe\ to\
proceed,"})$\6
$(\.{"since\ the\ offensive\ shrinkability\ has\ been\ made\ finite."})$;\5
\\{error};\6
\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
\\{begin\_diagnostic};\ \2\6
\&{tats}\6
\&{end};\2\6
$\|q\K\\{new\_spec}(\|p)$;\5
$\\{shrink\_order}(\|q)\K\\{normal}$;\5
$\\{delete\_glue\_ref}(\|p)$;\5
$\\{finite\_shrink}\K\|q$;\6
\&{end};\par
\As1005, 1053, 1072\ETs1119.
\U991.\fi

\M1003. \P$\X992:Get ready to start line breaking\X\mathrel{+}\S$\6
$\\{no\_shrink\_error\_yet}\K\\{true}$;\6
$\\{check\_shrinkage}(\\{left\_skip})$;\5
$\\{check\_shrinkage}(\\{right\_skip})$;\6
$\|q\K\\{left\_skip}$;\5
$\|r\K\\{right\_skip}$;\5
$\\{background}[1]\K\\{width}(\|q)+\\{width}(\|r)$;\6
$\\{background}[2]\K0$;\5
$\\{background}[3]\K0$;\5
$\\{background}[4]\K0$;\5
$\\{background}[5]\K0$;\6
$\\{background}[2+\\{stretch\_order}(\|q)]\K\\{stretch}(\|q)$;\6
$\\{background}[2+\\{stretch\_order}(\|r)]\K\30\\{background}[2+\\{stretch%
\_order}(\|r)]+\\{stretch}(\|r)$;\6
$\\{background}[6]\K\\{shrink}(\|q)+\\{shrink}(\|r)$;\6
\&{if} $\\{pdf\_adjust\_spacing}>1$ \1\&{then}\6
\&{begin} \37$\\{background}[7]\K0$;\5
$\\{background}[8]\K0$;\5
$\\{max\_stretch\_ratio}\K-1$;\5
$\\{max\_shrink\_ratio}\K-1$;\5
$\\{cur\_font\_step}\K-1$;\5
$\\{prev\_char\_p}\K\\{null}$;\6
\&{end};\2\6
\X1843:Check for special treatment of last line of paragraph\X;\par
\fi

\M1004. A pointer variable \\{cur\_p} runs through the given horizontal list as
we look
for breakpoints. This variable is global, since it is used both by \\{line%
\_break}
and by its subprocedure \\{try\_break}.

Another global variable called \\{threshold} is used to determine the
feasibility
of individual lines: Breakpoints are feasible if there is a way to reach
them without creating lines whose badness exceeds \\{threshold}.  (The
badness is compared to \\{threshold} before penalties are added, so that
penalty values do not affect the feasibility of breakpoints, except that
no break is allowed when the penalty is 10000 or more.) If \\{threshold}
is 10000 or more, all legal breaks are considered feasible, since the
\\{badness} function specified above never returns a value greater than~10000.

Up to three passes might be made through the paragraph in an attempt to find at
least one set of feasible breakpoints. On the first pass, we have
$\\{threshold}=\\{pretolerance}$ and $\\{second\_pass}=\\{final\_pass}=%
\\{false}$.
If this pass fails to find a
feasible solution, \\{threshold} is set to \\{tolerance}, \\{second\_pass} is
set
\\{true}, and an attempt is made to hyphenate as many words as possible.
If that fails too, we add \\{emergency\_stretch} to the background
stretchability and set $\\{final\_pass}=\\{true}$.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_p}: \37\\{pointer};\C{the current breakpoint under consideration}\6
\4\\{second\_pass}: \37\\{boolean};\C{is this our second attempt to break this
paragraph?}\6
\4\\{final\_pass}: \37\\{boolean};\C{is this our final attempt to break this
paragraph?}\6
\4\\{threshold}: \37\\{integer};\C{maximum badness on feasible lines}\par
\fi

\M1005. The heart of the line-breaking procedure is `\\{try\_break}', a
subroutine
that tests if the current breakpoint \\{cur\_p} is feasible, by running
through the active list to see what lines of text can be made from active
nodes to~\\{cur\_p}.  If feasible breaks are possible, new break nodes are
created.  If \\{cur\_p} is too far from an active node, that node is
deactivated.

The parameter \\{pi} to \\{try\_break} is the penalty associated
with a break at \\{cur\_p}; we have $\\{pi}=\\{eject\_penalty}$ if the break is
forced,
and $\\{pi}=\\{inf\_penalty}$ if the break is illegal.

The other parameter, \\{break\_type}, is set to \\{hyphenated} or %
\\{unhyphenated},
depending on whether or not the current break is at a \\{disc\_node}. The
end of a paragraph is also regarded as `\\{hyphenated}'; this case is
distinguishable by the condition $\\{cur\_p}=\\{null}$.

\Y\P\D \37$\\{copy\_to\_cur\_active}(\#)\S\\{cur\_active\_width}[\#]\K\\{active%
\_width}[\#]$\par
\P\D \37$\\{deactivate}=60$\C{go here when node \|r should be deactivated}\par
\P\D \37$\\{cp\_skipable}(\#)\S$\C{skipable nodes at the margins during
character protrusion}\6
$(\R\\{is\_char\_node}(\#)\W($$(\\{type}(\#)=\\{ins\_node})\V(\\{type}(\#)=%
\\{mark\_node})\V(\\{type}(\#)=\\{adjust\_node})\V(\\{type}(\#)=\\{penalty%
\_node})\V((\\{type}(\#)=\\{whatsit\_node})\W(\\{subtype}(\#)\I\\{pdf%
\_refximage\_node})\W(\\{subtype}(\#)\I\\{pdf\_refxform\_node}))$\C{reference
to an image or XObject form}\6
$\V((\\{type}(\#)=\\{disc\_node})\W(\\{pre\_break}(\#)=\\{null})\W(\\{post%
\_break}(\#)=\\{null})\W(\\{replace\_count}(\#)=0))$\C{an empty \\{disc\_node}}%
\6
$\V((\\{type}(\#)=\\{math\_node})\W(\\{width}(\#)=0))\V((\\{type}(\#)=\\{kern%
\_node})\W((\\{width}(\#)=0)\V(\\{subtype}(\#)=\\{normal})\V(\\{subtype}(\#)=%
\\{auto\_kern})))\V((\\{type}(\#)=\\{glue\_node})\W(\\{glue\_ptr}(\#)=\\{zero%
\_glue}))\V((\\{type}(\#)=\\{hlist\_node})\W(\\{width}(\#)=0)\W(\\{height}(%
\#)=0)\W(\\{depth}(\#)=0)\W(\\{list\_ptr}(\#)=\\{null}))$$))$\par
\Y\P$\4\X1002:Declare subprocedures for \\{line\_break}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{push\_node}(\|p:\\{pointer})$;\2\6
\&{begin} \37\&{if} $\\{hlist\_stack\_level}>\\{max\_hlist\_stack}$ \1\&{then}\5
$\\{pdf\_error}(\.{"push\_node"},\39\.{"stack\ overflow"})$;\2\6
$\\{hlist\_stack}[\\{hlist\_stack\_level}]\K\|p$;\5
$\\{hlist\_stack\_level}\K\\{hlist\_stack\_level}+1$;\6
\&{end};\6
\4\&{function}\1\  \37\\{pop\_node}: \37\\{pointer};\2\6
\&{begin} \37$\\{hlist\_stack\_level}\K\\{hlist\_stack\_level}-1$;\6
\&{if} $\\{hlist\_stack\_level}<0$ \1\&{then}\C{would point to some bug}\6
$\\{pdf\_error}(\.{"pop\_node"},\39\.{"stack\ underflow\ (internal\ error)"})$;%
\2\6
$\\{pop\_node}\K\\{hlist\_stack}[\\{hlist\_stack\_level}]$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{find\_protchar\_left}(\|l:\\{pointer};\,\35\|d:%
\\{boolean})$: \37\\{pointer};\C{searches left to right from list head \|l,
returns 1st non-skipable item}\6
\4\&{var} \37\|t: \37\\{pointer};\5
\\{run}: \37\\{boolean};\2\6
\&{begin} \37\&{if} $(\\{link}(\|l)\I\\{null})\W(\\{type}(\|l)=\\{hlist\_node})%
\W(\\{width}(\|l)=0)\W(\\{height}(\|l)=0)\W(\\{depth}(\|l)=0)\W(\\{list\_ptr}(%
\|l)=\\{null})$ \1\&{then}\5
$\|l\K\\{link}(\|l)$\C{for paragraph start with \.{\\parindent = 0pt}}\6
\4\&{else} \&{if} $\|d$ \1\&{then}\6
\&{while} $(\\{link}(\|l)\I\\{null})\W(\R(\\{is\_char\_node}(\|l)\V\\{non%
\_discardable}(\|l)))$ \1\&{do}\5
$\|l\K\\{link}(\|l)$;\C{std.\ discardables at line break, \TeX book, p 95}\2\2%
\2\6
$\\{hlist\_stack\_level}\K0$;\5
$\\{run}\K\\{true}$;\6
\1\&{repeat} \37$\|t\K\|l$;\6
\&{while} $\\{run}\W(\\{type}(\|l)=\\{hlist\_node})\W(\\{list\_ptr}(\|l)\I%
\\{null})$ \1\&{do}\6
\&{begin} \37$\\{push\_node}(\|l)$;\5
$\|l\K\\{list\_ptr}(\|l)$;\6
\&{end};\2\6
\&{while} $\\{run}\W\\{cp\_skipable}(\|l)$ \1\&{do}\6
\&{begin} \37\&{while} $(\\{link}(\|l)=\\{null})\W(\\{hlist\_stack\_level}>0)$ %
\1\&{do}\6
\&{begin} \37$\|l\K\\{pop\_node}$;\C{don't visit this node again}\6
\&{end};\2\6
\&{if} $\\{link}(\|l)\I\\{null}$ \1\&{then}\5
$\|l\K\\{link}(\|l)$\6
\4\&{else} \&{if} $\\{hlist\_stack\_level}=0$ \1\&{then}\5
$\\{run}\K\\{false}$\2\2\6
\&{end};\2\6
\4\&{until}\5
$\|t=\|l$;\2\6
$\\{find\_protchar\_left}\K\|l$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{find\_protchar\_right}(\|l,\39\|r:\\{pointer})$: \37%
\\{pointer};\C{searches right to left from list tail \|r to head \|l, returns
1st non-skipable item}\6
\4\&{var} \37\|t: \37\\{pointer};\5
\\{run}: \37\\{boolean};\2\6
\&{begin} \37$\\{find\_protchar\_right}\K\\{null}$;\6
\&{if} $\|r=\\{null}$ \1\&{then}\5
\&{return};\2\6
$\\{hlist\_stack\_level}\K0$;\5
$\\{run}\K\\{true}$;\6
\1\&{repeat} \37$\|t\K\|r$;\6
\&{while} $\\{run}\W(\\{type}(\|r)=\\{hlist\_node})\W(\\{list\_ptr}(\|r)\I%
\\{null})$ \1\&{do}\6
\&{begin} \37$\\{push\_node}(\|l)$;\5
$\\{push\_node}(\|r)$;\5
$\|l\K\\{list\_ptr}(\|r)$;\5
$\|r\K\|l$;\6
\&{while} $\\{link}(\|r)\I\\{null}$ \1\&{do}\5
$\|r\K\\{link}(\|r)$;\2\6
\&{end};\2\6
\&{while} $\\{run}\W\\{cp\_skipable}(\|r)$ \1\&{do}\6
\&{begin} \37\&{while} $(\|r=\|l)\W(\\{hlist\_stack\_level}>0)$ \1\&{do}\6
\&{begin} \37$\|r\K\\{pop\_node}$;\C{don't visit this node again}\6
$\|l\K\\{pop\_node}$;\6
\&{end};\2\6
\&{if} $(\|r\I\|l)\W(\|r\I\\{null})$ \1\&{then}\5
$\|r\K\\{prev\_rightmost}(\|l,\39\|r)$\6
\4\&{else} \&{if} $(\|r=\|l)\W(\\{hlist\_stack\_level}=0)$ \1\&{then}\5
$\\{run}\K\\{false}$\2\2\6
\&{end};\2\6
\4\&{until}\5
$\|t=\|r$;\2\6
$\\{find\_protchar\_right}\K\|r$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{total\_pw}(\|q,\39\|p:\\{pointer})$: \37\\{scaled};%
\C{returns the total width of character protrusion of a line; $\\{cur\_break}(%
\\{break\_node}(\|q))$ and \|p is the leftmost resp. rightmost node in the
horizontal list representing the actual line}\6
\4\&{var} \37$\|l,\39\|r$: \37\\{pointer};\5
\|n: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{break\_node}(\|q)=\\{null}$ \1\&{then}\5
$\|l\K\\{first\_p}$\6
\4\&{else} $\|l\K\\{cur\_break}(\\{break\_node}(\|q))$;\2\6
$\|r\K\\{prev\_rightmost}(\\{prev\_p},\39\|p)$;\C{get $\\{link}(\|r)=\|p$}\6
\C{let's look at the right margin first}\6
$\B\\{short\_display\_n}(\|r,\392)$;\5
$\\{print}(\.{"\&"})$;\5
$\\{short\_display\_n}(\|p,\392)$;\5
\\{print\_ln};\5
$\T$\1\6
\&{if} $(\|p\I\\{null})\W(\\{type}(\|p)=\\{disc\_node})\W(\\{pre\_break}(\|p)\I%
\\{null})$ \1\&{then}\C{a \\{disc\_node} with non-empty \\{pre\_break},
protrude the last char of \\{pre\_break}}\6
\&{begin} \37$\|r\K\\{pre\_break}(\|p)$;\6
\&{while} $\\{link}(\|r)\I\\{null}$ \1\&{do}\5
$\|r\K\\{link}(\|r)$;\2\6
\&{end}\6
\4\&{else} $\|r\K\\{find\_protchar\_right}(\|l,\39\|r)$;\C{now the left margin}%
\2\2\6
$\B\\{short\_display\_n}(\|l,\392)$;\5
\\{print\_ln};\5
$\\{breadth\_max}\K10$;\5
$\\{depth\_threshold}\K2$;\5
$\\{show\_node\_list}(\|l)$;\5
\\{print\_ln};\5
$\T$\1\6
\&{if} $(\|l\I\\{null})\W(\\{type}(\|l)=\\{disc\_node})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{post\_break}(\|l)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|l\K\\{post\_break}(\|l)$;\C{protrude the first char}\6
\&{goto} \37\\{done};\6
\&{end}\6
\4\&{else} \C{discard $\\{replace\_count}(\|l)$ nodes}\2\6
\&{begin} \37$\|n\K\\{replace\_count}(\|l)$;\5
$\|l\K\\{link}(\|l)$;\6
\&{while} $\|n>0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{link}(\|l)\I\\{null}$ \1\&{then}\5
$\|l\K\\{link}(\|l)$;\2\6
$\\{decr}(\|n)$;\6
\&{end};\2\6
\&{end};\6
\&{end};\2\2\6
$\|l\K\\{find\_protchar\_left}(\|l,\39\\{true})$;\6
\4\\{done}: \37$\\{total\_pw}\K\\{left\_pw}(\|l)+\\{right\_pw}(\|r)$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{try\_break}(\\{pi}:\\{integer};\,\35\\{break\_type}:%
\\{small\_number})$;\6
\4\&{label} \37$\\{exit},\39\\{done},\39\\{done1},\39\\{continue},\39%
\\{deactivate},\39\\{found},\39\\{not\_found}$;\6
\4\&{var} \37\|r: \37\\{pointer};\C{runs through the active list}\6
\\{margin\_kern\_stretch}: \37\\{scaled};\5
\\{margin\_kern\_shrink}: \37\\{scaled};\5
$\\{lp},\39\\{rp},\39\\{cp}$: \37\\{pointer};\5
\\{prev\_r}: \37\\{pointer};\C{stays a step behind \|r}\6
\\{old\_l}: \37\\{halfword};\C{maximum line number in current equivalence class
of lines}\6
\\{no\_break\_yet}: \37\\{boolean};\C{have we found a feasible break at \\{cur%
\_p}?}\6
\X1006:Other local variables for \\{try\_break}\X\2\6
\&{begin} \37\X1007:Make sure that \\{pi} is in the proper range\X;\6
$\\{no\_break\_yet}\K\\{true}$;\5
$\\{prev\_r}\K\\{active}$;\5
$\\{old\_l}\K0$;\5
$\\{do\_all\_eight}(\\{copy\_to\_cur\_active})$;\6
\~ \1\&{loop}\ \&{begin} \37\\{continue}: \37$\|r\K\\{link}(\\{prev\_r})$;\5
\X1008:If node \|r is of type \\{delta\_node}, update \\{cur\_active\_width},
set \\{prev\_r} and \\{prev\_prev\_r}, then \&{goto} \\{continue}\X;\6
\X1011:If a line number class has ended, create new active nodes for the best
feasible breaks in that class; then \&{return} if $\|r=\\{last\_active}$,
otherwise compute the new \\{line\_width}\X;\6
\X1027:Consider the demerits for a line from \|r to \\{cur\_p}; deactivate node
\|r if it should no longer be active; then \&{goto} \\{continue} if a line from
\|r to \\{cur\_p} is infeasible, otherwise record a new feasible break\X;\6
\&{end};\2\6
\4\\{exit}: \37\&{stat} \37\X1034:Update the value of \\{printed\_node} for
symbolic displays\X\ \&{tats}\6
\&{end};\par
\fi

\M1006. \P$\X1006:Other local variables for \\{try\_break}\X\S$\6
\4\\{prev\_prev\_r}: \37\\{pointer};\C{a step behind \\{prev\_r}, if $\\{type}(%
\\{prev\_r})=\\{delta\_node}$}\6
\4\|s: \37\\{pointer};\C{runs through nodes ahead of \\{cur\_p}}\6
\4\|q: \37\\{pointer};\C{points to a new node being created}\6
\4\|v: \37\\{pointer};\C{points to a glue specification or a node ahead of %
\\{cur\_p}}\6
\4\|t: \37\\{integer};\C{node count, if \\{cur\_p} is a discretionary node}\6
\4\|f: \37\\{internal\_font\_number};\C{used in character width calculation}\6
\4\|l: \37\\{halfword};\C{line number of current active node}\6
\4\\{node\_r\_stays\_active}: \37\\{boolean};\C{should node \|r remain in the
active list?}\6
\4\\{line\_width}: \37\\{scaled};\C{the current line will be justified to this
width}\6
\4\\{fit\_class}: \37$\\{very\_loose\_fit}\to\\{tight\_fit}$;\C{possible
fitness class of test line}\6
\4\|b: \37\\{halfword};\C{badness of test line}\6
\4\|d: \37\\{integer};\C{demerits of test line}\6
\4\\{artificial\_demerits}: \37\\{boolean};\C{has \|d been forced to zero?}\6
\4\\{save\_link}: \37\\{pointer};\C{temporarily holds value of $\\{link}(\\{cur%
\_p})$}\6
\4\\{shortfall}: \37\\{scaled};\C{used in badness calculations}\par
\A1844.
\U1005.\fi

\M1007. \P$\X1007:Make sure that \\{pi} is in the proper range\X\S$\6
\&{if} $\\{abs}(\\{pi})\G\\{inf\_penalty}$ \1\&{then}\6
\&{if} $\\{pi}>0$ \1\&{then}\5
\&{return}\C{this breakpoint is inhibited by infinite penalty}\6
\4\&{else} $\\{pi}\K\\{eject\_penalty}$\C{this breakpoint will be forced}\2\2%
\par
\U1005.\fi

\M1008. The following code uses the fact that $\\{type}(\\{last\_active})\I%
\\{delta\_node}$.

\Y\P\D \37$\\{update\_width}(\#)\S\30\\{cur\_active\_width}[\#]\K\\{cur\_active%
\_width}[\#]+\\{mem}[\|r+\#].\\{sc}$\par
\Y\P$\4\X1008:If node \|r is of type \\{delta\_node}, update \\{cur\_active%
\_width}, set \\{prev\_r} and \\{prev\_prev\_r}, then \&{goto} \\{continue}\X%
\S$\6
\&{if} $\\{type}(\|r)=\\{delta\_node}$ \1\&{then}\6
\&{begin} \37$\\{do\_all\_eight}(\\{update\_width})$;\5
$\\{prev\_prev\_r}\K\\{prev\_r}$;\5
$\\{prev\_r}\K\|r$;\5
\&{goto} \37\\{continue};\6
\&{end}\2\par
\U1005.\fi

\M1009. As we consider various ways to end a line at \\{cur\_p}, in a given
line number
class, we keep track of the best total demerits known, in an array with
one entry for each of the fitness classifications. For example,
$\\{minimal\_demerits}[\\{tight\_fit}]$ contains the fewest total demerits of
feasible
line breaks ending at \\{cur\_p} with a \\{tight\_fit} line; $\\{best\_place}[%
\\{tight\_fit}]$
points to the passive node for the break before~\\{cur\_p} that achieves such
an optimum; and $\\{best\_pl\_line}[\\{tight\_fit}]$ is the \\{line\_number}
field in the
active node corresponding to $\\{best\_place}[\\{tight\_fit}]$. When no
feasible break
sequence is known, the \\{minimal\_demerits} entries will be equal to
\\{awful\_bad}, which is $2^{30}-1$. Another variable, \\{minimum\_demerits},
keeps track of the smallest value in the \\{minimal\_demerits} array.

\Y\P\D \37$\\{awful\_bad}\S\O{7777777777}$\C{more than a billion demerits}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{minimal\_demerits}: \37\&{array} $[\\{very\_loose\_fit}\to\\{tight\_fit}]$
\1\&{of}\5
\\{integer};\C{best total   demerits known for current line class and position,
given the fitness}\2\6
\4\\{minimum\_demerits}: \37\\{integer};\C{best total demerits known for
current line class   and position}\6
\4\\{best\_place}: \37\&{array} $[\\{very\_loose\_fit}\to\\{tight\_fit}]$ \1%
\&{of}\5
\\{pointer};\C{how to achieve   \\{minimal\_demerits}}\2\6
\4\\{best\_pl\_line}: \37\&{array} $[\\{very\_loose\_fit}\to\\{tight\_fit}]$ \1%
\&{of}\5
\\{halfword};\C{corresponding   line number}\2\par
\fi

\M1010. \P$\X992:Get ready to start line breaking\X\mathrel{+}\S$\6
$\\{minimum\_demerits}\K\\{awful\_bad}$;\5
$\\{minimal\_demerits}[\\{tight\_fit}]\K\\{awful\_bad}$;\5
$\\{minimal\_demerits}[\\{decent\_fit}]\K\\{awful\_bad}$;\5
$\\{minimal\_demerits}[\\{loose\_fit}]\K\\{awful\_bad}$;\5
$\\{minimal\_demerits}[\\{very\_loose\_fit}]\K\\{awful\_bad}$;\par
\fi

\M1011. The first part of the following code is part of \TeX's inner loop, so
we don't want to waste any time. The current active node, namely node \|r,
contains the line number that will be considered next. At the end of the
list we have arranged the data structure so that $\|r=\\{last\_active}$ and
$\\{line\_number}(\\{last\_active})>\\{old\_l}$.

\Y\P$\4\X1011:If a line number class has ended, create new active nodes for the
best feasible breaks in that class; then \&{return} if $\|r=\\{last\_active}$,
otherwise compute the new \\{line\_width}\X\S$\6
\&{begin} \37$\|l\K\\{line\_number}(\|r)$;\6
\&{if} $\|l>\\{old\_l}$ \1\&{then}\6
\&{begin} \37\C{now we are no longer in the inner loop}\6
\&{if} $(\\{minimum\_demerits}<\\{awful\_bad})\W\30((\\{old\_l}\I\\{easy%
\_line})\V(\|r=\\{last\_active}))$ \1\&{then}\5
\X1012:Create new active nodes for the best feasible breaks just found\X;\2\6
\&{if} $\|r=\\{last\_active}$ \1\&{then}\5
\&{return};\2\6
\X1026:Compute the new line width\X;\6
\&{end};\2\6
\&{end}\par
\U1005.\fi

\M1012. It is not necessary to create new active nodes having \\{minimal%
\_demerits}
greater than
$\\{minimum\_demerits}+\\{abs}(\\{adj\_demerits})$, since such active nodes
will never
be chosen in the final paragraph breaks. This observation allows us to
omit a substantial number of feasible breakpoints from further consideration.

\Y\P$\4\X1012:Create new active nodes for the best feasible breaks just found\X%
\S$\6
\&{begin} \37\&{if} $\\{no\_break\_yet}$ \1\&{then}\5
\X1013:Compute the values of \\{break\_width}\X;\2\6
\X1019:Insert a delta node to prepare for breaks at \\{cur\_p}\X;\6
\&{if} $\\{abs}(\\{adj\_demerits})\G\\{awful\_bad}-\\{minimum\_demerits}$ \1%
\&{then}\5
$\\{minimum\_demerits}\K\\{awful\_bad}-1$\6
\4\&{else} $\\{minimum\_demerits}\K\\{minimum\_demerits}+\\{abs}(\\{adj%
\_demerits})$;\2\6
\&{for} $\\{fit\_class}\K\\{very\_loose\_fit}\mathrel{\&{to}}\\{tight\_fit}$ \1%
\&{do}\6
\&{begin} \37\&{if} $\\{minimal\_demerits}[\\{fit\_class}]\L\\{minimum%
\_demerits}$ \1\&{then}\5
\X1021:Insert a new active node from $\\{best\_place}[\\{fit\_class}]$ to %
\\{cur\_p}\X;\2\6
$\\{minimal\_demerits}[\\{fit\_class}]\K\\{awful\_bad}$;\6
\&{end};\2\6
$\\{minimum\_demerits}\K\\{awful\_bad}$;\5
\X1020:Insert a delta node to prepare for the next active node\X;\6
\&{end}\par
\U1011.\fi

\M1013. When we insert a new active node for a break at \\{cur\_p}, suppose
this
new node is to be placed just before active node \|a; then we essentially
want to insert `$\delta\,\\{cur\_p}\,\delta^\prime$' before \|a, where
$\delta=\alpha(a)-\alpha(\\{cur\_p})$ and $\delta^\prime=\alpha(\\{cur\_p})-%
\alpha(a)$
in the notation explained above.  The \\{cur\_active\_width} array now holds
$\gamma+\beta(\\{cur\_p})-\alpha(a)$; so $\delta$ can be obtained by
subtracting \\{cur\_active\_width} from the quantity $\gamma+\beta(\\{cur\_p})-
\alpha(\\{cur\_p})$. The latter quantity can be regarded as the length of a
line ``from \\{cur\_p} to \\{cur\_p}''; we call it the \\{break\_width} at %
\\{cur\_p}.

The \\{break\_width} is usually negative, since it consists of the background
(which is normally zero) minus the width of nodes following~\\{cur\_p} that are
eliminated after a break. If, for example, node \\{cur\_p} is a glue node, the
width of this glue is subtracted from the background; and we also look
ahead to eliminate all subsequent glue and penalty and kern and math
nodes, subtracting their widths as well.

Kern nodes do not disappear at a line break unless they are \\{explicit}.

\Y\P\D \37$\\{set\_break\_width\_to\_background}(\#)\S\\{break\_width}[\#]\K%
\\{background}[\#]$\par
\Y\P$\4\X1013:Compute the values of \\{break\_width}\X\S$\6
\&{begin} \37$\\{no\_break\_yet}\K\\{false}$;\5
$\\{do\_all\_eight}(\\{set\_break\_width\_to\_background})$;\5
$\|s\K\\{cur\_p}$;\6
\&{if} $\\{break\_type}>\\{unhyphenated}$ \1\&{then}\6
\&{if} $\\{cur\_p}\I\\{null}$ \1\&{then}\5
\X1016:Compute the discretionary \\{break\_width} values\X;\2\2\6
\&{while} $\|s\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{case} $\\{type}(\|s)$ \1\&{of}\6
\4\\{glue\_node}: \37\X1014:Subtract glue from \\{break\_width}\X;\6
\4\\{penalty\_node}: \37\\{do\_nothing};\6
\4\\{math\_node}: \37$\\{break\_width}[1]\K\\{break\_width}[1]-\\{width}(\|s)$;%
\6
\4\\{kern\_node}: \37\&{if} $\\{subtype}(\|s)\I\\{explicit}$ \1\&{then}\5
\&{goto} \37\\{done}\6
\4\&{else} $\\{break\_width}[1]\K\\{break\_width}[1]-\\{width}(\|s)$;\2\6
\4\&{othercases} \37\&{goto} \37\\{done}\2\6
\&{endcases};\6
$\|s\K\\{link}(\|s)$;\6
\&{end};\2\6
\4\\{done}: \37\&{end}\par
\U1012.\fi

\M1014. \P$\X1014:Subtract glue from \\{break\_width}\X\S$\6
\&{begin} \37$\|v\K\\{glue\_ptr}(\|s)$;\5
$\\{break\_width}[1]\K\\{break\_width}[1]-\\{width}(\|v)$;\5
$\\{break\_width}[2+\\{stretch\_order}(\|v)]\K\\{break\_width}[2+\\{stretch%
\_order}(\|v)]-\\{stretch}(\|v)$;\5
$\\{break\_width}[6]\K\\{break\_width}[6]-\\{shrink}(\|v)$;\6
\&{end}\par
\U1013.\fi

\M1015. When \\{cur\_p} is a discretionary break, the length of a line ``from %
\\{cur\_p} to
\\{cur\_p}'' has to be defined properly so that the other calculations work
out.
Suppose that the pre-break text at \\{cur\_p} has length $l_0$, the post-break
text has length $l_1$, and the replacement text has length \|l. Suppose
also that \|q is the node following the replacement text. Then length of a
line from \\{cur\_p} to \|q will be computed as $\gamma+\beta(q)-\alpha(\\{cur%
\_p})$,
where $\beta(q)=\beta(\\{cur\_p})-l_0+l$. The actual length will be the
background
plus $l_1$, so the length from \\{cur\_p} to \\{cur\_p} should be $%
\gamma+l_0+l_1-l$.
If the post-break text of the discretionary is empty, a break may also
discard~\|q; in that unusual case we subtract the length of~\|q and any
other nodes that will be discarded after the discretionary break.

The value of $l_0$ need not be computed, since \\{line\_break} will put
it into the global variable \\{disc\_width} before calling \\{try\_break}.

\Y\P\D \37$\\{reset\_disc\_width}(\#)\S\\{disc\_width}[\#]\K0$\par
\P\D \37$\\{add\_disc\_width\_to\_break\_width}(\#)\S\\{break\_width}[\#]\K%
\\{break\_width}[\#]+\\{disc\_width}[\#]$\par
\P\D \37$\\{add\_disc\_width\_to\_active\_width}(\#)\S\\{active\_width}[\#]\K%
\\{active\_width}[\#]+\\{disc\_width}[\#]$\par
\P\D \37$\\{sub\_disc\_width\_from\_active\_width}(\#)\S\\{active\_width}[\#]\K%
\\{active\_width}[\#]-\\{disc\_width}[\#]$\par
\P\D \37$\\{add\_char\_stretch\_end}(\#)\S\\{char\_stretch}(\|f,\39\#)$\par
\P\D \37$\\{add\_char\_stretch}(\#)\S\#\K\#+\\{add\_char\_stretch\_end}$\par
\P\D \37$\\{add\_char\_shrink\_end}(\#)\S\\{char\_shrink}(\|f,\39\#)$\par
\P\D \37$\\{add\_char\_shrink}(\#)\S\#\K\#+\\{add\_char\_shrink\_end}$\par
\P\D \37$\\{sub\_char\_stretch\_end}(\#)\S\\{char\_stretch}(\|f,\39\#)$\par
\P\D \37$\\{sub\_char\_stretch}(\#)\S\#\K\#-\\{sub\_char\_stretch\_end}$\par
\P\D \37$\\{sub\_char\_shrink\_end}(\#)\S\\{char\_shrink}(\|f,\39\#)$\par
\P\D \37$\\{sub\_char\_shrink}(\#)\S\#\K\#-\\{sub\_char\_shrink\_end}$\par
\P\D \37$\\{add\_kern\_stretch\_end}(\#)\S\\{kern\_stretch}(\#)$\par
\P\D \37$\\{add\_kern\_stretch}(\#)\S\#\K\#+\\{add\_kern\_stretch\_end}$\par
\P\D \37$\\{add\_kern\_shrink\_end}(\#)\S\\{kern\_shrink}(\#)$\par
\P\D \37$\\{add\_kern\_shrink}(\#)\S\#\K\#+\\{add\_kern\_shrink\_end}$\par
\P\D \37$\\{sub\_kern\_stretch\_end}(\#)\S\\{kern\_stretch}(\#)$\par
\P\D \37$\\{sub\_kern\_stretch}(\#)\S\#\K\#-\\{sub\_kern\_stretch\_end}$\par
\P\D \37$\\{sub\_kern\_shrink\_end}(\#)\S\\{kern\_shrink}(\#)$\par
\P\D \37$\\{sub\_kern\_shrink}(\#)\S\#\K\#-\\{sub\_kern\_shrink\_end}$\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{disc\_width}: \37\&{array} $[1\to8]$ \1\&{of}\5
\\{scaled};\C{the length of discretionary material preceding a break}\2\par
\fi

\M1016. \P$\X1016:Compute the discretionary \\{break\_width} values\X\S$\6
\&{begin} \37$\|t\K\\{replace\_count}(\\{cur\_p})$;\5
$\|v\K\\{cur\_p}$;\5
$\|s\K\\{post\_break}(\\{cur\_p})$;\6
\&{while} $\|t>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|t)$;\5
$\|v\K\\{link}(\|v)$;\5
\X1017:Subtract the width of node \|v from \\{break\_width}\X;\6
\&{end};\2\6
\&{while} $\|s\I\\{null}$ \1\&{do}\6
\&{begin} \37\X1018:Add the width of node \|s to \\{break\_width}\X;\6
$\|s\K\\{link}(\|s)$;\6
\&{end};\2\6
$\\{do\_one\_seven\_eight}(\\{add\_disc\_width\_to\_break\_width})$;\6
\&{if} $\\{post\_break}(\\{cur\_p})=\\{null}$ \1\&{then}\5
$\|s\K\\{link}(\|v)$;\C{nodes may be discardable after the break}\2\6
\&{end}\par
\U1013.\fi

\M1017. Replacement texts and discretionary texts are supposed to contain
only character nodes, kern nodes, ligature nodes, and box or rule nodes.

\Y\P$\4\X1017:Subtract the width of node \|v from \\{break\_width}\X\S$\6
\&{if} $\\{is\_char\_node}(\|v)$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|v)$;\5
$\\{break\_width}[1]\K\\{break\_width}[1]-\\{char\_width}(\|f)(\\{char\_info}(%
\|f)(\\{character}(\|v)))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|v$;\5
$\\{sub\_char\_stretch}(\\{break\_width}[7])(\\{character}(\|v))$;\5
$\\{sub\_char\_shrink}(\\{break\_width}[8])(\\{character}(\|v))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{case} $\\{type}(\|v)$ \1\&{of}\6
\4\\{ligature\_node}: \37\&{begin} \37$\|f\K\\{font}(\\{lig\_char}(\|v))$;\6
$\\{break\_width}[1]\K\30\\{break\_width}[1]-\\{char\_width}(\|f)(\\{char%
\_info}(\|f)(\\{character}(\\{lig\_char}(\|v))))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|v$;\5
$\\{sub\_char\_stretch}(\\{break\_width}[7])(\\{character}(\\{lig\_char}(%
\|v)))$;\5
$\\{sub\_char\_shrink}(\\{break\_width}[8])(\\{character}(\\{lig\_char}(%
\|v)))$;\6
\&{end};\2\6
\&{end};\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{kern\_node}$: \37%
\&{begin} \37$\\{break\_width}[1]\K\\{break\_width}[1]-\\{width}(\|v)$;\6
\&{if} $(\\{type}(\|v)=\\{kern\_node})\W(\\{pdf\_adjust\_spacing}>1)\W(%
\\{subtype}(\|v)=\\{normal})$ \1\&{then}\6
\&{begin} \37$\\{sub\_kern\_stretch}(\\{break\_width}[7])(\|v)$;\5
$\\{sub\_kern\_shrink}(\\{break\_width}[8])(\|v)$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"disc1"})$\2\6
\&{endcases}\2\par
\U1016.\fi

\M1018. \P$\X1018:Add the width of node \|s to \\{break\_width}\X\S$\6
\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|s)$;\5
$\\{break\_width}[1]\K\30\\{break\_width}[1]+\\{char\_width}(\|f)(\\{char%
\_info}(\|f)(\\{character}(\|s)))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{break\_width}[7])(\\{character}(\|s))$;\5
$\\{add\_char\_shrink}(\\{break\_width}[8])(\\{character}(\|s))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{case} $\\{type}(\|s)$ \1\&{of}\6
\4\\{ligature\_node}: \37\&{begin} \37$\|f\K\\{font}(\\{lig\_char}(\|s))$;\5
$\\{break\_width}[1]\K\\{break\_width}[1]+\\{char\_width}(\|f)(\\{char\_info}(%
\|f)(\\{character}(\\{lig\_char}(\|s))))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{break\_width}[7])(\\{character}(\\{lig\_char}(%
\|s)))$;\5
$\\{add\_char\_shrink}(\\{break\_width}[8])(\\{character}(\\{lig\_char}(%
\|s)))$;\6
\&{end};\2\6
\&{end};\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{kern\_node}$: \37%
\&{begin} \37$\\{break\_width}[1]\K\\{break\_width}[1]+\\{width}(\|s)$;\6
\&{if} $(\\{type}(\|s)=\\{kern\_node})\W(\\{pdf\_adjust\_spacing}>1)\W(%
\\{subtype}(\|s)=\\{normal})$ \1\&{then}\6
\&{begin} \37$\\{add\_kern\_stretch}(\\{break\_width}[7])(\|s)$;\5
$\\{add\_kern\_shrink}(\\{break\_width}[8])(\|s)$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"disc2"})$\2\6
\&{endcases}\2\par
\U1016.\fi

\M1019. We use the fact that $\\{type}(\\{active})\I\\{delta\_node}$.

\Y\P\D \37$\\{convert\_to\_break\_width}(\#)\S\30\\{mem}[\\{prev\_r}+\#].\\{sc}%
\K\30\hbox{\hskip10pt}\\{mem}[\\{prev\_r}+\#].\\{sc}-\\{cur\_active\_width}[%
\#]+\\{break\_width}[\#]$\par
\P\D \37$\\{store\_break\_width}(\#)\S\\{active\_width}[\#]\K\\{break\_width}[%
\#]$\par
\P\D \37$\\{new\_delta\_to\_break\_width}(\#)\S\30\\{mem}[\|q+\#].\\{sc}\K%
\\{break\_width}[\#]-\\{cur\_active\_width}[\#]$\par
\Y\P$\4\X1019:Insert a delta node to prepare for breaks at \\{cur\_p}\X\S$\6
\&{if} $\\{type}(\\{prev\_r})=\\{delta\_node}$ \1\&{then}\C{modify an existing
delta node}\6
\&{begin} \37$\\{do\_all\_eight}(\\{convert\_to\_break\_width})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{prev\_r}=\\{active}$ \1\&{then}\C{no delta node needed at
the beginning}\6
\&{begin} \37$\\{do\_all\_eight}(\\{store\_break\_width})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{get\_node}(\\{delta\_node\_size})$;\5
$\\{link}(\|q)\K\|r$;\5
$\\{type}(\|q)\K\\{delta\_node}$;\6
$\\{subtype}(\|q)\K0$;\C{the \\{subtype} is not used}\6
$\\{do\_all\_eight}(\\{new\_delta\_to\_break\_width})$;\5
$\\{link}(\\{prev\_r})\K\|q$;\5
$\\{prev\_prev\_r}\K\\{prev\_r}$;\5
$\\{prev\_r}\K\|q$;\6
\&{end}\2\2\par
\U1012.\fi

\M1020. When the following code is performed, we will have just inserted at
least one active node before \|r, so $\\{type}(\\{prev\_r})\I\\{delta\_node}$.

\Y\P\D \37$\\{new\_delta\_from\_break\_width}(\#)\S\30\\{mem}[\|q+\#].\\{sc}\K%
\\{cur\_active\_width}[\#]-\\{break\_width}[\#]$\par
\Y\P$\4\X1020:Insert a delta node to prepare for the next active node\X\S$\6
\&{if} $\|r\I\\{last\_active}$ \1\&{then}\6
\&{begin} \37$\|q\K\\{get\_node}(\\{delta\_node\_size})$;\5
$\\{link}(\|q)\K\|r$;\5
$\\{type}(\|q)\K\\{delta\_node}$;\6
$\\{subtype}(\|q)\K0$;\C{the \\{subtype} is not used}\6
$\\{do\_all\_eight}(\\{new\_delta\_from\_break\_width})$;\5
$\\{link}(\\{prev\_r})\K\|q$;\5
$\\{prev\_prev\_r}\K\\{prev\_r}$;\5
$\\{prev\_r}\K\|q$;\6
\&{end}\2\par
\U1012.\fi

\M1021. When we create an active node, we also create the corresponding
passive node.

\Y\P$\4\X1021:Insert a new active node from $\\{best\_place}[\\{fit\_class}]$
to \\{cur\_p}\X\S$\6
\&{begin} \37$\|q\K\\{get\_node}(\\{passive\_node\_size})$;\5
$\\{link}(\|q)\K\\{passive}$;\5
$\\{passive}\K\|q$;\5
$\\{cur\_break}(\|q)\K\\{cur\_p}$;\6
\&{stat} \37$\\{incr}(\\{pass\_number})$;\5
$\\{serial}(\|q)\K\\{pass\_number}$;\ \&{tats}\6
$\\{prev\_break}(\|q)\K\\{best\_place}[\\{fit\_class}]$;\6
$\|q\K\\{get\_node}(\\{active\_node\_size})$;\5
$\\{break\_node}(\|q)\K\\{passive}$;\5
$\\{line\_number}(\|q)\K\\{best\_pl\_line}[\\{fit\_class}]+1$;\5
$\\{fitness}(\|q)\K\\{fit\_class}$;\5
$\\{type}(\|q)\K\\{break\_type}$;\5
$\\{total\_demerits}(\|q)\K\\{minimal\_demerits}[\\{fit\_class}]$;\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1851:Store \(a)additional data in the new active node\X;\2\6
$\\{link}(\|q)\K\|r$;\5
$\\{link}(\\{prev\_r})\K\|q$;\5
$\\{prev\_r}\K\|q$;\6
\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
\X1022:Print a symbolic description of the new break node\X;\2\6
\&{tats}\6
\&{end}\par
\U1012.\fi

\M1022. \P$\X1022:Print a symbolic description of the new break node\X\S$\6
\&{begin} \37$\\{print\_nl}(\.{"@@"})$;\5
$\\{print\_int}(\\{serial}(\\{passive}))$;\5
$\\{print}(\.{":\ line\ "})$;\5
$\\{print\_int}(\\{line\_number}(\|q)-1)$;\5
$\\{print\_char}(\.{"."})$;\5
$\\{print\_int}(\\{fit\_class})$;\6
\&{if} $\\{break\_type}=\\{hyphenated}$ \1\&{then}\5
$\\{print\_char}(\.{"-"})$;\2\6
$\\{print}(\.{"\ t="})$;\5
$\\{print\_int}(\\{total\_demerits}(\|q))$;\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1852:Print additional data in the new active node\X;\2\6
$\\{print}(\.{"\ ->\ @@"})$;\6
\&{if} $\\{prev\_break}(\\{passive})=\\{null}$ \1\&{then}\5
$\\{print\_char}(\.{"0"})$\6
\4\&{else} $\\{print\_int}(\\{serial}(\\{prev\_break}(\\{passive})))$;\2\6
\&{end}\par
\U1021.\fi

\M1023. The length of lines depends on whether the user has specified
\.{\\parshape} or \.{\\hangindent}. If \\{par\_shape\_ptr} is not null, it
points to a $(2n+1)$-word record in \\{mem}, where the \\{info} in the first
word contains the value of \|n, and the other $2n$ words contain the left
margins and line lengths for the first \|n lines of the paragraph; the
specifications for line \|n apply to all subsequent lines. If
$\\{par\_shape\_ptr}=\\{null}$, the shape of the paragraph depends on the value
of
$\|n=\\{hang\_after}$; if $\|n\G0$, hanging indentation takes place on lines $%
\|n+1$,
$\|n+2$, \dots, otherwise it takes place on lines 1, \dots, $\vert
n\vert$. When hanging indentation is active, the left margin is
\\{hang\_indent}, if $\\{hang\_indent}\G0$, else it is 0; the line length is
$\\{hsize}-\vert\\{hang\_indent}\vert$. The normal setting is
$\\{par\_shape\_ptr}=\\{null}$, $\\{hang\_after}=1$, and $\\{hang\_indent}=0$.
Note that if $\\{hang\_indent}=0$, the value of \\{hang\_after} is irrelevant.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{easy\_line}: \37\\{halfword};\C{line numbers $>\\{easy\_line}$ are
equivalent in break nodes}\6
\4\\{last\_special\_line}: \37\\{halfword};\C{line numbers $>\\{last\_special%
\_line}$ all have   the same width}\6
\4\\{first\_width}: \37\\{scaled};\C{the width of all lines $\L\\{last\_special%
\_line}$, if   no \.{\\parshape} has been specified}\6
\4\\{second\_width}: \37\\{scaled};\C{the width of all lines $>\\{last\_special%
\_line}$}\6
\4\\{first\_indent}: \37\\{scaled};\C{left margin to go with \\{first\_width}}\6
\4\\{second\_indent}: \37\\{scaled};\C{left margin to go with \\{second%
\_width}}\par
\fi

\M1024. We compute the values of \\{easy\_line} and the other local variables
relating
to line length when the \\{line\_break} procedure is initializing itself.

\Y\P$\4\X992:Get ready to start line breaking\X\mathrel{+}\S$\6
\&{if} $\\{par\_shape\_ptr}=\\{null}$ \1\&{then}\6
\&{if} $\\{hang\_indent}=0$ \1\&{then}\6
\&{begin} \37$\\{last\_special\_line}\K0$;\5
$\\{second\_width}\K\\{hsize}$;\5
$\\{second\_indent}\K0$;\6
\&{end}\6
\4\&{else} \X1025:Set line length parameters in preparation for hanging
indentation\X\2\6
\4\&{else} \&{begin} \37$\\{last\_special\_line}\K\\{info}(\\{par\_shape%
\_ptr})-1$;\5
$\\{second\_width}\K\\{mem}[\\{par\_shape\_ptr}+2\ast(\\{last\_special%
\_line}+1)].\\{sc}$;\5
$\\{second\_indent}\K\\{mem}[\\{par\_shape\_ptr}+2\ast\\{last\_special%
\_line}+1].\\{sc}$;\6
\&{end};\2\6
\&{if} $\\{looseness}=0$ \1\&{then}\5
$\\{easy\_line}\K\\{last\_special\_line}$\6
\4\&{else} $\\{easy\_line}\K\\{max\_halfword}$\2\par
\fi

\M1025. \P$\X1025:Set line length parameters in preparation for hanging
indentation\X\S$\6
\&{begin} \37$\\{last\_special\_line}\K\\{abs}(\\{hang\_after})$;\6
\&{if} $\\{hang\_after}<0$ \1\&{then}\6
\&{begin} \37$\\{first\_width}\K\\{hsize}-\\{abs}(\\{hang\_indent})$;\6
\&{if} $\\{hang\_indent}\G0$ \1\&{then}\5
$\\{first\_indent}\K\\{hang\_indent}$\6
\4\&{else} $\\{first\_indent}\K0$;\2\6
$\\{second\_width}\K\\{hsize}$;\5
$\\{second\_indent}\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{first\_width}\K\\{hsize}$;\5
$\\{first\_indent}\K0$;\5
$\\{second\_width}\K\\{hsize}-\\{abs}(\\{hang\_indent})$;\6
\&{if} $\\{hang\_indent}\G0$ \1\&{then}\5
$\\{second\_indent}\K\\{hang\_indent}$\6
\4\&{else} $\\{second\_indent}\K0$;\2\6
\&{end};\2\6
\&{end}\par
\U1024.\fi

\M1026. When we come to the following code, we have just encountered the first
active node~\|r whose \\{line\_number} field contains \|l. Thus we want to
compute the length of the $l\mskip1mu$th line of the current paragraph.
Furthermore,
we want to set \\{old\_l} to the last number in the class of line numbers
equivalent to~\|l.

\Y\P$\4\X1026:Compute the new line width\X\S$\6
\&{if} $\|l>\\{easy\_line}$ \1\&{then}\6
\&{begin} \37$\\{line\_width}\K\\{second\_width}$;\5
$\\{old\_l}\K\\{max\_halfword}-1$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{old\_l}\K\|l$;\6
\&{if} $\|l>\\{last\_special\_line}$ \1\&{then}\5
$\\{line\_width}\K\\{second\_width}$\6
\4\&{else} \&{if} $\\{par\_shape\_ptr}=\\{null}$ \1\&{then}\5
$\\{line\_width}\K\\{first\_width}$\6
\4\&{else} $\\{line\_width}\K\\{mem}[\\{par\_shape\_ptr}+2\ast\|l\,].\\{sc}$;\2%
\2\6
\&{end}\2\par
\U1011.\fi

\M1027. The remaining part of \\{try\_break} deals with the calculation of
demerits for a break from \|r to \\{cur\_p}.

The first thing to do is calculate the badness, \|b. This value will always
be between zero and $\\{inf\_bad}+1$; the latter value occurs only in the
case of lines from \|r to \\{cur\_p} that cannot shrink enough to fit the
necessary
width. In such cases, node \|r will be deactivated.
We also deactivate node~\|r when a break at~\\{cur\_p} is forced, since future
breaks must go through a forced break.

\Y\P$\4\X1027:Consider the demerits for a line from \|r to \\{cur\_p};
deactivate node \|r if it should no longer be active; then \&{goto} %
\\{continue} if a line from \|r to \\{cur\_p} is infeasible, otherwise record a
new feasible break\X\S$\6
\&{begin} \37$\\{artificial\_demerits}\K\\{false}$;\6
$\\{shortfall}\K\\{line\_width}-\\{cur\_active\_width}[1]$;\C{we're this much
too short}\6
$\B$\1\6
\&{if} $\\{pdf\_output}>2$ \1\&{then}\6
\&{begin} \37\\{print\_ln};\6
\&{if} $(\|r\I\\{null})\W(\\{break\_node}(\|r)\I\\{null})$ \1\&{then}\5
$\\{short\_display\_n}(\\{cur\_break}(\\{break\_node}(\|r)),\395)$;\2\6
\\{print\_ln};\5
$\\{short\_display\_n}(\\{cur\_p},\395)$;\5
\\{print\_ln};\6
\&{end};\2\2\6
$\T$\1\6
\&{if} $\\{pdf\_protrude\_chars}>1$ \1\&{then}\5
$\\{shortfall}\K\\{shortfall}+\\{total\_pw}(\|r,\39\\{cur\_p})$;\2\2\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W(\\{shortfall}\I0)$ \1\&{then}\6
\&{begin} \37$\\{margin\_kern\_stretch}\K0$;\5
$\\{margin\_kern\_shrink}\K0$;\6
\&{if} $\\{pdf\_protrude\_chars}>1$ \1\&{then}\5
\X822:Calculate variations of marginal kerns\X;\2\6
\&{if} $(\\{shortfall}>0)\W((\\{total\_font\_stretch}+\\{margin\_kern%
\_stretch})>0)$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{total\_font\_stretch}+\\{margin\_kern\_stretch})>%
\\{shortfall}$ \1\&{then}\5
$\\{shortfall}\K((\\{total\_font\_stretch}+\\{margin\_kern\_stretch})\mathbin{%
\&{div}}(\\{max\_stretch\_ratio}\mathbin{\&{div}}\\{cur\_font\_step}))\mathbin{%
\&{div}}2$\6
\4\&{else} $\\{shortfall}\K\\{shortfall}-(\\{total\_font\_stretch}+\\{margin%
\_kern\_stretch})$;\2\6
\&{end}\6
\4\&{else} \&{if} $(\\{shortfall}<0)\W((\\{total\_font\_shrink}+\\{margin\_kern%
\_shrink})>0)$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{total\_font\_shrink}+\\{margin\_kern\_shrink})>-%
\\{shortfall}$ \1\&{then}\5
$\\{shortfall}\K-((\\{total\_font\_shrink}+\\{margin\_kern\_shrink})\mathbin{%
\&{div}}(\\{max\_shrink\_ratio}\mathbin{\&{div}}\\{cur\_font\_step}))\mathbin{%
\&{div}}2$\6
\4\&{else} $\\{shortfall}\K\\{shortfall}+(\\{total\_font\_shrink}+\\{margin%
\_kern\_shrink})$;\2\6
\&{end};\2\2\6
\&{end};\2\6
\&{if} $\\{shortfall}>0$ \1\&{then}\5
\X1028:Set the value of \|b to the badness for stretching the line, and compute
the corresponding \\{fit\_class}\X\6
\4\&{else} \X1029:Set the value of \|b to the badness for shrinking the line,
and compute the corresponding \\{fit\_class}\X;\2\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1849:Adjust \(t)the additional data for last line\X;\2\6
\4\\{found}: \37\&{if} $(\|b>\\{inf\_bad})\V(\\{pi}=\\{eject\_penalty})$ \1%
\&{then}\5
\X1030:Prepare to deactivate node~\|r, and \&{goto} \\{deactivate} unless there
is a reason to consider lines of text from \|r to \\{cur\_p}\X\6
\4\&{else} \&{begin} \37$\\{prev\_r}\K\|r$;\6
\&{if} $\|b>\\{threshold}$ \1\&{then}\5
\&{goto} \37\\{continue};\2\6
$\\{node\_r\_stays\_active}\K\\{true}$;\6
\&{end};\2\6
\X1031:Record a new feasible break\X;\6
\&{if} $\\{node\_r\_stays\_active}$ \1\&{then}\5
\&{goto} \37\\{continue};\C{\\{prev\_r} has been set to \|r}\2\6
\4\\{deactivate}: \37\X1036:Deactivate node \|r\X;\6
\&{end}\par
\U1005.\fi

\M1028. When a line must stretch, the available stretchability can be found in
the
subarray $\\{cur\_active\_width}[2\to5]$, in units of points, fil, fill, and
filll.

The present section is part of \TeX's inner loop, and it is most often
performed
when the badness is infinite; therefore it is worth while to make a quick
test for large width excess and small stretchability, before calling the
\\{badness} subroutine.

\Y\P$\4\X1028:Set the value of \|b to the badness for stretching the line, and
compute the corresponding \\{fit\_class}\X\S$\6
\&{if} $(\\{cur\_active\_width}[3]\I0)\V(\\{cur\_active\_width}[4]\I0)\V\30(%
\\{cur\_active\_width}[5]\I0)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\C{the last line of a
paragraph}\6
\X1846:Perform computations for last line and \&{goto} \\{found}\X;\2\6
$\\{shortfall}\K0$;\6
\&{end};\2\6
$\|b\K0$;\5
$\\{fit\_class}\K\\{decent\_fit}$;\C{infinite stretch}\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{shortfall}>7230584$ \1\&{then}\6
\&{if} $\\{cur\_active\_width}[2]<1663497$ \1\&{then}\6
\&{begin} \37$\|b\K\\{inf\_bad}$;\5
$\\{fit\_class}\K\\{very\_loose\_fit}$;\5
\&{goto} \37\\{done1};\6
\&{end};\2\2\6
$\|b\K\\{badness}(\\{shortfall},\39\\{cur\_active\_width}[2])$;\6
\&{if} $\|b>12$ \1\&{then}\6
\&{if} $\|b>99$ \1\&{then}\5
$\\{fit\_class}\K\\{very\_loose\_fit}$\6
\4\&{else} $\\{fit\_class}\K\\{loose\_fit}$\2\6
\4\&{else} $\\{fit\_class}\K\\{decent\_fit}$;\2\6
\4\\{done1}: \37\&{end}\2\par
\U1027.\fi

\M1029. Shrinkability is never infinite in a paragraph;
we can shrink the line from \|r to \\{cur\_p} by at most $\\{cur\_active%
\_width}[6]$.

\Y\P$\4\X1029:Set the value of \|b to the badness for shrinking the line, and
compute the corresponding \\{fit\_class}\X\S$\6
\&{begin} \37\&{if} $-\\{shortfall}>\\{cur\_active\_width}[6]$ \1\&{then}\5
$\|b\K\\{inf\_bad}+1$\6
\4\&{else} $\|b\K\\{badness}(-\\{shortfall},\39\\{cur\_active\_width}[6])$;\2\6
\&{if} $\|b>12$ \1\&{then}\5
$\\{fit\_class}\K\\{tight\_fit}$\ \&{else} $\\{fit\_class}\K\\{decent\_fit}$;\2%
\6
\&{end}\par
\U1027.\fi

\M1030. During the final pass, we dare not lose all active nodes, lest we lose
touch with the line breaks already found. The code shown here makes sure
that such a catastrophe does not happen, by permitting overfull boxes as
a last resort. This particular part of \TeX\ was a source of several subtle
bugs before the correct program logic was finally discovered; readers
who seek to ``improve'' \TeX\ should therefore think thrice before daring
to make any changes here.

\Y\P$\4\X1030:Prepare to deactivate node~\|r, and \&{goto} \\{deactivate}
unless there is a reason to consider lines of text from \|r to \\{cur\_p}\X\S$\6
\&{begin} \37\&{if} $\\{final\_pass}\W(\\{minimum\_demerits}=\\{awful\_bad})\W%
\30(\\{link}(\|r)=\\{last\_active})\W(\\{prev\_r}=\\{active})$ \1\&{then}\5
$\\{artificial\_demerits}\K\\{true}$\C{set demerits zero, this break is forced}%
\6
\4\&{else} \&{if} $\|b>\\{threshold}$ \1\&{then}\5
\&{goto} \37\\{deactivate};\2\2\6
$\\{node\_r\_stays\_active}\K\\{false}$;\6
\&{end}\par
\U1027.\fi

\M1031. When we get to this part of the code, the line from \|r to \\{cur\_p}
is
feasible, its badness is~\|b, and its fitness classification is \\{fit\_class}.
We don't want to make an active node for this break yet, but we will
compute the total demerits and record them in the \\{minimal\_demerits} array,
if such a break is the current champion among all ways to get to \\{cur\_p}
in a given line-number class and fitness class.

\Y\P$\4\X1031:Record a new feasible break\X\S$\6
\&{if} $\\{artificial\_demerits}$ \1\&{then}\5
$\|d\K0$\6
\4\&{else} \X1035:Compute the demerits, \|d, from \|r to \\{cur\_p}\X;\2\6
\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
\X1032:Print a symbolic description of this feasible break\X;\2\6
\&{tats}\6
$\|d\K\|d+\\{total\_demerits}(\|r)$;\C{this is the minimum total demerits
from the beginning to \\{cur\_p} via \|r}\6
\&{if} $\|d\L\\{minimal\_demerits}[\\{fit\_class}]$ \1\&{then}\6
\&{begin} \37$\\{minimal\_demerits}[\\{fit\_class}]\K\|d$;\5
$\\{best\_place}[\\{fit\_class}]\K\\{break\_node}(\|r)$;\5
$\\{best\_pl\_line}[\\{fit\_class}]\K\|l$;\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1850:Store \(a)additional data for this feasible break\X;\2\6
\&{if} $\|d<\\{minimum\_demerits}$ \1\&{then}\5
$\\{minimum\_demerits}\K\|d$;\2\6
\&{end}\2\par
\U1027.\fi

\M1032. \P$\X1032:Print a symbolic description of this feasible break\X\S$\6
\&{begin} \37\&{if} $\\{printed\_node}\I\\{cur\_p}$ \1\&{then}\5
\X1033:Print the list between \\{printed\_node} and \\{cur\_p}, then set $%
\\{printed\_node}\K\\{cur\_p}$\X;\2\6
$\\{print\_nl}(\.{"@"})$;\6
\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\5
$\\{print\_esc}(\.{"par"})$\6
\4\&{else} \&{if} $\\{type}(\\{cur\_p})\I\\{glue\_node}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{type}(\\{cur\_p})=\\{penalty\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"penalty"})$\6
\4\&{else} \&{if} $\\{type}(\\{cur\_p})=\\{disc\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"discretionary"})$\6
\4\&{else} \&{if} $\\{type}(\\{cur\_p})=\\{kern\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"kern"})$\6
\4\&{else} $\\{print\_esc}(\.{"math"})$;\2\2\2\6
\&{end};\2\2\6
$\\{print}(\.{"\ via\ @@"})$;\6
\&{if} $\\{break\_node}(\|r)=\\{null}$ \1\&{then}\5
$\\{print\_char}(\.{"0"})$\6
\4\&{else} $\\{print\_int}(\\{serial}(\\{break\_node}(\|r)))$;\2\6
$\\{print}(\.{"\ b="})$;\6
\&{if} $\|b>\\{inf\_bad}$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\ \&{else} $\\{print\_int}(\|b)$;\2\6
$\\{print}(\.{"\ p="})$;\5
$\\{print\_int}(\\{pi})$;\5
$\\{print}(\.{"\ d="})$;\6
\&{if} $\\{artificial\_demerits}$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\ \&{else} $\\{print\_int}(\|d)$;\2\6
\&{end}\par
\U1031.\fi

\M1033. \P$\X1033:Print the list between \\{printed\_node} and \\{cur\_p}, then
set $\\{printed\_node}\K\\{cur\_p}$\X\S$\6
\&{begin} \37$\\{print\_nl}(\.{""})$;\6
\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\5
$\\{short\_display}(\\{link}(\\{printed\_node}))$\6
\4\&{else} \&{begin} \37$\\{save\_link}\K\\{link}(\\{cur\_p})$;\5
$\\{link}(\\{cur\_p})\K\\{null}$;\5
$\\{print\_nl}(\.{""})$;\5
$\\{short\_display}(\\{link}(\\{printed\_node}))$;\5
$\\{link}(\\{cur\_p})\K\\{save\_link}$;\6
\&{end};\2\6
$\\{printed\_node}\K\\{cur\_p}$;\6
\&{end}\par
\U1032.\fi

\M1034. When the data for a discretionary break is being displayed, we will
have
printed the \\{pre\_break} and \\{post\_break} lists; we want to skip over the
third list, so that the discretionary data will not appear twice.  The
following code is performed at the very end of \\{try\_break}.

\Y\P$\4\X1034:Update the value of \\{printed\_node} for symbolic displays\X\S$\6
\&{if} $\\{cur\_p}=\\{printed\_node}$ \1\&{then}\6
\&{if} $\\{cur\_p}\I\\{null}$ \1\&{then}\6
\&{if} $\\{type}(\\{cur\_p})=\\{disc\_node}$ \1\&{then}\6
\&{begin} \37$\|t\K\\{replace\_count}(\\{cur\_p})$;\6
\&{while} $\|t>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\|t)$;\5
$\\{printed\_node}\K\\{link}(\\{printed\_node})$;\6
\&{end};\2\6
\&{end}\2\2\2\par
\U1005.\fi

\M1035. \P$\X1035:Compute the demerits, \|d, from \|r to \\{cur\_p}\X\S$\6
\&{begin} \37$\|d\K\\{line\_penalty}+\|b$;\6
\&{if} $\\{abs}(\|d)\G10000$ \1\&{then}\5
$\|d\K100000000$\ \&{else} $\|d\K\|d\ast\|d$;\2\6
\&{if} $\\{pi}\I0$ \1\&{then}\6
\&{if} $\\{pi}>0$ \1\&{then}\5
$\|d\K\|d+\\{pi}\ast\\{pi}$\6
\4\&{else} \&{if} $\\{pi}>\\{eject\_penalty}$ \1\&{then}\5
$\|d\K\|d-\\{pi}\ast\\{pi}$;\2\2\2\6
\&{if} $(\\{break\_type}=\\{hyphenated})\W(\\{type}(\|r)=\\{hyphenated})$ \1%
\&{then}\6
\&{if} $\\{cur\_p}\I\\{null}$ \1\&{then}\5
$\|d\K\|d+\\{double\_hyphen\_demerits}$\6
\4\&{else} $\|d\K\|d+\\{final\_hyphen\_demerits}$;\2\2\6
\&{if} $\\{abs}(\\{fit\_class}-\\{fitness}(\|r))>1$ \1\&{then}\5
$\|d\K\|d+\\{adj\_demerits}$;\2\6
\&{end}\par
\U1031.\fi

\M1036. When an active node disappears, we must delete an adjacent delta node
if the
active node was at the beginning or the end of the active list, or if it
was surrounded by delta nodes. We also must preserve the property that
\\{cur\_active\_width} represents the length of material from $\\{link}(\\{prev%
\_r})$
to~\\{cur\_p}.

\Y\P\D \37$\\{combine\_two\_deltas}(\#)\S\30\\{mem}[\\{prev\_r}+\#].\\{sc}\K%
\\{mem}[\\{prev\_r}+\#].\\{sc}+\\{mem}[\|r+\#].\\{sc}$\par
\P\D \37$\\{downdate\_width}(\#)\S\30\\{cur\_active\_width}[\#]\K\\{cur\_active%
\_width}[\#]-\\{mem}[\\{prev\_r}+\#].\\{sc}$\par
\Y\P$\4\X1036:Deactivate node \|r\X\S$\6
$\\{link}(\\{prev\_r})\K\\{link}(\|r)$;\5
$\\{free\_node}(\|r,\39\\{active\_node\_size})$;\6
\&{if} $\\{prev\_r}=\\{active}$ \1\&{then}\5
\X1037:Update the active widths, since the first active node has been deleted\X%
\6
\4\&{else} \&{if} $\\{type}(\\{prev\_r})=\\{delta\_node}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{link}(\\{prev\_r})$;\6
\&{if} $\|r=\\{last\_active}$ \1\&{then}\6
\&{begin} \37$\\{do\_all\_eight}(\\{downdate\_width})$;\5
$\\{link}(\\{prev\_prev\_r})\K\\{last\_active}$;\5
$\\{free\_node}(\\{prev\_r},\39\\{delta\_node\_size})$;\5
$\\{prev\_r}\K\\{prev\_prev\_r}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\|r)=\\{delta\_node}$ \1\&{then}\6
\&{begin} \37$\\{do\_all\_eight}(\\{update\_width})$;\5
$\\{do\_all\_eight}(\\{combine\_two\_deltas})$;\5
$\\{link}(\\{prev\_r})\K\\{link}(\|r)$;\5
$\\{free\_node}(\|r,\39\\{delta\_node\_size})$;\6
\&{end};\2\2\6
\&{end}\2\2\par
\U1027.\fi

\M1037. The following code uses the fact that $\\{type}(\\{last\_active})\I%
\\{delta\_node}$. If the
active list has just become empty, we do not need to update the
\\{active\_width} array, since it will be initialized when an active
node is next inserted.

\Y\P\D \37$\\{update\_active}(\#)\S\\{active\_width}[\#]\K\\{active\_width}[%
\#]+\\{mem}[\|r+\#].\\{sc}$\par
\Y\P$\4\X1037:Update the active widths, since the first active node has been
deleted\X\S$\6
\&{begin} \37$\|r\K\\{link}(\\{active})$;\6
\&{if} $\\{type}(\|r)=\\{delta\_node}$ \1\&{then}\6
\&{begin} \37$\\{do\_all\_eight}(\\{update\_active})$;\5
$\\{do\_all\_eight}(\\{copy\_to\_cur\_active})$;\5
$\\{link}(\\{active})\K\\{link}(\|r)$;\5
$\\{free\_node}(\|r,\39\\{delta\_node\_size})$;\6
\&{end};\2\6
\&{end}\par
\U1036.\fi

\N1038.  \[39] Breaking paragraphs into lines, continued.
So far we have gotten a little way into the \\{line\_break} routine, having
covered its important \\{try\_break} subroutine. Now let's consider the
rest of the process.

The main loop of \\{line\_break} traverses the given hlist,
starting at $\\{link}(\\{temp\_head})$, and calls \\{try\_break} at each legal
breakpoint. A variable called \\{auto\_breaking} is set to true except
within math formulas, since glue nodes are not legal breakpoints when
they appear in formulas.

The current node of interest in the hlist is pointed to by \\{cur\_p}. Another
variable, \\{prev\_p}, is usually one step behind \\{cur\_p}, but the real
meaning of \\{prev\_p} is this: If $\\{type}(\\{cur\_p})=\\{glue\_node}$ then %
\\{cur\_p} is a legal
breakpoint if and only if \\{auto\_breaking} is true and \\{prev\_p} does not
point to a glue node, penalty node, explicit kern node, or math node.

The following declarations provide for a few other local variables that are
used in special calculations.

\Y\P$\4\X1038:Local variables for line breaking\X\S$\6
\4$\|q,\39\|r,\39\|s,\39\\{prev\_s}$: \37\\{pointer};\C{miscellaneous nodes of
temporary interest}\6
\4\|f: \37\\{internal\_font\_number};\C{used when calculating character widths}%
\par
\A1070.
\U991.\fi

\M1039. The `\ignorespaces \~ \&{loop}\unskip' in the following code is
performed at most
thrice per call of \\{line\_break}, since it is actually a pass over the
entire paragraph.

\Y\P$\4\X1039:Find optimal breakpoints\X\S$\6
$\\{threshold}\K\\{pretolerance}$;\6
\&{if} $\\{threshold}\G0$ \1\&{then}\6
\&{begin} \37\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"@firstpass"})$;\ \&{end};\2\ \&{tats}\6
$\\{second\_pass}\K\\{false}$;\5
$\\{final\_pass}\K\\{false}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{threshold}\K\\{tolerance}$;\5
$\\{second\_pass}\K\\{true}$;\5
$\\{final\_pass}\K(\\{emergency\_stretch}\L0)$;\6
\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
\\{begin\_diagnostic};\ \2\6
\&{tats}\6
\&{end};\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{threshold}>\\{inf\_bad}$ \1\&{then}\5
$\\{threshold}\K\\{inf\_bad}$;\2\6
\&{if} $\\{second\_pass}$ \1\&{then}\5
\X1068:Initialize for hyphenating a paragraph\X;\2\6
\X1040:Create an active breakpoint representing the beginning of the paragraph%
\X;\6
$\\{cur\_p}\K\\{link}(\\{temp\_head})$;\5
$\\{auto\_breaking}\K\\{true}$;\6
$\\{prev\_p}\K\\{cur\_p}$;\C{glue at beginning is not a legal breakpoint}\6
$\\{prev\_char\_p}\K\\{null}$;\5
$\\{prev\_legal}\K\\{null}$;\5
$\\{rejected\_cur\_p}\K\\{null}$;\5
$\\{try\_prev\_break}\K\\{false}$;\5
$\\{before\_rejected\_cur\_p}\K\\{false}$;\5
$\\{first\_p}\K\\{cur\_p}$;\C{to access the first node of paragraph as the
first active                      node has $\\{break\_node}=\\{null}$}\6
\&{while} $(\\{cur\_p}\I\\{null})\W(\\{link}(\\{active})\I\\{last\_active})$ \1%
\&{do}\5
\X1042:Call \\{try\_break} if \\{cur\_p} is a legal breakpoint; on the second
pass, also try to hyphenate the next word, if \\{cur\_p} is a glue node; then
advance \\{cur\_p} to the next node of the paragraph that could possibly be a
legal breakpoint\X;\2\6
\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\5
\X1049:Try the final line break at the end of the paragraph, and \&{goto} %
\\{done} if the desired breakpoints have been found\X;\2\6
\X1041:Clean up the memory by removing the break nodes\X;\6
\&{if} $\R\\{second\_pass}$ \1\&{then}\6
\&{begin} \37\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\5
$\\{print\_nl}(\.{"@secondpass"})$;\2\ \&{tats}\6
$\\{threshold}\K\\{tolerance}$;\5
$\\{second\_pass}\K\\{true}$;\5
$\\{final\_pass}\K(\\{emergency\_stretch}\L0)$;\6
\&{end}\C{if at first you don't succeed, \dots}\6
\4\&{else} \&{begin} \37\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1%
\&{then}\5
$\\{print\_nl}(\.{"@emergencypass"})$;\2\ \&{tats}\6
$\\{background}[2]\K\\{background}[2]+\\{emergency\_stretch}$;\5
$\\{final\_pass}\K\\{true}$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{done}: \37\&{stat} \37\&{if} $\\{tracing\_paragraphs}>0$ \1\&{then}\6
\&{begin} \37$\\{end\_diagnostic}(\\{true})$;\5
\\{normalize\_selector};\6
\&{end};\ \2\6
\&{tats}\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1853:Adjust \(t)the final line of the paragraph\X;\2\par
\U991.\fi

\M1040. The active node that represents the starting point does not need a
corresponding passive node.

\Y\P\D \37$\\{store\_background}(\#)\S\\{active\_width}[\#]\K\\{background}[%
\#]$\par
\Y\P$\4\X1040:Create an active breakpoint representing the beginning of the
paragraph\X\S$\6
$\|q\K\\{get\_node}(\\{active\_node\_size})$;\5
$\\{type}(\|q)\K\\{unhyphenated}$;\5
$\\{fitness}(\|q)\K\\{decent\_fit}$;\5
$\\{link}(\|q)\K\\{last\_active}$;\5
$\\{break\_node}(\|q)\K\\{null}$;\5
$\\{line\_number}(\|q)\K\\{prev\_graf}+1$;\5
$\\{total\_demerits}(\|q)\K0$;\5
$\\{link}(\\{active})\K\|q$;\6
\&{if} $\\{do\_last\_line\_fit}$ \1\&{then}\5
\X1845:Initialize additional fields of the first active node\X;\2\6
$\\{do\_all\_eight}(\\{store\_background})$;\6
$\\{passive}\K\\{null}$;\5
$\\{printed\_node}\K\\{temp\_head}$;\5
$\\{pass\_number}\K0$;\5
$\\{font\_in\_short\_display}\K\\{null\_font}$\par
\U1039.\fi

\M1041. \P$\X1041:Clean up the memory by removing the break nodes\X\S$\6
$\|q\K\\{link}(\\{active})$;\6
\&{while} $\|q\I\\{last\_active}$ \1\&{do}\6
\&{begin} \37$\\{cur\_p}\K\\{link}(\|q)$;\6
\&{if} $\\{type}(\|q)=\\{delta\_node}$ \1\&{then}\5
$\\{free\_node}(\|q,\39\\{delta\_node\_size})$\6
\4\&{else} $\\{free\_node}(\|q,\39\\{active\_node\_size})$;\2\6
$\|q\K\\{cur\_p}$;\6
\&{end};\2\6
$\|q\K\\{passive}$;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{cur\_p}\K\\{link}(\|q)$;\5
$\\{free\_node}(\|q,\39\\{passive\_node\_size})$;\5
$\|q\K\\{cur\_p}$;\6
\&{end}\2\par
\Us991\ET1039.\fi

\M1042. Here is the main switch in the \\{line\_break} routine, where legal
breaks
are determined. As we move through the hlist, we need to keep the \\{active%
\_width}
array up to date, so that the badness of individual lines is readily calculated
by \\{try\_break}. It is convenient to use the short name \\{act\_width} for
the component of active width that represents real width as opposed to glue.

\Y\P\D \37$\\{act\_width}\S\\{active\_width}[1]$\C{length from first active
node to current node}\par
\P\D \37$\\{kern\_break}\S$\1\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\\{link}(\\{cur\_p}))\W\\{auto%
\_breaking}$ \1\&{then}\6
\&{if} $\\{type}(\\{link}(\\{cur\_p}))=\\{glue\_node}$ \1\&{then}\5
$\\{try\_break}(0,\39\\{unhyphenated})$;\2\2\6
$\\{act\_width}\K\\{act\_width}+\\{width}(\\{cur\_p})$;\6
\&{end}\2\par
\Y\P$\4\X1042:Call \\{try\_break} if \\{cur\_p} is a legal breakpoint; on the
second pass, also try to hyphenate the next word, if \\{cur\_p} is a glue node;
then advance \\{cur\_p} to the next node of the paragraph that could possibly
be a legal breakpoint\X\S$\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\\{cur\_p})$ \1\&{then}\5
\X1043:Advance \(c)\\{cur\_p} to the node following the present string of
characters\X;\2\6
\&{case} $\\{type}(\\{cur\_p})$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37$\\{act\_width}\K%
\\{act\_width}+\\{width}(\\{cur\_p})$;\6
\4\\{whatsit\_node}: \37\X1609:Advance \(p)past a whatsit node in the \(l)%
\\{line\_break} loop\X;\6
\4\\{glue\_node}: \37\&{begin} \37\X1044:If node \\{cur\_p} is a legal
breakpoint, call \\{try\_break}; then update the active widths by including the
glue in $\\{glue\_ptr}(\\{cur\_p})$\X;\6
\&{if} $\\{second\_pass}\W\\{auto\_breaking}$ \1\&{then}\5
\X1071:Try to hyphenate the following word\X;\2\6
\&{end};\6
\4\\{kern\_node}: \37\&{if} $\\{subtype}(\\{cur\_p})=\\{explicit}$ \1\&{then}\5
\\{kern\_break}\6
\4\&{else} \&{begin} \37$\\{act\_width}\K\\{act\_width}+\\{width}(\\{cur\_p})$;%
\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W(\\{subtype}(\\{cur\_p})=\\{normal})$ \1%
\&{then}\6
\&{begin} \37$\\{add\_kern\_stretch}(\\{active\_width}[7])(\\{cur\_p})$;\5
$\\{add\_kern\_shrink}(\\{active\_width}[8])(\\{cur\_p})$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{ligature\_node}: \37\&{begin} \37$\|f\K\\{font}(\\{lig\_char}(\\{cur%
\_p}))$;\5
$\\{act\_width}\K\\{act\_width}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(%
\\{character}(\\{lig\_char}(\\{cur\_p}))))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\\{cur\_p}$;\5
$\\{add\_char\_stretch}(\\{active\_width}[7])(\\{character}(\\{lig\_char}(%
\\{cur\_p})))$;\5
$\\{add\_char\_shrink}(\\{active\_width}[8])(\\{character}(\\{lig\_char}(\\{cur%
\_p})))$;\6
\&{end};\2\6
\&{end};\6
\4\\{disc\_node}: \37\X1045:Try to break after a discretionary fragment, then %
\&{goto} \\{done5}\X;\6
\4\\{math\_node}: \37\&{begin} \37\&{if} $\\{subtype}(\\{cur\_p})<\\{L\_code}$ %
\1\&{then}\5
$\\{auto\_breaking}\K\\{odd}(\\{subtype}(\\{cur\_p}))$;\2\6
\\{kern\_break};\6
\&{end};\6
\4\\{penalty\_node}: \37$\\{try\_break}(\\{penalty}(\\{cur\_p}),\39%
\\{unhyphenated})$;\6
\4$\\{mark\_node},\39\\{ins\_node},\39\\{adjust\_node}$: \37\\{do\_nothing};\6
\4\&{othercases} \37$\\{confusion}(\.{"paragraph"})$\2\6
\&{endcases};\6
$\\{prev\_p}\K\\{cur\_p}$;\5
$\\{cur\_p}\K\\{link}(\\{cur\_p})$;\6
\4\\{done5}: \37\&{end}\par
\U1039.\fi

\M1043. The code that passes over the characters of words in a paragraph is
part of \TeX's inner loop, so it has been streamlined for speed. We use
the fact that `\.{\\parfillskip}' glue appears at the end of each paragraph;
it is therefore unnecessary to check if $\\{link}(\\{cur\_p})=\\{null}$ when %
\\{cur\_p} is a
character node.

\Y\P$\4\X1043:Advance \(c)\\{cur\_p} to the node following the present string
of characters\X\S$\6
\&{begin} \37$\\{prev\_p}\K\\{cur\_p}$;\6
\1\&{repeat} \37$\|f\K\\{font}(\\{cur\_p})$;\5
$\\{act\_width}\K\\{act\_width}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(%
\\{character}(\\{cur\_p})))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\\{cur\_p}$;\5
$\\{add\_char\_stretch}(\\{active\_width}[7])(\\{character}(\\{cur\_p}))$;\5
$\\{add\_char\_shrink}(\\{active\_width}[8])(\\{character}(\\{cur\_p}))$;\6
\&{end};\2\6
$\\{cur\_p}\K\\{link}(\\{cur\_p})$;\6
\4\&{until}\5
$\R\\{is\_char\_node}(\\{cur\_p})$;\2\6
\&{end}\par
\U1042.\fi

\M1044. When node \\{cur\_p} is a glue node, we look at \\{prev\_p} to see
whether or not
a breakpoint is legal at \\{cur\_p}, as explained above.

\Y\P$\4\X1044:If node \\{cur\_p} is a legal breakpoint, call \\{try\_break};
then update the active widths by including the glue in $\\{glue\_ptr}(\\{cur%
\_p})$\X\S$\6
\&{if} $\\{auto\_breaking}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\\{prev\_p})$ \1\&{then}\5
$\\{try\_break}(0,\39\\{unhyphenated})$\6
\4\&{else} \&{if} $\\{precedes\_break}(\\{prev\_p})$ \1\&{then}\5
$\\{try\_break}(0,\39\\{unhyphenated})$\6
\4\&{else} \&{if} $(\\{type}(\\{prev\_p})=\\{kern\_node})\W(\\{subtype}(\\{prev%
\_p})\I\\{explicit})$ \1\&{then}\5
$\\{try\_break}(0,\39\\{unhyphenated})$;\2\2\2\6
\&{end};\2\6
$\\{check\_shrinkage}(\\{glue\_ptr}(\\{cur\_p}))$;\5
$\|q\K\\{glue\_ptr}(\\{cur\_p})$;\5
$\\{act\_width}\K\\{act\_width}+\\{width}(\|q)$;\5
$\30\\{active\_width}[2+\\{stretch\_order}(\|q)]\K\30\\{active\_width}[2+%
\\{stretch\_order}(\|q)]+\\{stretch}(\|q)$;\6
$\\{active\_width}[6]\K\\{active\_width}[6]+\\{shrink}(\|q)$\par
\U1042.\fi

\M1045. The following code knows that discretionary texts contain
only character nodes, kern nodes, box nodes, rule nodes, and ligature nodes.

\Y\P$\4\X1045:Try to break after a discretionary fragment, then \&{goto} %
\\{done5}\X\S$\6
\&{begin} \37$\|s\K\\{pre\_break}(\\{cur\_p})$;\5
$\\{do\_one\_seven\_eight}(\\{reset\_disc\_width})$;\6
\&{if} $\|s=\\{null}$ \1\&{then}\5
$\\{try\_break}(\\{ex\_hyphen\_penalty},\39\\{hyphenated})$\6
\4\&{else} \&{begin} \37\1\&{repeat} \37\X1046:Add the width of node \|s to %
\\{disc\_width}\X;\6
$\|s\K\\{link}(\|s)$;\6
\4\&{until}\5
$\|s=\\{null}$;\2\6
$\\{do\_one\_seven\_eight}(\\{add\_disc\_width\_to\_active\_width})$;\5
$\\{try\_break}(\\{hyphen\_penalty},\39\\{hyphenated})$;\5
$\\{do\_one\_seven\_eight}(\\{sub\_disc\_width\_from\_active\_width})$;\6
\&{end};\2\6
$\|r\K\\{replace\_count}(\\{cur\_p})$;\5
$\|s\K\\{link}(\\{cur\_p})$;\6
\&{while} $\|r>0$ \1\&{do}\6
\&{begin} \37\X1047:Add the width of node \|s to \\{act\_width}\X;\6
$\\{decr}(\|r)$;\5
$\|s\K\\{link}(\|s)$;\6
\&{end};\2\6
$\\{prev\_p}\K\\{cur\_p}$;\5
$\\{cur\_p}\K\|s$;\5
\&{goto} \37\\{done5};\6
\&{end}\par
\U1042.\fi

\M1046. \P$\X1046:Add the width of node \|s to \\{disc\_width}\X\S$\6
\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|s)$;\5
$\\{disc\_width}[1]\K\\{disc\_width}[1]+\\{char\_width}(\|f)(\\{char\_info}(%
\|f)(\\{character}(\|s)))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{disc\_width}[7])(\\{character}(\|s))$;\5
$\\{add\_char\_shrink}(\\{disc\_width}[8])(\\{character}(\|s))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{case} $\\{type}(\|s)$ \1\&{of}\6
\4\\{ligature\_node}: \37\&{begin} \37$\|f\K\\{font}(\\{lig\_char}(\|s))$;\5
$\\{disc\_width}[1]\K\\{disc\_width}[1]+\\{char\_width}(\|f)(\\{char\_info}(%
\|f)(\\{character}(\\{lig\_char}(\|s))))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{disc\_width}[7])(\\{character}(\\{lig\_char}(%
\|s)))$;\5
$\\{add\_char\_shrink}(\\{disc\_width}[8])(\\{character}(\\{lig\_char}(\|s)))$;%
\6
\&{end};\2\6
\&{end};\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{kern\_node}$: \37%
\&{begin} \37$\\{disc\_width}[1]\K\\{disc\_width}[1]+\\{width}(\|s)$;\6
\&{if} $(\\{type}(\|s)=\\{kern\_node})\W(\\{pdf\_adjust\_spacing}>1)\W(%
\\{subtype}(\|s)=\\{normal})$ \1\&{then}\6
\&{begin} \37$\\{add\_kern\_stretch}(\\{disc\_width}[7])(\|s)$;\5
$\\{add\_kern\_shrink}(\\{disc\_width}[8])(\|s)$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"disc3"})$\2\6
\&{endcases}\2\par
\U1045.\fi

\M1047. \P$\X1047:Add the width of node \|s to \\{act\_width}\X\S$\6
\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|s)$;\5
$\\{act\_width}\K\\{act\_width}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(%
\\{character}(\|s)))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{active\_width}[7])(\\{character}(\|s))$;\5
$\\{add\_char\_shrink}(\\{active\_width}[8])(\\{character}(\|s))$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{case} $\\{type}(\|s)$ \1\&{of}\6
\4\\{ligature\_node}: \37\&{begin} \37$\|f\K\\{font}(\\{lig\_char}(\|s))$;\5
$\\{act\_width}\K\\{act\_width}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(%
\\{character}(\\{lig\_char}(\|s))))$;\6
\&{if} $(\\{pdf\_adjust\_spacing}>1)\W\\{check\_expand\_pars}(\|f)$ \1\&{then}\6
\&{begin} \37$\\{prev\_char\_p}\K\|s$;\5
$\\{add\_char\_stretch}(\\{active\_width}[7])(\\{character}(\\{lig\_char}(%
\|s)))$;\5
$\\{add\_char\_shrink}(\\{active\_width}[8])(\\{character}(\\{lig\_char}(%
\|s)))$;\6
\&{end};\2\6
\&{end};\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{kern\_node}$: \37%
\&{begin} \37$\\{act\_width}\K\\{act\_width}+\\{width}(\|s)$;\6
\&{if} $(\\{type}(\|s)=\\{kern\_node})\W(\\{pdf\_adjust\_spacing}>1)\W(%
\\{subtype}(\|s)=\\{normal})$ \1\&{then}\6
\&{begin} \37$\\{add\_kern\_stretch}(\\{active\_width}[7])(\|s)$;\5
$\\{add\_kern\_shrink}(\\{active\_width}[8])(\|s)$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"disc4"})$\2\6
\&{endcases}\2\par
\U1045.\fi

\M1048. The forced line break at the paragraph's end will reduce the list of
breakpoints so that all active nodes represent breaks at $\\{cur\_p}=\\{null}$.
On the first pass, we insist on finding an active node that has the
correct ``looseness.'' On the final pass, there will be at least one active
node, and we will match the desired looseness as well as we can.

The global variable \\{best\_bet} will be set to the active node for the best
way to break the paragraph, and a few other variables are used to
help determine what is best.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{best\_bet}: \37\\{pointer};\C{use this passive node and its predecessors}\6
\4\\{fewest\_demerits}: \37\\{integer};\C{the demerits associated with \\{best%
\_bet}}\6
\4\\{best\_line}: \37\\{halfword};\C{line number following the last line of the
new paragraph}\6
\4\\{actual\_looseness}: \37\\{integer};\C{the difference between $\\{line%
\_number}(\\{best\_bet})$   and the optimum \\{best\_line}}\6
\4\\{line\_diff}: \37\\{integer};\C{the difference between the current line
number and   the optimum \\{best\_line}}\par
\fi

\M1049. \P$\X1049:Try the final line break at the end of the paragraph, and %
\&{goto} \\{done} if the desired breakpoints have been found\X\S$\6
\&{begin} \37$\\{try\_break}(\\{eject\_penalty},\39\\{hyphenated})$;\6
\&{if} $\\{link}(\\{active})\I\\{last\_active}$ \1\&{then}\6
\&{begin} \37\X1050:Find an active node with fewest demerits\X;\6
\&{if} $\\{looseness}=0$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\X1051:Find the best active node for the desired looseness\X;\6
\&{if} $(\\{actual\_looseness}=\\{looseness})\V\\{final\_pass}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{end};\2\6
\&{end}\par
\U1039.\fi

\M1050. \P$\X1050:Find an active node with fewest demerits\X\S$\6
$\|r\K\\{link}(\\{active})$;\5
$\\{fewest\_demerits}\K\\{awful\_bad}$;\6
\1\&{repeat} \37\&{if} $\\{type}(\|r)\I\\{delta\_node}$ \1\&{then}\6
\&{if} $\\{total\_demerits}(\|r)<\\{fewest\_demerits}$ \1\&{then}\6
\&{begin} \37$\\{fewest\_demerits}\K\\{total\_demerits}(\|r)$;\5
$\\{best\_bet}\K\|r$;\6
\&{end};\2\2\6
$\|r\K\\{link}(\|r)$;\6
\4\&{until}\5
$\|r=\\{last\_active}$;\2\6
$\\{best\_line}\K\\{line\_number}(\\{best\_bet})$\par
\U1049.\fi

\M1051. The adjustment for a desired looseness is a slightly more complicated
version of the loop just considered. Note that if a paragraph is broken
into segments by displayed equations, each segment will be subject to the
looseness calculation, independently of the other segments.

\Y\P$\4\X1051:Find the best active node for the desired looseness\X\S$\6
\&{begin} \37$\|r\K\\{link}(\\{active})$;\5
$\\{actual\_looseness}\K0$;\6
\1\&{repeat} \37\&{if} $\\{type}(\|r)\I\\{delta\_node}$ \1\&{then}\6
\&{begin} \37$\\{line\_diff}\K\\{line\_number}(\|r)-\\{best\_line}$;\6
\&{if} $((\\{line\_diff}<\\{actual\_looseness})\W(\\{looseness}\L\\{line%
\_diff}))\V\30((\\{line\_diff}>\\{actual\_looseness})\W(\\{looseness}\G\\{line%
\_diff}))$ \1\&{then}\6
\&{begin} \37$\\{best\_bet}\K\|r$;\5
$\\{actual\_looseness}\K\\{line\_diff}$;\5
$\\{fewest\_demerits}\K\\{total\_demerits}(\|r)$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{line\_diff}=\\{actual\_looseness})\W\30(\\{total%
\_demerits}(\|r)<\\{fewest\_demerits})$ \1\&{then}\6
\&{begin} \37$\\{best\_bet}\K\|r$;\5
$\\{fewest\_demerits}\K\\{total\_demerits}(\|r)$;\6
\&{end};\2\2\6
\&{end};\2\6
$\|r\K\\{link}(\|r)$;\6
\4\&{until}\5
$\|r=\\{last\_active}$;\2\6
$\\{best\_line}\K\\{line\_number}(\\{best\_bet})$;\6
\&{end}\par
\U1049.\fi

\M1052. Once the best sequence of breakpoints has been found (hurray), we call
on the
procedure \\{post\_line\_break} to finish the remainder of the work.
(By introducing this subprocedure, we are able to keep \\{line\_break}
from getting extremely long.)

\Y\P$\4\X1052:Break the paragraph at the chosen breakpoints, justify the
resulting lines to the correct widths, and append them to the current vertical
list\X\S$\6
$\\{post\_line\_break}(\|d)$\par
\U991.\fi

\M1053. The total number of lines that will be set by \\{post\_line\_break}
is $\\{best\_line}-\\{prev\_graf}-1$. The last breakpoint is specified by
$\\{break\_node}(\\{best\_bet})$, and this passive node points to the other
breakpoints
via the \\{prev\_break} links. The finishing-up phase starts by linking the
relevant passive nodes in forward order, changing \\{prev\_break} to
\\{next\_break}. (The \\{next\_break} fields actually reside in the same memory
space as the \\{prev\_break} fields did, but we give them a new name because
of their new significance.) Then the lines are justified, one by one.

\Y\P\D \37$\\{next\_break}\S\\{prev\_break}$\C{new name for \\{prev\_break}
after links are reversed}\par
\Y\P$\4\X1002:Declare subprocedures for \\{line\_break}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{post\_line\_break}(\|d:\\{boolean})$;\6
\4\&{label} \37$\\{done},\39\\{done1}$;\6
\4\&{var} \37$\|q,\39\|r,\39\|s$: \37\\{pointer};\C{temporary registers for
list manipulation}\6
$\|p,\39\|k$: \37\\{pointer};\5
\|w: \37\\{scaled};\5
\\{glue\_break}: \37\\{boolean};\C{was a break at glue?}\6
\\{ptmp}: \37\\{pointer};\5
\\{disc\_break}: \37\\{boolean};\C{was the current break at a discretionary
node?}\6
\\{post\_disc\_break}: \37\\{boolean};\C{and did it have a nonempty post-break
part?}\6
\\{cur\_width}: \37\\{scaled};\C{width of line number \\{cur\_line}}\6
\\{cur\_indent}: \37\\{scaled};\C{left margin of line number \\{cur\_line}}\6
\|t: \37\\{quarterword};\C{used for replacement counts in discretionary nodes}\6
\\{pen}: \37\\{integer};\C{use when calculating penalties between lines}\6
\\{cur\_line}: \37\\{halfword};\C{the current line number being justified}\6
\\{LR\_ptr}: \37\\{pointer};\C{stack of LR codes}\2\6
\&{begin} \37$\\{LR\_ptr}\K\\{LR\_save}$;\5
\X1054:Reverse the links of the relevant passive nodes, setting \\{cur\_p} to
the first breakpoint\X;\6
$\\{cur\_line}\K\\{prev\_graf}+1$;\6
\1\&{repeat} \37\X1056:Justify the line ending at breakpoint \\{cur\_p}, and
append it to the current vertical list, together with associated penalties and
other insertions\X;\6
$\\{incr}(\\{cur\_line})$;\5
$\\{cur\_p}\K\\{next\_break}(\\{cur\_p})$;\6
\&{if} $\\{cur\_p}\I\\{null}$ \1\&{then}\6
\&{if} $\R\\{post\_disc\_break}$ \1\&{then}\5
\X1055:Prune unwanted nodes at the beginning of the next line\X;\2\2\6
\4\&{until}\5
$\\{cur\_p}=\\{null}$;\2\6
\&{if} $(\\{cur\_line}\I\\{best\_line})\V(\\{link}(\\{temp\_head})\I\\{null})$ %
\1\&{then}\5
$\\{confusion}(\.{"line\ breaking"})$;\2\6
$\\{prev\_graf}\K\\{best\_line}-1$;\5
$\\{LR\_save}\K\\{LR\_ptr}$;\6
\&{end};\par
\fi

\M1054. The job of reversing links in a list is conveniently regarded as the
job
of taking items off one stack and putting them on another. In this case we
take them off a stack pointed to by \|q and having \\{prev\_break} fields;
we put them on a stack pointed to by \\{cur\_p} and having \\{next\_break}
fields.
Node \|r is the passive node being moved from stack to stack.

\Y\P$\4\X1054:Reverse the links of the relevant passive nodes, setting \\{cur%
\_p} to the first breakpoint\X\S$\6
$\|q\K\\{break\_node}(\\{best\_bet})$;\5
$\\{cur\_p}\K\\{null}$;\6
\1\&{repeat} \37$\|r\K\|q$;\5
$\|q\K\\{prev\_break}(\|q)$;\5
$\\{next\_break}(\|r)\K\\{cur\_p}$;\5
$\\{cur\_p}\K\|r$;\6
\4\&{until}\5
$\|q=\\{null}$\2\par
\U1053.\fi

\M1055. Glue and penalty and kern and math nodes are deleted at the beginning
of
a line, except in the anomalous case that the node to be deleted is actually
one of the chosen breakpoints. Otherwise
the pruning done here is designed to match
the lookahead computation in \\{try\_break}, where the \\{break\_width} values
are computed for non-discretionary breakpoints.

\Y\P$\4\X1055:Prune unwanted nodes at the beginning of the next line\X\S$\6
\&{begin} \37$\|r\K\\{temp\_head}$;\6
\~ \1\&{loop}\ \&{begin} \37$\|q\K\\{link}(\|r)$;\6
\&{if} $\|q=\\{cur\_break}(\\{cur\_p})$ \1\&{then}\5
\&{goto} \37\\{done1};\C{$\\{cur\_break}(\\{cur\_p})$ is the next breakpoint}\6
\C{now \|q cannot be \\{null}}\2\6
\&{if} $\\{is\_char\_node}(\|q)$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $\\{non\_discardable}(\|q)$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $\\{type}(\|q)=\\{kern\_node}$ \1\&{then}\6
\&{if} $\\{subtype}(\|q)\I\\{explicit}$ \1\&{then}\5
\&{goto} \37\\{done1};\2\2\6
$\|r\K\|q$;\C{now $\\{type}(\|q)=\\{glue\_node}$, \\{kern\_node}, \\{math%
\_node}, or \\{penalty\_node}}\6
\&{if} $\\{type}(\|q)=\\{math\_node}$ \1\&{then}\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1708:Adjust \(t)the LR stack for the \\{post\_line\_break} routine\X;\2\2\6
\&{end};\2\6
\4\\{done1}: \37\&{if} $\|r\I\\{temp\_head}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|r)\K\\{null}$;\5
$\\{flush\_node\_list}(\\{link}(\\{temp\_head}))$;\5
$\\{link}(\\{temp\_head})\K\|q$;\6
\&{end};\2\6
\&{end}\par
\U1053.\fi

\M1056. The current line to be justified appears in a horizontal list starting
at $\\{link}(\\{temp\_head})$ and ending at $\\{cur\_break}(\\{cur\_p})$. If $%
\\{cur\_break}(\\{cur\_p})$ is
a glue node, we reset the glue to equal the \\{right\_skip} glue; otherwise
we append the \\{right\_skip} glue at the right. If $\\{cur\_break}(\\{cur%
\_p})$ is a
discretionary node, we modify the list so that the discretionary break
is compulsory, and we set \\{disc\_break} to \\{true}. We also append
the \\{left\_skip} glue at the left of the line, unless it is zero.

\Y\P$\4\X1056:Justify the line ending at breakpoint \\{cur\_p}, and append it
to the current vertical list, together with associated penalties and other
insertions\X\S$\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1707:Insert LR nodes at the beginning of the current line and adjust the LR
stack based on LR nodes in this line\X;\2\6
\X1057:Modify the end of the line to reflect the nature of the break and to
include \.{\\rightskip}; also set the proper value of \\{disc\_break}\X;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1709:Insert LR nodes at the end of the current line\X;\2\6
\X1063:Put the \(l)\.{\\leftskip} glue at the left and detach this line\X;\6
\X1066:Call the packaging subroutine, setting \\{just\_box} to the justified
box\X;\6
\X1065:Append the new box to the current vertical list, followed by the list of
special nodes taken out of the box by the packager\X;\6
\X1067:Append a penalty node, if a nonzero penalty is appropriate\X\par
\U1053.\fi

\M1057. At the end of the following code, \|q will point to the final node on
the
list about to be justified.

\Y\P$\4\X1057:Modify the end of the line to reflect the nature of the break and
to include \.{\\rightskip}; also set the proper value of \\{disc\_break}\X\S$\6
$\|q\K\\{cur\_break}(\\{cur\_p})$;\5
$\\{disc\_break}\K\\{false}$;\5
$\\{post\_disc\_break}\K\\{false}$;\5
$\\{glue\_break}\K\\{false}$;\6
\&{if} $\|q\I\\{null}$ \1\&{then}\C{\|q cannot be a \\{char\_node}}\6
\&{if} $\\{type}(\|q)=\\{glue\_node}$ \1\&{then}\6
\&{begin} \37$\\{delete\_glue\_ref}(\\{glue\_ptr}(\|q))$;\5
$\\{glue\_ptr}(\|q)\K\\{right\_skip}$;\5
$\\{subtype}(\|q)\K\\{right\_skip\_code}+1$;\5
$\\{add\_glue\_ref}(\\{right\_skip})$;\5
$\\{glue\_break}\K\\{true}$;\5
\&{goto} \37\\{done};\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{type}(\|q)=\\{disc\_node}$ \1\&{then}\5
\X1058:Change discretionary to compulsory and set $\\{disc\_break}\K\\{true}$\X%
\6
\4\&{else} \&{if} $\\{type}(\|q)=\\{kern\_node}$ \1\&{then}\5
$\\{width}(\|q)\K0$\6
\4\&{else} \&{if} $\\{type}(\|q)=\\{math\_node}$ \1\&{then}\6
\&{begin} \37$\\{width}(\|q)\K0$;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1708:Adjust \(t)the LR stack for the \\{post\_line\_break} routine\X;\2\6
\&{end};\2\2\2\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\|q\K\\{temp\_head}$;\6
\&{while} $\\{link}(\|q)\I\\{null}$ \1\&{do}\5
$\|q\K\\{link}(\|q)$;\2\6
\&{end};\2\6
\4\\{done}: \37\C{at this point \|q is the rightmost breakpoint; the only
exception is the case of a discretionary break with non-empty \\{pre\_break},
then \|q has been changed to the last node of the \\{pre\_break} list}\6
\&{if} $\\{pdf\_protrude\_chars}>0$ \1\&{then} \6
\&{begin}   \6
\&{if} $\\{disc\_break}\W(\\{is\_char\_node}(\|q)\V(\\{type}(\|q)\I\\{disc%
\_node}))$\C{\|q has been reset to the last node of \\{pre\_break}}\6
\&{then} \6
\&{begin} \37$\|p\K\|q$;\5
$\\{ptmp}\K\|p$;\6
\&{end}\6
\4\&{else} \37\&{begin} \37$\|p\K\\{prev\_rightmost}(\\{link}(\\{temp\_head}),%
\39\|q)$;\C{get $\\{link}(\|p)=\|q$}\6
$\\{ptmp}\K\|p$;\5
$\|p\K\\{find\_protchar\_right}(\\{link}(\\{temp\_head}),\39\|p)$;\6
\&{end};\5
$\B\\{short\_display\_n}(\|p,\391)$;\5
\\{print\_ln};\5
$\T\|w\K\\{right\_pw}(\|p)$;\6
\&{if} $\|w\I0$ \1\&{then}\C{we have found a marginal kern, append it after %
\\{ptmp}}\6
\&{begin} \37$\|k\K\\{new\_margin\_kern}(-\|w,\39\\{last\_rightmost\_char},\39%
\\{right\_side})$;\5
$\\{link}(\|k)\K\\{link}(\\{ptmp})$;\5
$\\{link}(\\{ptmp})\K\|k$;\6
\&{if} $(\\{ptmp}=\|q)$ \1\&{then}\5
$\|q\K\\{link}(\|q)$;\2\6
\&{end};\2\6
\&{end} ;\C{if \|q was not a breakpoint at glue and has been reset to %
\\{rightskip} then  we append \\{rightskip} after \|q now}\6
\&{if} $\R\\{glue\_break}$ \1\&{then}\6
\&{begin} \37\X1062:Put the \(r)\.{\\rightskip} glue after node \|q\X;\6
\&{end};\2\par
\U1056.\fi

\M1058. \P$\X1058:Change discretionary to compulsory and set $\\{disc\_break}\K%
\\{true}$\X\S$\6
\&{begin} \37$\|t\K\\{replace\_count}(\|q)$;\5
\X1059:Destroy the \|t nodes following \|q, and make \|r point to the following
node\X;\6
\&{if} $\\{post\_break}(\|q)\I\\{null}$ \1\&{then}\5
\X1060:Transplant the post-break list\X;\2\6
\&{if} $\\{pre\_break}(\|q)\I\\{null}$ \1\&{then}\5
\X1061:Transplant the pre-break list\X;\2\6
$\\{link}(\|q)\K\|r$;\5
$\\{disc\_break}\K\\{true}$;\6
\&{end}\par
\U1057.\fi

\M1059. \P$\X1059:Destroy the \|t nodes following \|q, and make \|r point to
the following node\X\S$\6
\&{if} $\|t=0$ \1\&{then}\5
$\|r\K\\{link}(\|q)$\6
\4\&{else} \&{begin} \37$\|r\K\|q$;\6
\&{while} $\|t>1$ \1\&{do}\6
\&{begin} \37$\|r\K\\{link}(\|r)$;\5
$\\{decr}(\|t)$;\6
\&{end};\2\6
$\|s\K\\{link}(\|r)$;\5
$\|r\K\\{link}(\|s)$;\5
$\\{link}(\|s)\K\\{null}$;\5
$\\{flush\_node\_list}(\\{link}(\|q))$;\5
$\\{replace\_count}(\|q)\K0$;\6
\&{end}\2\par
\U1058.\fi

\M1060. We move the post-break list from inside node \|q to the main list by
re\-attaching it just before the present node \|r, then resetting \|r.

\Y\P$\4\X1060:Transplant the post-break list\X\S$\6
\&{begin} \37$\|s\K\\{post\_break}(\|q)$;\6
\&{while} $\\{link}(\|s)\I\\{null}$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
$\\{link}(\|s)\K\|r$;\5
$\|r\K\\{post\_break}(\|q)$;\5
$\\{post\_break}(\|q)\K\\{null}$;\5
$\\{post\_disc\_break}\K\\{true}$;\6
\&{end}\par
\U1058.\fi

\M1061. We move the pre-break list from inside node \|q to the main list by
re\-attaching it just after the present node \|q, then resetting \|q.

\Y\P$\4\X1061:Transplant the pre-break list\X\S$\6
\&{begin} \37$\|s\K\\{pre\_break}(\|q)$;\5
$\\{link}(\|q)\K\|s$;\6
\&{while} $\\{link}(\|s)\I\\{null}$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
$\\{pre\_break}(\|q)\K\\{null}$;\5
$\|q\K\|s$;\6
\&{end}\par
\U1058.\fi

\M1062. \P$\X1062:Put the \(r)\.{\\rightskip} glue after node \|q\X\S$\6
$\|r\K\\{new\_param\_glue}(\\{right\_skip\_code})$;\5
$\\{link}(\|r)\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\|r$;\5
$\|q\K\|r$\par
\U1057.\fi

\M1063. The following code begins with \|q at the end of the list to be
justified. It ends with \|q at the beginning of that list, and with
$\\{link}(\\{temp\_head})$ pointing to the remainder of the paragraph, if any.

\Y\P$\4\X1063:Put the \(l)\.{\\leftskip} glue at the left and detach this line%
\X\S$\6
$\|r\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\\{null}$;\5
$\|q\K\\{link}(\\{temp\_head})$;\5
$\\{link}(\\{temp\_head})\K\|r$;\C{at this point \|q is the leftmost node; all
discardable nodes have been discarded}\6
\&{if} $\\{pdf\_protrude\_chars}>0$ \1\&{then}\6
\&{begin} \37$\|p\K\|q$;\5
$\|p\K\\{find\_protchar\_left}(\|p,\39\\{false})$;\C{no more discardables}\6
$\|w\K\\{left\_pw}(\|p)$;\6
\&{if} $\|w\I0$ \1\&{then}\6
\&{begin} \37$\|k\K\\{new\_margin\_kern}(-\|w,\39\\{last\_leftmost\_char},\39%
\\{left\_side})$;\5
$\\{link}(\|k)\K\|q$;\5
$\|q\K\|k$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{left\_skip}\I\\{zero\_glue}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{new\_param\_glue}(\\{left\_skip\_code})$;\5
$\\{link}(\|r)\K\|q$;\5
$\|q\K\|r$;\6
\&{end}\2\par
\U1056.\fi

\M1064. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X%
\mathrel{+}\S$\6
$\\{pdf\_ignored\_dimen}\K\\{ignore\_depth}$;\5
$\\{pdf\_each\_line\_height}\K\\{pdf\_ignored\_dimen}$;\5
$\\{pdf\_each\_line\_depth}\K\\{pdf\_ignored\_dimen}$;\5
$\\{pdf\_first\_line\_height}\K\\{pdf\_ignored\_dimen}$;\5
$\\{pdf\_last\_line\_depth}\K\\{pdf\_ignored\_dimen}$;\par
\fi

\M1065. \P$\X1065:Append the new box to the current vertical list, followed by
the list of special nodes taken out of the box by the packager\X\S$\6
\&{if} $\\{pdf\_each\_line\_height}\I\\{pdf\_ignored\_dimen}$ \1\&{then}\5
$\\{height}(\\{just\_box})\K\\{pdf\_each\_line\_height}$;\2\6
\&{if} $\\{pdf\_each\_line\_depth}\I\\{pdf\_ignored\_dimen}$ \1\&{then}\5
$\\{depth}(\\{just\_box})\K\\{pdf\_each\_line\_depth}$;\2\6
\&{if} $(\\{pdf\_first\_line\_height}\I\\{pdf\_ignored\_dimen})\W(\\{cur%
\_line}=\\{prev\_graf}+1)$ \1\&{then}\5
$\\{height}(\\{just\_box})\K\\{pdf\_first\_line\_height}$;\2\6
\&{if} $(\\{pdf\_last\_line\_depth}\I\\{pdf\_ignored\_dimen})\W(\\{cur%
\_line}+1=\\{best\_line})$ \1\&{then}\5
$\\{depth}(\\{just\_box})\K\\{pdf\_last\_line\_depth}$;\2\6
\&{if} $\\{pre\_adjust\_head}\I\\{pre\_adjust\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{pre\_adjust\_head})(\\{pre\_adjust\_tail})$;\2\6
$\\{pre\_adjust\_tail}\K\\{null}$;\5
$\\{append\_to\_vlist}(\\{just\_box})$;\6
\&{if} $\\{adjust\_head}\I\\{adjust\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{adjust\_head})(\\{adjust\_tail})$;\2\6
$\\{adjust\_tail}\K\\{null}$\par
\U1056.\fi

\M1066. Now \|q points to the hlist that represents the current line of the
paragraph. We need to compute the appropriate line width, pack the
line into a box of this size, and shift the box by the appropriate
amount of indentation.

\Y\P$\4\X1066:Call the packaging subroutine, setting \\{just\_box} to the
justified box\X\S$\6
\&{if} $\\{cur\_line}>\\{last\_special\_line}$ \1\&{then}\6
\&{begin} \37$\\{cur\_width}\K\\{second\_width}$;\5
$\\{cur\_indent}\K\\{second\_indent}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{par\_shape\_ptr}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{cur\_width}\K\\{first\_width}$;\5
$\\{cur\_indent}\K\\{first\_indent}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_width}\K\\{mem}[\\{par\_shape\_ptr}+2\ast%
\\{cur\_line}].\\{sc}$;\5
$\\{cur\_indent}\K\\{mem}[\\{par\_shape\_ptr}+2\ast\\{cur\_line}-1].\\{sc}$;\6
\&{end};\2\2\6
$\\{adjust\_tail}\K\\{adjust\_head}$;\5
$\\{pre\_adjust\_tail}\K\\{pre\_adjust\_head}$;\6
\&{if} $\\{pdf\_adjust\_spacing}>0$ \1\&{then}\5
$\\{just\_box}\K\\{hpack}(\|q,\39\\{cur\_width},\39\\{cal\_expand\_ratio})$\6
\4\&{else} $\\{just\_box}\K\\{hpack}(\|q,\39\\{cur\_width},\39\\{exactly})$;\2\6
$\\{shift\_amount}(\\{just\_box})\K\\{cur\_indent}$\par
\U1056.\fi

\M1067. Penalties between the lines of a paragraph come from club and widow
lines,
from the \\{inter\_line\_penalty} parameter, and from lines that end at
discretionary breaks.  Breaking between lines of a two-line paragraph gets
both club-line and widow-line penalties. The local variable \\{pen} will
be set to the sum of all relevant penalties for the current line, except
that the final line is never penalized.

\Y\P$\4\X1067:Append a penalty node, if a nonzero penalty is appropriate\X\S$\6
\&{if} $\\{cur\_line}+1\I\\{best\_line}$ \1\&{then}\6
\&{begin} \37$\|q\K\\{inter\_line\_penalties\_ptr}$;\6
\&{if} $\|q\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{cur\_line}$;\6
\&{if} $\|r>\\{penalty}(\|q)$ \1\&{then}\5
$\|r\K\\{penalty}(\|q)$;\2\6
$\\{pen}\K\\{penalty}(\|q+\|r)$;\6
\&{end}\6
\4\&{else} $\\{pen}\K\\{inter\_line\_penalty}$;\2\6
$\|q\K\\{club\_penalties\_ptr}$;\6
\&{if} $\|q\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{cur\_line}-\\{prev\_graf}$;\6
\&{if} $\|r>\\{penalty}(\|q)$ \1\&{then}\5
$\|r\K\\{penalty}(\|q)$;\2\6
$\\{pen}\K\\{pen}+\\{penalty}(\|q+\|r)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_line}=\\{prev\_graf}+1$ \1\&{then}\5
$\\{pen}\K\\{pen}+\\{club\_penalty}$;\2\2\6
\&{if} $\|d$ \1\&{then}\5
$\|q\K\\{display\_widow\_penalties\_ptr}$\6
\4\&{else} $\|q\K\\{widow\_penalties\_ptr}$;\2\6
\&{if} $\|q\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{best\_line}-\\{cur\_line}-1$;\6
\&{if} $\|r>\\{penalty}(\|q)$ \1\&{then}\5
$\|r\K\\{penalty}(\|q)$;\2\6
$\\{pen}\K\\{pen}+\\{penalty}(\|q+\|r)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_line}+2=\\{best\_line}$ \1\&{then}\6
\&{if} $\|d$ \1\&{then}\5
$\\{pen}\K\\{pen}+\\{display\_widow\_penalty}$\6
\4\&{else} $\\{pen}\K\\{pen}+\\{widow\_penalty}$;\2\2\2\6
\&{if} $\\{disc\_break}$ \1\&{then}\5
$\\{pen}\K\\{pen}+\\{broken\_penalty}$;\2\6
\&{if} $\\{pen}\I0$ \1\&{then}\6
\&{begin} \37$\|r\K\\{new\_penalty}(\\{pen})$;\5
$\\{link}(\\{tail})\K\|r$;\5
$\\{tail}\K\|r$;\6
\&{end};\2\6
\&{end}\2\par
\U1056.\fi

\N1068.  \[40] Pre-hyphenation.
When the line-breaking routine is unable to find a feasible sequence of
breakpoints, it makes a second pass over the paragraph, attempting to
hyphenate the hyphenatable words. The goal of hyphenation is to insert
discretionary material into the paragraph so that there are more
potential places to break.

The general rules for hyphenation are somewhat complex and technical,
because we want to be able to hyphenate words that are preceded or
followed by punctuation marks, and because we want the rules to work
for languages other than English. We also must contend with the fact
that hyphens might radically alter the ligature and kerning structure
of a word.

A sequence of characters will be considered for hyphenation only if it
belongs to a ``potentially hyphenatable part'' of the current paragraph.
This is a sequence of nodes $p_0p_1\ldots p_m$ where $p_0$ is a glue node,
$p_1\ldots p_{m-1}$ are either character or ligature or whatsit or
implicit kern or text direction nodes, and $p_m$ is a glue or penalty or
insertion or adjust
or mark or whatsit or explicit kern node.  (Therefore hyphenation is
disabled by boxes, math formulas, and discretionary nodes already inserted
by the user.) The ligature nodes among $p_1\ldots p_{m-1}$ are effectively
expanded into the original non-ligature characters; the kern nodes and
whatsits are ignored. Each character \|c is now classified as either a
nonletter (if $\\{lc\_code}(\|c)=0$), a lowercase letter (if
$\\{lc\_code}(\|c)=\|c$), or an uppercase letter (otherwise); an uppercase
letter
is treated as if it were $\\{lc\_code}(\|c)$ for purposes of hyphenation. The
characters generated by $p_1\ldots p_{m-1}$ may begin with nonletters; let
$c_1$ be the first letter that is not in the middle of a ligature. Whatsit
nodes preceding $c_1$ are ignored; a whatsit found after $c_1$ will be the
terminating node $p_m$. All characters that do not have the same font as
$c_1$ will be treated as nonletters. The \\{hyphen\_char} for that font
must be between 0 and 255, otherwise hyphenation will not be attempted.
\TeX\ looks ahead for as many consecutive letters $c_1\ldots c_n$ as
possible; however, \|n must be less than 64, so a character that would
otherwise be $c_{64}$ is effectively not a letter. Furthermore $c_n$ must
not be in the middle of a ligature.  In this way we obtain a string of
letters $c_1\ldots c_n$ that are generated by nodes $p_a\ldots p_b$, where
$1\L\|a\L\|b+1\L\|m$. If $\|n\G\\{l\_hyf}+\\{r\_hyf}$, this string qualifies
for hyphenation;
however, \\{uc\_hyph} must be positive, if $c_1$ is uppercase.

The hyphenation process takes place in three stages. First, the candidate
sequence $c_1\ldots c_n$ is found; then potential positions for hyphens
are determined by referring to hyphenation tables; and finally, the nodes
$p_a\ldots p_b$ are replaced by a new sequence of nodes that includes the
discretionary breaks found.

Fortunately, we do not have to do all this calculation very often, because
of the way it has been taken out of \TeX's inner loop. For example, when
the second edition of the author's 700-page book {\sl Seminumerical
Algorithms} was typeset by \TeX, only about 1.2 hyphenations needed to be
tried per paragraph, since the line breaking algorithm needed to use two
passes on only about 5 per cent of the paragraphs.

\Y\P$\4\X1068:Initialize for hyphenating a paragraph\X\S$\6
\&{begin} \37\&{init} \37\&{if} $\\{trie\_not\_ready}$ \1\&{then}\5
\\{init\_trie};\ \2\6
\&{tini}\6
$\\{cur\_lang}\K\\{init\_cur\_lang}$;\5
$\\{l\_hyf}\K\\{init\_l\_hyf}$;\5
$\\{r\_hyf}\K\\{init\_r\_hyf}$;\5
\\{set\_hyph\_index};\6
\&{end}\par
\U1039.\fi

\M1069. The letters $c_1\ldots c_n$ that are candidates for hyphenation are
placed
into an array called \\{hc}; the number \|n is placed into \\{hn}; pointers to
nodes $p_{a-1}$ and~$p_b$ in the description above are placed into variables
\\{ha} and \\{hb}; and the font number is placed into \\{hf}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hc}: \37\&{array} $[0\to65]$ \1\&{of}\5
$0\to256$;\C{word to be hyphenated}\2\6
\4\\{hn}: \37$0\to64$;\C{the number of positions occupied in \\{hc};
                       not always a \\{small\_number}}\6
\4$\\{ha},\39\\{hb}$: \37\\{pointer};\C{nodes $\\{ha}\to\\{hb}$ should be
replaced by the hyphenated result}\6
\4\\{hf}: \37\\{internal\_font\_number};\C{font number of the letters in %
\\{hc}}\6
\4\\{hu}: \37\&{array} $[0\to63]$ \1\&{of}\5
$0\to256$;\C{like \\{hc}, before conversion to lowercase}\2\6
\4\\{hyf\_char}: \37\\{integer};\C{hyphen character of the relevant font}\6
\4$\\{cur\_lang},\39\\{init\_cur\_lang}$: \37\\{ASCII\_code};\C{current
hyphenation table of interest}\6
\4$\\{l\_hyf},\39\\{r\_hyf},\39\\{init\_l\_hyf},\39\\{init\_r\_hyf}$: \37%
\\{integer};\C{limits on fragment sizes}\6
\4\\{hyf\_bchar}: \37\\{halfword};\C{boundary character after $c_n$}\par
\fi

\M1070. Hyphenation routines need a few more local variables.

\Y\P$\4\X1038:Local variables for line breaking\X\mathrel{+}\S$\6
\4\|j: \37\\{small\_number};\C{an index into \\{hc} or \\{hu}}\6
\4\|c: \37$0\to255$;\C{character being considered for hyphenation}\par
\fi

\M1071. When the following code is activated, the \\{line\_break} procedure is
in its
second pass, and \\{cur\_p} points to a glue node.

\Y\P$\4\X1071:Try to hyphenate the following word\X\S$\6
\&{begin} \37$\\{prev\_s}\K\\{cur\_p}$;\5
$\|s\K\\{link}(\\{prev\_s})$;\6
\&{if} $\|s\I\\{null}$ \1\&{then}\6
\&{begin} \37\X1073:Skip to node \\{ha}, or \&{goto} \\{done1} if no
hyphenation should be attempted\X;\6
\&{if} $\\{l\_hyf}+\\{r\_hyf}>63$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\X1074:Skip to node \\{hb}, putting letters into \\{hu} and \\{hc}\X;\6
\X1076:Check that the nodes following \\{hb} permit hyphenation and that at
least $\\{l\_hyf}+\\{r\_hyf}$ letters have been found, otherwise \&{goto} %
\\{done1}\X;\6
\\{hyphenate};\6
\&{end};\2\6
\4\\{done1}: \37\&{end}\par
\U1042.\fi

\M1072. \P$\X1002:Declare subprocedures for \\{line\_break}\X\mathrel{+}\S$\6
\hbox{\4}\X1083:Declare the function called \\{reconstitute}\X \6
\4\&{procedure}\1\  \37\\{hyphenate};\6
\4\&{label} \37$\\{common\_ending},\39\\{done},\39\\{found},\39\\{found1},\39%
\\{found2},\39\\{not\_found},\39\\{exit}$;\6
\4\&{var} \37\X1078:Local variables for hyphenation\X\2\6
\&{begin} \37\X1100:Find hyphen locations for the word in \\{hc}, or \&{return}%
\X;\6
\X1079:If no hyphens were found, \&{return}\X;\6
\X1080:Replace nodes $\\{ha}\to\\{hb}$ by a sequence of nodes that includes the
discretionary hyphens\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1073. The first thing we need to do is find the node \\{ha} just before the
first letter.

\Y\P$\4\X1073:Skip to node \\{ha}, or \&{goto} \\{done1} if no hyphenation
should be attempted\X\S$\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\6
\&{begin} \37$\|c\K\\{qo}(\\{character}(\|s))$;\5
$\\{hf}\K\\{font}(\|s)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\|s)=\\{ligature\_node}$ \1\&{then}\6
\&{if} $\\{lig\_ptr}(\|s)=\\{null}$ \1\&{then}\5
\&{goto} \37\\{continue}\6
\4\&{else} \&{begin} \37$\|q\K\\{lig\_ptr}(\|s)$;\5
$\|c\K\\{qo}(\\{character}(\|q))$;\5
$\\{hf}\K\\{font}(\|q)$;\6
\&{end}\2\6
\4\&{else} \&{if} $(\\{type}(\|s)=\\{kern\_node})\W(\\{subtype}(\|s)=%
\\{normal})$ \1\&{then}\5
\&{goto} \37\\{continue}\6
\4\&{else} \&{if} $(\\{type}(\|s)=\\{math\_node})\W(\\{subtype}(\|s)\G\\{L%
\_code})$ \1\&{then}\5
\&{goto} \37\\{continue}\6
\4\&{else} \&{if} $\\{type}(\|s)=\\{whatsit\_node}$ \1\&{then}\6
\&{begin} \37\X1610:Advance \(p)past a whatsit node in the \(p)pre-hyphenation
loop\X;\6
\&{goto} \37\\{continue};\6
\&{end}\6
\4\&{else} \&{goto} \37\\{done1};\2\2\2\2\2\6
$\\{set\_lc\_code}(\|c)$;\6
\&{if} $\\{hc}[0]\I0$ \1\&{then}\6
\&{if} $(\\{hc}[0]=\|c)\V(\\{uc\_hyph}>0)$ \1\&{then}\5
\&{goto} \37\\{done2}\6
\4\&{else} \&{goto} \37\\{done1};\2\2\6
\4\\{continue}: \37$\\{prev\_s}\K\|s$;\5
$\|s\K\\{link}(\\{prev\_s})$;\6
\&{end};\2\6
\4\\{done2}: \37$\\{hyf\_char}\K\\{hyphen\_char}[\\{hf}]$;\6
\&{if} $\\{hyf\_char}<0$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
\&{if} $\\{hyf\_char}>255$ \1\&{then}\5
\&{goto} \37\\{done1};\2\6
$\\{ha}\K\\{prev\_s}$\par
\U1071.\fi

\M1074. The word to be hyphenated is now moved to the \\{hu} and \\{hc} arrays.

\Y\P$\4\X1074:Skip to node \\{hb}, putting letters into \\{hu} and \\{hc}\X\S$\6
$\\{hn}\K0$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{is\_char\_node}(\|s)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{font}(\|s)\I\\{hf}$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
$\\{hyf\_bchar}\K\\{character}(\|s)$;\5
$\|c\K\\{qo}(\\{hyf\_bchar})$;\5
$\\{set\_lc\_code}(\|c)$;\6
\&{if} $\\{hc}[0]=0$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
\&{if} $\\{hn}=63$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
$\\{hb}\K\|s$;\5
$\\{incr}(\\{hn})$;\5
$\\{hu}[\\{hn}]\K\|c$;\5
$\\{hc}[\\{hn}]\K\\{hc}[0]$;\5
$\\{hyf\_bchar}\K\\{non\_char}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\|s)=\\{ligature\_node}$ \1\&{then}\5
\X1075:Move the characters of a ligature node to \\{hu} and \\{hc}; but %
\&{goto} \\{done3} if they are not all letters\X\6
\4\&{else} \&{if} $(\\{type}(\|s)=\\{kern\_node})\W(\\{subtype}(\|s)=%
\\{normal})$ \1\&{then}\6
\&{begin} \37$\\{hb}\K\|s$;\5
$\\{hyf\_bchar}\K\\{font\_bchar}[\\{hf}]$;\6
\&{end}\6
\4\&{else} \&{goto} \37\\{done3};\2\2\2\6
$\|s\K\\{link}(\|s)$;\6
\&{end};\2\6
\4\\{done3}: \37\par
\U1071.\fi

\M1075. We let \|j be the index of the character being stored when a ligature
node
is being expanded, since we do not want to advance \\{hn} until we are sure
that the entire ligature consists of letters. Note that it is possible
to get to \\{done3} with $\\{hn}=0$ and \\{hb} not set to any value.

\Y\P$\4\X1075:Move the characters of a ligature node to \\{hu} and \\{hc}; but %
\&{goto} \\{done3} if they are not all letters\X\S$\6
\&{begin} \37\&{if} $\\{font}(\\{lig\_char}(\|s))\I\\{hf}$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
$\|j\K\\{hn}$;\5
$\|q\K\\{lig\_ptr}(\|s)$;\ \&{if} $\|q>\\{null}$ \1\&{then}\5
$\\{hyf\_bchar}\K\\{character}(\|q)$;\2\6
\&{while} $\|q>\\{null}$ \1\&{do}\6
\&{begin} \37$\|c\K\\{qo}(\\{character}(\|q))$;\5
$\\{set\_lc\_code}(\|c)$;\6
\&{if} $\\{hc}[0]=0$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
\&{if} $\|j=63$ \1\&{then}\5
\&{goto} \37\\{done3};\2\6
$\\{incr}(\|j)$;\5
$\\{hu}[\|j]\K\|c$;\5
$\\{hc}[\|j]\K\\{hc}[0]$;\6
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\6
$\\{hb}\K\|s$;\5
$\\{hn}\K\|j$;\6
\&{if} $\\{odd}(\\{subtype}(\|s))$ \1\&{then}\5
$\\{hyf\_bchar}\K\\{font\_bchar}[\\{hf}]$\ \&{else} $\\{hyf\_bchar}\K\\{non%
\_char}$;\2\6
\&{end}\par
\U1074.\fi

\M1076. \P$\X1076:Check that the nodes following \\{hb} permit hyphenation and
that at least $\\{l\_hyf}+\\{r\_hyf}$ letters have been found, otherwise %
\&{goto} \\{done1}\X\S$\6
\&{if} $\\{hn}<\\{l\_hyf}+\\{r\_hyf}$ \1\&{then}\5
\&{goto} \37\\{done1};\C{\\{l\_hyf} and \\{r\_hyf} are $\G1$}\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\R(\\{is\_char\_node}(\|s))$ \1\&{then}\6
\&{case} $\\{type}(\|s)$ \1\&{of}\6
\4\\{ligature\_node}: \37\\{do\_nothing};\6
\4\\{kern\_node}: \37\&{if} $\\{subtype}(\|s)\I\\{normal}$ \1\&{then}\5
\&{goto} \37\\{done4};\2\6
\4$\\{whatsit\_node},\39\\{glue\_node},\39\\{penalty\_node},\39\\{ins\_node},%
\39\\{adjust\_node},\39\\{mark\_node}$: \37\&{goto} \37\\{done4};\6
\4\\{math\_node}: \37\&{if} $\\{subtype}(\|s)\G\\{L\_code}$ \1\&{then}\5
\&{goto} \37\\{done4}\ \&{else} \&{goto} \37\\{done1};\2\6
\4\&{othercases} \37\&{goto} \37\\{done1}\2\6
\&{endcases};\2\6
$\|s\K\\{link}(\|s)$;\6
\&{end};\2\6
\4\\{done4}: \37\par
\U1071.\fi

\N1077.  \[41] Post-hyphenation.
If a hyphen may be inserted between $\\{hc}[\|j]$ and $\\{hc}[\|j+1]$, the
hyphenation
procedure will set $\\{hyf}[\|j]$ to some small odd number. But before we look
at \TeX's hyphenation procedure, which is independent of the rest of the
line-breaking algorithm, let us consider what we will do with the hyphens
it finds, since it is better to work on this part of the program before
forgetting what \\{ha} and \\{hb}, etc., are all about.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hyf}: \37\&{array} $[0\to64]$ \1\&{of}\5
$0\to9$;\C{odd values indicate discretionary hyphens}\2\6
\4\\{init\_list}: \37\\{pointer};\C{list of punctuation characters preceding
the word}\6
\4\\{init\_lig}: \37\\{boolean};\C{does \\{init\_list} represent a ligature?}\6
\4\\{init\_lft}: \37\\{boolean};\C{if so, did the ligature involve a left
boundary?}\par
\fi

\M1078. \P$\X1078:Local variables for hyphenation\X\S$\6
\4$\|i,\39\|j,\39\|l$: \37$0\to65$;\C{indices into \\{hc} or \\{hu}}\6
\4$\|q,\39\|r,\39\|s$: \37\\{pointer};\C{temporary registers for list
manipulation}\6
\4\\{bchar}: \37\\{halfword};\C{boundary character of hyphenated word, or %
\\{non\_char}}\par
\As1089, 1099\ETs1106.
\U1072.\fi

\M1079. \TeX\ will never insert a hyphen that has fewer than
\.{\\lefthyphenmin} letters before it or fewer than
\.{\\righthyphenmin} after it; hence, a short word has
comparatively little chance of being hyphenated. If no hyphens have
been found, we can save time by not having to make any changes to the
paragraph.

\Y\P$\4\X1079:If no hyphens were found, \&{return}\X\S$\6
\&{for} $\|j\K\\{l\_hyf}\mathrel{\&{to}}\\{hn}-\\{r\_hyf}$ \1\&{do}\6
\&{if} $\\{odd}(\\{hyf}[\|j])$ \1\&{then}\5
\&{goto} \37\\{found1};\2\2\6
\&{return};\6
\4\\{found1}: \37\par
\U1072.\fi

\M1080. If hyphens are in fact going to be inserted, \TeX\ first deletes the
subsequence of nodes between \\{ha} and~\\{hb}. An attempt is made to
preserve the effect that implicit boundary characters and punctuation marks
had on ligatures inside the hyphenated word, by storing a left boundary or
preceding character in $\\{hu}[0]$ and by storing a possible right boundary
in \\{bchar}. We set $\|j\K0$ if $\\{hu}[0]$ is to be part of the
reconstruction;
otherwise $\|j\K1$.
The variable \|s will point to the tail of the current hlist, and
\|q will point to the node following \\{hb}, so that
things can be hooked up after we reconstitute the hyphenated word.

\Y\P$\4\X1080:Replace nodes $\\{ha}\to\\{hb}$ by a sequence of nodes that
includes the discretionary hyphens\X\S$\6
$\|q\K\\{link}(\\{hb})$;\5
$\\{link}(\\{hb})\K\\{null}$;\5
$\|r\K\\{link}(\\{ha})$;\5
$\\{link}(\\{ha})\K\\{null}$;\5
$\\{bchar}\K\\{hyf\_bchar}$;\6
\&{if} $\\{is\_char\_node}(\\{ha})$ \1\&{then}\6
\&{if} $\\{font}(\\{ha})\I\\{hf}$ \1\&{then}\5
\&{goto} \37\\{found2}\6
\4\&{else} \&{begin} \37$\\{init\_list}\K\\{ha}$;\5
$\\{init\_lig}\K\\{false}$;\5
$\\{hu}[0]\K\\{qo}(\\{character}(\\{ha}))$;\6
\&{end}\2\6
\4\&{else} \&{if} $\\{type}(\\{ha})=\\{ligature\_node}$ \1\&{then}\6
\&{if} $\\{font}(\\{lig\_char}(\\{ha}))\I\\{hf}$ \1\&{then}\5
\&{goto} \37\\{found2}\6
\4\&{else} \&{begin} \37$\\{init\_list}\K\\{lig\_ptr}(\\{ha})$;\5
$\\{init\_lig}\K\\{true}$;\5
$\\{init\_lft}\K(\\{subtype}(\\{ha})>1)$;\5
$\\{hu}[0]\K\\{qo}(\\{character}(\\{lig\_char}(\\{ha})))$;\6
\&{if} $\\{init\_list}=\\{null}$ \1\&{then}\6
\&{if} $\\{init\_lft}$ \1\&{then}\6
\&{begin} \37$\\{hu}[0]\K256$;\5
$\\{init\_lig}\K\\{false}$;\6
\&{end};\C{in this case a ligature will be reconstructed from scratch}\2\2\6
$\\{free\_node}(\\{ha},\39\\{small\_node\_size})$;\6
\&{end}\2\6
\4\&{else} \&{begin} \37\C{no punctuation found; look for left boundary}\6
\&{if} $\R\\{is\_char\_node}(\|r)$ \1\&{then}\6
\&{if} $\\{type}(\|r)=\\{ligature\_node}$ \1\&{then}\6
\&{if} $\\{subtype}(\|r)>1$ \1\&{then}\5
\&{goto} \37\\{found2};\2\2\2\6
$\|j\K1$;\5
$\|s\K\\{ha}$;\5
$\\{init\_list}\K\\{null}$;\5
\&{goto} \37\\{common\_ending};\6
\&{end};\2\2\6
$\|s\K\\{cur\_p}$;\C{we have $\\{cur\_p}\I\\{ha}$ because $\\{type}(\\{cur%
\_p})=\\{glue\_node}$}\6
\&{while} $\\{link}(\|s)\I\\{ha}$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
$\|j\K0$;\5
\&{goto} \37\\{common\_ending};\6
\4\\{found2}: \37$\|s\K\\{ha}$;\5
$\|j\K0$;\5
$\\{hu}[0]\K256$;\5
$\\{init\_lig}\K\\{false}$;\5
$\\{init\_list}\K\\{null}$;\6
\4\\{common\_ending}: \37$\\{flush\_node\_list}(\|r)$;\5
\X1090:Reconstitute nodes for the hyphenated word, inserting discretionary
hyphens\X;\6
$\\{flush\_list}(\\{init\_list})$\par
\U1072.\fi

\M1081. We must now face the fact that the battle is not over, even though the
{\def\!{\kern-1pt}%
hyphens have been found: The process of reconstituting a word can be nontrivial
because ligatures might change when a hyphen is present. {\sl The \TeX book\/}
discusses the difficulties of the word ``difficult'', and
the discretionary material surrounding a
hyphen can be considerably more complex than that. Suppose
\.{abcdef} is a word in a font for which the only ligatures are \.{b\!c},
\.{c\!d}, \.{d\!e}, and \.{e\!f}. If this word permits hyphenation
between \.b and \.c, the two patterns with and without hyphenation are
$\.a\,\.b\,\.-\,\.{c\!d}\,\.{e\!f}$ and $\.a\,\.{b\!c}\,\.{d\!e}\,\.f$.
Thus the insertion of a hyphen might cause effects to ripple arbitrarily
far into the rest of the word. A further complication arises if additional
hyphens appear together with such rippling, e.g., if the word in the
example just given could also be hyphenated between \.c and \.d; \TeX\
avoids this by simply ignoring the additional hyphens in such weird cases.}

Still further complications arise in the presence of ligatures that do not
delete the original characters. When punctuation precedes the word being
hyphenated, \TeX's method is not perfect under all possible scenarios,
because punctuation marks and letters can propagate information back and forth.
For example, suppose the original pre-hyphenation pair
\.{*a} changes to \.{*y} via a \.{\?=:} ligature, which changes to \.{xy}
via a \.{=:\?} ligature; if $p_{a-1}=\.x$ and $p_a=\.y$, the reconstitution
procedure isn't smart enough to obtain \.{xy} again. In such cases the
font designer should include a ligature that goes from \.{xa} to \.{xy}.

\fi

\M1082. The processing is facilitated by a subroutine called \\{reconstitute}.
Given
a string of characters $x_j\ldots x_n$, there is a smallest index $m\ge j$
such that the ``translation'' of $x_j\ldots x_n$ by ligatures and kerning
has the form $y_1\ldots y_t$ followed by the translation of $x_{m+1}\ldots
x_n$,
where $y_1\ldots y_t$ is some nonempty sequence of character, ligature, and
kern nodes. We call $x_j\ldots x_m$ a ``cut prefix'' of $x_j\ldots x_n$.
For example, if $x_1x_2x_3=\.{fly}$, and if the font contains `fl' as a
ligature and a kern between `fl' and `y', then $m=2$, $t=2$, and $y_1$ will
be a ligature node for `fl' followed by an appropriate kern node~$y_2$.
In the most common case, $x_j$~forms no ligature with $x_{j+1}$ and we
simply have $m=j$, $y_1=x_j$. If $m<n$ we can repeat the procedure on
$x_{m+1}\ldots x_n$ until the entire translation has been found.

The \\{reconstitute} function returns the integer $m$ and puts the nodes
$y_1\ldots y_t$ into a linked list starting at $\\{link}(\\{hold\_head})$,
getting the input $x_j\ldots x_n$ from the \\{hu} array. If $x_j=256$,
we consider $x_j$ to be an implicit left boundary character; in this
case \|j must be strictly less than~\|n. There is a
parameter \\{bchar}, which is either 256 or an implicit right boundary
character
assumed to be present just following~$x_n$. (The value $\\{hu}[\|n+1]$ is never
explicitly examined, but the algorithm imagines that \\{bchar} is there.)

If there exists an index \|k in the range $j\le k\le m$ such that $\\{hyf}[%
\|k]$
is odd and such that the result of \\{reconstitute} would have been different
if $x_{k+1}$ had been \\{hchar}, then \\{reconstitute} sets \\{hyphen\_passed}
to the smallest such~\|k. Otherwise it sets \\{hyphen\_passed} to zero.

A special convention is used in the case $\|j=0$: Then we assume that the
translation of $\\{hu}[0]$ appears in a special list of charnodes starting at
\\{init\_list}; moreover, if \\{init\_lig} is \\{true}, then $\\{hu}[0]$ will
be
a ligature character, involving a left boundary if \\{init\_lft} is \\{true}.
This facility is provided for cases when a hyphenated
word is preceded by punctuation (like single or double quotes) that might
affect the translation of the beginning of the word.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hyphen\_passed}: \37\\{small\_number};\C{first hyphen in a ligature, if
any}\par
\fi

\M1083. \P$\X1083:Declare the function called \\{reconstitute}\X\S$\6
\4\&{function}\1\  \37$\\{reconstitute}(\|j,\39\|n:\\{small\_number};\,\35%
\\{bchar},\39\\{hchar}:\\{halfword})$: \37\\{small\_number};\6
\4\&{label} \37$\\{continue},\39\\{done}$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{temporary register for list manipulation}\6
\|t: \37\\{pointer};\C{a node being appended to}\6
\|q: \37\\{four\_quarters};\C{character information or a lig/kern instruction}\6
\\{cur\_rh}: \37\\{halfword};\C{hyphen character for ligature testing}\6
\\{test\_char}: \37\\{halfword};\C{hyphen or other character for ligature
testing}\6
\|w: \37\\{scaled};\C{amount of kerning}\6
\|k: \37\\{font\_index};\C{position of current lig/kern instruction}\2\6
\&{begin} \37$\\{hyphen\_passed}\K0$;\5
$\|t\K\\{hold\_head}$;\5
$\|w\K0$;\5
$\\{link}(\\{hold\_head})\K\\{null}$;\C{at this point $\\{ligature\_present}=%
\\{lft\_hit}=\\{rt\_hit}=\\{false}$}\6
\X1085:Set up data structures with the cursor following position \|j\X;\6
\4\\{continue}: \37\X1086:If there's a ligature or kern at the cursor position,
update the data structures, possibly advancing~\|j; continue until the cursor
moves\X;\6
\X1087:Append a ligature and/or kern to the translation; \&{goto} \\{continue}
if the stack of inserted ligatures is nonempty\X;\6
$\\{reconstitute}\K\|j$;\6
\&{end};\par
\U1072.\fi

\M1084. The reconstitution procedure shares many of the global data structures
by which \TeX\ has processed the words before they were hyphenated.
There is an implied ``cursor'' between characters \\{cur\_l} and \\{cur\_r};
these characters will be tested for possible ligature activity. If
\\{ligature\_present} then \\{cur\_l} is a ligature character formed from the
original characters following \\{cur\_q} in the current translation list.
There is a ``ligature stack'' between the cursor and character $\|j+1$,
consisting of pseudo-ligature nodes linked together by their \\{link} fields.
This stack is normally empty unless a ligature command has created a new
character that will need to be processed later. A pseudo-ligature is
a special node having a \\{character} field that represents a potential
ligature and a \\{lig\_ptr} field that points to a \\{char\_node} or is %
\\{null}.
We have
$$\\{cur\_r}=\cases{$\\{character}(\\{lig\_stack})$,&if $\\{lig\_stack}>%
\\{null}$;\cr
$\\{qi}(\\{hu}[\|j+1])$,&if $\\{lig\_stack}=\\{null}$ and $\|j<\|n$;\cr
bchar,&if $\\{lig\_stack}=\\{null}$ and $\|j=\|n$.\cr}$$

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4$\\{cur\_l},\39\\{cur\_r}$: \37\\{halfword};\C{characters before and after
the cursor}\6
\4\\{cur\_q}: \37\\{pointer};\C{where a ligature should be detached}\6
\4\\{lig\_stack}: \37\\{pointer};\C{unfinished business to the right of the
cursor}\6
\4\\{ligature\_present}: \37\\{boolean};\C{should a ligature node be made for %
\\{cur\_l}?}\6
\4$\\{lft\_hit},\39\\{rt\_hit}$: \37\\{boolean};\C{did we hit a ligature with a
boundary character?}\par
\fi

\M1085. \P\D \37$\\{append\_charnode\_to\_t}(\#)\S$\1\6
\&{begin} \37$\\{link}(\|t)\K\\{get\_avail}$;\5
$\|t\K\\{link}(\|t)$;\5
$\\{font}(\|t)\K\\{hf}$;\5
$\\{character}(\|t)\K\#$;\6
\&{end}\2\par
\P\D \37$\\{set\_cur\_r}\S$\1\6
\&{begin} \37\&{if} $\|j<\|n$ \1\&{then}\5
$\\{cur\_r}\K\\{qi}(\\{hu}[\|j+1])$\ \&{else} $\\{cur\_r}\K\\{bchar}$;\2\6
\&{if} $\\{odd}(\\{hyf}[\|j])$ \1\&{then}\5
$\\{cur\_rh}\K\\{hchar}$\ \&{else} $\\{cur\_rh}\K\\{non\_char}$;\2\6
\&{end}\2\par
\Y\P$\4\X1085:Set up data structures with the cursor following position \|j\X%
\S$\6
$\\{cur\_l}\K\\{qi}(\\{hu}[\|j])$;\5
$\\{cur\_q}\K\|t$;\6
\&{if} $\|j=0$ \1\&{then}\6
\&{begin} \37$\\{ligature\_present}\K\\{init\_lig}$;\5
$\|p\K\\{init\_list}$;\6
\&{if} $\\{ligature\_present}$ \1\&{then}\5
$\\{lft\_hit}\K\\{init\_lft}$;\2\6
\&{while} $\|p>\\{null}$ \1\&{do}\6
\&{begin} \37$\\{append\_charnode\_to\_t}(\\{character}(\|p))$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_l}<\\{non\_char}$ \1\&{then}\5
$\\{append\_charnode\_to\_t}(\\{cur\_l})$;\2\2\6
$\\{lig\_stack}\K\\{null}$;\5
\\{set\_cur\_r}\par
\U1083.\fi

\M1086. We may want to look at the lig/kern program twice, once for a hyphen
and once for a normal letter. (The hyphen might appear after the letter
in the program, so we'd better not try to look for both at once.)

\Y\P$\4\X1086:If there's a ligature or kern at the cursor position, update the
data structures, possibly advancing~\|j; continue until the cursor moves\X\S$\6
\&{if} $\\{cur\_l}=\\{non\_char}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{bchar\_label}[\\{hf}]$;\6
\&{if} $\|k=\\{non\_address}$ \1\&{then}\5
\&{goto} \37\\{done}\ \&{else} $\|q\K\\{font\_info}[\|k].\\{qqqq}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{char\_info}(\\{hf})(\\{cur\_l})$;\6
\&{if} $\\{char\_tag}(\|q)\I\\{lig\_tag}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|k\K\\{lig\_kern\_start}(\\{hf})(\|q)$;\5
$\|q\K\\{font\_info}[\|k].\\{qqqq}$;\6
\&{if} $\\{skip\_byte}(\|q)>\\{stop\_flag}$ \1\&{then}\6
\&{begin} \37$\|k\K\\{lig\_kern\_restart}(\\{hf})(\|q)$;\5
$\|q\K\\{font\_info}[\|k].\\{qqqq}$;\6
\&{end};\2\6
\&{end};\C{now \|k is the starting address of the lig/kern program}\2\6
\&{if} $\\{cur\_rh}<\\{non\_char}$ \1\&{then}\5
$\\{test\_char}\K\\{cur\_rh}$\ \&{else} $\\{test\_char}\K\\{cur\_r}$;\2\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{next\_char}(\|q)=\\{test\_char}$ \1%
\&{then}\6
\&{if} $\\{skip\_byte}(\|q)\L\\{stop\_flag}$ \1\&{then}\6
\&{if} $\\{cur\_rh}<\\{non\_char}$ \1\&{then}\6
\&{begin} \37$\\{hyphen\_passed}\K\|j$;\5
$\\{hchar}\K\\{non\_char}$;\5
$\\{cur\_rh}\K\\{non\_char}$;\5
\&{goto} \37\\{continue};\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{hchar}<\\{non\_char}$ \1\&{then}\6
\&{if} $\\{odd}(\\{hyf}[\|j])$ \1\&{then}\6
\&{begin} \37$\\{hyphen\_passed}\K\|j$;\5
$\\{hchar}\K\\{non\_char}$;\6
\&{end};\2\2\6
\&{if} $\\{op\_byte}(\|q)<\\{kern\_flag}$ \1\&{then}\5
\X1088:Carry out a ligature replacement, updating the cursor structure and
possibly advancing~\|j; \&{goto} \\{continue} if the cursor doesn't advance,
otherwise \&{goto} \\{done}\X;\2\6
$\|w\K\\{char\_kern}(\\{hf})(\|q)$;\5
\&{goto} \37\\{done};\C{this kern will be inserted below}\6
\&{end};\2\2\2\6
\&{if} $\\{skip\_byte}(\|q)\G\\{stop\_flag}$ \1\&{then}\6
\&{if} $\\{cur\_rh}=\\{non\_char}$ \1\&{then}\5
\&{goto} \37\\{done}\6
\4\&{else} \&{begin} \37$\\{cur\_rh}\K\\{non\_char}$;\5
\&{goto} \37\\{continue};\6
\&{end};\2\2\6
$\|k\K\|k+\\{qo}(\\{skip\_byte}(\|q))+1$;\5
$\|q\K\\{font\_info}[\|k].\\{qqqq}$;\6
\&{end};\2\6
\4\\{done}: \37\par
\U1083.\fi

\M1087. \P\D \37$\\{wrap\_lig}(\#)\S$\1\6
\&{if} $\\{ligature\_present}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{new\_ligature}(\\{hf},\39\\{cur\_l},\39\\{link}(\\{cur%
\_q}))$;\6
\&{if} $\\{lft\_hit}$ \1\&{then}\6
\&{begin} \37$\\{subtype}(\|p)\K2$;\5
$\\{lft\_hit}\K\\{false}$;\6
\&{end};\2\6
\&{if} $\#$ \1\&{then}\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{incr}(\\{subtype}(\|p))$;\5
$\\{rt\_hit}\K\\{false}$;\6
\&{end};\2\2\6
$\\{link}(\\{cur\_q})\K\|p$;\5
$\|t\K\|p$;\5
$\\{ligature\_present}\K\\{false}$;\6
\&{end}\2\2\par
\P\D \37$\\{pop\_lig\_stack}\S$\1\6
\&{begin} \37\&{if} $\\{lig\_ptr}(\\{lig\_stack})>\\{null}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|t)\K\\{lig\_ptr}(\\{lig\_stack})$;\C{this is a
charnode for $\\{hu}[\|j+1]$}\6
$\|t\K\\{link}(\|t)$;\5
$\\{incr}(\|j)$;\6
\&{end};\2\6
$\|p\K\\{lig\_stack}$;\5
$\\{lig\_stack}\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\5
\\{set\_cur\_r}\ \&{else} $\\{cur\_r}\K\\{character}(\\{lig\_stack})$;\2\6
\&{end}\C{if \\{lig\_stack} isn't \\{null} we have $\\{cur\_rh}=\\{non\_char}$}%
\2\par
\Y\P$\4\X1087:Append a ligature and/or kern to the translation; \&{goto} %
\\{continue} if the stack of inserted ligatures is nonempty\X\S$\6
$\\{wrap\_lig}(\\{rt\_hit})$;\6
\&{if} $\|w\I0$ \1\&{then}\6
\&{begin} \37$\\{link}(\|t)\K\\{new\_kern}(\|w)$;\5
$\|t\K\\{link}(\|t)$;\5
$\|w\K0$;\6
\&{end};\2\6
\&{if} $\\{lig\_stack}>\\{null}$ \1\&{then}\6
\&{begin} \37$\\{cur\_q}\K\|t$;\5
$\\{cur\_l}\K\\{character}(\\{lig\_stack})$;\5
$\\{ligature\_present}\K\\{true}$;\5
\\{pop\_lig\_stack};\5
\&{goto} \37\\{continue};\6
\&{end}\2\par
\U1083.\fi

\M1088. \P$\X1088:Carry out a ligature replacement, updating the cursor
structure and possibly advancing~\|j; \&{goto} \\{continue} if the cursor
doesn't advance, otherwise \&{goto} \\{done}\X\S$\6
\&{begin} \37\&{if} $\\{cur\_l}=\\{non\_char}$ \1\&{then}\5
$\\{lft\_hit}\K\\{true}$;\2\6
\&{if} $\|j=\|n$ \1\&{then}\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\5
$\\{rt\_hit}\K\\{true}$;\2\2\6
\\{check\_interrupt};\C{allow a way out in case there's an infinite ligature
loop}\6
\&{case} $\\{op\_byte}(\|q)$ \1\&{of}\6
\4$\\{qi}(1),\39\\{qi}(5)$: \37\&{begin} \37$\\{cur\_l}\K\\{rem\_byte}(\|q)$;%
\C{\.{=:\?}, \.{=:\?>}}\6
$\\{ligature\_present}\K\\{true}$;\6
\&{end};\6
\4$\\{qi}(2),\39\\{qi}(6)$: \37\&{begin} \37$\\{cur\_r}\K\\{rem\_byte}(\|q)$;%
\C{\.{\?=:}, \.{\?=:>}}\6
\&{if} $\\{lig\_stack}>\\{null}$ \1\&{then}\5
$\\{character}(\\{lig\_stack})\K\\{cur\_r}$\6
\4\&{else} \&{begin} \37$\\{lig\_stack}\K\\{new\_lig\_item}(\\{cur\_r})$;\6
\&{if} $\|j=\|n$ \1\&{then}\5
$\\{bchar}\K\\{non\_char}$\6
\4\&{else} \&{begin} \37$\|p\K\\{get\_avail}$;\5
$\\{lig\_ptr}(\\{lig\_stack})\K\|p$;\5
$\\{character}(\|p)\K\\{qi}(\\{hu}[\|j+1])$;\5
$\\{font}(\|p)\K\\{hf}$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\6
\4$\\{qi}(3)$: \37\&{begin} \37$\\{cur\_r}\K\\{rem\_byte}(\|q)$;\C{\.{\?=:\?}}\6
$\|p\K\\{lig\_stack}$;\5
$\\{lig\_stack}\K\\{new\_lig\_item}(\\{cur\_r})$;\5
$\\{link}(\\{lig\_stack})\K\|p$;\6
\&{end};\6
\4$\\{qi}(7),\39\\{qi}(11)$: \37\&{begin} \37$\\{wrap\_lig}(\\{false})$;\C{\.{%
\?=:\?>}, \.{\?=:\?>>}}\6
$\\{cur\_q}\K\|t$;\5
$\\{cur\_l}\K\\{rem\_byte}(\|q)$;\5
$\\{ligature\_present}\K\\{true}$;\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37$\\{cur\_l}\K\\{rem\_byte}(\|q)$;\5
$\\{ligature\_present}\K\\{true}$;\C{\.{=:}}\6
\&{if} $\\{lig\_stack}>\\{null}$ \1\&{then}\5
\\{pop\_lig\_stack}\6
\4\&{else} \&{if} $\|j=\|n$ \1\&{then}\5
\&{goto} \37\\{done}\6
\4\&{else} \&{begin} \37$\\{append\_charnode\_to\_t}(\\{cur\_r})$;\5
$\\{incr}(\|j)$;\5
\\{set\_cur\_r};\6
\&{end};\2\2\6
\&{end}\2\6
\&{endcases};\6
\&{if} $\\{op\_byte}(\|q)>\\{qi}(4)$ \1\&{then}\6
\&{if} $\\{op\_byte}(\|q)\I\\{qi}(7)$ \1\&{then}\5
\&{goto} \37\\{done};\2\2\6
\&{goto} \37\\{continue};\6
\&{end}\par
\U1086.\fi

\M1089. Okay, we're ready to insert the potential hyphenations that were found.
When the following program is executed, we want to append the word
$\\{hu}[1\to\\{hn}]$ after node \\{ha}, and node \|q should be appended to the
result.
During this process, the variable \|i will be a temporary
index into \\{hu}; the variable \|j will be an index to our current position
in \\{hu}; the variable \|l will be the counterpart of \|j, in a discretionary
branch; the variable \|r will point to new nodes being created; and
we need a few new local variables:

\Y\P$\4\X1078:Local variables for hyphenation\X\mathrel{+}\S$\6
\4$\\{major\_tail},\39\\{minor\_tail}$: \37\\{pointer};\C{the end of lists in
the main and   discretionary branches being reconstructed}\6
\4\|c: \37\\{ASCII\_code};\C{character temporarily replaced by a hyphen}\6
\4\\{c\_loc}: \37$0\to63$;\C{where that character came from}\6
\4\\{r\_count}: \37\\{integer};\C{replacement count for discretionary}\6
\4\\{hyf\_node}: \37\\{pointer};\C{the hyphen, if it exists}\par
\fi

\M1090. When the following code is performed, $\\{hyf}[0]$ and $\\{hyf}[%
\\{hn}]$ will be zero.

\Y\P$\4\X1090:Reconstitute nodes for the hyphenated word, inserting
discretionary hyphens\X\S$\6
\1\&{repeat} \37$\|l\K\|j$;\5
$\|j\K\\{reconstitute}(\|j,\39\\{hn},\39\\{bchar},\39\\{qi}(\\{hyf\_char}))+1$;%
\6
\&{if} $\\{hyphen\_passed}=0$ \1\&{then}\6
\&{begin} \37$\\{link}(\|s)\K\\{link}(\\{hold\_head})$;\6
\&{while} $\\{link}(\|s)>\\{null}$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
\&{if} $\\{odd}(\\{hyf}[\|j-1])$ \1\&{then}\6
\&{begin} \37$\|l\K\|j$;\5
$\\{hyphen\_passed}\K\|j-1$;\5
$\\{link}(\\{hold\_head})\K\\{null}$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{hyphen\_passed}>0$ \1\&{then}\5
\X1091:Create and append a discretionary node as an alternative to the
unhyphenated word, and continue to develop both branches until they become
equivalent\X;\2\6
\4\&{until}\5
$\|j>\\{hn}$;\2\6
$\\{link}(\|s)\K\|q$\par
\U1080.\fi

\M1091. In this repeat loop we will insert another discretionary if $\\{hyf}[%
\|j-1]$ is
odd, when both branches of the previous discretionary end at position $\|j-1$.
Strictly speaking, we aren't justified in doing this, because we don't know
that a hyphen after $\|j-1$ is truly independent of those branches. But in
almost
all applications we would rather not lose a potentially valuable hyphenation
point. (Consider the word `difficult', where the letter `c' is in position %
\|j.)

\Y\P\D \37$\\{advance\_major\_tail}\S$\1\6
\&{begin} \37$\\{major\_tail}\K\\{link}(\\{major\_tail})$;\5
$\\{incr}(\\{r\_count})$;\6
\&{end}\2\par
\Y\P$\4\X1091:Create and append a discretionary node as an alternative to the
unhyphenated word, and continue to develop both branches until they become
equivalent\X\S$\6
\1\&{repeat} \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{link}(\|r)\K\\{link}(\\{hold\_head})$;\5
$\\{type}(\|r)\K\\{disc\_node}$;\5
$\\{major\_tail}\K\|r$;\5
$\\{r\_count}\K0$;\6
\&{while} $\\{link}(\\{major\_tail})>\\{null}$ \1\&{do}\5
\\{advance\_major\_tail};\2\6
$\|i\K\\{hyphen\_passed}$;\5
$\\{hyf}[\|i]\K0$;\5
\X1092:Put the \(c)characters $\\{hu}[\|l\to\|i]$ and a hyphen into $\\{pre%
\_break}(\|r)$\X;\6
\X1093:Put the \(c)characters $\\{hu}[\|i+1\to\,]$ into $\\{post\_break}(\|r)$,
appending to this list and to \\{major\_tail} until synchronization has been
achieved\X;\6
\X1095:Move pointer \|s to the end of the current list, and set $\\{replace%
\_count}(\|r)$ appropriately\X;\6
$\\{hyphen\_passed}\K\|j-1$;\5
$\\{link}(\\{hold\_head})\K\\{null}$;\6
\4\&{until}\5
$\R\\{odd}(\\{hyf}[\|j-1])$\2\par
\U1090.\fi

\M1092. The new hyphen might combine with the previous character via ligature
or kern. At this point we have $\|l-1\L\|i<\|j$ and $\|i<\\{hn}$.

\Y\P$\4\X1092:Put the \(c)characters $\\{hu}[\|l\to\|i]$ and a hyphen into $%
\\{pre\_break}(\|r)$\X\S$\6
$\\{minor\_tail}\K\\{null}$;\5
$\\{pre\_break}(\|r)\K\\{null}$;\5
$\\{hyf\_node}\K\\{new\_character}(\\{hf},\39\\{hyf\_char})$;\6
\&{if} $\\{hyf\_node}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|i)$;\5
$\|c\K\\{hu}[\|i]$;\5
$\\{hu}[\|i]\K\\{hyf\_char}$;\5
$\\{free\_avail}(\\{hyf\_node})$;\6
\&{end};\2\6
\&{while} $\|l\L\|i$ \1\&{do}\6
\&{begin} \37$\|l\K\\{reconstitute}(\|l,\39\|i,\39\\{font\_bchar}[\\{hf}],\39%
\\{non\_char})+1$;\6
\&{if} $\\{link}(\\{hold\_head})>\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{minor\_tail}=\\{null}$ \1\&{then}\5
$\\{pre\_break}(\|r)\K\\{link}(\\{hold\_head})$\6
\4\&{else} $\\{link}(\\{minor\_tail})\K\\{link}(\\{hold\_head})$;\2\6
$\\{minor\_tail}\K\\{link}(\\{hold\_head})$;\6
\&{while} $\\{link}(\\{minor\_tail})>\\{null}$ \1\&{do}\5
$\\{minor\_tail}\K\\{link}(\\{minor\_tail})$;\2\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{hyf\_node}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{hu}[\|i]\K\|c$;\C{restore the character in the hyphen
position}\6
$\|l\K\|i$;\5
$\\{decr}(\|i)$;\6
\&{end}\2\par
\U1091.\fi

\M1093. The synchronization algorithm begins with $\|l=\|i+1\L\|j$.

\Y\P$\4\X1093:Put the \(c)characters $\\{hu}[\|i+1\to\,]$ into $\\{post%
\_break}(\|r)$, appending to this list and to \\{major\_tail} until
synchronization has been achieved\X\S$\6
$\\{minor\_tail}\K\\{null}$;\5
$\\{post\_break}(\|r)\K\\{null}$;\5
$\\{c\_loc}\K0$;\6
\&{if} $\\{bchar\_label}[\\{hf}]\I\\{non\_address}$ \1\&{then}\C{put left
boundary at beginning of new line}\6
\&{begin} \37$\\{decr}(\|l)$;\5
$\|c\K\\{hu}[\|l]$;\5
$\\{c\_loc}\K\|l$;\5
$\\{hu}[\|l]\K256$;\6
\&{end};\2\6
\&{while} $\|l<\|j$ \1\&{do}\6
\&{begin} \37\1\&{repeat} \37$\|l\K\\{reconstitute}(\|l,\39\\{hn},\39\\{bchar},%
\39\\{non\_char})+1$;\6
\&{if} $\\{c\_loc}>0$ \1\&{then}\6
\&{begin} \37$\\{hu}[\\{c\_loc}]\K\|c$;\5
$\\{c\_loc}\K0$;\6
\&{end};\2\6
\&{if} $\\{link}(\\{hold\_head})>\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{minor\_tail}=\\{null}$ \1\&{then}\5
$\\{post\_break}(\|r)\K\\{link}(\\{hold\_head})$\6
\4\&{else} $\\{link}(\\{minor\_tail})\K\\{link}(\\{hold\_head})$;\2\6
$\\{minor\_tail}\K\\{link}(\\{hold\_head})$;\6
\&{while} $\\{link}(\\{minor\_tail})>\\{null}$ \1\&{do}\5
$\\{minor\_tail}\K\\{link}(\\{minor\_tail})$;\2\6
\&{end};\2\6
\4\&{until}\5
$\|l\G\|j$;\2\6
\&{while} $\|l>\|j$ \1\&{do}\5
\X1094:Append characters of $\\{hu}[\|j\to\,]$ to \\{major\_tail}, advancing~%
\|j\X;\2\6
\&{end}\2\par
\U1091.\fi

\M1094. \P$\X1094:Append characters of $\\{hu}[\|j\to\,]$ to \\{major\_tail},
advancing~\|j\X\S$\6
\&{begin} \37$\|j\K\\{reconstitute}(\|j,\39\\{hn},\39\\{bchar},\39\\{non%
\_char})+1$;\5
$\\{link}(\\{major\_tail})\K\\{link}(\\{hold\_head})$;\6
\&{while} $\\{link}(\\{major\_tail})>\\{null}$ \1\&{do}\5
\\{advance\_major\_tail};\2\6
\&{end}\par
\U1093.\fi

\M1095. Ligature insertion can cause a word to grow exponentially in size.
Therefore
we must test the size of \\{r\_count} here, even though the hyphenated text
was at most 63 characters long.

\Y\P$\4\X1095:Move pointer \|s to the end of the current list, and set $%
\\{replace\_count}(\|r)$ appropriately\X\S$\6
\&{if} $\\{r\_count}>127$ \1\&{then}\C{we have to forget the discretionary
hyphen}\6
\&{begin} \37$\\{link}(\|s)\K\\{link}(\|r)$;\5
$\\{link}(\|r)\K\\{null}$;\5
$\\{flush\_node\_list}(\|r)$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{link}(\|s)\K\|r$;\5
$\\{replace\_count}(\|r)\K\\{r\_count}$;\6
\&{end};\2\6
$\|s\K\\{major\_tail}$\par
\U1091.\fi

\N1096.  \[42] Hyphenation.
When a word $\\{hc}[1\to\\{hn}]$ has been set up to contain a candidate for
hyphenation,
\TeX\ first looks to see if it is in the user's exception dictionary. If not,
hyphens are inserted based on patterns that appear within the given word,
using an algorithm due to Frank~M. Liang.

Let's consider Liang's method first, since it is much more interesting than the
exception-lookup routine.  The algorithm begins by setting $\\{hyf}[\|j]$ to
zero
for all \|j, and invalid characters are inserted into $\\{hc}[0]$
and $\\{hc}[\\{hn}+1]$ to serve as delimiters. Then a reasonably fast method is
used to see which of a given set of patterns occurs in the word
$\\{hc}[0\to(\\{hn}+1)]$. Each pattern $p_1\ldots p_k$ of length \|k has an
associated
sequence of $\|k+1$ numbers $n_0\ldots n_k$; and if the pattern occurs in
$\\{hc}[(\|j+1)\to(\|j+\|k)]$, \TeX\ will set $\\{hyf}[\|j+\|i]\K\hbox{max}(%
\\{hyf}[\|j+\|i],\hbox{$n_i$})$ for
$0\L\|i\L\|k$. After this has been done for each pattern that occurs, a
discretionary hyphen will be inserted between $\\{hc}[\|j]$ and $\\{hc}[\|j+1]$
when
$\\{hyf}[\|j]$ is odd, as we have already seen.

The set of patterns $p_1\ldots p_k$ and associated numbers $n_0\ldots n_k$
depends, of course, on the language whose words are being hyphenated, and
on the degree of hyphenation that is desired. A method for finding
appropriate \|p's and \|n's, from a given dictionary of words and acceptable
hyphenations, is discussed in Liang's Ph.D. thesis (Stanford University,
1983); \TeX\ simply starts with the patterns and works from there.

\fi

\M1097. The patterns are stored in a compact table that is also efficient for
retrieval, using a variant of ``trie memory'' [cf.\ {\sl The Art of
Computer Programming \bf3} (1973), 481--505]. We can find each pattern
$p_1\ldots p_k$ by letting $z_0$ be one greater than the relevant language
index and then, for $1\L\|i\L\|k$,
setting $\hbox{$z_i$}\K\\{trie\_link}\hbox{$(z_{i-1})+p_i$}$; the pattern will
be
identified by the number $z_k$. Since all the pattern information is
packed together into a single \\{trie\_link} array, it is necessary to
prevent confusion between the data from inequivalent patterns, so another
table is provided such that \\{trie\_char}\hbox{$(z_i)=p_i$} for all \|i. There
is also a table \\{trie\_op}$(z_k)$ to identify the numbers $n_0\ldots n_k$
associated with $p_1\ldots p_k$.

Comparatively few different number sequences $n_0\ldots n_k$ actually occur,
since most of the \|n's are generally zero. Therefore the number sequences
are encoded in such a way that \\{trie\_op}$(z_k)$ is only one byte long.
If $\\{trie\_op}(\hbox{$z_k$})\I\\{min\_quarterword}$, when $p_1\ldots p_k$ has
matched
the letters in $\\{hc}[(\|l-\|k+1)\to\|l\,]$ of language \|t,
we perform all of the required operations
for this pattern by carrying out the following little program: Set
$\|v\K\\{trie\_op}(\hbox{$z_k$})$. Then set $\|v\K\|v+\\{op\_start}[\|t]$,
$\\{hyf}[\|l-\\{hyf\_distance}[\|v]]\K\hbox{max}(\\{hyf}[\|l-\\{hyf\_distance}[%
\|v]],\\{hyf\_num}[\|v])$,
and $\|v\K\\{hyf\_next}[\|v]$; repeat, if necessary, until $\|v=\\{min%
\_quarterword}$.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{trie\_pointer}=0\to\\{trie\_size}$;\C{an index into \\{trie}}\par
\fi

\M1098. \P\D \37$\\{trie\_link}(\#)\S\\{trie}[\#].\\{rh}$\C{``downward'' link
in a trie}\par
\P\D \37$\\{trie\_char}(\#)\S\\{trie}[\#].\\{b1}$\C{character matched at this
trie location}\par
\P\D \37$\\{trie\_op}(\#)\S\\{trie}[\#].\\{b0}$\C{program for hyphenation at
this trie location}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{trie}: \37\&{array} $[\\{trie\_pointer}]$ \1\&{of}\5
\\{two\_halves};\C{\\{trie\_link}, \\{trie\_char}, \\{trie\_op}}\2\6
\4\\{hyf\_distance}: \37\&{array} $[1\to\\{trie\_op\_size}]$ \1\&{of}\5
\\{small\_number};\C{position $\|k-\|j$ of $n_j$}\2\6
\4\\{hyf\_num}: \37\&{array} $[1\to\\{trie\_op\_size}]$ \1\&{of}\5
\\{small\_number};\C{value of $n_j$}\2\6
\4\\{hyf\_next}: \37\&{array} $[1\to\\{trie\_op\_size}]$ \1\&{of}\5
\\{quarterword};\C{continuation code}\2\6
\4\\{op\_start}: \37\&{array} $[\\{ASCII\_code}]$ \1\&{of}\5
$0\to\\{trie\_op\_size}$;\C{offset for current language}\2\par
\fi

\M1099. \P$\X1078:Local variables for hyphenation\X\mathrel{+}\S$\6
\4\|z: \37\\{trie\_pointer};\C{an index into \\{trie}}\6
\4\|v: \37\\{integer};\C{an index into \\{hyf\_distance}, etc.}\par
\fi

\M1100. Assuming that these auxiliary tables have been set up properly, the
hyphenation algorithm is quite short. In the following code we set $\\{hc}[%
\\{hn}+2]$
to the impossible value 256, in order to guarantee that $\\{hc}[\\{hn}+3]$ will
never be fetched.

\Y\P$\4\X1100:Find hyphen locations for the word in \\{hc}, or \&{return}\X\S$\6
\&{for} $\|j\K0\mathrel{\&{to}}\\{hn}$ \1\&{do}\5
$\\{hyf}[\|j]\K0$;\2\6
\X1107:Look for the word $\\{hc}[1\to\\{hn}]$ in the exception table, and %
\&{goto} \\{found} (with \\{hyf} containing the hyphens) if an entry is found%
\X;\6
\&{if} $\\{trie\_char}(\\{cur\_lang}+1)\I\\{qi}(\\{cur\_lang})$ \1\&{then}\5
\&{return};\C{no patterns for \\{cur\_lang}}\2\6
$\\{hc}[0]\K0$;\5
$\\{hc}[\\{hn}+1]\K0$;\5
$\\{hc}[\\{hn}+2]\K256$;\C{insert delimiters}\6
\&{for} $\|j\K0\mathrel{\&{to}}\\{hn}-\\{r\_hyf}+1$ \1\&{do}\6
\&{begin} \37$\|z\K\\{trie\_link}(\\{cur\_lang}+1)+\\{hc}[\|j]$;\5
$\|l\K\|j$;\6
\&{while} $\\{hc}[\|l]=\\{qo}(\\{trie\_char}(\|z))$ \1\&{do}\6
\&{begin} \37\&{if} $\\{trie\_op}(\|z)\I\\{min\_quarterword}$ \1\&{then}\5
\X1101:Store \(m)maximum values in the \\{hyf} table\X;\2\6
$\\{incr}(\|l)$;\5
$\|z\K\\{trie\_link}(\|z)+\\{hc}[\|l]$;\6
\&{end};\2\6
\&{end};\2\6
\4\\{found}: \37\&{for} $\|j\K0\mathrel{\&{to}}\\{l\_hyf}-1$ \1\&{do}\5
$\\{hyf}[\|j]\K0$;\2\6
\&{for} $\|j\K0\mathrel{\&{to}}\\{r\_hyf}-1$ \1\&{do}\5
$\\{hyf}[\\{hn}-\|j]\K0$\2\par
\U1072.\fi

\M1101. \P$\X1101:Store \(m)maximum values in the \\{hyf} table\X\S$\6
\&{begin} \37$\|v\K\\{trie\_op}(\|z)$;\6
\1\&{repeat} \37$\|v\K\|v+\\{op\_start}[\\{cur\_lang}]$;\5
$\|i\K\|l-\\{hyf\_distance}[\|v]$;\6
\&{if} $\\{hyf\_num}[\|v]>\\{hyf}[\|i]$ \1\&{then}\5
$\\{hyf}[\|i]\K\\{hyf\_num}[\|v]$;\2\6
$\|v\K\\{hyf\_next}[\|v]$;\6
\4\&{until}\5
$\|v=\\{min\_quarterword}$;\2\6
\&{end}\par
\U1100.\fi

\M1102. The exception table that is built by \TeX's \.{\\hyphenation} primitive
is
organized as an ordered hash table [cf.\ Amble and Knuth, {\sl The Computer
Journal\/ \bf17} (1974), 135--142] using linear probing. If $\alpha$ and
$\beta$ are words, we will say that $\alpha<\beta$ if $\vert\alpha\vert<
\vert\beta\vert$ or if $\vert\alpha\vert=\vert\beta\vert$ and
$\alpha$ is lexicographically smaller than $\beta$. (The notation $\vert
\alpha\vert$ stands for the length of $\alpha$.) The idea of ordered hashing
is to arrange the table so that a given word $\alpha$ can be sought by
computing
a hash address $h=h(\alpha)$ and then looking in table positions \|h, $\|h-1$,
\dots, until encountering the first word $\L\alpha$. If this word is
different from $\alpha$, we can conclude that $\alpha$ is not in the table.

The words in the table point to lists in \\{mem} that specify hyphen positions
in their \\{info} fields. The list for $c_1\ldots c_n$ contains the number \|k
if
the word $c_1\ldots c_n$ has a discretionary hyphen between $c_k$ and
$c_{k+1}$.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{hyph\_pointer}=0\to\\{hyph\_size}$;\C{an index into the ordered hash table}%
\par
\fi

\M1103. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hyph\_word}: \37\&{array} $[\\{hyph\_pointer}]$ \1\&{of}\5
\\{str\_number};\C{exception words}\2\6
\4\\{hyph\_list}: \37\&{array} $[\\{hyph\_pointer}]$ \1\&{of}\5
\\{pointer};\C{lists of hyphen positions}\2\6
\4\\{hyph\_count}: \37\\{hyph\_pointer};\C{the number of words in the exception
dictionary}\par
\fi

\M1104. \P$\X19:Local variables for initialization\X\mathrel{+}\S$\6
\4\|z: \37\\{hyph\_pointer};\C{runs through the exception dictionary}\par
\fi

\M1105. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|z\K0\mathrel{\&{to}}\\{hyph\_size}$ \1\&{do}\6
\&{begin} \37$\\{hyph\_word}[\|z]\K0$;\5
$\\{hyph\_list}[\|z]\K\\{null}$;\6
\&{end};\2\6
$\\{hyph\_count}\K0$;\par
\fi

\M1106. The algorithm for exception lookup is quite simple, as soon as we have
a few more local variables to work with.

\Y\P$\4\X1078:Local variables for hyphenation\X\mathrel{+}\S$\6
\4\|h: \37\\{hyph\_pointer};\C{an index into \\{hyph\_word} and \\{hyph\_list}}%
\6
\4\|k: \37\\{str\_number};\C{an index into \\{str\_start}}\6
\4\|u: \37\\{pool\_pointer};\C{an index into \\{str\_pool}}\par
\fi

\M1107. First we compute the hash code \|h, then we search until we either
find the word or we don't. Words from different languages are kept
separate by appending the language code to the string.

\Y\P$\4\X1107:Look for the word $\\{hc}[1\to\\{hn}]$ in the exception table,
and \&{goto} \\{found} (with \\{hyf} containing the hyphens) if an entry is
found\X\S$\6
$\|h\K\\{hc}[1]$;\5
$\\{incr}(\\{hn})$;\5
$\\{hc}[\\{hn}]\K\\{cur\_lang}$;\6
\&{for} $\|j\K2\mathrel{\&{to}}\\{hn}$ \1\&{do}\5
$\|h\K(\|h+\|h+\\{hc}[\|j])\mathbin{\&{mod}}\\{hyph\_size}$;\2\6
\~ \1\&{loop}\ \&{begin} \37\X1108:If the string $\\{hyph\_word}[\|h]$ is less
than \(hc)$\\{hc}[1\to\\{hn}]$, \&{goto} \\{not\_found}; but if the two strings
are equal, set \\{hyf} to the hyphen positions and \&{goto} \\{found}\X;\6
\&{if} $\|h>0$ \1\&{then}\5
$\\{decr}(\|h)$\ \&{else} $\|h\K\\{hyph\_size}$;\2\6
\&{end};\2\6
\4\\{not\_found}: \37$\\{decr}(\\{hn})$\par
\U1100.\fi

\M1108. \P$\X1108:If the string $\\{hyph\_word}[\|h]$ is less than \(hc)$%
\\{hc}[1\to\\{hn}]$, \&{goto} \\{not\_found}; but if the two strings are equal,
set \\{hyf} to the hyphen positions and \&{goto} \\{found}\X\S$\6
$\|k\K\\{hyph\_word}[\|h]$;\6
\&{if} $\|k=0$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\&{if} $\\{length}(\|k)<\\{hn}$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\&{if} $\\{length}(\|k)=\\{hn}$ \1\&{then}\6
\&{begin} \37$\|j\K1$;\5
$\|u\K\\{str\_start}[\|k]$;\6
\1\&{repeat} \37\&{if} $\\{so}(\\{str\_pool}[\|u])<\\{hc}[\|j]$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\&{if} $\\{so}(\\{str\_pool}[\|u])>\\{hc}[\|j]$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\\{incr}(\|j)$;\5
$\\{incr}(\|u)$;\6
\4\&{until}\5
$\|j>\\{hn}$;\2\6
\X1109:Insert hyphens as specified in $\\{hyph\_list}[\|h]$\X;\6
$\\{decr}(\\{hn})$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\4\\{done}: \37\par
\U1107.\fi

\M1109. \P$\X1109:Insert hyphens as specified in $\\{hyph\_list}[\|h]$\X\S$\6
$\|s\K\\{hyph\_list}[\|h]$;\6
\&{while} $\|s\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{hyf}[\\{info}(\|s)]\K1$;\5
$\|s\K\\{link}(\|s)$;\6
\&{end}\2\par
\U1108.\fi

\M1110. \P$\X1110:Search \\{hyph\_list} for pointers to \|p\X\S$\6
\&{for} $\|q\K0\mathrel{\&{to}}\\{hyph\_size}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{hyph\_list}[\|q]=\|p$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"HYPH("})$;\5
$\\{print\_int}(\|q)$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\2\6
\&{end}\2\par
\U190.\fi

\M1111. We have now completed the hyphenation routine, so the \\{line\_break}
procedure
is finished at last. Since the hyphenation exception table is fresh in our
minds, it's a good time to deal with the routine that adds new entries to it.

When \TeX\ has scanned `\.{\\hyphenation}', it calls on a procedure named
\\{new\_hyph\_exceptions} to do the right thing.

\Y\P\D \37$\\{set\_cur\_lang}\S$\1\6
\&{if} $\\{language}\L0$ \1\&{then}\5
$\\{cur\_lang}\K0$\6
\4\&{else} \&{if} $\\{language}>255$ \1\&{then}\5
$\\{cur\_lang}\K0$\6
\4\&{else} $\\{cur\_lang}\K\\{language}$\2\2\2\par
\Y\P\4\&{procedure}\1\  \37\\{new\_hyph\_exceptions};\C{enters new exceptions}\6
\4\&{label} \37$\\{reswitch},\39\\{exit},\39\\{found},\39\\{not\_found},\39%
\\{not\_found1}$;\6
\4\&{var} \37\|n: \37$0\to64$;\C{length of current word; not always a \\{small%
\_number}}\6
\|j: \37$0\to64$;\C{an index into \\{hc}}\6
\|h: \37\\{hyph\_pointer};\C{an index into \\{hyph\_word} and \\{hyph\_list}}\6
\|k: \37\\{str\_number};\C{an index into \\{str\_start}}\6
\|p: \37\\{pointer};\C{head of a list of hyphen positions}\6
\|q: \37\\{pointer};\C{used when creating a new node for list \|p}\6
$\|s,\39\|t$: \37\\{str\_number};\C{strings being compared or stored}\6
$\|u,\39\|v$: \37\\{pool\_pointer};\C{indices into \\{str\_pool}}\2\6
\&{begin} \37\\{scan\_left\_brace};\C{a left brace must follow \.{%
\\hyphenation}}\6
\\{set\_cur\_lang};\6
\&{init} \37\&{if} $\\{trie\_not\_ready}$ \1\&{then}\6
\&{begin} \37$\\{hyph\_index}\K0$;\5
\&{goto} \37\\{not\_found1};\6
\&{end};\2\6
\&{tini}\6
\\{set\_hyph\_index};\6
\4\\{not\_found1}: \37\X1112:Enter as many hyphenation exceptions as are
listed, until coming to a right brace; then \&{return}\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1112. \P$\X1112:Enter as many hyphenation exceptions as are listed, until
coming to a right brace; then \&{return}\X\S$\6
$\|n\K0$;\5
$\|p\K\\{null}$;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_x\_token};\6
\4\\{reswitch}: \37\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4$\\{letter},\39\\{other\_char},\39\\{char\_given}$: \37\X1114:Append a new
letter or hyphen\X;\6
\4\\{char\_num}: \37\&{begin} \37\\{scan\_char\_num};\5
$\\{cur\_chr}\K\\{cur\_val}$;\5
$\\{cur\_cmd}\K\\{char\_given}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\6
\4$\\{spacer},\39\\{right\_brace}$: \37\&{begin} \37\&{if} $\|n>1$ \1\&{then}\5
\X1116:Enter a hyphenation exception\X;\2\6
\&{if} $\\{cur\_cmd}=\\{right\_brace}$ \1\&{then}\5
\&{return};\2\6
$\|n\K0$;\5
$\|p\K\\{null}$;\6
\&{end};\6
\4\&{othercases} \37\X1113:Give improper \.{\\hyphenation} error\X\2\6
\&{endcases};\6
\&{end}\2\par
\U1111.\fi

\M1113. \P$\X1113:Give improper \.{\\hyphenation} error\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ "})$;\5
$\\{print\_esc}(\.{"hyphenation"})$;\5
$\\{print}(\.{"\ will\ be\ flushed"})$;\5
$\\{help2}(\.{"Hyphenation\ exceptions\ must\ contain\ only\ letters"})$\6
$(\.{"and\ hyphens.\ But\ continue;\ I\'ll\ forgive\ and\ forget."})$;\5
\\{error};\6
\&{end}\par
\U1112.\fi

\M1114. \P$\X1114:Append a new letter or hyphen\X\S$\6
\&{if} $\\{cur\_chr}=\.{"-"}$ \1\&{then}\5
\X1115:Append the value \|n to list \|p\X\6
\4\&{else} \&{begin} \37$\\{set\_lc\_code}(\\{cur\_chr})$;\6
\&{if} $\\{hc}[0]=0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Not\ a\ letter"})$;\5
$\\{help2}(\.{"Letters\ in\ \\hyphenation\ words\ must\ have\ \\lccode>0."})$\6
$(\.{"Proceed;\ I\'ll\ ignore\ the\ character\ I\ just\ read."})$;\5
\\{error};\6
\&{end}\6
\4\&{else} \&{if} $\|n<63$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|n)$;\5
$\\{hc}[\|n]\K\\{hc}[0]$;\6
\&{end};\2\2\6
\&{end}\2\par
\U1112.\fi

\M1115. \P$\X1115:Append the value \|n to list \|p\X\S$\6
\&{begin} \37\&{if} $\|n<63$ \1\&{then}\6
\&{begin} \37$\|q\K\\{get\_avail}$;\5
$\\{link}(\|q)\K\|p$;\5
$\\{info}(\|q)\K\|n$;\5
$\|p\K\|q$;\6
\&{end};\2\6
\&{end}\par
\U1114.\fi

\M1116. \P$\X1116:Enter a hyphenation exception\X\S$\6
\&{begin} \37$\\{incr}(\|n)$;\5
$\\{hc}[\|n]\K\\{cur\_lang}$;\5
$\\{str\_room}(\|n)$;\5
$\|h\K0$;\6
\&{for} $\|j\K1\mathrel{\&{to}}\|n$ \1\&{do}\6
\&{begin} \37$\|h\K(\|h+\|h+\\{hc}[\|j])\mathbin{\&{mod}}\\{hyph\_size}$;\5
$\\{append\_char}(\\{hc}[\|j])$;\6
\&{end};\2\6
$\|s\K\\{make\_string}$;\5
\X1117:Insert the \(p)pair $(\|s,\|p)$ into the exception table\X;\6
\&{end}\par
\U1112.\fi

\M1117. \P$\X1117:Insert the \(p)pair $(\|s,\|p)$ into the exception table\X\S$%
\6
\&{if} $\\{hyph\_count}=\\{hyph\_size}$ \1\&{then}\5
$\\{overflow}(\.{"exception\ dictionary"},\39\\{hyph\_size})$;\2\6
$\\{incr}(\\{hyph\_count})$;\6
\&{while} $\\{hyph\_word}[\|h]\I0$ \1\&{do}\6
\&{begin} \37\X1118:If the string $\\{hyph\_word}[\|h]$ is less than \(or)or
equal to \|s, interchange $(\\{hyph\_word}[\|h],\\{hyph\_list}[\|h])$ with $(%
\|s,\|p)$\X;\6
\&{if} $\|h>0$ \1\&{then}\5
$\\{decr}(\|h)$\ \&{else} $\|h\K\\{hyph\_size}$;\2\6
\&{end};\2\6
$\\{hyph\_word}[\|h]\K\|s$;\5
$\\{hyph\_list}[\|h]\K\|p$\par
\U1116.\fi

\M1118. \P$\X1118:If the string $\\{hyph\_word}[\|h]$ is less than \(or)or
equal to \|s, interchange $(\\{hyph\_word}[\|h],\\{hyph\_list}[\|h])$ with $(%
\|s,\|p)$\X\S$\6
$\|k\K\\{hyph\_word}[\|h]$;\6
\&{if} $\\{length}(\|k)<\\{length}(\|s)$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{if} $\\{length}(\|k)>\\{length}(\|s)$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
$\|u\K\\{str\_start}[\|k]$;\5
$\|v\K\\{str\_start}[\|s]$;\6
\1\&{repeat} \37\&{if} $\\{str\_pool}[\|u]<\\{str\_pool}[\|v]$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{if} $\\{str\_pool}[\|u]>\\{str\_pool}[\|v]$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
$\\{incr}(\|u)$;\5
$\\{incr}(\|v)$;\6
\4\&{until}\5
$\|u=\\{str\_start}[\|k+1]$;\2\6
\4\\{found}: \37$\|q\K\\{hyph\_list}[\|h]$;\5
$\\{hyph\_list}[\|h]\K\|p$;\5
$\|p\K\|q$;\6
$\|t\K\\{hyph\_word}[\|h]$;\5
$\\{hyph\_word}[\|h]\K\|s$;\5
$\|s\K\|t$;\6
\4\\{not\_found}: \37\par
\U1117.\fi

\N1119.  \[43] Initializing the hyphenation tables.
The trie for \TeX's hyphenation algorithm is built from a sequence of
patterns following a \.{\\patterns} specification. Such a specification
is allowed only in \.{INITEX}, since the extra memory for auxiliary tables
and for the initialization program itself would only clutter up the
production version of \TeX\ with a lot of deadwood.

The first step is to build a trie that is linked, instead of packed
into sequential storage, so that insertions are readily made.
After all patterns have been processed, \.{INITEX}
compresses the linked trie by identifying common subtries. Finally the
trie is packed into the efficient sequential form that the hyphenation
algorithm actually uses.

\Y\P$\4\X1002:Declare subprocedures for \\{line\_break}\X\mathrel{+}\S$\6
\&{init} \37\X1121:Declare procedures for preprocessing hyphenation patterns\X\6
\&{tini}\par
\fi

\M1120. Before we discuss trie building in detail, let's consider the simpler
problem of creating the \\{hyf\_distance}, \\{hyf\_num}, and \\{hyf\_next}
arrays.

Suppose, for example, that \TeX\ reads the pattern `\.{ab2cde1}'. This is
a pattern of length 5, with $n_0\ldots n_5=0\,0\,2\,0\,0\,1$ in the
notation above. We want the corresponding \\{trie\_op} code \|v to have
$\\{hyf\_distance}[\|v]=3$, $\\{hyf\_num}[\|v]=2$, and $\\{hyf\_next}[\|v]=%
\hbox{$v^\prime$}$,
where the auxiliary \\{trie\_op} code $v^\prime$ has
$\\{hyf\_distance}[\hbox{$v^\prime$}]=0$, $\\{hyf\_num}[\hbox{$v^\prime$}]=1$,
and
$\\{hyf\_next}[\hbox{$v^\prime$}]=\\{min\_quarterword}$.

\TeX\ computes an appropriate value \|v with the \\{new\_trie\_op} subroutine
below, by setting
$$\hbox{$\hbox{$v^\prime$}\K\\{new\_trie\_op}(0,1,\\{min\_quarterword})$,\qquad
$\|v\K\\{new\_trie\_op}(3,2,\hbox{$v^\prime$})$.}$$
This subroutine looks up its three
parameters in a special hash table, assigning a new value only if these
three have not appeared before for the current language.

The hash table is called \\{trie\_op\_hash}, and the number of entries it
contains
is \\{trie\_op\_ptr}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\&{init} \37\\{trie\_op\_hash}: \37\&{array} $[-\\{trie\_op\_size}\to\\{trie%
\_op\_size}]$ \1\&{of}\5
$0\to\\{trie\_op\_size}$;\C{trie op codes for quadruples}\2\6
\4\\{trie\_used}: \37\&{array} $[\\{ASCII\_code}]$ \1\&{of}\5
\\{quarterword};\C{largest opcode used so far for this language}\2\6
\4\\{trie\_op\_lang}: \37\&{array} $[1\to\\{trie\_op\_size}]$ \1\&{of}\5
\\{ASCII\_code};\C{language part of a hashed quadruple}\2\6
\4\\{trie\_op\_val}: \37\&{array} $[1\to\\{trie\_op\_size}]$ \1\&{of}\5
\\{quarterword};\C{opcode corresponding to a hashed quadruple}\2\6
\4\\{trie\_op\_ptr}: \37$0\to\\{trie\_op\_size}$;\C{number of stored ops so
far}\6
\&{tini}\par
\fi

\M1121. It's tempting to remove the \\{overflow} stops in the following
procedure;
\\{new\_trie\_op} could return \\{min\_quarterword} (thereby simply ignoring
part of a hyphenation pattern) instead of aborting the job. However, that would
lead to different hyphenation results on different installations of \TeX\
using the same patterns. The \\{overflow} stops are necessary for portability
of patterns.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X\S$\6
\4\&{function}\1\  \37$\\{new\_trie\_op}(\|d,\39\|n:\\{small\_number};\,\35\|v:%
\\{quarterword})$: \37\\{quarterword};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|h: \37$-\\{trie\_op\_size}\to\\{trie\_op\_size}$;\C{trial hash
location}\6
\|u: \37\\{quarterword};\C{trial op code}\6
\|l: \37$0\to\\{trie\_op\_size}$;\C{pointer to stored data}\2\6
\&{begin} \37$\|h\K\\{abs}(\|n+313\ast\|d+361\ast\|v+1009\ast\\{cur\_lang})%
\mathbin{\&{mod}}(\\{trie\_op\_size}+\\{trie\_op\_size})-\\{trie\_op\_size}$;\6
\~ \1\&{loop}\ \&{begin} \37$\|l\K\\{trie\_op\_hash}[\|h]$;\6
\&{if} $\|l=0$ \1\&{then}\C{empty position found for a new op}\6
\&{begin} \37\&{if} $\\{trie\_op\_ptr}=\\{trie\_op\_size}$ \1\&{then}\5
$\\{overflow}(\.{"pattern\ memory\ ops"},\39\\{trie\_op\_size})$;\2\6
$\|u\K\\{trie\_used}[\\{cur\_lang}]$;\6
\&{if} $\|u=\\{max\_quarterword}$ \1\&{then}\5
$\\{overflow}(\.{"pattern\ memory\ ops\ per\ language"},\39\\{max%
\_quarterword}-\\{min\_quarterword})$;\2\6
$\\{incr}(\\{trie\_op\_ptr})$;\5
$\\{incr}(\|u)$;\5
$\\{trie\_used}[\\{cur\_lang}]\K\|u$;\5
$\\{hyf\_distance}[\\{trie\_op\_ptr}]\K\|d$;\5
$\\{hyf\_num}[\\{trie\_op\_ptr}]\K\|n$;\5
$\\{hyf\_next}[\\{trie\_op\_ptr}]\K\|v$;\5
$\\{trie\_op\_lang}[\\{trie\_op\_ptr}]\K\\{cur\_lang}$;\5
$\\{trie\_op\_hash}[\|h]\K\\{trie\_op\_ptr}$;\5
$\\{trie\_op\_val}[\\{trie\_op\_ptr}]\K\|u$;\5
$\\{new\_trie\_op}\K\|u$;\5
\&{return};\6
\&{end};\2\6
\&{if} $(\\{hyf\_distance}[\|l]=\|d)\W(\\{hyf\_num}[\|l]=\|n)\W(\\{hyf\_next}[%
\|l]=\|v)\W(\\{trie\_op\_lang}[\|l]=\\{cur\_lang})$ \1\&{then}\6
\&{begin} \37$\\{new\_trie\_op}\K\\{trie\_op\_val}[\|l]$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\|h>-\\{trie\_op\_size}$ \1\&{then}\5
$\\{decr}(\|h)$\ \&{else} $\|h\K\\{trie\_op\_size}$;\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\As1125, 1126, 1130, 1134, 1136, 1137\ETs1143.
\U1119.\fi

\M1122. After \\{new\_trie\_op} has compressed the necessary opcode
information,
plenty of information is available to unscramble the data into the
final form needed by our hyphenation algorithm.

\Y\P$\4\X1122:Sort \(t)the hyphenation op tables into proper order\X\S$\6
$\\{op\_start}[0]\K-\\{min\_quarterword}$;\6
\&{for} $\|j\K1\mathrel{\&{to}}255$ \1\&{do}\5
$\\{op\_start}[\|j]\K\\{op\_start}[\|j-1]+\\{qo}(\\{trie\_used}[\|j-1])$;\2\6
\&{for} $\|j\K1\mathrel{\&{to}}\\{trie\_op\_ptr}$ \1\&{do}\5
$\\{trie\_op\_hash}[\|j]\K\\{op\_start}[\\{trie\_op\_lang}[\|j]]+\\{trie\_op%
\_val}[\|j]$;\C{destination}\2\6
\&{for} $\|j\K1\mathrel{\&{to}}\\{trie\_op\_ptr}$ \1\&{do}\6
\&{while} $\\{trie\_op\_hash}[\|j]>\|j$ \1\&{do}\6
\&{begin} \37$\|k\K\\{trie\_op\_hash}[\|j]$;\6
$\|t\K\\{hyf\_distance}[\|k]$;\5
$\\{hyf\_distance}[\|k]\K\\{hyf\_distance}[\|j]$;\5
$\\{hyf\_distance}[\|j]\K\|t$;\6
$\|t\K\\{hyf\_num}[\|k]$;\5
$\\{hyf\_num}[\|k]\K\\{hyf\_num}[\|j]$;\5
$\\{hyf\_num}[\|j]\K\|t$;\6
$\|t\K\\{hyf\_next}[\|k]$;\5
$\\{hyf\_next}[\|k]\K\\{hyf\_next}[\|j]$;\5
$\\{hyf\_next}[\|j]\K\|t$;\6
$\\{trie\_op\_hash}[\|j]\K\\{trie\_op\_hash}[\|k]$;\5
$\\{trie\_op\_hash}[\|k]\K\|k$;\6
\&{end}\2\2\par
\U1129.\fi

\M1123. Before we forget how to initialize the data structures that have been
mentioned so far, let's write down the code that gets them started.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
\&{for} $\|k\K-\\{trie\_op\_size}\mathrel{\&{to}}\\{trie\_op\_size}$ \1\&{do}\5
$\\{trie\_op\_hash}[\|k]\K0$;\2\6
\&{for} $\|k\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{trie\_used}[\|k]\K\\{min\_quarterword}$;\2\6
$\\{trie\_op\_ptr}\K0$;\par
\fi

\M1124. The linked trie that is used to preprocess hyphenation patterns appears
in several global arrays. Each node represents an instruction of the form
``if you see character \|c, then perform operation \|o, move to the
next character, and go to node \|l; otherwise go to node \|r.''
The four quantities \|c, \|o, \|l, and \|r are stored in four arrays
\\{trie\_c}, \\{trie\_o}, \\{trie\_l}, and \\{trie\_r}. The root of the trie
is $\\{trie\_l}[0]$, and the number of nodes is \\{trie\_ptr}. Null trie
pointers are represented by zero. To initialize the trie, we simply
set $\\{trie\_l}[0]$ and \\{trie\_ptr} to zero. We also set $\\{trie\_c}[0]$ to
some
arbitrary value, since the algorithm may access it.

The algorithms maintain the condition
$$\hbox{$\\{trie\_c}[\\{trie\_r}[\|z]]>\\{trie\_c}[\|z]$\qquad
whenever $\|z\I0$ and $\\{trie\_r}[\|z]\I0$};$$ in other words, sibling nodes
are
ordered by their \|c fields.

\Y\P\D \37$\\{trie\_root}\S\\{trie\_l}[0]$\C{root of the linked trie}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\&{init} \37\\{trie\_c}: \37\&{packed} \37\&{array} $[\\{trie\_pointer}]$ \1%
\&{of}\5
\\{packed\_ASCII\_code};\C{characters to match}\2\6
\4\hbox{\hskip10pt}\\{trie\_o}: \37\&{packed} \37\&{array} $[\\{trie%
\_pointer}]$ \1\&{of}\5
\\{quarterword};\C{operations to perform}\2\6
\4\hbox{\hskip10pt}\\{trie\_l}: \37\&{packed} \37\&{array} $[\\{trie%
\_pointer}]$ \1\&{of}\5
\\{trie\_pointer};\C{left subtrie links}\2\6
\4\hbox{\hskip10pt}\\{trie\_r}: \37\&{packed} \37\&{array} $[\\{trie%
\_pointer}]$ \1\&{of}\5
\\{trie\_pointer};\C{right subtrie links}\2\6
\4\hbox{\hskip10pt}\\{trie\_ptr}: \37\\{trie\_pointer};\C{the number of nodes
in the trie}\6
\4\hbox{\hskip10pt}\\{trie\_hash}: \37\&{packed} \37\&{array} $[\\{trie%
\_pointer}]$ \1\&{of}\5
\\{trie\_pointer};\C{used to identify equivalent subtries}\2\6
\&{tini}\par
\fi

\M1125. Let us suppose that a linked trie has already been constructed.
Experience shows that we can often reduce its size by recognizing common
subtries; therefore another hash table is introduced for this purpose,
somewhat similar to \\{trie\_op\_hash}. The new hash table will be
initialized to zero.

The function $\\{trie\_node}(\|p)$ returns \|p if \|p is distinct from other
nodes
that it has seen, otherwise it returns the number of the first equivalent
node that it has seen.

Notice that we might make subtries equivalent even if they correspond to
patterns for different languages, in which the trie ops might mean quite
different things. That's perfectly all right.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{trie\_node}(\|p:\\{trie\_pointer})$: \37\\{trie%
\_pointer};\C{converts   to a canonical form}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|h: \37\\{trie\_pointer};\C{trial hash location}\6
\|q: \37\\{trie\_pointer};\C{trial trie node}\2\6
\&{begin} \37$\|h\K\\{abs}(\\{trie\_c}[\|p]+1009\ast\\{trie\_o}[\|p]+\302718%
\ast\\{trie\_l}[\|p]+3142\ast\\{trie\_r}[\|p])\mathbin{\&{mod}}\\{trie\_size}$;%
\6
\~ \1\&{loop}\ \&{begin} \37$\|q\K\\{trie\_hash}[\|h]$;\6
\&{if} $\|q=0$ \1\&{then}\6
\&{begin} \37$\\{trie\_hash}[\|h]\K\|p$;\5
$\\{trie\_node}\K\|p$;\5
\&{return};\6
\&{end};\2\6
\&{if} $(\\{trie\_c}[\|q]=\\{trie\_c}[\|p])\W(\\{trie\_o}[\|q]=\\{trie\_o}[%
\|p])\W\30(\\{trie\_l}[\|q]=\\{trie\_l}[\|p])\W(\\{trie\_r}[\|q]=\\{trie\_r}[%
\|p])$ \1\&{then}\6
\&{begin} \37$\\{trie\_node}\K\|q$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\|h>0$ \1\&{then}\5
$\\{decr}(\|h)$\ \&{else} $\|h\K\\{trie\_size}$;\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1126. A neat recursive procedure is now able to compress a trie by
traversing it and applying \\{trie\_node} to its nodes in ``bottom up''
fashion. We will compress the entire trie by clearing \\{trie\_hash} to
zero and then saying `$\\{trie\_root}\K\\{compress\_trie}(\\{trie\_root})$'.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{compress\_trie}(\|p:\\{trie\_pointer})$: \37\\{trie%
\_pointer};\2\6
\&{begin} \37\&{if} $\|p=0$ \1\&{then}\5
$\\{compress\_trie}\K0$\6
\4\&{else} \&{begin} \37$\\{trie\_l}[\|p]\K\\{compress\_trie}(\\{trie\_l}[%
\|p])$;\5
$\\{trie\_r}[\|p]\K\\{compress\_trie}(\\{trie\_r}[\|p])$;\5
$\\{compress\_trie}\K\\{trie\_node}(\|p)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1127. The compressed trie will be packed into the \\{trie} array using a
``top-down first-fit'' procedure. This is a little tricky, so the reader
should pay close attention: The \\{trie\_hash} array is cleared to zero
again and renamed \\{trie\_ref} for this phase of the operation; later on,
$\\{trie\_ref}[\|p]$ will be nonzero only if the linked trie node \|p is the
smallest character
in a family and if the characters \|c of that family have been allocated to
locations $\\{trie\_ref}[\|p]+\|c$ in the \\{trie} array. Locations of \\{trie}
that
are in use will have $\\{trie\_link}=0$, while the unused holes in \\{trie}
will be doubly linked with \\{trie\_link} pointing to the next larger vacant
location and \\{trie\_back} pointing to the next smaller one. This double
linking will have been carried out only as far as \\{trie\_max}, where
\\{trie\_max} is the largest index of \\{trie} that will be needed.
To save time at the low end of the trie, we maintain array entries
$\\{trie\_min}[\|c]$ pointing to the smallest hole that is greater than~\|c.
Another array \\{trie\_taken} tells whether or not a given location is
equal to $\\{trie\_ref}[\|p]$ for some \|p; this array is used to ensure that
distinct nodes in the compressed trie will have distinct \\{trie\_ref}
entries.

\Y\P\D \37$\\{trie\_ref}\S\\{trie\_hash}$\C{where linked trie families go into %
\\{trie}}\par
\P\D \37$\\{trie\_back}(\#)\S\\{trie}[\#].\\{lh}$\C{backward links in \\{trie}
holes}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\&{init} \37\\{trie\_taken}: \37\&{packed} \37\&{array} $[1\to\\{trie\_size}]$ %
\1\&{of}\5
\\{boolean};\C{does a family start here?}\2\6
\4\hbox{\hskip10pt}\\{trie\_min}: \37\&{array} $[\\{ASCII\_code}]$ \1\&{of}\5
\\{trie\_pointer};\C{the first possible slot for each character}\2\6
\4\hbox{\hskip10pt}\\{trie\_max}: \37\\{trie\_pointer};\C{largest location used
in \\{trie}}\6
\4\hbox{\hskip10pt}\\{trie\_not\_ready}: \37\\{boolean};\C{is the trie still in
linked form?}\6
\&{tini}\par
\fi

\M1128. Each time \.{\\patterns} appears, it contributes further patterns to
the future trie, which will be built only when hyphenation is attempted or
when a format file is dumped. The boolean variable \\{trie\_not\_ready}
will change to \\{false} when the trie is compressed; this will disable
further patterns.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{trie\_not\_ready}\K\\{true}$;\5
$\\{trie\_root}\K0$;\5
$\\{trie\_c}[0]\K\\{si}(0)$;\5
$\\{trie\_ptr}\K0$;\par
\fi

\M1129. Here is how the trie-compression data structures are initialized.
If storage is tight, it would be possible to overlap \\{trie\_op\_hash},
\\{trie\_op\_lang}, and \\{trie\_op\_val} with \\{trie}, \\{trie\_hash}, and %
\\{trie\_taken},
because we finish with the former just before we need the latter.

\Y\P$\4\X1129:Get ready to compress the trie\X\S$\6
\X1122:Sort \(t)the hyphenation op tables into proper order\X;\6
\&{for} $\|p\K0\mathrel{\&{to}}\\{trie\_size}$ \1\&{do}\5
$\\{trie\_hash}[\|p]\K0$;\2\6
$\\{hyph\_root}\K\\{compress\_trie}(\\{hyph\_root})$;\5
$\\{trie\_root}\K\\{compress\_trie}(\\{trie\_root})$;\C{identify equivalent
subtries}\6
\&{for} $\|p\K0\mathrel{\&{to}}\\{trie\_ptr}$ \1\&{do}\5
$\\{trie\_ref}[\|p]\K0$;\2\6
\&{for} $\|p\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{trie\_min}[\|p]\K\|p+1$;\2\6
$\\{trie\_link}(0)\K1$;\5
$\\{trie\_max}\K0$\par
\U1143.\fi

\M1130. The \\{first\_fit} procedure finds the smallest hole \|z in \\{trie}
such that
a trie family starting at a given node \|p will fit into vacant positions
starting at \|z. If $\|c=\\{trie\_c}[\|p]$, this means that location $\|z-\|c$
must
not already be taken by some other family, and that $\|z-\|c+\hbox{$c^\prime$}$
must be vacant for all characters $c^\prime$ in the family. The procedure
sets $\\{trie\_ref}[\|p]$ to $\|z-\|c$ when the first fit has been found.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{first\_fit}(\|p:\\{trie\_pointer})$;\C{packs a
family into \\{trie}}\6
\4\&{label} \37$\\{not\_found},\39\\{found}$;\6
\4\&{var} \37\|h: \37\\{trie\_pointer};\C{candidate for $\\{trie\_ref}[\|p]$}\6
\|z: \37\\{trie\_pointer};\C{runs through holes}\6
\|q: \37\\{trie\_pointer};\C{runs through the family starting at \|p}\6
\|c: \37\\{ASCII\_code};\C{smallest character in the family}\6
$\|l,\39\|r$: \37\\{trie\_pointer};\C{left and right neighbors}\6
\\{ll}: \37$1\to256$;\C{upper limit of \\{trie\_min} updating}\2\6
\&{begin} \37$\|c\K\\{so}(\\{trie\_c}[\|p])$;\5
$\|z\K\\{trie\_min}[\|c]$;\C{get the first conceivably good hole}\6
\~ \1\&{loop}\ \&{begin} \37$\|h\K\|z-\|c$;\6
\X1131:Ensure that $\\{trie\_max}\G\|h+256$\X;\6
\&{if} $\\{trie\_taken}[\|h]$ \1\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\X1132:If all characters of the family fit relative to \|h, then \&{goto} %
\\{found},\30\ otherwise \&{goto} \\{not\_found}\X;\6
\4\\{not\_found}: \37$\|z\K\\{trie\_link}(\|z)$;\C{move to the next hole}\6
\&{end};\2\6
\4\\{found}: \37\X1133:Pack the family into \\{trie} relative to \|h\X;\6
\&{end};\par
\fi

\M1131. By making sure that \\{trie\_max} is at least $\|h+256$, we can be sure
that
$\\{trie\_max}>\|z$, since $\|h=\|z-\|c$. It follows that location \\{trie%
\_max} will
never be occupied in \\{trie}, and we will have $\\{trie\_max}\G\\{trie\_link}(%
\|z)$.

\Y\P$\4\X1131:Ensure that $\\{trie\_max}\G\|h+256$\X\S$\6
\&{if} $\\{trie\_max}<\|h+256$ \1\&{then}\6
\&{begin} \37\&{if} $\\{trie\_size}\L\|h+256$ \1\&{then}\5
$\\{overflow}(\.{"pattern\ memory"},\39\\{trie\_size})$;\2\6
\1\&{repeat} \37$\\{incr}(\\{trie\_max})$;\5
$\\{trie\_taken}[\\{trie\_max}]\K\\{false}$;\5
$\\{trie\_link}(\\{trie\_max})\K\\{trie\_max}+1$;\5
$\\{trie\_back}(\\{trie\_max})\K\\{trie\_max}-1$;\6
\4\&{until}\5
$\\{trie\_max}=\|h+256$;\2\6
\&{end}\2\par
\U1130.\fi

\M1132. \P$\X1132:If all characters of the family fit relative to \|h, then %
\&{goto} \\{found},\30\ otherwise \&{goto} \\{not\_found}\X\S$\6
$\|q\K\\{trie\_r}[\|p]$;\6
\&{while} $\|q>0$ \1\&{do}\6
\&{begin} \37\&{if} $\\{trie\_link}(\|h+\\{so}(\\{trie\_c}[\|q]))=0$ \1\&{then}%
\5
\&{goto} \37\\{not\_found};\2\6
$\|q\K\\{trie\_r}[\|q]$;\6
\&{end};\2\6
\&{goto} \37\\{found}\par
\U1130.\fi

\M1133. \P$\X1133:Pack the family into \\{trie} relative to \|h\X\S$\6
$\\{trie\_taken}[\|h]\K\\{true}$;\5
$\\{trie\_ref}[\|p]\K\|h$;\5
$\|q\K\|p$;\6
\1\&{repeat} \37$\|z\K\|h+\\{so}(\\{trie\_c}[\|q])$;\5
$\|l\K\\{trie\_back}(\|z)$;\5
$\|r\K\\{trie\_link}(\|z)$;\5
$\\{trie\_back}(\|r)\K\|l$;\5
$\\{trie\_link}(\|l)\K\|r$;\5
$\\{trie\_link}(\|z)\K0$;\6
\&{if} $\|l<256$ \1\&{then}\6
\&{begin} \37\&{if} $\|z<256$ \1\&{then}\5
$\\{ll}\K\|z$\ \&{else} $\\{ll}\K256$;\2\6
\1\&{repeat} \37$\\{trie\_min}[\|l]\K\|r$;\5
$\\{incr}(\|l)$;\6
\4\&{until}\5
$\|l=\\{ll}$;\2\6
\&{end};\2\6
$\|q\K\\{trie\_r}[\|q]$;\6
\4\&{until}\5
$\|q=0$\2\par
\U1130.\fi

\M1134. To pack the entire linked trie, we use the following recursive
procedure.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{trie\_pack}(\|p:\\{trie\_pointer})$;\C{pack subtries
of a family}\6
\4\&{var} \37\|q: \37\\{trie\_pointer};\C{a local variable that need not be
saved on recursive calls}\2\6
\&{begin} \37\1\&{repeat} \37$\|q\K\\{trie\_l}[\|p]$;\6
\&{if} $(\|q>0)\W(\\{trie\_ref}[\|q]=0)$ \1\&{then}\6
\&{begin} \37$\\{first\_fit}(\|q)$;\5
$\\{trie\_pack}(\|q)$;\6
\&{end};\2\6
$\|p\K\\{trie\_r}[\|p]$;\6
\4\&{until}\5
$\|p=0$;\2\6
\&{end};\par
\fi

\M1135. When the whole trie has been allocated into the sequential table, we
must go through it once again so that \\{trie} contains the correct
information. Null pointers in the linked trie will be represented by the
value~0, which properly implements an ``empty'' family.

\Y\P$\4\X1135:Move the data into \\{trie}\X\S$\6
$\|h.\\{rh}\K0$;\5
$\|h.\\{b0}\K\\{min\_quarterword}$;\5
$\|h.\\{b1}\K\\{min\_quarterword}$;\C{$\\{trie\_link}\K0$,   $\\{trie\_op}\K%
\\{min\_quarterword}$, $\\{trie\_char}\K\\{qi}(0)$}\6
\&{if} $\\{trie\_max}=0$ \1\&{then}\C{no patterns were given}\6
\&{begin} \37\&{for} $\|r\K0\mathrel{\&{to}}256$ \1\&{do}\5
$\\{trie}[\|r]\K\|h$;\2\6
$\\{trie\_max}\K256$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{hyph\_root}>0$ \1\&{then}\5
$\\{trie\_fix}(\\{hyph\_root})$;\2\6
\&{if} $\\{trie\_root}>0$ \1\&{then}\5
$\\{trie\_fix}(\\{trie\_root})$;\C{this fixes the non-holes in \\{trie}}\2\6
$\|r\K0$;\C{now we will zero out all the holes}\6
\1\&{repeat} \37$\|s\K\\{trie\_link}(\|r)$;\5
$\\{trie}[\|r]\K\|h$;\5
$\|r\K\|s$;\6
\4\&{until}\5
$\|r>\\{trie\_max}$;\2\6
\&{end};\2\6
$\\{trie\_char}(0)\K\\{qi}(\.{"?"})$;\C{make $\\{trie\_char}(\|c)\I\|c$ for all
\|c}\par
\U1143.\fi

\M1136. The fixing-up procedure is, of course, recursive. Since the linked trie
usually has overlapping subtries, the same data may be moved several
times; but that causes no harm, and at most as much work is done as it
took to build the uncompressed trie.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{trie\_fix}(\|p:\\{trie\_pointer})$;\C{moves \|p and
its siblings into \\{trie}}\6
\4\&{var} \37\|q: \37\\{trie\_pointer};\C{a local variable that need not be
saved on recursive calls}\6
\|c: \37\\{ASCII\_code};\C{another one that need not be saved}\6
\|z: \37\\{trie\_pointer};\C{\\{trie} reference; this local variable must be
saved}\2\6
\&{begin} \37$\|z\K\\{trie\_ref}[\|p]$;\6
\1\&{repeat} \37$\|q\K\\{trie\_l}[\|p]$;\5
$\|c\K\\{so}(\\{trie\_c}[\|p])$;\5
$\\{trie\_link}(\|z+\|c)\K\\{trie\_ref}[\|q]$;\5
$\\{trie\_char}(\|z+\|c)\K\\{qi}(\|c)$;\5
$\\{trie\_op}(\|z+\|c)\K\\{trie\_o}[\|p]$;\6
\&{if} $\|q>0$ \1\&{then}\5
$\\{trie\_fix}(\|q)$;\2\6
$\|p\K\\{trie\_r}[\|p]$;\6
\4\&{until}\5
$\|p=0$;\2\6
\&{end};\par
\fi

\M1137. Now let's go back to the easier problem, of building the linked
trie.  When \.{INITEX} has scanned the `\.{\\patterns}' control
sequence, it calls on \\{new\_patterns} to do the right thing.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{new\_patterns};\C{initializes the hyphenation pattern
data}\6
\4\&{label} \37$\\{done},\39\\{done1}$;\6
\4\&{var} \37$\|k,\39\|l$: \37$0\to64$;\C{indices into \\{hc} and \\{hyf};
             not always in \\{small\_number} range}\6
\\{digit\_sensed}: \37\\{boolean};\C{should the next digit be treated as a
letter?}\6
\|v: \37\\{quarterword};\C{trie op code}\6
$\|p,\39\|q$: \37\\{trie\_pointer};\C{nodes of trie traversed during insertion}%
\6
\\{first\_child}: \37\\{boolean};\C{is $\|p=\\{trie\_l}[\|q]$?}\6
\|c: \37\\{ASCII\_code};\C{character being inserted}\2\6
\&{begin} \37\&{if} $\\{trie\_not\_ready}$ \1\&{then}\6
\&{begin} \37\\{set\_cur\_lang};\5
\\{scan\_left\_brace};\C{a left brace must follow \.{\\patterns}}\6
\X1138:Enter all of the patterns into a linked trie, until coming to a right
brace\X;\6
\&{if} $\\{saving\_hyph\_codes}>0$ \1\&{then}\5
\X1855:Store hyphenation codes for current language\X;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Too\ late\ for\ "})$;\5
$\\{print\_esc}(\.{"patterns"})$;\5
$\\{help1}(\.{"All\ patterns\ must\ be\ given\ before\ typesetting\
begins."})$;\5
\\{error};\5
$\\{link}(\\{garbage})\K\\{scan\_toks}(\\{false},\39\\{false})$;\5
$\\{flush\_list}(\\{def\_ref})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1138. Novices are not supposed to be using \.{\\patterns}, so the error
messages are terse. (Note that all error messages appear in \TeX's string
pool, even if they are used only by \.{INITEX}.)

\Y\P$\4\X1138:Enter all of the patterns into a linked trie, until coming to a
right brace\X\S$\6
$\|k\K0$;\5
$\\{hyf}[0]\K0$;\5
$\\{digit\_sensed}\K\\{false}$;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_x\_token};\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4$\\{letter},\39\\{other\_char}$: \37\X1139:Append a new letter or a hyphen
level\X;\6
\4$\\{spacer},\39\\{right\_brace}$: \37\&{begin} \37\&{if} $\|k>0$ \1\&{then}\5
\X1140:Insert a new pattern into the linked trie\X;\2\6
\&{if} $\\{cur\_cmd}=\\{right\_brace}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
$\|k\K0$;\5
$\\{hyf}[0]\K0$;\5
$\\{digit\_sensed}\K\\{false}$;\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37$\\{print\_err}(\.{"Bad\ "})$;\5
$\\{print\_esc}(\.{"patterns"})$;\5
$\\{help1}(\.{"(See\ Appendix\ H.)"})$;\5
\\{error};\6
\&{end}\2\6
\&{endcases};\6
\&{end};\2\6
\4\\{done}: \37\par
\U1137.\fi

\M1139. \P$\X1139:Append a new letter or a hyphen level\X\S$\6
\&{if} $\\{digit\_sensed}\V(\\{cur\_chr}<\.{"0"})\V(\\{cur\_chr}>\.{"9"})$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{cur\_chr}=\.{"."}$ \1\&{then}\5
$\\{cur\_chr}\K0$\C{edge-of-word delimiter}\6
\4\&{else} \&{begin} \37$\\{cur\_chr}\K\\{lc\_code}(\\{cur\_chr})$;\6
\&{if} $\\{cur\_chr}=0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Nonletter"})$;\5
$\\{help1}(\.{"(See\ Appendix\ H.)"})$;\5
\\{error};\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\|k<63$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|k)$;\5
$\\{hc}[\|k]\K\\{cur\_chr}$;\5
$\\{hyf}[\|k]\K0$;\5
$\\{digit\_sensed}\K\\{false}$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\|k<63$ \1\&{then}\6
\&{begin} \37$\\{hyf}[\|k]\K\\{cur\_chr}-\.{"0"}$;\5
$\\{digit\_sensed}\K\\{true}$;\6
\&{end}\2\2\par
\U1138.\fi

\M1140. When the following code comes into play, the pattern $p_1\ldots p_k$
appears in $\\{hc}[1\to\|k]$, and the corresponding sequence of numbers $n_0%
\ldots
n_k$ appears in $\\{hyf}[0\to\|k]$.

\Y\P$\4\X1140:Insert a new pattern into the linked trie\X\S$\6
\&{begin} \37\X1142:Compute the trie op code, \|v, and set $\|l\K0$\X;\6
$\|q\K0$;\5
$\\{hc}[0]\K\\{cur\_lang}$;\6
\&{while} $\|l\L\|k$ \1\&{do}\6
\&{begin} \37$\|c\K\\{hc}[\|l]$;\5
$\\{incr}(\|l)$;\5
$\|p\K\\{trie\_l}[\|q]$;\5
$\\{first\_child}\K\\{true}$;\6
\&{while} $(\|p>0)\W(\|c>\\{so}(\\{trie\_c}[\|p]))$ \1\&{do}\6
\&{begin} \37$\|q\K\|p$;\5
$\|p\K\\{trie\_r}[\|q]$;\5
$\\{first\_child}\K\\{false}$;\6
\&{end};\2\6
\&{if} $(\|p=0)\V(\|c<\\{so}(\\{trie\_c}[\|p]))$ \1\&{then}\5
\X1141:Insert a new trie node between \|q and \|p, and make \|p point to it\X;%
\2\6
$\|q\K\|p$;\C{now node \|q represents $p_1\ldots p_{l-1}$}\6
\&{end};\2\6
\&{if} $\\{trie\_o}[\|q]\I\\{min\_quarterword}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Duplicate\ pattern"})$;\5
$\\{help1}(\.{"(See\ Appendix\ H.)"})$;\5
\\{error};\6
\&{end};\2\6
$\\{trie\_o}[\|q]\K\|v$;\6
\&{end}\par
\U1138.\fi

\M1141. \P$\X1141:Insert a new trie node between \|q and \|p, and make \|p
point to it\X\S$\6
\&{begin} \37\&{if} $\\{trie\_ptr}=\\{trie\_size}$ \1\&{then}\5
$\\{overflow}(\.{"pattern\ memory"},\39\\{trie\_size})$;\2\6
$\\{incr}(\\{trie\_ptr})$;\5
$\\{trie\_r}[\\{trie\_ptr}]\K\|p$;\5
$\|p\K\\{trie\_ptr}$;\5
$\\{trie\_l}[\|p]\K0$;\6
\&{if} $\\{first\_child}$ \1\&{then}\5
$\\{trie\_l}[\|q]\K\|p$\ \&{else} $\\{trie\_r}[\|q]\K\|p$;\2\6
$\\{trie\_c}[\|p]\K\\{si}(\|c)$;\5
$\\{trie\_o}[\|p]\K\\{min\_quarterword}$;\6
\&{end}\par
\Us1140, 1855\ETs1856.\fi

\M1142. \P$\X1142:Compute the trie op code, \|v, and set $\|l\K0$\X\S$\6
\&{if} $\\{hc}[1]=0$ \1\&{then}\5
$\\{hyf}[0]\K0$;\2\6
\&{if} $\\{hc}[\|k]=0$ \1\&{then}\5
$\\{hyf}[\|k]\K0$;\2\6
$\|l\K\|k$;\5
$\|v\K\\{min\_quarterword}$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{hyf}[\|l]\I0$ \1\&{then}\5
$\|v\K\\{new\_trie\_op}(\|k-\|l,\39\\{hyf}[\|l],\39\|v)$;\2\6
\&{if} $\|l>0$ \1\&{then}\5
$\\{decr}(\|l)$\ \&{else} \&{goto} \37\\{done1};\2\6
\&{end};\2\6
\4\\{done1}: \37\par
\U1140.\fi

\M1143. Finally we put everything together: Here is how the trie gets to its
final, efficient form.
The following packing routine is rigged so that the root of the linked
tree gets mapped into location 1 of \\{trie}, as required by the hyphenation
algorithm. This happens because the first call of \\{first\_fit} will
``take'' location~1.

\Y\P$\4\X1121:Declare procedures for preprocessing hyphenation patterns\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{init\_trie};\6
\4\&{var} \37\|p: \37\\{trie\_pointer};\C{pointer for initialization}\6
$\|j,\39\|k,\39\|t$: \37\\{integer};\C{all-purpose registers for
initialization}\6
$\|r,\39\|s$: \37\\{trie\_pointer};\C{used to clean up the packed \\{trie}}\6
\|h: \37\\{two\_halves};\C{template used to zero out \\{trie}'s holes}\2\6
\&{begin} \37\X1129:Get ready to compress the trie\X;\6
\&{if} $\\{trie\_root}\I0$ \1\&{then}\6
\&{begin} \37$\\{first\_fit}(\\{trie\_root})$;\5
$\\{trie\_pack}(\\{trie\_root})$;\6
\&{end};\2\6
\&{if} $\\{hyph\_root}\I0$ \1\&{then}\5
\X1857:Pack all stored \\{hyph\_codes}\X;\2\6
\X1135:Move the data into \\{trie}\X;\6
$\\{trie\_not\_ready}\K\\{false}$;\6
\&{end};\par
\fi

\N1144.  \[44] Breaking vertical lists into pages.
The \\{vsplit} procedure, which implements \TeX's \.{\\vsplit} operation,
is considerably simpler than \\{line\_break} because it doesn't have to
worry about hyphenation, and because its mission is to discover a single
break instead of an optimum sequence of breakpoints.  But before we get
into the details of \\{vsplit}, we need to consider a few more basic things.

\fi

\M1145. A subroutine called \\{prune\_page\_top} takes a pointer to a vlist and
returns a pointer to a modified vlist in which all glue, kern, and penalty
nodes
have been deleted before the first box or rule node. However, the first
box or rule is actually preceded by a newly created glue node designed so that
the topmost baseline will be at distance \\{split\_top\_skip} from the top,
whenever this is possible without backspacing.

When the second argument \|s is \\{false} the deleted nodes are destroyed,
otherwise they are collected in a list starting at \\{split\_disc}.

In this routine and those that follow, we make use of the fact that a
vertical list contains no character nodes, hence the \\{type} field exists
for each node in the list.

\Y\P\D \37$\\{discard\_or\_move}=60$\par
\Y\P\4\&{function}\1\  \37$\\{prune\_page\_top}(\|p:\\{pointer};\,\35\|s:%
\\{boolean})$: \37\\{pointer};\6
\4\&{label} \37\\{discard\_or\_move};\C{adjust top after page break}\6
\4\&{var} \37\\{prev\_p}: \37\\{pointer};\C{lags one step behind \|p}\6
$\|q,\39\|r$: \37\\{pointer};\C{temporary variables for list manipulation}\2\6
\&{begin} \37$\\{prev\_p}\K\\{temp\_head}$;\5
$\\{link}(\\{temp\_head})\K\|p$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37\X1146:Insert glue
for \\{split\_top\_skip} and set~$\|p\K\\{null}$\X;\6
\4$\\{whatsit\_node},\39\\{mark\_node},\39\\{ins\_node}$: \37\&{begin} \37%
\&{if} $(\\{type}(\|p)=\\{whatsit\_node})\W((\\{subtype}(\|p)=\\{pdf\_snapy%
\_node})\V(\\{subtype}(\|p)=\\{pdf\_snapy\_comp\_node}))$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"snap\ node\ being\ discarded"})$;\5
\&{goto} \37\\{discard\_or\_move};\6
\&{end};\2\6
$\\{prev\_p}\K\|p$;\5
$\|p\K\\{link}(\\{prev\_p})$;\6
\&{end};\6
\4$\\{glue\_node},\39\\{kern\_node},\39\\{penalty\_node}$: \37\&{begin} \37%
\\{discard\_or\_move}: \37$\B\\{print}(\.{"discard\_or\_move:\ "})$;\5
$\\{show\_node\_list}(\|p)$;\5
\\{print\_ln};\5
$\T\|q\K\|p$;\5
$\|p\K\\{link}(\|q)$;\5
$\\{link}(\|q)\K\\{null}$;\5
$\\{link}(\\{prev\_p})\K\|p$;\6
\&{if} $\|s$ \1\&{then}\6
\&{begin} \37\&{if} $\\{split\_disc}=\\{null}$ \1\&{then}\5
$\\{split\_disc}\K\|q$\ \&{else} $\\{link}(\|r)\K\|q$;\2\6
$\|r\K\|q$;\6
\&{end}\6
\4\&{else} $\\{flush\_node\_list}(\|q)$;\2\6
\&{end};\6
\4\&{othercases} \37$\\{confusion}(\.{"pruning"})$\2\6
\&{endcases};\2\6
$\\{prune\_page\_top}\K\\{link}(\\{temp\_head})$;\6
\&{end};\par
\fi

\M1146. \P$\X1146:Insert glue for \\{split\_top\_skip} and set~$\|p\K\\{null}$%
\X\S$\6
\&{begin} \37$\|q\K\\{new\_skip\_param}(\\{split\_top\_skip\_code})$;\5
$\\{link}(\\{prev\_p})\K\|q$;\5
$\\{link}(\|q)\K\|p$;\C{now $\\{temp\_ptr}=\\{glue\_ptr}(\|q)$}\6
\&{if} $\\{width}(\\{temp\_ptr})>\\{height}(\|p)$ \1\&{then}\5
$\\{width}(\\{temp\_ptr})\K\\{width}(\\{temp\_ptr})-\\{height}(\|p)$\6
\4\&{else} $\\{width}(\\{temp\_ptr})\K0$;\2\6
$\|p\K\\{null}$;\6
\&{end}\par
\U1145.\fi

\M1147. The next subroutine finds the best place to break a given vertical list
so as to obtain a box of height~\|h, with maximum depth~\|d.
A pointer to the beginning of the vertical list is given,
and a pointer to the optimum breakpoint is returned. The list is effectively
followed by a forced break, i.e., a penalty node with the \\{eject\_penalty};
if the best break occurs at this artificial node, the value \\{null} is
returned.

An array of six \\{scaled} distances is used to keep track of the height
from the beginning of the list to the current place, just as in \\{line%
\_break}.
In fact, we use one of the same arrays, only changing its name to reflect
its new significance.

\Y\P\D \37$\\{active\_height}\S\\{active\_width}$\C{new name for the six
distance variables}\par
\P\D \37$\\{cur\_height}\S\\{active\_height}[1]$\C{the natural height}\par
\P\D \37$\\{set\_height\_zero}(\#)\S\\{active\_height}[\#]\K0$\C{initialize the
height to zero}\Y\par
\P\D \37$\\{update\_heights}=90$\C{go here to record glue in the \\{active%
\_height} table}\par
\Y\P\4\&{function}\1\  \37$\\{vert\_break}(\|p:\\{pointer};\,\35\|h,\39\|d:%
\\{scaled})$: \37\\{pointer};\C{finds optimum page break}\6
\4\&{label} \37$\\{done},\39\\{not\_found},\39\\{update\_heights}$;\6
\4\&{var} \37\\{prev\_p}: \37\\{pointer};\C{if \|p is a glue node, $\\{type}(%
\\{prev\_p})$ determines   whether \|p is a legal breakpoint}\6
$\|q,\39\|r$: \37\\{pointer};\C{glue specifications}\6
\\{pi}: \37\\{integer};\C{penalty value}\6
\|b: \37\\{integer};\C{badness at a trial breakpoint}\6
\\{least\_cost}: \37\\{integer};\C{the smallest badness plus penalties found so
far}\6
\\{best\_place}: \37\\{pointer};\C{the most recent break that leads to \\{least%
\_cost}}\6
\\{prev\_dp}: \37\\{scaled};\C{depth of previous box in the list}\6
\|t: \37\\{small\_number};\C{\\{type} of the node following a kern}\2\6
\&{begin} \37$\\{prev\_p}\K\|p$;\C{an initial glue node is not a legal
breakpoint}\6
$\\{least\_cost}\K\\{awful\_bad}$;\5
$\\{do\_all\_six}(\\{set\_height\_zero})$;\5
$\\{prev\_dp}\K0$;\6
\~ \1\&{loop}\ \&{begin} \37\X1149:If node \|p is a legal breakpoint, check if
this break is the best known, and \&{goto} \\{done} if \|p is null or if the
page-so-far is already too full to accept more stuff\X;\6
$\\{prev\_p}\K\|p$;\5
$\|p\K\\{link}(\\{prev\_p})$;\6
\&{end};\2\6
\4\\{done}: \37$\\{vert\_break}\K\\{best\_place}$;\6
\&{end};\par
\fi

\M1148. A global variable \\{best\_height\_plus\_depth} will be set to the
natural size
of the box that corresponds to the optimum breakpoint found by \\{vert\_break}.
(This value is used by the insertion-splitting algorithm of the page builder.)

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{best\_height\_plus\_depth}: \37\\{scaled};\C{height of the best box,
without stretching or   shrinking}\par
\fi

\M1149. A subtle point to be noted here is that the maximum depth~\|d might be
negative, so \\{cur\_height} and \\{prev\_dp} might need to be corrected even
after a glue or kern node.

\Y\P$\4\X1149:If node \|p is a legal breakpoint, check if this break is the
best known, and \&{goto} \\{done} if \|p is null or if the page-so-far is
already too full to accept more stuff\X\S$\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{pi}\K\\{eject\_penalty}$\6
\4\&{else} \X1150:Use node \|p to update the current height and depth
measurements; if this node is not a legal breakpoint, \&{goto} \\{not\_found}
or \\{update\_heights}, otherwise set \\{pi} to the associated penalty at the
break\X;\2\6
\X1151:Check if node \|p is a new champion breakpoint; then \(go)\&{goto} %
\\{done} if \|p is a forced break or if the page-so-far is already too full\X;\6
\&{if} $(\\{type}(\|p)<\\{glue\_node})\V(\\{type}(\|p)>\\{kern\_node})$ \1%
\&{then}\5
\&{goto} \37\\{not\_found};\2\6
\4\\{update\_heights}: \37\X1153:Update the current height and depth
measurements with respect to a glue or kern node~\|p\X;\6
\4\\{not\_found}: \37\&{if} $\\{prev\_dp}>\|d$ \1\&{then}\6
\&{begin} \37$\\{cur\_height}\K\\{cur\_height}+\\{prev\_dp}-\|d$;\5
$\\{prev\_dp}\K\|d$;\6
\&{end};\2\par
\U1147.\fi

\M1150. \P$\X1150:Use node \|p to update the current height and depth
measurements; if this node is not a legal breakpoint, \&{goto} \\{not\_found}
or \\{update\_heights}, otherwise set \\{pi} to the associated penalty at the
break\X\S$\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37\&{begin} \37%
\hbox{}\6
$\\{cur\_height}\K\\{cur\_height}+\\{prev\_dp}+\\{height}(\|p)$;\5
$\\{prev\_dp}\K\\{depth}(\|p)$;\5
\&{goto} \37\\{not\_found};\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1612:Process whatsit \|p in \\{vert\_break} loop, %
\&{goto} \\{not\_found}\X;\6
\4\\{glue\_node}: \37\&{if} $\\{precedes\_break}(\\{prev\_p})$ \1\&{then}\5
$\\{pi}\K0$\6
\4\&{else} \&{goto} \37\\{update\_heights};\2\6
\4\\{kern\_node}: \37\&{begin} \37\&{if} $\\{link}(\|p)=\\{null}$ \1\&{then}\5
$\|t\K\\{penalty\_node}$\6
\4\&{else} $\|t\K\\{type}(\\{link}(\|p))$;\2\6
\&{if} $\|t=\\{glue\_node}$ \1\&{then}\5
$\\{pi}\K0$\ \&{else} \&{goto} \37\\{update\_heights};\2\6
\&{end};\6
\4\\{penalty\_node}: \37$\\{pi}\K\\{penalty}(\|p)$;\6
\4$\\{mark\_node},\39\\{ins\_node}$: \37\&{goto} \37\\{not\_found};\6
\4\&{othercases} \37$\\{confusion}(\.{"vertbreak"})$\2\6
\&{endcases}\par
\U1149.\fi

\M1151. \P\D \37$\\{deplorable}\S100000$\C{more than \\{inf\_bad}, but less
than \\{awful\_bad}}\par
\Y\P$\4\X1151:Check if node \|p is a new champion breakpoint; then \(go)%
\&{goto} \\{done} if \|p is a forced break or if the page-so-far is already too
full\X\S$\6
\&{if} $\\{pi}<\\{inf\_penalty}$ \1\&{then}\6
\&{begin} \37\X1152:Compute the badness, \|b, using \\{awful\_bad} if the box
is too full\X;\6
\&{if} $\|b<\\{awful\_bad}$ \1\&{then}\6
\&{if} $\\{pi}\L\\{eject\_penalty}$ \1\&{then}\5
$\|b\K\\{pi}$\6
\4\&{else} \&{if} $\|b<\\{inf\_bad}$ \1\&{then}\5
$\|b\K\|b+\\{pi}$\6
\4\&{else} $\|b\K\\{deplorable}$;\2\2\2\6
\&{if} $\|b\L\\{least\_cost}$ \1\&{then}\6
\&{begin} \37$\\{best\_place}\K\|p$;\5
$\\{least\_cost}\K\|b$;\5
$\\{best\_height\_plus\_depth}\K\\{cur\_height}+\\{prev\_dp}$;\6
\&{end};\2\6
\&{if} $(\|b=\\{awful\_bad})\V(\\{pi}\L\\{eject\_penalty})$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\&{end}\2\par
\U1149.\fi

\M1152. \P$\X1152:Compute the badness, \|b, using \\{awful\_bad} if the box is
too full\X\S$\6
\&{if} $\\{cur\_height}<\|h$ \1\&{then}\6
\&{if} $(\\{active\_height}[3]\I0)\V(\\{active\_height}[4]\I0)\V(\\{active%
\_height}[5]\I0)$ \1\&{then}\5
$\|b\K0$\6
\4\&{else} $\|b\K\\{badness}(\|h-\\{cur\_height},\39\\{active\_height}[2])$\2\6
\4\&{else} \&{if} $\\{cur\_height}-\|h>\\{active\_height}[6]$ \1\&{then}\5
$\|b\K\\{awful\_bad}$\6
\4\&{else} $\|b\K\\{badness}(\\{cur\_height}-\|h,\39\\{active\_height}[6])$\2\2%
\par
\U1151.\fi

\M1153. Vertical lists that are subject to the \\{vert\_break} procedure should
not
contain infinite shrinkability, since that would permit any amount of
information to ``fit'' on one page.

\Y\P$\4\X1153:Update the current height and depth measurements with respect to
a glue or kern node~\|p\X\S$\6
\&{if} $\\{type}(\|p)=\\{kern\_node}$ \1\&{then}\5
$\|q\K\|p$\6
\4\&{else} \&{begin} \37$\|q\K\\{glue\_ptr}(\|p)$;\5
$\\{active\_height}[2+\\{stretch\_order}(\|q)]\K\30\\{active\_height}[2+%
\\{stretch\_order}(\|q)]+\\{stretch}(\|q)$;\6
$\\{active\_height}[6]\K\\{active\_height}[6]+\\{shrink}(\|q)$;\6
\&{if} $(\\{shrink\_order}(\|q)\I\\{normal})\W(\\{shrink}(\|q)\I0)$ \1\&{then}\6
\&{begin} \37\hbox{}\6
$\\{print\_err}(\.{"Infinite\ glue\ shrinkage\ found\ in\ box\ being\
split"})$;\6
$\\{help4}(\.{"The\ box\ you\ are\ \\vsplitting\ contains\ some\ infinitely"})$%
\6
$(\.{"shrinkable\ glue,\ e.g.,\ \`\\vss\'\ or\ \`\\vskip\ 0pt\ minus\ 1fil%
\'."})$\6
$(\.{"Such\ glue\ doesn\'t\ belong\ there;\ but\ you\ can\ safely\ proceed,"})$%
\6
$(\.{"since\ the\ offensive\ shrinkability\ has\ been\ made\ finite."})$;\5
\\{error};\5
$\|r\K\\{new\_spec}(\|q)$;\5
$\\{shrink\_order}(\|r)\K\\{normal}$;\5
$\\{delete\_glue\_ref}(\|q)$;\5
$\\{glue\_ptr}(\|p)\K\|r$;\5
$\|q\K\|r$;\6
\&{end};\2\6
\&{end};\2\6
$\\{cur\_height}\K\\{cur\_height}+\\{prev\_dp}+\\{width}(\|q)$;\5
$\\{prev\_dp}\K0$\par
\U1149.\fi

\M1154. Now we are ready to consider \\{vsplit} itself. Most of
its work is accomplished by the two subroutines that we have just considered.

Given the number of a vlist box \|n, and given a desired page height \|h,
the \\{vsplit} function finds the best initial segment of the vlist and
returns a box for a page of height~\|h. The remainder of the vlist, if
any, replaces the original box, after removing glue and penalties and
adjusting for \\{split\_top\_skip}. Mark nodes in the split-off box are used to
set the values of \\{split\_first\_mark} and \\{split\_bot\_mark}; we use the
fact that $\\{split\_first\_mark}=\\{null}$ if and only if $\\{split\_bot%
\_mark}=\\{null}$.

The original box becomes ``void'' if and only if it has been entirely
extracted.  The extracted box is ``void'' if and only if the original
box was void (or if it was, erroneously, an hlist box).

\Y\P\hbox{\4}\X1825:Declare the function called \\{do\_marks}\X\6
\4\&{function}\1\  \37$\\{vsplit}(\|n:\\{halfword};\,\35\|h:\\{scaled})$: \37%
\\{pointer};\C{extracts a page of height \|h from box \|n}\6
\4\&{label} \37$\\{exit},\39\\{done}$;\6
\4\&{var} \37\|v: \37\\{pointer};\C{the box to be split}\6
\|p: \37\\{pointer};\C{runs through the vlist}\6
\|q: \37\\{pointer};\C{points to where the break occurs}\2\6
\&{begin} \37$\\{cur\_val}\K\|n$;\5
$\\{fetch\_box}(\|v)$;\5
$\\{flush\_node\_list}(\\{split\_disc})$;\5
$\\{split\_disc}\K\\{null}$;\6
\&{if} $\\{sa\_mark}\I\\{null}$ \1\&{then}\6
\&{if} $\\{do\_marks}(\\{vsplit\_init},\390,\39\\{sa\_mark})$ \1\&{then}\5
$\\{sa\_mark}\K\\{null}$;\2\2\6
\&{if} $\\{split\_first\_mark}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{delete\_token\_ref}(\\{split\_first\_mark})$;\5
$\\{split\_first\_mark}\K\\{null}$;\5
$\\{delete\_token\_ref}(\\{split\_bot\_mark})$;\5
$\\{split\_bot\_mark}\K\\{null}$;\6
\&{end};\2\6
\X1155:Dispense with trivial cases of void or bad boxes\X;\6
$\|q\K\\{vert\_break}(\\{list\_ptr}(\|v),\39\|h,\39\\{split\_max\_depth})$;\5
\X1156:Look at all the marks in nodes before the break, and set the final link
to \\{null} at the break\X;\6
$\|q\K\\{prune\_page\_top}(\|q,\39\\{saving\_vdiscards}>0)$;\5
$\|p\K\\{list\_ptr}(\|v)$;\5
$\\{free\_node}(\|v,\39\\{box\_node\_size})$;\6
\&{if} $\|q\I\\{null}$ \1\&{then}\5
$\|q\K\\{vpack}(\|q,\39\\{natural})$;\2\6
$\\{change\_box}(\|q)$;\C{the \\{eq\_level} of the box stays the same}\6
$\\{vsplit}\K\\{vpackage}(\|p,\39\|h,\39\\{exactly},\39\\{split\_max\_depth})$;%
\6
\4\\{exit}: \37\&{end};\par
\fi

\M1155. \P$\X1155:Dispense with trivial cases of void or bad boxes\X\S$\6
\&{if} $\|v=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{vsplit}\K\\{null}$;\5
\&{return};\6
\&{end};\2\6
\&{if} $\\{type}(\|v)\I\\{vlist\_node}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{""})$;\5
$\\{print\_esc}(\.{"vsplit"})$;\5
$\\{print}(\.{"\ needs\ a\ "})$;\5
$\\{print\_esc}(\.{"vbox"})$;\5
$\\{help2}(\.{"The\ box\ you\ are\ trying\ to\ split\ is\ an\ \\hbox."})$\6
$(\.{"I\ can\'t\ split\ such\ a\ box,\ so\ I\'ll\ leave\ it\ alone."})$;\5
\\{error};\5
$\\{vsplit}\K\\{null}$;\5
\&{return};\6
\&{end}\2\par
\U1154.\fi

\M1156. It's possible that the box begins with a penalty node that is the
``best'' break, so we must be careful to handle this special case correctly.

\Y\P$\4\X1156:Look at all the marks in nodes before the break, and set the
final link to \\{null} at the break\X\S$\6
$\|p\K\\{list\_ptr}(\|v)$;\6
\&{if} $\|p=\|q$ \1\&{then}\5
$\\{list\_ptr}(\|v)\K\\{null}$\6
\4\&{else} \~ \1\&{loop}\ \&{begin} \37\&{if} $\\{type}(\|p)=\\{mark\_node}$ \1%
\&{then}\6
\&{if} $\\{mark\_class}(\|p)\I0$ \1\&{then}\5
\X1827:Update the current marks for \\{vsplit}\X\6
\4\&{else} \&{if} $\\{split\_first\_mark}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{split\_first\_mark}\K\\{mark\_ptr}(\|p)$;\5
$\\{split\_bot\_mark}\K\\{split\_first\_mark}$;\5
$\\{token\_ref\_count}(\\{split\_first\_mark})\K\30\\{token\_ref\_count}(%
\\{split\_first\_mark})+2$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{delete\_token\_ref}(\\{split\_bot\_mark})$;\5
$\\{split\_bot\_mark}\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{split\_bot\_mark})$;\6
\&{end};\2\2\2\6
\&{if} $\\{link}(\|p)=\|q$ \1\&{then}\6
\&{begin} \37$\\{link}(\|p)\K\\{null}$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\2\6
\4\\{done}: \37\par
\U1154.\fi

\N1157.  \[45] The page builder.
When \TeX\ appends new material to its main vlist in vertical mode, it uses
a method something like \\{vsplit} to decide where a page ends, except that
the calculations are done ``on line'' as new items come in.
The main complication in this process is that insertions must be put
into their boxes and removed from the vlist, in a more-or-less optimum manner.

We shall use the term ``current page'' for that part of the main vlist that
is being considered as a candidate for being broken off and sent to the
user's output routine. The current page starts at $\\{link}(\\{page\_head})$,
and
it ends at \\{page\_tail}.  We have $\\{page\_head}=\\{page\_tail}$ if this
list is empty.

Utter chaos would reign if the user kept changing page specifications
while a page is being constructed, so the page builder keeps the pertinent
specifications frozen as soon as the page receives its first box or
insertion.  The global variable \\{page\_contents} is \\{empty} when the
current page contains only mark nodes and content-less whatsit nodes; it
is \\{inserts\_only} if the page contains only insertion nodes in addition to
marks and whatsits.  Glue nodes, kern nodes, and penalty nodes are
discarded until a box or rule node appears, at which time \\{page\_contents}
changes to \\{box\_there}.  As soon as \\{page\_contents} becomes non-%
\\{empty},
the current \\{vsize} and \\{max\_depth} are squirreled away into \\{page%
\_goal}
and \\{page\_max\_depth}; the latter values will be used until the page has
been forwarded to the user's output routine. The \.{\\topskip} adjustment
is made when \\{page\_contents} changes to \\{box\_there}.

Although \\{page\_goal} starts out equal to \\{vsize}, it is decreased by the
scaled natural height-plus-depth of the insertions considered so far, and by
the \.{\\skip} corrections for those insertions. Therefore it represents
the size into which the non-inserted material should fit, assuming that
all insertions in the current page have been made.

The global variables \\{best\_page\_break} and \\{least\_page\_cost} correspond
respectively to the local variables \\{best\_place} and \\{least\_cost} in the
\\{vert\_break} routine that we have already studied; i.e., they record the
location and value of the best place currently known for breaking the
current page. The value of \\{page\_goal} at the time of the best break is
stored in \\{best\_size}.

\Y\P\D \37$\\{inserts\_only}=1$\C{\\{page\_contents} when an insert node has
been contributed, but no boxes}\par
\P\D \37$\\{box\_there}=2$\C{\\{page\_contents} when a box or rule has been
contributed}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{page\_tail}: \37\\{pointer};\C{the final node on the current page}\6
\4\\{page\_contents}: \37$\\{empty}\to\\{box\_there}$;\C{what is on the current
page so far?}\6
\4\\{page\_max\_depth}: \37\\{scaled};\C{maximum box depth on page being built}%
\6
\4\\{best\_page\_break}: \37\\{pointer};\C{break here to get the best page
known so far}\6
\4\\{least\_page\_cost}: \37\\{integer};\C{the score for this currently best
page}\6
\4\\{best\_size}: \37\\{scaled};\C{its \\{page\_goal}}\par
\fi

\M1158. The page builder has another data structure to keep track of
insertions.
This is a list of four-word nodes, starting and ending at \\{page\_ins\_head}.
That is, the first element of the list is node $\|r\hbox{$_1$}=\\{link}(\\{page%
\_ins\_head})$;
node $r_j$ is followed by $\|r\hbox{$_{j+1}$}=\\{link}(\|r\hbox{$_j$})$; and if
there are
\|n items we have $\|r\hbox{$_{n+1}$}=\\{page\_ins\_head}$. The \\{subtype}
field of
each node in this list refers to an insertion number; for example, `\.{\\insert
250}' would correspond to a node whose \\{subtype} is $\\{qi}(250)$
(the same as the \\{subtype} field of the relevant \\{ins\_node}). These %
\\{subtype}
fields are in increasing order, and $\\{subtype}(\\{page\_ins\_head})=%
\\{qi}(255)$, so \\{page\_ins\_head} serves as a convenient sentinel
at the end of the list. A record is present for each insertion number that
appears in the current page.

The \\{type} field in these nodes distinguishes two possibilities that
might occur as we look ahead before deciding on the optimum page break.
If $\\{type}(\|r)=\\{inserting}$, then $\\{height}(\|r)$ contains the total of
the
height-plus-depth dimensions of the box and all its inserts seen so far.
If $\\{type}(\|r)=\\{split\_up}$, then no more insertions will be made into
this box,
because at least one previous insertion was too big to fit on the current
page; $\\{broken\_ptr}(\|r)$ points to the node where that insertion will be
split, if \TeX\ decides to split it, $\\{broken\_ins}(\|r)$ points to the
insertion node that was tentatively split, and $\\{height}(\|r)$ includes also
the
natural height plus depth of the part that would be split off.

In both cases, $\\{last\_ins\_ptr}(\|r)$ points to the last \\{ins\_node}
encountered for box $\\{qo}(\\{subtype}(\|r))$ that would be at least partially
inserted on the next page; and $\\{best\_ins\_ptr}(\|r)$ points to the last
such \\{ins\_node} that should actually be inserted, to get the page with
minimum badness among all page breaks considered so far. We have
$\\{best\_ins\_ptr}(\|r)=\\{null}$ if and only if no insertion for this box
should
be made to produce this optimum page.

The data structure definitions here use the fact that the \\{height} field
appears in the fourth word of a box node.

\Y\P\D \37$\\{page\_ins\_node\_size}=4$\C{number of words for a page insertion
node}\par
\P\D \37$\\{inserting}=0$\C{an insertion class that has not yet overflowed}\par
\P\D \37$\\{split\_up}=1$\C{an overflowed insertion class}\par
\P\D \37$\\{broken\_ptr}(\#)\S\\{link}(\#+1)$\C{an insertion for this class
will break here if anywhere}\par
\P\D \37$\\{broken\_ins}(\#)\S\\{info}(\#+1)$\C{this insertion might break at %
\\{broken\_ptr}}\par
\P\D \37$\\{last\_ins\_ptr}(\#)\S\\{link}(\#+2)$\C{the most recent insertion
for this \\{subtype}}\par
\P\D \37$\\{best\_ins\_ptr}(\#)\S\\{info}(\#+2)$\C{the optimum most recent
insertion}\par
\Y\P$\4\X966:Initialize the special list heads and constant nodes\X\mathrel{+}%
\S$\6
$\\{subtype}(\\{page\_ins\_head})\K\\{qi}(255)$;\5
$\\{type}(\\{page\_ins\_head})\K\\{split\_up}$;\5
$\\{link}(\\{page\_ins\_head})\K\\{page\_ins\_head}$;\par
\fi

\M1159. An array \\{page\_so\_far} records the heights and depths of everything
on the current page. This array contains six \\{scaled} numbers, like the
similar arrays already considered in \\{line\_break} and \\{vert\_break}; and
it
also contains \\{page\_goal} and \\{page\_depth}, since these values are
all accessible to the user via \\{set\_page\_dimen} commands. The
value of $\\{page\_so\_far}[1]$ is also called \\{page\_total}.  The stretch
and shrink components of the \.{\\skip} corrections for each insertion are
included in \\{page\_so\_far}, but the natural space components of these
corrections are not, since they have been subtracted from \\{page\_goal}.

The variable \\{page\_depth} records the depth of the current page; it has been
adjusted so that it is at most \\{page\_max\_depth}. The variable
\\{last\_glue} points to the glue specification of the most recent node
contributed from the contribution list, if this was a glue node; otherwise
$\\{last\_glue}=\\{max\_halfword}$. (If the contribution list is nonempty,
however, the value of \\{last\_glue} is not necessarily accurate.)
The variables \\{last\_penalty}, \\{last\_kern}, and \\{last\_node\_type}
are similar.  And
finally, \\{insert\_penalties} holds the sum of the penalties associated with
all split and floating insertions.

\Y\P\D \37$\\{page\_goal}\S\\{page\_so\_far}[0]$\C{desired height of
information on page being built}\par
\P\D \37$\\{page\_total}\S\\{page\_so\_far}[1]$\C{height of the current page}%
\par
\P\D \37$\\{page\_shrink}\S\\{page\_so\_far}[6]$\C{shrinkability of the current
page}\par
\P\D \37$\\{page\_depth}\S\\{page\_so\_far}[7]$\C{depth of the current page}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{page\_so\_far}: \37\&{array} $[0\to7]$ \1\&{of}\5
\\{scaled};\C{height and glue of the current page}\2\6
\4\\{last\_glue}: \37\\{pointer};\C{used to implement \.{\\lastskip}}\6
\4\\{last\_penalty}: \37\\{integer};\C{used to implement \.{\\lastpenalty}}\6
\4\\{last\_kern}: \37\\{scaled};\C{used to implement \.{\\lastkern}}\6
\4\\{last\_node\_type}: \37\\{integer};\C{used to implement \.{\\lastnodetype}}%
\6
\4\\{insert\_penalties}: \37\\{integer};\C{sum of the penalties for insertions
 that were held over}\par
\fi

\M1160. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"pagegoal"},\39\\{set\_page\_dimen},\390)$;\5
$\\{primitive}(\.{"pagetotal"},\39\\{set\_page\_dimen},\391)$;\5
$\\{primitive}(\.{"pagestretch"},\39\\{set\_page\_dimen},\392)$;\5
$\\{primitive}(\.{"pagefilstretch"},\39\\{set\_page\_dimen},\393)$;\5
$\\{primitive}(\.{"pagefillstretch"},\39\\{set\_page\_dimen},\394)$;\5
$\\{primitive}(\.{"pagefilllstretch"},\39\\{set\_page\_dimen},\395)$;\5
$\\{primitive}(\.{"pageshrink"},\39\\{set\_page\_dimen},\396)$;\5
$\\{primitive}(\.{"pagedepth"},\39\\{set\_page\_dimen},\397)$;\par
\fi

\M1161. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{set\_page\_dimen}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\40: \37$\\{print\_esc}(\.{"pagegoal"})$;\6
\41: \37$\\{print\_esc}(\.{"pagetotal"})$;\6
\42: \37$\\{print\_esc}(\.{"pagestretch"})$;\6
\43: \37$\\{print\_esc}(\.{"pagefilstretch"})$;\6
\44: \37$\\{print\_esc}(\.{"pagefillstretch"})$;\6
\45: \37$\\{print\_esc}(\.{"pagefilllstretch"})$;\6
\46: \37$\\{print\_esc}(\.{"pageshrink"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"pagedepth"})$\2\6
\&{endcases};\par
\fi

\M1162. \P\D \37$\\{print\_plus\_end}(\#)\S\\{print}(\#)$;\ \&{end} \par
\P\D $\\{print\_plus}(\#)\S$  \6
\&{if} $\\{page\_so\_far}[\#]\I0$ \1\&{then} \6
\&{begin} \37$\\{print}(\.{"\ plus\ "})$;\5
$\\{print\_scaled}(\\{page\_so\_far}[\#])$;\5
\\{print\_plus\_end}\par
\Y\P\4\&{procedure}\1\  \37\\{print\_totals};\2\6
\&{begin} \37$\\{print\_scaled}(\\{page\_total})$;\5
$\\{print\_plus}(2)(\.{""})$;\5
$\\{print\_plus}(3)(\.{"fil"})$;\5
$\\{print\_plus}(4)(\.{"fill"})$;\5
$\\{print\_plus}(5)(\.{"filll"})$;\6
\&{if} $\\{page\_shrink}\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ minus\ "})$;\5
$\\{print\_scaled}(\\{page\_shrink})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1163. \P$\X1163:Show the status of the current page\X\S$\6
\&{if} $\\{page\_head}\I\\{page\_tail}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"\#\#\#\ current\ page:"})$;\6
\&{if} $\\{output\_active}$ \1\&{then}\5
$\\{print}(\.{"\ (held\ over\ for\ next\ output)"})$;\2\6
$\\{show\_box}(\\{link}(\\{page\_head}))$;\6
\&{if} $\\{page\_contents}>\\{empty}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"total\ height\ "})$;\5
\\{print\_totals};\5
$\\{print\_nl}(\.{"\ goal\ height\ "})$;\5
$\\{print\_scaled}(\\{page\_goal})$;\5
$\|r\K\\{link}(\\{page\_ins\_head})$;\6
\&{while} $\|r\I\\{page\_ins\_head}$ \1\&{do}\6
\&{begin} \37\\{print\_ln};\5
$\\{print\_esc}(\.{"insert"})$;\5
$\|t\K\\{qo}(\\{subtype}(\|r))$;\5
$\\{print\_int}(\|t)$;\5
$\\{print}(\.{"\ adds\ "})$;\6
\&{if} $\\{count}(\|t)=1000$ \1\&{then}\5
$\|t\K\\{height}(\|r)$\6
\4\&{else} $\|t\K\\{x\_over\_n}(\\{height}(\|r),\391000)\ast\\{count}(\|t)$;\2\6
$\\{print\_scaled}(\|t)$;\6
\&{if} $\\{type}(\|r)=\\{split\_up}$ \1\&{then}\6
\&{begin} \37$\|q\K\\{page\_head}$;\5
$\|t\K0$;\6
\1\&{repeat} \37$\|q\K\\{link}(\|q)$;\6
\&{if} $(\\{type}(\|q)=\\{ins\_node})\W(\\{subtype}(\|q)=\\{subtype}(\|r))$ \1%
\&{then}\5
$\\{incr}(\|t)$;\2\6
\4\&{until}\5
$\|q=\\{broken\_ins}(\|r)$;\2\6
$\\{print}(\.{",\ \#"})$;\5
$\\{print\_int}(\|t)$;\5
$\\{print}(\.{"\ might\ split"})$;\6
\&{end};\2\6
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\2\par
\U236.\fi

\M1164. Here is a procedure that is called when the \\{page\_contents} is
changing
from \\{empty} to \\{inserts\_only} or \\{box\_there}.

\Y\P\D \37$\\{set\_page\_so\_far\_zero}(\#)\S\\{page\_so\_far}[\#]\K0$\par
\Y\P\4\&{procedure}\1\  \37$\\{freeze\_page\_specs}(\|s:\\{small\_number})$;\2\6
\&{begin} \37$\\{page\_contents}\K\|s$;\5
$\\{page\_goal}\K\\{vsize}$;\5
$\\{page\_max\_depth}\K\\{max\_depth}$;\5
$\\{page\_depth}\K0$;\5
$\\{do\_all\_six}(\\{set\_page\_so\_far\_zero})$;\5
$\\{least\_page\_cost}\K\\{awful\_bad}$;\6
\&{stat} \37\&{if} $\\{tracing\_pages}>0$ \1\&{then}\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"\%\%\ goal\ height="})$;\5
$\\{print\_scaled}(\\{page\_goal})$;\5
$\\{print}(\.{",\ max\ depth="})$;\5
$\\{print\_scaled}(\\{page\_max\_depth})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\2\ \&{tats}\6
\&{end};\par
\fi

\M1165. Pages are built by appending nodes to the current list in \TeX's
vertical mode, which is at the outermost level of the semantic nest. This
vlist is split into two parts; the ``current page'' that we have been
talking so much about already, and the ``contribution list'' that receives
new nodes as they are created.  The current page contains everything that
the page builder has accounted for in its data structures, as described
above, while the contribution list contains other things that have been
generated by other parts of \TeX\ but have not yet been
seen by the page builder.
The contribution list starts at $\\{link}(\\{contrib\_head})$, and it ends at
the
current node in \TeX's vertical mode.

When \TeX\ has appended new material in vertical mode, it calls the procedure
\\{build\_page}, which tries to catch up by moving nodes from the contribution
list to the current page. This procedure will succeed in its goal of
emptying the contribution list, unless a page break is discovered, i.e.,
unless the current page has grown to the point where the optimum next
page break has been determined. In the latter case, the nodes after the
optimum break will go back onto the contribution list, and control will
effectively pass to the user's output routine.

We make $\\{type}(\\{page\_head})=\\{glue\_node}$, so that an initial glue node
on
the current page will not be considered a valid breakpoint.

\Y\P$\4\X966:Initialize the special list heads and constant nodes\X\mathrel{+}%
\S$\6
$\\{type}(\\{page\_head})\K\\{glue\_node}$;\5
$\\{subtype}(\\{page\_head})\K\\{normal}$;\par
\fi

\M1166. The global variable \\{output\_active} is true during the time the
user's output routine is driving \TeX.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{output\_active}: \37\\{boolean};\C{are we in the midst of an output
routine?}\par
\fi

\M1167. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{output\_active}\K\\{false}$;\5
$\\{insert\_penalties}\K0$;\par
\fi

\M1168. The page builder is ready to start a fresh page if we initialize
the following state variables. (However, the page insertion list is initialized
elsewhere.)

\Y\P$\4\X1168:Start a new current page\X\S$\6
$\\{page\_contents}\K\\{empty}$;\5
$\\{page\_tail}\K\\{page\_head}$;\5
$\\{link}(\\{page\_head})\K\\{null}$;\6
$\\{last\_glue}\K\\{max\_halfword}$;\5
$\\{last\_penalty}\K0$;\5
$\\{last\_kern}\K0$;\5
$\\{last\_node\_type}\K-1$;\5
$\\{page\_depth}\K0$;\5
$\\{page\_max\_depth}\K0$\par
\Us233\ET1194.\fi

\M1169. At certain times box 255 is supposed to be void (i.e., \\{null}),
or an insertion box is supposed to be ready to accept a vertical list.
If not, an error message is printed, and the following subroutine
flushes the unwanted contents, reporting them to the user.

\Y\P\4\&{procedure}\1\  \37$\\{box\_error}(\|n:\\{eight\_bits})$;\2\6
\&{begin} \37\\{error};\5
\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"The\ following\ box\ has\ been\ deleted:"})$;\5
$\\{show\_box}(\\{box}(\|n))$;\5
$\\{end\_diagnostic}(\\{true})$;\5
$\\{flush\_node\_list}(\\{box}(\|n))$;\5
$\\{box}(\|n)\K\\{null}$;\6
\&{end};\par
\fi

\M1170. The following procedure guarantees that a given box register
does not contain an \.{\\hbox}.

\Y\P\4\&{procedure}\1\  \37$\\{ensure\_vbox}(\|n:\\{eight\_bits})$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the box register contents}\2\6
\&{begin} \37$\|p\K\\{box}(\|n)$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $\\{type}(\|p)=\\{hlist\_node}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Insertions\ can\ only\ be\ added\ to\ a\
vbox"})$;\5
$\\{help3}(\.{"Tut\ tut:\ You\'re\ trying\ to\ \\insert\ into\ a"})$\6
$(\.{"\\box\ register\ that\ now\ contains\ an\ \\hbox."})$\6
$(\.{"Proceed,\ and\ I\'ll\ discard\ its\ present\ contents."})$;\5
$\\{box\_error}(\|n)$;\6
\&{end};\2\2\6
\&{end};\par
\fi

\M1171. \TeX\ is not always in vertical mode at the time \\{build\_page}
is called; the current mode reflects what \TeX\ should return to, after
the contribution list has been emptied. A call on \\{build\_page} should
be immediately followed by `\&{goto} \\{big\_switch}', which is \TeX's central
control point.

\Y\P\D \37$\\{contribute}=80$\C{go here to link a node into the current page}%
\par
\Y\P\hbox{\4}\X1189:Declare the procedure called \\{fire\_up}\X\6
\4\&{procedure}\1\  \37\\{build\_page};\C{append contributions to the current
page}\6
\4\&{label} \37$\\{exit},\39\\{done},\39\\{done1},\39\\{continue},\39%
\\{contribute},\39\\{update\_heights}$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the node being appended}\6
$\|q,\39\|r$: \37\\{pointer};\C{nodes being examined}\6
$\|b,\39\|c$: \37\\{integer};\C{badness and cost of current page}\6
\\{pi}: \37\\{integer};\C{penalty to be added to the badness}\6
\|n: \37$\\{min\_quarterword}\to255$;\C{insertion box number}\6
$\\{delta},\39\|h,\39\|w$: \37\\{scaled};\C{sizes used for insertion
calculations}\2\6
\&{begin} \37\&{if} $(\\{link}(\\{contrib\_head})=\\{null})\V\\{output%
\_active}$ \1\&{then}\5
\&{return};\2\6
\1\&{repeat} \37\\{continue}: \37$\|p\K\\{link}(\\{contrib\_head})$;\6
\X1173:Update the values of \\{last\_glue}, \\{last\_penalty}, and \\{last%
\_kern}\X;\6
\X1174:Move node \|p to the current page; if it is time for a page break, put
the nodes following the break back onto the contribution list, and \&{return}
to the user's output routine if there is one\X;\6
\4\&{until}\5
$\\{link}(\\{contrib\_head})=\\{null}$;\2\6
\X1172:Make the contribution list empty by setting its tail to \\{contrib%
\_head}\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1172. \P\D \37$\\{contrib\_tail}\S\\{nest}[0].\\{tail\_field}$\C{tail of the
contribution list}\par
\Y\P$\4\X1172:Make the contribution list empty by setting its tail to %
\\{contrib\_head}\X\S$\6
\&{if} $\\{nest\_ptr}=0$ \1\&{then}\5
$\\{tail}\K\\{contrib\_head}$\C{vertical mode}\6
\4\&{else} $\\{contrib\_tail}\K\\{contrib\_head}$\C{other modes}\2\par
\U1171.\fi

\M1173. \P$\X1173:Update the values of \\{last\_glue}, \\{last\_penalty}, and %
\\{last\_kern}\X\S$\6
\&{if} $\\{last\_glue}\I\\{max\_halfword}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{last\_glue})$;\2\6
$\\{last\_penalty}\K0$;\5
$\\{last\_kern}\K0$;\5
$\\{last\_node\_type}\K\\{type}(\|p)+1$;\6
\&{if} $\\{type}(\|p)=\\{glue\_node}$ \1\&{then}\6
\&{begin} \37$\\{last\_glue}\K\\{glue\_ptr}(\|p)$;\5
$\\{add\_glue\_ref}(\\{last\_glue})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{last\_glue}\K\\{max\_halfword}$;\6
\&{if} $\\{type}(\|p)=\\{penalty\_node}$ \1\&{then}\5
$\\{last\_penalty}\K\\{penalty}(\|p)$\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{kern\_node}$ \1\&{then}\5
$\\{last\_kern}\K\\{width}(\|p)$;\2\2\6
\&{end}\2\par
\U1171.\fi

\M1174. The code here is an example of a many-way switch into routines that
merge together in different places. Some people call this unstructured
programming, but the author doesn't see much wrong with it, as long as
the various labels have a well-understood meaning.

\Y\P$\4\X1174:Move node \|p to the current page; if it is time for a page
break, put the nodes following the break back onto the contribution list, and %
\&{return} to the user's output routine if there is one\X\S$\6
\X1177:If the current page is empty and node \|p is to be deleted, \&{goto} %
\\{done1}; otherwise use node \|p to update the state of the current page; if
this node is an insertion, \&{goto} \\{contribute}; otherwise if this node is
not a legal breakpoint, \&{goto} \\{contribute} or \\{update\_heights};
otherwise set \\{pi} to the penalty associated with this breakpoint\X;\6
\X1182:Check if node \|p is a new champion breakpoint; then \(if)if it is time
for a page break, prepare for output, and either fire up the user's output
routine and \&{return} or ship out the page and \&{goto} \\{done}\X;\6
\&{if} $(\\{type}(\|p)<\\{glue\_node})\V(\\{type}(\|p)>\\{kern\_node})$ \1%
\&{then}\5
\&{goto} \37\\{contribute};\2\6
\4\\{update\_heights}: \37\X1181:Update the current page measurements with
respect to the glue or kern specified by node~\|p\X;\6
\4\\{contribute}: \37\X1180:Make sure that \\{page\_max\_depth} is not exceeded%
\X;\6
\X1175:Link node \|p into the current page and \&{goto} \\{done}\X;\6
\4\\{done1}: \37\X1176:Recycle node \|p\X;\6
\4\\{done}: \37\par
\U1171.\fi

\M1175. \P$\X1175:Link node \|p into the current page and \&{goto} \\{done}\X%
\S$\6
$\\{link}(\\{page\_tail})\K\|p$;\5
$\\{page\_tail}\K\|p$;\5
$\\{link}(\\{contrib\_head})\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{null}$;\5
\&{goto} \37\\{done}\par
\U1174.\fi

\M1176. \P$\X1176:Recycle node \|p\X\S$\6
$\\{link}(\\{contrib\_head})\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{null}$;\6
\&{if} $\\{saving\_vdiscards}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{page\_disc}=\\{null}$ \1\&{then}\5
$\\{page\_disc}\K\|p$\ \&{else} $\\{link}(\\{tail\_page\_disc})\K\|p$;\2\6
$\\{tail\_page\_disc}\K\|p$;\6
\&{end}\6
\4\&{else} $\\{flush\_node\_list}(\|p)$\2\par
\U1174.\fi

\M1177. The title of this section is already so long, it seems best to avoid
making it more accurate but still longer, by mentioning the fact that a
kern node at the end of the contribution list will not be contributed until
we know its successor.

\Y\P$\4\X1177:If the current page is empty and node \|p is to be deleted, %
\&{goto} \\{done1}; otherwise use node \|p to update the state of the current
page; if this node is an insertion, \&{goto} \\{contribute}; otherwise if this
node is not a legal breakpoint, \&{goto} \\{contribute} or \\{update\_heights};
otherwise set \\{pi} to the penalty associated with this breakpoint\X\S$\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37\&{if} $\\{page%
\_contents}<\\{box\_there}$ \1\&{then}\5
\X1178:Initialize the current page, insert the \.{\\topskip} glue ahead of \|p,
and \&{goto} \\{continue}\X\6
\4\&{else} \X1179:Prepare to move a box or rule node to the current page, then %
\&{goto} \\{contribute}\X;\2\6
\4\\{whatsit\_node}: \37\&{if} $(\\{page\_contents}<\\{box\_there})\W((%
\\{subtype}(\|p)=\\{pdf\_snapy\_node})\V(\\{subtype}(\|p)=\\{pdf\_snapy\_comp%
\_node}))$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"snap\ node\ being\ discarded"})$;\5
\&{goto} \37\\{done1};\6
\&{end}\6
\4\&{else} \X1611:Prepare to move whatsit \|p to the current page, then %
\&{goto} \\{contribute}\X;\2\6
\4\\{glue\_node}: \37\&{if} $\\{page\_contents}<\\{box\_there}$ \1\&{then}\5
\&{goto} \37\\{done1}\6
\4\&{else} \&{if} $\\{precedes\_break}(\\{page\_tail})$ \1\&{then}\5
$\\{pi}\K0$\6
\4\&{else} \&{goto} \37\\{update\_heights};\2\2\6
\4\\{kern\_node}: \37\&{if} $\\{page\_contents}<\\{box\_there}$ \1\&{then}\5
\&{goto} \37\\{done1}\6
\4\&{else} \&{if} $\\{link}(\|p)=\\{null}$ \1\&{then}\5
\&{return}\6
\4\&{else} \&{if} $\\{type}(\\{link}(\|p))=\\{glue\_node}$ \1\&{then}\5
$\\{pi}\K0$\6
\4\&{else} \&{goto} \37\\{update\_heights};\2\2\2\6
\4\\{penalty\_node}: \37\&{if} $\\{page\_contents}<\\{box\_there}$ \1\&{then}\5
\&{goto} \37\\{done1}\ \&{else} $\\{pi}\K\\{penalty}(\|p)$;\2\6
\4\\{mark\_node}: \37\&{goto} \37\\{contribute};\6
\4\\{ins\_node}: \37\X1185:Append an insertion to the current page and \&{goto}
\\{contribute}\X;\6
\4\&{othercases} \37$\\{confusion}(\.{"page"})$\2\6
\&{endcases}\par
\U1174.\fi

\M1178. \P$\X1178:Initialize the current page, insert the \.{\\topskip} glue
ahead of \|p, and \&{goto} \\{continue}\X\S$\6
\&{begin} \37\&{if} $\\{page\_contents}=\\{empty}$ \1\&{then}\5
$\\{freeze\_page\_specs}(\\{box\_there})$\6
\4\&{else} $\\{page\_contents}\K\\{box\_there}$;\2\6
$\|q\K\\{new\_skip\_param}(\\{top\_skip\_code})$;\C{now $\\{temp\_ptr}=\\{glue%
\_ptr}(\|q)$}\6
\&{if} $\\{width}(\\{temp\_ptr})>\\{height}(\|p)$ \1\&{then}\5
$\\{width}(\\{temp\_ptr})\K\\{width}(\\{temp\_ptr})-\\{height}(\|p)$\6
\4\&{else} $\\{width}(\\{temp\_ptr})\K0$;\2\6
$\\{link}(\|q)\K\|p$;\5
$\\{link}(\\{contrib\_head})\K\|q$;\5
\&{goto} \37\\{continue};\6
\&{end}\par
\U1177.\fi

\M1179. \P$\X1179:Prepare to move a box or rule node to the current page, then %
\&{goto} \\{contribute}\X\S$\6
\&{begin} \37$\\{page\_total}\K\\{page\_total}+\\{page\_depth}+\\{height}(%
\|p)$;\5
$\\{page\_depth}\K\\{depth}(\|p)$;\5
\&{goto} \37\\{contribute};\6
\&{end}\par
\U1177.\fi

\M1180. \P$\X1180:Make sure that \\{page\_max\_depth} is not exceeded\X\S$\6
\&{if} $\\{page\_depth}>\\{page\_max\_depth}$ \1\&{then}\6
\&{begin} \37$\\{page\_total}\K\30\\{page\_total}+\\{page\_depth}-\\{page\_max%
\_depth}$;\6
$\\{page\_depth}\K\\{page\_max\_depth}$;\6
\&{end};\2\par
\U1174.\fi

\M1181. \P$\X1181:Update the current page measurements with respect to the glue
or kern specified by node~\|p\X\S$\6
\&{if} $\\{type}(\|p)=\\{kern\_node}$ \1\&{then}\5
$\|q\K\|p$\6
\4\&{else} \&{begin} \37$\|q\K\\{glue\_ptr}(\|p)$;\5
$\\{page\_so\_far}[2+\\{stretch\_order}(\|q)]\K\30\\{page\_so\_far}[2+%
\\{stretch\_order}(\|q)]+\\{stretch}(\|q)$;\6
$\\{page\_shrink}\K\\{page\_shrink}+\\{shrink}(\|q)$;\6
\&{if} $(\\{shrink\_order}(\|q)\I\\{normal})\W(\\{shrink}(\|q)\I0)$ \1\&{then}\6
\&{begin} \37\hbox{}\6
$\\{print\_err}(\.{"Infinite\ glue\ shrinkage\ found\ on\ current\ page"})$;\6
$\\{help4}(\.{"The\ page\ about\ to\ be\ output\ contains\ some\ infinitely"})$%
\6
$(\.{"shrinkable\ glue,\ e.g.,\ \`\\vss\'\ or\ \`\\vskip\ 0pt\ minus\ 1fil%
\'."})$\6
$(\.{"Such\ glue\ doesn\'t\ belong\ there;\ but\ you\ can\ safely\ proceed,"})$%
\6
$(\.{"since\ the\ offensive\ shrinkability\ has\ been\ made\ finite."})$;\5
\\{error};\5
$\|r\K\\{new\_spec}(\|q)$;\5
$\\{shrink\_order}(\|r)\K\\{normal}$;\5
$\\{delete\_glue\_ref}(\|q)$;\5
$\\{glue\_ptr}(\|p)\K\|r$;\5
$\|q\K\|r$;\6
\&{end};\2\6
\&{end};\2\6
$\\{page\_total}\K\\{page\_total}+\\{page\_depth}+\\{width}(\|q)$;\5
$\\{page\_depth}\K0$\par
\U1174.\fi

\M1182. \P$\X1182:Check if node \|p is a new champion breakpoint; then \(if)if
it is time for a page break, prepare for output, and either fire up the user's
output routine and \&{return} or ship out the page and \&{goto} \\{done}\X\S$\6
\&{if} $\\{pi}<\\{inf\_penalty}$ \1\&{then}\6
\&{begin} \37\X1184:Compute the badness, \|b, of the current page, using %
\\{awful\_bad} if the box is too full\X;\6
\&{if} $\|b<\\{awful\_bad}$ \1\&{then}\6
\&{if} $\\{pi}\L\\{eject\_penalty}$ \1\&{then}\5
$\|c\K\\{pi}$\6
\4\&{else} \&{if} $\|b<\\{inf\_bad}$ \1\&{then}\5
$\|c\K\|b+\\{pi}+\\{insert\_penalties}$\6
\4\&{else} $\|c\K\\{deplorable}$\2\2\6
\4\&{else} $\|c\K\|b$;\2\6
\&{if} $\\{insert\_penalties}\G10000$ \1\&{then}\5
$\|c\K\\{awful\_bad}$;\2\6
\&{stat} \37\&{if} $\\{tracing\_pages}>0$ \1\&{then}\5
\X1183:Display the page break cost\X;\ \2\6
\&{tats}\6
\&{if} $\|c\L\\{least\_page\_cost}$ \1\&{then}\6
\&{begin} \37$\\{best\_page\_break}\K\|p$;\5
$\\{best\_size}\K\\{page\_goal}$;\5
$\\{least\_page\_cost}\K\|c$;\5
$\|r\K\\{link}(\\{page\_ins\_head})$;\6
\&{while} $\|r\I\\{page\_ins\_head}$ \1\&{do}\6
\&{begin} \37$\\{best\_ins\_ptr}(\|r)\K\\{last\_ins\_ptr}(\|r)$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{end};\2\6
\&{if} $(\|c=\\{awful\_bad})\V(\\{pi}\L\\{eject\_penalty})$ \1\&{then}\6
\&{begin} \37$\\{fire\_up}(\|p)$;\C{output the current page at the best place}\6
\&{if} $\\{output\_active}$ \1\&{then}\5
\&{return};\C{user's output routine will act}\2\6
\&{goto} \37\\{done};\C{the page has been shipped out by default output
routine}\6
\&{end};\2\6
\&{end}\2\par
\U1174.\fi

\M1183. \P$\X1183:Display the page break cost\X\S$\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"\%"})$;\5
$\\{print}(\.{"\ t="})$;\5
\\{print\_totals};\6
$\\{print}(\.{"\ g="})$;\5
$\\{print\_scaled}(\\{page\_goal})$;\6
$\\{print}(\.{"\ b="})$;\6
\&{if} $\|b=\\{awful\_bad}$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\ \&{else} $\\{print\_int}(\|b)$;\2\6
$\\{print}(\.{"\ p="})$;\5
$\\{print\_int}(\\{pi})$;\5
$\\{print}(\.{"\ c="})$;\6
\&{if} $\|c=\\{awful\_bad}$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\ \&{else} $\\{print\_int}(\|c)$;\2\6
\&{if} $\|c\L\\{least\_page\_cost}$ \1\&{then}\5
$\\{print\_char}(\.{"\#"})$;\2\6
$\\{end\_diagnostic}(\\{false})$;\6
\&{end}\par
\U1182.\fi

\M1184. \P$\X1184:Compute the badness, \|b, of the current page, using \\{awful%
\_bad} if the box is too full\X\S$\6
\&{if} $\\{page\_total}<\\{page\_goal}$ \1\&{then}\6
\&{if} $(\\{page\_so\_far}[3]\I0)\V(\\{page\_so\_far}[4]\I0)\V\30(\\{page\_so%
\_far}[5]\I0)$ \1\&{then}\5
$\|b\K0$\6
\4\&{else} $\|b\K\\{badness}(\\{page\_goal}-\\{page\_total},\39\\{page\_so%
\_far}[2])$\2\6
\4\&{else} \&{if} $\\{page\_total}-\\{page\_goal}>\\{page\_shrink}$ \1\&{then}\5
$\|b\K\\{awful\_bad}$\6
\4\&{else} $\|b\K\\{badness}(\\{page\_total}-\\{page\_goal},\39\\{page%
\_shrink})$\2\2\par
\U1182.\fi

\M1185. \P$\X1185:Append an insertion to the current page and \&{goto} %
\\{contribute}\X\S$\6
\&{begin} \37\&{if} $\\{page\_contents}=\\{empty}$ \1\&{then}\5
$\\{freeze\_page\_specs}(\\{inserts\_only})$;\2\6
$\|n\K\\{subtype}(\|p)$;\5
$\|r\K\\{page\_ins\_head}$;\6
\&{while} $\|n\G\\{subtype}(\\{link}(\|r))$ \1\&{do}\5
$\|r\K\\{link}(\|r)$;\2\6
$\|n\K\\{qo}(\|n)$;\6
\&{if} $\\{subtype}(\|r)\I\\{qi}(\|n)$ \1\&{then}\5
\X1186:Create a page insertion node with $\\{subtype}(\|r)=\\{qi}(\|n)$, and
include the glue correction for box \|n in the current page state\X;\2\6
\&{if} $\\{type}(\|r)=\\{split\_up}$ \1\&{then}\5
$\\{insert\_penalties}\K\\{insert\_penalties}+\\{float\_cost}(\|p)$\6
\4\&{else} \&{begin} \37$\\{last\_ins\_ptr}(\|r)\K\|p$;\5
$\\{delta}\K\\{page\_goal}-\\{page\_total}-\\{page\_depth}+\\{page\_shrink}$;%
\C{this much room is left if we shrink the maximum}\6
\&{if} $\\{count}(\|n)=1000$ \1\&{then}\5
$\|h\K\\{height}(\|p)$\6
\4\&{else} $\|h\K\\{x\_over\_n}(\\{height}(\|p),\391000)\ast\\{count}(\|n)$;%
\C{this much room is needed}\2\6
\&{if} $((\|h\L0)\V(\|h\L\\{delta}))\W(\\{height}(\|p)+\\{height}(\|r)\L%
\\{dimen}(\|n))$ \1\&{then}\6
\&{begin} \37$\\{page\_goal}\K\\{page\_goal}-\|h$;\5
$\\{height}(\|r)\K\\{height}(\|r)+\\{height}(\|p)$;\6
\&{end}\6
\4\&{else} \X1187:Find the best way to split the insertion, and change $%
\\{type}(\|r)$ to \\{split\_up}\X;\2\6
\&{end};\2\6
\&{goto} \37\\{contribute};\6
\&{end}\par
\U1177.\fi

\M1186. We take note of the value of \.{\\skip} \|n and the height plus depth
of \.{\\box}~\|n only when the first \.{\\insert}~\|n node is
encountered for a new page. A user who changes the contents of \.{\\box}~\|n
after that first \.{\\insert}~\|n had better be either extremely careful
or extremely lucky, or both.

\Y\P$\4\X1186:Create a page insertion node with $\\{subtype}(\|r)=\\{qi}(\|n)$,
and include the glue correction for box \|n in the current page state\X\S$\6
\&{begin} \37$\|q\K\\{get\_node}(\\{page\_ins\_node\_size})$;\5
$\\{link}(\|q)\K\\{link}(\|r)$;\5
$\\{link}(\|r)\K\|q$;\5
$\|r\K\|q$;\5
$\\{subtype}(\|r)\K\\{qi}(\|n)$;\5
$\\{type}(\|r)\K\\{inserting}$;\5
$\\{ensure\_vbox}(\|n)$;\6
\&{if} $\\{box}(\|n)=\\{null}$ \1\&{then}\5
$\\{height}(\|r)\K0$\6
\4\&{else} $\\{height}(\|r)\K\\{height}(\\{box}(\|n))+\\{depth}(\\{box}(\|n))$;%
\2\6
$\\{best\_ins\_ptr}(\|r)\K\\{null}$;\6
$\|q\K\\{skip}(\|n)$;\6
\&{if} $\\{count}(\|n)=1000$ \1\&{then}\5
$\|h\K\\{height}(\|r)$\6
\4\&{else} $\|h\K\\{x\_over\_n}(\\{height}(\|r),\391000)\ast\\{count}(\|n)$;\2\6
$\\{page\_goal}\K\\{page\_goal}-\|h-\\{width}(\|q)$;\6
$\\{page\_so\_far}[2+\\{stretch\_order}(\|q)]\K\30\\{page\_so\_far}[2+%
\\{stretch\_order}(\|q)]+\\{stretch}(\|q)$;\6
$\\{page\_shrink}\K\\{page\_shrink}+\\{shrink}(\|q)$;\6
\&{if} $(\\{shrink\_order}(\|q)\I\\{normal})\W(\\{shrink}(\|q)\I0)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Infinite\ glue\ shrinkage\ inserted\ from\
"})$;\5
$\\{print\_esc}(\.{"skip"})$;\5
$\\{print\_int}(\|n)$;\5
$\\{help3}(\.{"The\ correction\ glue\ for\ page\ breaking\ with\ insertions"})$%
\6
$(\.{"must\ have\ finite\ shrinkability.\ But\ you\ may\ proceed,"})$\6
$(\.{"since\ the\ offensive\ shrinkability\ has\ been\ made\ finite."})$;\5
\\{error};\6
\&{end};\2\6
\&{end}\par
\U1185.\fi

\M1187. Here is the code that will split a long footnote between pages, in an
emergency. The current situation deserves to be recapitulated: Node \|p
is an insertion into box \|n; the insertion will not fit, in its entirety,
either because it would make the total contents of box \|n greater than
\.{\\dimen} \|n, or because it would make the incremental amount of growth
\|h greater than the available space \\{delta}, or both. (This amount \|h has
been weighted by the insertion scaling factor, i.e., by \.{\\count} \|n
over 1000.) Now we will choose the best way to break the vlist of the
insertion, using the same criteria as in the \.{\\vsplit} operation.

\Y\P$\4\X1187:Find the best way to split the insertion, and change $\\{type}(%
\|r)$ to \\{split\_up}\X\S$\6
\&{begin} \37\&{if} $\\{count}(\|n)\L0$ \1\&{then}\5
$\|w\K\\{max\_dimen}$\6
\4\&{else} \&{begin} \37$\|w\K\\{page\_goal}-\\{page\_total}-\\{page\_depth}$;\6
\&{if} $\\{count}(\|n)\I1000$ \1\&{then}\5
$\|w\K\\{x\_over\_n}(\|w,\39\\{count}(\|n))\ast1000$;\2\6
\&{end};\2\6
\&{if} $\|w>\\{dimen}(\|n)-\\{height}(\|r)$ \1\&{then}\5
$\|w\K\\{dimen}(\|n)-\\{height}(\|r)$;\2\6
$\|q\K\\{vert\_break}(\\{ins\_ptr}(\|p),\39\|w,\39\\{depth}(\|p))$;\5
$\\{height}(\|r)\K\\{height}(\|r)+\\{best\_height\_plus\_depth}$;\6
\&{stat} \37\&{if} $\\{tracing\_pages}>0$ \1\&{then}\5
\X1188:Display the insertion split cost\X;\ \2\6
\&{tats}\6
\&{if} $\\{count}(\|n)\I1000$ \1\&{then}\5
$\\{best\_height\_plus\_depth}\K\\{x\_over\_n}(\\{best\_height\_plus\_depth},%
\391000)\ast\\{count}(\|n)$;\2\6
$\\{page\_goal}\K\\{page\_goal}-\\{best\_height\_plus\_depth}$;\5
$\\{type}(\|r)\K\\{split\_up}$;\5
$\\{broken\_ptr}(\|r)\K\|q$;\5
$\\{broken\_ins}(\|r)\K\|p$;\6
\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{insert\_penalties}\K\\{insert\_penalties}+\\{eject\_penalty}$\6
\4\&{else} \&{if} $\\{type}(\|q)=\\{penalty\_node}$ \1\&{then}\5
$\\{insert\_penalties}\K\\{insert\_penalties}+\\{penalty}(\|q)$;\2\2\6
\&{end}\par
\U1185.\fi

\M1188. \P$\X1188:Display the insertion split cost\X\S$\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"\%\ split"})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print}(\.{"\ to\ "})$;\5
$\\{print\_scaled}(\|w)$;\5
$\\{print\_char}(\.{","})$;\5
$\\{print\_scaled}(\\{best\_height\_plus\_depth})$;\6
$\\{print}(\.{"\ p="})$;\6
\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{print\_int}(\\{eject\_penalty})$\6
\4\&{else} \&{if} $\\{type}(\|q)=\\{penalty\_node}$ \1\&{then}\5
$\\{print\_int}(\\{penalty}(\|q))$\6
\4\&{else} $\\{print\_char}(\.{"0"})$;\2\2\6
$\\{end\_diagnostic}(\\{false})$;\6
\&{end}\par
\U1187.\fi

\M1189. When the page builder has looked at as much material as could appear
before
the next page break, it makes its decision. The break that gave minimum
badness will be used to put a completed ``page'' into box 255, with insertions
appended to their other boxes.

We also set the values of \\{top\_mark}, \\{first\_mark}, and \\{bot\_mark}.
The
program uses the fact that $\\{bot\_mark}\I\\{null}$ implies $\\{first\_mark}\I%
\\{null}$;
it also knows that $\\{bot\_mark}=\\{null}$ implies $\\{top\_mark}=\\{first%
\_mark}=\\{null}$.

The \\{fire\_up} subroutine prepares to output the current page at the best
place; then it fires up the user's output routine, if there is one,
or it simply ships out the page. There is one parameter, \|c, which represents
the node that was being contributed to the page when the decision to
force an output was made.

\Y\P$\4\X1189:Declare the procedure called \\{fire\_up}\X\S$\6
\4\&{procedure}\1\  \37$\\{fire\_up}(\|c:\\{pointer})$;\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37$\|p,\39\|q,\39\|r,\39\|s$: \37\\{pointer};\C{nodes being examined
and/or changed}\6
\\{prev\_p}: \37\\{pointer};\C{predecessor of \|p}\6
\|n: \37$\\{min\_quarterword}\to255$;\C{insertion box number}\6
\\{wait}: \37\\{boolean};\C{should the present insertion be held over?}\6
\\{save\_vbadness}: \37\\{integer};\C{saved value of \\{vbadness}}\6
\\{save\_vfuzz}: \37\\{scaled};\C{saved value of \\{vfuzz}}\6
\\{save\_split\_top\_skip}: \37\\{pointer};\C{saved value of \\{split\_top%
\_skip}}\2\6
\&{begin} \37\X1190:Set the value of \\{output\_penalty}\X;\6
\&{if} $\\{sa\_mark}\I\\{null}$ \1\&{then}\6
\&{if} $\\{do\_marks}(\\{fire\_up\_init},\390,\39\\{sa\_mark})$ \1\&{then}\5
$\\{sa\_mark}\K\\{null}$;\2\2\6
\&{if} $\\{bot\_mark}\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{top\_mark}\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{top\_mark})$;\2\6
$\\{top\_mark}\K\\{bot\_mark}$;\5
$\\{add\_token\_ref}(\\{top\_mark})$;\5
$\\{delete\_token\_ref}(\\{first\_mark})$;\5
$\\{first\_mark}\K\\{null}$;\6
\&{end};\2\6
\X1191:Put the \(o)optimal current page into box 255, update \\{first\_mark}
and \\{bot\_mark}, append insertions to their boxes, and put the remaining
nodes back on the contribution list\X;\6
\&{if} $\\{sa\_mark}\I\\{null}$ \1\&{then}\6
\&{if} $\\{do\_marks}(\\{fire\_up\_done},\390,\39\\{sa\_mark})$ \1\&{then}\5
$\\{sa\_mark}\K\\{null}$;\2\2\6
\&{if} $(\\{top\_mark}\I\\{null})\W(\\{first\_mark}=\\{null})$ \1\&{then}\6
\&{begin} \37$\\{first\_mark}\K\\{top\_mark}$;\5
$\\{add\_token\_ref}(\\{top\_mark})$;\6
\&{end};\2\6
\&{if} $\\{output\_routine}\I\\{null}$ \1\&{then}\6
\&{if} $\\{dead\_cycles}\G\\{max\_dead\_cycles}$ \1\&{then}\5
\X1201:Explain that too many dead cycles have occurred in a row\X\6
\4\&{else} \X1202:Fire up the user's output routine and \&{return}\X;\2\2\6
\X1200:Perform the default output routine\X;\6
\4\\{exit}: \37\&{end};\par
\U1171.\fi

\M1190. \P$\X1190:Set the value of \\{output\_penalty}\X\S$\6
\&{if} $\\{type}(\\{best\_page\_break})=\\{penalty\_node}$ \1\&{then}\6
\&{begin} \37$\\{geq\_word\_define}(\\{int\_base}+\\{output\_penalty\_code},\39%
\\{penalty}(\\{best\_page\_break}))$;\5
$\\{penalty}(\\{best\_page\_break})\K\\{inf\_penalty}$;\6
\&{end}\6
\4\&{else} $\\{geq\_word\_define}(\\{int\_base}+\\{output\_penalty\_code},\39%
\\{inf\_penalty})$\2\par
\U1189.\fi

\M1191. As the page is finally being prepared for output,
pointer \|p runs through the vlist, with \\{prev\_p} trailing behind;
pointer \|q is the tail of a list of insertions that
are being held over for a subsequent page.

\Y\P$\4\X1191:Put the \(o)optimal current page into box 255, update \\{first%
\_mark} and \\{bot\_mark}, append insertions to their boxes, and put the
remaining nodes back on the contribution list\X\S$\6
\&{if} $\|c=\\{best\_page\_break}$ \1\&{then}\5
$\\{best\_page\_break}\K\\{null}$;\C{\|c not yet linked in}\2\6
\X1192:Ensure that box 255 is empty before output\X;\6
$\\{insert\_penalties}\K0$;\C{this will count the number of insertions held
over}\6
$\\{save\_split\_top\_skip}\K\\{split\_top\_skip}$;\6
\&{if} $\\{holding\_inserts}\L0$ \1\&{then}\5
\X1195:Prepare all the boxes involved in insertions to act as queues\X;\2\6
$\|q\K\\{hold\_head}$;\5
$\\{link}(\|q)\K\\{null}$;\5
$\\{prev\_p}\K\\{page\_head}$;\5
$\|p\K\\{link}(\\{prev\_p})$;\6
\&{while} $\|p\I\\{best\_page\_break}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{type}(\|p)=\\{ins\_node}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{holding\_inserts}\L0$ \1\&{then}\5
\X1197:Either insert the material specified by node \|p into the appropriate
box, or hold it for the next page; also delete node \|p from the current page%
\X;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{mark\_node}$ \1\&{then}\6
\&{if} $\\{mark\_class}(\|p)\I0$ \1\&{then}\5
\X1830:Update the current marks for \\{fire\_up}\X\6
\4\&{else} \X1193:Update the values of \\{first\_mark} and \\{bot\_mark}\X;\2\2%
\2\6
$\\{prev\_p}\K\|p$;\5
$\|p\K\\{link}(\\{prev\_p})$;\6
\&{end};\2\6
$\\{split\_top\_skip}\K\\{save\_split\_top\_skip}$;\5
\X1194:Break the current page at node \|p, put it in box~255, and put the
remaining nodes on the contribution list\X;\6
\X1196:Delete \(t)the page-insertion nodes\X\par
\U1189.\fi

\M1192. \P$\X1192:Ensure that box 255 is empty before output\X\S$\6
\&{if} $\\{box}(255)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{""})$;\5
$\\{print\_esc}(\.{"box"})$;\5
$\\{print}(\.{"255\ is\ not\ void"})$;\5
$\\{help2}(\.{"You\ shouldn\'t\ use\ \\box255\ except\ in\ \\output\
routines."})$\6
$(\.{"Proceed,\ and\ I\'ll\ discard\ its\ present\ contents."})$;\5
$\\{box\_error}(255)$;\6
\&{end}\2\par
\U1191.\fi

\M1193. \P$\X1193:Update the values of \\{first\_mark} and \\{bot\_mark}\X\S$\6
\&{begin} \37\&{if} $\\{first\_mark}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{first\_mark}\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{first\_mark})$;\6
\&{end};\2\6
\&{if} $\\{bot\_mark}\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{bot\_mark})$;\2\6
$\\{bot\_mark}\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{bot\_mark})$;\6
\&{end}\par
\U1191.\fi

\M1194. When the following code is executed, the current page runs from node
$\\{link}(\\{page\_head})$ to node \\{prev\_p}, and the nodes from \|p to %
\\{page\_tail}
are to be placed back at the front of the contribution list. Furthermore
the heldover insertions appear in a list from $\\{link}(\\{hold\_head})$ to %
\|q; we
will put them into the current page list for safekeeping while the user's
output routine is active.  We might have $\|q=\\{hold\_head}$; and $\|p=%
\\{null}$ if
and only if $\\{prev\_p}=\\{page\_tail}$. Error messages are suppressed within
\\{vpackage}, since the box might appear to be overfull or underfull simply
because the stretch and shrink from the \.{\\skip} registers for inserts
are not actually present in the box.

\Y\P$\4\X1194:Break the current page at node \|p, put it in box~255, and put
the remaining nodes on the contribution list\X\S$\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{link}(\\{contrib\_head})=\\{null}$ \1\&{then}\6
\&{if} $\\{nest\_ptr}=0$ \1\&{then}\5
$\\{tail}\K\\{page\_tail}$\6
\4\&{else} $\\{contrib\_tail}\K\\{page\_tail}$;\2\2\6
$\\{link}(\\{page\_tail})\K\\{link}(\\{contrib\_head})$;\5
$\\{link}(\\{contrib\_head})\K\|p$;\5
$\\{link}(\\{prev\_p})\K\\{null}$;\6
\&{end};\2\6
$\\{save\_vbadness}\K\\{vbadness}$;\5
$\\{vbadness}\K\\{inf\_bad}$;\5
$\\{save\_vfuzz}\K\\{vfuzz}$;\5
$\\{vfuzz}\K\\{max\_dimen}$;\C{inhibit error messages}\6
$\\{box}(255)\K\\{vpackage}(\\{link}(\\{page\_head}),\39\\{best\_size},\39%
\\{exactly},\39\\{page\_max\_depth})$;\5
$\\{vbadness}\K\\{save\_vbadness}$;\5
$\\{vfuzz}\K\\{save\_vfuzz}$;\6
\&{if} $\\{last\_glue}\I\\{max\_halfword}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{last\_glue})$;\2\6
\X1168:Start a new current page\X;\C{this sets $\\{last\_glue}\K\\{max%
\_halfword}$}\6
\&{if} $\|q\I\\{hold\_head}$ \1\&{then}\6
\&{begin} \37$\\{link}(\\{page\_head})\K\\{link}(\\{hold\_head})$;\5
$\\{page\_tail}\K\|q$;\6
\&{end}\2\par
\U1191.\fi

\M1195. If many insertions are supposed to go into the same box, we want to
know
the position of the last node in that box, so that we don't need to waste time
when linking further information into it. The \\{last\_ins\_ptr} fields of the
page insertion nodes are therefore used for this purpose during the
packaging phase.

\Y\P$\4\X1195:Prepare all the boxes involved in insertions to act as queues\X%
\S$\6
\&{begin} \37$\|r\K\\{link}(\\{page\_ins\_head})$;\6
\&{while} $\|r\I\\{page\_ins\_head}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{best\_ins\_ptr}(\|r)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|n\K\\{qo}(\\{subtype}(\|r))$;\5
$\\{ensure\_vbox}(\|n)$;\6
\&{if} $\\{box}(\|n)=\\{null}$ \1\&{then}\5
$\\{box}(\|n)\K\\{new\_null\_box}$;\2\6
$\|p\K\\{box}(\|n)+\\{list\_offset}$;\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{last\_ins\_ptr}(\|r)\K\|p$;\6
\&{end};\2\6
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
\&{end}\par
\U1191.\fi

\M1196. \P$\X1196:Delete \(t)the page-insertion nodes\X\S$\6
$\|r\K\\{link}(\\{page\_ins\_head})$;\6
\&{while} $\|r\I\\{page\_ins\_head}$ \1\&{do}\6
\&{begin} \37$\|q\K\\{link}(\|r)$;\5
$\\{free\_node}(\|r,\39\\{page\_ins\_node\_size})$;\5
$\|r\K\|q$;\6
\&{end};\2\6
$\\{link}(\\{page\_ins\_head})\K\\{page\_ins\_head}$\par
\U1191.\fi

\M1197. We will set $\\{best\_ins\_ptr}\K\\{null}$ and package the box
corresponding to
insertion node~\|r, just after making the final insertion into that box.
If this final insertion is `\\{split\_up}', the remainder after splitting
and pruning (if any) will be carried over to the next page.

\Y\P$\4\X1197:Either insert the material specified by node \|p into the
appropriate box, or hold it for the next page; also delete node \|p from the
current page\X\S$\6
\&{begin} \37$\|r\K\\{link}(\\{page\_ins\_head})$;\6
\&{while} $\\{subtype}(\|r)\I\\{subtype}(\|p)$ \1\&{do}\5
$\|r\K\\{link}(\|r)$;\2\6
\&{if} $\\{best\_ins\_ptr}(\|r)=\\{null}$ \1\&{then}\5
$\\{wait}\K\\{true}$\6
\4\&{else} \&{begin} \37$\\{wait}\K\\{false}$;\5
$\|s\K\\{last\_ins\_ptr}(\|r)$;\5
$\\{link}(\|s)\K\\{ins\_ptr}(\|p)$;\6
\&{if} $\\{best\_ins\_ptr}(\|r)=\|p$ \1\&{then}\5
\X1198:Wrap up the box specified by node \|r, splitting node \|p if called for;
set $\\{wait}\K\\{true}$ if node \|p holds a remainder after splitting\X\6
\4\&{else} \&{begin} \37\&{while} $\\{link}(\|s)\I\\{null}$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
$\\{last\_ins\_ptr}(\|r)\K\|s$;\6
\&{end};\2\6
\&{end};\2\6
\X1199:Either append the insertion node \|p after node \|q, and remove it from
the current page, or delete $\\{node}(\|p)$\X;\6
\&{end}\par
\U1191.\fi

\M1198. \P$\X1198:Wrap up the box specified by node \|r, splitting node \|p if
called for; set $\\{wait}\K\\{true}$ if node \|p holds a remainder after
splitting\X\S$\6
\&{begin} \37\&{if} $\\{type}(\|r)=\\{split\_up}$ \1\&{then}\6
\&{if} $(\\{broken\_ins}(\|r)=\|p)\W(\\{broken\_ptr}(\|r)\I\\{null})$ \1%
\&{then}\6
\&{begin} \37\&{while} $\\{link}(\|s)\I\\{broken\_ptr}(\|r)$ \1\&{do}\5
$\|s\K\\{link}(\|s)$;\2\6
$\\{link}(\|s)\K\\{null}$;\5
$\\{split\_top\_skip}\K\\{split\_top\_ptr}(\|p)$;\5
$\\{ins\_ptr}(\|p)\K\\{prune\_page\_top}(\\{broken\_ptr}(\|r),\39\\{false})$;\6
\&{if} $\\{ins\_ptr}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{temp\_ptr}\K\\{vpack}(\\{ins\_ptr}(\|p),\39\\{natural})$;\5
$\\{height}(\|p)\K\\{height}(\\{temp\_ptr})+\\{depth}(\\{temp\_ptr})$;\5
$\\{free\_node}(\\{temp\_ptr},\39\\{box\_node\_size})$;\5
$\\{wait}\K\\{true}$;\6
\&{end};\2\6
\&{end};\2\2\6
$\\{best\_ins\_ptr}(\|r)\K\\{null}$;\5
$\|n\K\\{qo}(\\{subtype}(\|r))$;\5
$\\{temp\_ptr}\K\\{list\_ptr}(\\{box}(\|n))$;\5
$\\{free\_node}(\\{box}(\|n),\39\\{box\_node\_size})$;\5
$\\{box}(\|n)\K\\{vpack}(\\{temp\_ptr},\39\\{natural})$;\6
\&{end}\par
\U1197.\fi

\M1199. \P$\X1199:Either append the insertion node \|p after node \|q, and
remove it from the current page, or delete $\\{node}(\|p)$\X\S$\6
$\\{link}(\\{prev\_p})\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{null}$;\6
\&{if} $\\{wait}$ \1\&{then}\6
\&{begin} \37$\\{link}(\|q)\K\|p$;\5
$\|q\K\|p$;\5
$\\{incr}(\\{insert\_penalties})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{delete\_glue\_ref}(\\{split\_top\_ptr}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{ins\_node\_size})$;\6
\&{end};\2\6
$\|p\K\\{prev\_p}$\par
\U1197.\fi

\M1200. The list of heldover insertions, running from $\\{link}(\\{page%
\_head})$ to
\\{page\_tail}, must be moved to the contribution list when the user has
specified no output routine.

\Y\P$\4\X1200:Perform the default output routine\X\S$\6
\&{begin} \37\&{if} $\\{link}(\\{page\_head})\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{link}(\\{contrib\_head})=\\{null}$ \1\&{then}\6
\&{if} $\\{nest\_ptr}=0$ \1\&{then}\5
$\\{tail}\K\\{page\_tail}$\ \&{else} $\\{contrib\_tail}\K\\{page\_tail}$\2\6
\4\&{else} $\\{link}(\\{page\_tail})\K\\{link}(\\{contrib\_head})$;\2\6
$\\{link}(\\{contrib\_head})\K\\{link}(\\{page\_head})$;\5
$\\{link}(\\{page\_head})\K\\{null}$;\5
$\\{page\_tail}\K\\{page\_head}$;\6
\&{end};\2\6
$\\{flush\_node\_list}(\\{page\_disc})$;\5
$\\{page\_disc}\K\\{null}$;\5
$\\{ship\_out}(\\{box}(255))$;\5
$\\{box}(255)\K\\{null}$;\6
\&{end}\par
\U1189.\fi

\M1201. \P$\X1201:Explain that too many dead cycles have occurred in a row\X\S$%
\6
\&{begin} \37$\\{print\_err}(\.{"Output\ loop---"})$;\5
$\\{print\_int}(\\{dead\_cycles})$;\5
$\\{print}(\.{"\ consecutive\ dead\ cycles"})$;\5
$\\{help3}(\.{"I\'ve\ concluded\ that\ your\ \\output\ is\ awry;\ it\ never\
does\ a"})$\6
$(\.{"\\shipout,\ so\ I\'m\ shipping\ \\box255\ out\ myself.\ Next\ time"})$\6
$(\.{"increase\ \\maxdeadcycles\ if\ you\ want\ me\ to\ be\ more\ patient!"})$;%
\5
\\{error};\6
\&{end}\par
\U1189.\fi

\M1202. \P$\X1202:Fire up the user's output routine and \&{return}\X\S$\6
\&{begin} \37$\\{output\_active}\K\\{true}$;\5
$\\{incr}(\\{dead\_cycles})$;\5
\\{push\_nest};\5
$\\{mode}\K-\\{vmode}$;\5
$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\5
$\\{mode\_line}\K-\\{line}$;\5
$\\{begin\_token\_list}(\\{output\_routine},\39\\{output\_text})$;\5
$\\{new\_save\_level}(\\{output\_group})$;\5
\\{normal\_paragraph};\5
\\{scan\_left\_brace};\5
\&{return};\6
\&{end}\par
\U1189.\fi

\M1203. When the user's output routine finishes, it has constructed a vlist
in internal vertical mode, and \TeX\ will do the following:

\Y\P$\4\X1203:Resume the page builder after an output routine has come to an
end\X\S$\6
\&{begin} \37\&{if} $(\\{loc}\I\\{null})\V((\\{token\_type}\I\\{output\_text})%
\W(\\{token\_type}\I\\{backed\_up}))$ \1\&{then}\5
\X1204:Recover from an unbalanced output routine\X;\2\6
\\{end\_token\_list};\C{conserve stack space in case more outputs are
triggered}\6
\\{end\_graf};\5
\\{unsave};\5
$\\{output\_active}\K\\{false}$;\5
$\\{insert\_penalties}\K0$;\6
\X1205:Ensure that box 255 is empty after output\X;\6
\&{if} $\\{tail}\I\\{head}$ \1\&{then}\C{current list goes after heldover
insertions}\6
\&{begin} \37$\\{link}(\\{page\_tail})\K\\{link}(\\{head})$;\5
$\\{page\_tail}\K\\{tail}$;\6
\&{end};\2\6
\&{if} $\\{link}(\\{page\_head})\I\\{null}$ \1\&{then}\C{and both go before
heldover contributions}\6
\&{begin} \37\&{if} $\\{link}(\\{contrib\_head})=\\{null}$ \1\&{then}\5
$\\{contrib\_tail}\K\\{page\_tail}$;\2\6
$\\{link}(\\{page\_tail})\K\\{link}(\\{contrib\_head})$;\5
$\\{link}(\\{contrib\_head})\K\\{link}(\\{page\_head})$;\5
$\\{link}(\\{page\_head})\K\\{null}$;\5
$\\{page\_tail}\K\\{page\_head}$;\6
\&{end};\2\6
$\\{flush\_node\_list}(\\{page\_disc})$;\5
$\\{page\_disc}\K\\{null}$;\5
\\{pop\_nest};\5
\\{build\_page};\6
\&{end}\par
\U1278.\fi

\M1204. \P$\X1204:Recover from an unbalanced output routine\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Unbalanced\ output\ routine"})$;\5
$\\{help2}(\.{"Your\ sneaky\ output\ routine\ has\ problematic\ \{\'s\ and/or\ %
\}\'s."})$\6
$(\.{"I\ can\'t\ handle\ that\ very\ well;\ good\ luck."})$;\5
\\{error};\6
\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{loc}=\\{null}$;\2\6
\&{end}\C{loops forever if reading from a file, since $\\{null}=\\{min%
\_halfword}\L0$}\par
\U1203.\fi

\M1205. \P$\X1205:Ensure that box 255 is empty after output\X\S$\6
\&{if} $\\{box}(255)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Output\ routine\ didn\'t\ use\ all\ of\ "})$;\5
$\\{print\_esc}(\.{"box"})$;\5
$\\{print\_int}(255)$;\5
$\\{help3}(\.{"Your\ \\output\ commands\ should\ empty\ \\box255,"})$\6
$(\.{"e.g.,\ by\ saying\ \`\\shipout\\box255\'."})$\6
$(\.{"Proceed;\ I\'ll\ discard\ its\ present\ contents."})$;\5
$\\{box\_error}(255)$;\6
\&{end}\2\par
\U1203.\fi

\N1206.  \[46] The chief executive.
We come now to the \\{main\_control} routine, which contains the master
switch that causes all the various pieces of \TeX\ to do their things,
in the right order.

In a sense, this is the grand climax of the program: It applies all the
tools that we have worked so hard to construct. In another sense, this is
the messiest part of the program: It necessarily refers to other pieces
of code all over the place, so that a person can't fully understand what is
going on without paging back and forth to be reminded of conventions that
are defined elsewhere. We are now at the hub of the web, the central nervous
system that touches most of the other parts and ties them together.

The structure of \\{main\_control} itself is quite simple. There's a label
called \\{big\_switch}, at which point the next token of input is fetched
using \\{get\_x\_token}. Then the program branches at high speed into one of
about 100 possible directions, based on the value of the current
mode and the newly fetched command code; the sum $\\{abs}(\\{mode})+\\{cur%
\_cmd}$
indicates what to do next. For example, the case `$\\{vmode}+\\{letter}$'
arises
when a letter occurs in vertical mode (or internal vertical mode); this
case leads to instructions that initialize a new paragraph and enter
horizontal mode.

The big   \&{case}  statement that contains this multiway switch has been
labeled
\\{reswitch}, so that the program can \&{goto} \\{reswitch} when the next token
has already been fetched. Most of the cases are quite short; they call
an ``action procedure'' that does the work for that case, and then they
either \&{goto} \\{reswitch} or they ``fall through'' to the end of the   %
\&{case}
statement, which returns control back to \\{big\_switch}. Thus, \\{main%
\_control}
is not an extremely large procedure, in spite of the multiplicity of things
it must do; it is small enough to be handled by \PASCAL\ compilers that put
severe restrictions on procedure size.

One case is singled out for special treatment, because it accounts for most
of \TeX's activities in typical applications. The process of reading simple
text and converting it into \\{char\_node} records, while looking for ligatures
and kerns, is part of \TeX's ``inner loop''; the whole program runs
efficiently when its inner loop is fast, so this part has been written
with particular care.

\fi

\M1207. We shall concentrate first on the inner loop of \\{main\_control},
deferring
consideration of the other cases until later.

\Y\P\D \37$\\{big\_switch}=60$\C{go here to branch on the next token of input}%
\par
\P\D \37$\\{main\_loop}=70$\C{go here to typeset a string of consecutive
characters}\par
\P\D \37$\\{main\_loop\_wrapup}=80$\C{go here to finish a character or
ligature}\par
\P\D \37$\\{main\_loop\_move}=90$\C{go here to advance the ligature cursor}\par
\P\D \37$\\{main\_loop\_move\_lig}=95$\C{same, when advancing past a generated
ligature}\par
\P\D \37$\\{main\_loop\_lookahead}=100$\C{go here to bring in another
character, if any}\par
\P\D \37$\\{main\_lig\_loop}=110$\C{go here to check for ligatures or kerning}%
\par
\P\D \37$\\{append\_normal\_space}=120$\C{go here to append a normal space
between words}\par
\Y\P\hbox{\4}\X1221:Declare action procedures for use by \\{main\_control}\X\6
\hbox{\4}\X1246:Declare the procedure called \\{handle\_right\_brace}\X\6
\4\&{procedure}\1\  \37\\{main\_control};\C{governs \TeX's activities}\6
\4\&{label} \37$\\{big\_switch},\39\\{reswitch},\39\\{main\_loop},\39\\{main%
\_loop\_wrapup},\39\\{main\_loop\_move},\39\\{main\_loop\_move}+1,\39\\{main%
\_loop\_move}+2,\39\\{main\_loop\_move\_lig},\39\\{main\_loop\_lookahead},\39%
\\{main\_loop\_lookahead}+1,\39\\{main\_lig\_loop},\39\\{main\_lig\_loop}+1,\39%
\\{main\_lig\_loop}+2,\39\\{append\_normal\_space},\39\\{exit}$;\6
\4\&{var} \37\|t: \37\\{integer};\C{general-purpose temporary variable}\6
$\\{tmp\_k1},\39\\{tmp\_k2}$: \37\\{pointer};\C{for testing whether an auto
kern should be inserted}\2\6
\&{begin} \37\&{if} $\\{every\_job}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_job},\39\\{every\_job\_text})$;\2\6
\4\\{big\_switch}: \37\\{get\_x\_token};\6
\4\\{reswitch}: \37\X1208:Give diagnostic information, if requested\X;\6
\&{case} $\\{abs}(\\{mode})+\\{cur\_cmd}$ \1\&{of}\6
\4$\\{hmode}+\\{letter},\39\\{hmode}+\\{other\_char},\39\\{hmode}+\\{char%
\_given}$: \37\&{goto} \37\\{main\_loop};\6
\4$\\{hmode}+\\{char\_num}$: \37\&{begin} \37\\{scan\_char\_num};\5
$\\{cur\_chr}\K\\{cur\_val}$;\5
\&{goto} \37\\{main\_loop};\ \&{end};\6
\4$\\{hmode}+\\{no\_boundary}$: \37\&{begin} \37\\{get\_x\_token};\6
\&{if} $(\\{cur\_cmd}=\\{letter})\V(\\{cur\_cmd}=\\{other\_char})\V(\\{cur%
\_cmd}=\\{char\_given})\V(\\{cur\_cmd}=\\{char\_num})$ \1\&{then}\5
$\\{cancel\_boundary}\K\\{true}$;\2\6
\&{goto} \37\\{reswitch};\6
\&{end};\6
\4$\\{hmode}+\\{spacer}$: \37\&{if} $(\\{space\_factor}=1000)\V(\\{pdf\_adjust%
\_interword\_glue}>0)$ \1\&{then}\5
\&{goto} \37\\{append\_normal\_space}\6
\4\&{else} \\{app\_space};\2\6
\4$\\{hmode}+\\{ex\_space},\39\\{mmode}+\\{ex\_space}$: \37\&{goto} \37%
\\{append\_normal\_space};\6
\hbox{\4}\X1223:Cases of \\{main\_control} that are not part of the inner loop%
\X\2\6
\&{end};\C{of the big   \&{case}  statement}\6
\&{goto} \37\\{big\_switch};\6
\4\\{main\_loop}: \37\X1211:Append character \\{cur\_chr} and the following
characters (if~any) to the current hlist in the current font; \&{goto} %
\\{reswitch} when a non-character has been fetched\X;\6
\4\\{append\_normal\_space}: \37\X1219:Append a normal inter-word space to the
current list, then \&{goto} \\{big\_switch}\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1208. When a new token has just been fetched at \\{big\_switch}, we have an
ideal place to monitor \TeX's activity.

\Y\P$\4\X1208:Give diagnostic information, if requested\X\S$\6
\&{if} $\\{interrupt}\I0$ \1\&{then}\6
\&{if} $\\{OK\_to\_interrupt}$ \1\&{then}\6
\&{begin} \37\\{back\_input};\5
\\{check\_interrupt};\5
\&{goto} \37\\{big\_switch};\6
\&{end};\2\2\6
\&{debug} \37\&{if} $\\{panicking}$ \1\&{then}\5
$\\{check\_mem}(\\{false})$;\ \2\ \&{gubed}\6
\&{if} $\\{tracing\_commands}>0$ \1\&{then}\5
\\{show\_cur\_cmd\_chr}\2\par
\U1207.\fi

\M1209. The following part of the program was first written in a structured
manner, according to the philosophy that ``premature optimization is
the root of all evil.'' Then it was rearranged into pieces of
spaghetti so that the most common actions could proceed with little or
no redundancy.

The original unoptimized form of this algorithm resembles the
\\{reconstitute} procedure, which was described earlier in connection with
hyphenation. Again we have an implied ``cursor'' between characters
\\{cur\_l} and \\{cur\_r}. The main difference is that the \\{lig\_stack} can
now
contain a charnode as well as pseudo-ligatures; that stack is now
usually nonempty, because the next character of input (if any) has been
appended to it. In \\{main\_control} we have
$$\\{cur\_r}=\cases{$\\{character}(\\{lig\_stack})$,&if $\\{lig\_stack}>%
\\{null}$;\cr
$\\{font\_bchar}[\\{cur\_font}]$,&otherwise;\cr}$$
except when $\\{character}(\\{lig\_stack})=\\{font\_false\_bchar}[\\{cur%
\_font}]$.
Several additional global variables are needed.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{main\_f}: \37\\{internal\_font\_number};\C{the current font}\6
\4\\{main\_i}: \37\\{four\_quarters};\C{character information bytes for \\{cur%
\_l}}\6
\4\\{main\_j}: \37\\{four\_quarters};\C{ligature/kern command}\6
\4\\{main\_k}: \37\\{font\_index};\C{index into \\{font\_info}}\6
\4\\{main\_p}: \37\\{pointer};\C{temporary register for list manipulation}\6
\4\\{main\_s}: \37\\{integer};\C{space factor value}\6
\4\\{bchar}: \37\\{halfword};\C{boundary character of current font, or \\{non%
\_char}}\6
\4\\{false\_bchar}: \37\\{halfword};\C{nonexistent character matching %
\\{bchar}, or \\{non\_char}}\6
\4\\{cancel\_boundary}: \37\\{boolean};\C{should the left boundary be ignored?}%
\6
\4\\{ins\_disc}: \37\\{boolean};\C{should we insert a discretionary node?}\par
\fi

\M1210. The boolean variables of the main loop are normally false, and always
reset
to false before the loop is left. That saves us the extra work of initializing
each time.

\Y\P$\4\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{ligature\_present}\K\\{false}$;\5
$\\{cancel\_boundary}\K\\{false}$;\5
$\\{lft\_hit}\K\\{false}$;\5
$\\{rt\_hit}\K\\{false}$;\5
$\\{ins\_disc}\K\\{false}$;\par
\fi

\M1211. We leave the \\{space\_factor} unchanged if $\\{sf\_code}(\\{cur%
\_chr})=0$; otherwise we
set it equal to $\\{sf\_code}(\\{cur\_chr})$, except that it should never
change
from a value less than 1000 to a value exceeding 1000. The most common
case is $\\{sf\_code}(\\{cur\_chr})=1000$, so we want that case to be fast.

The overall structure of the main loop is presented here. Some program labels
are inside the individual sections.

\Y\P\D \37$\\{adjust\_space\_factor}\S\hbox{}$\6
$\\{main\_s}\K\\{sf\_code}(\\{cur\_chr})$;\6
\&{if} $\\{main\_s}=1000$ \1\&{then}\5
$\\{space\_factor}\K1000$\6
\4\&{else} \&{if} $\\{main\_s}<1000$ \1\&{then}\6
\&{begin} \37\&{if} $\\{main\_s}>0$ \1\&{then}\5
$\\{space\_factor}\K\\{main\_s}$;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{space\_factor}<1000$ \1\&{then}\5
$\\{space\_factor}\K1000$\6
\4\&{else} $\\{space\_factor}\K\\{main\_s}$\2\2\2\par
\Y\P$\4\X1211:Append character \\{cur\_chr} and the following characters
(if~any) to the current hlist in the current font; \&{goto} \\{reswitch} when a
non-character has been fetched\X\S$\6
\\{adjust\_space\_factor};\6
$\\{save\_tail}\K\\{null}$;\5
$\\{main\_f}\K\\{cur\_font}$;\5
$\\{bchar}\K\\{font\_bchar}[\\{main\_f}]$;\5
$\\{false\_bchar}\K\\{font\_false\_bchar}[\\{main\_f}]$;\6
\&{if} $\\{mode}>0$ \1\&{then}\6
\&{if} $\\{language}\I\\{clang}$ \1\&{then}\5
\\{fix\_language};\2\2\6
$\\{fast\_get\_avail}(\\{lig\_stack})$;\5
$\\{font}(\\{lig\_stack})\K\\{main\_f}$;\5
$\\{cur\_l}\K\\{qi}(\\{cur\_chr})$;\5
$\\{character}(\\{lig\_stack})\K\\{cur\_l}$;\6
$\\{cur\_q}\K\\{tail}$;\5
$\\{tmp\_k1}\K\\{get\_auto\_kern}(\\{main\_f},\39\\{non\_char},\39\\{cur\_l})$;%
\5
\X1217:If \\{tmp\_k1} is not null then append that kern\X;\6
\&{if} $\\{cancel\_boundary}$ \1\&{then}\6
\&{begin} \37$\\{cancel\_boundary}\K\\{false}$;\5
$\\{main\_k}\K\\{non\_address}$;\6
\&{end}\6
\4\&{else} $\\{main\_k}\K\\{bchar\_label}[\\{main\_f}]$;\2\6
\&{if} $\\{main\_k}=\\{non\_address}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_move}+2$;\C{no left boundary processing}\2\6
$\\{cur\_r}\K\\{cur\_l}$;\5
$\\{cur\_l}\K\\{non\_char}$;\5
\&{goto} \37$\\{main\_lig\_loop}+1$;\C{begin with cursor after left boundary}\7
\4\\{main\_loop\_wrapup}: \37\X1212:Make a ligature node, if \\{ligature%
\_present}; insert a null discretionary, if appropriate\X;\6
\4\\{main\_loop\_move}: \37\X1213:If the cursor is immediately followed by the
right boundary, \&{goto} \\{reswitch}; if it's followed by an invalid
character, \&{goto} \\{big\_switch}; otherwise move the cursor one step to the
right and \&{goto} \\{main\_lig\_loop}\X;\6
\4\\{main\_loop\_lookahead}: \37\X1215:Look ahead for another character, or
leave \\{lig\_stack} empty if there's none there\X;\6
\4\\{main\_lig\_loop}: \37\X1216:If there's a ligature/kern command relevant to
\\{cur\_l} and \\{cur\_r}, adjust the text appropriately; exit to \\{main\_loop%
\_wrapup}\X;\6
\4\\{main\_loop\_move\_lig}: \37\X1214:Move the cursor past a pseudo-ligature,
then \&{goto} \\{main\_loop\_lookahead} or \\{main\_lig\_loop}\X\par
\U1207.\fi

\M1212. If $\\{link}(\\{cur\_q})$ is nonnull when \\{wrapup} is invoked, \\{cur%
\_q} points to
the list of characters that were consumed while building the ligature
character~\\{cur\_l}.

A discretionary break is not inserted for an explicit hyphen when we are in
restricted horizontal mode. In particular, this avoids putting discretionary
nodes inside of other discretionaries.

\Y\P\D \37$\\{pack\_lig}(\#)\S$\C{the parameter is either \\{rt\_hit} or %
\\{false}}\6
\&{begin} \37$\\{main\_p}\K\\{new\_ligature}(\\{main\_f},\39\\{cur\_l},\39%
\\{link}(\\{cur\_q}))$;\6
\&{if} $\\{lft\_hit}$ \1\&{then}\6
\&{begin} \37$\\{subtype}(\\{main\_p})\K2$;\5
$\\{lft\_hit}\K\\{false}$;\6
\&{end};\2\6
\&{if} $\#$ \1\&{then}\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{incr}(\\{subtype}(\\{main\_p}))$;\5
$\\{rt\_hit}\K\\{false}$;\6
\&{end};\2\2\6
\&{if} $\\{pdf\_prepend\_kern}>0$ \1\&{then}\5
$\\{tmp\_k2}\K\\{get\_auto\_kern}(\\{main\_f},\39\\{non\_char},\39\\{cur\_l})$\6
\4\&{else} $\\{tmp\_k2}\K\\{null}$;\2\6
\&{if} $\\{tmp\_k2}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{link}(\\{cur\_q})\K\\{main\_p}$;\5
$\\{tail}\K\\{main\_p}$;\5
$\\{ligature\_present}\K\\{false}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{link}(\\{cur\_q})\K\\{tmp\_k2}$;\5
$\\{link}(\\{tmp\_k2})\K\\{main\_p}$;\5
$\\{tail}\K\\{main\_p}$;\5
$\\{ligature\_present}\K\\{false}$;\6
\&{end}\2\6
\&{end}\par
\P\D \37$\\{wrapup}(\#)\S$\1\6
\&{if} $\\{cur\_l}<\\{non\_char}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{link}(\\{cur\_q})>\\{null}$ \1\&{then}\6
\&{if} $\\{character}(\\{tail})=\\{qi}(\\{hyphen\_char}[\\{main\_f}])$ \1%
\&{then}\5
$\\{ins\_disc}\K\\{true}$;\2\2\6
\&{if} $\\{ligature\_present}$ \1\&{then}\5
$\\{pack\_lig}(\#)$;\2\6
\&{if} $\\{ins\_disc}$ \1\&{then}\6
\&{begin} \37$\\{ins\_disc}\K\\{false}$;\6
\&{if} $\\{mode}>0$ \1\&{then}\5
$\\{tail\_append}(\\{new\_disc})$;\2\6
\&{end};\2\6
\&{end}\2\2\par
\Y\P$\4\X1212:Make a ligature node, if \\{ligature\_present}; insert a null
discretionary, if appropriate\X\S$\6
$\\{wrapup}(\\{rt\_hit})$\par
\U1211.\fi

\M1213. \P$\X1213:If the cursor is immediately followed by the right boundary, %
\&{goto} \\{reswitch}; if it's followed by an invalid character, \&{goto} %
\\{big\_switch}; otherwise move the cursor one step to the right and \&{goto} %
\\{main\_lig\_loop}\X\S$\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\5
\&{goto} \37\\{reswitch};\2\6
$\\{cur\_q}\K\\{tail}$;\5
$\\{cur\_l}\K\\{character}(\\{lig\_stack})$;\6
\4$\\{main\_loop\_move}+1$: \37\&{if} $\R\\{is\_char\_node}(\\{lig\_stack})$ \1%
\&{then}\5
\&{goto} \37\\{main\_loop\_move\_lig};\2\6
\4$\\{main\_loop\_move}+2$: \37\&{if} $(\\{cur\_chr}<\\{font\_bc}[\\{main\_f}])%
\V(\\{cur\_chr}>\\{font\_ec}[\\{main\_f}])$ \1\&{then}\6
\&{begin} \37$\\{char\_warning}(\\{main\_f},\39\\{cur\_chr})$;\5
$\\{free\_avail}(\\{lig\_stack})$;\5
\&{goto} \37\\{big\_switch};\6
\&{end};\2\6
$\\{main\_i}\K\\{char\_info}(\\{main\_f})(\\{cur\_l})$;\6
\&{if} $\R\\{char\_exists}(\\{main\_i})$ \1\&{then}\6
\&{begin} \37$\\{char\_warning}(\\{main\_f},\39\\{cur\_chr})$;\5
$\\{free\_avail}(\\{lig\_stack})$;\5
\&{goto} \37\\{big\_switch};\6
\&{end};\2\6
$\\{link}(\\{tail})\K\\{lig\_stack}$;\5
$\\{tail}\K\\{lig\_stack}$\C{\\{main\_loop\_lookahead} is next}\par
\U1211.\fi

\M1214. Here we are at \\{main\_loop\_move\_lig}.
When we begin this code we have $\\{cur\_q}=\\{tail}$ and $\\{cur\_l}=%
\\{character}(\\{lig\_stack})$.

\Y\P$\4\X1214:Move the cursor past a pseudo-ligature, then \&{goto} \\{main%
\_loop\_lookahead} or \\{main\_lig\_loop}\X\S$\6
$\\{main\_p}\K\\{lig\_ptr}(\\{lig\_stack})$;\6
\&{if} $\\{main\_p}>\\{null}$ \1\&{then}\5
$\\{tail\_append}(\\{main\_p})$;\C{append a single character}\2\6
$\\{temp\_ptr}\K\\{lig\_stack}$;\5
$\\{lig\_stack}\K\\{link}(\\{temp\_ptr})$;\5
$\\{free\_node}(\\{temp\_ptr},\39\\{small\_node\_size})$;\5
$\\{main\_i}\K\\{char\_info}(\\{main\_f})(\\{cur\_l})$;\5
$\\{ligature\_present}\K\\{true}$;\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\6
\&{if} $\\{main\_p}>\\{null}$ \1\&{then}\5
\&{goto} \37\\{main\_loop\_lookahead}\6
\4\&{else} $\\{cur\_r}\K\\{bchar}$\2\6
\4\&{else} $\\{cur\_r}\K\\{character}(\\{lig\_stack})$;\2\6
\&{goto} \37\\{main\_lig\_loop}\par
\U1211.\fi

\M1215. The result of \.{\\char} can participate in a ligature or kern, so we
must
look ahead for it.

\Y\P$\4\X1215:Look ahead for another character, or leave \\{lig\_stack} empty
if there's none there\X\S$\6
\\{get\_next};\C{set only \\{cur\_cmd} and \\{cur\_chr}, for speed}\6
\&{if} $\\{cur\_cmd}=\\{letter}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\&{if} $\\{cur\_cmd}=\\{other\_char}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\&{if} $\\{cur\_cmd}=\\{char\_given}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\\{x\_token};\C{now expand and set \\{cur\_cmd}, \\{cur\_chr}, \\{cur\_tok}}\6
\&{if} $\\{cur\_cmd}=\\{letter}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\&{if} $\\{cur\_cmd}=\\{other\_char}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\&{if} $\\{cur\_cmd}=\\{char\_given}$ \1\&{then}\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\2\6
\&{if} $\\{cur\_cmd}=\\{char\_num}$ \1\&{then}\6
\&{begin} \37\\{scan\_char\_num};\5
$\\{cur\_chr}\K\\{cur\_val}$;\5
\&{goto} \37$\\{main\_loop\_lookahead}+1$;\6
\&{end};\2\6
\&{if} $\\{cur\_cmd}=\\{no\_boundary}$ \1\&{then}\5
$\\{bchar}\K\\{non\_char}$;\2\6
$\\{cur\_r}\K\\{bchar}$;\5
$\\{lig\_stack}\K\\{null}$;\5
\&{goto} \37\\{main\_lig\_loop};\6
\4$\\{main\_loop\_lookahead}+1$: \37\\{adjust\_space\_factor};\5
$\\{fast\_get\_avail}(\\{lig\_stack})$;\5
$\\{font}(\\{lig\_stack})\K\\{main\_f}$;\5
$\\{cur\_r}\K\\{qi}(\\{cur\_chr})$;\5
$\\{character}(\\{lig\_stack})\K\\{cur\_r}$;\6
\&{if} $\\{cur\_r}=\\{false\_bchar}$ \1\&{then}\5
$\\{cur\_r}\K\\{non\_char}$\C{this prevents spurious ligatures}\2\par
\U1211.\fi

\M1216. Even though comparatively few characters have a lig/kern program,
several
of the instructions here count as part of \TeX's inner loop, since a
potentially long sequential search must be performed. For example, tests with
Computer Modern Roman showed that about 40 per cent of all characters
actually encountered in practice had a lig/kern program, and that about four
lig/kern commands were investigated for every such character.

At the beginning of this code we have $\\{main\_i}=\\{char\_info}(\\{main\_f})(%
\\{cur\_l})$.

\Y\P$\4\X1216:If there's a ligature/kern command relevant to \\{cur\_l} and %
\\{cur\_r}, adjust the text appropriately; exit to \\{main\_loop\_wrapup}\X\S$\6
$\\{tmp\_k1}\K\\{get\_auto\_kern}(\\{main\_f},\39\\{cur\_l},\39\\{cur\_r})$;\5
\X1217:If \\{tmp\_k1} is not null then append that kern\X;\6
\&{if} $\\{char\_tag}(\\{main\_i})\I\\{lig\_tag}$ \1\&{then}\5
\&{goto} \37\\{main\_loop\_wrapup};\2\6
\&{if} $\\{cur\_r}=\\{non\_char}$ \1\&{then}\5
\&{goto} \37\\{main\_loop\_wrapup};\2\6
$\\{main\_k}\K\\{lig\_kern\_start}(\\{main\_f})(\\{main\_i})$;\5
$\\{main\_j}\K\\{font\_info}[\\{main\_k}].\\{qqqq}$;\6
\&{if} $\\{skip\_byte}(\\{main\_j})\L\\{stop\_flag}$ \1\&{then}\5
\&{goto} \37$\\{main\_lig\_loop}+2$;\2\6
$\\{main\_k}\K\\{lig\_kern\_restart}(\\{main\_f})(\\{main\_j})$;\6
\4$\\{main\_lig\_loop}+1$: \37$\\{main\_j}\K\\{font\_info}[\\{main\_k}].%
\\{qqqq}$;\6
\4$\\{main\_lig\_loop}+2$: \37\&{if} $\\{next\_char}(\\{main\_j})=\\{cur\_r}$ %
\1\&{then}\6
\&{if} $\\{skip\_byte}(\\{main\_j})\L\\{stop\_flag}$ \1\&{then}\5
\X1218:Do ligature or kern command, returning to \\{main\_lig\_loop} or \\{main%
\_loop\_wrapup} or \\{main\_loop\_move}\X;\2\2\6
\&{if} $\\{skip\_byte}(\\{main\_j})=\\{qi}(0)$ \1\&{then}\5
$\\{incr}(\\{main\_k})$\6
\4\&{else} \&{begin} \37\&{if} $\\{skip\_byte}(\\{main\_j})\G\\{stop\_flag}$ \1%
\&{then}\5
\&{goto} \37\\{main\_loop\_wrapup};\2\6
$\\{main\_k}\K\\{main\_k}+\\{qo}(\\{skip\_byte}(\\{main\_j}))+1$;\6
\&{end};\2\6
\&{goto} \37$\\{main\_lig\_loop}+1$\par
\U1211.\fi

\M1217. \P$\X1217:If \\{tmp\_k1} is not null then append that kern\X\S$\6
\&{if} $\\{tmp\_k1}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{wrapup}(\\{rt\_hit})$;\C{Note: \\{wrapup} might insert a null
discretionary}\6
$\\{save\_tail}\K\\{tail}$;\C{insert auto-kern before a null discretionary
inserted by \\{wrapup} if appropriate}\6
\&{if} $(\R\\{is\_char\_node}(\\{tail}))\W(\\{type}(\\{tail})=\\{disc\_node})%
\W(\\{replace\_count}(\\{tail})=0)\W(\\{pre\_break}(\\{tail})=\\{null})\W(%
\\{post\_break}(\\{tail})=\\{null})\W(\\{link}(\\{prev\_tail})=\\{tail})$ \1%
\&{then}\6
\&{begin} \37$\\{insert\_before\_tail}(\\{tmp\_k1})$;\6
\&{end}\6
\4\&{else} $\\{tail\_append}(\\{tmp\_k1})$;\2\6
\&{goto} \37\\{main\_loop\_move};\6
\&{end}\2\par
\Us1211\ET1216.\fi

\M1218. When a ligature or kern instruction matches a character, we know from
\\{read\_font\_info} that the character exists in the font, even though we
haven't verified its existence in the normal way.

This section could be made into a subroutine, if the code inside
\\{main\_control} needs to be shortened.

\chardef\?='174 % vertical line to indicate character retention

\Y\P$\4\X1218:Do ligature or kern command, returning to \\{main\_lig\_loop} or %
\\{main\_loop\_wrapup} or \\{main\_loop\_move}\X\S$\6
\&{begin} \37\&{if} $\\{op\_byte}(\\{main\_j})\G\\{kern\_flag}$ \1\&{then}\6
\&{begin} \37$\\{wrapup}(\\{rt\_hit})$;\5
$\\{tail\_append}(\\{new\_kern}(\\{char\_kern}(\\{main\_f})(\\{main\_j})))$;\5
\&{goto} \37\\{main\_loop\_move};\6
\&{end};\2\6
\&{if} $\\{cur\_l}=\\{non\_char}$ \1\&{then}\5
$\\{lft\_hit}\K\\{true}$\6
\4\&{else} \&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\5
$\\{rt\_hit}\K\\{true}$;\2\2\6
\\{check\_interrupt};\C{allow a way out in case there's an infinite ligature
loop}\6
\&{case} $\\{op\_byte}(\\{main\_j})$ \1\&{of}\6
\4$\\{qi}(1),\39\\{qi}(5)$: \37\&{begin} \37$\\{cur\_l}\K\\{rem\_byte}(\\{main%
\_j})$;\C{\.{=:\?}, \.{=:\?>}}\6
$\\{main\_i}\K\\{char\_info}(\\{main\_f})(\\{cur\_l})$;\5
$\\{ligature\_present}\K\\{true}$;\6
\&{end};\6
\4$\\{qi}(2),\39\\{qi}(6)$: \37\&{begin} \37$\\{cur\_r}\K\\{rem\_byte}(\\{main%
\_j})$;\C{\.{\?=:}, \.{\?=:>}}\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\C{right boundary character is being
consumed}\6
\&{begin} \37$\\{lig\_stack}\K\\{new\_lig\_item}(\\{cur\_r})$;\5
$\\{bchar}\K\\{non\_char}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{is\_char\_node}(\\{lig\_stack})$ \1\&{then}\C{$\\{link}(%
\\{lig\_stack})=\\{null}$}\6
\&{begin} \37$\\{main\_p}\K\\{lig\_stack}$;\5
$\\{lig\_stack}\K\\{new\_lig\_item}(\\{cur\_r})$;\5
$\\{lig\_ptr}(\\{lig\_stack})\K\\{main\_p}$;\6
\&{end}\6
\4\&{else} $\\{character}(\\{lig\_stack})\K\\{cur\_r}$;\2\2\6
\&{end};\6
\4$\\{qi}(3)$: \37\&{begin} \37$\\{cur\_r}\K\\{rem\_byte}(\\{main\_j})$;\C{\.{%
\?=:\?}}\6
$\\{main\_p}\K\\{lig\_stack}$;\5
$\\{lig\_stack}\K\\{new\_lig\_item}(\\{cur\_r})$;\5
$\\{link}(\\{lig\_stack})\K\\{main\_p}$;\6
\&{end};\6
\4$\\{qi}(7),\39\\{qi}(11)$: \37\&{begin} \37$\\{wrapup}(\\{false})$;\C{\.{\?=:%
\?>}, \.{\?=:\?>>}}\6
$\\{cur\_q}\K\\{tail}$;\5
$\\{cur\_l}\K\\{rem\_byte}(\\{main\_j})$;\5
$\\{main\_i}\K\\{char\_info}(\\{main\_f})(\\{cur\_l})$;\5
$\\{ligature\_present}\K\\{true}$;\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37$\\{cur\_l}\K\\{rem\_byte}(\\{main\_j})$;\5
$\\{ligature\_present}\K\\{true}$;\C{\.{=:}}\6
\&{if} $\\{lig\_stack}=\\{null}$ \1\&{then}\5
\&{goto} \37\\{main\_loop\_wrapup}\6
\4\&{else} \&{goto} \37$\\{main\_loop\_move}+1$;\2\6
\&{end}\2\6
\&{endcases};\6
\&{if} $\\{op\_byte}(\\{main\_j})>\\{qi}(4)$ \1\&{then}\6
\&{if} $\\{op\_byte}(\\{main\_j})\I\\{qi}(7)$ \1\&{then}\5
\&{goto} \37\\{main\_loop\_wrapup};\2\2\6
\&{if} $\\{cur\_l}<\\{non\_char}$ \1\&{then}\5
\&{goto} \37\\{main\_lig\_loop};\2\6
$\\{main\_k}\K\\{bchar\_label}[\\{main\_f}]$;\5
\&{goto} \37$\\{main\_lig\_loop}+1$;\6
\&{end}\par
\U1216.\fi

\M1219. The occurrence of blank spaces is almost part of \TeX's inner loop,
since we usually encounter about one space for every five non-blank characters.
Therefore \\{main\_control} gives second-highest priority to ordinary spaces.

When a glue parameter like \.{\\spaceskip} is set to `\.{0pt}', we will
see to it later that the corresponding glue specification is precisely
\\{zero\_glue}, not merely a pointer to some specification that happens
to be full of zeroes. Therefore it is simple to test whether a glue parameter
is zero or~not.

\Y\P$\4\X1219:Append a normal inter-word space to the current list, then %
\&{goto} \\{big\_switch}\X\S$\6
\&{if} $\\{space\_skip}=\\{zero\_glue}$ \1\&{then}\6
\&{begin} \37\X1220:Find the glue specification, \\{main\_p}, for text spaces
in the current font\X;\6
$\\{temp\_ptr}\K\\{new\_glue}(\\{main\_p})$;\6
\&{end}\6
\4\&{else} $\\{temp\_ptr}\K\\{new\_param\_glue}(\\{space\_skip\_code})$;\2\6
\&{if} $\\{pdf\_adjust\_interword\_glue}>0$ \1\&{then}\5
$\\{adjust\_interword\_glue}(\\{tail},\39\\{temp\_ptr})$;\2\6
$\\{link}(\\{tail})\K\\{temp\_ptr}$;\5
$\\{tail}\K\\{temp\_ptr}$;\5
\&{goto} \37\\{big\_switch}\par
\U1207.\fi

\M1220. Having \\{font\_glue} allocated for each text font saves both time and
memory.
If any of the three spacing parameters are subsequently changed by the
use of \.{\\fontdimen}, the \\{find\_font\_dimen} procedure deallocates the
\\{font\_glue} specification allocated here.

\Y\P$\4\X1220:Find the glue specification, \\{main\_p}, for text spaces in the
current font\X\S$\6
\&{begin} \37$\\{main\_p}\K\\{font\_glue}[\\{cur\_font}]$;\6
\&{if} $\\{main\_p}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{main\_p}\K\\{new\_spec}(\\{zero\_glue})$;\5
$\\{main\_k}\K\\{param\_base}[\\{cur\_font}]+\\{space\_code}$;\5
$\\{width}(\\{main\_p})\K\\{font\_info}[\\{main\_k}].\\{sc}$;\C{that's $%
\\{space}(\\{cur\_font})$}\6
$\\{stretch}(\\{main\_p})\K\\{font\_info}[\\{main\_k}+1].\\{sc}$;\C{and $%
\\{space\_stretch}(\\{cur\_font})$}\6
$\\{shrink}(\\{main\_p})\K\\{font\_info}[\\{main\_k}+2].\\{sc}$;\C{and $%
\\{space\_shrink}(\\{cur\_font})$}\6
$\\{font\_glue}[\\{cur\_font}]\K\\{main\_p}$;\6
\&{end};\2\6
\&{end}\par
\Us1219\ET1221.\fi

\M1221. \P$\X1221:Declare action procedures for use by \\{main\_control}\X\S$\6
\4\&{procedure}\1\  \37\\{app\_space};\C{handle spaces when $\\{space\_factor}%
\I1000$}\6
\4\&{var} \37\|q: \37\\{pointer};\C{glue node}\2\6
\&{begin} \37\&{if} $(\\{space\_factor}\G2000)\W(\\{xspace\_skip}\I\\{zero%
\_glue})$ \1\&{then}\5
$\|q\K\\{new\_param\_glue}(\\{xspace\_skip\_code})$\6
\4\&{else} \&{begin} \37\&{if} $\\{space\_skip}\I\\{zero\_glue}$ \1\&{then}\5
$\\{main\_p}\K\\{space\_skip}$\6
\4\&{else} \X1220:Find the glue specification, \\{main\_p}, for text spaces in
the current font\X;\2\6
$\\{main\_p}\K\\{new\_spec}(\\{main\_p})$;\5
\X1222:Modify the glue specification in \\{main\_p} according to the space
factor\X;\6
$\|q\K\\{new\_glue}(\\{main\_p})$;\5
$\\{glue\_ref\_count}(\\{main\_p})\K\\{null}$;\6
\&{end};\2\6
$\\{link}(\\{tail})\K\|q$;\5
$\\{tail}\K\|q$;\6
\&{end};\par
\As1225, 1227, 1228, 1229, 1232, 1238, 1239, 1242, 1247, 1248, 1253, 1257,
1262, 1264, 1269, 1271, 1273, 1274, 1277, 1279, 1281, 1283, 1288, 1291, 1295,
1297, 1301, 1305, 1307, 1309, 1313, 1314, 1316, 1320, 1329, 1333, 1337, 1338,
1341, 1343, 1350, 1352, 1354, 1359, 1369, 1372, 1378, 1389, 1448, 1453, 1457,
1466, 1471, 1480, 1528\ETs1624.
\U1207.\fi

\M1222. \P$\X1222:Modify the glue specification in \\{main\_p} according to the
space factor\X\S$\6
\&{if} $\\{space\_factor}\G2000$ \1\&{then}\5
$\\{width}(\\{main\_p})\K\\{width}(\\{main\_p})+\\{extra\_space}(\\{cur%
\_font})$;\2\6
$\\{stretch}(\\{main\_p})\K\\{xn\_over\_d}(\\{stretch}(\\{main\_p}),\39\\{space%
\_factor},\391000)$;\5
$\\{shrink}(\\{main\_p})\K\\{xn\_over\_d}(\\{shrink}(\\{main\_p}),\391000,\39%
\\{space\_factor})$\par
\U1221.\fi

\M1223. Whew---that covers the main loop. We can now proceed at a leisurely
pace through the other combinations of possibilities.

\Y\P\D \37$\\{any\_mode}(\#)\S\\{vmode}+\#,\39\\{hmode}+\#,\39\\{mmode}+\#$%
\C{for mode-independent commands}\par
\Y\P$\4\X1223:Cases of \\{main\_control} that are not part of the inner loop\X%
\S$\6
\4$\\{any\_mode}(\\{relax}),\39\\{vmode}+\\{spacer},\39\\{mmode}+\\{spacer},\39%
\\{mmode}+\\{no\_boundary}$: \37\\{do\_nothing};\6
\4$\\{any\_mode}(\\{ignore\_spaces})$: \37\&{begin} \37\&{if} $\\{cur\_chr}=0$ %
\1\&{then}\6
\&{begin} \37\X432:Get the next non-blank non-call token\X;\6
\&{goto} \37\\{reswitch};\6
\&{end}\6
\4\&{else} \&{begin} \37$\|t\K\\{scanner\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_next};\5
$\\{scanner\_status}\K\|t$;\6
\&{if} $\\{cur\_cs}<\\{hash\_base}$ \1\&{then}\5
$\\{cur\_cs}\K\\{prim\_lookup}(\\{cur\_cs}-\\{single\_base})$\6
\4\&{else} $\\{cur\_cs}\K\\{prim\_lookup}(\\{text}(\\{cur\_cs}))$;\2\6
\&{if} $\\{cur\_cs}\I\\{undefined\_primitive}$ \1\&{then}\6
\&{begin} \37$\\{cur\_cmd}\K\\{prim\_eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{prim\_equiv}(\\{cur\_cs})$;\5
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{prim\_eqtb\_base}+\\{cur\_cs}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{end};\2\6
\&{end};\6
\4$\\{vmode}+\\{stop}$: \37\&{if} $\\{its\_all\_over}$ \1\&{then}\5
\&{return};\C{this is the only way out}\2\6
\hbox{\4}\X1226:Forbidden cases detected in \\{main\_control}\X\ $\,\\{any%
\_mode}(\\{mac\_param})$: \37\\{report\_illegal\_case};\6
\4\X1224:Math-only cases in non-math modes, or vice versa\X: \37\\{insert%
\_dollar\_sign};\5
\hbox{\4}\X1234:Cases of \\{main\_control} that build boxes and lists\X\6
\hbox{\4}\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X\6
\hbox{\4}\X1527:Cases of \\{main\_control} that are for extensions to \TeX\X\par
\U1207.\fi

\M1224. Here is a list of cases where the user has probably gotten into or out
of math
mode by mistake. \TeX\ will insert a dollar sign and rescan the current token.

\Y\P\D \37$\\{non\_math}(\#)\S\\{vmode}+\#,\39\\{hmode}+\#$\par
\Y\P$\4\X1224:Math-only cases in non-math modes, or vice versa\X\S$\6
$\\{non\_math}(\\{sup\_mark}),\39\\{non\_math}(\\{sub\_mark}),\39\\{non\_math}(%
\\{math\_char\_num}),\39\\{non\_math}(\\{math\_given}),\39\\{non\_math}(\\{math%
\_comp}),\39\\{non\_math}(\\{delim\_num}),\39\\{non\_math}(\\{left\_right}),\39%
\\{non\_math}(\\{above}),\39\\{non\_math}(\\{radical}),\39\\{non\_math}(\\{math%
\_style}),\39\\{non\_math}(\\{math\_choice}),\39\\{non\_math}(\\{vcenter}),\39%
\\{non\_math}(\\{non\_script}),\39\\{non\_math}(\\{mkern}),\39\\{non\_math}(%
\\{limit\_switch}),\39\\{non\_math}(\\{mskip}),\39\\{non\_math}(\\{math%
\_accent}),\39\\{mmode}+\\{endv},\39\\{mmode}+\\{par\_end},\39\\{mmode}+%
\\{stop},\39\\{mmode}+\\{vskip},\39\\{mmode}+\\{un\_vbox},\39\\{mmode}+%
\\{valign},\39\\{mmode}+\\{hrule}$\par
\U1223.\fi

\M1225. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{insert\_dollar\_sign};\2\6
\&{begin} \37\\{back\_input};\5
$\\{cur\_tok}\K\\{math\_shift\_token}+\.{"\$"}$;\5
$\\{print\_err}(\.{"Missing\ \$\ inserted"})$;\5
$\\{help2}(\.{"I\'ve\ inserted\ a\ begin-math/end-math\ symbol\ since\ I\
think"})$\6
$(\.{"you\ left\ one\ out.\ Proceed,\ with\ fingers\ crossed."})$;\5
\\{ins\_error};\6
\&{end};\par
\fi

\M1226. When erroneous situations arise, \TeX\ usually issues an error message
specific to the particular error. For example, `\.{\\noalign}' should
not appear in any mode, since it is recognized by the \\{align\_peek} routine
in all of its legitimate appearances; a special error message is given
when `\.{\\noalign}' occurs elsewhere. But sometimes the most appropriate
error message is simply that the user is not allowed to do what he or she
has attempted. For example, `\.{\\moveleft}' is allowed only in vertical mode,
and `\.{\\lower}' only in non-vertical modes.  Such cases are enumerated
here and in the other sections referred to under `See also \dots.'

\Y\P$\4\X1226:Forbidden cases detected in \\{main\_control}\X\S$\6
$\\{vmode}+\\{vmove},\39\\{hmode}+\\{hmove},\39\\{mmode}+\\{hmove},\39\\{any%
\_mode}(\\{last\_item}),\39$\par
\As1276, 1289\ETs1322.
\U1223.\fi

\M1227. The `\\{you\_cant}' procedure prints a line saying that the current
command
is illegal in the current mode; it identifies these things symbolically.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{you\_cant};\2\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print}(\.{"\'\ in\ "})$;\5
$\\{print\_mode}(\\{mode})$;\6
\&{end};\par
\fi

\M1228. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{report\_illegal\_case};\2\6
\&{begin} \37\\{you\_cant};\5
$\\{help4}(\.{"Sorry,\ but\ I\'m\ not\ programmed\ to\ handle\ this\ case;"})$\6
$(\.{"I\'ll\ just\ pretend\ that\ you\ didn\'t\ ask\ for\ it."})$\6
$(\.{"If\ you\'re\ in\ the\ wrong\ mode,\ you\ might\ be\ able\ to"})$\6
$(\.{"return\ to\ the\ right\ one\ by\ typing\ \`I\}\'\ or\ \`I\$\'\ or\ \`I%
\\par\'."})$;\6
\\{error};\6
\&{end};\par
\fi

\M1229. Some operations are allowed only in privileged modes, i.e., in cases
that $\\{mode}>0$. The \\{privileged} function is used to detect violations
of this rule; it issues an error message and returns \\{false} if the
current \\{mode} is negative.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37\\{privileged}: \37\\{boolean};\2\6
\&{begin} \37\&{if} $\\{mode}>0$ \1\&{then}\5
$\\{privileged}\K\\{true}$\6
\4\&{else} \&{begin} \37\\{report\_illegal\_case};\5
$\\{privileged}\K\\{false}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1230. Either \.{\\dump} or \.{\\end} will cause \\{main\_control} to enter
the
endgame, since both of them have `\\{stop}' as their command code.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"end"},\39\\{stop},\390)$;\6
$\\{primitive}(\.{"dump"},\39\\{stop},\391)$;\par
\fi

\M1231. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{stop}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"dump"})$\ \&{else} $\\{print\_esc}(\.{"end"})$;\2\par
\fi

\M1232. We don't want to leave \\{main\_control} immediately when a \\{stop}
command
is sensed, because it may be necessary to invoke an \.{\\output} routine
several times before things really grind to a halt. (The output routine
might even say `\.{\\gdef\\end\{...\}}', to prolong the life of the job.)
Therefore \\{its\_all\_over} is \\{true} only when the current page
and contribution list are empty, and when the last output was not a
``dead cycle.''

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37\\{its\_all\_over}: \37\\{boolean};\C{do this when \.{%
\\end} or \.{\\dump} occurs}\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{if} $\\{privileged}$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{page\_head}=\\{page\_tail})\W(\\{head}=\\{tail})\W(%
\\{dead\_cycles}=0)$ \1\&{then}\6
\&{begin} \37$\\{its\_all\_over}\K\\{true}$;\5
\&{return};\6
\&{end};\2\6
\\{back\_input};\C{we will try to end again after ejecting residual material}\6
$\\{tail\_append}(\\{new\_null\_box})$;\5
$\\{width}(\\{tail})\K\\{hsize}$;\5
$\\{tail\_append}(\\{new\_glue}(\\{fill\_glue}))$;\5
$\\{tail\_append}(\\{new\_penalty}(-\O{10000000000}))$;\6
\\{build\_page};\C{append \.{\\hbox to \\hsize\{\}\\vfill%
\\penalty-'10000000000}}\6
\&{end};\2\6
$\\{its\_all\_over}\K\\{false}$;\6
\4\\{exit}: \37\&{end};\par
\fi

\N1233.  \[47] Building boxes and lists.
The most important parts of \\{main\_control} are concerned with \TeX's
chief mission of box-making. We need to control the activities that put
entries on vlists and hlists, as well as the activities that convert
those lists into boxes. All of the necessary machinery has already been
developed; it remains for us to ``push the buttons'' at the right times.

\fi

\M1234. As an introduction to these routines, let's consider one of the
simplest
cases: What happens when `\.{\\hrule}' occurs in vertical mode, or
`\.{\\vrule}' in horizontal mode or math mode? The code in \\{main\_control}
is short, since the \\{scan\_rule\_spec} routine already does most of what is
required; thus, there is no need for a special action procedure.

Note that baselineskip calculations are disabled after a rule in vertical
mode, by setting $\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X\S$\6
\4$\\{vmode}+\\{hrule},\39\\{hmode}+\\{vrule},\39\\{mmode}+\\{vrule}$: \37%
\&{begin} \37$\\{tail\_append}(\\{scan\_rule\_spec})$;\6
\&{if} $\\{abs}(\\{mode})=\\{vmode}$ \1\&{then}\5
$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$\6
\4\&{else} \&{if} $\\{abs}(\\{mode})=\\{hmode}$ \1\&{then}\5
$\\{space\_factor}\K1000$;\2\2\6
\&{end};\par
\As1235, 1241, 1245, 1251, 1268, 1270, 1272, 1275, 1280, 1282, 1287, 1290,
1294, 1300, 1304, 1308, 1312, 1315, 1318, 1328, 1332, 1336, 1340, 1342, 1345,
1349, 1353, 1358, 1368\ETs1371.
\U1223.\fi

\M1235. The processing of things like \.{\\hskip} and \.{\\vskip} is slightly
more complicated. But the code in \\{main\_control} is very short, since
it simply calls on the action routine \\{append\_glue}. Similarly, \.{\\kern}
activates \\{append\_kern}.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{vskip},\39\\{hmode}+\\{hskip},\39\\{mmode}+\\{hskip},\39%
\\{mmode}+\\{mskip}$: \37\\{append\_glue};\6
\4$\\{any\_mode}(\\{kern}),\39\\{mmode}+\\{mkern}$: \37\\{append\_kern};\par
\fi

\M1236. The \\{hskip} and \\{vskip} command codes are used for control
sequences
like \.{\\hss} and \.{\\vfil} as well as for \.{\\hskip} and \.{\\vskip}.
The difference is in the value of \\{cur\_chr}.

\Y\P\D \37$\\{fil\_code}=0$\C{identifies \.{\\hfil} and \.{\\vfil}}\par
\P\D \37$\\{fill\_code}=1$\C{identifies \.{\\hfill} and \.{\\vfill}}\par
\P\D \37$\\{ss\_code}=2$\C{identifies \.{\\hss} and \.{\\vss}}\par
\P\D \37$\\{fil\_neg\_code}=3$\C{identifies \.{\\hfilneg} and \.{\\vfilneg}}\par
\P\D \37$\\{skip\_code}=4$\C{identifies \.{\\hskip} and \.{\\vskip}}\par
\P\D \37$\\{mskip\_code}=5$\C{identifies \.{\\mskip}}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"hskip"},\39\\{hskip},\39\\{skip\_code})$;\6
$\\{primitive}(\.{"hfil"},\39\\{hskip},\39\\{fil\_code})$;\5
$\\{primitive}(\.{"hfill"},\39\\{hskip},\39\\{fill\_code})$;\6
$\\{primitive}(\.{"hss"},\39\\{hskip},\39\\{ss\_code})$;\5
$\\{primitive}(\.{"hfilneg"},\39\\{hskip},\39\\{fil\_neg\_code})$;\6
$\\{primitive}(\.{"vskip"},\39\\{vskip},\39\\{skip\_code})$;\6
$\\{primitive}(\.{"vfil"},\39\\{vskip},\39\\{fil\_code})$;\5
$\\{primitive}(\.{"vfill"},\39\\{vskip},\39\\{fill\_code})$;\6
$\\{primitive}(\.{"vss"},\39\\{vskip},\39\\{ss\_code})$;\5
$\\{primitive}(\.{"vfilneg"},\39\\{vskip},\39\\{fil\_neg\_code})$;\6
$\\{primitive}(\.{"mskip"},\39\\{mskip},\39\\{mskip\_code})$;\6
$\\{primitive}(\.{"kern"},\39\\{kern},\39\\{explicit})$;\5
$\\{primitive}(\.{"mkern"},\39\\{mkern},\39\\{mu\_glue})$;\par
\fi

\M1237. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{hskip}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{skip\_code}: \37$\\{print\_esc}(\.{"hskip"})$;\6
\4\\{fil\_code}: \37$\\{print\_esc}(\.{"hfil"})$;\6
\4\\{fill\_code}: \37$\\{print\_esc}(\.{"hfill"})$;\6
\4\\{ss\_code}: \37$\\{print\_esc}(\.{"hss"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"hfilneg"})$\2\6
\&{endcases};\6
\4\\{vskip}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{skip\_code}: \37$\\{print\_esc}(\.{"vskip"})$;\6
\4\\{fil\_code}: \37$\\{print\_esc}(\.{"vfil"})$;\6
\4\\{fill\_code}: \37$\\{print\_esc}(\.{"vfill"})$;\6
\4\\{ss\_code}: \37$\\{print\_esc}(\.{"vss"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"vfilneg"})$\2\6
\&{endcases};\6
\4\\{mskip}: \37$\\{print\_esc}(\.{"mskip"})$;\6
\4\\{kern}: \37$\\{print\_esc}(\.{"kern"})$;\6
\4\\{mkern}: \37$\\{print\_esc}(\.{"mkern"})$;\par
\fi

\M1238. All the work relating to glue creation has been relegated to the
following subroutine. It does not call \\{build\_page}, because it is
used in at least one place where that would be a mistake.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_glue};\6
\4\&{var} \37\|s: \37\\{small\_number};\C{modifier of skip command}\2\6
\&{begin} \37$\|s\K\\{cur\_chr}$;\6
\&{case} $\|s$ \1\&{of}\6
\4\\{fil\_code}: \37$\\{cur\_val}\K\\{fil\_glue}$;\6
\4\\{fill\_code}: \37$\\{cur\_val}\K\\{fill\_glue}$;\6
\4\\{ss\_code}: \37$\\{cur\_val}\K\\{ss\_glue}$;\6
\4\\{fil\_neg\_code}: \37$\\{cur\_val}\K\\{fil\_neg\_glue}$;\6
\4\\{skip\_code}: \37$\\{scan\_glue}(\\{glue\_val})$;\6
\4\\{mskip\_code}: \37$\\{scan\_glue}(\\{mu\_val})$;\2\6
\&{end};\C{now \\{cur\_val} points to the glue specification}\6
$\\{tail\_append}(\\{new\_glue}(\\{cur\_val}))$;\6
\&{if} $\|s\G\\{skip\_code}$ \1\&{then}\6
\&{begin} \37$\\{decr}(\\{glue\_ref\_count}(\\{cur\_val}))$;\6
\&{if} $\|s>\\{skip\_code}$ \1\&{then}\5
$\\{subtype}(\\{tail})\K\\{mu\_glue}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1239. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_kern};\6
\4\&{var} \37\|s: \37\\{quarterword};\C{\\{subtype} of the kern node}\2\6
\&{begin} \37$\|s\K\\{cur\_chr}$;\5
$\\{scan\_dimen}(\|s=\\{mu\_glue},\39\\{false},\39\\{false})$;\5
$\\{tail\_append}(\\{new\_kern}(\\{cur\_val}))$;\5
$\\{subtype}(\\{tail})\K\|s$;\6
\&{end};\par
\fi

\M1240. Many of the actions related to box-making are triggered by the
appearance
of braces in the input. For example, when the user says `\.{\\hbox}
\.{to} \.{100pt\{$\langle\,\hbox{\rm hlist}\,\rangle$\}}' in vertical mode,
the information about the box size (100pt, \\{exactly}) is put onto \\{save%
\_stack}
with a level boundary word just above it, and $\\{cur\_group}\K\\{adjusted%
\_hbox\_group}$;
\TeX\ enters restricted horizontal mode to process the hlist. The right
brace eventually causes \\{save\_stack} to be restored to its former state,
at which time the information about the box size (100pt, \\{exactly}) is
available once again; a box is packaged and we leave restricted horizontal
mode, appending the new box to the current list of the enclosing mode
(in this case to the current list of vertical mode), followed by any
vertical adjustments that were removed from the box by \\{hpack}.

The next few sections of the program are therefore concerned with the
treatment of left and right curly braces.

\fi

\M1241. If a left brace occurs in the middle of a page or paragraph, it simply
introduces a new level of grouping, and the matching right brace will not have
such a drastic effect. Such grouping affects neither the mode nor the
current list.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{non\_math}(\\{left\_brace})$: \37$\\{new\_save\_level}(\\{simple%
\_group})$;\6
\4$\\{any\_mode}(\\{begin\_group})$: \37$\\{new\_save\_level}(\\{semi\_simple%
\_group})$;\6
\4$\\{any\_mode}(\\{end\_group})$: \37\&{if} $\\{cur\_group}=\\{semi\_simple%
\_group}$ \1\&{then}\5
\\{unsave}\6
\4\&{else} \\{off\_save};\2\par
\fi

\M1242. We have to deal with errors in which braces and such things are not
properly nested. Sometimes the user makes an error of commission by
inserting an extra symbol, but sometimes the user makes an error of omission.
\TeX\ can't always tell one from the other, so it makes a guess and tries
to avoid getting into a loop.

The \\{off\_save} routine is called when the current group code is wrong. It
tries
to insert something into the user's input that will help clean off
the top level.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{off\_save};\6
\4\&{var} \37\|p: \37\\{pointer};\C{inserted token}\2\6
\&{begin} \37\&{if} $\\{cur\_group}=\\{bottom\_level}$ \1\&{then}\5
\X1244:Drop current token and complain that it was unmatched\X\6
\4\&{else} \&{begin} \37\\{back\_input};\5
$\|p\K\\{get\_avail}$;\5
$\\{link}(\\{temp\_head})\K\|p$;\5
$\\{print\_err}(\.{"Missing\ "})$;\5
\X1243:Prepare to insert a token that matches \\{cur\_group}, and print what it
is\X;\6
$\\{print}(\.{"\ inserted"})$;\5
$\\{ins\_list}(\\{link}(\\{temp\_head}))$;\5
$\\{help5}(\.{"I\'ve\ inserted\ something\ that\ you\ may\ have\ forgotten."})$%
\6
$(\.{"(See\ the\ <inserted\ text>\ above.)"})$\6
$(\.{"With\ luck,\ this\ will\ get\ me\ unwedged.\ But\ if\ you"})$\6
$(\.{"really\ didn\'t\ forget\ anything,\ try\ typing\ \`2\'\ now;\ then"})$\6
$(\.{"my\ insertion\ and\ my\ current\ dilemma\ will\ both\ disappear."})$;\5
\\{error};\6
\&{end};\2\6
\&{end};\par
\fi

\M1243. At this point, $\\{link}(\\{temp\_head})=\|p$, a pointer to an empty
one-word node.

\Y\P$\4\X1243:Prepare to insert a token that matches \\{cur\_group}, and print
what it is\X\S$\6
\&{case} $\\{cur\_group}$ \1\&{of}\6
\4\\{semi\_simple\_group}: \37\&{begin} \37$\\{info}(\|p)\K\\{cs\_token\_flag}+%
\\{frozen\_end\_group}$;\5
$\\{print\_esc}(\.{"endgroup"})$;\6
\&{end};\6
\4\\{math\_shift\_group}: \37\&{begin} \37$\\{info}(\|p)\K\\{math\_shift%
\_token}+\.{"\$"}$;\5
$\\{print\_char}(\.{"\$"})$;\6
\&{end};\6
\4\\{math\_left\_group}: \37\&{begin} \37$\\{info}(\|p)\K\\{cs\_token\_flag}+%
\\{frozen\_right}$;\5
$\\{link}(\|p)\K\\{get\_avail}$;\5
$\|p\K\\{link}(\|p)$;\5
$\\{info}(\|p)\K\\{other\_token}+\.{"."}$;\5
$\\{print\_esc}(\.{"right."})$;\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37$\\{info}(\|p)\K\\{right\_brace\_token}+\.{"%
\}"}$;\5
$\\{print\_char}(\.{"\}"})$;\6
\&{end}\2\6
\&{endcases}\par
\U1242.\fi

\M1244. \P$\X1244:Drop current token and complain that it was unmatched\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Extra\ "})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{help1}(\.{"Things\ are\ pretty\ mixed\ up,\ but\ I\ think\ the\ worst\ is\
over."})$;\6
\\{error};\6
\&{end}\par
\U1242.\fi

\M1245. The routine for a \\{right\_brace} character branches into many
subcases,
since a variety of things may happen, depending on \\{cur\_group}. Some
types of groups are not supposed to be ended by a right brace; error
messages are given in hopes of pinpointing the problem. Most branches
of this routine will be filled in later, when we are ready to understand
them; meanwhile, we must prepare ourselves to deal with such errors.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{right\_brace})$: \37\\{handle\_right\_brace};\par
\fi

\M1246. \P$\X1246:Declare the procedure called \\{handle\_right\_brace}\X\S$\6
\4\&{procedure}\1\  \37\\{handle\_right\_brace};\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{for short-term use}\6
\|d: \37\\{scaled};\C{holds \\{split\_max\_depth} in \\{insert\_group}}\6
\|f: \37\\{integer};\C{holds \\{floating\_penalty} in \\{insert\_group}}\2\6
\&{begin} \37\&{case} $\\{cur\_group}$ \1\&{of}\6
\4\\{simple\_group}: \37\\{unsave};\6
\4\\{bottom\_level}: \37\&{begin} \37$\\{print\_err}(\.{"Too\ many\ \}\'s"})$;\5
$\\{help2}(\.{"You\'ve\ closed\ more\ groups\ than\ you\ opened."})$\6
$(\.{"Such\ booboos\ are\ generally\ harmless,\ so\ keep\ going."})$;\5
\\{error};\6
\&{end};\6
\4$\\{semi\_simple\_group},\39\\{math\_shift\_group},\39\\{math\_left\_group}$:
\37\\{extra\_right\_brace};\6
\hbox{\4}\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\6
\4\&{othercases} \37$\\{confusion}(\.{"rightbrace"})$\2\6
\&{endcases};\6
\&{end};\par
\U1207.\fi

\M1247. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{extra\_right\_brace};\2\6
\&{begin} \37$\\{print\_err}(\.{"Extra\ \},\ or\ forgotten\ "})$;\6
\&{case} $\\{cur\_group}$ \1\&{of}\6
\4\\{semi\_simple\_group}: \37$\\{print\_esc}(\.{"endgroup"})$;\6
\4\\{math\_shift\_group}: \37$\\{print\_char}(\.{"\$"})$;\6
\4\\{math\_left\_group}: \37$\\{print\_esc}(\.{"right"})$;\2\6
\&{end};\6
$\\{help5}(\.{"I\'ve\ deleted\ a\ group-closing\ symbol\ because\ it\ seems\ to%
\ be"})$\6
$(\.{"spurious,\ as\ in\ \`\$x\}\$\'.\ But\ perhaps\ the\ \}\ is\ legitimate\
and"})$\6
$(\.{"you\ forgot\ something\ else,\ as\ in\ \`\\hbox\{\$x\}\'.\ In\ such\
cases"})$\6
$(\.{"the\ way\ to\ recover\ is\ to\ insert\ both\ the\ forgotten\ and\ the"})$%
\6
$(\.{"deleted\ material,\ e.g.,\ by\ typing\ \`I\$\}\'."})$;\5
\\{error};\5
$\\{incr}(\\{align\_state})$;\6
\&{end};\par
\fi

\M1248. Here is where we clear the parameters that are supposed to revert to
their
default values after every paragraph and when internal vertical mode is
entered.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{normal\_paragraph};\2\6
\&{begin} \37\&{if} $\\{looseness}\I0$ \1\&{then}\5
$\\{eq\_word\_define}(\\{int\_base}+\\{looseness\_code},\390)$;\2\6
\&{if} $\\{hang\_indent}\I0$ \1\&{then}\5
$\\{eq\_word\_define}(\\{dimen\_base}+\\{hang\_indent\_code},\390)$;\2\6
\&{if} $\\{hang\_after}\I1$ \1\&{then}\5
$\\{eq\_word\_define}(\\{int\_base}+\\{hang\_after\_code},\391)$;\2\6
\&{if} $\\{par\_shape\_ptr}\I\\{null}$ \1\&{then}\5
$\\{eq\_define}(\\{par\_shape\_loc},\39\\{shape\_ref},\39\\{null})$;\2\6
\&{if} $\\{inter\_line\_penalties\_ptr}\I\\{null}$ \1\&{then}\5
$\\{eq\_define}(\\{inter\_line\_penalties\_loc},\39\\{shape\_ref},\39%
\\{null})$;\2\6
\&{end};\par
\fi

\M1249. Now let's turn to the question of how \.{\\hbox} is treated. We
actually
need to consider also a slightly larger context, since constructions like
`\.{\\setbox3=}\penalty0\.{\\hbox...}' and
`\.{\\leaders}\penalty0\.{\\hbox...}' and
`\.{\\lower3.8pt\\hbox...}'
are supposed to invoke quite
different actions after the box has been packaged. Conversely,
constructions like `\.{\\setbox3=}' can be followed by a variety of
different kinds of boxes, and we would like to encode such things in an
efficient way.

In other words, there are two problems: to represent the context of a box,
and to represent its type.

The first problem is solved by putting a ``context code'' on the \\{save%
\_stack},
just below the two entries that give the dimensions produced by \\{scan\_spec}.
The context code is either a (signed) shift amount, or it is a large
integer $\G\\{box\_flag}$, where $\\{box\_flag}=\hbox{$2^{30}$}$. Codes \\{box%
\_flag} through
$\\{global\_box\_flag}-1$ represent `\.{\\setbox0}' through `\.{%
\\setbox32767}';
codes \\{global\_box\_flag} through $\\{ship\_out\_flag}-1$ represent
`\.{\\global\\setbox0}' through `\.{\\global\\setbox32767}';
code \\{ship\_out\_flag} represents `\.{\\shipout}'; and codes \\{leader\_flag}
through $\\{leader\_flag}+2$ represent `\.{\\leaders}', `\.{\\cleaders}',
and `\.{\\xleaders}'.

The second problem is solved by giving the command code \\{make\_box} to all
control sequences that produce a box, and by using the following \\{chr\_code}
values to distinguish between them: \\{box\_code}, \\{copy\_code}, \\{last\_box%
\_code},
\\{vsplit\_code}, \\{vtop\_code}, $\\{vtop\_code}+\\{vmode}$, and $\\{vtop%
\_code}+\\{hmode}$, where
the latter two are used to denote \.{\\vbox} and \.{\\hbox}, respectively.

\Y\P\D \37$\\{box\_flag}\S\O{10000000000}$\C{context code for `\.{\\setbox0}'}%
\par
\P\D \37$\\{global\_box\_flag}\S\O{10000100000}$\C{context code for `\.{%
\\global\\setbox0}'}\par
\P\D \37$\\{ship\_out\_flag}\S\O{10000200000}$\C{context code for `\.{%
\\shipout}'}\par
\P\D \37$\\{leader\_flag}\S\O{10000200001}$\C{context code for `\.{\\leaders}'}%
\par
\P\D \37$\\{box\_code}=0$\C{\\{chr\_code} for `\.{\\box}'}\par
\P\D \37$\\{copy\_code}=1$\C{\\{chr\_code} for `\.{\\copy}'}\par
\P\D \37$\\{last\_box\_code}=2$\C{\\{chr\_code} for `\.{\\lastbox}'}\par
\P\D \37$\\{vsplit\_code}=3$\C{\\{chr\_code} for `\.{\\vsplit}'}\par
\P\D \37$\\{vtop\_code}=4$\C{\\{chr\_code} for `\.{\\vtop}'}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"moveleft"},\39\\{hmove},\391)$;\5
$\\{primitive}(\.{"moveright"},\39\\{hmove},\390)$;\6
$\\{primitive}(\.{"raise"},\39\\{vmove},\391)$;\5
$\\{primitive}(\.{"lower"},\39\\{vmove},\390)$;\7
$\\{primitive}(\.{"box"},\39\\{make\_box},\39\\{box\_code})$;\5
$\\{primitive}(\.{"copy"},\39\\{make\_box},\39\\{copy\_code})$;\5
$\\{primitive}(\.{"lastbox"},\39\\{make\_box},\39\\{last\_box\_code})$;\5
$\\{primitive}(\.{"vsplit"},\39\\{make\_box},\39\\{vsplit\_code})$;\5
$\\{primitive}(\.{"vtop"},\39\\{make\_box},\39\\{vtop\_code})$;\6
$\\{primitive}(\.{"vbox"},\39\\{make\_box},\39\\{vtop\_code}+\\{vmode})$;\5
$\\{primitive}(\.{"hbox"},\39\\{make\_box},\39\\{vtop\_code}+\\{hmode})$;\6
$\\{primitive}(\.{"shipout"},\39\\{leader\_ship},\39\\{a\_leaders}-1)$;\C{$%
\\{ship\_out\_flag}=\\{leader\_flag}-1$}\6
$\\{primitive}(\.{"leaders"},\39\\{leader\_ship},\39\\{a\_leaders})$;\5
$\\{primitive}(\.{"cleaders"},\39\\{leader\_ship},\39\\{c\_leaders})$;\5
$\\{primitive}(\.{"xleaders"},\39\\{leader\_ship},\39\\{x\_leaders})$;\par
\fi

\M1250. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{hmove}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"moveleft"})$\ \&{else} $\\{print\_esc}(\.{"moveright"})$;\2%
\6
\4\\{vmove}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"raise"})$\ \&{else} $\\{print\_esc}(\.{"lower"})$;\2\6
\4\\{make\_box}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{box\_code}: \37$\\{print\_esc}(\.{"box"})$;\6
\4\\{copy\_code}: \37$\\{print\_esc}(\.{"copy"})$;\6
\4\\{last\_box\_code}: \37$\\{print\_esc}(\.{"lastbox"})$;\6
\4\\{vsplit\_code}: \37$\\{print\_esc}(\.{"vsplit"})$;\6
\4\\{vtop\_code}: \37$\\{print\_esc}(\.{"vtop"})$;\6
\4$\\{vtop\_code}+\\{vmode}$: \37$\\{print\_esc}(\.{"vbox"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"hbox"})$\2\6
\&{endcases};\6
\4\\{leader\_ship}: \37\&{if} $\\{chr\_code}=\\{a\_leaders}$ \1\&{then}\5
$\\{print\_esc}(\.{"leaders"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{c\_leaders}$ \1\&{then}\5
$\\{print\_esc}(\.{"cleaders"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{x\_leaders}$ \1\&{then}\5
$\\{print\_esc}(\.{"xleaders"})$\6
\4\&{else} $\\{print\_esc}(\.{"shipout"})$;\2\2\2\par
\fi

\M1251. Constructions that require a box are started by calling \\{scan\_box}
with
a specified context code. The \\{scan\_box} routine verifies
that a \\{make\_box} command comes next and then it calls \\{begin\_box}.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{hmove},\39\\{hmode}+\\{vmove},\39\\{mmode}+\\{vmove}$: \37%
\&{begin} \37$\|t\K\\{cur\_chr}$;\5
\\{scan\_normal\_dimen};\6
\&{if} $\|t=0$ \1\&{then}\5
$\\{scan\_box}(\\{cur\_val})$\ \&{else} $\\{scan\_box}(-\\{cur\_val})$;\2\6
\&{end};\6
\4$\\{any\_mode}(\\{leader\_ship})$: \37$\\{scan\_box}(\\{leader\_flag}-\\{a%
\_leaders}+\\{cur\_chr})$;\6
\4$\\{any\_mode}(\\{make\_box})$: \37$\\{begin\_box}(0)$;\par
\fi

\M1252. The global variable \\{cur\_box} will point to a newly made box. If the
box
is void, we will have $\\{cur\_box}=\\{null}$. Otherwise we will have
$\\{type}(\\{cur\_box})=\\{hlist\_node}$ or \\{vlist\_node} or \\{rule\_node};
the \\{rule\_node}
case can occur only with leaders.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_box}: \37\\{pointer};\C{box to be placed into its context}\par
\fi

\M1253. The \\{box\_end} procedure does the right thing with \\{cur\_box}, if
\\{box\_context} represents the context as explained above.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{box\_end}(\\{box\_context}:\\{integer})$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{\\{ord\_noad} for new box in math mode}\6
\|a: \37\\{small\_number};\C{global prefix}\2\6
\&{begin} \37\&{if} $\\{box\_context}<\\{box\_flag}$ \1\&{then}\5
\X1254:Append box \\{cur\_box} to the current list, shifted by \\{box\_context}%
\X\6
\4\&{else} \&{if} $\\{box\_context}<\\{ship\_out\_flag}$ \1\&{then}\5
\X1255:Store \(c)\\{cur\_box} in a box register\X\6
\4\&{else} \&{if} $\\{cur\_box}\I\\{null}$ \1\&{then}\6
\&{if} $\\{box\_context}>\\{ship\_out\_flag}$ \1\&{then}\5
\X1256:Append a new leader node that uses \\{cur\_box}\X\6
\4\&{else} $\\{ship\_out}(\\{cur\_box})$;\2\2\2\2\6
\&{end};\par
\fi

\M1254. The global variable \\{adjust\_tail} will be non-null if and only if
the
current box might include adjustments that should be appended to the
current vertical list.

\Y\P$\4\X1254:Append box \\{cur\_box} to the current list, shifted by \\{box%
\_context}\X\S$\6
\&{begin} \37\&{if} $\\{cur\_box}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{shift\_amount}(\\{cur\_box})\K\\{box\_context}$;\6
\&{if} $\\{abs}(\\{mode})=\\{vmode}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pre\_adjust\_tail}\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pre\_adjust\_head}\I\\{pre\_adjust\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{pre\_adjust\_head})(\\{pre\_adjust\_tail})$;\2\6
$\\{pre\_adjust\_tail}\K\\{null}$;\6
\&{end};\2\6
$\\{append\_to\_vlist}(\\{cur\_box})$;\6
\&{if} $\\{adjust\_tail}\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{adjust\_head}\I\\{adjust\_tail}$ \1\&{then}\5
$\\{append\_list}(\\{adjust\_head})(\\{adjust\_tail})$;\2\6
$\\{adjust\_tail}\K\\{null}$;\6
\&{end};\2\6
\&{if} $\\{mode}>0$ \1\&{then}\5
\\{build\_page};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{abs}(\\{mode})=\\{hmode}$ \1\&{then}\5
$\\{space\_factor}\K1000$\6
\4\&{else} \&{begin} \37$\|p\K\\{new\_noad}$;\5
$\\{math\_type}(\\{nucleus}(\|p))\K\\{sub\_box}$;\5
$\\{info}(\\{nucleus}(\|p))\K\\{cur\_box}$;\5
$\\{cur\_box}\K\|p$;\6
\&{end};\2\6
$\\{link}(\\{tail})\K\\{cur\_box}$;\5
$\\{tail}\K\\{cur\_box}$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\par
\U1253.\fi

\M1255. \P$\X1255:Store \(c)\\{cur\_box} in a box register\X\S$\6
\&{begin} \37\&{if} $\\{box\_context}<\\{global\_box\_flag}$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K\\{box\_context}-\\{box\_flag}$;\5
$\|a\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_val}\K\\{box\_context}-\\{global\_box\_flag}$;%
\5
$\|a\K4$;\6
\&{end};\2\6
\&{if} $\\{cur\_val}<256$ \1\&{then}\5
$\\{define}(\\{box\_base}+\\{cur\_val},\39\\{box\_ref},\39\\{cur\_box})$\6
\4\&{else} \\{sa\_def\_box};\2\6
\&{end}\par
\U1253.\fi

\M1256. \P$\X1256:Append a new leader node that uses \\{cur\_box}\X\S$\6
\&{begin} \37\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $((\\{cur\_cmd}=\\{hskip})\W(\\{abs}(\\{mode})\I\\{vmode}))\V\30((\\{cur%
\_cmd}=\\{vskip})\W(\\{abs}(\\{mode})=\\{vmode}))$ \1\&{then}\6
\&{begin} \37\\{append\_glue};\5
$\\{subtype}(\\{tail})\K\\{box\_context}-(\\{leader\_flag}-\\{a\_leaders})$;\5
$\\{leader\_ptr}(\\{tail})\K\\{cur\_box}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Leaders\ not\ followed\ by\ proper\
glue"})$;\5
$\\{help3}(\.{"You\ should\ say\ \`\\leaders\ <box\ or\ rule><hskip\ or\ vskip>%
\'."})$\6
$(\.{"I\ found\ the\ <box\ or\ rule>,\ but\ there\'s\ no\ suitable"})$\6
$(\.{"<hskip\ or\ vskip>,\ so\ I\'m\ ignoring\ these\ leaders."})$;\5
\\{back\_error};\5
$\\{flush\_node\_list}(\\{cur\_box})$;\6
\&{end};\2\6
\&{end}\par
\U1253.\fi

\M1257. Now that we can see what eventually happens to boxes, we can consider
the first steps in their creation. The \\{begin\_box} routine is called when
\\{box\_context} is a context specification, \\{cur\_chr} specifies the type of
box desired, and $\\{cur\_cmd}=\\{make\_box}$.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{begin\_box}(\\{box\_context}:\\{integer})$;\6
\4\&{label} \37$\\{exit},\39\\{done}$;\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{run through the current list}\6
\|r: \37\\{pointer};\C{running behind \|p}\6
\\{fm}: \37\\{boolean};\C{a final \.{\\beginM} \.{\\endM} node pair?}\6
\\{tx}: \37\\{pointer};\C{effective tail node}\6
\|m: \37\\{quarterword};\C{the length of a replacement list}\6
\|k: \37\\{halfword};\C{0 or \\{vmode} or \\{hmode}}\6
\|n: \37\\{halfword};\C{a box number}\2\6
\&{begin} \37\&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{box\_code}: \37\&{begin} \37\\{scan\_register\_num};\5
$\\{fetch\_box}(\\{cur\_box})$;\5
$\\{change\_box}(\\{null})$;\C{the box becomes void, at the same level}\6
\&{end};\6
\4\\{copy\_code}: \37\&{begin} \37\\{scan\_register\_num};\5
$\\{fetch\_box}(\|q)$;\5
$\\{cur\_box}\K\\{copy\_node\_list}(\|q)$;\6
\&{end};\6
\4\\{last\_box\_code}: \37\X1258:If the current list ends with a box node,
delete it from the list and make \\{cur\_box} point to it; otherwise set $%
\\{cur\_box}\K\\{null}$\X;\6
\4\\{vsplit\_code}: \37\X1260:Split off part of a vertical box, make \\{cur%
\_box} point to it\X;\6
\4\&{othercases} \37\X1261:Initiate the construction of an hbox or vbox, then %
\&{return}\X\2\6
\&{endcases};\6
$\\{box\_end}(\\{box\_context})$;\C{in simple cases, we use the box
immediately}\6
\4\\{exit}: \37\&{end};\par
\fi

\M1258. Note that the condition $\R\\{is\_char\_node}(\\{tail})$ implies that $%
\\{head}\I\\{tail}$,
since \\{head} is a one-word node.

\Y\P\D \37$\\{fetch\_effective\_tail\_eTeX}(\#)\S$\C{extract \\{tx},   drop \.{%
\\beginM} \.{\\endM} pair}\6
$\|q\K\\{head}$;\5
$\|p\K\\{null}$;\6
\1\&{repeat} \37$\|r\K\|p$;\5
$\|p\K\|q$;\5
$\\{fm}\K\\{false}$;\6
\&{if} $\R\\{is\_char\_node}(\|q)$ \1\&{then}\6
\&{if} $\\{type}(\|q)=\\{disc\_node}$ \1\&{then}\6
\&{begin} \37\&{for} $\|m\K1\mathrel{\&{to}}\\{replace\_count}(\|q)$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
\&{if} $\|p=\\{tx}$ \1\&{then}\5
$\#$;\2\6
\&{end}\6
\4\&{else} \&{if} $(\\{type}(\|q)=\\{math\_node})\W(\\{subtype}(\|q)=\\{begin%
\_M\_code})$ \1\&{then}\5
$\\{fm}\K\\{true}$;\2\2\2\6
$\|q\K\\{link}(\|p)$;\6
\4\&{until}\5
$\|q=\\{tx}$;\C{found \|r$\to$\|p$\to$$\|q=\\{tx}$}\2\6
$\|q\K\\{link}(\\{tx})$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{link}(\\{tx})\K\\{null}$;\6
\&{if} $\|q=\\{null}$ \1\&{then}\6
\&{if} $\\{fm}$ \1\&{then}\5
$\\{confusion}(\.{"tail1"})$\6
\4\&{else} $\\{tail}\K\|p$\2\6
\4\&{else} \&{if} $\\{fm}$ \1\&{then}\C{\|r$\to$$\|p=\\{begin\_M}$$\to$$\|q=%
\\{end\_M}$}\6
\&{begin} \37$\\{tail}\K\|r$;\5
$\\{link}(\|r)\K\\{null}$;\5
$\\{flush\_node\_list}(\|p)$;\ \&{end}\2\2\par
\P\D \37$\\{check\_effective\_tail}(\#)\S\\{find\_effective\_tail\_eTeX}$\par
\P\D \37$\\{fetch\_effective\_tail}\S\\{fetch\_effective\_tail\_eTeX}$\par
\Y\P$\4\X1258:If the current list ends with a box node, delete it from the list
and make \\{cur\_box} point to it; otherwise set $\\{cur\_box}\K\\{null}$\X\S$\6
\&{begin} \37$\\{cur\_box}\K\\{null}$;\6
\&{if} $\\{abs}(\\{mode})=\\{mmode}$ \1\&{then}\6
\&{begin} \37\\{you\_cant};\5
$\\{help1}(\.{"Sorry;\ this\ \\lastbox\ will\ be\ void."})$;\5
\\{error};\6
\&{end}\6
\4\&{else} \&{if} $(\\{mode}=\\{vmode})\W(\\{head}=\\{tail})$ \1\&{then}\6
\&{begin} \37\\{you\_cant};\5
$\\{help2}(\.{"Sorry...I\ usually\ can\'t\ take\ things\ from\ the\ current\
page."})$\6
$(\.{"This\ \\lastbox\ will\ therefore\ be\ void."})$;\5
\\{error};\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{check\_effective\_tail}($\&{goto} \37\\{done}$)$;\6
\&{if} $\R\\{is\_char\_node}(\\{tx})$ \1\&{then}\6
\&{if} $(\\{type}(\\{tx})=\\{hlist\_node})\V(\\{type}(\\{tx})=\\{vlist\_node})$
\1\&{then}\5
\X1259:Remove the last box, unless it's part of a discretionary\X;\2\2\6
\4\\{done}: \37\&{end};\2\2\6
\&{end}\par
\U1257.\fi

\M1259. \P$\X1259:Remove the last box, unless it's part of a discretionary\X\S$%
\6
\&{begin} \37$\\{fetch\_effective\_tail}($\&{goto} \37\\{done}$)$;\5
$\\{cur\_box}\K\\{tx}$;\5
$\\{shift\_amount}(\\{cur\_box})\K0$;\6
\&{end}\par
\U1258.\fi

\M1260. Here we deal with things like `\.{\\vsplit 13 to 100pt}'.

\Y\P$\4\X1260:Split off part of a vertical box, make \\{cur\_box} point to it\X%
\S$\6
\&{begin} \37\\{scan\_register\_num};\5
$\|n\K\\{cur\_val}$;\6
\&{if} $\R\\{scan\_keyword}(\.{"to"})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \`to\'\ inserted"})$;\5
$\\{help2}(\.{"I\'m\ working\ on\ \`\\vsplit<box\ number>\ to\ <dimen>\';"})$\6
$(\.{"will\ look\ for\ the\ <dimen>\ next."})$;\5
\\{error};\6
\&{end};\2\6
\\{scan\_normal\_dimen};\5
$\\{cur\_box}\K\\{vsplit}(\|n,\39\\{cur\_val})$;\6
\&{end}\par
\U1257.\fi

\M1261. Here is where we enter restricted horizontal mode or internal vertical
mode, in order to make a box.

\Y\P$\4\X1261:Initiate the construction of an hbox or vbox, then \&{return}\X%
\S$\6
\&{begin} \37$\|k\K\\{cur\_chr}-\\{vtop\_code}$;\5
$\\{saved}(0)\K\\{box\_context}$;\6
\&{if} $\|k=\\{hmode}$ \1\&{then}\6
\&{if} $(\\{box\_context}<\\{box\_flag})\W(\\{abs}(\\{mode})=\\{vmode})$ \1%
\&{then}\5
$\\{scan\_spec}(\\{adjusted\_hbox\_group},\39\\{true})$\6
\4\&{else} $\\{scan\_spec}(\\{hbox\_group},\39\\{true})$\2\6
\4\&{else} \&{begin} \37\&{if} $\|k=\\{vmode}$ \1\&{then}\5
$\\{scan\_spec}(\\{vbox\_group},\39\\{true})$\6
\4\&{else} \&{begin} \37$\\{scan\_spec}(\\{vtop\_group},\39\\{true})$;\5
$\|k\K\\{vmode}$;\6
\&{end};\2\6
\\{normal\_paragraph};\6
\&{end};\2\6
\\{push\_nest};\5
$\\{mode}\K-\|k$;\6
\&{if} $\|k=\\{vmode}$ \1\&{then}\6
\&{begin} \37$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\6
\&{if} $\\{every\_vbox}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_vbox},\39\\{every\_vbox\_text})$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{space\_factor}\K1000$;\6
\&{if} $\\{every\_hbox}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_hbox},\39\\{every\_hbox\_text})$;\2\6
\&{end};\2\6
\&{return};\6
\&{end}\par
\U1257.\fi

\M1262. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{scan\_box}(\\{box\_context}:\\{integer})$;\C{the
next input should specify a box or perhaps a rule}\2\6
\&{begin} \37\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $\\{cur\_cmd}=\\{make\_box}$ \1\&{then}\5
$\\{begin\_box}(\\{box\_context})$\6
\4\&{else} \&{if} $(\\{box\_context}\G\\{leader\_flag})\W((\\{cur\_cmd}=%
\\{hrule})\V(\\{cur\_cmd}=\\{vrule}))$ \1\&{then}\6
\&{begin} \37$\\{cur\_box}\K\\{scan\_rule\_spec}$;\5
$\\{box\_end}(\\{box\_context})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\hbox{}\6
$\\{print\_err}(\.{"A\ <box>\ was\ supposed\ to\ be\ here"})$;\6
$\\{help3}(\.{"I\ was\ expecting\ to\ see\ \\hbox\ or\ \\vbox\ or\ \\copy\ or\ %
\\box\ or"})$\6
$(\.{"something\ like\ that.\ So\ you\ might\ find\ something\ missing\ in"})$\6
$(\.{"your\ output.\ But\ keep\ trying;\ you\ can\ fix\ this\ later."})$;\5
\\{back\_error};\6
\&{end};\2\2\6
\&{end};\par
\fi

\M1263. When the right brace occurs at the end of an \.{\\hbox} or \.{\\vbox}
or
\.{\\vtop} construction, the \\{package} routine comes into action. We might
also have to finish a paragraph that hasn't ended.

\Y\P$\4\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\S$\6
\4\\{hbox\_group}: \37$\\{package}(0)$;\6
\4\\{adjusted\_hbox\_group}: \37\&{begin} \37$\\{adjust\_tail}\K\\{adjust%
\_head}$;\5
$\\{pre\_adjust\_tail}\K\\{pre\_adjust\_head}$;\5
$\\{package}(0)$;\6
\&{end};\6
\4\\{vbox\_group}: \37\&{begin} \37\\{end\_graf};\5
$\\{package}(0)$;\6
\&{end};\6
\4\\{vtop\_group}: \37\&{begin} \37\\{end\_graf};\5
$\\{package}(\\{vtop\_code})$;\6
\&{end};\par
\As1278, 1296, 1310, 1311, 1346, 1351\ETs1364.
\U1246.\fi

\M1264. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{package}(\|c:\\{small\_number})$;\6
\4\&{var} \37\|h: \37\\{scaled};\C{height of box}\6
\|p: \37\\{pointer};\C{first node in a box}\6
\|d: \37\\{scaled};\C{max depth}\2\6
\&{begin} \37$\|d\K\\{box\_max\_depth}$;\5
\\{unsave};\5
$\\{save\_ptr}\K\\{save\_ptr}-3$;\6
\&{if} $\\{mode}=-\\{hmode}$ \1\&{then}\5
$\\{cur\_box}\K\\{hpack}(\\{link}(\\{head}),\39\\{saved}(2),\39\\{saved}(1))$\6
\4\&{else} \&{begin} \37$\\{cur\_box}\K\\{vpackage}(\\{link}(\\{head}),\39%
\\{saved}(2),\39\\{saved}(1),\39\|d)$;\6
\&{if} $\|c=\\{vtop\_code}$ \1\&{then}\5
\X1265:Readjust the height and depth of \\{cur\_box}, for \.{\\vtop}\X;\2\6
\&{end};\2\6
\\{pop\_nest};\5
$\\{box\_end}(\\{saved}(0))$;\6
\&{end};\par
\fi

\M1265. The height of a `\.{\\vtop}' box is inherited from the first item on
its list,
if that item is an \\{hlist\_node}, \\{vlist\_node}, or \\{rule\_node};
otherwise
the \.{\\vtop} height is zero.


\Y\P$\4\X1265:Readjust the height and depth of \\{cur\_box}, for \.{\\vtop}\X%
\S$\6
\&{begin} \37$\|h\K0$;\5
$\|p\K\\{list\_ptr}(\\{cur\_box})$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $\\{type}(\|p)\L\\{rule\_node}$ \1\&{then}\5
$\|h\K\\{height}(\|p)$;\2\2\6
$\\{depth}(\\{cur\_box})\K\\{depth}(\\{cur\_box})-\|h+\\{height}(\\{cur%
\_box})$;\5
$\\{height}(\\{cur\_box})\K\|h$;\6
\&{end}\par
\U1264.\fi

\M1266. Here is a really small patch to add a new primitive called
\.{\\quitvmode}. In vertical modes, it is identical to \.{\\indent},
but in horizontal and math modes it is really a no-op (as opposed to
\.{\\indent}, which executes the \\{indent\_in\_hmode} procedure).

A paragraph begins when horizontal-mode material occurs in vertical mode,
or when the paragraph is explicitly started by `\.{\\quitvmode}',
`\.{\\indent}' or `\.{\\noindent}'.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"indent"},\39\\{start\_par},\391)$;\5
$\\{primitive}(\.{"noindent"},\39\\{start\_par},\390)$;\5
$\\{primitive}(\.{"quitvmode"},\39\\{start\_par},\392)$;\par
\fi

\M1267. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{start\_par}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"noindent"})$\ \&{else} \&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"indent"})$\ \&{else} $\\{print\_esc}(\.{"quitvmode"})$;\2\2%
\par
\fi

\M1268. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{start\_par}$: \37$\\{new\_graf}(\\{cur\_chr}>0)$;\6
\4$\\{vmode}+\\{letter},\39\\{vmode}+\\{other\_char},\39\\{vmode}+\\{char%
\_num},\39\\{vmode}+\\{char\_given},\39\\{vmode}+\\{math\_shift},\39\\{vmode}+%
\\{un\_hbox},\39\\{vmode}+\\{vrule},\39\\{vmode}+\\{accent},\39\\{vmode}+%
\\{discretionary},\39\\{vmode}+\\{hskip},\39\\{vmode}+\\{valign},\39\\{vmode}+%
\\{ex\_space},\39\\{vmode}+\\{no\_boundary}$: \37\hbox{}\6
\&{begin} \37\\{back\_input};\5
$\\{new\_graf}(\\{true})$;\6
\&{end};\par
\fi

\M1269. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{norm\_min}(\|h:\\{integer})$: \37\\{small\_number};\2%
\6
\&{begin} \37\&{if} $\|h\L0$ \1\&{then}\5
$\\{norm\_min}\K1$\ \&{else} \&{if} $\|h\G63$ \1\&{then}\5
$\\{norm\_min}\K63$\ \&{else} $\\{norm\_min}\K\|h$;\2\2\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{new\_graf}(\\{indented}:\\{boolean})$;\2\6
\&{begin} \37$\\{prev\_graf}\K0$;\6
\&{if} $(\\{mode}=\\{vmode})\V(\\{head}\I\\{tail})$ \1\&{then}\5
$\\{tail\_append}(\\{new\_param\_glue}(\\{par\_skip\_code}))$;\2\6
\\{push\_nest};\5
$\\{mode}\K\\{hmode}$;\5
$\\{space\_factor}\K1000$;\5
\\{set\_cur\_lang};\5
$\\{clang}\K\\{cur\_lang}$;\5
$\\{prev\_graf}\K(\\{norm\_min}(\\{left\_hyphen\_min})\ast\O{100}+\\{norm%
\_min}(\\{right\_hyphen\_min}))\ast\O{200000}+\\{cur\_lang}$;\6
\&{if} $\\{indented}$ \1\&{then}\6
\&{begin} \37$\\{tail}\K\\{new\_null\_box}$;\5
$\\{link}(\\{head})\K\\{tail}$;\5
$\\{width}(\\{tail})\K\\{par\_indent}$;\ \&{end};\2\6
\&{if} $\\{every\_par}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_par},\39\\{every\_par\_text})$;\2\6
\&{if} $\\{nest\_ptr}=1$ \1\&{then}\5
\\{build\_page};\C{put \\{par\_skip} glue on current page}\2\6
\&{end};\par
\fi

\M1270. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{hmode}+\\{start\_par},\39\\{mmode}+\\{start\_par}$: \37\&{if} $\\{cur%
\_chr}\I2$ \1\&{then}\5
\\{indent\_in\_hmode};\2\par
\fi

\M1271. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{indent\_in\_hmode};\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\2\6
\&{begin} \37\&{if} $\\{cur\_chr}>0$ \1\&{then}\C{\.{\\indent}}\6
\&{begin} \37$\|p\K\\{new\_null\_box}$;\5
$\\{width}(\|p)\K\\{par\_indent}$;\6
\&{if} $\\{abs}(\\{mode})=\\{hmode}$ \1\&{then}\5
$\\{space\_factor}\K1000$\6
\4\&{else} \&{begin} \37$\|q\K\\{new\_noad}$;\5
$\\{math\_type}(\\{nucleus}(\|q))\K\\{sub\_box}$;\5
$\\{info}(\\{nucleus}(\|q))\K\|p$;\5
$\|p\K\|q$;\6
\&{end};\2\6
$\\{tail\_append}(\|p)$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1272. A paragraph ends when a \\{par\_end} command is sensed, or when we are
in
horizontal mode when reaching the right brace of vertical-mode routines
like \.{\\vbox}, \.{\\insert}, or \.{\\output}.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{par\_end}$: \37\&{begin} \37\\{normal\_paragraph};\6
\&{if} $\\{mode}>0$ \1\&{then}\5
\\{build\_page};\2\6
\&{end};\6
\4$\\{hmode}+\\{par\_end}$: \37\&{begin} \37\&{if} $\\{align\_state}<0$ \1%
\&{then}\5
\\{off\_save};\C{this tries to     recover from an alignment that didn't end
properly}\2\6
\\{end\_graf};\C{this takes us to the enclosing mode, if $\\{mode}>0$}\6
\&{if} $\\{mode}=\\{vmode}$ \1\&{then}\5
\\{build\_page};\2\6
\&{end};\6
\4$\\{hmode}+\\{stop},\39\\{hmode}+\\{vskip},\39\\{hmode}+\\{hrule},\39%
\\{hmode}+\\{un\_vbox},\39\\{hmode}+\\{halign}$: \37\\{head\_for\_vmode};\par
\fi

\M1273. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{head\_for\_vmode};\2\6
\&{begin} \37\&{if} $\\{mode}<0$ \1\&{then}\6
\&{if} $\\{cur\_cmd}\I\\{hrule}$ \1\&{then}\5
\\{off\_save}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_esc}(\.{"hrule"})$;\5
$\\{print}(\.{"\'\ here\ except\ with\ leaders"})$;\5
$\\{help2}(\.{"To\ put\ a\ horizontal\ rule\ in\ an\ hbox\ or\ an\
alignment,"})$\6
$(\.{"you\ should\ use\ \\leaders\ or\ \\hrulefill\ (see\ The\ TeXbook)."})$;\5
\\{error};\6
\&{end}\2\6
\4\&{else} \&{begin} \37\\{back\_input};\5
$\\{cur\_tok}\K\\{par\_token}$;\5
\\{back\_input};\5
$\\{token\_type}\K\\{inserted}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1274. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{end\_graf};\2\6
\&{begin} \37\&{if} $\\{mode}=\\{hmode}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{head}=\\{tail}$ \1\&{then}\5
\\{pop\_nest}\C{null paragraphs are ignored}\6
\4\&{else} $\\{line\_break}(\\{false})$;\2\6
\&{if} $\\{LR\_save}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{flush\_list}(\\{LR\_save})$;\5
$\\{LR\_save}\K\\{null}$;\6
\&{end};\2\6
\\{normal\_paragraph};\5
$\\{error\_count}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1275. Insertion and adjustment and mark nodes are constructed by the
following
pieces of the program.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{insert}),\39\\{hmode}+\\{vadjust},\39\\{mmode}+%
\\{vadjust}$: \37\\{begin\_insert\_or\_adjust};\6
\4$\\{any\_mode}(\\{mark})$: \37\\{make\_mark};\par
\fi

\M1276. \P$\X1226:Forbidden cases detected in \\{main\_control}\X\mathrel{+}\S$%
\6
$\\{vmode}+\\{vadjust},\39$\par
\fi

\M1277. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{begin\_insert\_or\_adjust};\2\6
\&{begin} \37\&{if} $\\{cur\_cmd}=\\{vadjust}$ \1\&{then}\5
$\\{cur\_val}\K255$\6
\4\&{else} \&{begin} \37\\{scan\_eight\_bit\_int};\6
\&{if} $\\{cur\_val}=255$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ "})$;\5
$\\{print\_esc}(\.{"insert"})$;\5
$\\{print\_int}(255)$;\5
$\\{help1}(\.{"I\'m\ changing\ to\ \\insert0;\ box\ 255\ is\ special."})$;\5
\\{error};\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\2\6
$\\{saved}(0)\K\\{cur\_val}$;\6
\&{if} $(\\{cur\_cmd}=\\{vadjust})\W\\{scan\_keyword}(\.{"pre"})$ \1\&{then}\5
$\\{saved}(1)\K1$\6
\4\&{else} $\\{saved}(1)\K0$;\2\6
$\\{save\_ptr}\K\\{save\_ptr}+2$;\5
$\\{new\_save\_level}(\\{insert\_group})$;\5
\\{scan\_left\_brace};\5
\\{normal\_paragraph};\5
\\{push\_nest};\5
$\\{mode}\K-\\{vmode}$;\5
$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\6
\&{end};\par
\fi

\M1278. \P$\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{insert\_group}: \37\&{begin} \37\\{end\_graf};\5
$\|q\K\\{split\_top\_skip}$;\5
$\\{add\_glue\_ref}(\|q)$;\5
$\|d\K\\{split\_max\_depth}$;\5
$\|f\K\\{floating\_penalty}$;\5
\\{unsave};\5
$\\{save\_ptr}\K\\{save\_ptr}-2$;\C{now $\\{saved}(0)$ is the insertion number,
or 255 for \\{vadjust}}\6
$\|p\K\\{vpack}(\\{link}(\\{head}),\39\\{natural})$;\5
\\{pop\_nest};\6
\&{if} $\\{saved}(0)<255$ \1\&{then}\6
\&{begin} \37$\\{tail\_append}(\\{get\_node}(\\{ins\_node\_size}))$;\5
$\\{type}(\\{tail})\K\\{ins\_node}$;\5
$\\{subtype}(\\{tail})\K\\{qi}(\\{saved}(0))$;\5
$\\{height}(\\{tail})\K\\{height}(\|p)+\\{depth}(\|p)$;\5
$\\{ins\_ptr}(\\{tail})\K\\{list\_ptr}(\|p)$;\5
$\\{split\_top\_ptr}(\\{tail})\K\|q$;\5
$\\{depth}(\\{tail})\K\|d$;\5
$\\{float\_cost}(\\{tail})\K\|f$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{tail\_append}(\\{get\_node}(\\{small\_node%
\_size}))$;\5
$\\{type}(\\{tail})\K\\{adjust\_node}$;\6
$\\{adjust\_pre}(\\{tail})\K\\{saved}(1)$;\C{the \\{subtype} is used for %
\\{adjust\_pre}}\6
$\\{adjust\_ptr}(\\{tail})\K\\{list\_ptr}(\|p)$;\5
$\\{delete\_glue\_ref}(\|q)$;\6
\&{end};\2\6
$\\{free\_node}(\|p,\39\\{box\_node\_size})$;\6
\&{if} $\\{nest\_ptr}=0$ \1\&{then}\5
\\{build\_page};\2\6
\&{end};\6
\4\\{output\_group}: \37\X1203:Resume the page builder after an output routine
has come to an end\X;\par
\fi

\M1279. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{make\_mark};\6
\4\&{var} \37\|p: \37\\{pointer};\C{new node}\6
\|c: \37\\{halfword};\C{the mark class}\2\6
\&{begin} \37\&{if} $\\{cur\_chr}=0$ \1\&{then}\5
$\|c\K0$\6
\4\&{else} \&{begin} \37\\{scan\_register\_num};\5
$\|c\K\\{cur\_val}$;\6
\&{end};\2\6
$\|p\K\\{scan\_toks}(\\{false},\39\\{true})$;\5
$\|p\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{mark\_class}(\|p)\K\|c$;\5
$\\{type}(\|p)\K\\{mark\_node}$;\5
$\\{subtype}(\|p)\K0$;\C{the \\{subtype} is not used}\6
$\\{mark\_ptr}(\|p)\K\\{def\_ref}$;\5
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\6
\&{end};\par
\fi

\M1280. Penalty nodes get into a list via the \\{break\_penalty} command.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{break\_penalty})$: \37\\{append\_penalty};\par
\fi

\M1281. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_penalty};\2\6
\&{begin} \37\\{scan\_int};\5
$\\{tail\_append}(\\{new\_penalty}(\\{cur\_val}))$;\6
\&{if} $\\{mode}=\\{vmode}$ \1\&{then}\5
\\{build\_page};\2\6
\&{end};\par
\fi

\M1282. The \\{remove\_item} command removes a penalty, kern, or glue node if
it
appears at the tail of the current list, using a brute-force linear scan.
Like \.{\\lastbox}, this command is not allowed in vertical mode (except
internal vertical mode), since the current list in vertical mode is sent
to the page builder.  But if we happen to be able to implement it in
vertical mode, we do.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{remove\_item})$: \37\\{delete\_last};\par
\fi

\M1283. When \\{delete\_last} is called, \\{cur\_chr} is the \\{type} of node
that
will be deleted, if present.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{delete\_last};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{run through the current list}\6
\|r: \37\\{pointer};\C{running behind \|p}\6
\\{fm}: \37\\{boolean};\C{a final \.{\\beginM} \.{\\endM} node pair?}\6
\\{tx}: \37\\{pointer};\C{effective tail node}\6
\|m: \37\\{quarterword};\C{the length of a replacement list}\2\6
\&{begin} \37\&{if} $(\\{mode}=\\{vmode})\W(\\{tail}=\\{head})$ \1\&{then}\5
\X1284:Apologize for inability to do the operation now, unless \.{\\unskip}
follows non-glue\X\6
\4\&{else} \&{begin} \37$\\{check\_effective\_tail}(\&{return})$;\6
\&{if} $\R\\{is\_char\_node}(\\{tx})$ \1\&{then}\6
\&{if} $\\{type}(\\{tx})=\\{cur\_chr}$ \1\&{then}\6
\&{begin} \37$\\{fetch\_effective\_tail}(\&{return})$;\5
$\\{flush\_node\_list}(\\{tx})$;\6
\&{end};\2\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1284. \P$\X1284:Apologize for inability to do the operation now, unless \.{%
\\unskip} follows non-glue\X\S$\6
\&{begin} \37\&{if} $(\\{cur\_chr}\I\\{glue\_node})\V(\\{last\_glue}\I\\{max%
\_halfword})$ \1\&{then}\6
\&{begin} \37\\{you\_cant};\5
$\\{help2}(\.{"Sorry...I\ usually\ can\'t\ take\ things\ from\ the\ current\
page."})$\6
$(\.{"Try\ \`I\\vskip-\\lastskip\'\ instead."})$;\6
\&{if} $\\{cur\_chr}=\\{kern\_node}$ \1\&{then}\5
$\\{help\_line}[0]\K(\.{"Try\ \`I\\kern-\\lastkern\'\ instead."})$\6
\4\&{else} \&{if} $\\{cur\_chr}\I\\{glue\_node}$ \1\&{then}\5
$\\{help\_line}[0]\K\30(\.{"Perhaps\ you\ can\ make\ the\ output\ routine\ do\
it."})$;\2\2\6
\\{error};\6
\&{end};\2\6
\&{end}\par
\U1283.\fi

\M1285. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"unpenalty"},\39\\{remove\_item},\39\\{penalty\_node})$;\6
$\\{primitive}(\.{"unkern"},\39\\{remove\_item},\39\\{kern\_node})$;\6
$\\{primitive}(\.{"unskip"},\39\\{remove\_item},\39\\{glue\_node})$;\6
$\\{primitive}(\.{"unhbox"},\39\\{un\_hbox},\39\\{box\_code})$;\6
$\\{primitive}(\.{"unhcopy"},\39\\{un\_hbox},\39\\{copy\_code})$;\6
$\\{primitive}(\.{"unvbox"},\39\\{un\_vbox},\39\\{box\_code})$;\6
$\\{primitive}(\.{"unvcopy"},\39\\{un\_vbox},\39\\{copy\_code})$;\par
\fi

\M1286. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{remove\_item}: \37\&{if} $\\{chr\_code}=\\{glue\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"unskip"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{kern\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"unkern"})$\6
\4\&{else} $\\{print\_esc}(\.{"unpenalty"})$;\2\2\6
\4\\{un\_hbox}: \37\&{if} $\\{chr\_code}=\\{copy\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"unhcopy"})$\6
\4\&{else} $\\{print\_esc}(\.{"unhbox"})$;\2\6
\4\\{un\_vbox}: \37\&{if} $\\{chr\_code}=\\{copy\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"unvcopy"})$\1\5
\X1862:Cases of \\{un\_vbox} for \\{print\_cmd\_chr}\X\2\6
\4\&{else} $\\{print\_esc}(\.{"unvbox"})$;\2\par
\fi

\M1287. The \\{un\_hbox} and \\{un\_vbox} commands unwrap one of the 256
current boxes.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{un\_vbox},\39\\{hmode}+\\{un\_hbox},\39\\{mmode}+\\{un\_hbox}$:
\37\\{unpackage};\par
\fi

\M1288. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{unpackage};\6
\4\&{label} \37$\\{done},\39\\{exit}$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the box}\6
\|r: \37\\{pointer};\C{to remove marginal kern nodes}\6
\|c: \37$\\{box\_code}\to\\{copy\_code}$;\C{should we copy?}\2\6
\&{begin} \37\&{if} $\\{cur\_chr}>\\{copy\_code}$ \1\&{then}\5
\X1863:Handle saved items and \&{goto} \\{done}\X;\2\6
$\|c\K\\{cur\_chr}$;\5
\\{scan\_register\_num};\5
$\\{fetch\_box}(\|p)$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{if} $(\\{abs}(\\{mode})=\\{mmode})\V((\\{abs}(\\{mode})=\\{vmode})\W(%
\\{type}(\|p)\I\\{vlist\_node}))\V\30((\\{abs}(\\{mode})=\\{hmode})\W(\\{type}(%
\|p)\I\\{hlist\_node}))$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Incompatible\ list\ can\'t\ be\ unboxed"})$;\5
$\\{help3}(\.{"Sorry,\ Pandora.\ (You\ sneaky\ devil.)"})$\6
$(\.{"I\ refuse\ to\ unbox\ an\ \\hbox\ in\ vertical\ mode\ or\ vice\
versa."})$\6
$(\.{"And\ I\ can\'t\ open\ any\ boxes\ in\ math\ mode."})$;\6
\\{error};\5
\&{return};\6
\&{end};\2\6
\&{if} $\|c=\\{copy\_code}$ \1\&{then}\5
$\\{link}(\\{tail})\K\\{copy\_node\_list}(\\{list\_ptr}(\|p))$\6
\4\&{else} \&{begin} \37$\\{link}(\\{tail})\K\\{list\_ptr}(\|p)$;\5
$\\{change\_box}(\\{null})$;\5
$\\{free\_node}(\|p,\39\\{box\_node\_size})$;\6
\&{end};\2\6
\4\\{done}: \37\&{while} $\\{link}(\\{tail})\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|r\K\\{link}(\\{tail})$;\6
\&{if} $\R\\{is\_char\_node}(\|r)\W(\\{type}(\|r)=\\{margin\_kern\_node})$ \1%
\&{then}\6
\&{begin} \37$\\{link}(\\{tail})\K\\{link}(\|r)$;\5
$\\{free\_avail}(\\{margin\_char}(\|r))$;\5
$\\{free\_node}(\|r,\39\\{margin\_kern\_node\_size})$;\6
\&{end};\2\6
$\\{tail}\K\\{link}(\\{tail})$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1289. \P$\X1226:Forbidden cases detected in \\{main\_control}\X\mathrel{+}\S$%
\6
$\\{vmode}+\\{ital\_corr},\39$\par
\fi

\M1290. Italic corrections are converted to kern nodes when the \\{ital\_corr}
command
follows a character. In math mode the same effect is achieved by appending
a kern of zero here, since italic corrections are supplied later.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{hmode}+\\{ital\_corr}$: \37\\{append\_italic\_correction};\6
\4$\\{mmode}+\\{ital\_corr}$: \37$\\{tail\_append}(\\{new\_kern}(0))$;\par
\fi

\M1291. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_italic\_correction};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{\\{char\_node} at the tail of the current
list}\6
\|f: \37\\{internal\_font\_number};\C{the font in the \\{char\_node}}\2\6
\&{begin} \37\&{if} $\\{tail}\I\\{head}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\\{tail})$ \1\&{then}\5
$\|p\K\\{tail}$\6
\4\&{else} \&{if} $\\{type}(\\{tail})=\\{ligature\_node}$ \1\&{then}\5
$\|p\K\\{lig\_char}(\\{tail})$\6
\4\&{else} \&{return};\2\2\6
$\|f\K\\{font}(\|p)$;\5
$\\{tail\_append}(\\{new\_kern}(\\{char\_italic}(\|f)(\\{char\_info}(\|f)(%
\\{character}(\|p)))))$;\5
$\\{subtype}(\\{tail})\K\\{explicit}$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1292. Discretionary nodes are easy in the common case `\.{\\-}', but in the
general case we must process three braces full of items.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"-"},\39\\{discretionary},\391)$;\5
$\\{primitive}(\.{"discretionary"},\39\\{discretionary},\390)$;\par
\fi

\M1293. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{discretionary}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"-"})$\ \&{else} $\\{print\_esc}(\.{"discretionary"})$;\2\par
\fi

\M1294. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{hmode}+\\{discretionary},\39\\{mmode}+\\{discretionary}$: \37\\{append%
\_discretionary};\par
\fi

\M1295. The space factor does not change when we append a discretionary node,
but it starts out as 1000 in the subsidiary lists.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_discretionary};\6
\4\&{var} \37\|c: \37\\{integer};\C{hyphen character}\6
$\\{app\_kern},\39\\{pre\_kern},\39\|p,\39\\{c\_node}$: \37\\{pointer};\2\6
\&{begin} \37$\\{tail\_append}(\\{new\_disc})$;\6
\&{if} $\\{cur\_chr}=1$ \1\&{then}\6
\&{begin} \37$\|c\K\\{hyphen\_char}[\\{cur\_font}]$;\6
\&{if} $\|c\G0$ \1\&{then}\6
\&{if} $\|c<256$ \1\&{then}\6
\&{begin} \37$\\{pre\_kern}\K\\{get\_auto\_kern}(\\{cur\_font},\39\\{non%
\_char},\39\|c)$;\5
$\\{app\_kern}\K\\{get\_auto\_kern}(\\{cur\_font},\39\|c,\39\\{non\_char})$;\5
$\\{c\_node}\K\\{new\_character}(\\{cur\_font},\39\|c)$;\6
\&{if} $(\\{app\_kern}=\\{null})\W(\\{pre\_kern}=\\{null})$ \1\&{then}\C{no
auto-kern}\6
$\\{pre\_break}(\\{tail})\K\\{c\_node}$\6
\4\&{else} \&{begin} \37\&{if} $\\{pre\_kern}=\\{null}$ \1\&{then}\5
$\\{pre\_break}(\\{tail})\K\\{c\_node}$\6
\4\&{else} \&{begin} \37$\\{pre\_break}(\\{tail})\K\\{pre\_kern}$;\5
$\\{link}(\\{pre\_kern})\K\\{c\_node}$;\6
\&{end};\2\6
\&{if} $\\{app\_kern}\I\\{null}$ \1\&{then}\5
$\\{link}(\\{c\_node})\K\\{app\_kern}$;\2\6
\&{end};\2\6
\&{end};\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{incr}(\\{save\_ptr})$;\5
$\\{saved}(-1)\K0$;\5
$\\{new\_save\_level}(\\{disc\_group})$;\5
\\{scan\_left\_brace};\5
\\{push\_nest};\5
$\\{mode}\K-\\{hmode}$;\5
$\\{space\_factor}\K1000$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1296. The three discretionary lists are constructed somewhat as if they were
hboxes. A~subroutine called \\{build\_discretionary} handles the transitions.
(This is sort of fun.)

\Y\P$\4\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{disc\_group}: \37\\{build\_discretionary};\par
\fi

\M1297. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{build\_discretionary};\6
\4\&{label} \37$\\{done},\39\\{exit}$;\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\C{for link manipulation}\6
\|n: \37\\{integer};\C{length of discretionary list}\2\6
\&{begin} \37\\{unsave};\5
\X1299:Prune the current list, if necessary, until it contains only \\{char%
\_node}, \\{kern\_node}, \\{hlist\_node}, \\{vlist\_node}, \\{rule\_node}, and %
\\{ligature\_node} items; set \|n to the length of the list, and set \|q to the
list's tail\X;\6
$\|p\K\\{link}(\\{head})$;\5
\\{pop\_nest};\6
\&{case} $\\{saved}(-1)$ \1\&{of}\6
\40: \37$\\{pre\_break}(\\{tail})\K\|p$;\6
\41: \37$\\{post\_break}(\\{tail})\K\|p$;\6
\42: \37\X1298:Attach list \|p to the current list, and record its length; then
finish up and \&{return}\X;\2\6
\&{end};\C{there are no other cases}\6
$\\{incr}(\\{saved}(-1))$;\5
$\\{new\_save\_level}(\\{disc\_group})$;\5
\\{scan\_left\_brace};\5
\\{push\_nest};\5
$\\{mode}\K-\\{hmode}$;\5
$\\{space\_factor}\K1000$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1298. \P$\X1298:Attach list \|p to the current list, and record its length;
then finish up and \&{return}\X\S$\6
\&{begin} \37\&{if} $(\|n>0)\W(\\{abs}(\\{mode})=\\{mmode})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ math\ "})$;\5
$\\{print\_esc}(\.{"discretionary"})$;\5
$\\{help2}(\.{"Sorry:\ The\ third\ part\ of\ a\ discretionary\ break\ must\
be"})$\6
$(\.{"empty,\ in\ math\ formulas.\ I\ had\ to\ delete\ your\ third\ part."})$;\5
$\\{flush\_node\_list}(\|p)$;\5
$\|n\K0$;\5
\\{error};\6
\&{end}\6
\4\&{else} $\\{link}(\\{tail})\K\|p$;\2\6
\&{if} $\|n\L\\{max\_quarterword}$ \1\&{then}\5
$\\{replace\_count}(\\{tail})\K\|n$\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Discretionary\ list\ is\ too\
long"})$;\5
$\\{help2}(\.{"Wow---I\ never\ thought\ anybody\ would\ tweak\ me\ here."})$\6
$(\.{"You\ can\'t\ seriously\ need\ such\ a\ huge\ discretionary\ list?"})$;\5
\\{error};\6
\&{end};\2\6
\&{if} $\|n>0$ \1\&{then}\5
$\\{tail}\K\|q$;\2\6
$\\{decr}(\\{save\_ptr})$;\5
\&{return};\6
\&{end}\par
\U1297.\fi

\M1299. During this loop, $\|p=\\{link}(\|q)$ and there are \|n items preceding
\|p.

\Y\P$\4\X1299:Prune the current list, if necessary, until it contains only %
\\{char\_node}, \\{kern\_node}, \\{hlist\_node}, \\{vlist\_node}, \\{rule%
\_node}, and \\{ligature\_node} items; set \|n to the length of the list, and
set \|q to the list's tail\X\S$\6
$\|q\K\\{head}$;\5
$\|p\K\\{link}(\|q)$;\5
$\|n\K0$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{if} $\\{type}(\|p)>\\{rule\_node}$ \1\&{then}\6
\&{if} $\\{type}(\|p)\I\\{kern\_node}$ \1\&{then}\6
\&{if} $\\{type}(\|p)\I\\{ligature\_node}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ discretionary\ list"})$;\5
$\\{help1}(\.{"Discretionary\ lists\ must\ contain\ only\ boxes\ and\
kerns."})$;\6
\\{error};\5
\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{"The\ following\ discretionary\ sublist\ has\ been\
deleted:"})$;\5
$\\{show\_box}(\|p)$;\5
$\\{end\_diagnostic}(\\{true})$;\5
$\\{flush\_node\_list}(\|p)$;\5
$\\{link}(\|q)\K\\{null}$;\5
\&{goto} \37\\{done};\6
\&{end};\2\2\2\2\6
$\|q\K\|p$;\5
$\|p\K\\{link}(\|q)$;\5
$\\{incr}(\|n)$;\6
\&{end};\2\6
\4\\{done}: \37\par
\U1297.\fi

\M1300. We need only one more thing to complete the horizontal mode routines,
namely
the \.{\\accent} primitive.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{hmode}+\\{accent}$: \37\\{make\_accent};\par
\fi

\M1301. The positioning of accents is straightforward but tedious. Given an
accent
of width \|a, designed for characters of height \|x and slant \|s;
and given a character of width \|w, height \|h, and slant \|t: We will shift
the accent down by $\|x-\|h$, and we will insert kern nodes that have the
effect of
centering the accent over the character and shifting the accent to the
right by $\delta={1\over2}(w-a)+h\cdot t-x\cdot s$.  If either character is
absent from the font, we will simply use the other, without shifting.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{make\_accent};\6
\4\&{var} \37$\|s,\39\|t$: \37\\{real};\C{amount of slant}\6
$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{character, box, and kern nodes}\6
\|f: \37\\{internal\_font\_number};\C{relevant font}\6
$\|a,\39\|h,\39\|x,\39\|w,\39\\{delta}$: \37\\{scaled};\C{heights and widths,
as explained above}\6
\|i: \37\\{four\_quarters};\C{character information}\2\6
\&{begin} \37\\{scan\_char\_num};\5
$\|f\K\\{cur\_font}$;\5
$\|p\K\\{new\_character}(\|f,\39\\{cur\_val})$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|x\K\\{x\_height}(\|f)$;\5
$\|s\K\\{slant}(\|f)/\\{float\_constant}(65536)$;\5
$\|a\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\\{character}(\|p)))$;\6
\\{do\_assignments};\6
\X1302:Create a character node \|q for the next character, but set $\|q\K%
\\{null}$ if problems arise\X;\6
\&{if} $\|q\I\\{null}$ \1\&{then}\5
\X1303:Append the accent with appropriate kerns, then set $\|p\K\|q$\X;\2\6
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\5
$\\{space\_factor}\K1000$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1302. \P$\X1302:Create a character node \|q for the next character, but set $%
\|q\K\\{null}$ if problems arise\X\S$\6
$\|q\K\\{null}$;\5
$\|f\K\\{cur\_font}$;\6
\&{if} $(\\{cur\_cmd}=\\{letter})\V(\\{cur\_cmd}=\\{other\_char})\V(\\{cur%
\_cmd}=\\{char\_given})$ \1\&{then}\5
$\|q\K\\{new\_character}(\|f,\39\\{cur\_chr})$\6
\4\&{else} \&{if} $\\{cur\_cmd}=\\{char\_num}$ \1\&{then}\6
\&{begin} \37\\{scan\_char\_num};\5
$\|q\K\\{new\_character}(\|f,\39\\{cur\_val})$;\6
\&{end}\6
\4\&{else} \\{back\_input}\2\2\par
\U1301.\fi

\M1303. The kern nodes appended here must be distinguished from other kerns,
lest
they be wiped away by the hyphenation algorithm or by a previous line break.

The two kerns are computed with (machine-dependent) \\{real} arithmetic, but
their sum is machine-independent; the net effect is machine-independent,
because the user cannot remove these nodes nor access them via \.{\\lastkern}.

\Y\P$\4\X1303:Append the accent with appropriate kerns, then set $\|p\K\|q$\X%
\S$\6
\&{begin} \37$\|t\K\\{slant}(\|f)/\\{float\_constant}(65536)$;\5
$\|i\K\\{char\_info}(\|f)(\\{character}(\|q))$;\5
$\|w\K\\{char\_width}(\|f)(\|i)$;\5
$\|h\K\\{char\_height}(\|f)(\\{height\_depth}(\|i))$;\6
\&{if} $\|h\I\|x$ \1\&{then}\C{the accent must be shifted up or down}\6
\&{begin} \37$\|p\K\\{hpack}(\|p,\39\\{natural})$;\5
$\\{shift\_amount}(\|p)\K\|x-\|h$;\6
\&{end};\2\6
$\\{delta}\K\\{round}((\|w-\|a)/\\{float\_constant}(2)+\|h\ast\|t-\|x\ast\|s)$;%
\5
$\|r\K\\{new\_kern}(\\{delta})$;\5
$\\{subtype}(\|r)\K\\{acc\_kern}$;\5
$\\{link}(\\{tail})\K\|r$;\5
$\\{link}(\|r)\K\|p$;\5
$\\{tail}\K\\{new\_kern}(-\|a-\\{delta})$;\5
$\\{subtype}(\\{tail})\K\\{acc\_kern}$;\5
$\\{link}(\|p)\K\\{tail}$;\5
$\|p\K\|q$;\6
\&{end}\par
\U1301.\fi

\M1304. When `\.{\\cr}' or `\.{\\span}' or a tab mark comes through the scanner
into \\{main\_control}, it might be that the user has foolishly inserted
one of them into something that has nothing to do with alignment. But it is
far more likely that a left brace or right brace has been omitted, since
\\{get\_next} takes actions appropriate to alignment only when `\.{\\cr}'
or `\.{\\span}' or tab marks occur with $\\{align\_state}=0$. The following
program attempts to make an appropriate recovery.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{car\_ret}),\39\\{any\_mode}(\\{tab\_mark})$: \37\\{align%
\_error};\6
\4$\\{any\_mode}(\\{no\_align})$: \37\\{no\_align\_error};\6
\4$\\{any\_mode}(\\{omit})$: \37\\{omit\_error};\par
\fi

\M1305. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{align\_error};\2\6
\&{begin} \37\&{if} $\\{abs}(\\{align\_state})>2$ \1\&{then}\5
\X1306:Express consternation over the fact that no alignment is in progress\X\6
\4\&{else} \&{begin} \37\\{back\_input};\6
\&{if} $\\{align\_state}<0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \{\ inserted"})$;\5
$\\{incr}(\\{align\_state})$;\5
$\\{cur\_tok}\K\\{left\_brace\_token}+\.{"\{"}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Missing\ \}\ inserted"})$;\5
$\\{decr}(\\{align\_state})$;\5
$\\{cur\_tok}\K\\{right\_brace\_token}+\.{"\}"}$;\6
\&{end};\2\6
$\\{help3}(\.{"I\'ve\ put\ in\ what\ seems\ to\ be\ necessary\ to\ fix"})$\6
$(\.{"the\ current\ column\ of\ the\ current\ alignment."})$\6
$(\.{"Try\ to\ go\ on,\ since\ this\ might\ almost\ work."})$;\5
\\{ins\_error};\6
\&{end};\2\6
\&{end};\par
\fi

\M1306. \P$\X1306:Express consternation over the fact that no alignment is in
progress\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Misplaced\ "})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\6
\&{if} $\\{cur\_tok}=\\{tab\_token}+\.{"\&"}$ \1\&{then}\6
\&{begin} \37$\\{help6}(\.{"I\ can\'t\ figure\ out\ why\ you\ would\ want\ to\
use\ a\ tab\ mark"})$\6
$(\.{"here.\ If\ you\ just\ want\ an\ ampersand,\ the\ remedy\ is"})$\6
$(\.{"simple:\ Just\ type\ \`I\\\&\'\ now.\ But\ if\ some\ right\ brace"})$\6
$(\.{"up\ above\ has\ ended\ a\ previous\ alignment\ prematurely,"})$\6
$(\.{"you\'re\ probably\ due\ for\ more\ error\ messages,\ and\ you"})$\6
$(\.{"might\ try\ typing\ \`S\'\ now\ just\ to\ see\ what\ is\
salvageable."})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{help5}(\.{"I\ can\'t\ figure\ out\ why\ you\ would\
want\ to\ use\ a\ tab\ mark"})$\6
$(\.{"or\ \\cr\ or\ \\span\ just\ now.\ If\ something\ like\ a\ right\
brace"})$\6
$(\.{"up\ above\ has\ ended\ a\ previous\ alignment\ prematurely,"})$\6
$(\.{"you\'re\ probably\ due\ for\ more\ error\ messages,\ and\ you"})$\6
$(\.{"might\ try\ typing\ \`S\'\ now\ just\ to\ see\ what\ is\
salvageable."})$;\6
\&{end};\2\6
\\{error};\6
\&{end}\par
\U1305.\fi

\M1307. The help messages here contain a little white lie, since \.{\\noalign}
and \.{\\omit} are allowed also after `\.{\\noalign\{...\}}'.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{no\_align\_error};\2\6
\&{begin} \37$\\{print\_err}(\.{"Misplaced\ "})$;\5
$\\{print\_esc}(\.{"noalign"})$;\5
$\\{help2}(\.{"I\ expect\ to\ see\ \\noalign\ only\ after\ the\ \\cr\ of"})$\6
$(\.{"an\ alignment.\ Proceed,\ and\ I\'ll\ ignore\ this\ case."})$;\5
\\{error};\6
\&{end};\6
\4\&{procedure}\1\  \37\\{omit\_error};\2\6
\&{begin} \37$\\{print\_err}(\.{"Misplaced\ "})$;\5
$\\{print\_esc}(\.{"omit"})$;\5
$\\{help2}(\.{"I\ expect\ to\ see\ \\omit\ only\ after\ tab\ marks\ or\ the\ %
\\cr\ of"})$\6
$(\.{"an\ alignment.\ Proceed,\ and\ I\'ll\ ignore\ this\ case."})$;\5
\\{error};\6
\&{end};\par
\fi

\M1308. We've now covered most of the abuses of \.{\\halign} and \.{\\valign}.
Let's take a look at what happens when they are used correctly.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{vmode}+\\{halign}$: \37\\{init\_align};\6
\4$\\{hmode}+\\{valign}$: \37\X1703:Cases of \\{main\_control} for $\\{hmode}+%
\\{valign}$\X\6
\\{init\_align};\6
\4$\\{mmode}+\\{halign}$: \37\&{if} $\\{privileged}$ \1\&{then}\6
\&{if} $\\{cur\_group}=\\{math\_shift\_group}$ \1\&{then}\5
\\{init\_align}\6
\4\&{else} \\{off\_save};\2\2\6
\4$\\{vmode}+\\{endv},\39\\{hmode}+\\{endv}$: \37\\{do\_endv};\par
\fi

\M1309. An \\{align\_group} code is supposed to remain on the \\{save\_stack}
during an entire alignment, until \\{fin\_align} removes it.

A devious user might force an \\{endv} command to occur just about anywhere;
we must defeat such hacks.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{do\_endv};\2\6
\&{begin} \37$\\{base\_ptr}\K\\{input\_ptr}$;\5
$\\{input\_stack}[\\{base\_ptr}]\K\\{cur\_input}$;\6
\&{while} $(\\{input\_stack}[\\{base\_ptr}].\\{index\_field}\I\\{v\_template})%
\W(\\{input\_stack}[\\{base\_ptr}].\\{loc\_field}=\\{null})\W(\\{input\_stack}[%
\\{base\_ptr}].\\{state\_field}=\\{token\_list})$ \1\&{do}\5
$\\{decr}(\\{base\_ptr})$;\2\6
\&{if} $(\\{input\_stack}[\\{base\_ptr}].\\{index\_field}\I\\{v\_template})\V(%
\\{input\_stack}[\\{base\_ptr}].\\{loc\_field}\I\\{null})\V(\\{input\_stack}[%
\\{base\_ptr}].\\{state\_field}\I\\{token\_list})$ \1\&{then}\5
$\\{fatal\_error}(\.{"(interwoven\ alignment\ preambles\ are\ not\
allowed)"})$;\2\6
\&{if} $\\{cur\_group}=\\{align\_group}$ \1\&{then}\6
\&{begin} \37\\{end\_graf};\6
\&{if} $\\{fin\_col}$ \1\&{then}\5
\\{fin\_row};\2\6
\&{end}\6
\4\&{else} \\{off\_save};\2\6
\&{end};\par
\fi

\M1310. \P$\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{align\_group}: \37\&{begin} \37\\{back\_input};\5
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_cr}$;\5
$\\{print\_err}(\.{"Missing\ "})$;\5
$\\{print\_esc}(\.{"cr"})$;\5
$\\{print}(\.{"\ inserted"})$;\5
$\\{help1}(\.{"I\'m\ guessing\ that\ you\ meant\ to\ end\ an\ alignment\
here."})$;\5
\\{ins\_error};\6
\&{end};\par
\fi

\M1311. \P$\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{no\_align\_group}: \37\&{begin} \37\\{end\_graf};\5
\\{unsave};\5
\\{align\_peek};\6
\&{end};\par
\fi

\M1312. Finally, \.{\\endcsname} is not supposed to get through to \\{main%
\_control}.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{end\_cs\_name})$: \37\\{cs\_error};\par
\fi

\M1313. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{cs\_error};\2\6
\&{begin} \37$\\{print\_err}(\.{"Extra\ "})$;\5
$\\{print\_esc}(\.{"endcsname"})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ this,\ since\ I\ wasn\'t\ doing\ a\ %
\\csname."})$;\5
\\{error};\6
\&{end};\par
\fi

\N1314.  \[48] Building math lists.
The routines that \TeX\ uses to create mlists are similar to those we have
just seen for the generation of hlists and vlists. But it is necessary to
make ``noads'' as well as nodes, so the reader should review the
discussion of math mode data structures before trying to make sense out of
the following program.

Here is a little routine that needs to be done whenever a subformula
is about to be processed. The parameter is a code like \\{math\_group}.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{push\_math}(\|c:\\{group\_code})$;\2\6
\&{begin} \37\\{push\_nest};\5
$\\{mode}\K-\\{mmode}$;\5
$\\{incompleat\_noad}\K\\{null}$;\5
$\\{new\_save\_level}(\|c)$;\6
\&{end};\par
\fi

\M1315. We get into math mode from horizontal mode when a `\.\$' (i.e., a
\\{math\_shift} character) is scanned. We must check to see whether this
`\.\$' is immediately followed by another, in case display math mode is
called for.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{hmode}+\\{math\_shift}$: \37\\{init\_math};\par
\fi

\M1316. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\hbox{\4}\X1733:Declare subprocedures for \\{init\_math}\X\6
\4\&{procedure}\1\  \37\\{init\_math};\6
\4\&{label} \37$\\{reswitch},\39\\{found},\39\\{not\_found},\39\\{done}$;\6
\4\&{var} \37\|w: \37\\{scaled};\C{new or partial \\{pre\_display\_size}}\6
\|j: \37\\{pointer};\C{prototype box for display}\6
\|x: \37\\{integer};\C{new \\{pre\_display\_direction}}\6
\|l: \37\\{scaled};\C{new \\{display\_width}}\6
\|s: \37\\{scaled};\C{new \\{display\_indent}}\6
\|p: \37\\{pointer};\C{current node when calculating \\{pre\_display\_size}}\6
\|q: \37\\{pointer};\C{glue specification when calculating \\{pre\_display%
\_size}}\6
\|f: \37\\{internal\_font\_number};\C{font in current \\{char\_node}}\6
\|n: \37\\{integer};\C{scope of paragraph shape specification}\6
\|v: \37\\{scaled};\C{\|w plus possible glue amount}\6
\|d: \37\\{scaled};\C{increment to \|v}\2\6
\&{begin} \37\\{get\_token};\C{\\{get\_x\_token} would fail on \.{\\ifmmode}%
\thinspace!}\6
\&{if} $(\\{cur\_cmd}=\\{math\_shift})\W(\\{mode}>0)$ \1\&{then}\5
\X1323:Go into display math mode\X\6
\4\&{else} \&{begin} \37\\{back\_input};\5
\X1317:Go into ordinary math mode\X;\6
\&{end};\2\6
\&{end};\par
\fi

\M1317. \P$\X1317:Go into ordinary math mode\X\S$\6
\&{begin} \37$\\{push\_math}(\\{math\_shift\_group})$;\5
$\\{eq\_word\_define}(\\{int\_base}+\\{cur\_fam\_code},\39-1)$;\6
\&{if} $\\{every\_math}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_math},\39\\{every\_math\_text})$;\2\6
\&{end}\par
\Us1316\ET1320.\fi

\M1318. We get into ordinary math mode from display math mode when `\.{\\eqno}'
or
`\.{\\leqno}' appears. In such cases \\{cur\_chr} will be 0 or~1, respectively;
the value of \\{cur\_chr} is placed onto \\{save\_stack} for safe keeping.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{eq\_no}$: \37\&{if} $\\{privileged}$ \1\&{then}\6
\&{if} $\\{cur\_group}=\\{math\_shift\_group}$ \1\&{then}\5
\\{start\_eq\_no}\6
\4\&{else} \\{off\_save};\2\2\par
\fi

\M1319. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"eqno"},\39\\{eq\_no},\390)$;\5
$\\{primitive}(\.{"leqno"},\39\\{eq\_no},\391)$;\par
\fi

\M1320. When \TeX\ is in display math mode, $\\{cur\_group}=\\{math\_shift%
\_group}$,
so it is not necessary for the \\{start\_eq\_no} procedure to test for
this condition.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{start\_eq\_no};\2\6
\&{begin} \37$\\{saved}(0)\K\\{cur\_chr}$;\5
$\\{incr}(\\{save\_ptr})$;\5
\X1317:Go into ordinary math mode\X;\6
\&{end};\par
\fi

\M1321. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{eq\_no}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"leqno"})$\ \&{else} $\\{print\_esc}(\.{"eqno"})$;\2\par
\fi

\M1322. \P$\X1226:Forbidden cases detected in \\{main\_control}\X\mathrel{+}\S$%
\6
$\\{non\_math}(\\{eq\_no}),\39$\par
\fi

\M1323. When we enter display math mode, we need to call \\{line\_break} to
process the partial paragraph that has just been interrupted by the
display. Then we can set the proper values of \\{display\_width} and
\\{display\_indent} and \\{pre\_display\_size}.

\Y\P$\4\X1323:Go into display math mode\X\S$\6
\&{begin} \37$\|j\K\\{null}$;\5
$\|w\K-\\{max\_dimen}$;\6
\&{if} $\\{head}=\\{tail}$ \1\&{then}\C{`\.{\\noindent\$\$}' or `\.{\$\${ }\$%
\$}'}\6
\X1732:Prepare for display after an empty paragraph\X\6
\4\&{else} \&{begin} \37$\\{line\_break}(\\{true})$;\6
\X1324:Calculate the natural width, \|w, by which the characters of the final
line extend to the right of the reference point, plus two ems; or set $\|w\K%
\\{max\_dimen}$ if the non-blank information on that line is affected by
stretching or shrinking\X;\6
\&{end};\C{now we are in vertical mode, working on the list that will contain
the display}\2\6
\X1327:Calculate the length, \|l, and the shift amount, \|s, of the display
lines\X;\6
$\\{push\_math}(\\{math\_shift\_group})$;\5
$\\{mode}\K\\{mmode}$;\5
$\\{eq\_word\_define}(\\{int\_base}+\\{cur\_fam\_code},\39-1)$;\6
$\\{eq\_word\_define}(\\{dimen\_base}+\\{pre\_display\_size\_code},\39\|w)$;\5
$\\{LR\_box}\K\|j$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
$\\{eq\_word\_define}(\\{int\_base}+\\{pre\_display\_direction\_code},\39\|x)$;%
\2\6
$\\{eq\_word\_define}(\\{dimen\_base}+\\{display\_width\_code},\39\|l)$;\5
$\\{eq\_word\_define}(\\{dimen\_base}+\\{display\_indent\_code},\39\|s)$;\6
\&{if} $\\{every\_display}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_display},\39\\{every\_display\_text})$;\2\6
\&{if} $\\{nest\_ptr}=1$ \1\&{then}\5
\\{build\_page};\2\6
\&{end}\par
\U1316.\fi

\M1324. \P$\X1324:Calculate the natural width, \|w, by which the characters of
the final line extend to the right of the reference point, plus two ems; or set
$\|w\K\\{max\_dimen}$ if the non-blank information on that line is affected by
stretching or shrinking\X\S$\6
\X1734:Prepare for display after a non-empty paragraph\X;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\X1325:Let \|d be the natural width of node \|p; if the node is
``visible,'' \&{goto} \\{found}; if the node is glue that stretches or shrinks,
set $\|v\K\\{max\_dimen}$\X;\6
\&{if} $\|v<\\{max\_dimen}$ \1\&{then}\5
$\|v\K\|v+\|d$;\2\6
\&{goto} \37\\{not\_found};\6
\4\\{found}: \37\&{if} $\|v<\\{max\_dimen}$ \1\&{then}\6
\&{begin} \37$\|v\K\|v+\|d$;\5
$\|w\K\|v$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|w\K\\{max\_dimen}$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
\4\\{not\_found}: \37$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\4\\{done}: \37\X1735:Finish the natural width computation\X\par
\U1323.\fi

\M1325. \P$\X1325:Let \|d be the natural width of node \|p; if the node is
``visible,'' \&{goto} \\{found}; if the node is glue that stretches or shrinks,
set $\|v\K\\{max\_dimen}$\X\S$\6
\4\\{reswitch}: \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{begin} \37$\|f\K\\{font}(\|p)$;\5
$\|d\K\\{char\_width}(\|f)(\\{char\_info}(\|f)(\\{character}(\|p)))$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37\&{begin} \37$\|d%
\K\\{width}(\|p)$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4\\{ligature\_node}: \37\X826:Make node \|p look like a \\{char\_node} and %
\&{goto} \\{reswitch}\X;\6
\4\\{margin\_kern\_node}: \37$\|d\K\\{width}(\|p)$;\6
\4\\{kern\_node}: \37$\|d\K\\{width}(\|p)$;\6
\hbox{\4}\X1736:Cases of `Let \|d be the natural width' that need special
treatment\X\6
\4\\{glue\_node}: \37\X1326:Let \|d be the natural width of this glue; if
stretching or shrinking, set $\|v\K\\{max\_dimen}$; \&{goto} \\{found} in the
case of leaders\X;\6
\4\\{whatsit\_node}: \37\X1608:Let \|d be the width of the whatsit \|p\X;\6
\4\&{othercases} \37$\|d\K0$\2\6
\&{endcases}\par
\U1324.\fi

\M1326. We need to be careful that \|w, \|v, and \|d do not depend on any %
\\{glue\_set}
values, since such values are subject to system-dependent rounding.
System-dependent numbers are not allowed to infiltrate parameters like
\\{pre\_display\_size}, since \TeX82 is supposed to make the same decisions on
all
machines.

\Y\P$\4\X1326:Let \|d be the natural width of this glue; if stretching or
shrinking, set $\|v\K\\{max\_dimen}$; \&{goto} \\{found} in the case of leaders%
\X\S$\6
\&{begin} \37$\|q\K\\{glue\_ptr}(\|p)$;\5
$\|d\K\\{width}(\|q)$;\6
\&{if} $\\{glue\_sign}(\\{just\_box})=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{glue\_order}(\\{just\_box})=\\{stretch\_order}(\|q))\W%
\30(\\{stretch}(\|q)\I0)$ \1\&{then}\5
$\|v\K\\{max\_dimen}$;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{glue\_sign}(\\{just\_box})=\\{shrinking}$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{glue\_order}(\\{just\_box})=\\{shrink\_order}(\|q))\W%
\30(\\{shrink}(\|q)\I0)$ \1\&{then}\5
$\|v\K\\{max\_dimen}$;\2\6
\&{end};\2\2\6
\&{if} $\\{subtype}(\|p)\G\\{a\_leaders}$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{end}\par
\U1325.\fi

\M1327. A displayed equation is considered to be three lines long, so we
calculate the length and offset of line number $\\{prev\_graf}+2$.

\Y\P$\4\X1327:Calculate the length, \|l, and the shift amount, \|s, of the
display lines\X\S$\6
\&{if} $\\{par\_shape\_ptr}=\\{null}$ \1\&{then}\6
\&{if} $(\\{hang\_indent}\I0)\W\30(((\\{hang\_after}\G0)\W(\\{prev\_graf}+2>%
\\{hang\_after}))\V\30(\\{prev\_graf}+1<-\\{hang\_after}))$ \1\&{then}\6
\&{begin} \37$\|l\K\\{hsize}-\\{abs}(\\{hang\_indent})$;\6
\&{if} $\\{hang\_indent}>0$ \1\&{then}\5
$\|s\K\\{hang\_indent}$\ \&{else} $\|s\K0$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|l\K\\{hsize}$;\5
$\|s\K0$;\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\|n\K\\{info}(\\{par\_shape\_ptr})$;\6
\&{if} $\\{prev\_graf}+2\G\|n$ \1\&{then}\5
$\|p\K\\{par\_shape\_ptr}+2\ast\|n$\6
\4\&{else} $\|p\K\\{par\_shape\_ptr}+2\ast(\\{prev\_graf}+2)$;\2\6
$\|s\K\\{mem}[\|p-1].\\{sc}$;\5
$\|l\K\\{mem}[\|p].\\{sc}$;\6
\&{end}\2\par
\U1323.\fi

\M1328. Subformulas of math formulas cause a new level of math mode to be
entered,
on the semantic nest as well as the save stack. These subformulas arise in
several ways: (1)~A left brace by itself indicates the beginning of a
subformula that will be put into a box, thereby freezing its glue and
preventing line breaks. (2)~A subscript or superscript is treated as a
subformula if it is not a single character; the same applies to
the nucleus of things like \.{\\underline}. (3)~The \.{\\left} primitive
initiates a subformula that will be terminated by a matching \.{\\right}.
The group codes placed on \\{save\_stack} in these three cases are
\\{math\_group}, \\{math\_group}, and \\{math\_left\_group}, respectively.

Here is the code that handles case (1); the other cases are not quite as
trivial, so we shall consider them later.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{left\_brace}$: \37\&{begin} \37$\\{tail\_append}(\\{new%
\_noad})$;\5
\\{back\_input};\5
$\\{scan\_math}(\\{nucleus}(\\{tail}))$;\6
\&{end};\par
\fi

\M1329. Recall that the \\{nucleus}, \\{subscr}, and \\{supscr} fields in a
noad are
broken down into subfields called \\{math\_type} and either \\{info} or
$(\\{fam},\\{character})$. The job of \\{scan\_math} is to figure out what to
place
in one of these principal fields; it looks at the subformula that
comes next in the input, and places an encoding of that subformula
into a given word of \\{mem}.

\Y\P\D \37$\\{fam\_in\_range}\S((\\{cur\_fam}\G0)\W(\\{cur\_fam}<16))$\par
\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{scan\_math}(\|p:\\{pointer})$;\6
\4\&{label} \37$\\{restart},\39\\{reswitch},\39\\{exit}$;\6
\4\&{var} \37\|c: \37\\{integer};\C{math character code}\2\6
\&{begin} \37\\{restart}: \37\X430:Get the next non-blank non-relax non-call
token\X;\6
\4\\{reswitch}: \37\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4$\\{letter},\39\\{other\_char},\39\\{char\_given}$: \37\&{begin} \37$\|c\K%
\\{ho}(\\{math\_code}(\\{cur\_chr}))$;\6
\&{if} $\|c=\O{100000}$ \1\&{then}\6
\&{begin} \37\X1330:Treat \\{cur\_chr} as an active character\X;\6
\&{goto} \37\\{restart};\6
\&{end};\2\6
\&{end};\6
\4\\{char\_num}: \37\&{begin} \37\\{scan\_char\_num};\5
$\\{cur\_chr}\K\\{cur\_val}$;\5
$\\{cur\_cmd}\K\\{char\_given}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\6
\4\\{math\_char\_num}: \37\&{begin} \37\\{scan\_fifteen\_bit\_int};\5
$\|c\K\\{cur\_val}$;\6
\&{end};\6
\4\\{math\_given}: \37$\|c\K\\{cur\_chr}$;\6
\4\\{delim\_num}: \37\&{begin} \37\\{scan\_twenty\_seven\_bit\_int};\5
$\|c\K\\{cur\_val}\mathbin{\&{div}}\O{10000}$;\6
\&{end};\6
\4\&{othercases} \37\X1331:Scan a subformula enclosed in braces and \&{return}%
\X\2\6
\&{endcases};\6
$\\{math\_type}(\|p)\K\\{math\_char}$;\5
$\\{character}(\|p)\K\\{qi}(\|c\mathbin{\&{mod}}256)$;\6
\&{if} $(\|c\G\\{var\_code})\W\\{fam\_in\_range}$ \1\&{then}\5
$\\{fam}(\|p)\K\\{cur\_fam}$\6
\4\&{else} $\\{fam}(\|p)\K(\|c\mathbin{\&{div}}256)\mathbin{\&{mod}}16$;\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1330. An active character that is an \\{outer\_call} is allowed here.

\Y\P$\4\X1330:Treat \\{cur\_chr} as an active character\X\S$\6
\&{begin} \37$\\{cur\_cs}\K\\{cur\_chr}+\\{active\_base}$;\5
$\\{cur\_cmd}\K\\{eq\_type}(\\{cur\_cs})$;\5
$\\{cur\_chr}\K\\{equiv}(\\{cur\_cs})$;\5
\\{x\_token};\5
\\{back\_input};\6
\&{end}\par
\Us1329\ET1333.\fi

\M1331. The pointer \|p is placed on \\{save\_stack} while a complex subformula
is being scanned.

\Y\P$\4\X1331:Scan a subformula enclosed in braces and \&{return}\X\S$\6
\&{begin} \37\\{back\_input};\5
\\{scan\_left\_brace};\6
$\\{saved}(0)\K\|p$;\5
$\\{incr}(\\{save\_ptr})$;\5
$\\{push\_math}(\\{math\_group})$;\5
\&{return};\6
\&{end}\par
\U1329.\fi

\M1332. The simplest math formula is, of course, `\.{\${ }\$}', when no noads
are
generated. The next simplest cases involve a single character, e.g.,
`\.{\$x\$}'. Even though such cases may not seem to be very interesting,
the reader can perhaps understand how happy the author was when `\.{\$x\$}'
was first properly typeset by \TeX. The code in this section was used.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{letter},\39\\{mmode}+\\{other\_char},\39\\{mmode}+\\{char%
\_given}$: \37$\\{set\_math\_char}(\\{ho}(\\{math\_code}(\\{cur\_chr})))$;\6
\4$\\{mmode}+\\{char\_num}$: \37\&{begin} \37\\{scan\_char\_num};\5
$\\{cur\_chr}\K\\{cur\_val}$;\5
$\\{set\_math\_char}(\\{ho}(\\{math\_code}(\\{cur\_chr})))$;\6
\&{end};\6
\4$\\{mmode}+\\{math\_char\_num}$: \37\&{begin} \37\\{scan\_fifteen\_bit\_int};%
\5
$\\{set\_math\_char}(\\{cur\_val})$;\6
\&{end};\6
\4$\\{mmode}+\\{math\_given}$: \37$\\{set\_math\_char}(\\{cur\_chr})$;\6
\4$\\{mmode}+\\{delim\_num}$: \37\&{begin} \37\\{scan\_twenty\_seven\_bit%
\_int};\5
$\\{set\_math\_char}(\\{cur\_val}\mathbin{\&{div}}\O{10000})$;\6
\&{end};\par
\fi

\M1333. The \\{set\_math\_char} procedure creates a new noad appropriate to a
given
math code, and appends it to the current mlist. However, if the math code
is sufficiently large, the \\{cur\_chr} is treated as an active character and
nothing is appended.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{set\_math\_char}(\|c:\\{integer})$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new noad}\2\6
\&{begin} \37\&{if} $\|c\G\O{100000}$ \1\&{then}\5
\X1330:Treat \\{cur\_chr} as an active character\X\6
\4\&{else} \&{begin} \37$\|p\K\\{new\_noad}$;\5
$\\{math\_type}(\\{nucleus}(\|p))\K\\{math\_char}$;\5
$\\{character}(\\{nucleus}(\|p))\K\\{qi}(\|c\mathbin{\&{mod}}256)$;\5
$\\{fam}(\\{nucleus}(\|p))\K(\|c\mathbin{\&{div}}256)\mathbin{\&{mod}}16$;\6
\&{if} $\|c\G\\{var\_code}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{fam\_in\_range}$ \1\&{then}\5
$\\{fam}(\\{nucleus}(\|p))\K\\{cur\_fam}$;\2\6
$\\{type}(\|p)\K\\{ord\_noad}$;\6
\&{end}\6
\4\&{else} $\\{type}(\|p)\K\\{ord\_noad}+(\|c\mathbin{\&{div}}\O{10000})$;\2\6
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1334. Primitive math operators like \.{\\mathop} and \.{\\underline} are
given
the command code \\{math\_comp}, supplemented by the noad type that they
generate.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"mathord"},\39\\{math\_comp},\39\\{ord\_noad})$;\5
$\\{primitive}(\.{"mathop"},\39\\{math\_comp},\39\\{op\_noad})$;\5
$\\{primitive}(\.{"mathbin"},\39\\{math\_comp},\39\\{bin\_noad})$;\5
$\\{primitive}(\.{"mathrel"},\39\\{math\_comp},\39\\{rel\_noad})$;\5
$\\{primitive}(\.{"mathopen"},\39\\{math\_comp},\39\\{open\_noad})$;\5
$\\{primitive}(\.{"mathclose"},\39\\{math\_comp},\39\\{close\_noad})$;\5
$\\{primitive}(\.{"mathpunct"},\39\\{math\_comp},\39\\{punct\_noad})$;\5
$\\{primitive}(\.{"mathinner"},\39\\{math\_comp},\39\\{inner\_noad})$;\5
$\\{primitive}(\.{"underline"},\39\\{math\_comp},\39\\{under\_noad})$;\5
$\\{primitive}(\.{"overline"},\39\\{math\_comp},\39\\{over\_noad})$;\6
$\\{primitive}(\.{"displaylimits"},\39\\{limit\_switch},\39\\{normal})$;\5
$\\{primitive}(\.{"limits"},\39\\{limit\_switch},\39\\{limits})$;\5
$\\{primitive}(\.{"nolimits"},\39\\{limit\_switch},\39\\{no\_limits})$;\par
\fi

\M1335. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{math\_comp}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{ord\_noad}: \37$\\{print\_esc}(\.{"mathord"})$;\6
\4\\{op\_noad}: \37$\\{print\_esc}(\.{"mathop"})$;\6
\4\\{bin\_noad}: \37$\\{print\_esc}(\.{"mathbin"})$;\6
\4\\{rel\_noad}: \37$\\{print\_esc}(\.{"mathrel"})$;\6
\4\\{open\_noad}: \37$\\{print\_esc}(\.{"mathopen"})$;\6
\4\\{close\_noad}: \37$\\{print\_esc}(\.{"mathclose"})$;\6
\4\\{punct\_noad}: \37$\\{print\_esc}(\.{"mathpunct"})$;\6
\4\\{inner\_noad}: \37$\\{print\_esc}(\.{"mathinner"})$;\6
\4\\{under\_noad}: \37$\\{print\_esc}(\.{"underline"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"overline"})$\2\6
\&{endcases};\6
\4\\{limit\_switch}: \37\&{if} $\\{chr\_code}=\\{limits}$ \1\&{then}\5
$\\{print\_esc}(\.{"limits"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{no\_limits}$ \1\&{then}\5
$\\{print\_esc}(\.{"nolimits"})$\6
\4\&{else} $\\{print\_esc}(\.{"displaylimits"})$;\2\2\par
\fi

\M1336. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{math\_comp}$: \37\&{begin} \37$\\{tail\_append}(\\{new%
\_noad})$;\5
$\\{type}(\\{tail})\K\\{cur\_chr}$;\5
$\\{scan\_math}(\\{nucleus}(\\{tail}))$;\6
\&{end};\6
\4$\\{mmode}+\\{limit\_switch}$: \37\\{math\_limit\_switch};\par
\fi

\M1337. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{math\_limit\_switch};\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{if} $\\{head}\I\\{tail}$ \1\&{then}\6
\&{if} $\\{type}(\\{tail})=\\{op\_noad}$ \1\&{then}\6
\&{begin} \37$\\{subtype}(\\{tail})\K\\{cur\_chr}$;\5
\&{return};\6
\&{end};\2\2\6
$\\{print\_err}(\.{"Limit\ controls\ must\ follow\ a\ math\ operator"})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ this\ misplaced\ \\limits\ or\ \\nolimits\
command."})$;\5
\\{error};\6
\4\\{exit}: \37\&{end};\par
\fi

\M1338. Delimiter fields of noads are filled in by the \\{scan\_delimiter}
routine.
The first parameter of this procedure is the \\{mem} address where the
delimiter is to be placed; the second tells if this delimiter follows
\.{\\radical} or not.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{scan\_delimiter}(\|p:\\{pointer};\,\35\|r:%
\\{boolean})$;\2\6
\&{begin} \37\&{if} $\|r$ \1\&{then}\5
\\{scan\_twenty\_seven\_bit\_int}\6
\4\&{else} \&{begin} \37\X430:Get the next non-blank non-relax non-call token%
\X;\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\4$\\{letter},\39\\{other\_char}$: \37$\\{cur\_val}\K\\{del\_code}(\\{cur%
\_chr})$;\6
\4\\{delim\_num}: \37\\{scan\_twenty\_seven\_bit\_int};\6
\4\&{othercases} \37$\\{cur\_val}\K-1$\2\6
\&{endcases};\6
\&{end};\2\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\5
\X1339:Report that an invalid delimiter code is being changed to null; set~$%
\\{cur\_val}\K0$\X;\2\6
$\\{small\_fam}(\|p)\K(\\{cur\_val}\mathbin{\&{div}}\O{4000000})\mathbin{%
\&{mod}}16$;\5
$\\{small\_char}(\|p)\K\\{qi}((\\{cur\_val}\mathbin{\&{div}}\O{10000})\mathbin{%
\&{mod}}256)$;\5
$\\{large\_fam}(\|p)\K(\\{cur\_val}\mathbin{\&{div}}256)\mathbin{\&{mod}}16$;\5
$\\{large\_char}(\|p)\K\\{qi}(\\{cur\_val}\mathbin{\&{mod}}256)$;\6
\&{end};\par
\fi

\M1339. \P$\X1339:Report that an invalid delimiter code is being changed to
null; set~$\\{cur\_val}\K0$\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ delimiter\ (.\ inserted)"})$;\5
$\\{help6}(\.{"I\ was\ expecting\ to\ see\ something\ like\ \`(\'\ or\ \`\\\{\'%
\ or"})$\6
$(\.{"\`\\\}\'\ here.\ If\ you\ typed,\ e.g.,\ \`\{\'\ instead\ of\ \`\\\{\',\
you"})$\6
$(\.{"should\ probably\ delete\ the\ \`\{\'\ by\ typing\ \`1\'\ now,\ so\
that"})$\6
$(\.{"braces\ don\'t\ get\ unbalanced.\ Otherwise\ just\ proceed."})$\6
$(\.{"Acceptable\ delimiters\ are\ characters\ whose\ \\delcode\ is"})$\6
$(\.{"nonnegative,\ or\ you\ can\ use\ \`\\delimiter\ <delimiter\ code>\'."})$;%
\5
\\{back\_error};\5
$\\{cur\_val}\K0$;\6
\&{end}\par
\U1338.\fi

\M1340. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{radical}$: \37\\{math\_radical};\par
\fi

\M1341. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{math\_radical};\2\6
\&{begin} \37$\\{tail\_append}(\\{get\_node}(\\{radical\_noad\_size}))$;\5
$\\{type}(\\{tail})\K\\{radical\_noad}$;\5
$\\{subtype}(\\{tail})\K\\{normal}$;\5
$\\{mem}[\\{nucleus}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{subscr}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{supscr}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{scan\_delimiter}(\\{left\_delimiter}(\\{tail}),\39\\{true})$;\5
$\\{scan\_math}(\\{nucleus}(\\{tail}))$;\6
\&{end};\par
\fi

\M1342. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{accent},\39\\{mmode}+\\{math\_accent}$: \37\\{math\_ac};\par
\fi

\M1343. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{math\_ac};\2\6
\&{begin} \37\&{if} $\\{cur\_cmd}=\\{accent}$ \1\&{then}\5
\X1344:Complain that the user should have said \.{\\mathaccent}\X;\2\6
$\\{tail\_append}(\\{get\_node}(\\{accent\_noad\_size}))$;\5
$\\{type}(\\{tail})\K\\{accent\_noad}$;\5
$\\{subtype}(\\{tail})\K\\{normal}$;\5
$\\{mem}[\\{nucleus}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{subscr}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{supscr}(\\{tail})].\\{hh}\K\\{empty\_field}$;\5
$\\{math\_type}(\\{accent\_chr}(\\{tail}))\K\\{math\_char}$;\5
\\{scan\_fifteen\_bit\_int};\5
$\\{character}(\\{accent\_chr}(\\{tail}))\K\\{qi}(\\{cur\_val}\mathbin{%
\&{mod}}256)$;\6
\&{if} $(\\{cur\_val}\G\\{var\_code})\W\\{fam\_in\_range}$ \1\&{then}\5
$\\{fam}(\\{accent\_chr}(\\{tail}))\K\\{cur\_fam}$\6
\4\&{else} $\\{fam}(\\{accent\_chr}(\\{tail}))\K(\\{cur\_val}\mathbin{%
\&{div}}256)\mathbin{\&{mod}}16$;\2\6
$\\{scan\_math}(\\{nucleus}(\\{tail}))$;\6
\&{end};\par
\fi

\M1344. \P$\X1344:Complain that the user should have said \.{\\mathaccent}\X\S$%
\6
\&{begin} \37$\\{print\_err}(\.{"Please\ use\ "})$;\5
$\\{print\_esc}(\.{"mathaccent"})$;\5
$\\{print}(\.{"\ for\ accents\ in\ math\ mode"})$;\5
$\\{help2}(\.{"I\'m\ changing\ \\accent\ to\ \\mathaccent\ here;\ wish\ me\
luck."})$\6
$(\.{"(Accents\ are\ not\ the\ same\ in\ formulas\ as\ they\ are\ in\
text.)"})$;\5
\\{error};\6
\&{end}\par
\U1343.\fi

\M1345. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{vcenter}$: \37\&{begin} \37$\\{scan\_spec}(\\{vcenter\_group},%
\39\\{false})$;\5
\\{normal\_paragraph};\5
\\{push\_nest};\5
$\\{mode}\K-\\{vmode}$;\5
$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\6
\&{if} $\\{every\_vbox}\I\\{null}$ \1\&{then}\5
$\\{begin\_token\_list}(\\{every\_vbox},\39\\{every\_vbox\_text})$;\2\6
\&{end};\par
\fi

\M1346. \P$\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{vcenter\_group}: \37\&{begin} \37\\{end\_graf};\5
\\{unsave};\5
$\\{save\_ptr}\K\\{save\_ptr}-2$;\5
$\|p\K\\{vpack}(\\{link}(\\{head}),\39\\{saved}(1),\39\\{saved}(0))$;\5
\\{pop\_nest};\5
$\\{tail\_append}(\\{new\_noad})$;\5
$\\{type}(\\{tail})\K\\{vcenter\_noad}$;\5
$\\{math\_type}(\\{nucleus}(\\{tail}))\K\\{sub\_box}$;\5
$\\{info}(\\{nucleus}(\\{tail}))\K\|p$;\6
\&{end};\par
\fi

\M1347. The routine that inserts a \\{style\_node} holds no surprises.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"displaystyle"},\39\\{math\_style},\39\\{display\_style})$;\5
$\\{primitive}(\.{"textstyle"},\39\\{math\_style},\39\\{text\_style})$;\5
$\\{primitive}(\.{"scriptstyle"},\39\\{math\_style},\39\\{script\_style})$;\5
$\\{primitive}(\.{"scriptscriptstyle"},\39\\{math\_style},\39\\{script\_script%
\_style})$;\par
\fi

\M1348. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{math\_style}: \37$\\{print\_style}(\\{chr\_code})$;\par
\fi

\M1349. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{math\_style}$: \37$\\{tail\_append}(\\{new\_style}(\\{cur%
\_chr}))$;\6
\4$\\{mmode}+\\{non\_script}$: \37\&{begin} \37$\\{tail\_append}(\\{new\_glue}(%
\\{zero\_glue}))$;\5
$\\{subtype}(\\{tail})\K\\{cond\_math\_glue}$;\6
\&{end};\6
\4$\\{mmode}+\\{math\_choice}$: \37\\{append\_choices};\par
\fi

\M1350. The routine that scans the four mlists of a \.{\\mathchoice} is very
much like the routine that builds discretionary nodes.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{append\_choices};\2\6
\&{begin} \37$\\{tail\_append}(\\{new\_choice})$;\5
$\\{incr}(\\{save\_ptr})$;\5
$\\{saved}(-1)\K0$;\5
$\\{push\_math}(\\{math\_choice\_group})$;\5
\\{scan\_left\_brace};\6
\&{end};\par
\fi

\M1351. \P$\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{math\_choice\_group}: \37\\{build\_choices};\par
\fi

\M1352. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\hbox{\4}\X1362:Declare the function called \\{fin\_mlist}\X\hbox{}\6
\4\&{procedure}\1\  \37\\{build\_choices};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{the current mlist}\2\6
\&{begin} \37\\{unsave};\5
$\|p\K\\{fin\_mlist}(\\{null})$;\6
\&{case} $\\{saved}(-1)$ \1\&{of}\6
\40: \37$\\{display\_mlist}(\\{tail})\K\|p$;\6
\41: \37$\\{text\_mlist}(\\{tail})\K\|p$;\6
\42: \37$\\{script\_mlist}(\\{tail})\K\|p$;\6
\43: \37\&{begin} \37$\\{script\_script\_mlist}(\\{tail})\K\|p$;\5
$\\{decr}(\\{save\_ptr})$;\5
\&{return};\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
$\\{incr}(\\{saved}(-1))$;\5
$\\{push\_math}(\\{math\_choice\_group})$;\5
\\{scan\_left\_brace};\6
\4\\{exit}: \37\&{end};\par
\fi

\M1353. Subscripts and superscripts are attached to the previous nucleus by the
action procedure called \\{sub\_sup}. We use the facts that $\\{sub\_mark}=%
\\{sup\_mark}+1$
and $\\{subscr}(\|p)=\\{supscr}(\|p)+1$.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{sub\_mark},\39\\{mmode}+\\{sup\_mark}$: \37\\{sub\_sup};\par
\fi

\M1354. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{sub\_sup};\6
\4\&{var} \37\|t: \37\\{small\_number};\C{type of previous sub/superscript}\6
\|p: \37\\{pointer};\C{field to be filled by \\{scan\_math}}\2\6
\&{begin} \37$\|t\K\\{empty}$;\5
$\|p\K\\{null}$;\6
\&{if} $\\{tail}\I\\{head}$ \1\&{then}\6
\&{if} $\\{scripts\_allowed}(\\{tail})$ \1\&{then}\6
\&{begin} \37$\|p\K\\{supscr}(\\{tail})+\\{cur\_cmd}-\\{sup\_mark}$;\C{%
\\{supscr} or \\{subscr}}\6
$\|t\K\\{math\_type}(\|p)$;\6
\&{end};\2\2\6
\&{if} $(\|p=\\{null})\V(\|t\I\\{empty})$ \1\&{then}\5
\X1355:Insert a dummy noad to be sub/superscripted\X;\2\6
$\\{scan\_math}(\|p)$;\6
\&{end};\par
\fi

\M1355. \P$\X1355:Insert a dummy noad to be sub/superscripted\X\S$\6
\&{begin} \37$\\{tail\_append}(\\{new\_noad})$;\5
$\|p\K\\{supscr}(\\{tail})+\\{cur\_cmd}-\\{sup\_mark}$;\C{\\{supscr} or %
\\{subscr}}\6
\&{if} $\|t\I\\{empty}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_cmd}=\\{sup\_mark}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Double\ superscript"})$;\5
$\\{help1}(\.{"I\ treat\ \`x\^1\^2\'\ essentially\ like\ \`x\^1\{\}\^2\'."})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Double\ subscript"})$;\5
$\\{help1}(\.{"I\ treat\ \`x\_1\_2\'\ essentially\ like\ \`x\_1\{\}\_2\'."})$;\6
\&{end};\2\6
\\{error};\6
\&{end};\2\6
\&{end}\par
\U1354.\fi

\M1356. An operation like `\.{\\over}' causes the current mlist to go into a
state of suspended animation: \\{incompleat\_noad} points to a \\{fraction%
\_noad}
that contains the mlist-so-far as its numerator, while the denominator
is yet to come. Finally when the mlist is finished, the denominator will
go into the incompleat fraction noad, and that noad will become the
whole formula, unless it is surrounded by `\.{\\left}' and `\.{\\right}'
delimiters.

\Y\P\D \37$\\{above\_code}=0$\C{ `\.{\\above}' }\par
\P\D \37$\\{over\_code}=1$\C{ `\.{\\over}' }\par
\P\D \37$\\{atop\_code}=2$\C{ `\.{\\atop}' }\par
\P\D \37$\\{delimited\_code}=3$\C{ `\.{\\abovewithdelims}', etc.}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"above"},\39\\{above},\39\\{above\_code})$;\6
$\\{primitive}(\.{"over"},\39\\{above},\39\\{over\_code})$;\6
$\\{primitive}(\.{"atop"},\39\\{above},\39\\{atop\_code})$;\6
$\\{primitive}(\.{"abovewithdelims"},\39\\{above},\39\\{delimited\_code}+%
\\{above\_code})$;\6
$\\{primitive}(\.{"overwithdelims"},\39\\{above},\39\\{delimited\_code}+\\{over%
\_code})$;\6
$\\{primitive}(\.{"atopwithdelims"},\39\\{above},\39\\{delimited\_code}+\\{atop%
\_code})$;\par
\fi

\M1357. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{above}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{over\_code}: \37$\\{print\_esc}(\.{"over"})$;\6
\4\\{atop\_code}: \37$\\{print\_esc}(\.{"atop"})$;\6
\4$\\{delimited\_code}+\\{above\_code}$: \37$\\{print\_esc}(%
\.{"abovewithdelims"})$;\6
\4$\\{delimited\_code}+\\{over\_code}$: \37$\\{print\_esc}(%
\.{"overwithdelims"})$;\6
\4$\\{delimited\_code}+\\{atop\_code}$: \37$\\{print\_esc}(%
\.{"atopwithdelims"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"above"})$\2\6
\&{endcases};\par
\fi

\M1358. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{above}$: \37\\{math\_fraction};\par
\fi

\M1359. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{math\_fraction};\6
\4\&{var} \37\|c: \37\\{small\_number};\C{the type of generalized fraction we
are scanning}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\6
\&{if} $\\{incompleat\_noad}\I\\{null}$ \1\&{then}\5
\X1361:Ignore the fraction operation and complain about this ambiguous case\X\6
\4\&{else} \&{begin} \37$\\{incompleat\_noad}\K\\{get\_node}(\\{fraction\_noad%
\_size})$;\5
$\\{type}(\\{incompleat\_noad})\K\\{fraction\_noad}$;\5
$\\{subtype}(\\{incompleat\_noad})\K\\{normal}$;\5
$\\{math\_type}(\\{numerator}(\\{incompleat\_noad}))\K\\{sub\_mlist}$;\5
$\\{info}(\\{numerator}(\\{incompleat\_noad}))\K\\{link}(\\{head})$;\5
$\\{mem}[\\{denominator}(\\{incompleat\_noad})].\\{hh}\K\\{empty\_field}$;\5
$\\{mem}[\\{left\_delimiter}(\\{incompleat\_noad})].\\{qqqq}\K\\{null%
\_delimiter}$;\5
$\\{mem}[\\{right\_delimiter}(\\{incompleat\_noad})].\\{qqqq}\K\\{null%
\_delimiter}$;\6
$\\{link}(\\{head})\K\\{null}$;\5
$\\{tail}\K\\{head}$;\5
\X1360:Use code \|c to distinguish between generalized fractions\X;\6
\&{end};\2\6
\&{end};\par
\fi

\M1360. \P$\X1360:Use code \|c to distinguish between generalized fractions\X%
\S$\6
\&{if} $\|c\G\\{delimited\_code}$ \1\&{then}\6
\&{begin} \37$\\{scan\_delimiter}(\\{left\_delimiter}(\\{incompleat\_noad}),\39%
\\{false})$;\5
$\\{scan\_delimiter}(\\{right\_delimiter}(\\{incompleat\_noad}),\39\\{false})$;%
\6
\&{end};\2\6
\&{case} $\|c\mathbin{\&{mod}}\\{delimited\_code}$ \1\&{of}\6
\4\\{above\_code}: \37\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{thickness}(\\{incompleat\_noad})\K\\{cur\_val}$;\6
\&{end};\6
\4\\{over\_code}: \37$\\{thickness}(\\{incompleat\_noad})\K\\{default\_code}$;\6
\4\\{atop\_code}: \37$\\{thickness}(\\{incompleat\_noad})\K0$;\2\6
\&{end}\C{there are no other cases}\par
\U1359.\fi

\M1361. \P$\X1361:Ignore the fraction operation and complain about this
ambiguous case\X\S$\6
\&{begin} \37\&{if} $\|c\G\\{delimited\_code}$ \1\&{then}\6
\&{begin} \37$\\{scan\_delimiter}(\\{garbage},\39\\{false})$;\5
$\\{scan\_delimiter}(\\{garbage},\39\\{false})$;\6
\&{end};\2\6
\&{if} $\|c\mathbin{\&{mod}}\\{delimited\_code}=\\{above\_code}$ \1\&{then}\5
\\{scan\_normal\_dimen};\2\6
$\\{print\_err}(\.{"Ambiguous;\ you\ need\ another\ \{\ and\ \}"})$;\5
$\\{help3}(\.{"I\'m\ ignoring\ this\ fraction\ specification,\ since\ I\ don%
\'t"})$\6
$(\.{"know\ whether\ a\ construction\ like\ \`x\ \\over\ y\ \\over\ z\'"})$\6
$(\.{"means\ \`\{x\ \\over\ y\}\ \\over\ z\'\ or\ \`x\ \\over\ \{y\ \\over\ z\}%
\'."})$;\5
\\{error};\6
\&{end}\par
\U1359.\fi

\M1362. At the end of a math formula or subformula, the \\{fin\_mlist} routine
is
called upon to return a pointer to the newly completed mlist, and to
pop the nest back to the enclosing semantic level. The parameter to
\\{fin\_mlist}, if not null, points to a \\{right\_noad} that ends the
current mlist; this \\{right\_noad} has not yet been appended.

\Y\P$\4\X1362:Declare the function called \\{fin\_mlist}\X\S$\6
\4\&{function}\1\  \37$\\{fin\_mlist}(\|p:\\{pointer})$: \37\\{pointer};\6
\4\&{var} \37\|q: \37\\{pointer};\C{the mlist to return}\2\6
\&{begin} \37\&{if} $\\{incompleat\_noad}\I\\{null}$ \1\&{then}\5
\X1363:Compleat the incompleat noad\X\6
\4\&{else} \&{begin} \37$\\{link}(\\{tail})\K\|p$;\5
$\|q\K\\{link}(\\{head})$;\6
\&{end};\2\6
\\{pop\_nest};\5
$\\{fin\_mlist}\K\|q$;\6
\&{end};\par
\U1352.\fi

\M1363. \P$\X1363:Compleat the incompleat noad\X\S$\6
\&{begin} \37$\\{math\_type}(\\{denominator}(\\{incompleat\_noad}))\K\\{sub%
\_mlist}$;\5
$\\{info}(\\{denominator}(\\{incompleat\_noad}))\K\\{link}(\\{head})$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\|q\K\\{incompleat\_noad}$\6
\4\&{else} \&{begin} \37$\|q\K\\{info}(\\{numerator}(\\{incompleat\_noad}))$;\6
\&{if} $(\\{type}(\|q)\I\\{left\_noad})\V(\\{delim\_ptr}=\\{null})$ \1\&{then}\5
$\\{confusion}(\.{"right"})$;\2\6
$\\{info}(\\{numerator}(\\{incompleat\_noad}))\K\\{link}(\\{delim\_ptr})$;\5
$\\{link}(\\{delim\_ptr})\K\\{incompleat\_noad}$;\5
$\\{link}(\\{incompleat\_noad})\K\|p$;\6
\&{end};\2\6
\&{end}\par
\U1362.\fi

\M1364. Now at last we're ready to see what happens when a right brace occurs
in a math formula. Two special cases are simplified here: Braces are
effectively
removed when they surround a single Ord without sub/superscripts, or when they
surround an accent that is the nucleus of an Ord atom.

\Y\P$\4\X1263:Cases of \\{handle\_right\_brace} where a \\{right\_brace}
triggers a delayed action\X\mathrel{+}\S$\6
\4\\{math\_group}: \37\&{begin} \37\\{unsave};\5
$\\{decr}(\\{save\_ptr})$;\6
$\\{math\_type}(\\{saved}(0))\K\\{sub\_mlist}$;\5
$\|p\K\\{fin\_mlist}(\\{null})$;\5
$\\{info}(\\{saved}(0))\K\|p$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $\\{link}(\|p)=\\{null}$ \1\&{then}\6
\&{if} $\\{type}(\|p)=\\{ord\_noad}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{math\_type}(\\{subscr}(\|p))=\\{empty}$ \1\&{then}\6
\&{if} $\\{math\_type}(\\{supscr}(\|p))=\\{empty}$ \1\&{then}\6
\&{begin} \37$\\{mem}[\\{saved}(0)].\\{hh}\K\\{mem}[\\{nucleus}(\|p)].\\{hh}$;\5
$\\{free\_node}(\|p,\39\\{noad\_size})$;\6
\&{end};\2\2\6
\&{end}\6
\4\&{else} \&{if} $\\{type}(\|p)=\\{accent\_noad}$ \1\&{then}\6
\&{if} $\\{saved}(0)=\\{nucleus}(\\{tail})$ \1\&{then}\6
\&{if} $\\{type}(\\{tail})=\\{ord\_noad}$ \1\&{then}\5
\X1365:Replace the tail of the list by \|p\X;\2\2\2\2\2\2\6
\&{end};\par
\fi

\M1365. \P$\X1365:Replace the tail of the list by \|p\X\S$\6
\&{begin} \37$\|q\K\\{head}$;\6
\&{while} $\\{link}(\|q)\I\\{tail}$ \1\&{do}\5
$\|q\K\\{link}(\|q)$;\2\6
$\\{link}(\|q)\K\|p$;\5
$\\{free\_node}(\\{tail},\39\\{noad\_size})$;\5
$\\{tail}\K\|p$;\6
\&{end}\par
\U1364.\fi

\M1366. We have dealt with all constructions of math mode except `\.{\\left}'
and
`\.{\\right}', so the picture is completed by the following sections of
the program.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"left"},\39\\{left\_right},\39\\{left\_noad})$;\5
$\\{primitive}(\.{"right"},\39\\{left\_right},\39\\{right\_noad})$;\5
$\\{text}(\\{frozen\_right})\K\.{"right"}$;\5
$\\{eqtb}[\\{frozen\_right}]\K\\{eqtb}[\\{cur\_val}]$;\par
\fi

\M1367. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{left\_right}: \37\&{if} $\\{chr\_code}=\\{left\_noad}$ \1\&{then}\5
$\\{print\_esc}(\.{"left"})$\2\6
\X1698:Cases of \\{left\_right} for \\{print\_cmd\_chr}\X\6
\4\&{else} \37$\\{print\_esc}(\.{"right"})$;\par
\fi

\M1368. \P$\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{left\_right}$: \37\\{math\_left\_right};\par
\fi

\M1369. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{math\_left\_right};\6
\4\&{var} \37\|t: \37\\{small\_number};\C{\\{left\_noad} or \\{right\_noad}}\6
\|p: \37\\{pointer};\C{new noad}\6
\|q: \37\\{pointer};\C{resulting mlist}\2\6
\&{begin} \37$\|t\K\\{cur\_chr}$;\6
\&{if} $(\|t\I\\{left\_noad})\W(\\{cur\_group}\I\\{math\_left\_group})$ \1%
\&{then}\5
\X1370:Try to recover from mismatched \.{\\right}\X\6
\4\&{else} \&{begin} \37$\|p\K\\{new\_noad}$;\5
$\\{type}(\|p)\K\|t$;\5
$\\{scan\_delimiter}(\\{delimiter}(\|p),\39\\{false})$;\6
\&{if} $\|t=\\{middle\_noad}$ \1\&{then}\6
\&{begin} \37$\\{type}(\|p)\K\\{right\_noad}$;\5
$\\{subtype}(\|p)\K\\{middle\_noad}$;\6
\&{end};\2\6
\&{if} $\|t=\\{left\_noad}$ \1\&{then}\5
$\|q\K\|p$\6
\4\&{else} \&{begin} \37$\|q\K\\{fin\_mlist}(\|p)$;\5
\\{unsave};\C{end of \\{math\_left\_group}}\6
\&{end};\2\6
\&{if} $\|t\I\\{right\_noad}$ \1\&{then}\6
\&{begin} \37$\\{push\_math}(\\{math\_left\_group})$;\5
$\\{link}(\\{head})\K\|q$;\5
$\\{tail}\K\|p$;\5
$\\{delim\_ptr}\K\|p$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{tail\_append}(\\{new\_noad})$;\5
$\\{type}(\\{tail})\K\\{inner\_noad}$;\5
$\\{math\_type}(\\{nucleus}(\\{tail}))\K\\{sub\_mlist}$;\5
$\\{info}(\\{nucleus}(\\{tail}))\K\|q$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1370. \P$\X1370:Try to recover from mismatched \.{\\right}\X\S$\6
\&{begin} \37\&{if} $\\{cur\_group}=\\{math\_shift\_group}$ \1\&{then}\6
\&{begin} \37$\\{scan\_delimiter}(\\{garbage},\39\\{false})$;\5
$\\{print\_err}(\.{"Extra\ "})$;\6
\&{if} $\|t=\\{middle\_noad}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"middle"})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ a\ \\middle\ that\ had\ no\ matching\ %
\\left."})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"right"})$;\5
$\\{help1}(\.{"I\'m\ ignoring\ a\ \\right\ that\ had\ no\ matching\ %
\\left."})$;\6
\&{end};\2\6
\\{error};\6
\&{end}\6
\4\&{else} \\{off\_save};\2\6
\&{end}\par
\U1369.\fi

\M1371. Here is the only way out of math mode.

\Y\P$\4\X1234:Cases of \\{main\_control} that build boxes and lists\X%
\mathrel{+}\S$\6
\4$\\{mmode}+\\{math\_shift}$: \37\&{if} $\\{cur\_group}=\\{math\_shift%
\_group}$ \1\&{then}\5
\\{after\_math}\6
\4\&{else} \\{off\_save};\2\par
\fi

\M1372. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\hbox{\4}\X1744:Declare subprocedures for \\{after\_math}\X\6
\4\&{procedure}\1\  \37\\{after\_math};\6
\4\&{var} \37\|l: \37\\{boolean};\C{`\.{\\leqno}' instead of `\.{\\eqno}'}\6
\\{danger}: \37\\{boolean};\C{not enough symbol fonts are present}\6
\|m: \37\\{integer};\C{\\{mmode} or $-\\{mmode}$}\6
\|p: \37\\{pointer};\C{the formula}\6
\|a: \37\\{pointer};\C{box containing equation number}\6
\X1376:Local variables for finishing a displayed formula\X\2\6
\&{begin} \37$\\{danger}\K\\{false}$;\5
\X1742:Retrieve the prototype box\X;\6
\X1373:Check that the necessary fonts for math symbols are present; if not,
flush the current math lists and set $\\{danger}\K\\{true}$\X;\6
$\|m\K\\{mode}$;\5
$\|l\K\\{false}$;\5
$\|p\K\\{fin\_mlist}(\\{null})$;\C{this pops the nest}\6
\&{if} $\\{mode}=-\|m$ \1\&{then}\C{end of equation number}\6
\&{begin} \37\X1375:Check that another \.\$ follows\X;\6
$\\{cur\_mlist}\K\|p$;\5
$\\{cur\_style}\K\\{text\_style}$;\5
$\\{mlist\_penalties}\K\\{false}$;\5
\\{mlist\_to\_hlist};\5
$\|a\K\\{hpack}(\\{link}(\\{temp\_head}),\39\\{natural})$;\5
$\\{set\_box\_lr}(\|a)(\\{dlist})$;\5
\\{unsave};\5
$\\{decr}(\\{save\_ptr})$;\C{now $\\{cur\_group}=\\{math\_shift\_group}$}\6
\&{if} $\\{saved}(0)=1$ \1\&{then}\5
$\|l\K\\{true}$;\2\6
$\\{danger}\K\\{false}$;\5
\X1742:Retrieve the prototype box\X;\6
\X1373:Check that the necessary fonts for math symbols are present; if not,
flush the current math lists and set $\\{danger}\K\\{true}$\X;\6
$\|m\K\\{mode}$;\5
$\|p\K\\{fin\_mlist}(\\{null})$;\6
\&{end}\6
\4\&{else} $\|a\K\\{null}$;\2\6
\&{if} $\|m<0$ \1\&{then}\5
\X1374:Finish math in text\X\6
\4\&{else} \&{begin} \37\&{if} $\|a=\\{null}$ \1\&{then}\5
\X1375:Check that another \.\$ follows\X;\2\6
\X1377:Finish displayed math\X;\6
\&{end};\2\6
\&{end};\par
\fi

\M1373. \P$\X1373:Check that the necessary fonts for math symbols are present;
if not, flush the current math lists and set $\\{danger}\K\\{true}$\X\S$\6
\&{if} $(\\{font\_params}[\\{fam\_fnt}(2+\\{text\_size})]<\\{total\_mathsy%
\_params})\V\30(\\{font\_params}[\\{fam\_fnt}(2+\\{script\_size})]<\\{total%
\_mathsy\_params})\V\30(\\{font\_params}[\\{fam\_fnt}(2+\\{script\_script%
\_size})]<\\{total\_mathsy\_params})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Math\ formula\ deleted:\ Insufficient\ symbol\
fonts"})$;\6
$\\{help3}(\.{"Sorry,\ but\ I\ can\'t\ typeset\ math\ unless\ \\textfont\ 2"})$%
\6
$(\.{"and\ \\scriptfont\ 2\ and\ \\scriptscriptfont\ 2\ have\ all"})$\6
$(\.{"the\ \\fontdimen\ values\ needed\ in\ math\ symbol\ fonts."})$;\5
\\{error};\5
\\{flush\_math};\5
$\\{danger}\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{font\_params}[\\{fam\_fnt}(3+\\{text\_size})]<\\{total%
\_mathex\_params})\V\30(\\{font\_params}[\\{fam\_fnt}(3+\\{script\_size})]<%
\\{total\_mathex\_params})\V\30(\\{font\_params}[\\{fam\_fnt}(3+\\{script%
\_script\_size})]<\\{total\_mathex\_params})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Math\ formula\ deleted:\ Insufficient\
extension\ fonts"})$;\6
$\\{help3}(\.{"Sorry,\ but\ I\ can\'t\ typeset\ math\ unless\ \\textfont\ 3"})$%
\6
$(\.{"and\ \\scriptfont\ 3\ and\ \\scriptscriptfont\ 3\ have\ all"})$\6
$(\.{"the\ \\fontdimen\ values\ needed\ in\ math\ extension\ fonts."})$;\5
\\{error};\5
\\{flush\_math};\5
$\\{danger}\K\\{true}$;\6
\&{end}\2\2\par
\Us1372\ET1372.\fi

\M1374. The \\{unsave} is done after everything else here; hence an appearance
of
`\.{\\mathsurround}' inside of `\.{\$...\$}' affects the spacing at these
particular \.\$'s. This is consistent with the conventions of
`\.{\$\$...\$\$}', since `\.{\\abovedisplayskip}' inside a display affects the
space above that display.

\Y\P$\4\X1374:Finish math in text\X\S$\6
\&{begin} \37$\\{tail\_append}(\\{new\_math}(\\{math\_surround},\39%
\\{before}))$;\5
$\\{cur\_mlist}\K\|p$;\5
$\\{cur\_style}\K\\{text\_style}$;\5
$\\{mlist\_penalties}\K(\\{mode}>0)$;\5
\\{mlist\_to\_hlist};\5
$\\{link}(\\{tail})\K\\{link}(\\{temp\_head})$;\6
\&{while} $\\{link}(\\{tail})\I\\{null}$ \1\&{do}\5
$\\{tail}\K\\{link}(\\{tail})$;\2\6
$\\{tail\_append}(\\{new\_math}(\\{math\_surround},\39\\{after}))$;\5
$\\{space\_factor}\K1000$;\5
\\{unsave};\6
\&{end}\par
\U1372.\fi

\M1375. \TeX\ gets to the following part of the program when the first `\.\$'
ending
a display has been scanned.

\Y\P$\4\X1375:Check that another \.\$ follows\X\S$\6
\&{begin} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cmd}\I\\{math\_shift}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Display\ math\ should\ end\ with\ \$\$"})$;\5
$\\{help2}(\.{"The\ \`\$\'\ that\ I\ just\ saw\ supposedly\ matches\ a\
previous\ \`\$\$\'."})$\6
$(\.{"So\ I\ shall\ assume\ that\ you\ typed\ \`\$\$\'\ both\ times."})$;\5
\\{back\_error};\6
\&{end};\2\6
\&{end}\par
\Us1372, 1372\ETs1384.\fi

\M1376. We have saved the worst for last: The fussiest part of math mode
processing
occurs when a displayed formula is being centered and placed with an optional
equation number.

\Y\P$\4\X1376:Local variables for finishing a displayed formula\X\S$\6
\4\|b: \37\\{pointer};\C{box containing the equation}\6
\4\|w: \37\\{scaled};\C{width of the equation}\6
\4\|z: \37\\{scaled};\C{width of the line}\6
\4\|e: \37\\{scaled};\C{width of equation number}\6
\4\|q: \37\\{scaled};\C{width of equation number plus space to separate from
equation}\6
\4\|d: \37\\{scaled};\C{displacement of equation in the line}\6
\4\|s: \37\\{scaled};\C{move the line right this much}\6
\4$\\{g1},\39\\{g2}$: \37\\{small\_number};\C{glue parameter codes for before
and after}\6
\4\|r: \37\\{pointer};\C{kern node used to position the display}\6
\4\|t: \37\\{pointer};\C{tail of adjustment list}\6
\4\\{pre\_t}: \37\\{pointer};\C{tail of pre-adjustment list}\par
\A1741.
\U1372.\fi

\M1377. At this time \|p points to the mlist for the formula; \|a is either
\\{null} or it points to a box containing the equation number; and we are in
vertical mode (or internal vertical mode).

\Y\P$\4\X1377:Finish displayed math\X\S$\6
$\\{cur\_mlist}\K\|p$;\5
$\\{cur\_style}\K\\{display\_style}$;\5
$\\{mlist\_penalties}\K\\{false}$;\5
\\{mlist\_to\_hlist};\5
$\|p\K\\{link}(\\{temp\_head})$;\6
$\\{adjust\_tail}\K\\{adjust\_head}$;\5
$\\{pre\_adjust\_tail}\K\\{pre\_adjust\_head}$;\5
$\|b\K\\{hpack}(\|p,\39\\{natural})$;\5
$\|p\K\\{list\_ptr}(\|b)$;\5
$\|t\K\\{adjust\_tail}$;\5
$\\{adjust\_tail}\K\\{null}$;\6
$\\{pre\_t}\K\\{pre\_adjust\_tail}$;\5
$\\{pre\_adjust\_tail}\K\\{null}$;\6
$\|w\K\\{width}(\|b)$;\5
$\|z\K\\{display\_width}$;\5
$\|s\K\\{display\_indent}$;\6
\&{if} $\\{pre\_display\_direction}<0$ \1\&{then}\5
$\|s\K-\|s-\|z$;\2\6
\&{if} $(\|a=\\{null})\V\\{danger}$ \1\&{then}\6
\&{begin} \37$\|e\K0$;\5
$\|q\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|e\K\\{width}(\|a)$;\5
$\|q\K\|e+\\{math\_quad}(\\{text\_size})$;\6
\&{end};\2\6
\&{if} $\|w+\|q>\|z$ \1\&{then}\5
\X1379:Squeeze the equation as much as possible; if there is an equation number
that should go on a separate line by itself, set~$\|e\K0$\X;\2\6
\X1380:Determine the displacement, \|d, of the left edge of the equation, with
respect to the line size \|z, assuming that $\|l=\\{false}$\X;\6
\X1381:Append the glue or equation number preceding the display\X;\6
\X1382:Append the display and perhaps also the equation number\X;\6
\X1383:Append the glue or equation number following the display\X;\6
\X1743:Flush the prototype box\X;\6
\\{resume\_after\_display}\par
\U1372.\fi

\M1378. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{resume\_after\_display};\2\6
\&{begin} \37\&{if} $\\{cur\_group}\I\\{math\_shift\_group}$ \1\&{then}\5
$\\{confusion}(\.{"display"})$;\2\6
\\{unsave};\5
$\\{prev\_graf}\K\\{prev\_graf}+3$;\5
\\{push\_nest};\5
$\\{mode}\K\\{hmode}$;\5
$\\{space\_factor}\K1000$;\5
\\{set\_cur\_lang};\5
$\\{clang}\K\\{cur\_lang}$;\5
$\\{prev\_graf}\K(\\{norm\_min}(\\{left\_hyphen\_min})\ast\O{100}+\\{norm%
\_min}(\\{right\_hyphen\_min}))\ast\O{200000}+\\{cur\_lang}$;\5
\X469:Scan an optional space\X;\6
\&{if} $\\{nest\_ptr}=1$ \1\&{then}\5
\\{build\_page};\2\6
\&{end};\par
\fi

\M1379. The user can force the equation number to go on a separate line
by causing its width to be zero.

\Y\P$\4\X1379:Squeeze the equation as much as possible; if there is an equation
number that should go on a separate line by itself, set~$\|e\K0$\X\S$\6
\&{begin} \37\&{if} $(\|e\I0)\W((\|w-\\{total\_shrink}[\\{normal}]+\|q\L\|z)\V%
\30(\\{total\_shrink}[\\{fil}]\I0)\V(\\{total\_shrink}[\\{fill}]\I0)\V(\\{total%
\_shrink}[\\{filll}]\I0))$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|b,\39\\{box\_node\_size})$;\5
$\|b\K\\{hpack}(\|p,\39\|z-\|q,\39\\{exactly})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|e\K0$;\6
\&{if} $\|w>\|z$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|b,\39\\{box\_node\_size})$;\5
$\|b\K\\{hpack}(\|p,\39\|z,\39\\{exactly})$;\6
\&{end};\2\6
\&{end};\2\6
$\|w\K\\{width}(\|b)$;\6
\&{end}\par
\U1377.\fi

\M1380. We try first to center the display without regard to the existence of
the equation number. If that would make it too close (where ``too close''
means that the space between display and equation number is less than the
width of the equation number), we either center it in the remaining space
or move it as far from the equation number as possible. The latter alternative
is taken only if the display begins with glue, since we assume that the
user put glue there to control the spacing precisely.

\Y\P$\4\X1380:Determine the displacement, \|d, of the left edge of the
equation, with respect to the line size \|z, assuming that $\|l=\\{false}$\X\S$%
\6
$\\{set\_box\_lr}(\|b)(\\{dlist})$;\5
$\|d\K\\{half}(\|z-\|w)$;\6
\&{if} $(\|e>0)\W(\|d<2\ast\|e)$ \1\&{then}\C{too close}\6
\&{begin} \37$\|d\K\\{half}(\|z-\|w-\|e)$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\6
\&{if} $\R\\{is\_char\_node}(\|p)$ \1\&{then}\6
\&{if} $\\{type}(\|p)=\\{glue\_node}$ \1\&{then}\5
$\|d\K0$;\2\2\2\6
\&{end}\2\par
\U1377.\fi

\M1381. If the equation number is set on a line by itself, either before or
after the formula, we append an infinite penalty so that no page break will
separate the display from its number; and we use the same size and
displacement for all three potential lines of the display, even though
`\.{\\parshape}' may specify them differently.

\Y\P$\4\X1381:Append the glue or equation number preceding the display\X\S$\6
$\\{tail\_append}(\\{new\_penalty}(\\{pre\_display\_penalty}))$;\6
\&{if} $(\|d+\|s\L\\{pre\_display\_size})\V\|l$ \1\&{then}\C{not enough
clearance}\6
\&{begin} \37$\\{g1}\K\\{above\_display\_skip\_code}$;\5
$\\{g2}\K\\{below\_display\_skip\_code}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{g1}\K\\{above\_display\_short\_skip\_code}$;\5
$\\{g2}\K\\{below\_display\_short\_skip\_code}$;\6
\&{end};\2\6
\&{if} $\|l\W(\|e=0)$ \1\&{then}\C{it follows that $\\{type}(\|a)=\\{hlist%
\_node}$}\6
\&{begin} \37$\\{app\_display}(\|j,\39\|a,\390)$;\5
$\\{tail\_append}(\\{new\_penalty}(\\{inf\_penalty}))$;\6
\&{end}\6
\4\&{else} $\\{tail\_append}(\\{new\_param\_glue}(\\{g1}))$\2\par
\U1377.\fi

\M1382. \P$\X1382:Append the display and perhaps also the equation number\X\S$\6
\&{if} $\|e\I0$ \1\&{then}\6
\&{begin} \37$\|r\K\\{new\_kern}(\|z-\|w-\|e-\|d)$;\6
\&{if} $\|l$ \1\&{then}\6
\&{begin} \37$\\{link}(\|a)\K\|r$;\5
$\\{link}(\|r)\K\|b$;\5
$\|b\K\|a$;\5
$\|d\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{link}(\|b)\K\|r$;\5
$\\{link}(\|r)\K\|a$;\6
\&{end};\2\6
$\|b\K\\{hpack}(\|b,\39\\{natural})$;\6
\&{end};\2\6
$\\{app\_display}(\|j,\39\|b,\39\|d)$\par
\U1377.\fi

\M1383. \P$\X1383:Append the glue or equation number following the display\X\S$%
\6
\&{if} $(\|a\I\\{null})\W(\|e=0)\W\R\|l$ \1\&{then}\6
\&{begin} \37$\\{tail\_append}(\\{new\_penalty}(\\{inf\_penalty}))$;\5
$\\{app\_display}(\|j,\39\|a,\39\|z-\\{width}(\|a))$;\5
$\\{g2}\K0$;\6
\&{end};\2\6
\&{if} $\|t\I\\{adjust\_head}$ \1\&{then}\C{migrating material comes after
equation number}\6
\&{begin} \37$\\{link}(\\{tail})\K\\{link}(\\{adjust\_head})$;\5
$\\{tail}\K\|t$;\6
\&{end};\2\6
\&{if} $\\{pre\_t}\I\\{pre\_adjust\_head}$ \1\&{then}\6
\&{begin} \37$\\{link}(\\{tail})\K\\{link}(\\{pre\_adjust\_head})$;\5
$\\{tail}\K\\{pre\_t}$;\6
\&{end};\2\6
$\\{tail\_append}(\\{new\_penalty}(\\{post\_display\_penalty}))$;\6
\&{if} $\\{g2}>0$ \1\&{then}\5
$\\{tail\_append}(\\{new\_param\_glue}(\\{g2}))$\2\par
\U1377.\fi

\M1384. When \.{\\halign} appears in a display, the alignment routines operate
essentially as they do in vertical mode. Then the following program is
activated, with \|p and \|q pointing to the beginning and end of the
resulting list, and with \\{aux\_save} holding the \\{prev\_depth} value.

\Y\P$\4\X1384:Finish an alignment in a display\X\S$\6
\&{begin} \37\\{do\_assignments};\6
\&{if} $\\{cur\_cmd}\I\\{math\_shift}$ \1\&{then}\5
\X1385:Pontificate about improper alignment in display\X\6
\4\&{else} \X1375:Check that another \.\$ follows\X;\2\6
$\\{flush\_node\_list}(\\{LR\_box})$;\5
\\{pop\_nest};\5
$\\{tail\_append}(\\{new\_penalty}(\\{pre\_display\_penalty}))$;\5
$\\{tail\_append}(\\{new\_param\_glue}(\\{above\_display\_skip\_code}))$;\5
$\\{link}(\\{tail})\K\|p$;\6
\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{tail}\K\|q$;\2\6
$\\{tail\_append}(\\{new\_penalty}(\\{post\_display\_penalty}))$;\5
$\\{tail\_append}(\\{new\_param\_glue}(\\{below\_display\_skip\_code}))$;\5
$\\{prev\_depth}\K\\{aux\_save}.\\{sc}$;\5
\\{resume\_after\_display};\6
\&{end}\par
\U988.\fi

\M1385. \P$\X1385:Pontificate about improper alignment in display\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \$\$\ inserted"})$;\5
$\\{help2}(\.{"Displays\ can\ use\ special\ alignments\ (like\ \\eqalignno)"})$%
\6
$(\.{"only\ if\ nothing\ but\ the\ alignment\ itself\ is\ between\ \$\$%
\'s."})$;\5
\\{back\_error};\6
\&{end}\par
\U1384.\fi

\N1386.  \[49] Mode-independent processing.
The long \\{main\_control} procedure has now been fully specified, except for
certain activities that are independent of the current mode. These activities
do not change the current vlist or hlist or mlist; if they change anything,
it is the value of a parameter or the meaning of a control sequence.

Assignments to values in \\{eqtb} can be global or local. Furthermore, a
control sequence can be defined to be `\.{\\long}', `\.{\\protected}',
or `\.{\\outer}', and it might or might not be expanded. The prefixes
`\.{\\global}', `\.{\\long}', `\.{\\protected}',
and `\.{\\outer}' can occur in any order. Therefore we assign binary numeric
codes, making it possible to accumulate the union of all specified prefixes
by adding the corresponding codes.  (\PASCAL's \&{set}  operations could also
have been used.)

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"long"},\39\\{prefix},\391)$;\5
$\\{primitive}(\.{"outer"},\39\\{prefix},\392)$;\5
$\\{primitive}(\.{"global"},\39\\{prefix},\394)$;\5
$\\{primitive}(\.{"def"},\39\\{def},\390)$;\5
$\\{primitive}(\.{"gdef"},\39\\{def},\391)$;\5
$\\{primitive}(\.{"edef"},\39\\{def},\392)$;\5
$\\{primitive}(\.{"xdef"},\39\\{def},\393)$;\par
\fi

\M1387. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{prefix}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"long"})$\6
\4\&{else} \&{if} $\\{chr\_code}=2$ \1\&{then}\5
$\\{print\_esc}(\.{"outer"})$\2\2\6
\X1771:Cases of \\{prefix} for \\{print\_cmd\_chr}\X\6
\4\&{else} \37$\\{print\_esc}(\.{"global"})$;\6
\4\\{def}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"def"})$\6
\4\&{else} \&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"gdef"})$\6
\4\&{else} \&{if} $\\{chr\_code}=2$ \1\&{then}\5
$\\{print\_esc}(\.{"edef"})$\6
\4\&{else} $\\{print\_esc}(\.{"xdef"})$;\2\2\2\par
\fi

\M1388. Every prefix, and every command code that might or might not be
prefixed,
calls the action procedure \\{prefixed\_command}. This routine accumulates
a sequence of prefixes until coming to a non-prefix, then it carries out
the command.

\Y\P$\4\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X\S$\6
\4$\\{any\_mode}(\\{toks\_register}),\39\\{any\_mode}(\\{assign\_toks}),\39%
\\{any\_mode}(\\{assign\_int}),\39\\{any\_mode}(\\{assign\_dimen}),\39\\{any%
\_mode}(\\{assign\_glue}),\39\\{any\_mode}(\\{assign\_mu\_glue}),\39\\{any%
\_mode}(\\{assign\_font\_dimen}),\39\\{any\_mode}(\\{assign\_font\_int}),\39%
\\{any\_mode}(\\{set\_aux}),\39\\{any\_mode}(\\{set\_prev\_graf}),\39\\{any%
\_mode}(\\{set\_page\_dimen}),\39\\{any\_mode}(\\{set\_page\_int}),\39\\{any%
\_mode}(\\{set\_box\_dimen}),\39\\{any\_mode}(\\{set\_shape}),\39\\{any\_mode}(%
\\{def\_code}),\39\\{any\_mode}(\\{def\_family}),\39\\{any\_mode}(\\{set%
\_font}),\39\\{any\_mode}(\\{def\_font}),\39\\{any\_mode}(\\{letterspace%
\_font}),\39\\{any\_mode}(\\{pdf\_copy\_font}),\39\\{any\_mode}(\\{register}),%
\39\\{any\_mode}(\\{advance}),\39\\{any\_mode}(\\{multiply}),\39\\{any\_mode}(%
\\{divide}),\39\\{any\_mode}(\\{prefix}),\39\\{any\_mode}(\\{let}),\39\\{any%
\_mode}(\\{shorthand\_def}),\39\\{any\_mode}(\\{read\_to\_cs}),\39\\{any%
\_mode}(\\{def}),\39\\{any\_mode}(\\{set\_box}),\39\\{any\_mode}(\\{hyph%
\_data}),\39\\{any\_mode}(\\{set\_interaction})$: \37\\{prefixed\_command};\par
\As1446, 1449, 1452, 1454, 1463\ETs1468.
\U1223.\fi

\M1389. If the user says, e.g., `\.{\\global\\global}', the redundancy is
silently accepted.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\hbox{\4}\X1393:Declare subprocedures for \\{prefixed\_command}\X\hbox{}\6
\4\&{procedure}\1\  \37\\{prefixed\_command};\6
\4\&{label} \37$\\{done},\39\\{exit}$;\6
\4\&{var} \37\|a: \37\\{small\_number};\C{accumulated prefix codes so far}\6
\|f: \37\\{internal\_font\_number};\C{identifies a font}\6
\|j: \37\\{halfword};\C{index into a \.{\\parshape} specification}\6
\|k: \37\\{font\_index};\C{index into \\{font\_info}}\6
$\|p,\39\|q$: \37\\{pointer};\C{for temporary short-term use}\6
\|n: \37\\{integer};\C{ditto}\6
\|e: \37\\{boolean};\C{should a definition be expanded? or was \.{\\let} not
done?}\2\6
\&{begin} \37$\|a\K0$;\6
\&{while} $\\{cur\_cmd}=\\{prefix}$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{odd}(\|a\mathbin{\&{div}}\\{cur\_chr})$ \1\&{then}\5
$\|a\K\|a+\\{cur\_chr}$;\2\6
\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $\\{cur\_cmd}\L\\{max\_non\_prefixed\_command}$ \1\&{then}\5
\X1390:Discard erroneous prefixes and \&{return}\X;\2\6
\&{if} $\\{tracing\_commands}>2$ \1\&{then}\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\\{show\_cur\_cmd\_chr};\2\2\6
\&{end};\2\6
\X1391:Discard the prefixes \.{\\long} and \.{\\outer} if they are irrelevant%
\X;\6
\X1392:Adjust \(f)for the setting of \.{\\globaldefs}\X;\6
\&{case} $\\{cur\_cmd}$ \1\&{of}\6
\hbox{\4}\X1395:Assignments\X\6
\4\&{othercases} \37$\\{confusion}(\.{"prefix"})$\2\6
\&{endcases};\6
\4\\{done}: \37\X1447:Insert a token saved by \.{\\afterassignment}, if any\X;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1390. \P$\X1390:Discard erroneous prefixes and \&{return}\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ a\ prefix\ with\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print\_char}(\.{"\'"})$;\5
$\\{help1}(\.{"I\'ll\ pretend\ you\ didn\'t\ say\ \\long\ or\ \\outer\ or\ %
\\global."})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
$\\{help\_line}[0]\K\30\.{"I\'ll\ pretend\ you\ didn\'t\ say\ \\long\ or\ %
\\outer\ or\ \\global\ or\ \\protected."}$;\2\6
\\{back\_error};\5
\&{return};\6
\&{end}\par
\U1389.\fi

\M1391. \P$\X1391:Discard the prefixes \.{\\long} and \.{\\outer} if they are
irrelevant\X\S$\6
\&{if} $\|a\G8$ \1\&{then}\6
\&{begin} \37$\|j\K\\{protected\_token}$;\5
$\|a\K\|a-8$;\6
\&{end}\6
\4\&{else} $\|j\K0$;\2\6
\&{if} $(\\{cur\_cmd}\I\\{def})\W((\|a\mathbin{\&{mod}}4\I0)\V(\|j\I0))$ \1%
\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_esc}(\.{"long"})$;\5
$\\{print}(\.{"\'\ or\ \`"})$;\5
$\\{print\_esc}(\.{"outer"})$;\5
$\\{help1}(\.{"I\'ll\ pretend\ you\ didn\'t\ say\ \\long\ or\ \\outer\
here."})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37$\\{help\_line}[0]\K\30\.{"I\'ll\ pretend\ you\ didn\'t\ say\ %
\\long\ or\ \\outer\ or\ \\protected\ here."}$;\5
$\\{print}(\.{"\'\ or\ \`"})$;\5
$\\{print\_esc}(\.{"protected"})$;\6
\&{end};\2\6
$\\{print}(\.{"\'\ with\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print\_char}(\.{"\'"})$;\5
\\{error};\6
\&{end}\2\par
\U1389.\fi

\M1392. The previous routine does not have to adjust \|a so that $\|a\mathbin{%
\&{mod}}4=0$,
since the following routines test for the \.{\\global} prefix as follows.

\Y\P\D \37$\\{global}\S(\|a\G4)$\par
\P\D \37$\\{define}(\#)\S$\1\6
\&{if} $\\{global}$ \1\&{then}\5
$\\{geq\_define}(\#)$\ \&{else} $\\{eq\_define}(\#)$\2\2\par
\P\D \37$\\{word\_define}(\#)\S$\1\6
\&{if} $\\{global}$ \1\&{then}\5
$\\{geq\_word\_define}(\#)$\ \&{else} $\\{eq\_word\_define}(\#)$\2\2\par
\Y\P$\4\X1392:Adjust \(f)for the setting of \.{\\globaldefs}\X\S$\6
\&{if} $\\{global\_defs}\I0$ \1\&{then}\6
\&{if} $\\{global\_defs}<0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{global}$ \1\&{then}\5
$\|a\K\|a-4$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\R\\{global}$ \1\&{then}\5
$\|a\K\|a+4$;\2\6
\&{end}\2\2\par
\U1389.\fi

\M1393. When a control sequence is to be defined, by \.{\\def} or \.{\\let} or
something similar, the \\{get\_r\_token} routine will substitute a special
control sequence for a token that is not redefinable.

\Y\P$\4\X1393:Declare subprocedures for \\{prefixed\_command}\X\S$\6
\4\&{procedure}\1\  \37\\{get\_r\_token};\6
\4\&{label} \37\\{restart};\2\6
\&{begin} \37\\{restart}: \37\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{cur\_tok}\I\\{space\_token}$;\2\6
\&{if} $(\\{cur\_cs}=0)\V(\\{cur\_cs}>\\{frozen\_control\_sequence})$ \1%
\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ control\ sequence\ inserted"})$;\5
$\\{help5}(\.{"Please\ don\'t\ say\ \`\\def\ cs\{...\}\',\ say\ \`\\def\\cs%
\{...\}\'."})$\6
$(\.{"I\'ve\ inserted\ an\ inaccessible\ control\ sequence\ so\ that\ your"})$\6
$(\.{"definition\ will\ be\ completed\ without\ mixing\ me\ up\ too\ badly."})$%
\6
$(\.{"You\ can\ recover\ graciously\ from\ this\ error,\ if\ you\'re"})$\6
$(\.{"careful;\ see\ exercise\ 27.2\ in\ The\ TeXbook."})$;\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
\\{back\_input};\2\6
$\\{cur\_tok}\K\\{cs\_token\_flag}+\\{frozen\_protection}$;\5
\\{ins\_error};\5
\&{goto} \37\\{restart};\6
\&{end};\2\6
\&{end};\par
\As1407, 1414, 1421, 1422, 1423, 1424, 1425, 1435\ETs1443.
\U1389.\fi

\M1394. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X%
\mathrel{+}\S$\6
$\\{text}(\\{frozen\_protection})\K\.{"inaccessible"}$;\par
\fi

\M1395. Here's an example of the way many of the following routines operate.
(Unfortunately, they aren't all as simple as this.)

\Y\P$\4\X1395:Assignments\X\S$\6
\4\\{set\_font}: \37$\\{define}(\\{cur\_font\_loc},\39\\{data},\39\\{cur%
\_chr})$;\par
\As1396, 1399, 1402, 1403, 1404, 1406, 1410, 1412, 1413, 1419, 1420, 1426,
1430, 1431, 1434\ETs1442.
\U1389.\fi

\M1396. When a \\{def} command has been scanned,
\\{cur\_chr} is odd if the definition is supposed to be global, and
$\\{cur\_chr}\G2$ if the definition is supposed to be expanded.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{def}: \37\&{begin} \37\&{if} $\\{odd}(\\{cur\_chr})\W\R\\{global}\W(%
\\{global\_defs}\G0)$ \1\&{then}\5
$\|a\K\|a+4$;\2\6
$\|e\K(\\{cur\_chr}\G2)$;\5
\\{get\_r\_token};\5
$\|p\K\\{cur\_cs}$;\5
$\|q\K\\{scan\_toks}(\\{true},\39\|e)$;\6
\&{if} $\|j\I0$ \1\&{then}\6
\&{begin} \37$\|q\K\\{get\_avail}$;\5
$\\{info}(\|q)\K\|j$;\5
$\\{link}(\|q)\K\\{link}(\\{def\_ref})$;\5
$\\{link}(\\{def\_ref})\K\|q$;\6
\&{end};\2\6
$\\{define}(\|p,\39\\{call}+(\|a\mathbin{\&{mod}}4),\39\\{def\_ref})$;\6
\&{end};\par
\fi

\M1397. Both \.{\\let} and \.{\\futurelet} share the command code \\{let}.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"let"},\39\\{let},\39\\{normal})$;\6
$\\{primitive}(\.{"futurelet"},\39\\{let},\39\\{normal}+1)$;\par
\fi

\M1398. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{let}: \37\&{if} $\\{chr\_code}\I\\{normal}$ \1\&{then}\5
$\\{print\_esc}(\.{"futurelet"})$\ \&{else} $\\{print\_esc}(\.{"let"})$;\2\par
\fi

\M1399. \P$\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{let}: \37\&{begin} \37$\|n\K\\{cur\_chr}$;\5
\\{get\_r\_token};\5
$\|p\K\\{cur\_cs}$;\6
\&{if} $\|n=\\{normal}$ \1\&{then}\6
\&{begin} \37\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{cur\_cmd}\I\\{spacer}$;\2\6
\&{if} $\\{cur\_tok}=\\{other\_token}+\.{"="}$ \1\&{then}\6
\&{begin} \37\\{get\_token};\6
\&{if} $\\{cur\_cmd}=\\{spacer}$ \1\&{then}\5
\\{get\_token};\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\\{get\_token};\5
$\|q\K\\{cur\_tok}$;\5
\\{get\_token};\5
\\{back\_input};\5
$\\{cur\_tok}\K\|q$;\5
\\{back\_input};\C{look ahead, then back up}\6
\&{end};\C{note that \\{back\_input} doesn't affect \\{cur\_cmd}, \\{cur\_chr}}%
\2\6
\&{if} $\\{cur\_cmd}\G\\{call}$ \1\&{then}\5
$\\{add\_token\_ref}(\\{cur\_chr})$\6
\4\&{else} \&{if} $(\\{cur\_cmd}=\\{register})\V(\\{cur\_cmd}=\\{toks%
\_register})$ \1\&{then}\6
\&{if} $(\\{cur\_chr}<\\{mem\_bot})\V(\\{cur\_chr}>\\{lo\_mem\_stat\_max})$ \1%
\&{then}\5
$\\{add\_sa\_ref}(\\{cur\_chr})$;\2\2\2\6
$\\{define}(\|p,\39\\{cur\_cmd},\39\\{cur\_chr})$;\6
\&{end};\par
\fi

\M1400. A \.{\\chardef} creates a control sequence whose \\{cmd} is \\{char%
\_given};
a \.{\\mathchardef} creates a control sequence whose \\{cmd} is \\{math%
\_given};
and the corresponding \\{chr} is the character code or math code. A \.{%
\\countdef}
or \.{\\dimendef} or \.{\\skipdef} or \.{\\muskipdef} creates a control
sequence whose \\{cmd} is \\{assign\_int} or \dots\ or \\{assign\_mu\_glue},
and the
corresponding \\{chr} is the \\{eqtb} location of the internal register in
question.

\Y\P\D \37$\\{char\_def\_code}=0$\C{\\{shorthand\_def} for \.{\\chardef}}\par
\P\D \37$\\{math\_char\_def\_code}=1$\C{\\{shorthand\_def} for \.{%
\\mathchardef}}\par
\P\D \37$\\{count\_def\_code}=2$\C{\\{shorthand\_def} for \.{\\countdef}}\par
\P\D \37$\\{dimen\_def\_code}=3$\C{\\{shorthand\_def} for \.{\\dimendef}}\par
\P\D \37$\\{skip\_def\_code}=4$\C{\\{shorthand\_def} for \.{\\skipdef}}\par
\P\D \37$\\{mu\_skip\_def\_code}=5$\C{\\{shorthand\_def} for \.{\\muskipdef}}%
\par
\P\D \37$\\{toks\_def\_code}=6$\C{\\{shorthand\_def} for \.{\\toksdef}}\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"chardef"},\39\\{shorthand\_def},\39\\{char\_def\_code})$;\6
$\\{primitive}(\.{"mathchardef"},\39\\{shorthand\_def},\39\\{math\_char\_def%
\_code})$;\6
$\\{primitive}(\.{"countdef"},\39\\{shorthand\_def},\39\\{count\_def\_code})$;\6
$\\{primitive}(\.{"dimendef"},\39\\{shorthand\_def},\39\\{dimen\_def\_code})$;\6
$\\{primitive}(\.{"skipdef"},\39\\{shorthand\_def},\39\\{skip\_def\_code})$;\6
$\\{primitive}(\.{"muskipdef"},\39\\{shorthand\_def},\39\\{mu\_skip\_def%
\_code})$;\6
$\\{primitive}(\.{"toksdef"},\39\\{shorthand\_def},\39\\{toks\_def\_code})$;\par
\fi

\M1401. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{shorthand\_def}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{char\_def\_code}: \37$\\{print\_esc}(\.{"chardef"})$;\6
\4\\{math\_char\_def\_code}: \37$\\{print\_esc}(\.{"mathchardef"})$;\6
\4\\{count\_def\_code}: \37$\\{print\_esc}(\.{"countdef"})$;\6
\4\\{dimen\_def\_code}: \37$\\{print\_esc}(\.{"dimendef"})$;\6
\4\\{skip\_def\_code}: \37$\\{print\_esc}(\.{"skipdef"})$;\6
\4\\{mu\_skip\_def\_code}: \37$\\{print\_esc}(\.{"muskipdef"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"toksdef"})$\2\6
\&{endcases};\6
\4\\{char\_given}: \37\&{begin} \37$\\{print\_esc}(\.{"char"})$;\5
$\\{print\_hex}(\\{chr\_code})$;\6
\&{end};\6
\4\\{math\_given}: \37\&{begin} \37$\\{print\_esc}(\.{"mathchar"})$;\5
$\\{print\_hex}(\\{chr\_code})$;\6
\&{end};\par
\fi

\M1402. We temporarily define \|p to be \\{relax}, so that an occurrence of \|p
while scanning the definition will simply stop the scanning instead of
producing an ``undefined control sequence'' error or expanding the
previous meaning.  This allows, for instance, `\.{\\chardef\\foo=123\\foo}'.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{shorthand\_def}: \37\&{begin} \37$\|n\K\\{cur\_chr}$;\5
\\{get\_r\_token};\5
$\|p\K\\{cur\_cs}$;\5
$\\{define}(\|p,\39\\{relax},\39256)$;\5
\\{scan\_optional\_equals};\6
\&{case} $\|n$ \1\&{of}\6
\4\\{char\_def\_code}: \37\&{begin} \37\\{scan\_char\_num};\5
$\\{define}(\|p,\39\\{char\_given},\39\\{cur\_val})$;\6
\&{end};\6
\4\\{math\_char\_def\_code}: \37\&{begin} \37\\{scan\_fifteen\_bit\_int};\5
$\\{define}(\|p,\39\\{math\_given},\39\\{cur\_val})$;\6
\&{end};\6
\4\&{othercases} \37\&{begin} \37\\{scan\_register\_num};\6
\&{if} $\\{cur\_val}>255$ \1\&{then}\6
\&{begin} \37$\|j\K\|n-\\{count\_def\_code}$;\C{$\\{int\_val}\to\\{box\_val}$}\6
\&{if} $\|j>\\{mu\_val}$ \1\&{then}\5
$\|j\K\\{tok\_val}$;\C{$\\{int\_val}\to\\{mu\_val}$ or \\{tok\_val}}\2\6
$\\{find\_sa\_element}(\|j,\39\\{cur\_val},\39\\{true})$;\5
$\\{add\_sa\_ref}(\\{cur\_ptr})$;\6
\&{if} $\|j=\\{tok\_val}$ \1\&{then}\5
$\|j\K\\{toks\_register}$\ \&{else} $\|j\K\\{register}$;\2\6
$\\{define}(\|p,\39\|j,\39\\{cur\_ptr})$;\6
\&{end}\6
\4\&{else} \&{case} $\|n$ \1\&{of}\6
\4\\{count\_def\_code}: \37$\\{define}(\|p,\39\\{assign\_int},\39\\{count%
\_base}+\\{cur\_val})$;\6
\4\\{dimen\_def\_code}: \37$\\{define}(\|p,\39\\{assign\_dimen},\39\\{scaled%
\_base}+\\{cur\_val})$;\6
\4\\{skip\_def\_code}: \37$\\{define}(\|p,\39\\{assign\_glue},\39\\{skip%
\_base}+\\{cur\_val})$;\6
\4\\{mu\_skip\_def\_code}: \37$\\{define}(\|p,\39\\{assign\_mu\_glue},\39\\{mu%
\_skip\_base}+\\{cur\_val})$;\6
\4\\{toks\_def\_code}: \37$\\{define}(\|p,\39\\{assign\_toks},\39\\{toks%
\_base}+\\{cur\_val})$;\2\6
\&{end};\C{there are no other cases}\2\6
\&{end}\2\6
\&{endcases};\6
\&{end};\par
\fi

\M1403. \P$\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{read\_to\_cs}: \37\&{begin} \37$\|j\K\\{cur\_chr}$;\5
\\{scan\_int};\5
$\|n\K\\{cur\_val}$;\6
\&{if} $\R\\{scan\_keyword}(\.{"to"})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ \`to\'\ inserted"})$;\5
$\\{help2}(\.{"You\ should\ have\ said\ \`\\read<number>\ to\ \\cs\'."})$\6
$(\.{"I\'m\ going\ to\ look\ for\ the\ \\cs\ now."})$;\5
\\{error};\6
\&{end};\2\6
\\{get\_r\_token};\5
$\|p\K\\{cur\_cs}$;\5
$\\{read\_toks}(\|n,\39\|p,\39\|j)$;\5
$\\{define}(\|p,\39\\{call},\39\\{cur\_val})$;\6
\&{end};\par
\fi

\M1404. The token-list parameters, \.{\\output} and \.{\\everypar}, etc.,
receive
their values in the following way. (For safety's sake, we place an
enclosing pair of braces around an \.{\\output} list.)

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4$\\{toks\_register},\39\\{assign\_toks}$: \37\&{begin} \37$\|q\K\\{cur\_cs}$;%
\5
$\|e\K\\{false}$;\C{just in case, will be set \\{true} for sparse array
elements}\6
\&{if} $\\{cur\_cmd}=\\{toks\_register}$ \1\&{then}\6
\&{if} $\\{cur\_chr}=\\{mem\_bot}$ \1\&{then}\6
\&{begin} \37\\{scan\_register\_num};\6
\&{if} $\\{cur\_val}>255$ \1\&{then}\6
\&{begin} \37$\\{find\_sa\_element}(\\{tok\_val},\39\\{cur\_val},\39\\{true})$;%
\5
$\\{cur\_chr}\K\\{cur\_ptr}$;\5
$\|e\K\\{true}$;\6
\&{end}\6
\4\&{else} $\\{cur\_chr}\K\\{toks\_base}+\\{cur\_val}$;\2\6
\&{end}\6
\4\&{else} $\|e\K\\{true}$;\2\2\6
$\|p\K\\{cur\_chr}$;\C{$\|p=\\{every\_par\_loc}$ or \\{output\_routine\_loc} or
\dots}\6
\\{scan\_optional\_equals};\5
\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $\\{cur\_cmd}\I\\{left\_brace}$ \1\&{then}\5
\X1405:If the right-hand side is a token parameter or token register, finish
the assignment and \&{goto} \\{done}\X;\2\6
\\{back\_input};\5
$\\{cur\_cs}\K\|q$;\5
$\|q\K\\{scan\_toks}(\\{false},\39\\{false})$;\6
\&{if} $\\{link}(\\{def\_ref})=\\{null}$ \1\&{then}\C{empty list: revert to the
default}\6
\&{begin} \37$\\{sa\_define}(\|p,\39\\{null})(\|p,\39\\{undefined\_cs},\39%
\\{null})$;\5
$\\{free\_avail}(\\{def\_ref})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $(\|p=\\{output\_routine\_loc})\W\R\|e$ \1%
\&{then}\C{enclose in curlies}\6
\&{begin} \37$\\{link}(\|q)\K\\{get\_avail}$;\5
$\|q\K\\{link}(\|q)$;\5
$\\{info}(\|q)\K\\{right\_brace\_token}+\.{"\}"}$;\5
$\|q\K\\{get\_avail}$;\5
$\\{info}(\|q)\K\\{left\_brace\_token}+\.{"\{"}$;\5
$\\{link}(\|q)\K\\{link}(\\{def\_ref})$;\5
$\\{link}(\\{def\_ref})\K\|q$;\6
\&{end};\2\6
$\\{sa\_define}(\|p,\39\\{def\_ref})(\|p,\39\\{call},\39\\{def\_ref})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1405. \P$\X1405:If the right-hand side is a token parameter or token
register, finish the assignment and \&{goto} \\{done}\X\S$\6
\&{if} $(\\{cur\_cmd}=\\{toks\_register})\V(\\{cur\_cmd}=\\{assign\_toks})$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{cur\_cmd}=\\{toks\_register}$ \1\&{then}\6
\&{if} $\\{cur\_chr}=\\{mem\_bot}$ \1\&{then}\6
\&{begin} \37\\{scan\_register\_num};\6
\&{if} $\\{cur\_val}<256$ \1\&{then}\5
$\|q\K\\{equiv}(\\{toks\_base}+\\{cur\_val})$\6
\4\&{else} \&{begin} \37$\\{find\_sa\_element}(\\{tok\_val},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}=\\{null}$ \1\&{then}\5
$\|q\K\\{null}$\6
\4\&{else} $\|q\K\\{sa\_ptr}(\\{cur\_ptr})$;\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\|q\K\\{sa\_ptr}(\\{cur\_chr})$\2\6
\4\&{else} $\|q\K\\{equiv}(\\{cur\_chr})$;\2\6
\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{sa\_define}(\|p,\39\\{null})(\|p,\39\\{undefined\_cs},\39\\{null})$\6
\4\&{else} \&{begin} \37$\\{add\_token\_ref}(\|q)$;\5
$\\{sa\_define}(\|p,\39\|q)(\|p,\39\\{call},\39\|q)$;\6
\&{end};\2\6
\&{goto} \37\\{done};\6
\&{end}\2\par
\U1404.\fi

\M1406. Similar routines are used to assign values to the numeric parameters.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{assign\_int}: \37\&{begin} \37$\|p\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_int};\5
$\\{word\_define}(\|p,\39\\{cur\_val})$;\6
\&{end};\6
\4\\{assign\_dimen}: \37\&{begin} \37$\|p\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_normal\_dimen};\5
$\\{word\_define}(\|p,\39\\{cur\_val})$;\6
\&{end};\6
\4$\\{assign\_glue},\39\\{assign\_mu\_glue}$: \37\&{begin} \37$\|p\K\\{cur%
\_chr}$;\5
$\|n\K\\{cur\_cmd}$;\5
\\{scan\_optional\_equals};\6
\&{if} $\|n=\\{assign\_mu\_glue}$ \1\&{then}\5
$\\{scan\_glue}(\\{mu\_val})$\ \&{else} $\\{scan\_glue}(\\{glue\_val})$;\2\6
\\{trap\_zero\_glue};\5
$\\{define}(\|p,\39\\{glue\_ref},\39\\{cur\_val})$;\6
\&{end};\par
\fi

\M1407. When a glue register or parameter becomes zero, it will always point to
\\{zero\_glue} because of the following procedure. (Exception: The tabskip
glue isn't trapped while preambles are being scanned.)

\Y\P$\4\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{trap\_zero\_glue};\2\6
\&{begin} \37\&{if} $(\\{width}(\\{cur\_val})=0)\W(\\{stretch}(\\{cur\_val})=0)%
\W(\\{shrink}(\\{cur\_val})=0)$ \1\&{then}\6
\&{begin} \37$\\{add\_glue\_ref}(\\{zero\_glue})$;\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\5
$\\{cur\_val}\K\\{zero\_glue}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1408. The various character code tables are changed by the \\{def\_code}
commands,
and the font families are declared by \\{def\_family}.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"catcode"},\39\\{def\_code},\39\\{cat\_code\_base})$;\5
$\\{primitive}(\.{"mathcode"},\39\\{def\_code},\39\\{math\_code\_base})$;\5
$\\{primitive}(\.{"lccode"},\39\\{def\_code},\39\\{lc\_code\_base})$;\5
$\\{primitive}(\.{"uccode"},\39\\{def\_code},\39\\{uc\_code\_base})$;\5
$\\{primitive}(\.{"sfcode"},\39\\{def\_code},\39\\{sf\_code\_base})$;\5
$\\{primitive}(\.{"delcode"},\39\\{def\_code},\39\\{del\_code\_base})$;\5
$\\{primitive}(\.{"textfont"},\39\\{def\_family},\39\\{math\_font\_base})$;\5
$\\{primitive}(\.{"scriptfont"},\39\\{def\_family},\39\\{math\_font\_base}+%
\\{script\_size})$;\5
$\\{primitive}(\.{"scriptscriptfont"},\39\\{def\_family},\39\\{math\_font%
\_base}+\\{script\_script\_size})$;\par
\fi

\M1409. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{def\_code}: \37\&{if} $\\{chr\_code}=\\{cat\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"catcode"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{math\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"mathcode"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{lc\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"lccode"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{uc\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"uccode"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{sf\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"sfcode"})$\6
\4\&{else} $\\{print\_esc}(\.{"delcode"})$;\2\2\2\2\2\6
\4\\{def\_family}: \37$\\{print\_size}(\\{chr\_code}-\\{math\_font\_base})$;\par
\fi

\M1410. The different types of code values have different legal ranges; the
following program is careful to check each case properly.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{def\_code}: \37\&{begin} \37\X1411:Let \|n be the largest legal code
value, based on \\{cur\_chr}\X;\6
$\|p\K\\{cur\_chr}$;\5
\\{scan\_char\_num};\5
$\|p\K\|p+\\{cur\_val}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_int};\6
\&{if} $((\\{cur\_val}<0)\W(\|p<\\{del\_code\_base}))\V(\\{cur\_val}>\|n)$ \1%
\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Invalid\ code\ ("})$;\5
$\\{print\_int}(\\{cur\_val})$;\6
\&{if} $\|p<\\{del\_code\_base}$ \1\&{then}\5
$\\{print}(\.{"),\ should\ be\ in\ the\ range\ 0.."})$\6
\4\&{else} $\\{print}(\.{"),\ should\ be\ at\ most\ "})$;\2\6
$\\{print\_int}(\|n)$;\5
$\\{help1}(\.{"I\'m\ going\ to\ use\ 0\ instead\ of\ that\ illegal\ code\
value."})$;\6
\\{error};\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{if} $\|p<\\{math\_code\_base}$ \1\&{then}\5
$\\{define}(\|p,\39\\{data},\39\\{cur\_val})$\6
\4\&{else} \&{if} $\|p<\\{del\_code\_base}$ \1\&{then}\5
$\\{define}(\|p,\39\\{data},\39\\{hi}(\\{cur\_val}))$\6
\4\&{else} $\\{word\_define}(\|p,\39\\{cur\_val})$;\2\2\6
\&{end};\par
\fi

\M1411. \P$\X1411:Let \|n be the largest legal code value, based on \\{cur%
\_chr}\X\S$\6
\&{if} $\\{cur\_chr}=\\{cat\_code\_base}$ \1\&{then}\5
$\|n\K\\{max\_char\_code}$\6
\4\&{else} \&{if} $\\{cur\_chr}=\\{math\_code\_base}$ \1\&{then}\5
$\|n\K\O{100000}$\6
\4\&{else} \&{if} $\\{cur\_chr}=\\{sf\_code\_base}$ \1\&{then}\5
$\|n\K\O{77777}$\6
\4\&{else} \&{if} $\\{cur\_chr}=\\{del\_code\_base}$ \1\&{then}\5
$\|n\K\O{77777777}$\6
\4\&{else} $\|n\K255$\2\2\2\2\par
\U1410.\fi

\M1412. \P$\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{def\_family}: \37\&{begin} \37$\|p\K\\{cur\_chr}$;\5
\\{scan\_four\_bit\_int};\5
$\|p\K\|p+\\{cur\_val}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_font\_ident};\5
$\\{define}(\|p,\39\\{data},\39\\{cur\_val})$;\6
\&{end};\par
\fi

\M1413. Next we consider changes to \TeX's numeric registers.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4$\\{register},\39\\{advance},\39\\{multiply},\39\\{divide}$: \37$\\{do%
\_register\_command}(\|a)$;\par
\fi

\M1414. We use the fact that $\\{register}<\\{advance}<\\{multiply}<%
\\{divide}$.

\Y\P$\4\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{do\_register\_command}(\|a:\\{small\_number})$;\6
\4\&{label} \37$\\{found},\39\\{exit}$;\6
\4\&{var} \37$\|l,\39\|q,\39\|r,\39\|s$: \37\\{pointer};\C{for list
manipulation}\6
\|p: \37$\\{int\_val}\to\\{mu\_val}$;\C{type of register involved}\6
\|e: \37\\{boolean};\C{does \|l refer to a sparse array element?}\6
\|w: \37\\{integer};\C{integer or dimen value of \|l}\2\6
\&{begin} \37$\|q\K\\{cur\_cmd}$;\5
$\|e\K\\{false}$;\C{just in case, will be set \\{true} for sparse array
elements}\6
\X1415:Compute the register location \|l and its type \|p; but \&{return} if
invalid\X;\6
\&{if} $\|q=\\{register}$ \1\&{then}\5
\\{scan\_optional\_equals}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"by"})$ \1\&{then}\5
\\{do\_nothing};\C{optional `\.{by}'}\2\2\6
$\\{arith\_error}\K\\{false}$;\6
\&{if} $\|q<\\{multiply}$ \1\&{then}\5
\X1416:Compute result of \\{register} or \\{advance}, put it in \\{cur\_val}\X\6
\4\&{else} \X1418:Compute result of \\{multiply} or \\{divide}, put it in %
\\{cur\_val}\X;\2\6
\&{if} $\\{arith\_error}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Arithmetic\ overflow"})$;\5
$\\{help2}(\.{"I\ can\'t\ carry\ out\ that\ multiplication\ or\ division,"})$\6
$(\.{"since\ the\ result\ is\ out\ of\ range."})$;\6
\&{if} $\|p\G\\{glue\_val}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\2\6
\\{error};\5
\&{return};\6
\&{end};\2\6
\&{if} $\|p<\\{glue\_val}$ \1\&{then}\5
$\\{sa\_word\_define}(\|l,\39\\{cur\_val})$\6
\4\&{else} \&{begin} \37\\{trap\_zero\_glue};\5
$\\{sa\_define}(\|l,\39\\{cur\_val})(\|l,\39\\{glue\_ref},\39\\{cur\_val})$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1415. Here we use the fact that the consecutive codes $\\{int\_val}\to\\{mu%
\_val}$ and
$\\{assign\_int}\to\\{assign\_mu\_glue}$ correspond to each other nicely.

\Y\P$\4\X1415:Compute the register location \|l and its type \|p; but %
\&{return} if invalid\X\S$\6
\&{begin} \37\&{if} $\|q\I\\{register}$ \1\&{then}\6
\&{begin} \37\\{get\_x\_token};\6
\&{if} $(\\{cur\_cmd}\G\\{assign\_int})\W(\\{cur\_cmd}\L\\{assign\_mu\_glue})$ %
\1\&{then}\6
\&{begin} \37$\|l\K\\{cur\_chr}$;\5
$\|p\K\\{cur\_cmd}-\\{assign\_int}$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\&{if} $\\{cur\_cmd}\I\\{register}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print}(\.{"\'\ after\ "})$;\5
$\\{print\_cmd\_chr}(\|q,\390)$;\5
$\\{help1}(\.{"I\'m\ forgetting\ what\ you\ said\ and\ not\ changing\
anything."})$;\5
\\{error};\5
\&{return};\6
\&{end};\2\6
\&{end};\2\6
\&{if} $(\\{cur\_chr}<\\{mem\_bot})\V(\\{cur\_chr}>\\{lo\_mem\_stat\_max})$ \1%
\&{then}\6
\&{begin} \37$\|l\K\\{cur\_chr}$;\5
$\|p\K\\{sa\_type}(\|l)$;\5
$\|e\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{cur\_chr}-\\{mem\_bot}$;\5
\\{scan\_register\_num};\6
\&{if} $\\{cur\_val}>255$ \1\&{then}\6
\&{begin} \37$\\{find\_sa\_element}(\|p,\39\\{cur\_val},\39\\{true})$;\5
$\|l\K\\{cur\_ptr}$;\5
$\|e\K\\{true}$;\6
\&{end}\6
\4\&{else} \&{case} $\|p$ \1\&{of}\6
\4\\{int\_val}: \37$\|l\K\\{cur\_val}+\\{count\_base}$;\6
\4\\{dimen\_val}: \37$\|l\K\\{cur\_val}+\\{scaled\_base}$;\6
\4\\{glue\_val}: \37$\|l\K\\{cur\_val}+\\{skip\_base}$;\6
\4\\{mu\_val}: \37$\|l\K\\{cur\_val}+\\{mu\_skip\_base}$;\2\6
\&{end};\C{there are no other cases}\2\6
\&{end};\2\6
\&{end};\6
\4\\{found}: \37\&{if} $\|p<\\{glue\_val}$ \1\&{then}\ \&{if} $\|e$ \1\&{then}\5
$\|w\K\\{sa\_int}(\|l)$\ \&{else} $\|w\K\\{eqtb}[\|l].\\{int}$\2\6
\4\&{else} \&{if} $\|e$ \1\&{then}\5
$\|s\K\\{sa\_ptr}(\|l)$\ \&{else} $\|s\K\\{equiv}(\|l)$\2\2\par
\U1414.\fi

\M1416. \P$\X1416:Compute result of \\{register} or \\{advance}, put it in %
\\{cur\_val}\X\S$\6
\&{if} $\|p<\\{glue\_val}$ \1\&{then}\6
\&{begin} \37\&{if} $\|p=\\{int\_val}$ \1\&{then}\5
\\{scan\_int}\ \&{else} \\{scan\_normal\_dimen};\2\6
\&{if} $\|q=\\{advance}$ \1\&{then}\5
$\\{cur\_val}\K\\{cur\_val}+\|w$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{scan\_glue}(\|p)$;\6
\&{if} $\|q=\\{advance}$ \1\&{then}\5
\X1417:Compute the sum of two glue specs\X;\2\6
\&{end}\2\par
\U1414.\fi

\M1417. \P$\X1417:Compute the sum of two glue specs\X\S$\6
\&{begin} \37$\|q\K\\{new\_spec}(\\{cur\_val})$;\5
$\|r\K\|s$;\5
$\\{delete\_glue\_ref}(\\{cur\_val})$;\5
$\\{width}(\|q)\K\\{width}(\|q)+\\{width}(\|r)$;\6
\&{if} $\\{stretch}(\|q)=0$ \1\&{then}\5
$\\{stretch\_order}(\|q)\K\\{normal}$;\2\6
\&{if} $\\{stretch\_order}(\|q)=\\{stretch\_order}(\|r)$ \1\&{then}\5
$\\{stretch}(\|q)\K\\{stretch}(\|q)+\\{stretch}(\|r)$\6
\4\&{else} \&{if} $(\\{stretch\_order}(\|q)<\\{stretch\_order}(\|r))\W(%
\\{stretch}(\|r)\I0)$ \1\&{then}\6
\&{begin} \37$\\{stretch}(\|q)\K\\{stretch}(\|r)$;\5
$\\{stretch\_order}(\|q)\K\\{stretch\_order}(\|r)$;\6
\&{end};\2\2\6
\&{if} $\\{shrink}(\|q)=0$ \1\&{then}\5
$\\{shrink\_order}(\|q)\K\\{normal}$;\2\6
\&{if} $\\{shrink\_order}(\|q)=\\{shrink\_order}(\|r)$ \1\&{then}\5
$\\{shrink}(\|q)\K\\{shrink}(\|q)+\\{shrink}(\|r)$\6
\4\&{else} \&{if} $(\\{shrink\_order}(\|q)<\\{shrink\_order}(\|r))\W(%
\\{shrink}(\|r)\I0)$ \1\&{then}\6
\&{begin} \37$\\{shrink}(\|q)\K\\{shrink}(\|r)$;\5
$\\{shrink\_order}(\|q)\K\\{shrink\_order}(\|r)$;\6
\&{end};\2\2\6
$\\{cur\_val}\K\|q$;\6
\&{end}\par
\U1416.\fi

\M1418. \P$\X1418:Compute result of \\{multiply} or \\{divide}, put it in %
\\{cur\_val}\X\S$\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\|p<\\{glue\_val}$ \1\&{then}\6
\&{if} $\|q=\\{multiply}$ \1\&{then}\6
\&{if} $\|p=\\{int\_val}$ \1\&{then}\5
$\\{cur\_val}\K\\{mult\_integers}(\|w,\39\\{cur\_val})$\6
\4\&{else} $\\{cur\_val}\K\\{nx\_plus\_y}(\|w,\39\\{cur\_val},\390)$\2\6
\4\&{else} $\\{cur\_val}\K\\{x\_over\_n}(\|w,\39\\{cur\_val})$\2\6
\4\&{else} \&{begin} \37$\|r\K\\{new\_spec}(\|s)$;\6
\&{if} $\|q=\\{multiply}$ \1\&{then}\6
\&{begin} \37$\\{width}(\|r)\K\\{nx\_plus\_y}(\\{width}(\|s),\39\\{cur\_val},%
\390)$;\5
$\\{stretch}(\|r)\K\\{nx\_plus\_y}(\\{stretch}(\|s),\39\\{cur\_val},\390)$;\5
$\\{shrink}(\|r)\K\\{nx\_plus\_y}(\\{shrink}(\|s),\39\\{cur\_val},\390)$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{width}(\|r)\K\\{x\_over\_n}(\\{width}(\|s),\39%
\\{cur\_val})$;\5
$\\{stretch}(\|r)\K\\{x\_over\_n}(\\{stretch}(\|s),\39\\{cur\_val})$;\5
$\\{shrink}(\|r)\K\\{x\_over\_n}(\\{shrink}(\|s),\39\\{cur\_val})$;\6
\&{end};\2\6
$\\{cur\_val}\K\|r$;\6
\&{end};\2\6
\&{end}\par
\U1414.\fi

\M1419. The processing of boxes is somewhat different, because we may need
to scan and create an entire box before we actually change the value of the old
one.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{set\_box}: \37\&{begin} \37\\{scan\_register\_num};\6
\&{if} $\\{global}$ \1\&{then}\5
$\|n\K\\{global\_box\_flag}+\\{cur\_val}$\ \&{else} $\|n\K\\{box\_flag}+\\{cur%
\_val}$;\2\6
\\{scan\_optional\_equals};\6
\&{if} $\\{set\_box\_allowed}$ \1\&{then}\5
$\\{scan\_box}(\|n)$\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Improper\ "})$;\5
$\\{print\_esc}(\.{"setbox"})$;\5
$\\{help2}(\.{"Sorry,\ \\setbox\ is\ not\ allowed\ after\ \\halign\ in\ a\
display,"})$\6
$(\.{"or\ between\ \\accent\ and\ an\ accented\ character."})$;\5
\\{error};\6
\&{end};\2\6
\&{end};\par
\fi

\M1420. The \\{space\_factor} or \\{prev\_depth} settings are changed when a %
\\{set\_aux}
command is sensed. Similarly, \\{prev\_graf} is changed in the presence of
\\{set\_prev\_graf}, and \\{dead\_cycles} or \\{insert\_penalties} in the
presence of
\\{set\_page\_int}. These definitions are always global.

When some dimension of a box register is changed, the change isn't exactly
global; but \TeX\ does not look at the \.{\\global} switch.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{set\_aux}: \37\\{alter\_aux};\6
\4\\{set\_prev\_graf}: \37\\{alter\_prev\_graf};\6
\4\\{set\_page\_dimen}: \37\\{alter\_page\_so\_far};\6
\4\\{set\_page\_int}: \37\\{alter\_integer};\6
\4\\{set\_box\_dimen}: \37\\{alter\_box\_dimen};\par
\fi

\M1421. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{alter\_aux};\6
\4\&{var} \37\|c: \37\\{halfword};\C{\\{hmode} or \\{vmode}}\2\6
\&{begin} \37\&{if} $\\{cur\_chr}\I\\{abs}(\\{mode})$ \1\&{then}\5
\\{report\_illegal\_case}\6
\4\&{else} \&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\6
\&{if} $\|c=\\{vmode}$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{prev\_depth}\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}\L0)\V(\\{cur\_val}>32767)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ space\ factor"})$;\5
$\\{help1}(\.{"I\ allow\ only\ values\ in\ the\ range\ 1..32767\ here."})$;\5
$\\{int\_error}(\\{cur\_val})$;\6
\&{end}\6
\4\&{else} $\\{space\_factor}\K\\{cur\_val}$;\2\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1422. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{alter\_prev\_graf};\6
\4\&{var} \37\|p: \37$0\to\\{nest\_size}$;\C{index into \\{nest}}\2\6
\&{begin} \37$\\{nest}[\\{nest\_ptr}]\K\\{cur\_list}$;\5
$\|p\K\\{nest\_ptr}$;\6
\&{while} $\\{abs}(\\{nest}[\|p].\\{mode\_field})\I\\{vmode}$ \1\&{do}\5
$\\{decr}(\|p)$;\2\6
\\{scan\_optional\_equals};\5
\\{scan\_int};\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ "})$;\5
$\\{print\_esc}(\.{"prevgraf"})$;\5
$\\{help1}(\.{"I\ allow\ only\ nonnegative\ values\ here."})$;\5
$\\{int\_error}(\\{cur\_val})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{nest}[\|p].\\{pg\_field}\K\\{cur\_val}$;\5
$\\{cur\_list}\K\\{nest}[\\{nest\_ptr}]$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1423. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{alter\_page\_so\_far};\6
\4\&{var} \37\|c: \37$0\to7$;\C{index into \\{page\_so\_far}}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_normal\_dimen};\5
$\\{page\_so\_far}[\|c]\K\\{cur\_val}$;\6
\&{end};\par
\fi

\M1424. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{alter\_integer};\6
\4\&{var} \37\|c: \37\\{small\_number};\C{0 for \.{\\deadcycles}, 1 for \.{%
\\insertpenalties}, etc.}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_int};\6
\&{if} $\|c=0$ \1\&{then}\5
$\\{dead\_cycles}\K\\{cur\_val}$\2\6
\X1696:Cases for \\{alter\_integer}\X\6
\4\&{else} \37$\\{insert\_penalties}\K\\{cur\_val}$;\6
\&{end};\par
\fi

\M1425. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{alter\_box\_dimen};\6
\4\&{var} \37\|c: \37\\{small\_number};\C{\\{width\_offset} or \\{height%
\_offset} or \\{depth\_offset}}\6
\|b: \37\\{pointer};\C{box register}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_register\_num};\5
$\\{fetch\_box}(\|b)$;\5
\\{scan\_optional\_equals};\5
\\{scan\_normal\_dimen};\6
\&{if} $\|b\I\\{null}$ \1\&{then}\5
$\\{mem}[\|b+\|c].\\{sc}\K\\{cur\_val}$;\2\6
\&{end};\par
\fi

\M1426. Paragraph shapes are set up in the obvious way.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{set\_shape}: \37\&{begin} \37$\|q\K\\{cur\_chr}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_int};\5
$\|n\K\\{cur\_val}$;\6
\&{if} $\|n\L0$ \1\&{then}\5
$\|p\K\\{null}$\6
\4\&{else} \&{if} $\|q>\\{par\_shape\_loc}$ \1\&{then}\6
\&{begin} \37$\|n\K(\\{cur\_val}\mathbin{\&{div}}2)+1$;\5
$\|p\K\\{get\_node}(2\ast\|n+1)$;\5
$\\{info}(\|p)\K\|n$;\5
$\|n\K\\{cur\_val}$;\5
$\\{mem}[\|p+1].\\{int}\K\|n$;\C{number of penalties}\6
\&{for} $\|j\K\|p+2\mathrel{\&{to}}\|p+\|n+1$ \1\&{do}\6
\&{begin} \37\\{scan\_int};\5
$\\{mem}[\|j].\\{int}\K\\{cur\_val}$;\C{penalty values}\6
\&{end};\2\6
\&{if} $\R\\{odd}(\|n)$ \1\&{then}\5
$\\{mem}[\|p+\|n+2].\\{int}\K0$;\C{unused}\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{get\_node}(2\ast\|n+1)$;\5
$\\{info}(\|p)\K\|n$;\6
\&{for} $\|j\K1\mathrel{\&{to}}\|n$ \1\&{do}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{mem}[\|p+2\ast\|j-1].\\{sc}\K\\{cur\_val}$;\C{indentation}\6
\\{scan\_normal\_dimen};\5
$\\{mem}[\|p+2\ast\|j].\\{sc}\K\\{cur\_val}$;\C{width}\6
\&{end};\2\6
\&{end};\2\2\6
$\\{define}(\|q,\39\\{shape\_ref},\39\|p)$;\6
\&{end};\par
\fi

\M1427. Here's something that isn't quite so obvious. It guarantees that
$\\{info}(\\{par\_shape\_ptr})$ can hold any positive~\|n for which $\\{get%
\_node}(2\ast\|n+1)$
doesn't overflow the memory capacity.

\Y\P$\4\X14:Check the ``constant'' values for consistency\X\mathrel{+}\S$\6
\&{if} $2\ast\\{max\_halfword}<\\{mem\_top}-\\{mem\_min}$ \1\&{then}\5
$\\{bad}\K41$;\2\par
\fi

\M1428. New hyphenation data is loaded by the \\{hyph\_data} command.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"hyphenation"},\39\\{hyph\_data},\390)$;\5
$\\{primitive}(\.{"patterns"},\39\\{hyph\_data},\391)$;\par
\fi

\M1429. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{hyph\_data}: \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"patterns"})$\6
\4\&{else} $\\{print\_esc}(\.{"hyphenation"})$;\2\par
\fi

\M1430. \P$\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{hyph\_data}: \37\&{if} $\\{cur\_chr}=1$ \1\&{then}\6
\&{begin} \37\&{init} \37\\{new\_patterns};\5
\&{goto} \37\\{done};\ \&{tini}\6
$\\{print\_err}(\.{"Patterns\ can\ be\ loaded\ only\ by\ INITEX"})$;\5
\\{help0};\5
\\{error};\6
\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{cur\_cmd}=\\{right\_brace}$;\C{flush the patterns}\2\6
\&{return};\6
\&{end}\6
\4\&{else} \&{begin} \37\\{new\_hyph\_exceptions};\5
\&{goto} \37\\{done};\6
\&{end};\2\par
\fi

\M1431. All of \TeX's parameters are kept in \\{eqtb} except the font
information,
the interaction mode, and the hyphenation tables; these are strictly global.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{assign\_font\_dimen}: \37\&{begin} \37$\\{find\_font\_dimen}(\\{true})$;\5
$\|k\K\\{cur\_val}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_normal\_dimen};\5
$\\{font\_info}[\|k].\\{sc}\K\\{cur\_val}$;\6
\&{end};\6
\4\\{assign\_font\_int}: \37\&{begin} \37$\|n\K\\{cur\_chr}$;\5
\\{scan\_font\_ident};\5
$\|f\K\\{cur\_val}$;\6
\&{if} $\|n=\\{no\_lig\_code}$ \1\&{then}\5
$\\{set\_no\_ligatures}(\|f)$\6
\4\&{else} \&{if} $\|n<\\{lp\_code\_base}$ \1\&{then}\6
\&{begin} \37\\{scan\_optional\_equals};\5
\\{scan\_int};\6
\&{if} $\|n=0$ \1\&{then}\5
$\\{hyphen\_char}[\|f]\K\\{cur\_val}$\ \&{else} $\\{skew\_char}[\|f]\K\\{cur%
\_val}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\\{scan\_char\_num};\5
$\|p\K\\{cur\_val}$;\5
\\{scan\_optional\_equals};\5
\\{scan\_int};\6
\&{case} $\|n$ \1\&{of}\6
\4\\{lp\_code\_base}: \37$\\{set\_lp\_code}(\|f,\39\|p,\39\\{cur\_val})$;\6
\4\\{rp\_code\_base}: \37$\\{set\_rp\_code}(\|f,\39\|p,\39\\{cur\_val})$;\6
\4\\{ef\_code\_base}: \37$\\{set\_ef\_code}(\|f,\39\|p,\39\\{cur\_val})$;\6
\4\\{tag\_code}: \37$\\{set\_tag\_code}(\|f,\39\|p,\39\\{cur\_val})$;\6
\4\\{kn\_bs\_code\_base}: \37$\\{set\_kn\_bs\_code}(\|f,\39\|p,\39\\{cur%
\_val})$;\6
\4\\{st\_bs\_code\_base}: \37$\\{set\_st\_bs\_code}(\|f,\39\|p,\39\\{cur%
\_val})$;\6
\4\\{sh\_bs\_code\_base}: \37$\\{set\_sh\_bs\_code}(\|f,\39\|p,\39\\{cur%
\_val})$;\6
\4\\{kn\_bc\_code\_base}: \37$\\{set\_kn\_bc\_code}(\|f,\39\|p,\39\\{cur%
\_val})$;\6
\4\\{kn\_ac\_code\_base}: \37$\\{set\_kn\_ac\_code}(\|f,\39\|p,\39\\{cur%
\_val})$;\2\6
\&{end};\6
\&{end};\2\2\6
\&{end};\par
\fi

\M1432. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"hyphenchar"},\39\\{assign\_font\_int},\390)$;\5
$\\{primitive}(\.{"skewchar"},\39\\{assign\_font\_int},\391)$;\5
$\\{primitive}(\.{"lpcode"},\39\\{assign\_font\_int},\39\\{lp\_code\_base})$;\5
$\\{primitive}(\.{"rpcode"},\39\\{assign\_font\_int},\39\\{rp\_code\_base})$;\5
$\\{primitive}(\.{"efcode"},\39\\{assign\_font\_int},\39\\{ef\_code\_base})$;\5
$\\{primitive}(\.{"tagcode"},\39\\{assign\_font\_int},\39\\{tag\_code})$;\5
$\\{primitive}(\.{"knbscode"},\39\\{assign\_font\_int},\39\\{kn\_bs\_code%
\_base})$;\5
$\\{primitive}(\.{"stbscode"},\39\\{assign\_font\_int},\39\\{st\_bs\_code%
\_base})$;\5
$\\{primitive}(\.{"shbscode"},\39\\{assign\_font\_int},\39\\{sh\_bs\_code%
\_base})$;\5
$\\{primitive}(\.{"knbccode"},\39\\{assign\_font\_int},\39\\{kn\_bc\_code%
\_base})$;\5
$\\{primitive}(\.{"knaccode"},\39\\{assign\_font\_int},\39\\{kn\_ac\_code%
\_base})$;\5
$\\{primitive}(\.{"pdfnoligatures"},\39\\{assign\_font\_int},\39\\{no\_lig%
\_code})$;\par
\fi

\M1433. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{assign\_font\_int}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\40: \37$\\{print\_esc}(\.{"hyphenchar"})$;\6
\41: \37$\\{print\_esc}(\.{"skewchar"})$;\6
\4\\{lp\_code\_base}: \37$\\{print\_esc}(\.{"lpcode"})$;\6
\4\\{rp\_code\_base}: \37$\\{print\_esc}(\.{"rpcode"})$;\6
\4\\{ef\_code\_base}: \37$\\{print\_esc}(\.{"efcode"})$;\6
\4\\{tag\_code}: \37$\\{print\_esc}(\.{"tagcode"})$;\6
\4\\{kn\_bs\_code\_base}: \37$\\{print\_esc}(\.{"knbscode"})$;\6
\4\\{st\_bs\_code\_base}: \37$\\{print\_esc}(\.{"stbscode"})$;\6
\4\\{sh\_bs\_code\_base}: \37$\\{print\_esc}(\.{"shbscode"})$;\6
\4\\{kn\_bc\_code\_base}: \37$\\{print\_esc}(\.{"knbccode"})$;\6
\4\\{kn\_ac\_code\_base}: \37$\\{print\_esc}(\.{"knaccode"})$;\6
\4\\{no\_lig\_code}: \37$\\{print\_esc}(\.{"pdfnoligatures"})$;\2\6
\&{endcases};\par
\fi

\M1434. Here is where the information for a new font gets loaded.

\Y\P$\4\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{def\_font}: \37$\\{new\_font}(\|a)$;\6
\4\\{letterspace\_font}: \37$\\{new\_letterspaced\_font}(\|a)$;\6
\4\\{pdf\_copy\_font}: \37$\\{make\_font\_copy}(\|a)$;\par
\fi

\M1435. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37$\\{new\_font}(\|a:\\{small\_number})$;\6
\4\&{label} \37\\{common\_ending};\6
\4\&{var} \37\|u: \37\\{pointer};\C{user's font identifier}\6
\|s: \37\\{scaled};\C{stated ``at'' size, or negative of scaled magnification}\6
\|f: \37\\{internal\_font\_number};\C{runs through existing fonts}\6
\|t: \37\\{str\_number};\C{name for the frozen font identifier}\6
\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector} setting}\6
\\{flushable\_string}: \37\\{str\_number};\C{string not yet referenced}\2\6
\&{begin} \37\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\C{avoid confusing \.{texput} with the font name}\2\6
\\{get\_r\_token};\5
$\|u\K\\{cur\_cs}$;\6
\&{if} $\|u\G\\{hash\_base}$ \1\&{then}\5
$\|t\K\\{text}(\|u)$\6
\4\&{else} \&{if} $\|u\G\\{single\_base}$ \1\&{then}\6
\&{if} $\|u=\\{null\_cs}$ \1\&{then}\5
$\|t\K\.{"FONT"}$\ \&{else} $\|t\K\|u-\\{single\_base}$\2\6
\4\&{else} \&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\.{"FONT"})$;\5
$\\{print}(\|u-\\{active\_base})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{str\_room}(1)$;\5
$\|t\K\\{make\_string}$;\6
\&{end};\2\2\6
$\\{define}(\|u,\39\\{set\_font},\39\\{null\_font})$;\5
\\{scan\_optional\_equals};\5
\\{scan\_file\_name};\5
\X1436:Scan the font size specification\X;\6
\X1438:If this font has already been loaded, set \|f to the internal font
number and \&{goto} \\{common\_ending}\X;\6
$\|f\K\\{read\_font\_info}(\|u,\39\\{cur\_name},\39\\{cur\_area},\39\|s)$;\6
\4\\{common\_ending}: \37$\\{define}(\|u,\39\\{set\_font},\39\|f)$;\5
$\\{eqtb}[\\{font\_id\_base}+\|f]\K\\{eqtb}[\|u]$;\5
$\\{font\_id\_text}(\|f)\K\|t$;\6
\&{end};\par
\fi

\M1436. \P$\X1436:Scan the font size specification\X\S$\6
$\\{name\_in\_progress}\K\\{true}$;\C{this keeps \\{cur\_name} from being
changed}\6
\&{if} $\\{scan\_keyword}(\.{"at"})$ \1\&{then}\5
\X1437:Put the \(p)(positive) `at' size into \|s\X\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"scaled"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\|s\K-\\{cur\_val}$;\6
\&{if} $(\\{cur\_val}\L0)\V(\\{cur\_val}>32768)$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Illegal\ magnification\ has\ been\ changed\ to%
\ 1000"})$;\6
$\\{help1}(\.{"The\ magnification\ ratio\ must\ be\ between\ 1\ and\
32768."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\|s\K-1000$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} $\|s\K-1000$;\2\2\6
$\\{name\_in\_progress}\K\\{false}$\par
\U1435.\fi

\M1437. \P$\X1437:Put the \(p)(positive) `at' size into \|s\X\S$\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\|s\K\\{cur\_val}$;\6
\&{if} $(\|s\L0)\V(\|s\G\O{1000000000})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ \`at\'\ size\ ("})$;\5
$\\{print\_scaled}(\|s)$;\5
$\\{print}(\.{"pt),\ replaced\ by\ 10pt"})$;\5
$\\{help2}(\.{"I\ can\ only\ handle\ fonts\ at\ positive\ sizes\ that\ are"})$\6
$(\.{"less\ than\ 2048pt,\ so\ I\'ve\ changed\ what\ you\ said\ to\ 10pt."})$;\5
\\{error};\5
$\|s\K10\ast\\{unity}$;\6
\&{end};\2\6
\&{end}\par
\U1436.\fi

\M1438. When the user gives a new identifier to a font that was previously
loaded,
the new name becomes the font identifier of record. Font names `\.{xyz}' and
`\.{XYZ}' are considered to be different.

\Y\P$\4\X1438:If this font has already been loaded, set \|f to the internal
font number and \&{goto} \\{common\_ending}\X\S$\6
$\\{flushable\_string}\K\\{str\_ptr}-1$;\6
\&{for} $\|f\K\\{font\_base}+1\mathrel{\&{to}}\\{font\_ptr}$ \1\&{do}\6
\&{if} $\\{str\_eq\_str}(\\{font\_name}[\|f],\39\\{cur\_name})\W\\{str\_eq%
\_str}(\\{font\_area}[\|f],\39\\{cur\_area})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_name}=\\{flushable\_string}$ \1\&{then}\6
\&{begin} \37\\{flush\_string};\5
$\\{cur\_name}\K\\{font\_name}[\|f]$;\6
\&{end};\2\6
\&{if} $\|s>0$ \1\&{then}\6
\&{begin} \37\&{if} $\|s=\\{font\_size}[\|f]$ \1\&{then}\5
\&{goto} \37\\{common\_ending};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{font\_size}[\|f]=\\{xn\_over\_d}(\\{font\_dsize}[\|f],%
\39-\|s,\391000)$ \1\&{then}\5
\&{goto} \37\\{common\_ending};\2\2\6
\&{end}\2\2\par
\U1435.\fi

\M1439. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{set\_font}: \37\&{begin} \37$\\{print}(\.{"select\ font\ "})$;\5
$\\{slow\_print}(\\{font\_name}[\\{chr\_code}])$;\6
\&{if} $\\{font\_size}[\\{chr\_code}]\I\\{font\_dsize}[\\{chr\_code}]$ \1%
\&{then}\6
\&{begin} \37$\\{print}(\.{"\ at\ "})$;\5
$\\{print\_scaled}(\\{font\_size}[\\{chr\_code}])$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1440. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"batchmode"},\39\\{set\_interaction},\39\\{batch\_mode})$;\5
$\\{primitive}(\.{"nonstopmode"},\39\\{set\_interaction},\39\\{nonstop%
\_mode})$;\5
$\\{primitive}(\.{"scrollmode"},\39\\{set\_interaction},\39\\{scroll\_mode})$;\5
$\\{primitive}(\.{"errorstopmode"},\39\\{set\_interaction},\39\\{error\_stop%
\_mode})$;\par
\fi

\M1441. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{set\_interaction}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{batch\_mode}: \37$\\{print\_esc}(\.{"batchmode"})$;\6
\4\\{nonstop\_mode}: \37$\\{print\_esc}(\.{"nonstopmode"})$;\6
\4\\{scroll\_mode}: \37$\\{print\_esc}(\.{"scrollmode"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"errorstopmode"})$\2\6
\&{endcases};\par
\fi

\M1442. \P$\X1395:Assignments\X\mathrel{+}\S$\6
\4\\{set\_interaction}: \37\\{new\_interaction};\par
\fi

\M1443. \P$\X1393:Declare subprocedures for \\{prefixed\_command}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{new\_interaction};\2\6
\&{begin} \37\\{print\_ln};\5
$\\{interaction}\K\\{cur\_chr}$;\5
\X75:Initialize the print \\{selector} based on \\{interaction}\X;\6
\&{if} $\\{log\_opened}$ \1\&{then}\5
$\\{selector}\K\\{selector}+2$;\2\6
\&{end};\par
\fi

\M1444. The \.{\\afterassignment} command puts a token into the global
variable \\{after\_token}. This global variable is examined just after
every assignment has been performed.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{after\_token}: \37\\{halfword};\C{zero, or a saved token}\par
\fi

\M1445. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{after\_token}\K0$;\par
\fi

\M1446. \P$\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{after\_assignment})$: \37\&{begin} \37\\{get\_token};\5
$\\{after\_token}\K\\{cur\_tok}$;\6
\&{end};\par
\fi

\M1447. \P$\X1447:Insert a token saved by \.{\\afterassignment}, if any\X\S$\6
\&{if} $\\{after\_token}\I0$ \1\&{then}\6
\&{begin} \37$\\{cur\_tok}\K\\{after\_token}$;\5
\\{back\_input};\5
$\\{after\_token}\K0$;\6
\&{end}\2\par
\U1389.\fi

\M1448. Here is a procedure that might be called `Get the next non-blank
non-relax
non-call non-assignment token'.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{do\_assignments};\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\~ \1\&{loop}\6
\&{begin} \37\X430:Get the next non-blank non-relax non-call token\X;\6
\&{if} $\\{cur\_cmd}\L\\{max\_non\_prefixed\_command}$ \1\&{then}\5
\&{return};\2\6
$\\{set\_box\_allowed}\K\\{false}$;\5
\\{prefixed\_command};\5
$\\{set\_box\_allowed}\K\\{true}$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1449. \P$\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{after\_group})$: \37\&{begin} \37\\{get\_token};\5
$\\{save\_for\_after}(\\{cur\_tok})$;\6
\&{end};\par
\fi

\M1450. Files for \.{\\read} are opened and closed by the \\{in\_stream}
command.

\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"openin"},\39\\{in\_stream},\391)$;\5
$\\{primitive}(\.{"closein"},\39\\{in\_stream},\390)$;\par
\fi

\M1451. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{in\_stream}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"closein"})$\6
\4\&{else} $\\{print\_esc}(\.{"openin"})$;\2\par
\fi

\M1452. \P$\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{in\_stream})$: \37\\{open\_or\_close\_in};\par
\fi

\M1453. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{open\_or\_close\_in};\6
\4\&{var} \37\|c: \37$0\to1$;\C{1 for \.{\\openin}, 0 for \.{\\closein}}\6
\|n: \37$0\to15$;\C{stream number}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_four\_bit\_int};\5
$\|n\K\\{cur\_val}$;\6
\&{if} $\\{read\_open}[\|n]\I\\{closed}$ \1\&{then}\6
\&{begin} \37$\\{a\_close}(\\{read\_file}[\|n])$;\5
$\\{read\_open}[\|n]\K\\{closed}$;\6
\&{end};\2\6
\&{if} $\|c\I0$ \1\&{then}\6
\&{begin} \37\\{scan\_optional\_equals};\5
\\{scan\_file\_name};\6
\&{if} $\\{cur\_ext}=\.{""}$ \1\&{then}\5
$\\{cur\_ext}\K\.{".tex"}$;\2\6
\\{pack\_cur\_name};\6
\&{if} $\\{a\_open\_in}(\\{read\_file}[\|n])$ \1\&{then}\5
$\\{read\_open}[\|n]\K\\{just\_open}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1454. The user can issue messages to the terminal, regardless of the
current mode.

\Y\P$\4\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{message})$: \37\\{issue\_message};\par
\fi

\M1455. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"message"},\39\\{message},\390)$;\5
$\\{primitive}(\.{"errmessage"},\39\\{message},\391)$;\par
\fi

\M1456. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{message}: \37\&{if} $\\{chr\_code}=0$ \1\&{then}\5
$\\{print\_esc}(\.{"message"})$\6
\4\&{else} $\\{print\_esc}(\.{"errmessage"})$;\2\par
\fi

\M1457. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{issue\_message};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector}
setting}\6
\|c: \37$0\to1$;\C{identifies \.{\\message} and \.{\\errmessage}}\6
\|s: \37\\{str\_number};\C{the message}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
$\\{link}(\\{garbage})\K\\{scan\_toks}(\\{false},\39\\{true})$;\5
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{token\_show}(\\{def\_ref})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{flush\_list}(\\{def\_ref})$;\5
$\\{str\_room}(1)$;\5
$\|s\K\\{make\_string}$;\6
\&{if} $\|c=0$ \1\&{then}\5
\X1458:Print string \|s on the terminal\X\6
\4\&{else} \X1461:Print string \|s as an error message\X;\2\6
\\{flush\_string};\6
\&{end};\par
\fi

\M1458. \P$\X1458:Print string \|s on the terminal\X\S$\6
\&{begin} \37\&{if} $\\{term\_offset}+\\{length}(\|s)>\\{max\_print\_line}-2$ %
\1\&{then}\5
\\{print\_ln}\6
\4\&{else} \&{if} $(\\{term\_offset}>0)\V(\\{file\_offset}>0)$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\2\6
$\\{slow\_print}(\|s)$;\5
\\{update\_terminal};\6
\&{end}\par
\U1457.\fi

\M1459. If \.{\\errmessage} occurs often in \\{scroll\_mode}, without
user-defined
\.{\\errhelp}, we don't want to give a long help message each time. So we
give a verbose explanation only once.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{long\_help\_seen}: \37\\{boolean};\C{has the long \.{\\errmessage} help
been used?}\par
\fi

\M1460. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{long\_help\_seen}\K\\{false}$;\par
\fi

\M1461. \P$\X1461:Print string \|s as an error message\X\S$\6
\&{begin} \37$\\{print\_err}(\.{""})$;\5
$\\{slow\_print}(\|s)$;\6
\&{if} $\\{err\_help}\I\\{null}$ \1\&{then}\5
$\\{use\_err\_help}\K\\{true}$\6
\4\&{else} \&{if} $\\{long\_help\_seen}$ \1\&{then}\5
$\\{help1}(\.{"(That\ was\ another\ \\errmessage.)"})$\6
\4\&{else} \&{begin} \37\&{if} $\\{interaction}<\\{error\_stop\_mode}$ \1%
\&{then}\5
$\\{long\_help\_seen}\K\\{true}$;\2\6
$\\{help4}(\.{"This\ error\ message\ was\ generated\ by\ an\ \\errmessage"})$\6
$(\.{"command,\ so\ I\ can\'t\ give\ any\ explicit\ help."})$\6
$(\.{"Pretend\ that\ you\'re\ Hercule\ Poirot:\ Examine\ all\ clues,"})$\6
$(\.{"and\ deduce\ the\ truth\ by\ order\ and\ method."})$;\6
\&{end};\2\2\6
\\{error};\5
$\\{use\_err\_help}\K\\{false}$;\6
\&{end}\par
\U1457.\fi

\M1462. The \\{error} routine calls on \\{give\_err\_help} if help is requested
from
the \\{err\_help} parameter.

\Y\P\4\&{procedure}\1\  \37\\{give\_err\_help};\2\6
\&{begin} \37$\\{token\_show}(\\{err\_help})$;\6
\&{end};\par
\fi

\M1463. The \.{\\uppercase} and \.{\\lowercase} commands are implemented by
building a token list and then changing the cases of the letters in it.

\Y\P$\4\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{case\_shift})$: \37\\{shift\_case};\par
\fi

\M1464. \P$\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}%
\S$\6
$\\{primitive}(\.{"lowercase"},\39\\{case\_shift},\39\\{lc\_code\_base})$;\5
$\\{primitive}(\.{"uppercase"},\39\\{case\_shift},\39\\{uc\_code\_base})$;\par
\fi

\M1465. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{case\_shift}: \37\&{if} $\\{chr\_code}=\\{lc\_code\_base}$ \1\&{then}\5
$\\{print\_esc}(\.{"lowercase"})$\6
\4\&{else} $\\{print\_esc}(\.{"uppercase"})$;\2\par
\fi

\M1466. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{shift\_case};\6
\4\&{var} \37\|b: \37\\{pointer};\C{\\{lc\_code\_base} or \\{uc\_code\_base}}\6
\|p: \37\\{pointer};\C{runs through the token list}\6
\|t: \37\\{halfword};\C{token}\6
\|c: \37\\{eight\_bits};\C{character code}\2\6
\&{begin} \37$\|b\K\\{cur\_chr}$;\5
$\|p\K\\{scan\_toks}(\\{false},\39\\{false})$;\5
$\|p\K\\{link}(\\{def\_ref})$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\X1467:Change the case of the token in \|p, if a change is
appropriate\X;\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{back\_list}(\\{link}(\\{def\_ref}))$;\5
$\\{free\_avail}(\\{def\_ref})$;\C{omit reference count}\6
\&{end};\par
\fi

\M1467. When the case of a \\{chr\_code} changes, we don't change the \\{cmd}.
We also change active characters, using the fact that
$\\{cs\_token\_flag}+\\{active\_base}$ is a multiple of~256.

\Y\P$\4\X1467:Change the case of the token in \|p, if a change is appropriate\X%
\S$\6
$\|t\K\\{info}(\|p)$;\6
\&{if} $\|t<\\{cs\_token\_flag}+\\{single\_base}$ \1\&{then}\6
\&{begin} \37$\|c\K\|t\mathbin{\&{mod}}256$;\6
\&{if} $\\{equiv}(\|b+\|c)\I0$ \1\&{then}\5
$\\{info}(\|p)\K\|t-\|c+\\{equiv}(\|b+\|c)$;\2\6
\&{end}\2\par
\U1466.\fi

\M1468. We come finally to the last pieces missing from \\{main\_control},
namely the
`\.{\\show}' commands that are useful when debugging.

\Y\P$\4\X1388:Cases of \\{main\_control} that don't depend on \\{mode}\X%
\mathrel{+}\S$\6
\4$\\{any\_mode}(\\{xray})$: \37\\{show\_whatever};\par
\fi

\M1469. \P\D \37$\\{show\_code}=0$\C{ \.{\\show} }\par
\P\D \37$\\{show\_box\_code}=1$\C{ \.{\\showbox} }\par
\P\D \37$\\{show\_the\_code}=2$\C{ \.{\\showthe} }\par
\P\D \37$\\{show\_lists\_code}=3$\C{ \.{\\showlists} }\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"show"},\39\\{xray},\39\\{show\_code})$;\5
$\\{primitive}(\.{"showbox"},\39\\{xray},\39\\{show\_box\_code})$;\5
$\\{primitive}(\.{"showthe"},\39\\{xray},\39\\{show\_the\_code})$;\5
$\\{primitive}(\.{"showlists"},\39\\{xray},\39\\{show\_lists\_code})$;\par
\fi

\M1470. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{xray}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{show\_box\_code}: \37$\\{print\_esc}(\.{"showbox"})$;\6
\4\\{show\_the\_code}: \37$\\{print\_esc}(\.{"showthe"})$;\6
\4\\{show\_lists\_code}: \37$\\{print\_esc}(\.{"showlists"})$;\6
\X1676:Cases of \\{xray} for \\{print\_cmd\_chr}\X\6
\4\&{othercases} \37$\\{print\_esc}(\.{"show"})$\2\6
\&{endcases};\par
\fi

\M1471. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{show\_whatever};\6
\4\&{label} \37\\{common\_ending};\6
\4\&{var} \37\|p: \37\\{pointer};\C{tail of a token list to show}\6
\|t: \37\\{small\_number};\C{type of conditional being shown}\6
\|m: \37$\\{normal}\to\\{or\_code}$;\C{upper bound on \\{fi\_or\_else} codes}\6
\|l: \37\\{integer};\C{line where that conditional began}\6
\|n: \37\\{integer};\C{level of \.{\\if...\\fi} nesting}\2\6
\&{begin} \37\&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{show\_lists\_code}: \37\&{begin} \37\\{begin\_diagnostic};\5
\\{show\_activities};\6
\&{end};\6
\4\\{show\_box\_code}: \37\X1474:Show the current contents of a box\X;\6
\4\\{show\_code}: \37\X1472:Show the current meaning of a token, then \&{goto} %
\\{common\_ending}\X;\6
\X1677:Cases for \\{show\_whatever}\X\6
\4\&{othercases} \37\X1475:Show the current value of some parameter or
register, then \&{goto} \\{common\_ending}\X\2\6
\&{endcases};\6
\X1476:Complete a potentially long \.{\\show} command\X;\6
\4\\{common\_ending}: \37\&{if} $\\{interaction}<\\{error\_stop\_mode}$ \1%
\&{then}\6
\&{begin} \37\\{help0};\5
$\\{decr}(\\{error\_count})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{tracing\_online}>0$ \1\&{then}\6
\&{begin} \37\hbox{}\6
$\\{help3}(\.{"This\ isn\'t\ an\ error\ message;\ I\'m\ just\ \\showing\
something."})$\6
$(\.{"Type\ \`I\\show...\'\ to\ show\ more\ (e.g.,\ \\show\\cs,"})$\6
$(\.{"\\showthe\\count10,\ \\showbox255,\ \\showlists)."})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\hbox{}\6
$\\{help5}(\.{"This\ isn\'t\ an\ error\ message;\ I\'m\ just\ \\showing\
something."})$\6
$(\.{"Type\ \`I\\show...\'\ to\ show\ more\ (e.g.,\ \\show\\cs,"})$\6
$(\.{"\\showthe\\count10,\ \\showbox255,\ \\showlists)."})$\6
$(\.{"And\ type\ \`I\\tracingonline=1\\show...\'\ to\ show\ boxes\ and"})$\6
$(\.{"lists\ on\ your\ terminal\ as\ well\ as\ in\ the\ transcript\ file."})$;\6
\&{end};\2\2\6
\\{error};\6
\&{end};\par
\fi

\M1472. \P$\X1472:Show the current meaning of a token, then \&{goto} \\{common%
\_ending}\X\S$\6
\&{begin} \37\\{get\_token};\6
\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
\\{wake\_up\_terminal};\2\6
$\\{print\_nl}(\.{">\ "})$;\6
\&{if} $\\{cur\_cs}\I0$ \1\&{then}\6
\&{begin} \37$\\{sprint\_cs}(\\{cur\_cs})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{end};\2\6
\\{print\_meaning};\5
\&{goto} \37\\{common\_ending};\6
\&{end}\par
\U1471.\fi

\M1473. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{undefined\_cs}: \37$\\{print}(\.{"undefined"})$;\6
\4$\\{call},\39\\{long\_call},\39\\{outer\_call},\39\\{long\_outer\_call}$: \37%
\&{begin} \37$\|n\K\\{cmd}-\\{call}$;\6
\&{if} $\\{info}(\\{link}(\\{chr\_code}))=\\{protected\_token}$ \1\&{then}\5
$\|n\K\|n+4$;\2\6
\&{if} $\\{odd}(\|n\mathbin{\&{div}}4)$ \1\&{then}\5
$\\{print\_esc}(\.{"protected"})$;\2\6
\&{if} $\\{odd}(\|n)$ \1\&{then}\5
$\\{print\_esc}(\.{"long"})$;\2\6
\&{if} $\\{odd}(\|n\mathbin{\&{div}}2)$ \1\&{then}\5
$\\{print\_esc}(\.{"outer"})$;\2\6
\&{if} $\|n>0$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\6
$\\{print}(\.{"macro"})$;\6
\&{end};\6
\4\\{end\_template}: \37$\\{print\_esc}(\.{"outer\ endtemplate"})$;\par
\fi

\M1474. \P$\X1474:Show the current contents of a box\X\S$\6
\&{begin} \37\\{scan\_register\_num};\5
$\\{fetch\_box}(\|p)$;\5
\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{">\ \\box"})$;\5
$\\{print\_int}(\\{cur\_val})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{print}(\.{"void"})$\ \&{else} $\\{show\_box}(\|p)$;\2\6
\&{end}\par
\U1471.\fi

\M1475. \P$\X1475:Show the current value of some parameter or register, then %
\&{goto} \\{common\_ending}\X\S$\6
\&{begin} \37$\|p\K\\{the\_toks}$;\6
\&{if} $\\{interaction}=\\{error\_stop\_mode}$ \1\&{then}\5
\\{wake\_up\_terminal};\2\6
$\\{print\_nl}(\.{">\ "})$;\5
$\\{token\_show}(\\{temp\_head})$;\5
$\\{flush\_list}(\\{link}(\\{temp\_head}))$;\5
\&{goto} \37\\{common\_ending};\6
\&{end}\par
\U1471.\fi

\M1476. \P$\X1476:Complete a potentially long \.{\\show} command\X\S$\6
$\\{end\_diagnostic}(\\{true})$;\5
$\\{print\_err}(\.{"OK"})$;\6
\&{if} $\\{selector}=\\{term\_and\_log}$ \1\&{then}\6
\&{if} $\\{tracing\_online}\L0$ \1\&{then}\6
\&{begin} \37$\\{selector}\K\\{term\_only}$;\5
$\\{print}(\.{"\ (see\ the\ transcript\ file)"})$;\5
$\\{selector}\K\\{term\_and\_log}$;\6
\&{end}\2\2\par
\U1471.\fi

\N1477.  \[50] Dumping and undumping the tables.
After \.{INITEX} has seen a collection of fonts and macros, it
can write all the necessary information on an auxiliary file so
that production versions of \TeX\ are able to initialize their
memory at high speed. The present section of the program takes
care of such output and input. We shall consider simultaneously
the processes of storing and restoring,
so that the inverse relation between them is clear.

The global variable \\{format\_ident} is a string that is printed right
after the \\{banner} line when \TeX\ is ready to start. For \.{INITEX} this
string says simply `\.{ (INITEX)}'; for other versions of \TeX\ it says,
for example, `\.{ (preloaded format=plain 1982.11.19)}', showing the year,
month, and day that the format file was created. We have $\\{format\_ident}=0$
before \TeX's tables are loaded.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{format\_ident}: \37\\{str\_number};\par
\fi

\M1478. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{format\_ident}\K0$;\par
\fi

\M1479. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X%
\mathrel{+}\S$\6
$\\{format\_ident}\K\.{"\ (INITEX)"}$;\par
\fi

\M1480. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\&{init} \37\&{procedure}\1\  \37\\{store\_fmt\_file};\6
\4\&{label} \37$\\{found1},\39\\{found2},\39\\{done1},\39\\{done2}$;\6
\4\&{var} \37$\|j,\39\|k,\39\|l$: \37\\{integer};\C{all-purpose indices}\6
$\|p,\39\|q$: \37\\{pointer};\C{all-purpose pointers}\6
\|x: \37\\{integer};\C{something to dump}\6
\|w: \37\\{four\_quarters};\C{four ASCII codes}\2\6
\&{begin} \37\X1482:If dumping is not allowed, abort\X;\6
\X1508:Create the \\{format\_ident}, open the format file, and inform the user
that dumping has begun\X;\6
\X1485:Dump constants for consistency check\X;\6
\X1487:Dump the string pool\X;\6
\X1489:Dump the dynamic memory\X;\6
\X1491:Dump the table of equivalents\X;\6
\X1498:Dump the font information\X;\6
\X1502:Dump the hyphenation tables\X;\6
\X1504:Dump pdftex data\X;\6
\X1506:Dump a couple more things and the closing check word\X;\6
\X1509:Close the format file\X;\6
\&{end};\6
\&{tini}\par
\fi

\M1481. Corresponding to the procedure that dumps a format file, we have a
function
that reads one in. The function returns \\{false} if the dumped format is
incompatible with the present \TeX\ table sizes, etc.

\Y\P\D \37$\\{bad\_fmt}=6666$\C{go here if the format file is unacceptable}\par
\P\D \37$\\{too\_small}(\#)\S$\1\6
\&{begin} \37\\{wake\_up\_terminal};\5
$\\{wterm\_ln}(\.{\'---!\ Must\ increase\ the\ \'},\39\#)$;\5
\&{goto} \37\\{bad\_fmt};\6
\&{end}\2\par
\Y\P\hbox{\4}\X550:Declare the function called \\{open\_fmt\_file}\X\6
\4\&{function}\1\  \37\\{load\_fmt\_file}: \37\\{boolean};\6
\4\&{label} \37$\\{bad\_fmt},\39\\{exit}$;\6
\4\&{var} \37$\|j,\39\|k$: \37\\{integer};\C{all-purpose indices}\6
$\|p,\39\|q$: \37\\{pointer};\C{all-purpose pointers}\6
\|x: \37\\{integer};\C{something undumped}\6
\|w: \37\\{four\_quarters};\C{four ASCII codes}\2\6
\&{begin} \37\X1486:Undump constants for consistency check\X;\6
\X1488:Undump the string pool\X;\6
\X1490:Undump the dynamic memory\X;\6
\X1492:Undump the table of equivalents\X;\6
\X1499:Undump the font information\X;\6
\X1503:Undump the hyphenation tables\X;\6
\X1505:Undump pdftex data\X;\6
\X1507:Undump a couple more things and the closing check word\X;\6
$\\{prev\_depth}\K\\{pdf\_ignored\_dimen}$;\5
$\\{load\_fmt\_file}\K\\{true}$;\5
\&{return};\C{it worked!}\6
\4\\{bad\_fmt}: \37\\{wake\_up\_terminal};\5
$\\{wterm\_ln}(\.{\'(Fatal\ format\ file\ error;\ I\'}\.{\'m\ stymied)\'})$;\5
$\\{load\_fmt\_file}\K\\{false}$;\6
\4\\{exit}: \37\&{end};\par
\fi

\M1482. The user is not allowed to dump a format file unless $\\{save\_ptr}=0$.
This condition implies that $\\{cur\_level}=\\{level\_one}$, hence
the \\{xeq\_level} array is constant and it need not be dumped.

\Y\P$\4\X1482:If dumping is not allowed, abort\X\S$\6
\&{if} $\\{save\_ptr}\I0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"You\ can\'t\ dump\ inside\ a\ group"})$;\5
$\\{help1}(\.{"\`\{...\\dump\}\'\ is\ a\ no-no."})$;\5
\\{succumb};\6
\&{end}\2\par
\U1480.\fi

\M1483. Format files consist of \\{memory\_word} items, and we use the
following
macros to dump words of different types:

\Y\P\D \37$\\{dump\_wd}(\#)\S$\1\6
\&{begin} \37$\\{fmt\_file}\^\K\#$;\5
$\\{put}(\\{fmt\_file})$;\ \&{end}\2\par
\P\D \37$\\{dump\_int}(\#)\S$\1\6
\&{begin} \37$\\{fmt\_file}\^.\\{int}\K\#$;\5
$\\{put}(\\{fmt\_file})$;\ \&{end}\2\par
\P\D \37$\\{dump\_hh}(\#)\S$\1\6
\&{begin} \37$\\{fmt\_file}\^.\\{hh}\K\#$;\5
$\\{put}(\\{fmt\_file})$;\ \&{end}\2\par
\P\D \37$\\{dump\_qqqq}(\#)\S$\1\6
\&{begin} \37$\\{fmt\_file}\^.\\{qqqq}\K\#$;\5
$\\{put}(\\{fmt\_file})$;\ \&{end}\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{fmt\_file}: \37\\{word\_file};\C{for input or output of format
information}\par
\fi

\M1484. The inverse macros are slightly more complicated, since we need to
check
the range of the values we are reading in. We say `$\\{undump}(\|a)(\|b)(\|x)$'
to
read an integer value \|x that is supposed to be in the range $\|a\L\|x\L\|b$.
System error messages should be suppressed when undumping.

\Y\P\D \37$\\{undump\_wd}(\#)\S$\1\6
\&{begin} \37$\\{get}(\\{fmt\_file})$;\5
$\#\K\\{fmt\_file}\^$;\ \&{end}\2\par
\P\D \37$\\{undump\_int}(\#)\S$\1\6
\&{begin} \37$\\{get}(\\{fmt\_file})$;\5
$\#\K\\{fmt\_file}\^.\\{int}$;\ \&{end}\2\par
\P\D \37$\\{undump\_hh}(\#)\S$\1\6
\&{begin} \37$\\{get}(\\{fmt\_file})$;\5
$\#\K\\{fmt\_file}\^.\\{hh}$;\ \&{end}\2\par
\P\D \37$\\{undump\_qqqq}(\#)\S$\1\6
\&{begin} \37$\\{get}(\\{fmt\_file})$;\5
$\#\K\\{fmt\_file}\^.\\{qqqq}$;\ \&{end}\2\par
\P\D \37$\\{undump\_end\_end}(\#)\S\#\K\|x$;\ \&{end} \par
\P\D $\\{undump\_end}(\#)\S(\|x>\#)$ \&{then} \&{goto} \37\\{bad\_fmt}\ %
\&{else} \37\\{undump\_end\_end}\par
\P\D $\\{undump}(\#)\S$ \6
\&{begin} \37$\\{undump\_int}(\|x)$;  \6
\&{if} $(\|x<\#)\V\\{undump\_end}$\par
\P\D \37$\\{undump\_size\_end\_end}(\#)\S\\{too\_small}(\#)$\ \&{else} \37%
\\{undump\_end\_end}\par
\P\D \37$\\{undump\_size\_end}(\#)\S$\1\6
\&{if} $\|x>\#$ \1\&{then}\5
\\{undump\_size\_end\_end}\2\2\par
\P\D $\\{undump\_size}(\#)\S$ \6
\&{begin} \37$\\{undump\_int}(\|x)$;\6
\&{if} $\|x<\#$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
\\{undump\_size\_end}\par
\fi

\M1485. The next few sections of the program should make it clear how we use
the
dump/undump macros.

\Y\P$\4\X1485:Dump constants for consistency check\X\S$\6
$\\{dump\_int}(\))$;\6
\X1654:Dump the \eTeX\ state\X\6
$\\{dump\_int}(\\{mem\_bot})$;\6
$\\{dump\_int}(\\{mem\_top})$;\6
$\\{dump\_int}(\\{eqtb\_size})$;\6
$\\{dump\_int}(\\{hash\_prime})$;\6
$\\{dump\_int}(\\{hyph\_size})$\par
\U1480.\fi

\M1486. Sections of a \.{WEB} program that are ``commented out'' still
contribute
strings to the string pool; therefore \.{INITEX} and \TeX\ will have
the same strings. (And it is, of course, a good thing that they do.)

\Y\P$\4\X1486:Undump constants for consistency check\X\S$\6
$\|x\K\\{fmt\_file}\^.\\{int}$;\6
\&{if} $\|x\I\)$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\C{check that strings are the same}\2\6
\X1655:Undump the \eTeX\ state\X\6
$\\{undump\_int}(\|x)$;\6
\&{if} $\|x\I\\{mem\_bot}$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
$\\{undump\_int}(\|x)$;\6
\&{if} $\|x\I\\{mem\_top}$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
$\\{undump\_int}(\|x)$;\6
\&{if} $\|x\I\\{eqtb\_size}$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
$\\{undump\_int}(\|x)$;\6
\&{if} $\|x\I\\{hash\_prime}$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
$\\{undump\_int}(\|x)$;\6
\&{if} $\|x\I\\{hyph\_size}$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt}\2\par
\U1481.\fi

\M1487. \P\D \37$\\{dump\_four\_ASCII}\S\|w.\\{b0}\K\\{qi}(\\{so}(\\{str%
\_pool}[\|k]))$;\5
$\|w.\\{b1}\K\\{qi}(\\{so}(\\{str\_pool}[\|k+1]))$;\5
$\|w.\\{b2}\K\\{qi}(\\{so}(\\{str\_pool}[\|k+2]))$;\5
$\|w.\\{b3}\K\\{qi}(\\{so}(\\{str\_pool}[\|k+3]))$;\5
$\\{dump\_qqqq}(\|w)$\par
\Y\P$\4\X1487:Dump the string pool\X\S$\6
$\\{dump\_int}(\\{pool\_ptr})$;\5
$\\{dump\_int}(\\{str\_ptr})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{str\_ptr}$ \1\&{do}\5
$\\{dump\_int}(\\{str\_start}[\|k])$;\2\6
$\|k\K0$;\6
\&{while} $\|k+4<\\{pool\_ptr}$ \1\&{do}\6
\&{begin} \37\\{dump\_four\_ASCII};\5
$\|k\K\|k+4$;\6
\&{end};\2\6
$\|k\K\\{pool\_ptr}-4$;\5
\\{dump\_four\_ASCII};\5
\\{print\_ln};\5
$\\{print\_int}(\\{str\_ptr})$;\5
$\\{print}(\.{"\ strings\ of\ total\ length\ "})$;\5
$\\{print\_int}(\\{pool\_ptr})$\par
\U1480.\fi

\M1488. \P\D \37$\\{undump\_four\_ASCII}\S\\{undump\_qqqq}(\|w)$;\5
$\\{str\_pool}[\|k]\K\\{si}(\\{qo}(\|w.\\{b0}))$;\5
$\\{str\_pool}[\|k+1]\K\\{si}(\\{qo}(\|w.\\{b1}))$;\5
$\\{str\_pool}[\|k+2]\K\\{si}(\\{qo}(\|w.\\{b2}))$;\5
$\\{str\_pool}[\|k+3]\K\\{si}(\\{qo}(\|w.\\{b3}))$\par
\Y\P$\4\X1488:Undump the string pool\X\S$\6
$\\{undump\_size}(0)(\\{pool\_size})(\.{\'string\ pool\ size\'})(\\{pool%
\_ptr})$;\5
$\\{undump\_size}(0)(\\{max\_strings})(\.{\'max\ strings\'})(\\{str\_ptr})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{str\_ptr}$ \1\&{do}\5
$\\{undump}(0)(\\{pool\_ptr})(\\{str\_start}[\|k])$;\2\6
$\|k\K0$;\6
\&{while} $\|k+4<\\{pool\_ptr}$ \1\&{do}\6
\&{begin} \37\\{undump\_four\_ASCII};\5
$\|k\K\|k+4$;\6
\&{end};\2\6
$\|k\K\\{pool\_ptr}-4$;\5
\\{undump\_four\_ASCII};\5
$\\{init\_str\_ptr}\K\\{str\_ptr}$;\5
$\\{init\_pool\_ptr}\K\\{pool\_ptr}$\par
\U1481.\fi

\M1489. By sorting the list of available spaces in the variable-size portion of
\\{mem}, we are usually able to get by without having to dump very much
of the dynamic memory.

We recompute \\{var\_used} and \\{dyn\_used}, so that \.{INITEX} dumps valid
information even when it has not been gathering statistics.

\Y\P$\4\X1489:Dump the dynamic memory\X\S$\6
\\{sort\_avail};\5
$\\{var\_used}\K0$;\5
$\\{dump\_int}(\\{lo\_mem\_max})$;\5
$\\{dump\_int}(\\{rover})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{for} $\|k\K\\{int\_val}\mathrel{\&{to}}\\{tok\_val}$ \1\&{do}\5
$\\{dump\_int}(\\{sa\_root}[\|k])$;\2\2\6
$\|p\K\\{mem\_bot}$;\5
$\|q\K\\{rover}$;\5
$\|x\K0$;\6
\1\&{repeat} \37\&{for} $\|k\K\|p\mathrel{\&{to}}\|q+1$ \1\&{do}\5
$\\{dump\_wd}(\\{mem}[\|k])$;\2\6
$\|x\K\|x+\|q+2-\|p$;\5
$\\{var\_used}\K\\{var\_used}+\|q-\|p$;\5
$\|p\K\|q+\\{node\_size}(\|q)$;\5
$\|q\K\\{rlink}(\|q)$;\6
\4\&{until}\5
$\|q=\\{rover}$;\2\6
$\\{var\_used}\K\\{var\_used}+\\{lo\_mem\_max}-\|p$;\5
$\\{dyn\_used}\K\\{mem\_end}+1-\\{hi\_mem\_min}$;\6
\&{for} $\|k\K\|p\mathrel{\&{to}}\\{lo\_mem\_max}$ \1\&{do}\5
$\\{dump\_wd}(\\{mem}[\|k])$;\2\6
$\|x\K\|x+\\{lo\_mem\_max}+1-\|p$;\5
$\\{dump\_int}(\\{hi\_mem\_min})$;\5
$\\{dump\_int}(\\{avail})$;\6
\&{for} $\|k\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\5
$\\{dump\_wd}(\\{mem}[\|k])$;\2\6
$\|x\K\|x+\\{mem\_end}+1-\\{hi\_mem\_min}$;\5
$\|p\K\\{avail}$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{dyn\_used})$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{dump\_int}(\\{var\_used})$;\5
$\\{dump\_int}(\\{dyn\_used})$;\5
\\{print\_ln};\5
$\\{print\_int}(\|x)$;\5
$\\{print}(\.{"\ memory\ locations\ dumped;\ current\ usage\ is\ "})$;\5
$\\{print\_int}(\\{var\_used})$;\5
$\\{print\_char}(\.{"\&"})$;\5
$\\{print\_int}(\\{dyn\_used})$\par
\U1480.\fi

\M1490. \P$\X1490:Undump the dynamic memory\X\S$\6
$\\{undump}(\\{lo\_mem\_stat\_max}+1000)(\\{hi\_mem\_stat\_min}-1)(\\{lo\_mem%
\_max})$;\5
$\\{undump}(\\{lo\_mem\_stat\_max}+1)(\\{lo\_mem\_max})(\\{rover})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{for} $\|k\K\\{int\_val}\mathrel{\&{to}}\\{tok\_val}$ \1\&{do}\5
$\\{undump}(\\{null})(\\{lo\_mem\_max})(\\{sa\_root}[\|k])$;\2\2\6
$\|p\K\\{mem\_bot}$;\5
$\|q\K\\{rover}$;\6
\1\&{repeat} \37\&{for} $\|k\K\|p\mathrel{\&{to}}\|q+1$ \1\&{do}\5
$\\{undump\_wd}(\\{mem}[\|k])$;\2\6
$\|p\K\|q+\\{node\_size}(\|q)$;\6
\&{if} $(\|p>\\{lo\_mem\_max})\V((\|q\G\\{rlink}(\|q))\W(\\{rlink}(\|q)\I%
\\{rover}))$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
$\|q\K\\{rlink}(\|q)$;\6
\4\&{until}\5
$\|q=\\{rover}$;\2\6
\&{for} $\|k\K\|p\mathrel{\&{to}}\\{lo\_mem\_max}$ \1\&{do}\5
$\\{undump\_wd}(\\{mem}[\|k])$;\2\6
\&{if} $\\{mem\_min}<\\{mem\_bot}-2$ \1\&{then}\C{make more low memory
available}\6
\&{begin} \37$\|p\K\\{llink}(\\{rover})$;\5
$\|q\K\\{mem\_min}+1$;\5
$\\{link}(\\{mem\_min})\K\\{null}$;\5
$\\{info}(\\{mem\_min})\K\\{null}$;\C{we don't use the bottom word}\6
$\\{rlink}(\|p)\K\|q$;\5
$\\{llink}(\\{rover})\K\|q$;\6
$\\{rlink}(\|q)\K\\{rover}$;\5
$\\{llink}(\|q)\K\|p$;\5
$\\{link}(\|q)\K\\{empty\_flag}$;\5
$\\{node\_size}(\|q)\K\\{mem\_bot}-\|q$;\6
\&{end};\2\6
$\\{undump}(\\{lo\_mem\_max}+1)(\\{hi\_mem\_stat\_min})(\\{hi\_mem\_min})$;\5
$\\{undump}(\\{null})(\\{mem\_top})(\\{avail})$;\5
$\\{mem\_end}\K\\{mem\_top}$;\6
\&{for} $\|k\K\\{hi\_mem\_min}\mathrel{\&{to}}\\{mem\_end}$ \1\&{do}\5
$\\{undump\_wd}(\\{mem}[\|k])$;\2\6
$\\{undump\_int}(\\{var\_used})$;\5
$\\{undump\_int}(\\{dyn\_used})$\par
\U1481.\fi

\M1491. \P$\X1491:Dump the table of equivalents\X\S$\6
\X1493:Dump regions 1 to 4 of \\{eqtb}\X;\6
\X1494:Dump regions 5 and 6 of \\{eqtb}\X;\6
$\\{dump\_int}(\\{par\_loc})$;\5
$\\{dump\_int}(\\{write\_loc})$;\6
\X1496:Dump the hash table\X\par
\U1480.\fi

\M1492. \P$\X1492:Undump the table of equivalents\X\S$\6
\X1495:Undump regions 1 to 6 of \\{eqtb}\X;\6
$\\{undump}(\\{hash\_base})(\\{frozen\_control\_sequence})(\\{par\_loc})$;\5
$\\{par\_token}\K\\{cs\_token\_flag}+\\{par\_loc}$;\6
$\\{undump}(\\{hash\_base})(\\{frozen\_control\_sequence})(\\{write\_loc})$;\6
\X1497:Undump the hash table\X\par
\U1481.\fi

\M1493. The table of equivalents usually contains repeated information, so we
dump it
in compressed form: The sequence of $n+2$ values $(n,x_1,\ldots,x_n,m)$ in the
format file represents $n+m$ consecutive entries of \\{eqtb}, with \|m extra
copies of $x_n$, namely $(x_1,\ldots,x_n,x_n,\ldots,x_n)$.

\Y\P$\4\X1493:Dump regions 1 to 4 of \\{eqtb}\X\S$\6
$\|k\K\\{active\_base}$;\6
\1\&{repeat} \37$\|j\K\|k$;\6
\&{while} $\|j<\\{int\_base}-1$ \1\&{do}\6
\&{begin} \37\&{if} $(\\{equiv}(\|j)=\\{equiv}(\|j+1))\W(\\{eq\_type}(\|j)=%
\\{eq\_type}(\|j+1))\W\30(\\{eq\_level}(\|j)=\\{eq\_level}(\|j+1))$ \1\&{then}\5
\&{goto} \37\\{found1};\2\6
$\\{incr}(\|j)$;\6
\&{end};\2\6
$\|l\K\\{int\_base}$;\5
\&{goto} \37\\{done1};\C{$\|j=\\{int\_base}-1$}\6
\4\\{found1}: \37$\\{incr}(\|j)$;\5
$\|l\K\|j$;\6
\&{while} $\|j<\\{int\_base}-1$ \1\&{do}\6
\&{begin} \37\&{if} $(\\{equiv}(\|j)\I\\{equiv}(\|j+1))\V(\\{eq\_type}(\|j)\I%
\\{eq\_type}(\|j+1))\V\30(\\{eq\_level}(\|j)\I\\{eq\_level}(\|j+1))$ \1\&{then}%
\5
\&{goto} \37\\{done1};\2\6
$\\{incr}(\|j)$;\6
\&{end};\2\6
\4\\{done1}: \37$\\{dump\_int}(\|l-\|k)$;\6
\&{while} $\|k<\|l$ \1\&{do}\6
\&{begin} \37$\\{dump\_wd}(\\{eqtb}[\|k])$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\|k\K\|j+1$;\5
$\\{dump\_int}(\|k-\|l)$;\6
\4\&{until}\5
$\|k=\\{int\_base}$\2\par
\U1491.\fi

\M1494. \P$\X1494:Dump regions 5 and 6 of \\{eqtb}\X\S$\6
\1\&{repeat} \37$\|j\K\|k$;\6
\&{while} $\|j<\\{eqtb\_size}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{eqtb}[\|j].\\{int}=\\{eqtb}[\|j+1].\\{int}$ \1\&{then}\5
\&{goto} \37\\{found2};\2\6
$\\{incr}(\|j)$;\6
\&{end};\2\6
$\|l\K\\{eqtb\_size}+1$;\5
\&{goto} \37\\{done2};\C{$\|j=\\{eqtb\_size}$}\6
\4\\{found2}: \37$\\{incr}(\|j)$;\5
$\|l\K\|j$;\6
\&{while} $\|j<\\{eqtb\_size}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{eqtb}[\|j].\\{int}\I\\{eqtb}[\|j+1].\\{int}$ \1\&{then}%
\5
\&{goto} \37\\{done2};\2\6
$\\{incr}(\|j)$;\6
\&{end};\2\6
\4\\{done2}: \37$\\{dump\_int}(\|l-\|k)$;\6
\&{while} $\|k<\|l$ \1\&{do}\6
\&{begin} \37$\\{dump\_wd}(\\{eqtb}[\|k])$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\|k\K\|j+1$;\5
$\\{dump\_int}(\|k-\|l)$;\6
\4\&{until}\5
$\|k>\\{eqtb\_size}$\2\par
\U1491.\fi

\M1495. \P$\X1495:Undump regions 1 to 6 of \\{eqtb}\X\S$\6
$\|k\K\\{active\_base}$;\6
\1\&{repeat} \37$\\{undump\_int}(\|x)$;\6
\&{if} $(\|x<1)\V(\|k+\|x>\\{eqtb\_size}+1)$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
\&{for} $\|j\K\|k\mathrel{\&{to}}\|k+\|x-1$ \1\&{do}\5
$\\{undump\_wd}(\\{eqtb}[\|j])$;\2\6
$\|k\K\|k+\|x$;\5
$\\{undump\_int}(\|x)$;\6
\&{if} $(\|x<0)\V(\|k+\|x>\\{eqtb\_size}+1)$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt};\2\6
\&{for} $\|j\K\|k\mathrel{\&{to}}\|k+\|x-1$ \1\&{do}\5
$\\{eqtb}[\|j]\K\\{eqtb}[\|k-1]$;\2\6
$\|k\K\|k+\|x$;\6
\4\&{until}\5
$\|k>\\{eqtb\_size}$\2\par
\U1492.\fi

\M1496. A different scheme is used to compress the hash table, since its lower
region is usually sparse. When $\\{text}(\|p)\I0$ for $\|p\L\\{hash\_used}$, we
output
two words, \|p and $\\{hash}[\|p]$. The hash table is, of course, densely
packed
for $\|p\G\\{hash\_used}$, so the remaining entries are output in a~block.

\Y\P$\4\X1496:Dump the hash table\X\S$\6
\&{for} $\|p\K0\mathrel{\&{to}}\\{prim\_size}$ \1\&{do}\5
$\\{dump\_hh}(\\{prim}[\|p])$;\2\6
$\\{dump\_int}(\\{hash\_used})$;\5
$\\{cs\_count}\K\\{frozen\_control\_sequence}-1-\\{hash\_used}$;\6
\&{for} $\|p\K\\{hash\_base}\mathrel{\&{to}}\\{hash\_used}$ \1\&{do}\6
\&{if} $\\{text}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\\{dump\_int}(\|p)$;\5
$\\{dump\_hh}(\\{hash}[\|p])$;\5
$\\{incr}(\\{cs\_count})$;\6
\&{end};\2\2\6
\&{for} $\|p\K\\{hash\_used}+1\mathrel{\&{to}}\\{undefined\_control%
\_sequence}-1$ \1\&{do}\5
$\\{dump\_hh}(\\{hash}[\|p])$;\2\6
$\\{dump\_int}(\\{cs\_count})$;\6
\\{print\_ln};\5
$\\{print\_int}(\\{cs\_count})$;\5
$\\{print}(\.{"\ multiletter\ control\ sequences"})$\par
\U1491.\fi

\M1497. \P$\X1497:Undump the hash table\X\S$\6
\&{for} $\|p\K0\mathrel{\&{to}}\\{prim\_size}$ \1\&{do}\5
$\\{undump\_hh}(\\{prim}[\|p])$;\2\6
$\\{undump}(\\{hash\_base})(\\{frozen\_control\_sequence})(\\{hash\_used})$;\5
$\|p\K\\{hash\_base}-1$;\6
\1\&{repeat} \37$\\{undump}(\|p+1)(\\{hash\_used})(\|p)$;\5
$\\{undump\_hh}(\\{hash}[\|p])$;\6
\4\&{until}\5
$\|p=\\{hash\_used}$;\2\6
\&{for} $\|p\K\\{hash\_used}+1\mathrel{\&{to}}\\{undefined\_control%
\_sequence}-1$ \1\&{do}\5
$\\{undump\_hh}(\\{hash}[\|p])$;\2\6
$\\{undump\_int}(\\{cs\_count})$\par
\U1492.\fi

\M1498. \P$\X1498:Dump the font information\X\S$\6
$\\{dump\_int}(\\{fmem\_ptr})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{fmem\_ptr}-1$ \1\&{do}\5
$\\{dump\_wd}(\\{font\_info}[\|k])$;\2\6
$\\{dump\_int}(\\{font\_ptr})$;\6
\&{for} $\|k\K\\{null\_font}\mathrel{\&{to}}\\{font\_ptr}$ \1\&{do}\5
\X1500:Dump the array info for internal font number \|k\X;\2\6
\\{print\_ln};\5
$\\{print\_int}(\\{fmem\_ptr}-7)$;\5
$\\{print}(\.{"\ words\ of\ font\ info\ for\ "})$;\5
$\\{print\_int}(\\{font\_ptr}-\\{font\_base})$;\5
$\\{print}(\.{"\ preloaded\ font"})$;\6
\&{if} $\\{font\_ptr}\I\\{font\_base}+1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$\2\par
\U1480.\fi

\M1499. \P$\X1499:Undump the font information\X\S$\6
$\\{undump\_size}(7)(\\{font\_mem\_size})(\.{\'font\ mem\ size\'})(\\{fmem%
\_ptr})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{fmem\_ptr}-1$ \1\&{do}\5
$\\{undump\_wd}(\\{font\_info}[\|k])$;\2\6
$\\{undump\_size}(\\{font\_base})(\\{font\_max})(\.{\'font\ max\'})(\\{font%
\_ptr})$;\6
\&{for} $\|k\K\\{null\_font}\mathrel{\&{to}}\\{font\_ptr}$ \1\&{do}\5
\X1501:Undump the array info for internal font number \|k\X\2\par
\U1481.\fi

\M1500. \P$\X1500:Dump the array info for internal font number \|k\X\S$\6
\&{begin} \37$\\{dump\_qqqq}(\\{font\_check}[\|k])$;\5
$\\{dump\_int}(\\{font\_size}[\|k])$;\5
$\\{dump\_int}(\\{font\_dsize}[\|k])$;\5
$\\{dump\_int}(\\{font\_params}[\|k])$;\6
$\\{dump\_int}(\\{hyphen\_char}[\|k])$;\5
$\\{dump\_int}(\\{skew\_char}[\|k])$;\6
$\\{dump\_int}(\\{font\_name}[\|k])$;\5
$\\{dump\_int}(\\{font\_area}[\|k])$;\6
$\\{dump\_int}(\\{font\_bc}[\|k])$;\5
$\\{dump\_int}(\\{font\_ec}[\|k])$;\6
$\\{dump\_int}(\\{char\_base}[\|k])$;\5
$\\{dump\_int}(\\{width\_base}[\|k])$;\5
$\\{dump\_int}(\\{height\_base}[\|k])$;\6
$\\{dump\_int}(\\{depth\_base}[\|k])$;\5
$\\{dump\_int}(\\{italic\_base}[\|k])$;\5
$\\{dump\_int}(\\{lig\_kern\_base}[\|k])$;\6
$\\{dump\_int}(\\{kern\_base}[\|k])$;\5
$\\{dump\_int}(\\{exten\_base}[\|k])$;\5
$\\{dump\_int}(\\{param\_base}[\|k])$;\6
$\\{dump\_int}(\\{font\_glue}[\|k])$;\6
$\\{dump\_int}(\\{bchar\_label}[\|k])$;\5
$\\{dump\_int}(\\{font\_bchar}[\|k])$;\5
$\\{dump\_int}(\\{font\_false\_bchar}[\|k])$;\6
$\\{print\_nl}(\.{"\\font"})$;\5
$\\{print\_esc}(\\{font\_id\_text}(\|k))$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_file\_name}(\\{font\_name}[\|k],\39\\{font\_area}[\|k],\39\.{""})$;\6
\&{if} $\\{font\_size}[\|k]\I\\{font\_dsize}[\|k]$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ at\ "})$;\5
$\\{print\_scaled}(\\{font\_size}[\|k])$;\5
$\\{print}(\.{"pt"})$;\6
\&{end};\2\6
\&{end}\par
\U1498.\fi

\M1501. \P$\X1501:Undump the array info for internal font number \|k\X\S$\6
\&{begin} \37$\\{undump\_qqqq}(\\{font\_check}[\|k])$;\6
$\\{undump\_int}(\\{font\_size}[\|k])$;\5
$\\{undump\_int}(\\{font\_dsize}[\|k])$;\5
$\\{undump}(\\{min\_halfword})(\\{max\_halfword})(\\{font\_params}[\|k])$;\6
$\\{undump\_int}(\\{hyphen\_char}[\|k])$;\5
$\\{undump\_int}(\\{skew\_char}[\|k])$;\6
$\\{undump}(0)(\\{str\_ptr})(\\{font\_name}[\|k])$;\5
$\\{undump}(0)(\\{str\_ptr})(\\{font\_area}[\|k])$;\6
$\\{undump}(0)(255)(\\{font\_bc}[\|k])$;\5
$\\{undump}(0)(255)(\\{font\_ec}[\|k])$;\6
$\\{undump\_int}(\\{char\_base}[\|k])$;\5
$\\{undump\_int}(\\{width\_base}[\|k])$;\5
$\\{undump\_int}(\\{height\_base}[\|k])$;\6
$\\{undump\_int}(\\{depth\_base}[\|k])$;\5
$\\{undump\_int}(\\{italic\_base}[\|k])$;\5
$\\{undump\_int}(\\{lig\_kern\_base}[\|k])$;\6
$\\{undump\_int}(\\{kern\_base}[\|k])$;\5
$\\{undump\_int}(\\{exten\_base}[\|k])$;\5
$\\{undump\_int}(\\{param\_base}[\|k])$;\6
$\\{undump}(\\{min\_halfword})(\\{lo\_mem\_max})(\\{font\_glue}[\|k])$;\6
$\\{undump}(0)(\\{fmem\_ptr}-1)(\\{bchar\_label}[\|k])$;\5
$\\{undump}(\\{min\_quarterword})(\\{non\_char})(\\{font\_bchar}[\|k])$;\5
$\\{undump}(\\{min\_quarterword})(\\{non\_char})(\\{font\_false\_bchar}[\|k])$;%
\6
\&{end}\par
\U1499.\fi

\M1502. \P$\X1502:Dump the hyphenation tables\X\S$\6
$\\{dump\_int}(\\{hyph\_count})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{hyph\_size}$ \1\&{do}\6
\&{if} $\\{hyph\_word}[\|k]\I0$ \1\&{then}\6
\&{begin} \37$\\{dump\_int}(\|k)$;\5
$\\{dump\_int}(\\{hyph\_word}[\|k])$;\5
$\\{dump\_int}(\\{hyph\_list}[\|k])$;\6
\&{end};\2\2\6
\\{print\_ln};\5
$\\{print\_int}(\\{hyph\_count})$;\5
$\\{print}(\.{"\ hyphenation\ exception"})$;\6
\&{if} $\\{hyph\_count}\I1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
\&{if} $\\{trie\_not\_ready}$ \1\&{then}\5
\\{init\_trie};\2\6
$\\{dump\_int}(\\{trie\_max})$;\5
$\\{dump\_int}(\\{hyph\_start})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\\{trie\_max}$ \1\&{do}\5
$\\{dump\_hh}(\\{trie}[\|k])$;\2\6
$\\{dump\_int}(\\{trie\_op\_ptr})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{trie\_op\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{dump\_int}(\\{hyf\_distance}[\|k])$;\5
$\\{dump\_int}(\\{hyf\_num}[\|k])$;\5
$\\{dump\_int}(\\{hyf\_next}[\|k])$;\6
\&{end};\2\6
$\\{print\_nl}(\.{"Hyphenation\ trie\ of\ length\ "})$;\5
$\\{print\_int}(\\{trie\_max})$;\5
$\\{print}(\.{"\ has\ "})$;\5
$\\{print\_int}(\\{trie\_op\_ptr})$;\5
$\\{print}(\.{"\ op"})$;\6
\&{if} $\\{trie\_op\_ptr}\I1$ \1\&{then}\5
$\\{print\_char}(\.{"s"})$;\2\6
$\\{print}(\.{"\ out\ of\ "})$;\5
$\\{print\_int}(\\{trie\_op\_size})$;\6
\&{for} $\|k\K255\mathrel{\&{downto}}0$ \1\&{do}\6
\&{if} $\\{trie\_used}[\|k]>\\{min\_quarterword}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"\ \ "})$;\5
$\\{print\_int}(\\{qo}(\\{trie\_used}[\|k]))$;\5
$\\{print}(\.{"\ for\ language\ "})$;\5
$\\{print\_int}(\|k)$;\5
$\\{dump\_int}(\|k)$;\5
$\\{dump\_int}(\\{qo}(\\{trie\_used}[\|k]))$;\6
\&{end}\2\2\par
\U1480.\fi

\M1503. Only ``nonempty'' parts of \\{op\_start} need to be restored.

\Y\P$\4\X1503:Undump the hyphenation tables\X\S$\6
$\\{undump}(0)(\\{hyph\_size})(\\{hyph\_count})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{hyph\_count}$ \1\&{do}\6
\&{begin} \37$\\{undump}(0)(\\{hyph\_size})(\|j)$;\5
$\\{undump}(0)(\\{str\_ptr})(\\{hyph\_word}[\|j])$;\5
$\\{undump}(\\{min\_halfword})(\\{max\_halfword})(\\{hyph\_list}[\|j])$;\6
\&{end};\2\6
$\\{undump\_size}(0)(\\{trie\_size})(\.{\'trie\ size\'})(\|j)$;\ \&{init} \37$%
\\{trie\_max}\K\|j$;\ \&{tini}$\\{undump}(0)(\|j)(\\{hyph\_start})$;\6
\&{for} $\|k\K0\mathrel{\&{to}}\|j$ \1\&{do}\5
$\\{undump\_hh}(\\{trie}[\|k])$;\2\6
$\\{undump\_size}(0)(\\{trie\_op\_size})(\.{\'trie\ op\ size\'})(\|j)$;\ %
\&{init} \37$\\{trie\_op\_ptr}\K\|j$;\ \&{tini}\6
\&{for} $\|k\K1\mathrel{\&{to}}\|j$ \1\&{do}\6
\&{begin} \37$\\{undump}(0)(63)(\\{hyf\_distance}[\|k])$;\C{a \\{small%
\_number}}\6
$\\{undump}(0)(63)(\\{hyf\_num}[\|k])$;\5
$\\{undump}(\\{min\_quarterword})(\\{max\_quarterword})(\\{hyf\_next}[\|k])$;\6
\&{end};\2\6
\&{init} \37\&{for} $\|k\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{trie\_used}[\|k]\K\\{min\_quarterword}$;\ \2\6
\&{tini}\6
$\|k\K256$;\6
\&{while} $\|j>0$ \1\&{do}\6
\&{begin} \37$\\{undump}(0)(\|k-1)(\|k)$;\5
$\\{undump}(1)(\|j)(\|x)$;\ \&{init} \37$\\{trie\_used}[\|k]\K\\{qi}(\|x)$;\ %
\&{tini}\6
$\|j\K\|j-\|x$;\5
$\\{op\_start}[\|k]\K\\{qo}(\|j)$;\6
\&{end};\2\6
\&{init} \37$\\{trie\_not\_ready}\K\\{false}$\ \&{tini}\par
\U1481.\fi

\M1504. Store some of the pdftex data structures in the format. The idea here
is
to ensure that any data structures referenced from pdftex-specific whatsit
nodes are retained. For the sake of simplicity and speed, all the filled parts
of \\{pdf\_mem} and \\{obj\_tab} are retained, in the present implementation.
We also
retain three of the linked lists that start from \\{head\_tab}, so that it is
possible to, say, load an image in the \.{INITEX} run and then reference it in
a
\.{VIRTEX} run that uses the dumped format.

\Y\P$\4\X1504:Dump pdftex data\X\S$\6
\&{begin} \37\\{dumpimagemeta};\C{the image information array }\6
$\\{dump\_int}(\\{pdf\_mem\_size})$;\5
$\\{dump\_int}(\\{pdf\_mem\_ptr})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{pdf\_mem\_ptr}-1$ \1\&{do}\6
\&{begin} \37$\\{dump\_int}(\\{pdf\_mem}[\|k])$;\6
\&{end};\2\6
\\{print\_ln};\5
$\\{print\_int}(\\{pdf\_mem\_ptr}-1)$;\5
$\\{print}(\.{"\ words\ of\ pdfTeX\ memory"})$;\5
$\\{dump\_int}(\\{obj\_tab\_size})$;\5
$\\{dump\_int}(\\{obj\_ptr})$;\5
$\\{dump\_int}(\\{sys\_obj\_ptr})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{sys\_obj\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{dump\_int}(\\{obj\_tab}[\|k].\\{int0})$;\5
$\\{dump\_int}(\\{obj\_tab}[\|k].\\{int1})$;\5
$\\{dump\_int}(\\{obj\_tab}[\|k].\\{int3})$;\5
$\\{dump\_int}(\\{obj\_tab}[\|k].\\{int4})$;\6
\&{end};\2\6
\\{print\_ln};\5
$\\{print\_int}(\\{sys\_obj\_ptr})$;\5
$\\{print}(\.{"\ indirect\ objects"})$;\5
$\\{dump\_int}(\\{pdf\_obj\_count})$;\5
$\\{dump\_int}(\\{pdf\_xform\_count})$;\5
$\\{dump\_int}(\\{pdf\_ximage\_count})$;\5
$\\{dump\_int}(\\{head\_tab}[\\{obj\_type\_obj}])$;\5
$\\{dump\_int}(\\{head\_tab}[\\{obj\_type\_xform}])$;\5
$\\{dump\_int}(\\{head\_tab}[\\{obj\_type\_ximage}])$;\5
$\\{dump\_int}(\\{pdf\_last\_obj})$;\5
$\\{dump\_int}(\\{pdf\_last\_xform})$;\5
$\\{dump\_int}(\\{pdf\_last\_ximage})$;\5
\\{dumptounicode};\6
\&{end}\par
\U1480.\fi

\M1505. And restoring the pdftex data structures from the format. The
two function arguments to \\{undumpimagemeta} have been restored
already in an earlier module.

\Y\P$\4\X1505:Undump pdftex data\X\S$\6
\&{begin} \37$\\{undumpimagemeta}(\\{pdf\_major\_version},\39\\{pdf\_minor%
\_version},\39\\{pdf\_inclusion\_errorlevel})$;\C{the image information array }%
\6
$\\{undump\_int}(\\{pdf\_mem\_size})$;\5
$\\{pdf\_mem}\K\\{xrealloc\_array}(\\{pdf\_mem},\39\\{integer},\39\\{pdf\_mem%
\_size})$;\5
$\\{undump\_int}(\\{pdf\_mem\_ptr})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{pdf\_mem\_ptr}-1$ \1\&{do}\6
\&{begin} \37$\\{undump\_int}(\\{pdf\_mem}[\|k])$;\6
\&{end};\2\6
$\\{undump\_int}(\\{obj\_tab\_size})$;\5
$\\{undump\_int}(\\{obj\_ptr})$;\5
$\\{undump\_int}(\\{sys\_obj\_ptr})$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{sys\_obj\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{undump\_int}(\\{obj\_tab}[\|k].\\{int0})$;\5
$\\{undump\_int}(\\{obj\_tab}[\|k].\\{int1})$;\5
$\\{obj\_tab}[\|k].\\{int2}\K-1$;\5
$\\{undump\_int}(\\{obj\_tab}[\|k].\\{int3})$;\5
$\\{undump\_int}(\\{obj\_tab}[\|k].\\{int4})$;\6
\&{end};\2\6
$\\{undump\_int}(\\{pdf\_obj\_count})$;\5
$\\{undump\_int}(\\{pdf\_xform\_count})$;\5
$\\{undump\_int}(\\{pdf\_ximage\_count})$;\5
$\\{undump\_int}(\\{head\_tab}[\\{obj\_type\_obj}])$;\5
$\\{undump\_int}(\\{head\_tab}[\\{obj\_type\_xform}])$;\5
$\\{undump\_int}(\\{head\_tab}[\\{obj\_type\_ximage}])$;\5
$\\{undump\_int}(\\{pdf\_last\_obj})$;\5
$\\{undump\_int}(\\{pdf\_last\_xform})$;\5
$\\{undump\_int}(\\{pdf\_last\_ximage})$;\5
\\{undumptounicode};\6
\&{end}\par
\U1481.\fi

\M1506. We have already printed a lot of statistics, so we set $\\{tracing%
\_stats}\K0$
to prevent them from appearing again.

\Y\P$\4\X1506:Dump a couple more things and the closing check word\X\S$\6
$\\{dump\_int}(\\{interaction})$;\5
$\\{dump\_int}(\\{format\_ident})$;\5
$\\{dump\_int}(69069)$;\5
$\\{tracing\_stats}\K0$\par
\U1480.\fi

\M1507. \P$\X1507:Undump a couple more things and the closing check word\X\S$\6
$\\{undump}(\\{batch\_mode})(\\{error\_stop\_mode})(\\{interaction})$;\5
$\\{undump}(0)(\\{str\_ptr})(\\{format\_ident})$;\5
$\\{undump\_int}(\|x)$;\6
\&{if} $(\|x\I69069)\V\\{eof}(\\{fmt\_file})$ \1\&{then}\5
\&{goto} \37\\{bad\_fmt}\2\par
\U1481.\fi

\M1508. \P$\X1508:Create the \\{format\_ident}, open the format file, and
inform the user that dumping has begun\X\S$\6
$\\{selector}\K\\{new\_string}$;\5
$\\{print}(\.{"\ (preloaded\ format="})$;\5
$\\{print}(\\{job\_name})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\\{year})$;\5
$\\{print\_char}(\.{"."})$;\5
$\\{print\_int}(\\{month})$;\5
$\\{print\_char}(\.{"."})$;\5
$\\{print\_int}(\\{day})$;\5
$\\{print\_char}(\.{")"})$;\6
\&{if} $\\{interaction}=\\{batch\_mode}$ \1\&{then}\5
$\\{selector}\K\\{log\_only}$\6
\4\&{else} $\\{selector}\K\\{term\_and\_log}$;\2\6
$\\{str\_room}(1)$;\5
$\\{format\_ident}\K\\{make\_string}$;\5
$\\{pack\_job\_name}(\\{format\_extension})$;\6
\&{while} $\R\\{w\_open\_out}(\\{fmt\_file})$ \1\&{do}\5
$\\{prompt\_file\_name}(\.{"format\ file\ name"},\39\\{format\_extension})$;\2\6
$\\{print\_nl}(\.{"Beginning\ to\ dump\ on\ file\ "})$;\5
$\\{slow\_print}(\\{w\_make\_name\_string}(\\{fmt\_file}))$;\5
\\{flush\_string};\5
$\\{print\_nl}(\.{""})$;\5
$\\{slow\_print}(\\{format\_ident})$\par
\U1480.\fi

\M1509. \P$\X1509:Close the format file\X\S$\6
$\\{w\_close}(\\{fmt\_file})$\par
\U1480.\fi

\N1510.  \[51] The main program.
This is it: the part of \TeX\ that executes all those procedures we have
written.

Well---almost. Let's leave space for a few more routines that we may
have forgotten.

\Y\P\X1513:Last-minute procedures\X\par
\fi

\M1511. We have noted that there are two versions of \TeX82. One, called %
\.{INITEX},
has to be run first; it initializes everything from scratch, without
reading a format file, and it has the capability of dumping a format file.
The other one is called `\.{VIRTEX}'; it is a ``virgin'' program that needs
to input a format file in order to get started. \.{VIRTEX} typically has
more memory capacity than \.{INITEX}, because it does not need the space
consumed by the auxiliary hyphenation tables and the numerous calls on
\\{primitive}, etc.

The \.{VIRTEX} program cannot read a format file instantaneously, of course;
the best implementations therefore allow for production versions of \TeX\ that
not only avoid the loading routine for \PASCAL\ object code, they also have
a format file pre-loaded. This is impossible to do if we stick to standard
\PASCAL; but there is a simple way to fool many systems into avoiding the
initialization, as follows:\quad(1)~We declare a global integer variable
called \\{ready\_already}. The probability is negligible that this
variable holds any particular value like 314159 when \.{VIRTEX} is first
loaded.\quad(2)~After we have read in a format file and initialized
everything, we set $\\{ready\_already}\K314159$.\quad(3)~Soon \.{VIRTEX}
will print `\.*', waiting for more input; and at this point we
interrupt the program and save its core image in some form that the
operating system can reload speedily.\quad(4)~When that core image is
activated, the program starts again at the beginning; but now
$\\{ready\_already}=314159$ and all the other global variables have
their initial values too. The former chastity has vanished!

In other words, if we allow ourselves to test the condition
$\\{ready\_already}=314159$, before \\{ready\_already} has been
assigned a value, we can avoid the lengthy initialization. Dirty tricks
rarely pay off so handsomely.

On systems that allow such preloading, the standard program called \.{TeX}
should be the one that has \.{plain} format preloaded, since that agrees
with {\sl The \TeX book}. Other versions, e.g., \.{AmSTeX}, should also
be provided for commonly used formats.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{ready\_already}: \37\\{integer};\C{a sacrifice of purity for economy}\par
\fi

\M1512. Now this is really it: \TeX\ starts and ends here.

The initial test involving \\{ready\_already} should be deleted if the
\PASCAL\ runtime system is smart enough to detect such a ``mistake.''

\Y\P\&{begin} \37\C{\\{start\_here}}\6
$\\{history}\K\\{fatal\_error\_stop}$;\C{in case we quit during initialization}%
\6
\\{t\_open\_out};\C{open the terminal for output}\6
\&{if} $\\{ready\_already}=314159$ \1\&{then}\5
\&{goto} \37\\{start\_of\_TEX};\2\6
\X14:Check the ``constant'' values for consistency\X\6
\&{if} $\\{bad}>0$ \1\&{then}\6
\&{begin} \37$\\{wterm\_ln}(\.{\'Ouch---my\ internal\ constants\ have\ been\
clobbered!\'},\39\.{\'---case\ \'},\39\\{bad}:1)$;\5
\&{goto} \37\\{final\_end};\6
\&{end};\2\6
\\{initialize};\C{set global variables to their starting values}\6
\&{init} \37\&{if} $\R\\{get\_strings\_started}$ \1\&{then}\5
\&{goto} \37\\{final\_end};\2\6
\\{init\_prim};\C{call \\{primitive} for each primitive}\6
$\\{init\_str\_ptr}\K\\{str\_ptr}$;\5
$\\{init\_pool\_ptr}\K\\{pool\_ptr}$;\5
\\{fix\_date\_and\_time};\6
\&{tini}\6
$\\{ready\_already}\K314159$;\6
\4\\{start\_of\_TEX}: \37\X55:Initialize the output routines\X;\6
\X1517:Get the first line of input and prepare to start\X;\6
$\\{history}\K\\{spotless}$;\C{ready to go!}\6
\\{main\_control};\C{come to life}\6
\\{final\_cleanup};\C{prepare for death}\6
\4\\{end\_of\_TEX}: \37\\{close\_files\_and\_terminate};\6
\4\\{final\_end}: \37$\\{ready\_already}\K0$;\6
\&{end}.\par
\fi

\M1513. Here we do whatever is needed to complete \TeX's job gracefully on the
local operating system. The code here might come into play after a fatal
error; it must therefore consist entirely of ``safe'' operations that
cannot produce error messages. For example, it would be a mistake to call
\\{str\_room} or \\{make\_string} at this time, because a call on \\{overflow}
might lead to an infinite loop.
(Actually there's one way to get error messages, via \\{prepare\_mag};
but that can't cause infinite recursion.)

If \\{final\_cleanup} is bypassed, this program doesn't bother to close
the input files that may still be open.

\Y\P$\4\X1513:Last-minute procedures\X\S$\6
\4\&{procedure}\1\  \37\\{close\_files\_and\_terminate};\6
\4\&{label} \37$\\{done},\39\\{done1}$;\6
\4\&{var} \37$\|a,\39\|b,\39\|c,\39\|i,\39\|j,\39\|k,\39\|l$: \37\\{integer};%
\C{all-purpose index}\6
\\{is\_root}: \37\\{boolean};\C{\\{pdf\_last\_pages} is root of Pages tree?}\6
\\{is\_names}: \37\\{boolean};\C{flag for name tree output: is it Names or
Kids?}\6
$\\{root},\39\\{outlines},\39\\{threads},\39\\{names\_tree},\39\\{dests}$: \37%
\\{integer};\5
$\\{xref\_offset\_width},\39\\{names\_head},\39\\{names\_tail}$: \37%
\\{integer};\2\6
\&{begin} \37\X1626:Finish the extensions\X;\6
$\\{new\_line\_char}\K-1$;\6
\&{stat} \37\&{if} $\\{tracing\_stats}>0$ \1\&{then}\5
\X1514:Output statistics about this job\X;\2\ \&{tats}\6
\\{wake\_up\_terminal};\6
\&{if} $\R\\{fixed\_pdfoutput\_set}$ \1\&{then}\5
\\{fix\_pdfoutput};\2\6
\&{if} $\\{fixed\_pdfoutput}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{history}=\\{fatal\_error\_stop}$ \1\&{then}\6
\&{begin} \37\\{remove\_pdffile};\5
$\\{print\_err}(\.{"\ ==>\ Fatal\ error\ occurred,\ no\ output\ PDF\ file\
produced!"})$\6
\&{end}\6
\4\&{else} \&{begin} \37\X794:Finish the PDF file\X;\6
\&{if} $\\{log\_opened}$ \1\&{then}\6
\&{begin} \37\\{wlog\_cr};\5
$\\{wlog\_ln}(\.{\'PDF\ statistics:\'})$;\5
$\\{wlog\_ln}(\.{\'\ \'},\39\\{obj\_ptr}:1,\39\.{\'\ PDF\ objects\ out\ of\ %
\'},\39\\{obj\_tab\_size}:1,\39\.{\'\ (max.\ \'},\39\\{sup\_obj\_tab\_size}:1,%
\39\.{\')\'})$;\6
\&{if} $\\{pdf\_os\_cntr}>0$ \1\&{then}\6
\&{begin} \37$\\{wlog}(\.{\'\ \'},\39((\\{pdf\_os\_cntr}-1)\ast\\{pdf\_os\_max%
\_objs}+\\{pdf\_os\_objidx}+1):1,\39\.{\'\ compressed\ objects\ within\ \'},\39%
\\{pdf\_os\_cntr}:1,\39\.{\'\ object\ stream\'})$;\6
\&{if} $\\{pdf\_os\_cntr}>1$ \1\&{then}\5
$\\{wlog}(\.{\'s\'})$;\2\6
\\{wlog\_cr};\6
\&{end};\2\6
$\\{wlog\_ln}(\.{\'\ \'},\39\\{pdf\_dest\_names\_ptr}:1,\39\.{\'\ named\
destinations\ out\ of\ \'},\39\\{dest\_names\_size}:1,\39\.{\'\ (max.\ \'},\39%
\\{sup\_dest\_names\_size}:1,\39\.{\')\'})$;\5
$\\{wlog\_ln}(\.{\'\ \'},\39\\{pdf\_mem\_ptr}:1,\39\.{\'\ words\ of\ extra\
memory\ for\ PDF\ output\ out\ of\ \'},\39\\{pdf\_mem\_size}:1,\39\.{\'\ (max.\
\'},\39\\{sup\_pdf\_mem\_size}:1,\39\.{\')\'})$;\6
\&{end};\2\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37\X670:Finish the \.{DVI} file\X;\6
\&{end};\2\6
\&{if} $\\{log\_opened}$ \1\&{then}\6
\&{begin} \37\\{wlog\_cr};\5
$\\{a\_close}(\\{log\_file})$;\5
$\\{selector}\K\\{selector}-2$;\6
\&{if} $\\{selector}=\\{term\_only}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Transcript\ written\ on\ "})$;\5
$\\{slow\_print}(\\{log\_name})$;\5
$\\{print\_char}(\.{"."})$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\As1515, 1516\ETs1518.
\U1510.\fi

\M1514. The present section goes directly to the log file instead of using
\\{print} commands, because there's no need for these strings to take
up \\{str\_pool} memory when a non-{\bf stat} version of \TeX\ is being used.

\Y\P$\4\X1514:Output statistics about this job\X\S$\6
\&{if} $\\{log\_opened}$ \1\&{then}\6
\&{begin} \37$\\{wlog\_ln}(\.{\'\ \'})$;\5
$\\{wlog\_ln}(\.{\'Here\ is\ how\ much\ of\ TeX\'}\.{\'s\ memory\'},\39\.{\'\
you\ used:\'})$;\5
$\\{wlog}(\.{\'\ \'},\39\\{str\_ptr}-\\{init\_str\_ptr}:1,\39\.{\'\ string%
\'})$;\6
\&{if} $\\{str\_ptr}\I\\{init\_str\_ptr}+1$ \1\&{then}\5
$\\{wlog}(\.{\'s\'})$;\2\6
$\\{wlog\_ln}(\.{\'\ out\ of\ \'},\39\\{max\_strings}-\\{init\_str\_ptr}:1)$;\6
$\\{wlog\_ln}(\.{\'\ \'},\39\\{pool\_ptr}-\\{init\_pool\_ptr}:1,\39\.{\'\
string\ characters\ out\ of\ \'},\39\\{pool\_size}-\\{init\_pool\_ptr}:1)$;\6
$\\{wlog\_ln}(\.{\'\ \'},\39\\{lo\_mem\_max}-\\{mem\_min}+\\{mem\_end}-\\{hi%
\_mem\_min}+2:1,\39\30\.{\'\ words\ of\ memory\ out\ of\ \'},\39\\{mem\_end}+1-%
\\{mem\_min}:1)$;\6
$\\{wlog\_ln}(\.{\'\ \'},\39\\{cs\_count}:1,\39\.{\'\ multiletter\ control\
sequences\ out\ of\ \'},\39\\{hash\_size}:1)$;\6
$\\{wlog}(\.{\'\ \'},\39\\{fmem\_ptr}:1,\39\.{\'\ words\ of\ font\ info\ for\ %
\'},\39\\{font\_ptr}-\\{font\_base}:1,\39\.{\'\ font\'})$;\6
\&{if} $\\{font\_ptr}\I\\{font\_base}+1$ \1\&{then}\5
$\\{wlog}(\.{\'s\'})$;\2\6
$\\{wlog\_ln}(\.{\',\ out\ of\ \'},\39\\{font\_mem\_size}:1,\39\.{\'\ for\ \'},%
\39\\{font\_max}-\\{font\_base}:1)$;\6
$\\{wlog}(\.{\'\ \'},\39\\{hyph\_count}:1,\39\.{\'\ hyphenation\ exception%
\'})$;\6
\&{if} $\\{hyph\_count}\I1$ \1\&{then}\5
$\\{wlog}(\.{\'s\'})$;\2\6
$\\{wlog\_ln}(\.{\'\ out\ of\ \'},\39\\{hyph\_size}:1)$;\6
$\\{wlog\_ln}(\.{\'\ \'},\39\\{max\_in\_stack}:1,\39\.{\'i,\'},\39\\{max\_nest%
\_stack}:1,\39\.{\'n,\'},\39\30\\{max\_param\_stack}:1,\39\.{\'p,\'},\39\30%
\\{max\_buf\_stack}+1:1,\39\.{\'b,\'},\39\30\\{max\_save\_stack}+6:1,\39\.{\'s\
stack\ positions\ out\ of\ \'},\39\30\\{stack\_size}:1,\39\.{\'i,\'},\39\\{nest%
\_size}:1,\39\.{\'n,\'},\39\\{param\_size}:1,\39\.{\'p,\'},\39\\{buf\_size}:1,%
\39\.{\'b,\'},\39\\{save\_size}:1,\39\.{\'s\'})$;\6
\&{end}\2\par
\U1513.\fi

\M1515. We get to the \\{final\_cleanup} routine when \.{\\end} or \.{\\dump}
has
been scanned and \\{its\_all\_over}\kern-2pt.

\Y\P$\4\X1513:Last-minute procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{final\_cleanup};\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|c: \37\\{small\_number};\C{0 for \.{\\end}, 1 for \.{\\dump}}\2\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\6
\&{if} $\|c\I1$ \1\&{then}\5
$\\{new\_line\_char}\K-1$;\2\6
\&{if} $\\{job\_name}=0$ \1\&{then}\5
\\{open\_log\_file};\2\6
\&{while} $\\{input\_ptr}>0$ \1\&{do}\6
\&{if} $\\{state}=\\{token\_list}$ \1\&{then}\5
\\{end\_token\_list}\ \&{else} \\{end\_file\_reading};\2\2\6
\&{while} $\\{open\_parens}>0$ \1\&{do}\6
\&{begin} \37$\\{print}(\.{"\ )"})$;\5
$\\{decr}(\\{open\_parens})$;\6
\&{end};\2\6
\&{if} $\\{cur\_level}>\\{level\_one}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"("})$;\5
$\\{print\_esc}(\.{"end\ occurred\ "})$;\5
$\\{print}(\.{"inside\ a\ group\ at\ level\ "})$;\5
$\\{print\_int}(\\{cur\_level}-\\{level\_one})$;\5
$\\{print\_char}(\.{")"})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\\{show\_save\_groups};\2\6
\&{end};\2\6
\&{while} $\\{cond\_ptr}\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{print\_nl}(\.{"("})$;\5
$\\{print\_esc}(\.{"end\ occurred\ "})$;\5
$\\{print}(\.{"when\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{cur\_if})$;\6
\&{if} $\\{if\_line}\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ on\ line\ "})$;\5
$\\{print\_int}(\\{if\_line})$;\6
\&{end};\2\6
$\\{print}(\.{"\ was\ incomplete)"})$;\5
$\\{if\_line}\K\\{if\_line\_field}(\\{cond\_ptr})$;\5
$\\{cur\_if}\K\\{subtype}(\\{cond\_ptr})$;\5
$\\{temp\_ptr}\K\\{cond\_ptr}$;\5
$\\{cond\_ptr}\K\\{link}(\\{cond\_ptr})$;\5
$\\{free\_node}(\\{temp\_ptr},\39\\{if\_node\_size})$;\6
\&{end};\2\6
\&{if} $\\{history}\I\\{spotless}$ \1\&{then}\6
\&{if} $((\\{history}=\\{warning\_issued})\V(\\{interaction}<\\{error\_stop%
\_mode}))$ \1\&{then}\6
\&{if} $\\{selector}=\\{term\_and\_log}$ \1\&{then}\6
\&{begin} \37$\\{selector}\K\\{term\_only}$;\5
$\\{print\_nl}(\.{"(see\ the\ transcript\ file\ for\ additional\
information)"})$;\5
$\\{selector}\K\\{term\_and\_log}$;\6
\&{end};\2\2\2\6
\&{if} $\|c=1$ \1\&{then}\6
\&{begin} \37\&{init} \37\&{for} $\|c\K\\{top\_mark\_code}\mathrel{\&{to}}%
\\{split\_bot\_mark\_code}$ \1\&{do}\6
\&{if} $\\{cur\_mark}[\|c]\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{cur\_mark}[\|c])$;\2\2\6
\&{if} $\\{sa\_mark}\I\\{null}$ \1\&{then}\6
\&{if} $\\{do\_marks}(\\{destroy\_marks},\390,\39\\{sa\_mark})$ \1\&{then}\5
$\\{sa\_mark}\K\\{null}$;\2\2\6
\&{for} $\|c\K\\{last\_box\_code}\mathrel{\&{to}}\\{vsplit\_code}$ \1\&{do}\5
$\\{flush\_node\_list}(\\{disc\_ptr}[\|c])$;\2\6
\&{if} $\\{last\_glue}\I\\{max\_halfword}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{last\_glue})$;\2\6
\\{store\_fmt\_file};\5
\&{return};\ \&{tini}\6
$\\{print\_nl}(\.{"(\\dump\ is\ performed\ only\ by\ INITEX)"})$;\5
\&{return};\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1516. \P$\X1513:Last-minute procedures\X\mathrel{+}\S$\6
\&{init} \37\&{procedure}\1\  \37\\{init\_prim};\C{initialize all the
primitives}\2\6
\&{begin} \37$\\{no\_new\_control\_sequence}\K\\{false}$;\5
$\\{first}\K0$;\5
\X244:Put each of \TeX's primitives into the hash table\X;\6
$\\{no\_new\_control\_sequence}\K\\{true}$;\6
\&{end};\6
\&{tini}\par
\fi

\M1517. When we begin the following code, \TeX's tables may still contain
garbage;
the strings might not even be present. Thus we must proceed cautiously to get
bootstrapped in.

But when we finish this part of the program, \TeX\ is ready to call on the
\\{main\_control} routine to do its work.

\Y\P$\4\X1517:Get the first line of input and prepare to start\X\S$\6
\&{begin} \37\X353:Initialize the input routines\X;\6
\X1648:Enable \eTeX, if requested\X\6
\&{if} $(\\{format\_ident}=0)\V(\\{buffer}[\\{loc}]=\.{"\&"})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{format\_ident}\I0$ \1\&{then}\5
\\{initialize};\C{erase preloaded format}\2\6
\&{if} $\R\\{open\_fmt\_file}$ \1\&{then}\5
\&{goto} \37\\{final\_end};\2\6
\&{if} $\R\\{load\_fmt\_file}$ \1\&{then}\6
\&{begin} \37$\\{w\_close}(\\{fmt\_file})$;\5
\&{goto} \37\\{final\_end};\6
\&{end};\2\6
$\\{w\_close}(\\{fmt\_file})$;\6
\&{while} $(\\{loc}<\\{limit})\W(\\{buffer}[\\{loc}]=\.{"\ "})$ \1\&{do}\5
$\\{incr}(\\{loc})$;\2\6
\&{end};\2\6
\&{if} $(\\{pdf\_output\_option}\I0)$ \1\&{then}\5
$\\{pdf\_output}\K\\{pdf\_output\_value}$;\2\6
\&{if} $(\\{pdf\_draftmode\_option}\I0)$ \1\&{then}\5
$\\{pdf\_draftmode}\K\\{pdf\_draftmode\_value}$;\2\6
$\\{pdf\_init\_map\_file}(\.{\'pdftex.map\'})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
$\\{wterm\_ln}(\.{\'entering\ extended\ mode\'})$;\2\6
\&{if} $\\{end\_line\_char\_inactive}$ \1\&{then}\5
$\\{decr}(\\{limit})$\6
\4\&{else} $\\{buffer}[\\{limit}]\K\\{end\_line\_char}$;\2\6
\\{fix\_date\_and\_time};\6
$\\{random\_seed}\K(\\{microseconds}\ast1000)+(\\{epochseconds}\mathbin{%
\&{mod}}1000000)$;\6
$\\{init\_randoms}(\\{random\_seed})$;\6
\X941:Compute the magic offset\X;\6
\X75:Initialize the print \\{selector} based on \\{interaction}\X;\6
\&{if} $(\\{loc}<\\{limit})\W(\\{cat\_code}(\\{buffer}[\\{loc}])\I\\{escape})$ %
\1\&{then}\5
\\{start\_input};\C{\.{\\input} assumed}\2\6
\&{end}\par
\U1512.\fi

\N1518.  \[52] Debugging.
Once \TeX\ is working, you should be able to diagnose most errors with
the \.{\\show} commands and other diagnostic features. But for the initial
stages of debugging, and for the revelation of really deep mysteries, you
can compile \TeX\ with a few more aids, including the \PASCAL\ runtime
checks and its debugger. An additional routine called \\{debug\_help}
will also come into play when you type `\.D' after an error message;
\\{debug\_help} also occurs just before a fatal error causes \TeX\ to succumb.

The interface to \\{debug\_help} is primitive, but it is good enough when used
with a \PASCAL\ debugger that allows you to set breakpoints and to read
variables and change their values. After getting the prompt `\.{debug \#}', you
type either a negative number (this exits \\{debug\_help}), or zero (this
goes to a location where you can set a breakpoint, thereby entering into
dialog with the \PASCAL\ debugger), or a positive number \|m followed by
an argument \|n. The meaning of \|m and \|n will be clear from the
program below. (If $\|m=13$, there is an additional argument, \|l.)

\Y\P\D \37$\\{breakpoint}=888$\C{place where a breakpoint is desirable}\par
\Y\P$\4\X1513:Last-minute procedures\X\mathrel{+}\S$\6
\&{debug} \37\&{procedure}\1\  \37\\{debug\_help};\C{routine to display various
things}\6
\4\&{label} \37$\\{breakpoint},\39\\{exit}$;\6
\4\&{var} \37$\|k,\39\|l,\39\|m,\39\|n$: \37\\{integer};\2\6
\&{begin} \37\\{clear\_terminal};\6
\~ \1\&{loop}\6
\&{begin} \37\\{wake\_up\_terminal};\5
$\\{print\_nl}(\.{"debug\ \#\ (-1\ to\ exit):"})$;\5
\\{update\_terminal};\5
$\\{read}(\\{term\_in},\39\|m)$;\6
\&{if} $\|m<0$ \1\&{then}\5
\&{return}\6
\4\&{else} \&{if} $\|m=0$ \1\&{then}\6
\&{begin} \37\&{goto} \37\\{breakpoint};\6
\C{go to every declared label at least once}\6
\4\\{breakpoint}: \37$\|m\K0$;\5
$\B\.{\'BREAKPOINT\'}\T$\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{read}(\\{term\_in},\39\|n)$;\6
\&{case} $\|m$ \1\&{of}\6
\hbox{\4}\X1519:Numbered cases for \\{debug\_help}\X\6
\4\&{othercases} \37$\\{print}(\.{"?"})$\2\6
\&{endcases};\6
\&{end};\2\2\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\6
\&{gubed}\par
\fi

\M1519. \P$\X1519:Numbered cases for \\{debug\_help}\X\S$\6
\41: \37$\\{print\_word}(\\{mem}[\|n])$;\C{display $\\{mem}[\|n]$ in all forms}%
\6
\42: \37$\\{print\_int}(\\{info}(\|n))$;\6
\43: \37$\\{print\_int}(\\{link}(\|n))$;\6
\44: \37$\\{print\_word}(\\{eqtb}[\|n])$;\6
\45: \37$\\{print\_word}(\\{font\_info}[\|n])$;\6
\46: \37$\\{print\_word}(\\{save\_stack}[\|n])$;\6
\47: \37$\\{show\_box}(\|n)$;\C{show a box, abbreviated by \\{show\_box\_depth}
and \\{show\_box\_breadth}}\6
\48: \37\&{begin} \37$\\{breadth\_max}\K10000$;\5
$\\{depth\_threshold}\K\\{pool\_size}-\\{pool\_ptr}-10$;\5
$\\{show\_node\_list}(\|n)$;\C{show a box in its entirety}\6
\&{end};\6
\49: \37$\\{show\_token\_list}(\|n,\39\\{null},\391000)$;\6
\410: \37$\\{slow\_print}(\|n)$;\6
\411: \37$\\{check\_mem}(\|n>0)$;\C{check wellformedness; print new busy
locations if $\|n>0$}\6
\412: \37$\\{search\_mem}(\|n)$;\C{look for pointers to \|n}\6
\413: \37\&{begin} \37$\\{read}(\\{term\_in},\39\|l)$;\5
$\\{print\_cmd\_chr}(\|n,\39\|l)$;\6
\&{end};\6
\414: \37\&{for} $\|k\K0\mathrel{\&{to}}\|n$ \1\&{do}\5
$\\{print}(\\{buffer}[\|k])$;\2\6
\415: \37\&{begin} \37$\\{font\_in\_short\_display}\K\\{null\_font}$;\5
$\\{short\_display}(\|n)$;\6
\&{end};\6
\416: \37$\\{panicking}\K\R\\{panicking}$;\par
\U1518.\fi

\N1520.  \[53] Extensions.
The program above includes a bunch of ``hooks'' that allow further
capabilities to be added without upsetting \TeX's basic structure.
Most of these hooks are concerned with ``whatsit'' nodes, which are
intended to be used for special purposes; whenever a new extension to
\TeX\ involves a new kind of whatsit node, a corresponding change needs
to be made to the routines below that deal with such nodes,
but it will usually be unnecessary to make many changes to the
other parts of this program.

In order to demonstrate how extensions can be made, we shall treat
`\.{\\write}', `\.{\\openout}', `\.{\\closeout}', `\.{\\immediate}',
`\.{\\special}', and `\.{\\setlanguage}' as if they were extensions.
These commands are actually primitives of \TeX, and they should
appear in all implementations of the system; but let's try to imagine
that they aren't. Then the program below illustrates how a person
could add them.

Sometimes, of course, an extension will require changes to \TeX\ itself;
no system of hooks could be complete enough for all conceivable extensions.
The features associated with `\.{\\write}' are almost all confined to the
following paragraphs, but there are small parts of the \\{print\_ln} and
\\{print\_char} procedures that were introduced specifically to \.{\\write}
characters. Furthermore one of the token lists recognized by the scanner
is a \\{write\_text}; and there are a few other miscellaneous places where we
have already provided for some aspect of \.{\\write}.  The goal of a \TeX\
extender should be to minimize alterations to the standard parts of the
program, and to avoid them completely if possible. He or she should also
be quite sure that there's no easy way to accomplish the desired goals
with the standard features that \TeX\ already has. ``Think thrice before
extending,'' because that may save a lot of work, and it will also keep
incompatible extensions of \TeX\ from proliferating.

\fi

\M1521. First let's consider the format of whatsit nodes that are used to
represent
the data associated with \.{\\write} and its relatives. Recall that a whatsit
has $\\{type}=\\{whatsit\_node}$, and the \\{subtype} is supposed to
distinguish
different kinds of whatsits. Each node occupies two or more words; the
exact number is immaterial, as long as it is readily determined from the
\\{subtype} or other data.

We shall introduce five \\{subtype} values here, corresponding to the
control sequences \.{\\openout}, \.{\\write}, \.{\\closeout}, \.{\\special},
and
\.{\\setlanguage}. The second word of I/O whatsits has a \\{write\_stream}
field
that identifies the write-stream number (0 to 15, or 16 for out-of-range and
positive, or 17 for out-of-range and negative).
In the case of \.{\\write} and \.{\\special}, there is also a field that
points to the reference count of a token list that should be sent. In the
case of \.{\\openout}, we need three words and three auxiliary subfields
to hold the string numbers for name, area, and extension.

\Y\P\D \37$\\{write\_node\_size}=2$\C{number of words in a write/whatsit node}%
\par
\P\D \37$\\{open\_node\_size}=3$\C{number of words in an open/whatsit node}\par
\P\D \37$\\{open\_node}=0$\C{\\{subtype} in whatsits that represent files to %
\.{\\openout}}\par
\P\D \37$\\{write\_node}=1$\C{\\{subtype} in whatsits that represent things to %
\.{\\write}}\par
\P\D \37$\\{close\_node}=2$\C{\\{subtype} in whatsits that represent streams to
\.{\\closeout}}\par
\P\D \37$\\{special\_node}=3$\C{\\{subtype} in whatsits that represent \.{%
\\special} things}\par
\P\D \37$\\{latespecial\_node}\S4$\C{\\{subtype} in whatsits that represent \.{%
\\special} things expanded during output}\par
\P\D \37$\\{language\_node}=5$\C{\\{subtype} in whatsits that change the
current language}\par
\P\D \37$\\{what\_lang}(\#)\S\\{link}(\#+1)$\C{language number, in the range $0%
\to255$}\par
\P\D \37$\\{what\_lhm}(\#)\S\\{type}(\#+1)$\C{minimum left fragment, in the
range $1\to63$}\par
\P\D \37$\\{what\_rhm}(\#)\S\\{subtype}(\#+1)$\C{minimum right fragment, in the
range $1\to63$}\par
\P\D \37$\\{write\_tokens}(\#)\S\\{link}(\#+1)$\C{reference count of token list
to write}\par
\P\D \37$\\{write\_stream}(\#)\S\\{info}(\#+1)$\C{stream number (0 to 17)}\par
\P\D \37$\\{open\_name}(\#)\S\\{link}(\#+1)$\C{string number of file name to
open}\par
\P\D \37$\\{open\_area}(\#)\S\\{info}(\#+2)$\C{string number of file area for %
\\{open\_name}}\par
\P\D \37$\\{open\_ext}(\#)\S\\{link}(\#+2)$\C{string number of file extension
for \\{open\_name}}\par
\fi

\M1522. The sixteen possible \.{\\write} streams are represented by the %
\\{write\_file}
array. The \|jth file is open if and only if $\\{write\_open}[\|j]=\\{true}$.
The last
two streams are special; $\\{write\_open}[16]$ represents a stream number
greater than 15, while $\\{write\_open}[17]$ represents a negative stream
number,
and both of these variables are always \\{false}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{write\_file}: \37\&{array} $[0\to15]$ \1\&{of}\5
\\{alpha\_file};\2\6
\4\\{write\_open}: \37\&{array} $[0\to17]$ \1\&{of}\5
\\{boolean};\2\par
\fi

\M1523. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
\&{for} $\|k\K0\mathrel{\&{to}}17$ \1\&{do}\5
$\\{write\_open}[\|k]\K\\{false}$;\2\par
\fi

\M1524. Extensions might introduce new command codes; but it's best to use
\\{extension} with a modifier, whenever possible, so that \\{main\_control}
stays the same.

\Y\P\D \37$\\{immediate\_code}=5$\C{command modifier for \.{\\immediate}}\par
\P\D \37$\\{set\_language\_code}=6$\C{command modifier for \.{\\setlanguage}}%
\par
\P\D \37$\\{pdftex\_first\_extension\_code}=7$\par
\P\D \37$\\{pdf\_literal\_node}\S\\{pdftex\_first\_extension\_code}+0$\par
\P\D \37$\\{pdf\_lateliteral\_node}\S\\{pdftex\_first\_extension\_code}+1$\par
\P\D \37$\\{pdf\_obj\_code}\S\\{pdftex\_first\_extension\_code}+2$\par
\P\D \37$\\{pdf\_refobj\_node}\S\\{pdftex\_first\_extension\_code}+3$\par
\P\D \37$\\{pdf\_xform\_code}\S\\{pdftex\_first\_extension\_code}+4$\par
\P\D \37$\\{pdf\_refxform\_node}\S\\{pdftex\_first\_extension\_code}+5$\par
\P\D \37$\\{pdf\_ximage\_code}\S\\{pdftex\_first\_extension\_code}+6$\par
\P\D \37$\\{pdf\_refximage\_node}\S\\{pdftex\_first\_extension\_code}+7$\par
\P\D \37$\\{pdf\_annot\_node}\S\\{pdftex\_first\_extension\_code}+8$\par
\P\D \37$\\{pdf\_start\_link\_node}\S\\{pdftex\_first\_extension\_code}+9$\par
\P\D \37$\\{pdf\_end\_link\_node}\S\\{pdftex\_first\_extension\_code}+10$\par
\P\D \37$\\{pdf\_outline\_code}\S\\{pdftex\_first\_extension\_code}+11$\par
\P\D \37$\\{pdf\_dest\_node}\S\\{pdftex\_first\_extension\_code}+12$\par
\P\D \37$\\{pdf\_thread\_node}\S\\{pdftex\_first\_extension\_code}+13$\par
\P\D \37$\\{pdf\_start\_thread\_node}\S\\{pdftex\_first\_extension\_code}+14$%
\par
\P\D \37$\\{pdf\_end\_thread\_node}\S\\{pdftex\_first\_extension\_code}+15$\par
\P\D \37$\\{pdf\_save\_pos\_node}\S\\{pdftex\_first\_extension\_code}+16$\par
\P\D \37$\\{pdf\_info\_code}\S\\{pdftex\_first\_extension\_code}+17$\par
\P\D \37$\\{pdf\_catalog\_code}\S\\{pdftex\_first\_extension\_code}+18$\par
\P\D \37$\\{pdf\_names\_code}\S\\{pdftex\_first\_extension\_code}+19$\par
\P\D \37$\\{pdf\_font\_attr\_code}\S\\{pdftex\_first\_extension\_code}+20$\par
\P\D \37$\\{pdf\_include\_chars\_code}\S\\{pdftex\_first\_extension\_code}+21$%
\par
\P\D \37$\\{pdf\_map\_file\_code}\S\\{pdftex\_first\_extension\_code}+22$\par
\P\D \37$\\{pdf\_map\_line\_code}\S\\{pdftex\_first\_extension\_code}+23$\par
\P\D \37$\\{pdf\_trailer\_code}\S\\{pdftex\_first\_extension\_code}+24$\par
\P\D \37$\\{pdf\_trailer\_id\_code}\S\\{pdftex\_first\_extension\_code}+25$\par
\P\D \37$\\{reset\_timer\_code}\S\\{pdftex\_first\_extension\_code}+26$\par
\P\D \37$\\{pdf\_font\_expand\_code}\S\\{pdftex\_first\_extension\_code}+27$\par
\P\D \37$\\{set\_random\_seed\_code}\S\\{pdftex\_first\_extension\_code}+28$\par
\P\D \37$\\{pdf\_snap\_ref\_point\_node}\S\\{pdftex\_first\_extension%
\_code}+29$\par
\P\D \37$\\{pdf\_snapy\_node}\S\\{pdftex\_first\_extension\_code}+30$\par
\P\D \37$\\{pdf\_snapy\_comp\_node}\S\\{pdftex\_first\_extension\_code}+31$\par
\P\D \37$\\{pdf\_glyph\_to\_unicode\_code}\S\\{pdftex\_first\_extension%
\_code}+32$\par
\P\D \37$\\{pdf\_colorstack\_node}\S\\{pdftex\_first\_extension\_code}+33$\par
\P\D \37$\\{pdf\_setmatrix\_node}\S\\{pdftex\_first\_extension\_code}+34$\par
\P\D \37$\\{pdf\_save\_node}\S\\{pdftex\_first\_extension\_code}+35$\par
\P\D \37$\\{pdf\_restore\_node}\S\\{pdftex\_first\_extension\_code}+36$\par
\P\D \37$\\{pdf\_nobuiltin\_tounicode\_code}\S\\{pdftex\_first\_extension%
\_code}+37$\par
\P\D \37$\\{pdf\_interword\_space\_on\_node}\S\\{pdftex\_first\_extension%
\_code}+38$\par
\P\D \37$\\{pdf\_interword\_space\_off\_node}\S\\{pdftex\_first\_extension%
\_code}+39$\par
\P\D \37$\\{pdf\_fake\_space\_node}\S\\{pdftex\_first\_extension\_code}+40$\par
\P\D \37$\\{pdf\_running\_link\_off\_node}\S\\{pdftex\_first\_extension%
\_code}+41$\par
\P\D \37$\\{pdf\_running\_link\_on\_node}\S\\{pdftex\_first\_extension%
\_code}+42$\par
\P\D \37$\\{pdf\_space\_font\_code}\S\\{pdftex\_first\_extension\_code}+43$\par
\P\D \37$\\{pdftex\_last\_extension\_code}\S\\{pdftex\_first\_extension%
\_code}+43$\par
\Y\P$\4\X244:Put each of \TeX's primitives into the hash table\X\mathrel{+}\S$\6
$\\{primitive}(\.{"openout"},\39\\{extension},\39\\{open\_node})$;\6
$\\{primitive}(\.{"write"},\39\\{extension},\39\\{write\_node})$;\5
$\\{write\_loc}\K\\{cur\_val}$;\6
$\\{primitive}(\.{"closeout"},\39\\{extension},\39\\{close\_node})$;\6
$\\{primitive}(\.{"special"},\39\\{extension},\39\\{special\_node})$;\6
$\\{primitive}(\.{"immediate"},\39\\{extension},\39\\{immediate\_code})$;\6
$\\{primitive}(\.{"setlanguage"},\39\\{extension},\39\\{set\_language\_code})$;%
\6
$\\{primitive}(\.{"pdfliteral"},\39\\{extension},\39\\{pdf\_literal\_node})$;\6
$\\{primitive}(\.{"pdfcolorstack"},\39\\{extension},\39\\{pdf\_colorstack%
\_node})$;\6
$\\{primitive}(\.{"pdfsetmatrix"},\39\\{extension},\39\\{pdf\_setmatrix%
\_node})$;\6
$\\{primitive}(\.{"pdfsave"},\39\\{extension},\39\\{pdf\_save\_node})$;\6
$\\{primitive}(\.{"pdfrestore"},\39\\{extension},\39\\{pdf\_restore\_node})$;\6
$\\{primitive}(\.{"pdfobj"},\39\\{extension},\39\\{pdf\_obj\_code})$;\6
$\\{primitive}(\.{"pdfrefobj"},\39\\{extension},\39\\{pdf\_refobj\_node})$;\6
$\\{primitive}(\.{"pdfxform"},\39\\{extension},\39\\{pdf\_xform\_code})$;\6
$\\{primitive}(\.{"pdfrefxform"},\39\\{extension},\39\\{pdf\_refxform\_node})$;%
\6
$\\{primitive}(\.{"pdfximage"},\39\\{extension},\39\\{pdf\_ximage\_code})$;\6
$\\{primitive}(\.{"pdfrefximage"},\39\\{extension},\39\\{pdf\_refximage%
\_node})$;\6
$\\{primitive}(\.{"pdfannot"},\39\\{extension},\39\\{pdf\_annot\_node})$;\6
$\\{primitive}(\.{"pdfstartlink"},\39\\{extension},\39\\{pdf\_start\_link%
\_node})$;\6
$\\{primitive}(\.{"pdfendlink"},\39\\{extension},\39\\{pdf\_end\_link\_node})$;%
\6
$\\{primitive}(\.{"pdfoutline"},\39\\{extension},\39\\{pdf\_outline\_code})$;\6
$\\{primitive}(\.{"pdfdest"},\39\\{extension},\39\\{pdf\_dest\_node})$;\6
$\\{primitive}(\.{"pdfthread"},\39\\{extension},\39\\{pdf\_thread\_node})$;\6
$\\{primitive}(\.{"pdfstartthread"},\39\\{extension},\39\\{pdf\_start\_thread%
\_node})$;\6
$\\{primitive}(\.{"pdfendthread"},\39\\{extension},\39\\{pdf\_end\_thread%
\_node})$;\6
$\\{primitive}(\.{"pdfsavepos"},\39\\{extension},\39\\{pdf\_save\_pos\_node})$;%
\6
$\\{primitive}(\.{"pdfsnaprefpoint"},\39\\{extension},\39\\{pdf\_snap\_ref%
\_point\_node})$;\6
$\\{primitive}(\.{"pdfsnapy"},\39\\{extension},\39\\{pdf\_snapy\_node})$;\6
$\\{primitive}(\.{"pdfsnapycomp"},\39\\{extension},\39\\{pdf\_snapy\_comp%
\_node})$;\6
$\\{primitive}(\.{"pdfinfo"},\39\\{extension},\39\\{pdf\_info\_code})$;\6
$\\{primitive}(\.{"pdfcatalog"},\39\\{extension},\39\\{pdf\_catalog\_code})$;\6
$\\{primitive}(\.{"pdfnames"},\39\\{extension},\39\\{pdf\_names\_code})$;\6
$\\{primitive}(\.{"pdfincludechars"},\39\\{extension},\39\\{pdf\_include\_chars%
\_code})$;\6
$\\{primitive}(\.{"pdffontattr"},\39\\{extension},\39\\{pdf\_font\_attr%
\_code})$;\6
$\\{primitive}(\.{"pdfmapfile"},\39\\{extension},\39\\{pdf\_map\_file\_code})$;%
\6
$\\{primitive}(\.{"pdfmapline"},\39\\{extension},\39\\{pdf\_map\_line\_code})$;%
\6
$\\{primitive}(\.{"pdftrailer"},\39\\{extension},\39\\{pdf\_trailer\_code})$;\6
$\\{primitive}(\.{"pdftrailerid"},\39\\{extension},\39\\{pdf\_trailer\_id%
\_code})$;\6
$\\{primitive}(\.{"pdfresettimer"},\39\\{extension},\39\\{reset\_timer%
\_code})$;\6
$\\{primitive}(\.{"pdfsetrandomseed"},\39\\{extension},\39\\{set\_random\_seed%
\_code})$;\6
$\\{primitive}(\.{"pdffontexpand"},\39\\{extension},\39\\{pdf\_font\_expand%
\_code})$;\6
$\\{primitive}(\.{"pdfglyphtounicode"},\39\\{extension},\39\\{pdf\_glyph\_to%
\_unicode\_code})$;\6
$\\{primitive}(\.{"pdfnobuiltintounicode"},\39\\{extension},\39\\{pdf%
\_nobuiltin\_tounicode\_code})$;\6
$\\{primitive}(\.{"pdfinterwordspaceon"},\39\\{extension},\39\\{pdf\_interword%
\_space\_on\_node})$;\6
$\\{primitive}(\.{"pdfinterwordspaceoff"},\39\\{extension},\39\\{pdf\_interword%
\_space\_off\_node})$;\6
$\\{primitive}(\.{"pdffakespace"},\39\\{extension},\39\\{pdf\_fake\_space%
\_node})$;\6
$\\{primitive}(\.{"pdfrunninglinkoff"},\39\\{extension},\39\\{pdf\_running%
\_link\_off\_node})$;\6
$\\{primitive}(\.{"pdfrunninglinkon"},\39\\{extension},\39\\{pdf\_running\_link%
\_on\_node})$;\6
$\\{primitive}(\.{"pdfspacefont"},\39\\{extension},\39\\{pdf\_space\_font%
\_code})$;\par
\fi

\M1525. The variable \\{write\_loc} just introduced is used to provide an
appropriate error message in case of ``runaway'' write texts.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{write\_loc}: \37\\{pointer};\C{\\{eqtb} address of \.{\\write}}\par
\fi

\M1526. \P$\X245:Cases of \\{print\_cmd\_chr} for symbolic printing of
primitives\X\mathrel{+}\S$\6
\4\\{extension}: \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{open\_node}: \37$\\{print\_esc}(\.{"openout"})$;\6
\4\\{write\_node}: \37$\\{print\_esc}(\.{"write"})$;\6
\4\\{close\_node}: \37$\\{print\_esc}(\.{"closeout"})$;\6
\4\\{special\_node}: \37$\\{print\_esc}(\.{"special"})$;\6
\4\\{immediate\_code}: \37$\\{print\_esc}(\.{"immediate"})$;\6
\4\\{set\_language\_code}: \37$\\{print\_esc}(\.{"setlanguage"})$;\6
\4\\{pdf\_annot\_node}: \37$\\{print\_esc}(\.{"pdfannot"})$;\6
\4\\{pdf\_catalog\_code}: \37$\\{print\_esc}(\.{"pdfcatalog"})$;\6
\4\\{pdf\_dest\_node}: \37$\\{print\_esc}(\.{"pdfdest"})$;\6
\4\\{pdf\_end\_link\_node}: \37$\\{print\_esc}(\.{"pdfendlink"})$;\6
\4\\{pdf\_end\_thread\_node}: \37$\\{print\_esc}(\.{"pdfendthread"})$;\6
\4\\{pdf\_font\_attr\_code}: \37$\\{print\_esc}(\.{"pdffontattr"})$;\6
\4\\{pdf\_font\_expand\_code}: \37$\\{print\_esc}(\.{"pdffontexpand"})$;\6
\4\\{pdf\_include\_chars\_code}: \37$\\{print\_esc}(\.{"pdfincludechars"})$;\6
\4\\{pdf\_info\_code}: \37$\\{print\_esc}(\.{"pdfinfo"})$;\6
\4\\{pdf\_literal\_node}: \37$\\{print\_esc}(\.{"pdfliteral"})$;\6
\4\\{pdf\_colorstack\_node}: \37$\\{print\_esc}(\.{"pdfcolorstack"})$;\6
\4\\{pdf\_setmatrix\_node}: \37$\\{print\_esc}(\.{"pdfsetmatrix"})$;\6
\4\\{pdf\_save\_node}: \37$\\{print\_esc}(\.{"pdfsave"})$;\6
\4\\{pdf\_restore\_node}: \37$\\{print\_esc}(\.{"pdfrestore"})$;\6
\4\\{pdf\_map\_file\_code}: \37$\\{print\_esc}(\.{"pdfmapfile"})$;\6
\4\\{pdf\_map\_line\_code}: \37$\\{print\_esc}(\.{"pdfmapline"})$;\6
\4\\{pdf\_names\_code}: \37$\\{print\_esc}(\.{"pdfnames"})$;\6
\4\\{pdf\_obj\_code}: \37$\\{print\_esc}(\.{"pdfobj"})$;\6
\4\\{pdf\_outline\_code}: \37$\\{print\_esc}(\.{"pdfoutline"})$;\6
\4\\{pdf\_refobj\_node}: \37$\\{print\_esc}(\.{"pdfrefobj"})$;\6
\4\\{pdf\_refxform\_node}: \37$\\{print\_esc}(\.{"pdfrefxform"})$;\6
\4\\{pdf\_refximage\_node}: \37$\\{print\_esc}(\.{"pdfrefximage"})$;\6
\4\\{pdf\_save\_pos\_node}: \37$\\{print\_esc}(\.{"pdfsavepos"})$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37$\\{print\_esc}(\.{"pdfsnaprefpoint"})$;\6
\4\\{pdf\_snapy\_comp\_node}: \37$\\{print\_esc}(\.{"pdfsnapycomp"})$;\6
\4\\{pdf\_snapy\_node}: \37$\\{print\_esc}(\.{"pdfsnapy"})$;\6
\4\\{pdf\_start\_link\_node}: \37$\\{print\_esc}(\.{"pdfstartlink"})$;\6
\4\\{pdf\_start\_thread\_node}: \37$\\{print\_esc}(\.{"pdfstartthread"})$;\6
\4\\{pdf\_thread\_node}: \37$\\{print\_esc}(\.{"pdfthread"})$;\6
\4\\{pdf\_trailer\_code}: \37$\\{print\_esc}(\.{"pdftrailer"})$;\6
\4\\{pdf\_trailer\_id\_code}: \37$\\{print\_esc}(\.{"pdftrailerid"})$;\6
\4\\{pdf\_xform\_code}: \37$\\{print\_esc}(\.{"pdfxform"})$;\6
\4\\{pdf\_ximage\_code}: \37$\\{print\_esc}(\.{"pdfximage"})$;\6
\4\\{reset\_timer\_code}: \37$\\{print\_esc}(\.{"pdfresettimer"})$;\6
\4\\{set\_random\_seed\_code}: \37$\\{print\_esc}(\.{"pdfsetrandomseed"})$;\6
\4\\{pdf\_nobuiltin\_tounicode\_code}: \37$\\{print\_esc}(%
\.{"pdfnobuiltintounicode"})$;\6
\4\\{pdf\_glyph\_to\_unicode\_code}: \37$\\{print\_esc}(%
\.{"pdfglyphtounicode"})$;\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\\{print\_esc}(%
\.{"pdfinterwordspaceon"})$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\\{print\_esc}(%
\.{"pdfinterwordspaceoff"})$;\6
\4\\{pdf\_fake\_space\_node}: \37$\\{print\_esc}(\.{"pdffakespace"})$;\6
\4\\{pdf\_running\_link\_off\_node}: \37$\\{print\_esc}(%
\.{"pdfrunninglinkoff"})$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\\{print\_esc}(%
\.{"pdfrunninglinkon"})$;\6
\4\\{pdf\_space\_font\_code}: \37$\\{print\_esc}(\.{"pdfspacefont"})$;\6
\4\&{othercases} \37$\\{print}(\.{"[unknown\ extension!]"})$\2\6
\&{endcases};\par
\fi

\M1527. When an \\{extension} command occurs in \\{main\_control}, in any mode,
the \\{do\_extension} routine is called.

\Y\P$\4\X1527:Cases of \\{main\_control} that are for extensions to \TeX\X\S$\6
\4$\\{any\_mode}(\\{extension})$: \37\\{do\_extension};\par
\U1223.\fi

\M1528. \P$\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\hbox{\4}\X1529:Declare procedures needed in \\{do\_extension}\X\6
\4\&{procedure}\1\  \37\\{do\_extension};\6
\4\&{var} \37$\|i,\39\|j,\39\|k$: \37\\{integer};\C{all-purpose integers}\6
$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{all-purpose pointers}\2\6
\&{begin} \37\&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{open\_node}: \37\X1531:Implement \.{\\openout}\X;\6
\4\\{write\_node}: \37\X1532:Implement \.{\\write}\X;\6
\4\\{close\_node}: \37\X1533:Implement \.{\\closeout}\X;\6
\4\\{special\_node}: \37\X1534:Implement \.{\\special}\X;\6
\4\\{immediate\_code}: \37\X1623:Implement \.{\\immediate}\X;\6
\4\\{set\_language\_code}: \37\X1625:Implement \.{\\setlanguage}\X;\6
\4\\{pdf\_annot\_node}: \37\X1558:Implement \.{\\pdfannot}\X;\6
\4\\{pdf\_catalog\_code}: \37\X1579:Implement \.{\\pdfcatalog}\X;\6
\4\\{pdf\_dest\_node}: \37\X1565:Implement \.{\\pdfdest}\X;\6
\4\\{pdf\_end\_link\_node}: \37\X1561:Implement \.{\\pdfendlink}\X;\6
\4\\{pdf\_end\_thread\_node}: \37\X1569:Implement \.{\\pdfendthread}\X;\6
\4\\{pdf\_font\_attr\_code}: \37\X1589:Implement \.{\\pdffontattr}\X;\6
\4\\{pdf\_font\_expand\_code}: \37\X1535:Implement \.{\\pdffontexpand}\X;\6
\4\\{pdf\_include\_chars\_code}: \37\X1588:Implement \.{\\pdfincludechars}\X;\6
\4\\{pdf\_info\_code}: \37\X1578:Implement \.{\\pdfinfo}\X;\6
\4\\{pdf\_literal\_node}: \37\X1538:Implement \.{\\pdfliteral}\X;\6
\4\\{pdf\_colorstack\_node}: \37\X1539:Implement \.{\\pdfcolorstack}\X;\6
\4\\{pdf\_setmatrix\_node}: \37\X1540:Implement \.{\\pdfsetmatrix}\X;\6
\4\\{pdf\_save\_node}: \37\X1541:Implement \.{\\pdfsave}\X;\6
\4\\{pdf\_restore\_node}: \37\X1542:Implement \.{\\pdfrestore}\X;\6
\4\\{pdf\_map\_file\_code}: \37\X1590:Implement \.{\\pdfmapfile}\X;\6
\4\\{pdf\_map\_line\_code}: \37\X1591:Implement \.{\\pdfmapline}\X;\6
\4\\{pdf\_names\_code}: \37\X1580:Implement \.{\\pdfnames}\X;\6
\4\\{pdf\_obj\_code}: \37\X1544:Implement \.{\\pdfobj}\X;\6
\4\\{pdf\_outline\_code}: \37\X1563:Implement \.{\\pdfoutline}\X;\6
\4\\{pdf\_refobj\_node}: \37\X1546:Implement \.{\\pdfrefobj}\X;\6
\4\\{pdf\_refxform\_node}: \37\X1549:Implement \.{\\pdfrefxform}\X;\6
\4\\{pdf\_refximage\_node}: \37\X1554:Implement \.{\\pdfrefximage}\X;\6
\4\\{pdf\_save\_pos\_node}: \37\X1576:Implement \.{\\pdfsavepos}\X;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37\X1572:Implement \.{\\pdfsnaprefpoint}\X;%
\6
\4\\{pdf\_snapy\_comp\_node}: \37\X1575:Implement \.{\\pdfsnapycomp}\X;\6
\4\\{pdf\_snapy\_node}: \37\X1574:Implement \.{\\pdfsnapy}\X;\6
\4\\{pdf\_start\_link\_node}: \37\X1560:Implement \.{\\pdfstartlink}\X;\6
\4\\{pdf\_start\_thread\_node}: \37\X1568:Implement \.{\\pdfstartthread}\X;\6
\4\\{pdf\_thread\_node}: \37\X1567:Implement \.{\\pdfthread}\X;\6
\4\\{pdf\_trailer\_code}: \37\X1581:Implement \.{\\pdftrailer}\X;\6
\4\\{pdf\_trailer\_id\_code}: \37\X1582:Implement \.{\\pdftrailerid}\X;\6
\4\\{pdf\_xform\_code}: \37\X1548:Implement \.{\\pdfxform}\X;\6
\4\\{pdf\_ximage\_code}: \37\X1553:Implement \.{\\pdfximage}\X;\6
\4\\{reset\_timer\_code}: \37\X1586:Implement \.{\\pdfresettimer}\X;\6
\4\\{set\_random\_seed\_code}: \37\X1585:Implement \.{\\pdfsetrandomseed}\X;\6
\4\\{pdf\_glyph\_to\_unicode\_code}: \37\X1592:Implement \.{%
\\pdfglyphtounicode}\X;\6
\4\\{pdf\_nobuiltin\_tounicode\_code}: \37\X1593:Implement \.{%
\\pdfnobuiltintounicode}\X;\6
\4\\{pdf\_interword\_space\_on\_node}: \37\X1594:Implement \.{%
\\pdfinterwordspaceon}\X;\6
\4\\{pdf\_interword\_space\_off\_node}: \37\X1595:Implement \.{%
\\pdfinterwordspaceoff}\X;\6
\4\\{pdf\_fake\_space\_node}: \37\X1596:Implement \.{\\pdffakespace}\X;\6
\4\\{pdf\_running\_link\_off\_node}: \37\X1597:Implement \.{%
\\pdfrunninglinkoff}\X;\6
\4\\{pdf\_running\_link\_on\_node}: \37\X1598:Implement \.{\\pdfrunninglinkon}%
\X;\6
\4\\{pdf\_space\_font\_code}: \37\X1599:Implement \.{\\pdfspacefont}\X;\6
\4\&{othercases} \37$\\{confusion}(\.{"ext1"})$\2\6
\&{endcases};\6
\&{end};\par
\fi

\M1529. Here is a subroutine that creates a whatsit node having a given %
\\{subtype}
and a given number of words. It initializes only the first word of the whatsit,
and appends it to the current list.

\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\S$\6
\4\&{procedure}\1\  \37$\\{new\_whatsit}(\|s:\\{small\_number};\,\35\|w:%
\\{small\_number})$;\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\|w)$;\5
$\\{type}(\|p)\K\\{whatsit\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\5
$\\{link}(\\{tail})\K\|p$;\5
$\\{tail}\K\|p$;\6
\&{end};\par
\As1530, 1537, 1552, 1556, 1562, 1566, 1573, 1577, 1587\ETs1600.
\U1528.\fi

\M1530. The next subroutine uses \\{cur\_chr} to decide what sort of whatsit is
involved, and also inserts a \\{write\_stream} number.

\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{new\_write\_whatsit}(\|w:\\{small\_number})$;\2\6
\&{begin} \37$\\{new\_whatsit}(\\{cur\_chr},\39\|w)$;\6
\&{if} $\|w\I\\{write\_node\_size}$ \1\&{then}\5
\\{scan\_four\_bit\_int}\6
\4\&{else} \&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\5
$\\{cur\_val}\K17$\6
\4\&{else} \&{if} $\\{cur\_val}>15$ \1\&{then}\5
$\\{cur\_val}\K16$;\2\2\6
\&{end};\2\6
$\\{write\_stream}(\\{tail})\K\\{cur\_val}$;\6
\&{end};\par
\fi

\M1531. \P$\X1531:Implement \.{\\openout}\X\S$\6
\&{begin} \37$\\{new\_write\_whatsit}(\\{open\_node\_size})$;\5
\\{scan\_optional\_equals};\5
\\{scan\_file\_name};\6
$\\{open\_name}(\\{tail})\K\\{cur\_name}$;\5
$\\{open\_area}(\\{tail})\K\\{cur\_area}$;\5
$\\{open\_ext}(\\{tail})\K\\{cur\_ext}$;\6
\&{end}\par
\U1528.\fi

\M1532. When `\.{\\write 12\{...\}}' appears, we scan the token list `\.{\{...%
\}}'
without expanding its macros; the macros will be expanded later when this
token list is rescanned.

\Y\P$\4\X1532:Implement \.{\\write}\X\S$\6
\&{begin} \37$\|k\K\\{cur\_cs}$;\5
$\\{new\_write\_whatsit}(\\{write\_node\_size})$;\6
$\\{cur\_cs}\K\|k$;\5
$\|p\K\\{scan\_toks}(\\{false},\39\\{false})$;\5
$\\{write\_tokens}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\par
\U1528.\fi

\M1533. \P$\X1533:Implement \.{\\closeout}\X\S$\6
\&{begin} \37$\\{new\_write\_whatsit}(\\{write\_node\_size})$;\5
$\\{write\_tokens}(\\{tail})\K\\{null}$;\6
\&{end}\par
\U1528.\fi

\M1534. When `\.{\\special\{...\}}' appears, we expand the macros in the token
list as in \.{\\xdef} and \.{\\mark}.  When marked with \.{shipout}, we keep
tokens unexpanded for now.

Unfortunately, the $\\{write\_stream}(\\{tail})\K\\{null}$ done here is not a
valid
assignment in Web2C, because \\{null} (a.k.a.\ \\{min\_halfword}) is a large
negative number ($-268435455 = -\H{FFFFFFF}$, set in \.{tex.ch}); too
large to fit in the {\bf short} structure element that's being assigned.
The warning from gcc~8.5.0 was:

\.{pdftex0.c: In function 'doextension':}
\.{pdftex0.c:37849:40: warning: overflow in conversion from 'long int' to
'short int'}
\.{changes value from '-268435455' to '1' [-Woverflow]}\hfil\break
\.{  mem [curlist .tailfield + 1 ].hh.b0 = -268435455L ;}

The correct thing to do is not immediately evident. However, for Web2C,
it does not matter, because these lines are changed for enc\TeX, in
\.{enctex2.ch}, and now zero is assigned, instead of \\{null}.

\Y\P$\4\X1534:Implement \.{\\special}\X\S$\6
\&{begin} \37\&{if} $\\{scan\_keyword}(\.{"shipout"})$ \1\&{then}\6
\&{begin} \37$\\{new\_whatsit}(\\{latespecial\_node},\39\\{write\_node%
\_size})$;\5
$\\{write\_stream}(\\{tail})\K\\{null}$;\5
$\|p\K\\{scan\_toks}(\\{false},\39\\{false})$;\5
$\\{write\_tokens}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{new\_whatsit}(\\{special\_node},\39\\{write\_node%
\_size})$;\5
$\\{write\_stream}(\\{tail})\K\\{null}$;\5
$\|p\K\\{scan\_toks}(\\{false},\39\\{true})$;\5
$\\{write\_tokens}(\\{tail})\K\\{def\_ref}$;\6
\&{end};\2\6
\&{end}\par
\U1528.\fi

\M1535. \P$\X1535:Implement \.{\\pdffontexpand}\X\S$\6
\\{read\_expand\_font}\par
\U1528.\fi

\M1536. The following macros are needed for further manipulation with whatsit
nodes
for \pdfTeX{} extensions (copying, destroying, etc.).

\Y\P\D \37$\\{add\_action\_ref}(\#)\S\\{incr}(\\{pdf\_action\_refcount}(\#))$%
\C{increase count of references to this action}\par
\P\D \37$\\{delete\_action\_ref}(\#)\S$\C{decrease count of references to this
action; free it if there is no reference to this action}\6
\&{begin} \37\&{if} $\\{pdf\_action\_refcount}(\#)=\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_action\_type}(\#)=\\{pdf\_action\_user}$ \1%
\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_action\_user\_tokens}(\#))$\6
\4\&{else} \&{begin} \37\&{if} $\\{pdf\_action\_file}(\#)\I\\{null}$ \1\&{then}%
\5
$\\{delete\_token\_ref}(\\{pdf\_action\_file}(\#))$;\2\6
\&{if} $\\{pdf\_action\_type}(\#)=\\{pdf\_action\_page}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_action\_page\_tokens}(\#))$\6
\4\&{else} \&{if} $(\\{pdf\_action\_named\_id}(\#)\W1)=1$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_action\_id}(\#))$;\2\2\6
\&{if} $(\\{pdf\_action\_named\_id}(\#)\W2)=2$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_action\_struct\_id}(\#))$;\2\6
\&{end};\2\6
$\\{free\_node}(\#,\39\\{pdf\_action\_size})$;\6
\&{end}\6
\4\&{else} $\\{decr}(\\{pdf\_action\_refcount}(\#))$;\2\6
\&{end}\par
\fi

\M1537. We have to check whether \.{\\pdfoutput} is set for using \pdfTeX{}
extensions.
\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{check\_pdfoutput}(\|s:\\{str\_number};\,\35\\{is%
\_error}:\\{boolean})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_output}\L0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{is\_error}$ \1\&{then}\5
$\\{pdf\_error}(\|s,\39\.{"not\ allowed\ in\ DVI\ mode\ (\\pdfoutput\ <=\
0)"})$\6
\4\&{else} $\\{pdf\_warning}(\|s,\39\.{"not\ allowed\ in\ DVI\ mode\ (%
\\pdfoutput\ <=\ 0);\ ignoring\ it"},\39\\{true},\39\\{true})$;\2\6
\&{end}\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{scan\_pdf\_ext\_toks};\2\6
\&{begin} \37$\\{call\_func}(\\{scan\_toks}(\\{false},\39\\{true}))$;\C{like %
\.{\\special}}\6
\&{end};\6
\4\&{procedure}\1\  \37\\{scan\_pdf\_ext\_late\_toks};\2\6
\&{begin} \37$\\{call\_func}(\\{scan\_toks}(\\{false},\39\\{false}))$;\C{like %
\.{\\special}, but doesn't expand}\6
\&{end};\6
\4\&{procedure}\1\  \37\\{compare\_strings};\C{to implement \.{\\pdfstrcmp}}\6
\4\&{label} \37\\{done};\6
\4\&{var} \37$\\{s1},\39\\{s2}$: \37\\{str\_number};\5
$\\{i1},\39\\{i2},\39\\{j1},\39\\{j2}$: \37\\{pool\_pointer};\5
\\{save\_cur\_cs}: \37\\{pointer};\2\6
\&{begin} \37$\\{save\_cur\_cs}\K\\{cur\_cs}$;\5
$\\{call\_func}(\\{scan\_toks}(\\{false},\39\\{true}))$;\5
$\\{s1}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{cur\_cs}\K\\{save\_cur\_cs}$;\5
$\\{call\_func}(\\{scan\_toks}(\\{false},\39\\{true}))$;\5
$\\{s2}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{i1}\K\\{str\_start}[\\{s1}]$;\5
$\\{j1}\K\\{str\_start}[\\{s1}+1]$;\5
$\\{i2}\K\\{str\_start}[\\{s2}]$;\5
$\\{j2}\K\\{str\_start}[\\{s2}+1]$;\6
\&{while} $(\\{i1}<\\{j1})\W(\\{i2}<\\{j2})$ \1\&{do}\6
\&{begin} \37\&{if} $\\{str\_pool}[\\{i1}]<\\{str\_pool}[\\{i2}]$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K-1$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
\&{if} $\\{str\_pool}[\\{i1}]>\\{str\_pool}[\\{i2}]$ \1\&{then}\6
\&{begin} \37$\\{cur\_val}\K1$;\5
\&{goto} \37\\{done};\6
\&{end};\2\6
$\\{incr}(\\{i1})$;\5
$\\{incr}(\\{i2})$;\6
\&{end};\2\6
\&{if} $(\\{i1}=\\{j1})\W(\\{i2}=\\{j2})$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} \&{if} $\\{i1}<\\{j1}$ \1\&{then}\5
$\\{cur\_val}\K1$\6
\4\&{else} $\\{cur\_val}\K-1$;\2\2\6
\4\\{done}: \37$\\{flush\_str}(\\{s2})$;\5
$\\{flush\_str}(\\{s1})$;\5
$\\{cur\_val\_level}\K\\{int\_val}$;\6
\&{end};\par
\fi

\M1538. \P$\X1538:Implement \.{\\pdfliteral}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfliteral"},\39\\{true})$;\6
\&{if} $\\{scan\_keyword}(\.{"shipout"})$ \1\&{then}\5
$\|k\K\\{pdf\_lateliteral\_node}$\6
\4\&{else} $\|k\K\\{pdf\_literal\_node}$;\2\6
$\\{new\_whatsit}(\|k,\39\\{write\_node\_size})$;\6
\&{if} $\\{scan\_keyword}(\.{"direct"})$ \1\&{then}\5
$\\{pdf\_literal\_mode}(\\{tail})\K\\{direct\_always}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"page"})$ \1\&{then}\5
$\\{pdf\_literal\_mode}(\\{tail})\K\\{direct\_page}$\6
\4\&{else} $\\{pdf\_literal\_mode}(\\{tail})\K\\{set\_origin}$;\2\2\6
\&{if} $\|k=\\{pdf\_literal\_node}$ \1\&{then}\5
\\{scan\_pdf\_ext\_toks}\6
\4\&{else} \\{scan\_pdf\_ext\_late\_toks};\2\6
$\\{pdf\_literal\_data}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\par
\U1528.\fi

\M1539. \P$\X1539:Implement \.{\\pdfcolorstack}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfcolorstack"},\39\\{true})$;\C{Scan
and check the stack number and store in \\{cur\_val}}\6
\\{scan\_int};\6
\&{if} $\\{cur\_val}\G\\{colorstackused}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Unknown\ color\ stack\ number\ "})$;\5
$\\{print\_int}(\\{cur\_val})$;\5
$\\{help3}(\.{"Allocate\ and\ initialize\ a\ color\ stack\ with\ %
\\\\pdfcolorstackinit."})$\6
$(\.{"I\'ll\ use\ default\ color\ stack\ 0\ here."})$\6
$(\.{"Proceed,\ with\ fingers\ crossed."})$;\5
\\{error};\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Invalid\ negative\ color\ stack\ number"})$;\5
$\\{help2}(\.{"I\'ll\ use\ default\ color\ stack\ 0\ here."})$\6
$(\.{"Proceed,\ with\ fingers\ crossed."})$;\5
\\{error};\5
$\\{cur\_val}\K0$;\6
\&{end};\C{Scan the command and store in i, j holds the node size}\2\6
\&{if} $\\{scan\_keyword}(\.{"set"})$ \1\&{then}\6
\&{begin} \37$\|i\K\\{colorstack\_set}$;\5
$\|j\K\\{pdf\_colorstack\_setter\_node\_size}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"push"})$ \1\&{then}\6
\&{begin} \37$\|i\K\\{colorstack\_push}$;\5
$\|j\K\\{pdf\_colorstack\_setter\_node\_size}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"pop"})$ \1\&{then}\6
\&{begin} \37$\|i\K\\{colorstack\_pop}$;\5
$\|j\K\\{pdf\_colorstack\_getter\_node\_size}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"current"})$ \1\&{then}\6
\&{begin} \37$\|i\K\\{colorstack\_current}$;\5
$\|j\K\\{pdf\_colorstack\_getter\_node\_size}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|i\K-1$;\C{error}\6
\&{end};\2\2\2\2\6
\&{if} $\|i\G0$ \1\&{then}\6
\&{begin} \37$\\{new\_whatsit}(\\{pdf\_colorstack\_node},\39\|j)$;\5
$\\{pdf\_colorstack\_stack}(\\{tail})\K\\{cur\_val}$;\5
$\\{pdf\_colorstack\_cmd}(\\{tail})\K\|i$;\6
\&{if} $\|i\L\\{colorstack\_data}$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_colorstack\_data}(\\{tail})\K\\{def\_ref}$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Color\ stack\ action\ is\
missing"})$;\5
$\\{help3}(\.{"The\ expected\ actions\ for\ \\pdfcolorstack:"})$\6
$(\.{"\ \ \ \ set,\ push,\ pop,\ current"})$\6
$(\.{"I\'ll\ ignore\ the\ color\ stack\ command."})$;\5
\\{error};\6
\&{end}\2\6
\&{end}\par
\U1528.\fi

\M1540. \P$\X1540:Implement \.{\\pdfsetmatrix}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfsetmatrix"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_setmatrix\_node},\39\\{pdf\_setmatrix\_node\_size})$;%
\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_setmatrix\_data}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\par
\U1528.\fi

\M1541. \P$\X1541:Implement \.{\\pdfsave}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfsave"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_save\_node},\39\\{pdf\_save\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1542. \P$\X1542:Implement \.{\\pdfrestore}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrestore"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_restore\_node},\39\\{pdf\_restore\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1543. The \.{\\pdfobj} primitive is used to create a ``raw'' object in the
PDF
output file. The object contents will be hold in memory and will be written
out only when the object is referenced by \.{\\pdfrefobj}. When \.{\\pdfobj}
is used with \.{\\immediate}, the object contents will be written out
immediately. Objects referenced in the current page are appended into
\\{pdf\_obj\_list}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_obj}: \37\\{integer};\par
\fi

\M1544. \P$\X1544:Implement \.{\\pdfobj}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfobj"},\39\\{true})$;\6
\&{if} $\\{scan\_keyword}(\.{"reserveobjnum"})$ \1\&{then}\6
\&{begin} \37\X469:Scan an optional space\X;\6
$\\{incr}(\\{pdf\_obj\_count})$;\5
$\\{pdf\_create\_obj}(\\{obj\_type\_obj},\39\\{pdf\_obj\_count})$;\5
$\\{pdf\_last\_obj}\K\\{obj\_ptr}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|k\K-1$;\6
\&{if} $\\{scan\_keyword}(\.{"useobjnum"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\|k\K\\{cur\_val}$;\6
\&{if} $(\|k\L0)\V(\|k>\\{obj\_ptr})\V(\\{obj\_data\_ptr}(\|k)\I0)$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"\\pdfobj"},\39\.{"invalid\ object\ number\
being\ ignored"},\39\\{true},\39\\{true})$;\5
$\\{pdf\_retval}\K-1$;\C{signal the problem}\6
$\|k\K-1$;\C{will be generated again}\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\|k<0$ \1\&{then}\6
\&{begin} \37$\\{incr}(\\{pdf\_obj\_count})$;\5
$\\{pdf\_create\_obj}(\\{obj\_type\_obj},\39\\{pdf\_obj\_count})$;\5
$\|k\K\\{obj\_ptr}$;\6
\&{end};\2\6
$\\{obj\_data\_ptr}(\|k)\K\\{pdf\_get\_mem}(\\{pdfmem\_obj\_size})$;\6
\&{if} $\\{scan\_keyword}(\.{"stream"})$ \1\&{then}\6
\&{begin} \37$\\{obj\_obj\_is\_stream}(\|k)\K1$;\6
\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{obj\_obj\_stream\_attr}(\|k)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{obj\_obj\_stream\_attr}(\|k)\K\\{null}$;\2\6
\&{end}\6
\4\&{else} $\\{obj\_obj\_is\_stream}(\|k)\K0$;\2\6
\&{if} $\\{scan\_keyword}(\.{"file"})$ \1\&{then}\5
$\\{obj\_obj\_is\_file}(\|k)\K1$\6
\4\&{else} $\\{obj\_obj\_is\_file}(\|k)\K0$;\2\6
\\{scan\_pdf\_ext\_toks};\5
$\\{obj\_obj\_data}(\|k)\K\\{def\_ref}$;\5
$\\{pdf\_last\_obj}\K\|k$;\6
\&{end};\2\6
\&{end}\par
\U1528.\fi

\M1545. We need to check whether the referenced object exists.

\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{prev\_rightmost}(\|s,\39\|e:\\{pointer})$: \37%
\\{pointer};\C{finds the node preceding the rightmost node \|e; \|s is some
node before \|e}\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37$\\{prev\_rightmost}\K\\{null}$;\5
$\|p\K\|s$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{while} $\\{link}(\|p)\I\|e$ \1\&{do}\6
\&{begin} \37$\|p\K\\{link}(\|p)$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{end};\2\6
$\\{prev\_rightmost}\K\|p$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_check\_obj}(\|t,\39\|n:\\{integer})$;\6
\4\&{var} \37\|k: \37\\{integer};\2\6
\&{begin} \37$\|k\K\\{head\_tab}[\|t]$;\6
\&{while} $(\|k\I0)\W(\|k\I\|n)$ \1\&{do}\5
$\|k\K\\{obj\_link}(\|k)$;\2\6
\&{if} $\|k=0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"cannot\ find\ referenced\ object"})$;\2\6
\&{end};\par
\fi

\M1546. \P$\X1546:Implement \.{\\pdfrefobj}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrefobj"},\39\\{true})$;\5
\\{scan\_int};\5
$\\{pdf\_check\_obj}(\\{obj\_type\_obj},\39\\{cur\_val})$;\5
$\\{new\_whatsit}(\\{pdf\_refobj\_node},\39\\{pdf\_refobj\_node\_size})$;\5
$\\{pdf\_obj\_objnum}(\\{tail})\K\\{cur\_val}$;\6
\&{end}\par
\U1528.\fi

\M1547. \.{\\pdfxform} and \.{\\pdfrefxform} are similar to \.{\\pdfobj} and
\.{\\pdfrefobj}.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_xform}: \37\\{integer};\par
\fi

\M1548. \P$\X1548:Implement \.{\\pdfxform}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfxform"},\39\\{true})$;\5
$\\{incr}(\\{pdf\_xform\_count})$;\5
$\\{pdf\_create\_obj}(\\{obj\_type\_xform},\39\\{pdf\_xform\_count})$;\5
$\|k\K\\{obj\_ptr}$;\5
$\\{obj\_data\_ptr}(\|k)\K\\{pdf\_get\_mem}(\\{pdfmem\_xform\_size})$;\6
\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{obj\_xform\_attr}(\|k)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{obj\_xform\_attr}(\|k)\K\\{null}$;\2\6
\&{if} $\\{scan\_keyword}(\.{"resources"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{obj\_xform\_resources}(\|k)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{obj\_xform\_resources}(\|k)\K\\{null}$;\2\6
\\{scan\_register\_num};\5
$\\{fetch\_box}(\|p)$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"\\pdfxform\ cannot\ be\ used\ with\ a\ void\
box"})$;\2\6
$\\{obj\_xform\_width}(\|k)\K\\{width}(\|p)$;\5
$\\{obj\_xform\_height}(\|k)\K\\{height}(\|p)$;\5
$\\{obj\_xform\_depth}(\|k)\K\\{depth}(\|p)$;\5
$\\{obj\_xform\_box}(\|k)\K\|p$;\C{save pointer to the box}\6
$\\{change\_box}(\\{null})$;\5
$\\{pdf\_last\_xform}\K\|k$;\6
\&{end}\par
\U1528.\fi

\M1549. \P$\X1549:Implement \.{\\pdfrefxform}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrefxform"},\39\\{true})$;\5
\\{scan\_int};\5
$\\{pdf\_check\_obj}(\\{obj\_type\_xform},\39\\{cur\_val})$;\5
$\\{new\_whatsit}(\\{pdf\_refxform\_node},\39\\{pdf\_refxform\_node\_size})$;\5
$\\{pdf\_xform\_objnum}(\\{tail})\K\\{cur\_val}$;\5
$\\{pdf\_width}(\\{tail})\K\\{obj\_xform\_width}(\\{cur\_val})$;\5
$\\{pdf\_height}(\\{tail})\K\\{obj\_xform\_height}(\\{cur\_val})$;\5
$\\{pdf\_depth}(\\{tail})\K\\{obj\_xform\_depth}(\\{cur\_val})$;\6
\&{end}\par
\U1528.\fi

\M1550. \.{\\pdfximage} and \.{\\pdfrefximage} are similar to \.{\\pdfxform}
and
\.{\\pdfrefxform}. As we have to scan $<\\{rule}\\{spec}>$ quite often, it is
better
have a \\{rule\_node} that holds the most recently scanned $<\\{rule}%
\\{spec}>$.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_ximage}: \37\\{integer};\6
\4\\{pdf\_last\_ximage\_pages}: \37\\{integer};\6
\4\\{pdf\_last\_ximage\_colordepth}: \37\\{integer};\6
\4\\{alt\_rule}: \37\\{pointer};\6
\4\\{warn\_pdfpagebox}: \37\\{boolean};\par
\fi

\M1551. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{alt\_rule}\K\\{null}$;\5
$\\{warn\_pdfpagebox}\K\\{true}$;\par
\fi

\M1552. \P$\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37$\\{scale\_image}(\|n:\\{integer})$;\6
\4\&{var} \37$\|x,\39\|y,\39\\{xr},\39\\{yr}$: \37\\{integer};\C{size and
resolution of image}\6
$\|w,\39\|h$: \37\\{scaled};\C{indeed size corresponds to image resolution}\6
\\{default\_res}: \37\\{integer};\5
\\{image}: \37\\{integer};\2\6
\&{begin} \37$\\{image}\K\\{obj\_ximage\_data}(\|n)$;\6
\&{if} $(\\{image\_rotate}(\\{image})=90)\V(\\{image\_rotate}(\\{image})=270)$ %
\1\&{then}\6
\&{begin} \37$\|y\K\\{image\_width}(\\{image})$;\5
$\|x\K\\{image\_height}(\\{image})$;\5
$\\{yr}\K\\{image\_x\_res}(\\{image})$;\5
$\\{xr}\K\\{image\_y\_res}(\\{image})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|x\K\\{image\_width}(\\{image})$;\5
$\|y\K\\{image\_height}(\\{image})$;\5
$\\{xr}\K\\{image\_x\_res}(\\{image})$;\5
$\\{yr}\K\\{image\_y\_res}(\\{image})$;\6
\&{end};\2\6
\&{if} $(\\{xr}>65535)\V(\\{yr}>65535)$ \1\&{then}\6
\&{begin} \37$\\{xr}\K0$;\5
$\\{yr}\K0$;\5
$\\{pdf\_warning}(\.{"ext1"},\39\.{"too\ large\ image\ resolution\ ignored"},%
\39\\{true},\39\\{true})$;\6
\&{end};\2\6
\&{if} $(\|x\L0)\V(\|y\L0)\V(\\{xr}<0)\V(\\{yr}<0)$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"invalid\ image\ dimensions"})$;\2\6
\&{if} $\\{is\_pdf\_image}(\\{image})$ \1\&{then}\6
\&{begin} \37$\|w\K\|x$;\5
$\|h\K\|y$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{default\_res}\K\\{fix\_int}(\\{pdf\_image%
\_resolution},\390,\3965535)$;\6
\&{if} $(\\{default\_res}>0)\W((\\{xr}=0)\V(\\{yr}=0))$ \1\&{then}\6
\&{begin} \37$\\{xr}\K\\{default\_res}$;\5
$\\{yr}\K\\{default\_res}$;\6
\&{end};\2\6
\&{if} $\\{is\_running}(\\{obj\_ximage\_width}(\|n))\W\\{is\_running}(\\{obj%
\_ximage\_height}(\|n))$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{xr}>0)\W(\\{yr}>0)$ \1\&{then}\6
\&{begin} \37$\|w\K\\{ext\_xn\_over\_d}(\\{one\_hundred\_inch},\39\|x,\39100%
\ast\\{xr})$;\5
$\|h\K\\{ext\_xn\_over\_d}(\\{one\_hundred\_inch},\39\|y,\39100\ast\\{yr})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|w\K\\{ext\_xn\_over\_d}(\\{one\_hundred\_inch},\39%
\|x,\397200)$;\5
$\|h\K\\{ext\_xn\_over\_d}(\\{one\_hundred\_inch},\39\|y,\397200)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\&{if} $\\{is\_running}(\\{obj\_ximage\_width}(\|n))\W\\{is\_running}(\\{obj%
\_ximage\_height}(\|n))\W\\{is\_running}(\\{obj\_ximage\_depth}(\|n))$ \1%
\&{then}\6
\&{begin} \37$\\{obj\_ximage\_width}(\|n)\K\|w$;\5
$\\{obj\_ximage\_height}(\|n)\K\|h$;\5
$\\{obj\_ximage\_depth}(\|n)\K0$;\6
\&{end}\6
\4\&{else} \&{if} $\\{is\_running}(\\{obj\_ximage\_width}(\|n))$ \1\&{then}\6
\&{begin} \37\C{image depth or height is explicitly specified}\6
\&{if} $\\{is\_running}(\\{obj\_ximage\_height}(\|n))$ \1\&{then}\6
\&{begin} \37\C{image depth is explicitly specified}\6
$\\{obj\_ximage\_width}(\|n)\K\\{ext\_xn\_over\_d}(\|h,\39\|x,\39\|y)$;\5
$\\{obj\_ximage\_height}(\|n)\K\|h-\\{obj\_ximage\_depth}(\|n)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{is\_running}(\\{obj\_ximage\_depth}(\|n))$ \1\&{then}\6
\&{begin} \37\C{image height is explicitly specified}\6
$\\{obj\_ximage\_width}(\|n)\K\\{ext\_xn\_over\_d}(\\{obj\_ximage\_height}(%
\|n),\39\|x,\39\|y)$;\5
$\\{obj\_ximage\_depth}(\|n)\K0$;\6
\&{end}\6
\4\&{else} \&{begin} \37\C{both image depth and height are explicitly
specified}\6
$\\{obj\_ximage\_width}(\|n)\K\\{ext\_xn\_over\_d}(\\{obj\_ximage\_height}(%
\|n)+\\{obj\_ximage\_depth}(\|n),\39\|x,\39\|y)$;\6
\&{end};\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37\C{image width is explicitly specified}\6
\&{if} $\\{is\_running}(\\{obj\_ximage\_height}(\|n))\W\\{is\_running}(\\{obj%
\_ximage\_depth}(\|n))$ \1\&{then}\6
\&{begin} \37\C{both image depth and height are not specified}\6
$\\{obj\_ximage\_height}(\|n)\K\\{ext\_xn\_over\_d}(\\{obj\_ximage\_width}(%
\|n),\39\|y,\39\|x)$;\5
$\\{obj\_ximage\_depth}(\|n)\K0$;\6
\&{end}\C{image depth is explicitly specified}\6
\4\&{else} \&{if} $\\{is\_running}(\\{obj\_ximage\_height}(\|n))$ \1\&{then}\6
\&{begin} \37$\\{obj\_ximage\_height}(\|n)\K\\{ext\_xn\_over\_d}(\\{obj\_ximage%
\_width}(\|n),\39\|y,\39\|x)-\\{obj\_ximage\_depth}(\|n)$;\6
\&{end}\C{image height is explicitly specified}\6
\4\&{else} \&{if} $\\{is\_running}(\\{obj\_ximage\_depth}(\|n))$ \1\&{then}\6
\&{begin} \37$\\{obj\_ximage\_depth}(\|n)\K0$;\6
\&{end}\C{both image depth and height are explicitly specified}\6
\4\&{else} \\{do\_nothing};\2\2\2\6
\&{end};\2\2\6
\&{end};\6
\4\&{function}\1\  \37\\{scan\_pdf\_box\_spec}: \37\\{integer};\C{scans PDF
pagebox specification}\2\6
\&{begin} \37$\\{scan\_pdf\_box\_spec}\K0$;\6
\&{if} $\\{scan\_keyword}(\.{"mediabox"})$ \1\&{then}\5
$\\{scan\_pdf\_box\_spec}\K\\{pdf\_box\_spec\_media}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"cropbox"})$ \1\&{then}\5
$\\{scan\_pdf\_box\_spec}\K\\{pdf\_box\_spec\_crop}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"bleedbox"})$ \1\&{then}\5
$\\{scan\_pdf\_box\_spec}\K\\{pdf\_box\_spec\_bleed}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"trimbox"})$ \1\&{then}\5
$\\{scan\_pdf\_box\_spec}\K\\{pdf\_box\_spec\_trim}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"artbox"})$ \1\&{then}\5
$\\{scan\_pdf\_box\_spec}\K\\{pdf\_box\_spec\_art}$\2\2\2\2\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{scan\_alt\_rule};\C{scans rule spec to \\{alt\_rule}}%
\6
\4\&{label} \37\\{reswitch};\2\6
\&{begin} \37\&{if} $\\{alt\_rule}=\\{null}$ \1\&{then}\5
$\\{alt\_rule}\K\\{new\_rule}$;\2\6
$\\{width}(\\{alt\_rule})\K\\{null\_flag}$;\5
$\\{height}(\\{alt\_rule})\K\\{null\_flag}$;\5
$\\{depth}(\\{alt\_rule})\K\\{null\_flag}$;\6
\4\\{reswitch}: \37\&{if} $\\{scan\_keyword}(\.{"width"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{width}(\\{alt\_rule})\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"height"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{height}(\\{alt\_rule})\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"depth"})$ \1\&{then}\6
\&{begin} \37\\{scan\_normal\_dimen};\5
$\\{depth}(\\{alt\_rule})\K\\{cur\_val}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37\\{scan\_image};\6
\4\&{label} \37\\{reswitch};\6
\4\&{var} \37\|k: \37\\{integer};\5
\\{named}: \37\\{str\_number};\5
\|s: \37\\{str\_number};\5
$\\{page},\39\\{pagebox},\39\\{colorspace}$: \37\\{integer};\2\6
\&{begin} \37$\\{incr}(\\{pdf\_ximage\_count})$;\5
$\\{pdf\_create\_obj}(\\{obj\_type\_ximage},\39\\{pdf\_ximage\_count})$;\5
$\|k\K\\{obj\_ptr}$;\5
$\\{obj\_data\_ptr}(\|k)\K\\{pdf\_get\_mem}(\\{pdfmem\_ximage\_size})$;\5
\\{scan\_alt\_rule};\C{scans $<\\{rule}\\{spec}>$ to \\{alt\_rule}}\6
$\\{obj\_ximage\_width}(\|k)\K\\{width}(\\{alt\_rule})$;\5
$\\{obj\_ximage\_height}(\|k)\K\\{height}(\\{alt\_rule})$;\5
$\\{obj\_ximage\_depth}(\|k)\K\\{depth}(\\{alt\_rule})$;\6
\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{obj\_ximage\_attr}(\|k)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{obj\_ximage\_attr}(\|k)\K\\{null}$;\2\6
$\\{named}\K0$;\6
\&{if} $\\{scan\_keyword}(\.{"named"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{named}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"page"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\\{page}\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\\{page}\K1$;\2\2\6
\&{if} $\\{scan\_keyword}(\.{"colorspace"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\\{colorspace}\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\\{colorspace}\K0$;\2\6
$\\{pagebox}\K\\{scan\_pdf\_box\_spec}$;\6
\&{if} $\\{pagebox}=0$ \1\&{then}\5
$\\{pagebox}\K\\{pdf\_pagebox}$;\2\6
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\6
\&{if} $\\{pdf\_option\_always\_use\_pdfpagebox}\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"PDF\ inclusion"},\39\.{"Primitive\ %
\\pdfoptionalwaysusepdfpagebox\ is\ obsolete;\ use\ \\pdfpagebox\ instead."},%
\39\\{true},\39\\{true})$;\5
$\\{pdf\_force\_pagebox}\K\\{pdf\_option\_always\_use\_pdfpagebox}$;\5
$\\{pdf\_option\_always\_use\_pdfpagebox}\K0$;\C{warn once}\6
$\\{warn\_pdfpagebox}\K\\{false}$;\6
\&{end};\2\6
\&{if} $\\{pdf\_option\_pdf\_inclusion\_errorlevel}\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"PDF\ inclusion"},\39\.{"Primitive\ %
\\pdfoptionpdfinclusionerrorlevel\ is\ obsolete;\ use\ \\pdfinclusionerrorlevel%
\ instead."},\39\\{true},\39\\{true})$;\5
$\\{pdf\_inclusion\_errorlevel}\K\\{pdf\_option\_pdf\_inclusion\_errorlevel}$;\5
$\\{pdf\_option\_pdf\_inclusion\_errorlevel}\K0$;\C{warn once}\6
\&{end};\2\6
\&{if} $\\{pdf\_force\_pagebox}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{warn\_pdfpagebox}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_warning}(\.{"PDF\ inclusion"},\39\.{"Primitive\ %
\\pdfforcepagebox\ is\ obsolete;\ use\ \\pdfpagebox\ instead."},\39\\{true},\39%
\\{true})$;\5
$\\{warn\_pdfpagebox}\K\\{false}$;\6
\&{end};\2\6
$\\{pagebox}\K\\{pdf\_force\_pagebox}$;\6
\&{end};\2\6
\&{if} $\\{pagebox}=0$ \1\&{then}\C{no pagebox specification given}\6
$\\{pagebox}\K\\{pdf\_box\_spec\_crop}$;\2\6
$\\{obj\_ximage\_data}(\|k)\K\\{read\_image}(\|s,\39\\{page},\39\\{named},\39%
\\{colorspace},\39\\{pagebox},\39\\{pdf\_major\_version},\39\\{pdf\_minor%
\_version},\39\\{pdf\_inclusion\_errorlevel})$;\6
\&{if} $\\{named}\I0$ \1\&{then}\5
$\\{flush\_str}(\\{named})$;\2\6
$\\{flush\_str}(\|s)$;\5
$\\{scale\_image}(\|k)$;\5
$\\{pdf\_last\_ximage}\K\|k$;\5
$\\{pdf\_last\_ximage\_pages}\K\\{image\_pages}(\\{obj\_ximage\_data}(\|k))$;\5
$\\{pdf\_last\_ximage\_colordepth}\K\\{image\_colordepth}(\\{obj\_ximage%
\_data}(\|k))$;\6
\&{end};\par
\fi

\M1553. \P$\X1553:Implement \.{\\pdfximage}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfximage"},\39\\{true})$;\5
\\{check\_pdfversion};\5
\\{scan\_image};\6
\&{end}\par
\U1528.\fi

\M1554. \P$\X1554:Implement \.{\\pdfrefximage}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrefximage"},\39\\{true})$;\5
\\{scan\_int};\5
$\\{pdf\_check\_obj}(\\{obj\_type\_ximage},\39\\{cur\_val})$;\5
$\\{new\_whatsit}(\\{pdf\_refximage\_node},\39\\{pdf\_refximage\_node\_size})$;%
\5
$\\{pdf\_ximage\_objnum}(\\{tail})\K\\{cur\_val}$;\5
$\\{pdf\_width}(\\{tail})\K\\{obj\_ximage\_width}(\\{cur\_val})$;\5
$\\{pdf\_height}(\\{tail})\K\\{obj\_ximage\_height}(\\{cur\_val})$;\5
$\\{pdf\_depth}(\\{tail})\K\\{obj\_ximage\_depth}(\\{cur\_val})$;\6
\&{end}\par
\U1528.\fi

\M1555. The following function finds object with identifier \|i and type \|t.
$\|i<0$ indicates that $-\|i$ should be treated as a string number. If no
such object exists then it will be created. This function is used mainly to
find destination for link annotations and outlines; however it is also used
in \\{pdf\_ship\_out} (to check whether a Page object already exists) so we
need
to declare it together with subroutines needed in \\{pdf\_hlist\_out} and
\\{pdf\_vlist\_out}.

\Y\P$\4\X686:Declare procedures that need to be declared forward for \pdfTeX\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{find\_obj}(\|t,\39\|i:\\{integer};\,\35\\{byname}:%
\\{boolean})$: \37\\{integer};\2\6
\&{begin} \37$\\{find\_obj}\K\\{avl\_find\_obj}(\|t,\39\|i,\39\\{byname})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{flush\_str}(\|s:\\{str\_number})$;\C{flush a string
if possible}\2\6
\&{begin} \37\&{if} $\\{flushable}(\|s)$ \1\&{then}\5
\\{flush\_string};\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_obj}(\|t,\39\|i:\\{integer};\,\35\\{byname}:%
\\{boolean})$: \37\\{integer};\6
\4\&{var} \37\|r: \37\\{integer};\5
\|s: \37\\{str\_number};\2\6
\&{begin} \37\&{if} $\\{byname}>0$ \1\&{then}\6
\&{begin} \37$\|s\K\\{tokens\_to\_string}(\|i)$;\5
$\|r\K\\{find\_obj}(\|t,\39\|s,\39\\{true})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|s\K0$;\5
$\|r\K\\{find\_obj}(\|t,\39\|i,\39\\{false})$;\6
\&{end};\2\6
\&{if} $\|r=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{byname}>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_create\_obj}(\|t,\39-\|s)$;\5
$\|s\K0$;\6
\&{end}\6
\4\&{else} $\\{pdf\_create\_obj}(\|t,\39\|i)$;\2\6
$\|r\K\\{obj\_ptr}$;\6
\&{if} $(\|t=\\{obj\_type\_dest})\V(\|t=\\{obj\_type\_struct\_dest})$ \1%
\&{then}\5
$\\{obj\_dest\_ptr}(\|r)\K\\{null}$;\2\6
\&{end};\2\6
\&{if} $\|s\I0$ \1\&{then}\5
$\\{flush\_str}(\|s)$;\2\6
$\\{get\_obj}\K\|r$;\6
\&{end};\6
\4\&{function}\1\  \37\\{get\_microinterval}: \37\\{integer};\6
\4\&{var} \37$\|s,\39\|m$: \37\\{integer};\C{seconds and microseconds}\2\6
\&{begin} \37$\\{seconds\_and\_micros}(\|s,\39\|m)$;\6
\&{if} $(\|s-\\{epochseconds})>32767$ \1\&{then}\5
$\\{get\_microinterval}\K\\{max\_integer}$\6
\4\&{else} \&{if} $(\\{microseconds}>\|m)$ \1\&{then}\5
$\\{get\_microinterval}\K((\|s-1-\\{epochseconds})\ast65536)+(((\|m+1000000-%
\\{microseconds})/100)\ast65536)/10000$\6
\4\&{else} $\\{get\_microinterval}\K((\|s-\\{epochseconds})\ast65536)+(((\|m-%
\\{microseconds})/100)\ast65536)/10000$;\2\2\6
\&{end};\par
\fi

\M1556. \P$\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}%
\S$\6
\4\&{function}\1\  \37\\{scan\_action}: \37\\{pointer};\C{read an action
specification}\6
\4\&{var} \37\|p: \37\\{integer};\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{pdf\_action\_size})$;\5
$\\{scan\_action}\K\|p$;\5
$\\{pdf\_action\_file}(\|p)\K\\{null}$;\5
$\\{pdf\_action\_refcount}(\|p)\K\\{null}$;\6
\&{if} $\\{scan\_keyword}(\.{"user"})$ \1\&{then}\5
$\\{pdf\_action\_type}(\|p)\K\\{pdf\_action\_user}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"goto"})$ \1\&{then}\5
$\\{pdf\_action\_type}(\|p)\K\\{pdf\_action\_goto}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"thread"})$ \1\&{then}\5
$\\{pdf\_action\_type}(\|p)\K\\{pdf\_action\_thread}$\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"action\ type\ missing"})$;\2\2\2\6
\&{if} $\\{pdf\_action\_type}(\|p)=\\{pdf\_action\_user}$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_user\_tokens}(\|p)\K\\{def\_ref}$;\5
\&{return};\6
\&{end};\2\6
$\\{pdf\_action\_named\_id}(\|p)\K0$;\6
\&{if} $\\{scan\_keyword}(\.{"file"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_file}(\|p)\K\\{def\_ref}$;\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"struct"})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_action\_type}(\|p)\I\\{pdf\_action\_goto}$ \1%
\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"only\ GoTo\ action\ can\ be\ used\ with\ %
\`struct\'"})$;\2\6
\&{if} $\\{pdf\_action\_file}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_named\_id}(\|p)\K\\{pdf\_action\_named\_id}(\|p)+2$;\5
$\\{pdf\_action\_struct\_id}(\|p)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"name"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_named\_id}(\|p)\K\\{pdf\_action\_named\_id}(\|p)+2$;\5
$\\{pdf\_action\_struct\_id}(\|p)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"num"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"num\ identifier\ must\ be\ positive"})$;\2\6
$\\{pdf\_action\_struct\_id}(\|p)\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"identifier\ type\ missing"})$;\2\2%
\2\6
\&{end}\6
\4\&{else} $\\{pdf\_action\_struct\_id}(\|p)\K\\{null}$;\2\6
\&{if} $\\{scan\_keyword}(\.{"page"})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_action\_type}(\|p)\I\\{pdf\_action\_goto}$ \1%
\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"only\ GoTo\ action\ can\ be\ used\ with\ %
\`page\'"})$;\2\6
$\\{pdf\_action\_type}(\|p)\K\\{pdf\_action\_page}$;\5
\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"page\ number\ must\ be\ positive"})$;\2\6
$\\{pdf\_action\_id}(\|p)\K\\{cur\_val}$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_page\_tokens}(\|p)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"name"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_action\_named\_id}(\|p)\K\\{pdf\_action\_named\_id}(\|p)+1$;\5
$\\{pdf\_action\_id}(\|p)\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"num"})$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{pdf\_action\_type}(\|p)=\\{pdf\_action\_goto})\W(%
\\{pdf\_action\_file}(\|p)\I\\{null})$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"\`goto\'\ option\ cannot\ be\ used\ with\
both\ \`file\'\ and\ \`num\'"})$;\2\6
\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"num\ identifier\ must\ be\ positive"})$;\2\6
$\\{pdf\_action\_id}(\|p)\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"identifier\ type\ missing"})$;\2\2%
\2\6
\&{if} $\\{scan\_keyword}(\.{"newwindow"})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_action\_new\_window}(\|p)\K1$;\5
\X469:Scan an optional space\X;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"nonewwindow"})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_action\_new\_window}(\|p)\K2$;\5
\X469:Scan an optional space\X;\6
\&{end}\6
\4\&{else} $\\{pdf\_action\_new\_window}(\|p)\K0$;\2\2\6
\&{if} $(\\{pdf\_action\_new\_window}(\|p)>0)\W(((\\{pdf\_action\_type}(\|p)\I%
\\{pdf\_action\_goto})\W(\\{pdf\_action\_type}(\|p)\I\\{pdf\_action\_page}))\V(%
\\{pdf\_action\_file}(\|p)=\\{null}))$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"\`newwindow\'/\`nonewwindow\'\ must\ be\ used%
\ with\ \`goto\'\ and\ \`file\'\ option"})$;\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{new\_annot\_whatsit}(\|w,\39\|s:\\{small\_number})$;%
\C{create a new whatsit node for annotation}\2\6
\&{begin} \37$\\{new\_whatsit}(\|w,\39\|s)$;\5
\\{scan\_alt\_rule};\C{scans $<\\{rule}\\{spec}>$ to \\{alt\_rule}}\6
$\\{pdf\_width}(\\{tail})\K\\{width}(\\{alt\_rule})$;\5
$\\{pdf\_height}(\\{tail})\K\\{height}(\\{alt\_rule})$;\5
$\\{pdf\_depth}(\\{tail})\K\\{depth}(\\{alt\_rule})$;\6
\&{if} $(\|w=\\{pdf\_start\_link\_node})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_link\_attr}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_link\_attr}(\\{tail})\K\\{null}$;\2\6
\&{end};\2\6
\&{if} $(\|w=\\{pdf\_thread\_node})\V(\|w=\\{pdf\_start\_thread\_node})$ \1%
\&{then}\6
\&{begin} \37\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_thread\_attr}(\\{tail})\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_thread\_attr}(\\{tail})\K\\{null}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1557. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_annot}: \37\\{integer};\par
\fi

\M1558. \P$\X1558:Implement \.{\\pdfannot}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfannot"},\39\\{true})$;\6
\&{if} $\\{scan\_keyword}(\.{"reserveobjnum"})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_last\_annot}\K\\{pdf\_new\_objnum}$;\5
\X469:Scan an optional space\X;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{scan\_keyword}(\.{"useobjnum"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\|k\K\\{cur\_val}$;\6
\&{if} $(\|k\L0)\V(\|k>\\{obj\_ptr})\V(\\{obj\_annot\_ptr}(\|k)\I0)$ \1\&{then}%
\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"invalid\ object\ number"})$;\2\6
\&{end}\6
\4\&{else} $\|k\K\\{pdf\_new\_objnum}$;\2\6
$\\{new\_annot\_whatsit}(\\{pdf\_annot\_node},\39\\{pdf\_annot\_node\_size})$;\5
$\\{pdf\_annot\_objnum}(\\{tail})\K\|k$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_annot\_data}(\\{tail})\K\\{def\_ref}$;\5
$\\{pdf\_last\_annot}\K\|k$;\6
\&{end}\2\6
\&{end}\par
\U1528.\fi

\M1559. \.{\\pdflastlink} needs an extra global variable.
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_link}: \37\\{integer};\par
\fi

\M1560. \P$\X1560:Implement \.{\\pdfstartlink}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfstartlink"},\39\\{true})$;\6
\&{if} $\\{abs}(\\{mode})=\\{vmode}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"\\pdfstartlink\ cannot\ be\ used\ in\
vertical\ mode"})$;\2\6
$\|k\K\\{pdf\_new\_objnum}$;\5
$\\{new\_annot\_whatsit}(\\{pdf\_start\_link\_node},\39\\{pdf\_annot\_node%
\_size})$;\5
$\\{pdf\_link\_action}(\\{tail})\K\\{scan\_action}$;\5
$\\{pdf\_link\_objnum}(\\{tail})\K\|k$;\5
$\\{pdf\_last\_link}\K\|k$;\C{N.B.: although it is possible to set $\\{obj%
\_annot\_ptr}(\|k)\K\\{tail}$ here, it      is not safe if nodes are later
copied/destroyed/moved; a better place      to do this is inside \\{do\_link},
when the whatsit node is written out}\6
\&{end}\par
\U1528.\fi

\M1561. \P$\X1561:Implement \.{\\pdfendlink}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfendlink"},\39\\{true})$;\6
\&{if} $\\{abs}(\\{mode})=\\{vmode}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"\\pdfendlink\ cannot\ be\ used\ in\ vertical\
mode"})$;\2\6
$\\{new\_whatsit}(\\{pdf\_end\_link\_node},\39\\{small\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1562. \P$\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}%
\S$\6
\4\&{function}\1\  \37$\\{outline\_list\_count}(\|p:\\{pointer})$: \37%
\\{integer};\C{return number of outline entries in the same level with \|p}\6
\4\&{var} \37\|k: \37\\{integer};\2\6
\&{begin} \37$\|k\K1$;\6
\&{while} $\\{obj\_outline\_prev}(\|p)\I0$ \1\&{do}\6
\&{begin} \37$\\{incr}(\|k)$;\5
$\|p\K\\{obj\_outline\_prev}(\|p)$;\6
\&{end};\2\6
$\\{outline\_list\_count}\K\|k$;\6
\&{end};\par
\fi

\M1563. \P$\X1563:Implement \.{\\pdfoutline}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfoutline"},\39\\{true})$;\6
\&{if} $\\{scan\_keyword}(\.{"attr"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\|r\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\|r\K0$;\2\6
$\|p\K\\{scan\_action}$;\6
\&{if} $\\{scan\_keyword}(\.{"count"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\5
$\|i\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\|i\K0$;\2\6
\\{scan\_pdf\_ext\_toks};\5
$\|q\K\\{def\_ref}$;\5
$\\{pdf\_new\_obj}(\\{obj\_type\_others},\390,\391)$;\5
$\|j\K\\{obj\_ptr}$;\5
$\\{write\_action}(\|p)$;\5
\\{pdf\_end\_obj};\5
$\\{delete\_action\_ref}(\|p)$;\5
$\\{pdf\_create\_obj}(\\{obj\_type\_outline},\390)$;\5
$\|k\K\\{obj\_ptr}$;\5
$\\{obj\_outline\_ptr}(\|k)\K\\{pdf\_get\_mem}(\\{pdfmem\_outline\_size})$;\5
$\\{obj\_outline\_action\_objnum}(\|k)\K\|j$;\5
$\\{obj\_outline\_count}(\|k)\K\|i$;\5
$\\{pdf\_new\_obj}(\\{obj\_type\_others},\390,\391)$;\5
$\\{pdf\_print\_str\_ln}(\\{tokens\_to\_string}(\|q))$;\5
$\\{flush\_str}(\\{last\_tokens\_string})$;\5
$\\{delete\_token\_ref}(\|q)$;\5
\\{pdf\_end\_obj};\5
$\\{obj\_outline\_title}(\|k)\K\\{obj\_ptr}$;\5
$\\{obj\_outline\_prev}(\|k)\K0$;\5
$\\{obj\_outline\_next}(\|k)\K0$;\5
$\\{obj\_outline\_first}(\|k)\K0$;\5
$\\{obj\_outline\_last}(\|k)\K0$;\5
$\\{obj\_outline\_parent}(\|k)\K\\{pdf\_parent\_outline}$;\5
$\\{obj\_outline\_attr}(\|k)\K\|r$;\6
\&{if} $\\{pdf\_first\_outline}=0$ \1\&{then}\5
$\\{pdf\_first\_outline}\K\|k$;\2\6
\&{if} $\\{pdf\_last\_outline}=0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_parent\_outline}\I0$ \1\&{then}\5
$\\{obj\_outline\_first}(\\{pdf\_parent\_outline})\K\|k$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{obj\_outline\_next}(\\{pdf\_last\_outline})\K\|k$;\5
$\\{obj\_outline\_prev}(\|k)\K\\{pdf\_last\_outline}$;\6
\&{end};\2\6
$\\{pdf\_last\_outline}\K\|k$;\6
\&{if} $\\{obj\_outline\_count}(\|k)\I0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_parent\_outline}\K\|k$;\5
$\\{pdf\_last\_outline}\K0$;\6
\&{end}\6
\4\&{else} \&{if} $(\\{pdf\_parent\_outline}\I0)\W(\\{outline\_list\_count}(%
\|k)=\\{abs}(\\{obj\_outline\_count}(\\{pdf\_parent\_outline})))$ \1\&{then}\6
\&{begin} \37$\|j\K\\{pdf\_last\_outline}$;\6
\1\&{repeat} \37$\\{obj\_outline\_last}(\\{pdf\_parent\_outline})\K\|j$;\5
$\|j\K\\{pdf\_parent\_outline}$;\5
$\\{pdf\_parent\_outline}\K\\{obj\_outline\_parent}(\\{pdf\_parent\_outline})$;%
\6
\4\&{until}\5
$(\\{pdf\_parent\_outline}=0)\V(\\{outline\_list\_count}(\|j)<\\{abs}(\\{obj%
\_outline\_count}(\\{pdf\_parent\_outline})))$;\2\6
\&{if} $\\{pdf\_parent\_outline}=0$ \1\&{then}\5
$\\{pdf\_last\_outline}\K\\{pdf\_first\_outline}$\6
\4\&{else} $\\{pdf\_last\_outline}\K\\{obj\_outline\_first}(\\{pdf\_parent%
\_outline})$;\2\6
\&{while} $\\{obj\_outline\_next}(\\{pdf\_last\_outline})\I0$ \1\&{do}\5
$\\{pdf\_last\_outline}\K\\{obj\_outline\_next}(\\{pdf\_last\_outline})$;\2\6
\&{end};\2\2\6
\&{end}\par
\U1528.\fi

\M1564. When a destination is created we need to check whether another
destination
with the same identifier already exists and give a warning if needed.

\Y\P$\4\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{warn\_dest\_dup}(\\{id}:\\{integer};\,\35\\{byname}:%
\\{small\_number};\,\35\\{s1},\39\\{s2}:\\{str\_number})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_suppress\_warning\_dup\_dest}>0$ \1\&{then}\5
\&{return};\2\6
$\\{pdf\_warning}(\\{s1},\39\.{"destination\ with\ the\ same\ identifier\ ("},%
\39\\{true},\39\\{false})$;\6
\&{if} $\\{byname}>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"name"})$;\5
$\\{print\_mark}(\\{id})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"num"})$;\5
$\\{print\_int}(\\{id})$;\6
\&{end};\2\6
$\\{print}(\.{")\ "})$;\5
$\\{print}(\\{s2})$;\5
\\{print\_ln};\5
\\{show\_context};\6
\&{end};\par
\fi

\M1565. Notice that \\{scan\_keyword} doesn't care if two words have same
prefix; so
we should be careful when scan keywords with same prefix. The main rule: if
there are two or more keywords with the same prefix, then always test in
order from the longest one to the shortest one.

\Y\P$\4\X1565:Implement \.{\\pdfdest}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfdest"},\39\\{true})$;\5
$\|q\K\\{tail}$;\5
$\\{new\_whatsit}(\\{pdf\_dest\_node},\39\\{pdf\_dest\_node\_size})$;\6
\&{if} $\\{scan\_keyword}(\.{"struct"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"struct\ identifier\ must\ be\ positive"})$;\2%
\6
$\\{pdf\_dest\_objnum}(\\{tail})\K\\{cur\_val}$;\5
$\|j\K\\{obj\_type\_struct\_dest}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_dest\_objnum}(\\{tail})\K\\{null}$;\5
$\|j\K\\{obj\_type\_dest}$;\6
\&{end};\2\6
\&{if} $\\{scan\_keyword}(\.{"num"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"num\ identifier\ must\ be\ positive"})$;\2\6
\&{if} $\\{cur\_val}>\\{max\_halfword}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"number\ too\ big"})$;\2\6
$\\{pdf\_dest\_id}(\\{tail})\K\\{cur\_val}$;\5
$\\{pdf\_dest\_named\_id}(\\{tail})\K0$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"name"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_dest\_id}(\\{tail})\K\\{def\_ref}$;\5
$\\{pdf\_dest\_named\_id}(\\{tail})\K1$;\6
\&{end}\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"identifier\ type\ missing"})$;\2\2%
\6
\&{if} $\\{scan\_keyword}(\.{"xyz"})$ \1\&{then}\6
\&{begin} \37$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_xyz}$;\6
\&{if} $\\{scan\_keyword}(\.{"zoom"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}>\\{max\_halfword}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"number\ too\ big"})$;\2\6
$\\{pdf\_dest\_xyz\_zoom}(\\{tail})\K\\{cur\_val}$;\6
\&{end}\6
\4\&{else} $\\{pdf\_dest\_xyz\_zoom}(\\{tail})\K\\{null}$;\2\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fitbh"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fitbh}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fitbv"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fitbv}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fitb"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fitb}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fith"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fith}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fitv"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fitv}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fitr"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fitr}$\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"fit"})$ \1\&{then}\5
$\\{pdf\_dest\_type}(\\{tail})\K\\{pdf\_dest\_fit}$\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"destination\ type\ missing"})$;\2%
\2\2\2\2\2\2\2\6
\X469:Scan an optional space\X;\6
\&{if} $\\{pdf\_dest\_type}(\\{tail})=\\{pdf\_dest\_fitr}$ \1\&{then}\6
\&{begin} \37\\{scan\_alt\_rule};\C{scans $<\\{rule}\\{spec}>$ to \\{alt%
\_rule}}\6
$\\{pdf\_width}(\\{tail})\K\\{width}(\\{alt\_rule})$;\5
$\\{pdf\_height}(\\{tail})\K\\{height}(\\{alt\_rule})$;\5
$\\{pdf\_depth}(\\{tail})\K\\{depth}(\\{alt\_rule})$;\6
\&{end};\2\6
\&{if} $\\{pdf\_dest\_named\_id}(\\{tail})\I0$ \1\&{then}\6
\&{begin} \37$\|i\K\\{tokens\_to\_string}(\\{pdf\_dest\_id}(\\{tail}))$;\5
$\|k\K\\{find\_obj}(\|j,\39\|i,\39\\{true})$;\5
$\\{flush\_str}(\|i)$;\6
\&{end}\6
\4\&{else} $\|k\K\\{find\_obj}(\|j,\39\\{pdf\_dest\_id}(\\{tail}),\39%
\\{false})$;\2\6
\&{if} $(\|k\I0)\W(\\{obj\_dest\_ptr}(\|k)\I\\{null})$ \1\&{then}\6
\&{begin} \37$\\{warn\_dest\_dup}(\\{pdf\_dest\_id}(\\{tail}),\39\\{pdf\_dest%
\_named\_id}(\\{tail}),\39\.{"ext4"},\39\.{"has\ been\ already\ used,\
duplicate\ ignored"})$;\5
$\\{flush\_node\_list}(\\{tail})$;\5
$\\{tail}\K\|q$;\5
$\\{link}(\|q)\K\\{null}$;\6
\&{end};\2\6
\&{end}\par
\U1528.\fi

\M1566. \P$\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37\\{scan\_thread\_id};\2\6
\&{begin} \37\&{if} $\\{scan\_keyword}(\.{"num"})$ \1\&{then}\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"num\ identifier\ must\ be\ positive"})$;\2\6
\&{if} $\\{cur\_val}>\\{max\_halfword}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"number\ too\ big"})$;\2\6
$\\{pdf\_thread\_id}(\\{tail})\K\\{cur\_val}$;\5
$\\{pdf\_thread\_named\_id}(\\{tail})\K0$;\6
\&{end}\6
\4\&{else} \&{if} $\\{scan\_keyword}(\.{"name"})$ \1\&{then}\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_thread\_id}(\\{tail})\K\\{def\_ref}$;\5
$\\{pdf\_thread\_named\_id}(\\{tail})\K1$;\6
\&{end}\6
\4\&{else} $\\{pdf\_error}(\.{"ext1"},\39\.{"identifier\ type\ missing"})$;\2\2%
\6
\&{end};\par
\fi

\M1567. \P$\X1567:Implement \.{\\pdfthread}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfthread"},\39\\{true})$;\5
$\\{new\_annot\_whatsit}(\\{pdf\_thread\_node},\39\\{pdf\_thread\_node%
\_size})$;\5
\\{scan\_thread\_id};\6
\&{end}\par
\U1528.\fi

\M1568. \P$\X1568:Implement \.{\\pdfstartthread}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfstartthread"},\39\\{true})$;\5
$\\{new\_annot\_whatsit}(\\{pdf\_start\_thread\_node},\39\\{pdf\_thread\_node%
\_size})$;\5
\\{scan\_thread\_id};\6
\&{end}\par
\U1528.\fi

\M1569. \P$\X1569:Implement \.{\\pdfendthread}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfendthread"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_end\_thread\_node},\39\\{small\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1570. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_last\_x\_pos}: \37\\{integer};\6
\4\\{pdf\_last\_y\_pos}: \37\\{integer};\6
\4\\{pdf\_snapx\_refpos}: \37\\{integer};\6
\4\\{pdf\_snapy\_refpos}: \37\\{integer};\6
\4\\{count\_do\_snapy}: \37\\{integer};\par
\fi

\M1571. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{count\_do\_snapy}\K0$;\par
\fi

\M1572. \P$\X1572:Implement \.{\\pdfsnaprefpoint}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfsnaprefpoint"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_snap\_ref\_point\_node},\39\\{small\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1573. \P$\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}%
\S$\6
\4\&{function}\1\  \37$\\{new\_snap\_node}(\|s:\\{small\_number})$: \37%
\\{pointer};\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37$\\{scan\_glue}(\\{glue\_val})$;\6
\&{if} $\\{width}(\\{cur\_val})<0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"negative\ snap\ glue"})$;\2\6
$\|p\K\\{get\_node}(\\{snap\_node\_size})$;\5
$\\{type}(\|p)\K\\{whatsit\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\\{snap\_glue\_ptr}(\|p)\K\\{cur\_val}$;\5
$\\{final\_skip}(\|p)\K0$;\5
$\\{new\_snap\_node}\K\|p$;\6
\&{end};\par
\fi

\M1574. \P$\X1574:Implement \.{\\pdfsnapy}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfsnapy"},\39\\{true})$;\5
$\\{tail\_append}(\\{new\_snap\_node}(\\{pdf\_snapy\_node}))$;\6
\&{end}\par
\U1528.\fi

\M1575. \P$\X1575:Implement \.{\\pdfsnapycomp}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfsnapycomp"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_snapy\_comp\_node},\39\\{small\_node\_size})$;\5
\\{scan\_int};\5
$\\{snapy\_comp\_ratio}(\\{tail})\K\\{fix\_int}(\\{cur\_val},\390,\391000)$;\6
\&{end}\par
\U1528.\fi

\M1576. \P$\X1576:Implement \.{\\pdfsavepos}\X\S$\6
\&{begin} \37$\\{new\_whatsit}(\\{pdf\_save\_pos\_node},\39\\{small\_node%
\_size})$;\6
\&{end}\par
\U1528.\fi

\M1577. To implement primitives as \.{\\pdfinfo}, \.{\\pdfcatalog} or
\.{\\pdfnames} we need to concatenate tokens lists.

\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{concat\_tokens}(\|q,\39\|r:\\{pointer})$: \37%
\\{pointer};\C{concat \|q and \|r and returns the result tokens list}\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37\&{if} $\|q=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{concat\_tokens}\K\|r$;\5
\&{return};\6
\&{end};\2\6
$\|p\K\|q$;\6
\&{while} $\\{link}(\|p)\I\\{null}$ \1\&{do}\5
$\|p\K\\{link}(\|p)$;\2\6
$\\{link}(\|p)\K\\{link}(\|r)$;\5
$\\{free\_avail}(\|r)$;\5
$\\{concat\_tokens}\K\|q$;\6
\&{end};\par
\fi

\M1578. \P$\X1578:Implement \.{\\pdfinfo}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfinfo"},\39\\{false})$;\5
\\{scan\_pdf\_ext\_toks};\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_info\_toks}\K\\{concat\_tokens}(\\{pdf\_info\_toks},\39\\{def\_ref})$;%
\2\6
\&{end}\par
\U1528.\fi

\M1579. \P$\X1579:Implement \.{\\pdfcatalog}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfcatalog"},\39\\{false})$;\5
\\{scan\_pdf\_ext\_toks};\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_catalog\_toks}\K\\{concat\_tokens}(\\{pdf\_catalog\_toks},\39\\{def%
\_ref})$;\2\6
\&{if} $\\{scan\_keyword}(\.{"openaction"})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{pdf\_catalog\_openaction}\I0$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext1"},\39\.{"duplicate\ of\ openaction"})$\6
\4\&{else} \&{begin} \37$\|p\K\\{scan\_action}$;\5
$\\{pdf\_new\_obj}(\\{obj\_type\_others},\390,\391)$;\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_catalog\_openaction}\K\\{obj\_ptr}$;\2\6
$\\{write\_action}(\|p)$;\5
\\{pdf\_end\_obj};\5
$\\{delete\_action\_ref}(\|p)$;\6
\&{end};\2\6
\&{end}\2\6
\&{end}\par
\U1528.\fi

\M1580. \P$\X1580:Implement \.{\\pdfnames}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfnames"},\39\\{true})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_names\_toks}\K\\{concat\_tokens}(\\{pdf\_names\_toks},\39\\{def%
\_ref})$;\6
\&{end}\par
\U1528.\fi

\M1581. \P$\X1581:Implement \.{\\pdftrailer}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdftrailer"},\39\\{false})$;\5
\\{scan\_pdf\_ext\_toks};\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_trailer\_toks}\K\\{concat\_tokens}(\\{pdf\_trailer\_toks},\39\\{def%
\_ref})$;\2\6
\&{end}\par
\U1528.\fi

\M1582. \P$\X1582:Implement \.{\\pdftrailerid}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdftrailerid"},\39\\{false})$;\5
\\{scan\_pdf\_ext\_toks};\6
\&{if} $\\{pdf\_output}>0$ \1\&{then}\5
$\\{pdf\_trailer\_id\_toks}\K\\{concat\_tokens}(\\{pdf\_trailer\_id\_toks},\39%
\\{def\_ref})$;\2\6
\&{end}\par
\U1528.\fi

\M1583. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_retval}: \37\\{integer};\C{global multi-purpose return value}\par
\fi

\M1584. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{seconds\_and\_micros}(\\{epochseconds},\39\\{microseconds})$;\5
\\{init\_start\_time};\par
\fi

\M1585. Negative random seed values are silently converted to positive ones.

\Y\P$\4\X1585:Implement \.{\\pdfsetrandomseed}\X\S$\6
\&{begin} \37\\{scan\_int};\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\5
$\\{negate}(\\{cur\_val})$;\2\6
$\\{random\_seed}\K\\{cur\_val}$;\5
$\\{init\_randoms}(\\{random\_seed})$;\6
\&{end}\par
\U1528.\fi

\M1586. \P$\X1586:Implement \.{\\pdfresettimer}\X\S$\6
\&{begin} \37$\\{seconds\_and\_micros}(\\{epochseconds},\39\\{microseconds})$;\6
\&{end}\par
\U1528.\fi

\M1587. The following subroutines are about PDF-specific font issues.

\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{pdf\_include\_chars};\6
\4\&{var} \37\|s: \37\\{str\_number};\5
\|k: \37\\{pool\_pointer};\C{running indices}\6
\|f: \37\\{internal\_font\_number};\2\6
\&{begin} \37\\{scan\_font\_ident};\5
$\|f\K\\{cur\_val}$;\6
\&{if} $\|f=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"invalid\ font\ identifier"})$;\2\6
\\{pdf\_check\_vf\_cur\_val};\6
\&{if} $\R\\{font\_used}[\|f]$ \1\&{then}\5
$\\{pdf\_init\_font}(\|f)$;\2\6
\\{scan\_pdf\_ext\_toks};\5
$\|s\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\|k\K\\{str\_start}[\|s]$;\6
\&{while} $\|k<\\{str\_start}[\|s+1]$ \1\&{do}\6
\&{begin} \37$\\{pdf\_mark\_char}(\|f,\39\\{str\_pool}[\|k])$;\5
$\\{incr}(\|k)$;\6
\&{end};\2\6
$\\{flush\_str}(\|s)$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{glyph\_to\_unicode};\6
\4\&{var} \37$\\{s1},\39\\{s2}$: \37\\{str\_number};\2\6
\&{begin} \37\\{scan\_pdf\_ext\_toks};\5
$\\{s1}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{s2}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\5
$\\{def\_tounicode}(\\{s1},\39\\{s2})$;\5
$\\{flush\_str}(\\{s2})$;\5
$\\{flush\_str}(\\{s1})$;\6
\&{end};\par
\fi

\M1588. \P$\X1588:Implement \.{\\pdfincludechars}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfincludechars"},\39\\{true})$;\5
\\{pdf\_include\_chars};\6
\&{end}\par
\U1528.\fi

\M1589. \P$\X1589:Implement \.{\\pdffontattr}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdffontattr"},\39\\{true})$;\5
\\{scan\_font\_ident};\5
$\|k\K\\{cur\_val}$;\6
\&{if} $\|k=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"invalid\ font\ identifier"})$;\2\6
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_font\_attr}[\|k]\K\\{tokens\_to\_string}(\\{def\_ref})$;\6
\&{end}\par
\U1528.\fi

\M1590. \P$\X1590:Implement \.{\\pdfmapfile}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfmapfile"},\39\\{true})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdfmapfile}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\6
\&{end}\par
\U1528.\fi

\M1591. \P$\X1591:Implement \.{\\pdfmapline}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfmapline"},\39\\{true})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdfmapline}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\6
\&{end}\par
\U1528.\fi

\M1592. \P$\X1592:Implement \.{\\pdfglyphtounicode}\X\S$\6
\&{begin} \37\\{glyph\_to\_unicode};\6
\&{end}\par
\U1528.\fi

\M1593. \P$\X1593:Implement \.{\\pdfnobuiltintounicode}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfnobuiltintounicode"},\39\\{true})$;%
\5
\\{scan\_font\_ident};\5
$\|k\K\\{cur\_val}$;\6
\&{if} $\|k=\\{null\_font}$ \1\&{then}\5
$\\{pdf\_error}(\.{"font"},\39\.{"invalid\ font\ identifier"})$;\2\6
$\\{pdf\_font\_nobuiltin\_tounicode}[\|k]\K\\{true}$;\6
\&{end}\par
\U1528.\fi

\M1594. \P$\X1594:Implement \.{\\pdfinterwordspaceon}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfinterwordspaceon"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_interword\_space\_on\_node},\39\\{small\_node%
\_size})$;\6
\&{end}\par
\U1528.\fi

\M1595. \P$\X1595:Implement \.{\\pdfinterwordspaceoff}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfinterwordspaceoff"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_interword\_space\_off\_node},\39\\{small\_node%
\_size})$;\6
\&{end}\par
\U1528.\fi

\M1596. \P$\X1596:Implement \.{\\pdffakespace}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdffakespace"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_fake\_space\_node},\39\\{small\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1597. \P$\X1597:Implement \.{\\pdfrunninglinkoff}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrunninglinkoff"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_running\_link\_off\_node},\39\\{small\_node\_size})$;%
\6
\&{end}\par
\U1528.\fi

\M1598. \P$\X1598:Implement \.{\\pdfrunninglinkon}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfrunninglinkon"},\39\\{true})$;\5
$\\{new\_whatsit}(\\{pdf\_running\_link\_on\_node},\39\\{small\_node\_size})$;\6
\&{end}\par
\U1528.\fi

\M1599. \P$\X1599:Implement \.{\\pdfspacefont}\X\S$\6
\&{begin} \37$\\{check\_pdfoutput}(\.{"\\pdfspacefont"},\39\\{true})$;\5
\\{scan\_pdf\_ext\_toks};\5
$\\{pdf\_space\_font\_name}\K\\{tokens\_to\_string}(\\{def\_ref})$;\5
$\\{delete\_token\_ref}(\\{def\_ref})$;\6
\&{end}\par
\U1528.\fi

\M1600. The following function are needed for outputting article thread.

\Y\P$\4\X1529:Declare procedures needed in \\{do\_extension}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{thread\_title}(\\{thread}:\\{integer})$;\2\6
\&{begin} \37$\\{pdf\_print}(\.{"/Title\ ("})$;\6
\&{if} $\\{obj\_info}(\\{thread})<0$ \1\&{then}\5
$\\{pdf\_print}(-\\{obj\_info}(\\{thread}))$\6
\4\&{else} $\\{pdf\_print\_int}(\\{obj\_info}(\\{thread}))$;\2\6
$\\{pdf\_print\_ln}(\.{")"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{pdf\_fix\_thread}(\\{thread}:\\{integer})$;\6
\4\&{var} \37\|a: \37\\{pointer};\2\6
\&{begin} \37$\\{pdf\_warning}(\.{"thread"},\39\.{"destination\ "},\39\\{true},%
\39\\{false})$;\6
\&{if} $\\{obj\_info}(\\{thread})<0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"name\{"})$;\5
$\\{print}(-\\{obj\_info}(\\{thread}))$;\5
$\\{print}(\.{"\}"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"num"})$;\5
$\\{print\_int}(\\{obj\_info}(\\{thread}))$;\6
\&{end};\2\6
$\\{print}(\.{"\ has\ been\ referenced\ but\ does\ not\ exist,\ replaced\ by\ a%
\ fixed\ one"})$;\5
\\{print\_ln};\5
\\{print\_ln};\5
$\\{pdf\_new\_dict}(\\{obj\_type\_others},\390,\390)$;\5
$\|a\K\\{obj\_ptr}$;\5
$\\{pdf\_indirect\_ln}(\.{"T"},\39\\{thread})$;\5
$\\{pdf\_indirect\_ln}(\.{"V"},\39\|a)$;\5
$\\{pdf\_indirect\_ln}(\.{"N"},\39\|a)$;\5
$\\{pdf\_indirect\_ln}(\.{"P"},\39\\{head\_tab}[\\{obj\_type\_page}])$;\5
$\\{pdf\_print}(\.{"/R\ [0\ 0\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_page\_width})$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_page\_height})$;\5
$\\{pdf\_print\_ln}(\.{"]"})$;\5
\\{pdf\_end\_dict};\5
$\\{pdf\_begin\_dict}(\\{thread},\391)$;\5
$\\{pdf\_print\_ln}(\.{"/I\ <<\ "})$;\5
$\\{thread\_title}(\\{thread})$;\5
$\\{pdf\_print\_ln}(\.{">>"})$;\5
$\\{pdf\_indirect\_ln}(\.{"F"},\39\|a)$;\5
\\{pdf\_end\_dict};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{out\_thread}(\\{thread}:\\{integer})$;\6
\4\&{var} \37$\|a,\39\|b$: \37\\{pointer};\5
\\{last\_attr}: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{obj\_thread\_first}(\\{thread})=0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_fix\_thread}(\\{thread})$;\5
\&{return};\6
\&{end};\2\6
$\\{pdf\_begin\_dict}(\\{thread},\391)$;\5
$\|a\K\\{obj\_thread\_first}(\\{thread})$;\5
$\|b\K\|a$;\5
$\\{last\_attr}\K0$;\6
\1\&{repeat} \37\&{if} $\\{obj\_bead\_attr}(\|a)\I0$ \1\&{then}\5
$\\{last\_attr}\K\\{obj\_bead\_attr}(\|a)$;\2\6
$\|a\K\\{obj\_bead\_next}(\|a)$;\6
\4\&{until}\5
$\|a=\|b$;\2\6
\&{if} $\\{last\_attr}\I0$ \1\&{then}\5
$\\{pdf\_print\_ln}(\\{last\_attr})$\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_ln}(\.{"/I\ <<\ "})$;\5
$\\{thread\_title}(\\{thread})$;\5
$\\{pdf\_print\_ln}(\.{">>"})$;\6
\&{end};\2\6
$\\{pdf\_indirect\_ln}(\.{"F"},\39\|a)$;\5
\\{pdf\_end\_dict};\6
\1\&{repeat} \37$\\{pdf\_begin\_dict}(\|a,\391)$;\6
\&{if} $\|a=\|b$ \1\&{then}\5
$\\{pdf\_indirect\_ln}(\.{"T"},\39\\{thread})$;\2\6
$\\{pdf\_indirect\_ln}(\.{"V"},\39\\{obj\_bead\_prev}(\|a))$;\5
$\\{pdf\_indirect\_ln}(\.{"N"},\39\\{obj\_bead\_next}(\|a))$;\5
$\\{pdf\_indirect\_ln}(\.{"P"},\39\\{obj\_bead\_page}(\|a))$;\5
$\\{pdf\_indirect\_ln}(\.{"R"},\39\\{obj\_bead\_rect}(\|a))$;\5
\\{pdf\_end\_dict};\5
$\|a\K\\{obj\_bead\_next}(\|a)$;\6
\4\&{until}\5
$\|a=\|b$;\2\6
\&{end};\par
\fi

\M1601. \P$\X1601:Display <rule spec> for whatsit node created by \pdfTeX\X\S$\6
$\\{print}(\.{"("})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_height}(\|p))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_depth}(\|p))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_width}(\|p))$\par
\Us1603, 1603\ETs1603.\fi

\M1602. Each new type of node that appears in our data structure must be
capable
of being displayed, copied, destroyed, and so on. The routines that we
need for write-oriented whatsits are somewhat like those for mark nodes;
other extensions might, of course, involve more subtlety here.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_write\_whatsit}(\|s:\\{str\_number};\,\35\|p:%
\\{pointer})$;\2\6
\&{begin} \37$\\{print\_esc}(\|s)$;\6
\&{if} $\\{write\_stream}(\|p)<16$ \1\&{then}\5
$\\{print\_int}(\\{write\_stream}(\|p))$\6
\4\&{else} \&{if} $\\{write\_stream}(\|p)=16$ \1\&{then}\5
$\\{print\_char}(\.{"*"})$\6
\4\&{else} $\\{print\_char}(\.{"-"})$;\2\2\6
\&{end};\par
\fi

\M1603. \P$\X1603:Display the whatsit node \|p\X\S$\6
\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4\\{open\_node}: \37\&{begin} \37$\\{print\_write\_whatsit}(\.{"openout"},\39%
\|p)$;\5
$\\{print\_char}(\.{"="})$;\5
$\\{print\_file\_name}(\\{open\_name}(\|p),\39\\{open\_area}(\|p),\39\\{open%
\_ext}(\|p))$;\6
\&{end};\6
\4\\{write\_node}: \37\&{begin} \37$\\{print\_write\_whatsit}(\.{"write"},\39%
\|p)$;\5
$\\{print\_mark}(\\{write\_tokens}(\|p))$;\6
\&{end};\6
\4\\{close\_node}: \37$\\{print\_write\_whatsit}(\.{"closeout"},\39\|p)$;\6
\4\\{special\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"special"})$;\5
$\\{print\_mark}(\\{write\_tokens}(\|p))$;\6
\&{end};\6
\4\\{latespecial\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"special"})$;\5
$\\{print}(\.{"\ shipout"})$;\5
$\\{print\_mark}(\\{write\_tokens}(\|p))$;\6
\&{end};\6
\4\\{language\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"setlanguage"})$;\5
$\\{print\_int}(\\{what\_lang}(\|p))$;\5
$\\{print}(\.{"\ (hyphenmin\ "})$;\5
$\\{print\_int}(\\{what\_lhm}(\|p))$;\5
$\\{print\_char}(\.{","})$;\5
$\\{print\_int}(\\{what\_rhm}(\|p))$;\5
$\\{print\_char}(\.{")"})$;\6
\&{end};\6
\4$\\{pdf\_literal\_node},\39\\{pdf\_lateliteral\_node}$: \37\&{begin} \37$%
\\{print\_esc}(\.{"pdfliteral"})$;\6
\&{if} $\\{subtype}(\|p)=\\{pdf\_lateliteral\_node}$ \1\&{then}\5
$\\{print}(\.{"\ shipout"})$;\2\6
\&{case} $\\{pdf\_literal\_mode}(\|p)$ \1\&{of}\6
\4\\{set\_origin}: \37\\{do\_nothing};\6
\4\\{direct\_page}: \37$\\{print}(\.{"\ page"})$;\6
\4\\{direct\_always}: \37$\\{print}(\.{"\ direct"})$;\6
\4\&{othercases} \37$\\{confusion}(\.{"literal2"})$\2\6
\&{endcases};\5
$\\{print\_mark}(\\{pdf\_literal\_data}(\|p))$;\6
\&{end};\6
\4\\{pdf\_colorstack\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfcolorstack\
"})$;\5
$\\{print\_int}(\\{pdf\_colorstack\_stack}(\|p))$;\6
\&{case} $\\{pdf\_colorstack\_cmd}(\|p)$ \1\&{of}\6
\4\\{colorstack\_set}: \37$\\{print}(\.{"\ set\ "})$;\6
\4\\{colorstack\_push}: \37$\\{print}(\.{"\ push\ "})$;\6
\4\\{colorstack\_pop}: \37$\\{print}(\.{"\ pop"})$;\6
\4\\{colorstack\_current}: \37$\\{print}(\.{"\ current"})$;\6
\4\&{othercases} \37$\\{confusion}(\.{"pdfcolorstack"})$\2\6
\&{endcases};\6
\&{if} $\\{pdf\_colorstack\_cmd}(\|p)\L\\{colorstack\_data}$ \1\&{then}\5
$\\{print\_mark}(\\{pdf\_colorstack\_data}(\|p))$;\2\6
\&{end};\6
\4\\{pdf\_setmatrix\_node}: \37\&{begin} \37$\\{print\_esc}(%
\.{"pdfsetmatrix"})$;\5
$\\{print\_mark}(\\{pdf\_setmatrix\_data}(\|p))$;\6
\&{end};\6
\4\\{pdf\_save\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfsave"})$;\6
\&{end};\6
\4\\{pdf\_restore\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfrestore"})$;\6
\&{end};\6
\4\\{pdf\_refobj\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfrefobj"})$;\6
\&{if} $\\{obj\_obj\_is\_stream}(\\{pdf\_obj\_objnum}(\|p))>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{obj\_obj\_stream\_attr}(\\{pdf\_obj\_objnum}(\|p))\I%
\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ attr"})$;\5
$\\{print\_mark}(\\{obj\_obj\_stream\_attr}(\\{pdf\_obj\_objnum}(\|p)))$;\6
\&{end};\2\6
$\\{print}(\.{"\ stream"})$;\6
\&{end};\2\6
\&{if} $\\{obj\_obj\_is\_file}(\\{pdf\_obj\_objnum}(\|p))>0$ \1\&{then}\5
$\\{print}(\.{"\ file"})$;\2\6
$\\{print\_mark}(\\{obj\_obj\_data}(\\{pdf\_obj\_objnum}(\|p)))$;\6
\&{end};\6
\4\\{pdf\_refxform\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfrefxform"})$;%
\5
$\\{print}(\.{"("})$;\5
$\\{print\_scaled}(\\{obj\_xform\_height}(\\{pdf\_xform\_objnum}(\|p)))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_scaled}(\\{obj\_xform\_depth}(\\{pdf\_xform\_objnum}(\|p)))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_scaled}(\\{obj\_xform\_width}(\\{pdf\_xform\_objnum}(\|p)))$;\6
\&{end};\6
\4\\{pdf\_refximage\_node}: \37\&{begin} \37$\\{print\_esc}(%
\.{"pdfrefximage"})$;\5
$\\{print}(\.{"("})$;\5
$\\{print\_scaled}(\\{obj\_ximage\_height}(\\{pdf\_ximage\_objnum}(\|p)))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_scaled}(\\{obj\_ximage\_depth}(\\{pdf\_ximage\_objnum}(\|p)))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_scaled}(\\{obj\_ximage\_width}(\\{pdf\_ximage\_objnum}(\|p)))$;\6
\&{end};\6
\4\\{pdf\_annot\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfannot"})$;\5
\X1601:Display <rule spec> for whatsit node created by \pdfTeX\X;\6
$\\{print\_mark}(\\{pdf\_annot\_data}(\|p))$;\6
\&{end};\6
\4\\{pdf\_start\_link\_node}: \37\&{begin} \37$\\{print\_esc}(%
\.{"pdfstartlink"})$;\5
\X1601:Display <rule spec> for whatsit node created by \pdfTeX\X;\6
\&{if} $\\{pdf\_link\_attr}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ attr"})$;\5
$\\{print\_mark}(\\{pdf\_link\_attr}(\|p))$;\6
\&{end};\2\6
$\\{print}(\.{"\ action"})$;\6
\&{if} $\\{pdf\_action\_type}(\\{pdf\_link\_action}(\|p))=\\{pdf\_action%
\_user}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ user"})$;\5
$\\{print\_mark}(\\{pdf\_action\_user\_tokens}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{pdf\_action\_file}(\\{pdf\_link\_action}(%
\|p))\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ file"})$;\5
$\\{print\_mark}(\\{pdf\_action\_file}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end};\2\6
\&{case} $\\{pdf\_action\_type}(\\{pdf\_link\_action}(\|p))$ \1\&{of}\6
\4\\{pdf\_action\_goto}: \37\&{begin} \37\&{if} $(\\{pdf\_action\_named\_id}(%
\\{pdf\_link\_action}(\|p))\mathbin{\&{mod}}2)=1$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ goto\ name"})$;\5
$\\{print\_mark}(\\{pdf\_action\_id}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"\ goto\ num"})$;\5
$\\{print\_int}(\\{pdf\_action\_id}(\\{pdf\_link\_action}(\|p)))$\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_action\_page}: \37\&{begin} \37$\\{print}(\.{"\ page"})$;\5
$\\{print\_int}(\\{pdf\_action\_id}(\\{pdf\_link\_action}(\|p)))$;\5
$\\{print\_mark}(\\{pdf\_action\_page\_tokens}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end};\6
\4\\{pdf\_action\_thread}: \37\&{begin} \37\&{if} $(\\{pdf\_action\_named\_id}(%
\\{pdf\_link\_action}(\|p))\mathbin{\&{mod}}2)=1$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ thread\ name"})$;\5
$\\{print\_mark}(\\{pdf\_action\_id}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"\ thread\ num"})$;\5
$\\{print\_int}(\\{pdf\_action\_id}(\\{pdf\_link\_action}(\|p)))$;\6
\&{end};\2\6
\&{end};\6
\4\&{othercases} \37$\\{pdf\_error}(\.{"displaying"},\39\.{"unknown\ action\
type"})$;\2\6
\&{endcases};\6
\&{end}\2\6
\&{end};\6
\4\\{pdf\_end\_link\_node}: \37$\\{print\_esc}(\.{"pdfendlink"})$;\6
\4\\{pdf\_dest\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfdest"})$;\6
\&{if} $\\{pdf\_dest\_objnum}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ struct"})$;\5
$\\{print\_int}(\\{pdf\_dest\_objnum}(\|p))$;\6
\&{end};\2\6
\&{if} $\\{pdf\_dest\_named\_id}(\|p)>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ name"})$;\5
$\\{print\_mark}(\\{pdf\_dest\_id}(\|p))$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"\ num"})$;\5
$\\{print\_int}(\\{pdf\_dest\_id}(\|p))$;\6
\&{end};\2\6
$\\{print}(\.{"\ "})$;\6
\&{case} $\\{pdf\_dest\_type}(\|p)$ \1\&{of}\6
\4\\{pdf\_dest\_xyz}: \37\&{begin} \37$\\{print}(\.{"xyz"})$;\6
\&{if} $\\{pdf\_dest\_xyz\_zoom}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ zoom"})$;\5
$\\{print\_int}(\\{pdf\_dest\_xyz\_zoom}(\|p))$;\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_dest\_fitbh}: \37$\\{print}(\.{"fitbh"})$;\6
\4\\{pdf\_dest\_fitbv}: \37$\\{print}(\.{"fitbv"})$;\6
\4\\{pdf\_dest\_fitb}: \37$\\{print}(\.{"fitb"})$;\6
\4\\{pdf\_dest\_fith}: \37$\\{print}(\.{"fith"})$;\6
\4\\{pdf\_dest\_fitv}: \37$\\{print}(\.{"fitv"})$;\6
\4\\{pdf\_dest\_fitr}: \37\&{begin} \37$\\{print}(\.{"fitr"})$;\5
\X1601:Display <rule spec> for whatsit node created by \pdfTeX\X;\6
\&{end};\6
\4\\{pdf\_dest\_fit}: \37$\\{print}(\.{"fit"})$;\6
\4\&{othercases} \37$\\{print}(\.{"unknown!"})$;\2\6
\&{endcases};\6
\&{end};\6
\4$\\{pdf\_thread\_node},\39\\{pdf\_start\_thread\_node}$: \37\&{begin} \37%
\&{if} $\\{subtype}(\|p)=\\{pdf\_thread\_node}$ \1\&{then}\5
$\\{print\_esc}(\.{"pdfthread"})$\6
\4\&{else} $\\{print\_esc}(\.{"pdfstartthread"})$;\2\6
$\\{print}(\.{"("})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_height}(\|p))$;\5
$\\{print\_char}(\.{"+"})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_depth}(\|p))$;\5
$\\{print}(\.{")x"})$;\5
$\\{print\_rule\_dimen}(\\{pdf\_width}(\|p))$;\6
\&{if} $\\{pdf\_thread\_attr}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ attr"})$;\5
$\\{print\_mark}(\\{pdf\_thread\_attr}(\|p))$;\6
\&{end};\2\6
\&{if} $\\{pdf\_thread\_named\_id}(\|p)>0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ name"})$;\5
$\\{print\_mark}(\\{pdf\_thread\_id}(\|p))$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{print}(\.{"\ num"})$;\5
$\\{print\_int}(\\{pdf\_thread\_id}(\|p))$;\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_end\_thread\_node}: \37$\\{print\_esc}(\.{"pdfendthread"})$;\6
\4\\{pdf\_save\_pos\_node}: \37$\\{print\_esc}(\.{"pdfsavepos"})$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37$\\{print\_esc}(\.{"pdfsnaprefpoint"})$;\6
\4\\{pdf\_snapy\_node}: \37\&{begin} \37$\\{print\_esc}(\.{"pdfsnapy"})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_spec}(\\{snap\_glue\_ptr}(\|p),\390)$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_spec}(\\{final\_skip}(\|p),\390)$;\6
\&{end};\6
\4\\{pdf\_snapy\_comp\_node}: \37\&{begin} \37$\\{print\_esc}(%
\.{"pdfsnapycomp"})$;\5
$\\{print\_char}(\.{"\ "})$;\5
$\\{print\_int}(\\{snapy\_comp\_ratio}(\|p))$;\6
\&{end};\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\\{print\_esc}(%
\.{"pdfinterwordspaceon"})$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\\{print\_esc}(%
\.{"pdfinterwordspaceoff"})$;\6
\4\\{pdf\_fake\_space\_node}: \37$\\{print\_esc}(\.{"pdffakespace"})$;\6
\4\\{pdf\_running\_link\_off\_node}: \37$\\{print\_esc}(%
\.{"pdfrunninglinkoff"})$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\\{print\_esc}(%
\.{"pdfrunninglinkon"})$;\6
\4\&{othercases} \37$\\{print}(\.{"whatsit?"})$\2\6
\&{endcases}\par
\U201.\fi

\M1604. \P$\X1604:Make a partial copy of the whatsit node \|p and make \|r
point to it; set \\{words} to the number of initial words not yet copied\X\S$\6
\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4\\{open\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{open\_node\_size})$;\5
$\\{words}\K\\{open\_node\_size}$;\6
\&{end};\6
\4$\\{write\_node},\39\\{special\_node},\39\\{latespecial\_node}$: \37\&{begin}
\37$\|r\K\\{get\_node}(\\{write\_node\_size})$;\5
$\\{add\_token\_ref}(\\{write\_tokens}(\|p))$;\5
$\\{words}\K\\{write\_node\_size}$;\6
\&{end};\6
\4$\\{close\_node},\39\\{language\_node}$: \37\&{begin} \37$\|r\K\\{get\_node}(%
\\{small\_node\_size})$;\5
$\\{words}\K\\{small\_node\_size}$;\6
\&{end};\6
\4$\\{pdf\_literal\_node},\39\\{pdf\_lateliteral\_node}$: \37\&{begin} \37$\|r%
\K\\{get\_node}(\\{write\_node\_size})$;\5
$\\{add\_token\_ref}(\\{pdf\_literal\_data}(\|p))$;\5
$\\{words}\K\\{write\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_colorstack\_node}: \37\&{begin} \37\&{if} $\\{pdf\_colorstack\_cmd}(%
\|p)\L\\{colorstack\_data}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_colorstack\_setter\_node\_size})$;\5
$\\{add\_token\_ref}(\\{pdf\_colorstack\_data}(\|p))$;\5
$\\{words}\K\\{pdf\_colorstack\_setter\_node\_size}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_colorstack\_getter\_node%
\_size})$;\5
$\\{words}\K\\{pdf\_colorstack\_getter\_node\_size}$;\6
\&{end};\2\6
\&{end};\6
\4\\{pdf\_setmatrix\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf%
\_setmatrix\_node\_size})$;\5
$\\{add\_token\_ref}(\\{pdf\_setmatrix\_data}(\|p))$;\5
$\\{words}\K\\{pdf\_setmatrix\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_save\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_save\_node%
\_size})$;\5
$\\{words}\K\\{pdf\_save\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_restore\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_restore%
\_node\_size})$;\5
$\\{words}\K\\{pdf\_restore\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_refobj\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_refobj%
\_node\_size})$;\5
$\\{words}\K\\{pdf\_refobj\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_refxform\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_refxform%
\_node\_size})$;\5
$\\{words}\K\\{pdf\_refxform\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_refximage\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf%
\_refximage\_node\_size})$;\5
$\\{words}\K\\{pdf\_refximage\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_annot\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_annot\_node%
\_size})$;\5
$\\{add\_token\_ref}(\\{pdf\_annot\_data}(\|p))$;\5
$\\{words}\K\\{pdf\_annot\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_start\_link\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_annot%
\_node\_size})$;\5
$\\{pdf\_height}(\|r)\K\\{pdf\_height}(\|p)$;\5
$\\{pdf\_depth}(\|r)\K\\{pdf\_depth}(\|p)$;\5
$\\{pdf\_width}(\|r)\K\\{pdf\_width}(\|p)$;\5
$\\{pdf\_link\_attr}(\|r)\K\\{pdf\_link\_attr}(\|p)$;\6
\&{if} $\\{pdf\_link\_attr}(\|r)\I\\{null}$ \1\&{then}\5
$\\{add\_token\_ref}(\\{pdf\_link\_attr}(\|r))$;\2\6
$\\{pdf\_link\_action}(\|r)\K\\{pdf\_link\_action}(\|p)$;\5
$\\{add\_action\_ref}(\\{pdf\_link\_action}(\|r))$;\5
$\\{pdf\_link\_objnum}(\|r)\K\\{pdf\_link\_objnum}(\|p)$;\6
\&{end};\6
\4\\{pdf\_end\_link\_node}: \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\6
\4\\{pdf\_dest\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{pdf\_dest\_node%
\_size})$;\6
\&{if} $\\{pdf\_dest\_named\_id}(\|p)>0$ \1\&{then}\5
$\\{add\_token\_ref}(\\{pdf\_dest\_id}(\|p))$;\2\6
$\\{words}\K\\{pdf\_dest\_node\_size}$;\6
\&{end};\6
\4$\\{pdf\_thread\_node},\39\\{pdf\_start\_thread\_node}$: \37\&{begin} \37$\|r%
\K\\{get\_node}(\\{pdf\_thread\_node\_size})$;\6
\&{if} $\\{pdf\_thread\_named\_id}(\|p)>0$ \1\&{then}\5
$\\{add\_token\_ref}(\\{pdf\_thread\_id}(\|p))$;\2\6
\&{if} $\\{pdf\_thread\_attr}(\|p)\I\\{null}$ \1\&{then}\5
$\\{add\_token\_ref}(\\{pdf\_thread\_attr}(\|p))$;\2\6
$\\{words}\K\\{pdf\_thread\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_end\_thread\_node}: \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\6
\4\\{pdf\_save\_pos\_node}: \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\6
\4\\{pdf\_snapy\_node}: \37\&{begin} \37$\\{add\_glue\_ref}(\\{snap\_glue%
\_ptr}(\|p))$;\5
$\|r\K\\{get\_node}(\\{snap\_node\_size})$;\5
$\\{words}\K\\{snap\_node\_size}$;\6
\&{end};\6
\4\\{pdf\_snapy\_comp\_node}: \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\6
\4\\{pdf\_fake\_space\_node}: \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\6
\4\\{pdf\_running\_link\_off\_node}: \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\|r\K\\{get\_node}(\\{small\_node%
\_size})$;\6
\4\&{othercases} \37$\\{confusion}(\.{"ext2"})$\2\6
\&{endcases}\par
\Us224\ET1733.\fi

\M1605. \P$\X1605:Wipe out the whatsit node \|p and \&{goto} \\{done}\X\S$\6
\&{begin} \37\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4\\{open\_node}: \37$\\{free\_node}(\|p,\39\\{open\_node\_size})$;\6
\4$\\{write\_node},\39\\{special\_node},\39\\{latespecial\_node}$: \37\&{begin}
\37$\\{delete\_token\_ref}(\\{write\_tokens}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{write\_node\_size})$;\5
\&{goto} \37\\{done};\6
\&{end};\6
\4$\\{close\_node},\39\\{language\_node}$: \37$\\{free\_node}(\|p,\39\\{small%
\_node\_size})$;\6
\4$\\{pdf\_literal\_node},\39\\{pdf\_lateliteral\_node}$: \37\&{begin} \37$%
\\{delete\_token\_ref}(\\{pdf\_literal\_data}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{write\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_colorstack\_node}: \37\&{begin} \37\&{if} $\\{pdf\_colorstack\_cmd}(%
\|p)\L\\{colorstack\_data}$ \1\&{then}\6
\&{begin} \37$\\{delete\_token\_ref}(\\{pdf\_colorstack\_data}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{pdf\_colorstack\_setter\_node\_size})$;\6
\&{end}\6
\4\&{else} $\\{free\_node}(\|p,\39\\{pdf\_colorstack\_getter\_node\_size})$;\2\6
\&{end};\6
\4\\{pdf\_setmatrix\_node}: \37\&{begin} \37$\\{delete\_token\_ref}(\\{pdf%
\_setmatrix\_data}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{pdf\_setmatrix\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_save\_node}: \37\&{begin} \37$\\{free\_node}(\|p,\39\\{pdf\_save%
\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_restore\_node}: \37\&{begin} \37$\\{free\_node}(\|p,\39\\{pdf%
\_restore\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_refobj\_node}: \37$\\{free\_node}(\|p,\39\\{pdf\_refobj\_node%
\_size})$;\6
\4\\{pdf\_refxform\_node}: \37$\\{free\_node}(\|p,\39\\{pdf\_refxform\_node%
\_size})$;\6
\4\\{pdf\_refximage\_node}: \37$\\{free\_node}(\|p,\39\\{pdf\_refximage\_node%
\_size})$;\6
\4\\{pdf\_annot\_node}: \37\&{begin} \37$\\{delete\_token\_ref}(\\{pdf\_annot%
\_data}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{pdf\_annot\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_start\_link\_node}: \37\&{begin} \37\&{if} $\\{pdf\_link\_attr}(\|p)%
\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_link\_attr}(\|p))$;\2\6
$\\{delete\_action\_ref}(\\{pdf\_link\_action}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{pdf\_annot\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_end\_link\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\6
\4\\{pdf\_dest\_node}: \37\&{begin} \37\&{if} $\\{pdf\_dest\_named\_id}(\|p)>0$
\1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_dest\_id}(\|p))$;\2\6
$\\{free\_node}(\|p,\39\\{pdf\_dest\_node\_size})$;\6
\&{end};\6
\4$\\{pdf\_thread\_node},\39\\{pdf\_start\_thread\_node}$: \37\&{begin} \37%
\&{if} $\\{pdf\_thread\_named\_id}(\|p)>0$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_thread\_id}(\|p))$;\2\6
\&{if} $\\{pdf\_thread\_attr}(\|p)\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_thread\_attr}(\|p))$;\2\6
$\\{free\_node}(\|p,\39\\{pdf\_thread\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_end\_thread\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_save\_pos\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_snapy\_node}: \37\&{begin} \37$\\{delete\_glue\_ref}(\\{snap\_glue%
\_ptr}(\|p))$;\5
$\\{free\_node}(\|p,\39\\{snap\_node\_size})$;\6
\&{end};\6
\4\\{pdf\_snapy\_comp\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\\{free\_node}(\|p,\39\\{small%
\_node\_size})$;\6
\4\\{pdf\_fake\_space\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_running\_link\_off\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\\{free\_node}(\|p,\39\\{small\_node%
\_size})$;\6
\4\&{othercases} \37$\\{confusion}(\.{"ext3"})$\2\6
\&{endcases};\6
\&{goto} \37\\{done};\6
\&{end}\par
\U220.\fi

\M1606. \P$\X1606:Incorporate a whatsit node into a vbox\X\S$\6
\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(\\{subtype}(\|p)=\\{pdf%
\_refximage\_node})$ \1\&{then}\6
\&{begin} \37$\|x\K\|x+\|d+\\{pdf\_height}(\|p)$;\5
$\|d\K\\{pdf\_depth}(\|p)$;\5
$\|s\K0$;\6
\&{if} $\\{pdf\_width}(\|p)+\|s>\|w$ \1\&{then}\5
$\|w\K\\{pdf\_width}(\|p)+\|s$;\2\6
\&{end}\2\par
\U845.\fi

\M1607. \P$\X1607:Incorporate a whatsit node into an hbox\X\S$\6
\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(\\{subtype}(\|p)=\\{pdf%
\_refximage\_node})$ \1\&{then}\6
\&{begin} \37$\|x\K\|x+\\{pdf\_width}(\|p)$;\5
$\|s\K0$;\6
\&{if} $\\{pdf\_height}(\|p)-\|s>\|h$ \1\&{then}\5
$\|h\K\\{pdf\_height}(\|p)-\|s$;\2\6
\&{if} $\\{pdf\_depth}(\|p)+\|s>\|d$ \1\&{then}\5
$\|d\K\\{pdf\_depth}(\|p)+\|s$;\2\6
\&{end}\2\par
\U825.\fi

\M1608. \P$\X1608:Let \|d be the width of the whatsit \|p\X\S$\6
\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(\\{subtype}(\|p)=\\{pdf%
\_refximage\_node})$ \1\&{then}\5
$\|d\K\\{pdf\_width}(\|p)$\6
\4\&{else} $\|d\K0$\2\par
\U1325.\fi

\M1609. \P\D \37$\\{adv\_past}(\#)\S$\ \&{if} $\\{subtype}(\#)=\\{language%
\_node}$ \1\&{then}\6
\&{begin} \37$\\{cur\_lang}\K\\{what\_lang}(\#)$;\5
$\\{l\_hyf}\K\\{what\_lhm}(\#)$;\5
$\\{r\_hyf}\K\\{what\_rhm}(\#)$;\ \&{end}\2\par
\Y\P$\4\X1609:Advance \(p)past a whatsit node in the \(l)\\{line\_break} loop\X%
\S$\ \&{begin} \37$\\{adv\_past}(\\{cur\_p})$;\6
\&{if} $(\\{subtype}(\\{cur\_p})=\\{pdf\_refxform\_node})\V(\\{subtype}(\\{cur%
\_p})=\\{pdf\_refximage\_node})$ \1\&{then}\5
$\\{act\_width}\K\\{act\_width}+\\{pdf\_width}(\\{cur\_p})$;\2\6
\&{end}\par
\U1042.\fi

\M1610. \P$\X1610:Advance \(p)past a whatsit node in the \(p)pre-hyphenation
loop\X\S$\ \&{if} $\\{subtype}(\|s)=\\{language\_node}$ \1\&{then}\6
\&{begin} \37$\\{cur\_lang}\K\\{what\_lang}(\|s)$;\5
$\\{l\_hyf}\K\\{what\_lhm}(\|s)$;\5
$\\{r\_hyf}\K\\{what\_rhm}(\|s)$;\5
\\{set\_hyph\_index};\6
\&{end}\2\par
\U1073.\fi

\M1611. \P$\X1611:Prepare to move whatsit \|p to the current page, then %
\&{goto} \\{contribute}\X\S$\6
\&{begin} \37\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(\\{subtype}(%
\|p)=\\{pdf\_refximage\_node})$ \1\&{then}\6
\&{begin} \37$\\{page\_total}\K\\{page\_total}+\\{page\_depth}+\\{pdf\_height}(%
\|p)$;\5
$\\{page\_depth}\K\\{pdf\_depth}(\|p)$;\6
\&{end};\2\6
\&{goto} \37\\{contribute};\6
\&{end}\par
\U1177.\fi

\M1612. \P$\X1612:Process whatsit \|p in \\{vert\_break} loop, \&{goto} \\{not%
\_found}\X\S$\6
\&{begin} \37\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(\\{subtype}(%
\|p)=\\{pdf\_refximage\_node})$ \1\&{then}\6
\&{begin} \37$\\{cur\_height}\K\\{cur\_height}+\\{prev\_dp}+\\{pdf\_height}(%
\|p)$;\5
$\\{prev\_dp}\K\\{pdf\_depth}(\|p)$;\6
\&{end};\2\6
\&{goto} \37\\{not\_found};\6
\&{end}\par
\U1150.\fi

\M1613. \P$\X1613:Output the whatsit node \|p in a vlist\X\S$\6
$\\{out\_what}(\|p)$\par
\U659.\fi

\M1614. \P$\X1614:Output the whatsit node \|p in an hlist\X\S$\6
$\\{out\_what}(\|p)$\par
\U650.\fi

\M1615. After all this preliminary shuffling, we come finally to the routines
that actually send out the requested data. Let's do \.{\\special} first
(it's easier).

\Y\P$\4\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}\X\S$\6
\4\&{procedure}\1\  \37$\\{special\_out}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\|k: \37\\{pool\_pointer};\C{index into \\{str\_pool}}\6
\|h: \37\\{halfword};\5
$\|q,\39\|r$: \37\\{pointer};\C{temporary variables for list manipulation}\6
\\{old\_mode}: \37\\{integer};\C{saved \\{mode}}\2\6
\&{begin} \37\\{synch\_h};\5
\\{synch\_v};\6
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{selector}\K\\{old\_setting}$;\6
\&{if} $\\{subtype}(\|p)=\\{latespecial\_node}$ \1\&{then}\6
\&{begin} \37\X1618:Expand macros in the token list and make $\\{link}(\\{def%
\_ref})$ point to the result\X;\6
$\|h\K\\{def\_ref}$;\6
\&{end}\6
\4\&{else} $\|h\K\\{write\_tokens}(\|p)$;\2\6
$\\{selector}\K\\{new\_string}$;\5
$\\{show\_token\_list}(\\{link}(\|h),\39\\{null},\39\\{pool\_size}-\\{pool%
\_ptr})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{str\_room}(1)$;\6
\&{if} $\\{cur\_length}<256$ \1\&{then}\6
\&{begin} \37$\\{dvi\_out}(\\{xxx1})$;\5
$\\{dvi\_out}(\\{cur\_length})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{dvi\_out}(\\{xxx4})$;\5
$\\{dvi\_four}(\\{cur\_length})$;\6
\&{end};\2\6
\&{for} $\|k\K\\{str\_start}[\\{str\_ptr}]\mathrel{\&{to}}\\{pool\_ptr}-1$ \1%
\&{do}\5
$\\{dvi\_out}(\\{so}(\\{str\_pool}[\|k]))$;\2\6
$\\{pool\_ptr}\K\\{str\_start}[\\{str\_ptr}]$;\C{erase the string}\6
\&{if} $\\{subtype}(\|p)=\\{latespecial\_node}$ \1\&{then}\5
$\\{flush\_list}(\\{def\_ref})$;\2\6
\&{end};\par
\As1617, 1620, 1719\ETs1723.
\U647.\fi

\M1616. To write a token list, we must run it through \TeX's scanner, expanding
macros and \.{\\the} and \.{\\number}, etc. This might cause runaways,
if a delimited macro parameter isn't matched, and runaways would be
extremely confusing since we are calling on \TeX's scanner in the middle
of a \.{\\shipout} command. Therefore we will put a dummy control sequence as
a ``stopper,'' right after the token list. This control sequence is
artificially defined to be \.{\\outer}.

\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{text}(\\{end\_write})\K\.{"endwrite"}$;\5
$\\{eq\_level}(\\{end\_write})\K\\{level\_one}$;\5
$\\{eq\_type}(\\{end\_write})\K\\{outer\_call}$;\5
$\\{equiv}(\\{end\_write})\K\\{null}$;\par
\fi

\M1617. \P$\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{write\_out}(\|p:\\{pointer})$;\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds print %
\\{selector}}\6
\\{old\_mode}: \37\\{integer};\C{saved \\{mode}}\6
\|j: \37\\{small\_number};\C{write stream number}\6
$\|q,\39\|r$: \37\\{pointer};\C{temporary variables for list manipulation}\2\6
\&{begin} \37\X1618:Expand macros in the token list and make $\\{link}(\\{def%
\_ref})$ point to the result\X;\6
$\\{old\_setting}\K\\{selector}$;\5
$\|j\K\\{write\_stream}(\|p)$;\6
\&{if} $\\{write\_open}[\|j]$ \1\&{then}\5
$\\{selector}\K\|j$\6
\4\&{else} \&{begin} \37\C{write to the terminal if file isn't open}\6
\&{if} $(\|j=17)\W(\\{selector}=\\{term\_and\_log})$ \1\&{then}\5
$\\{selector}\K\\{log\_only}$;\2\6
$\\{print\_nl}(\.{""})$;\6
\&{end};\2\6
$\\{token\_show}(\\{def\_ref})$;\5
\\{print\_ln};\5
$\\{flush\_list}(\\{def\_ref})$;\5
$\\{selector}\K\\{old\_setting}$;\6
\&{end};\par
\fi

\M1618. The final line of this routine is slightly subtle; at least, the author
didn't think about it until getting burnt! There is a used-up token list
on the stack, namely the one that contained \\{end\_write\_token}. (We
insert this artificial `\.{\\endwrite}' to prevent runaways, as explained
above.) If it were not removed, and if there were numerous writes on a
single page, the stack would overflow.

\Y\P\D \37$\\{end\_write\_token}\S\\{cs\_token\_flag}+\\{end\_write}$\par
\Y\P$\4\X1618:Expand macros in the token list and make $\\{link}(\\{def\_ref})$
point to the result\X\S$\6
$\|q\K\\{get\_avail}$;\5
$\\{info}(\|q)\K\\{right\_brace\_token}+\.{"\}"}$;\6
$\|r\K\\{get\_avail}$;\5
$\\{link}(\|q)\K\|r$;\5
$\\{info}(\|r)\K\\{end\_write\_token}$;\5
$\\{ins\_list}(\|q)$;\6
$\\{begin\_token\_list}(\\{write\_tokens}(\|p),\39\\{write\_text})$;\6
$\|q\K\\{get\_avail}$;\5
$\\{info}(\|q)\K\\{left\_brace\_token}+\.{"\{"}$;\5
$\\{ins\_list}(\|q)$;\C{now we're ready to scan   `\.\{$\langle\,$token list$\,%
\rangle$\.{\} \\endwrite}'}\6
$\\{old\_mode}\K\\{mode}$;\5
$\\{mode}\K0$;\C{disable \.{\\prevdepth}, \.{\\spacefactor}, \.{\\lastskip}, %
\.{\\prevgraf}}\6
$\\{cur\_cs}\K\\{write\_loc}$;\5
$\|q\K\\{scan\_toks}(\\{false},\39\\{true})$;\C{expand macros, etc.}\6
\\{get\_token};\ \&{if} $\\{cur\_tok}\I\\{end\_write\_token}$ \1\&{then}\5
\X1619:Recover from an unbalanced write command\X;\2\6
$\\{mode}\K\\{old\_mode}$;\5
\\{end\_token\_list}\C{conserve stack space}\par
\Us727, 727, 1615\ETs1617.\fi

\M1619. \P$\X1619:Recover from an unbalanced write command\X\S$\6
\&{begin} \37$\\{print\_err}(\.{"Unbalanced\ write\ command"})$;\5
$\\{help2}(\.{"On\ this\ page\ there\'s\ a\ \\write\ with\ fewer\ real\ \{\'s\
than\ \}\'s."})$\6
$(\.{"I\ can\'t\ handle\ that\ very\ well;\ good\ luck."})$;\5
\\{error};\6
\1\&{repeat} \37\\{get\_token};\6
\4\&{until}\5
$\\{cur\_tok}=\\{end\_write\_token}$;\2\6
\&{end}\par
\U1618.\fi

\M1620. The \\{out\_what} procedure takes care of outputting whatsit nodes for
\\{vlist\_out} and \\{hlist\_out}\kern-.3pt.

\Y\P$\4\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{out\_what}(\|p:\\{pointer})$;\6
\4\&{var} \37\|j: \37\\{small\_number};\C{write stream number}\2\6
\&{begin} \37\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4$\\{open\_node},\39\\{write\_node},\39\\{close\_node}$: \37\X1622:Do some
work that has been queued up for \.{\\write}\X;\6
\4$\\{special\_node},\39\\{latespecial\_node}$: \37$\\{special\_out}(\|p)$;\6
\4\\{language\_node}: \37\\{do\_nothing};\6
\4\\{pdf\_save\_pos\_node}: \37\X1621:Save current position in DVI mode\X;\6
\4\\{others}: \37\&{begin} \37\&{if} $(\\{pdftex\_first\_extension\_code}\L%
\\{subtype}(\|p))\W(\\{subtype}(\|p)\L\\{pdftex\_last\_extension\_code})$ \1%
\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"pdf\ node\ ended\ up\ in\ DVI\ mode"})$\6
\4\&{else} $\\{confusion}(\.{"ext4"})$\2\6
\&{end};\2\6
\&{endcases};\6
\&{end};\par
\fi

\M1621. \P$\X1621:Save current position in DVI mode\X\S$\6
\&{begin} \37\C{4736286 = 1in, the funny DVI origin offset}\6
$\\{pdf\_last\_x\_pos}\K\\{cur\_h}+4736286$;\5
$\\{pdf\_last\_y\_pos}\K\\{cur\_page\_height}-\\{cur\_v}-4736286$;\6
\&{end}\par
\U1620.\fi

\M1622. We don't implement \.{\\write} inside of leaders. (The reason is that
the number of times a leader box appears might be different in different
implementations, due to machine-dependent rounding in the glue calculations.)

\Y\P$\4\X1622:Do some work that has been queued up for \.{\\write}\X\S$\6
\&{if} $\R\\{doing\_leaders}$ \1\&{then}\6
\&{begin} \37$\|j\K\\{write\_stream}(\|p)$;\6
\&{if} $\\{subtype}(\|p)=\\{write\_node}$ \1\&{then}\5
$\\{write\_out}(\|p)$\6
\4\&{else} \&{begin} \37\&{if} $\\{write\_open}[\|j]$ \1\&{then}\5
$\\{a\_close}(\\{write\_file}[\|j])$;\2\6
\&{if} $\\{subtype}(\|p)=\\{close\_node}$ \1\&{then}\5
$\\{write\_open}[\|j]\K\\{false}$\6
\4\&{else} \&{if} $\|j<16$ \1\&{then}\6
\&{begin} \37$\\{cur\_name}\K\\{open\_name}(\|p)$;\5
$\\{cur\_area}\K\\{open\_area}(\|p)$;\5
$\\{cur\_ext}\K\\{open\_ext}(\|p)$;\6
\&{if} $\\{cur\_ext}=\.{""}$ \1\&{then}\5
$\\{cur\_ext}\K\.{".tex"}$;\2\6
\\{pack\_cur\_name};\6
\&{while} $\R\\{a\_open\_out}(\\{write\_file}[\|j])$ \1\&{do}\5
$\\{prompt\_file\_name}(\.{"output\ file\ name"},\39\.{".tex"})$;\2\6
$\\{write\_open}[\|j]\K\\{true}$;\6
\&{end};\2\2\6
\&{end};\2\6
\&{end}\2\par
\U1620.\fi

\M1623. The presence of `\.{\\immediate}' causes the \\{do\_extension}
procedure
to descend to one level of recursion. Nothing happens unless \.{\\immediate}
is followed by `\.{\\openout}', `\.{\\write}', or `\.{\\closeout}'.

\Y\P$\4\X1623:Implement \.{\\immediate}\X\S$\6
\&{begin} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cmd}=\\{extension}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_chr}\L\\{close\_node}$ \1\&{then}\6
\&{begin} \37$\|p\K\\{tail}$;\5
\\{do\_extension};\C{append a whatsit node}\6
$\\{out\_what}(\\{tail})$;\C{do the action immediately}\6
$\\{flush\_node\_list}(\\{tail})$;\5
$\\{tail}\K\|p$;\5
$\\{link}(\|p)\K\\{null}$;\6
\&{end}\6
\4\&{else} \&{case} $\\{cur\_chr}$ \1\&{of}\6
\4\\{pdf\_obj\_code}: \37\&{begin} \37\\{do\_extension};\C{scan object and set %
\\{pdf\_last\_obj}}\6
\&{if} $\\{obj\_data\_ptr}(\\{pdf\_last\_obj})=0$ \1\&{then}\C{this object has
not been initialized yet}\6
$\\{pdf\_error}(\.{"ext1"},\39\.{"\`\\pdfobj\ reserveobjnum\'\ cannot\ be\ used%
\ with\ \\immediate"})$;\2\6
$\\{pdf\_write\_obj}(\\{pdf\_last\_obj})$;\6
\&{end};\6
\4\\{pdf\_xform\_code}: \37\&{begin} \37\\{do\_extension};\C{scan form and set %
\\{pdf\_last\_xform}}\6
$\\{pdf\_cur\_form}\K\\{pdf\_last\_xform}$;\5
$\\{pdf\_ship\_out}(\\{obj\_xform\_box}(\\{pdf\_last\_xform}),\39\\{false})$;\6
\&{end};\6
\4\\{pdf\_ximage\_code}: \37\&{begin} \37\\{do\_extension};\C{scan image and
set \\{pdf\_last\_ximage}}\6
$\\{pdf\_write\_image}(\\{pdf\_last\_ximage})$;\6
\&{end};\6
\4\&{othercases} \37\\{back\_input}\2\6
\&{endcases};\2\6
\&{end}\6
\4\&{else} \\{back\_input};\2\6
\&{end}\par
\U1528.\fi

\M1624. The \.{\\language} extension is somewhat different.
We need a subroutine that comes into play when a character of
a non-\\{clang} language is being appended to the current paragraph.

\Y\P$\4\X1221:Declare action procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{fix\_language};\6
\4\&{var} \37\|l: \37\\{ASCII\_code};\C{the new current language}\2\6
\&{begin} \37\&{if} $\\{language}\L0$ \1\&{then}\5
$\|l\K0$\6
\4\&{else} \&{if} $\\{language}>255$ \1\&{then}\5
$\|l\K0$\6
\4\&{else} $\|l\K\\{language}$;\2\2\6
\&{if} $\|l\I\\{clang}$ \1\&{then}\6
\&{begin} \37$\\{new\_whatsit}(\\{language\_node},\39\\{small\_node\_size})$;\5
$\\{what\_lang}(\\{tail})\K\|l$;\5
$\\{clang}\K\|l$;\6
$\\{what\_lhm}(\\{tail})\K\\{norm\_min}(\\{left\_hyphen\_min})$;\5
$\\{what\_rhm}(\\{tail})\K\\{norm\_min}(\\{right\_hyphen\_min})$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1625. \P$\X1625:Implement \.{\\setlanguage}\X\S$\6
\&{if} $\\{abs}(\\{mode})\I\\{hmode}$ \1\&{then}\5
\\{report\_illegal\_case}\6
\4\&{else} \&{begin} \37$\\{new\_whatsit}(\\{language\_node},\39\\{small\_node%
\_size})$;\5
\\{scan\_int};\6
\&{if} $\\{cur\_val}\L0$ \1\&{then}\5
$\\{clang}\K0$\6
\4\&{else} \&{if} $\\{cur\_val}>255$ \1\&{then}\5
$\\{clang}\K0$\6
\4\&{else} $\\{clang}\K\\{cur\_val}$;\2\2\6
$\\{what\_lang}(\\{tail})\K\\{clang}$;\5
$\\{what\_lhm}(\\{tail})\K\\{norm\_min}(\\{left\_hyphen\_min})$;\5
$\\{what\_rhm}(\\{tail})\K\\{norm\_min}(\\{right\_hyphen\_min})$;\6
\&{end}\2\par
\U1528.\fi

\M1626. \P$\X1626:Finish the extensions\X\S$\6
\&{for} $\|k\K0\mathrel{\&{to}}15$ \1\&{do}\6
\&{if} $\\{write\_open}[\|k]$ \1\&{then}\5
$\\{a\_close}(\\{write\_file}[\|k])$\2\2\par
\U1513.\fi

\M1627. Shipping out PDF marks.

\Y\P$\4\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{dest\_name\_entry}=$\1\5
\1\&{record} \37\\{objname}: \37\\{str\_number};\C{destination name}\6
\4\\{objnum}: \37\\{integer};\C{destination object number}\2\6
\&{end};\2\par
\fi

\M1628. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{cur\_page\_width}: \37\\{scaled};\C{width of page being shipped}\6
\4\\{cur\_page\_height}: \37\\{scaled};\C{height of page being shipped}\6
\4\\{cur\_h\_offset}: \37\\{scaled};\C{horizontal offset of page being shipped}%
\6
\4\\{cur\_v\_offset}: \37\\{scaled};\C{vertical offset of page being shipped}\6
\4\\{pdf\_obj\_list}: \37\\{pointer};\C{list of objects in the current page}\6
\4\\{pdf\_xform\_list}: \37\\{pointer};\C{list of forms in the current page}\6
\4\\{pdf\_ximage\_list}: \37\\{pointer};\C{list of images in the current page}\6
\4\\{last\_thread}: \37\\{pointer};\C{pointer to the last thread}\6
\4$\\{pdf\_thread\_ht},\39\\{pdf\_thread\_dp},\39\\{pdf\_thread\_wd}$: \37%
\\{scaled};\C{dimensions of the last thread}\6
\4\\{pdf\_last\_thread\_id}: \37\\{halfword};\C{identifier of the last thread}\6
\4\\{pdf\_last\_thread\_named\_id}: \37\\{boolean};\C{is identifier of the last
thread named}\6
\4\\{pdf\_thread\_level}: \37\\{integer};\C{depth of nesting of box containing
the last thread}\6
\4\\{pdf\_annot\_list}: \37\\{pointer};\C{list of annotations in the current
page}\6
\4\\{pdf\_link\_list}: \37\\{pointer};\C{list of link annotations in the
current page}\6
\4\\{pdf\_dest\_list}: \37\\{pointer};\C{list of destinations in the current
page}\6
\4\\{pdf\_bead\_list}: \37\\{pointer};\C{list of thread beads in the current
page}\6
\4\\{pdf\_obj\_count}: \37\\{integer};\C{counter of objects}\6
\4\\{pdf\_xform\_count}: \37\\{integer};\C{counter of forms}\6
\4\\{pdf\_ximage\_count}: \37\\{integer};\C{counter of images}\6
\4\\{pdf\_cur\_form}: \37\\{integer};\C{the form being output}\6
\4$\\{pdf\_first\_outline},\39\\{pdf\_last\_outline},\39\\{pdf\_parent%
\_outline}$: \37\\{integer};\6
\4$\\{pdf\_xform\_width},\39\\{pdf\_xform\_height},\39\\{pdf\_xform\_depth}$: %
\37\\{scaled};\C{dimension of the current form}\6
\4\\{pdf\_info\_toks}: \37\\{pointer};\C{additional keys of Info dictionary}\6
\4\\{pdf\_catalog\_toks}: \37\\{pointer};\C{additional keys of Catalog
dictionary}\6
\4\\{pdf\_catalog\_openaction}: \37\\{integer};\6
\4\\{pdf\_names\_toks}: \37\\{pointer};\C{additional keys of Names dictionary}\6
\4\\{pdf\_dest\_names\_ptr}: \37\\{integer};\C{first unused position in \\{dest%
\_names}}\6
\4\\{dest\_names\_size}: \37\\{integer};\C{maximum number of names in name tree
of PDF output file}\6
\4\\{dest\_names}: \37$\^\\{dest\_name\_entry}$;\6
\4\\{pk\_dpi}: \37\\{integer};\C{PK pixel density value from \.{texmf.cnf}}\6
\4$\\{image\_orig\_x},\39\\{image\_orig\_y}$: \37\\{integer};\C{origin of
cropped PDF images}\6
\4\\{pdf\_trailer\_toks}: \37\\{pointer};\C{additional keys of Trailer
dictionary}\6
\4\\{pdf\_trailer\_id\_toks}: \37\\{pointer};\C{custom Trailer ID}\6
\4\\{gen\_faked\_interword\_space}: \37\\{boolean};\C{flag to turn on/off faked
interword spaces}\6
\4\\{gen\_running\_link}: \37\\{boolean};\C{flag to turn on/off running link}\6
\4\\{pdf\_space\_font\_name}: \37\\{str\_number};\C{name of font used for
inter-word space in PDF output}\par
\fi

\M1629. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pdf\_first\_outline}\K0$;\5
$\\{pdf\_last\_outline}\K0$;\5
$\\{pdf\_parent\_outline}\K0$;\5
$\\{pdf\_obj\_count}\K0$;\5
$\\{pdf\_xform\_count}\K0$;\5
$\\{pdf\_ximage\_count}\K0$;\5
$\\{pdf\_dest\_names\_ptr}\K0$;\5
$\\{pdf\_info\_toks}\K\\{null}$;\5
$\\{pdf\_catalog\_toks}\K\\{null}$;\5
$\\{pdf\_names\_toks}\K\\{null}$;\5
$\\{pdf\_catalog\_openaction}\K0$;\5
$\\{pdf\_trailer\_toks}\K\\{null}$;\5
$\\{pdf\_trailer\_id\_toks}\K\\{null}$;\5
$\\{gen\_faked\_interword\_space}\K\\{false}$;\5
$\\{gen\_running\_link}\K\\{true}$;\5
$\\{pdf\_space\_font\_name}\K\.{"pdftexspace"}$;\par
\fi

\M1630. The following procedures are needed for outputting whatsit nodes for
\pdfTeX{}.

\Y\P$\4\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{write\_action}(\|p:\\{pointer})$;\C{write an action
specification}\6
\4\&{var} \37\|s: \37\\{str\_number};\5
\|d: \37\\{integer};\2\6
\&{begin} \37\&{if} $\\{pdf\_action\_type}(\|p)=\\{pdf\_action\_user}$ \1%
\&{then}\6
\&{begin} \37$\\{pdf\_print\_toks\_ln}(\\{pdf\_action\_user\_tokens}(\|p))$;\5
\&{return};\6
\&{end};\2\6
$\\{pdf\_print}(\.{"<<\ "})$;\6
\&{if} $\\{pdf\_action\_file}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/F\ "})$;\5
$\|s\K\\{tokens\_to\_string}(\\{pdf\_action\_file}(\|p))$;\6
\&{if} $(\\{str\_pool}[\\{str\_start}[\|s]]=40)\W(\\{str\_pool}[\\{str\_start}[%
\|s]+\\{length}(\|s)-1]=41)$ \1\&{then}\5
$\\{pdf\_print}(\|s)$\6
\4\&{else} \&{begin} \37$\\{pdf\_print\_str}(\|s)$;\6
\&{end};\2\6
$\\{flush\_str}(\|s)$;\5
$\\{pdf\_print}(\.{"\ "})$;\6
\&{if} $\\{pdf\_action\_new\_window}(\|p)>0$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/NewWindow\ "})$;\6
\&{if} $\\{pdf\_action\_new\_window}(\|p)=1$ \1\&{then}\5
$\\{pdf\_print}(\.{"true\ "})$\6
\4\&{else} $\\{pdf\_print}(\.{"false\ "})$;\2\6
\&{end};\2\6
\&{end};\2\6
\&{case} $\\{pdf\_action\_type}(\|p)$ \1\&{of}\6
\4\\{pdf\_action\_page}: \37\&{begin} \37\&{if} $\\{pdf\_action\_file}(\|p)=%
\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/S\ /GoTo\ /D\ ["})$;\5
$\\{pdf\_print\_int}(\\{get\_obj}(\\{obj\_type\_page},\39\\{pdf\_action\_id}(%
\|p),\39\\{false}))$;\5
$\\{pdf\_print}(\.{"\ 0\ R"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{pdf\_print}(\.{"/S\ /GoToR\ /D\ ["})$;\5
$\\{pdf\_print\_int}(\\{pdf\_action\_id}(\|p)-1)$;\6
\&{end};\2\6
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print}(\\{tokens\_to\_string}(\\{pdf\_action\_page\_tokens}(\|p)))$;\5
$\\{flush\_str}(\\{last\_tokens\_string})$;\5
$\\{pdf\_out}(\.{"]"})$;\6
\&{end};\6
\4\\{pdf\_action\_goto}: \37\&{begin} \37\&{if} $\\{pdf\_action\_file}(\|p)=%
\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_print}(\.{"/S\ /GoTo\ "})$;\5
$\|d\K\\{get\_obj}(\\{obj\_type\_dest},\39\\{pdf\_action\_id}(\|p),\39\\{pdf%
\_action\_named\_id}(\|p)\mathbin{\&{mod}}2)$;\6
\&{end}\6
\4\&{else} $\\{pdf\_print}(\.{"/S\ /GoToR\ "})$;\2\6
\&{if} $(\\{pdf\_action\_named\_id}(\|p)\mathbin{\&{mod}}2)=1$ \1\&{then}\6
\&{begin} \37$\\{pdf\_str\_entry}(\.{"D"},\39\\{tokens\_to\_string}(\\{pdf%
\_action\_id}(\|p)))$;\5
$\\{flush\_str}(\\{last\_tokens\_string})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{pdf\_action\_file}(\|p)=\\{null}$ \1\&{then}\5
$\\{pdf\_indirect}(\.{"D"},\39\|d)$\6
\4\&{else} $\\{pdf\_error}(\.{"ext4"},\39\.{"\`goto\'\ option\ cannot\ be\ used%
\ with\ both\ \`file\'\ and\ \`num\'"})$;\2\2\6
\&{end};\6
\4\\{pdf\_action\_thread}: \37\&{begin} \37$\\{pdf\_print}(\.{"/S\ /Thread\
"})$;\6
\&{if} $\\{pdf\_action\_file}(\|p)=\\{null}$ \1\&{then}\5
$\|d\K\\{get\_obj}(\\{obj\_type\_thread},\39\\{pdf\_action\_id}(\|p),\39\\{pdf%
\_action\_named\_id}(\|p)\mathbin{\&{mod}}2)$;\2\6
\&{if} $(\\{pdf\_action\_named\_id}(\|p)\mathbin{\&{mod}}2)=1$ \1\&{then}\6
\&{begin} \37$\\{pdf\_str\_entry}(\.{"D"},\39\\{tokens\_to\_string}(\\{pdf%
\_action\_id}(\|p)))$;\5
$\\{flush\_str}(\\{last\_tokens\_string})$;\6
\&{end}\6
\4\&{else} \&{if} $\\{pdf\_action\_file}(\|p)=\\{null}$ \1\&{then}\5
$\\{pdf\_indirect}(\.{"D"},\39\|d)$\6
\4\&{else} $\\{pdf\_int\_entry}(\.{"D"},\39\\{pdf\_action\_id}(\|p))$;\2\2\6
\&{end};\2\6
\&{endcases};\6
\&{if} $\\{pdf\_action\_struct\_id}(\|p)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_out}(\.{"\ "})$;\6
\&{if} $\\{pdf\_action\_file}(\|p)=\\{null}$ \1\&{then}\5
$\\{pdf\_indirect}(\.{"SD"},\39\\{get\_obj}(\\{obj\_type\_struct\_dest},\39%
\\{pdf\_action\_struct\_id}(\|p),\39(\\{pdf\_action\_named\_id}(\|p)\mathbin{%
\&{div}}2)\mathbin{\&{mod}}2))$\6
\4\&{else} \&{begin} \37$\\{pdf\_print}(\.{"/SD\ "})$;\5
$\\{pdf\_print}(\\{tokens\_to\_string}(\\{pdf\_action\_struct\_id}(\|p)))$;\5
$\\{flush\_str}(\\{last\_tokens\_string})$;\6
\&{end};\2\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{"\ >>"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box}:%
\\{pointer};\,\35\|x,\39\|y,\39\|w,\39\|h,\39\|d,\39\\{margin}:\\{scaled})$;\2\6
\&{begin} \37$\\{pdf\_left}(\|p)\K\\{cur\_h}$;\6
\&{if} $\\{is\_running}(\|w)$ \1\&{then}\5
$\\{pdf\_right}(\|p)\K\|x+\\{width}(\\{parent\_box})$\6
\4\&{else} $\\{pdf\_right}(\|p)\K\\{cur\_h}+\|w$;\2\6
\&{if} $\\{is\_running}(\|h)$ \1\&{then}\5
$\\{pdf\_top}(\|p)\K\|y-\\{height}(\\{parent\_box})$\6
\4\&{else} $\\{pdf\_top}(\|p)\K\\{cur\_v}-\|h$;\2\6
\&{if} $\\{is\_running}(\|d)$ \1\&{then}\5
$\\{pdf\_bottom}(\|p)\K\|y+\\{depth}(\\{parent\_box})$\6
\4\&{else} $\\{pdf\_bottom}(\|p)\K\\{cur\_v}+\|d$;\2\6
\&{if} $\\{is\_shipping\_page}\W\\{matrixused}$ \1\&{then}\6
\&{begin} \37$\\{matrixtransformrect}(\\{pdf\_left}(\|p),\39\\{cur\_page%
\_height}-\\{pdf\_bottom}(\|p),\39\\{pdf\_right}(\|p),\39\\{cur\_page\_height}-%
\\{pdf\_top}(\|p))$;\5
$\\{pdf\_left}(\|p)\K\\{getllx}$;\5
$\\{pdf\_bottom}(\|p)\K\\{cur\_page\_height}-\\{getlly}$;\5
$\\{pdf\_right}(\|p)\K\\{geturx}$;\5
$\\{pdf\_top}(\|p)\K\\{cur\_page\_height}-\\{getury}$;\6
\&{end};\2\6
$\\{pdf\_left}(\|p)\K\\{pdf\_left}(\|p)-\\{margin}$;\5
$\\{pdf\_top}(\|p)\K\\{pdf\_top}(\|p)-\\{margin}$;\5
$\\{pdf\_right}(\|p)\K\\{pdf\_right}(\|p)+\\{margin}$;\5
$\\{pdf\_bottom}(\|p)\K\\{pdf\_bottom}(\|p)+\\{margin}$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_annot}(\|p,\39\\{parent\_box}:\\{pointer};\,\35%
\|x,\39\|y:\\{scaled})$;\2\6
\&{begin} \37\&{if} $\R\\{is\_shipping\_page}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"annotations\ cannot\ be\ inside\ an\
XForm"})$;\2\6
\&{if} $\\{doing\_leaders}$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{is\_obj\_scheduled}(\\{pdf\_annot\_objnum}(\|p))$ \1\&{then}\5
$\\{pdf\_annot\_objnum}(\|p)\K\\{pdf\_new\_objnum}$;\2\6
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\390)$;\5
$\\{obj\_annot\_ptr}(\\{pdf\_annot\_objnum}(\|p))\K\|p$;\5
$\\{pdf\_append\_list}(\\{pdf\_annot\_objnum}(\|p))(\\{pdf\_annot\_list})$;\5
$\\{set\_obj\_scheduled}(\\{pdf\_annot\_objnum}(\|p))$;\6
\&{end};\par
\fi

\M1631. To implement nested link annotations, we need a stack to hold copy of
\\{pdf\_start\_link\_node}'s that are being written out, together with their
box
nesting level.

\Y\P\D \37$\\{pdf\_link\_stack\_top}\S\\{pdf\_link\_stack}[\\{pdf\_link\_stack%
\_ptr}]$\par
\Y\P$\4\X11:Constants in the outer block\X\mathrel{+}\S$\6
$\\{pdf\_max\_link\_level}=10$;\C{maximum depth of link nesting}\par
\fi

\M1632. \P$\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{pdf\_link\_stack\_record}=$\1\5
\1\&{record} \37\\{nesting\_level}: \37\\{integer};\6
\4\\{link\_node}: \37\\{pointer};\C{holds a copy of the corresponding \\{pdf%
\_start\_link\_node}}\6
\4\\{ref\_link\_node}: \37\\{pointer};\C{points to original \\{pdf\_start\_link%
\_node}, or a                              copy of \\{link\_node} created by %
\\{append\_link} in                              case of multi-line link}\2\6
\&{end};\2\par
\fi

\M1633. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pdf\_link\_stack}: \37\&{array} $[1\to\\{pdf\_max\_link\_level}]$ \1\&{of}%
\5
\\{pdf\_link\_stack\_record};\2\6
\4\\{pdf\_link\_stack\_ptr}: \37\\{small\_number};\par
\fi

\M1634. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pdf\_link\_stack\_ptr}\K0$;\par
\fi

\M1635. \P$\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf%
\_vlist\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{push\_link\_level}(\|p:\\{pointer})$;\2\6
\&{begin} \37\&{if} $\\{pdf\_link\_stack\_ptr}\G\\{pdf\_max\_link\_level}$ \1%
\&{then}\5
$\\{overflow}(\.{"pdf\ link\ stack\ size"},\39\\{pdf\_max\_link\_level})$;\2\6
$\\{pdfassert}((\\{type}(\|p)=\\{whatsit\_node})\W(\\{subtype}(\|p)=\\{pdf%
\_start\_link\_node}))$;\5
$\\{incr}(\\{pdf\_link\_stack\_ptr})$;\5
$\\{pdf\_link\_stack\_top}.\\{nesting\_level}\K\\{cur\_s}$;\5
$\\{pdf\_link\_stack\_top}.\\{link\_node}\K\\{copy\_node\_list}(\|p)$;\5
$\\{pdf\_link\_stack\_top}.\\{ref\_link\_node}\K\|p$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{pop\_link\_level};\2\6
\&{begin} \37$\\{pdfassert}(\\{pdf\_link\_stack\_ptr}>0)$;\5
$\\{flush\_node\_list}(\\{pdf\_link\_stack\_top}.\\{link\_node})$;\5
$\\{decr}(\\{pdf\_link\_stack\_ptr})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_link}(\|p,\39\\{parent\_box}:\\{pointer};\,\35%
\|x,\39\|y:\\{scaled})$;\2\6
\&{begin} \37\&{if} $\R\\{is\_shipping\_page}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"link\ annotations\ cannot\ be\ inside\ an\
XForm"})$;\2\6
$\\{pdfassert}(\\{type}(\\{parent\_box})=\\{hlist\_node})$;\6
\&{if} $\\{is\_obj\_scheduled}(\\{pdf\_link\_objnum}(\|p))$ \1\&{then}\5
$\\{pdf\_link\_objnum}(\|p)\K\\{pdf\_new\_objnum}$;\2\6
$\\{push\_link\_level}(\|p)$;\5
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_link\_margin})$;%
\5
$\\{obj\_annot\_ptr}(\\{pdf\_link\_objnum}(\|p))\K\|p$;\C{the reference for the
pdf annot object                                              must be set here}%
\6
$\\{pdf\_append\_list}(\\{pdf\_link\_objnum}(\|p))(\\{pdf\_link\_list})$;\5
$\\{set\_obj\_scheduled}(\\{pdf\_link\_objnum}(\|p))$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{end\_link};\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37\&{if} $\\{pdf\_link\_stack\_ptr}<1$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"pdf\_link\_stack\ empty,\ \\pdfendlink\ used\
without\ \\pdfstartlink?"})$;\2\6
\&{if} $\\{pdf\_link\_stack\_top}.\\{nesting\_level}\I\\{cur\_s}$ \1\&{then}\5
$\\{pdf\_warning}(0,\39\.{"\\pdfendlink\ ended\ up\ in\ different\ nesting\
level\ than\ \\pdfstartlink"},\39\\{true},\39\\{true})$;\C{N.B.: test for
running link must be done on \\{link\_node} and not \\{ref\_link\_node},
as \\{ref\_link\_node} can be set by \\{do\_link} or \\{append\_link} already}%
\2\6
\&{if} $\\{is\_running}(\\{pdf\_width}(\\{pdf\_link\_stack\_top}.\\{link%
\_node}))$ \1\&{then}\6
\&{begin} \37$\|p\K\\{pdf\_link\_stack\_top}.\\{ref\_link\_node}$;\6
\&{if} $\\{is\_shipping\_page}\W\\{matrixused}$ \1\&{then}\6
\&{begin} \37$\\{matrixrecalculate}(\\{cur\_h}+\\{pdf\_link\_margin})$;\5
$\\{pdf\_left}(\|p)\K\\{getllx}-\\{pdf\_link\_margin}$;\5
$\\{pdf\_top}(\|p)\K\\{cur\_page\_height}-\\{getury}-\\{pdf\_link\_margin}$;\5
$\\{pdf\_right}(\|p)\K\\{geturx}+\\{pdf\_link\_margin}$;\5
$\\{pdf\_bottom}(\|p)\K\\{cur\_page\_height}-\\{getlly}+\\{pdf\_link\_margin}$;%
\6
\&{end}\6
\4\&{else} $\\{pdf\_right}(\|p)\K\\{cur\_h}+\\{pdf\_link\_margin}$;\2\6
\&{end};\2\6
\\{pop\_link\_level};\6
\&{end};\par
\fi

\M1636. For ``running'' annotations we must append a new node when the end of
annotation is in other box than its start. The new created node is identical to
corresponding whatsit node representing the start of annotation,  but its
\\{info} field is \\{max\_halfword}. We set \\{info} field just before
destroying the
node, in order to use \\{flush\_node\_list} to do the job.

\Y\P$\4\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{append\_link}(\\{parent\_box}:\\{pointer};\,\35\|x,%
\39\|y:\\{scaled};\,\35\|i:\\{small\_number})$;\C{append a new pdf annot to %
\\{pdf\_link\_list}}\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37$\\{pdfassert}(\\{type}(\\{parent\_box})=\\{hlist\_node})$;\5
$\|p\K\\{copy\_node\_list}(\\{pdf\_link\_stack}[\|i].\\{link\_node})$;\5
$\\{pdf\_link\_stack}[\|i].\\{ref\_link\_node}\K\|p$;\5
$\\{info}(\|p)\K\\{max\_halfword}$;\C{mark that this node is not a whatsit
node}\6
$\\{link}(\|p)\K\\{null}$;\C{this node is not linked in any list}\6
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_link\_margin})$;%
\5
$\\{pdf\_create\_obj}(\\{obj\_type\_others},\390)$;\5
$\\{obj\_annot\_ptr}(\\{obj\_ptr})\K\|p$;\5
$\\{pdf\_append\_list}(\\{obj\_ptr})(\\{pdf\_link\_list})$;\6
\&{end};\par
\fi

\M1637. Threads are handled in similar way as link annotations.

\Y\P$\4\X727:Declare procedures needed in \\{pdf\_hlist\_out}, \\{pdf\_vlist%
\_out}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{append\_bead}(\|p:\\{pointer})$;\6
\4\&{var} \37$\|a,\39\|b,\39\|c,\39\|t$: \37\\{integer};\2\6
\&{begin} \37\&{if} $\R\\{is\_shipping\_page}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"threads\ cannot\ be\ inside\ an\ XForm"})$;\2%
\6
$\|t\K\\{get\_obj}(\\{obj\_type\_thread},\39\\{pdf\_thread\_id}(\|p),\39\\{pdf%
\_thread\_named\_id}(\|p))$;\5
$\|b\K\\{pdf\_new\_objnum}$;\5
$\\{obj\_bead\_ptr}(\|b)\K\\{pdf\_get\_mem}(\\{pdfmem\_bead\_size})$;\5
$\\{obj\_bead\_page}(\|b)\K\\{pdf\_last\_page}$;\5
$\\{obj\_bead\_data}(\|b)\K\|p$;\6
\&{if} $\\{pdf\_thread\_attr}(\|p)\I\\{null}$ \1\&{then}\5
$\\{obj\_bead\_attr}(\|b)\K\\{tokens\_to\_string}(\\{pdf\_thread\_attr}(\|p))$\6
\4\&{else} $\\{obj\_bead\_attr}(\|b)\K0$;\2\6
\&{if} $\\{obj\_thread\_first}(\|t)=0$ \1\&{then}\6
\&{begin} \37$\\{obj\_thread\_first}(\|t)\K\|b$;\5
$\\{obj\_bead\_next}(\|b)\K\|b$;\5
$\\{obj\_bead\_prev}(\|b)\K\|b$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|a\K\\{obj\_thread\_first}(\|t)$;\5
$\|c\K\\{obj\_bead\_prev}(\|a)$;\5
$\\{obj\_bead\_prev}(\|b)\K\|c$;\5
$\\{obj\_bead\_next}(\|b)\K\|a$;\5
$\\{obj\_bead\_prev}(\|a)\K\|b$;\5
$\\{obj\_bead\_next}(\|c)\K\|b$;\6
\&{end};\2\6
$\\{pdf\_append\_list}(\|b)(\\{pdf\_bead\_list})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_thread}(\|p,\39\\{parent\_box}:\\{pointer};\,\35%
\|x,\39\|y:\\{scaled})$;\2\6
\&{begin} \37\&{if} $\\{doing\_leaders}$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{subtype}(\|p)=\\{pdf\_start\_thread\_node}$ \1\&{then}\6
\&{begin} \37$\\{pdf\_thread\_wd}\K\\{pdf\_width}(\|p)$;\5
$\\{pdf\_thread\_ht}\K\\{pdf\_height}(\|p)$;\5
$\\{pdf\_thread\_dp}\K\\{pdf\_depth}(\|p)$;\5
$\\{pdf\_last\_thread\_id}\K\\{pdf\_thread\_id}(\|p)$;\5
$\\{pdf\_last\_thread\_named\_id}\K(\\{pdf\_thread\_named\_id}(\|p)>0)$;\6
\&{if} $\\{pdf\_last\_thread\_named\_id}$ \1\&{then}\5
$\\{add\_token\_ref}(\\{pdf\_thread\_id}(\|p))$;\2\6
$\\{pdf\_thread\_level}\K\\{cur\_s}$;\6
\&{end};\2\6
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_thread%
\_margin})$;\5
$\\{append\_bead}(\|p)$;\5
$\\{last\_thread}\K\|p$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{append\_thread}(\\{parent\_box}:\\{pointer};\,\35%
\|x,\39\|y:\\{scaled})$;\6
\4\&{var} \37\|p: \37\\{pointer};\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{pdf\_thread\_node\_size})$;\5
$\\{info}(\|p)\K\\{max\_halfword}$;\C{this is not a whatsit node}\6
$\\{link}(\|p)\K\\{null}$;\C{this node will be destroyed separately}\6
$\\{pdf\_width}(\|p)\K\\{pdf\_thread\_wd}$;\5
$\\{pdf\_height}(\|p)\K\\{pdf\_thread\_ht}$;\5
$\\{pdf\_depth}(\|p)\K\\{pdf\_thread\_dp}$;\5
$\\{pdf\_thread\_attr}(\|p)\K\\{null}$;\5
$\\{pdf\_thread\_id}(\|p)\K\\{pdf\_last\_thread\_id}$;\6
\&{if} $\\{pdf\_last\_thread\_named\_id}$ \1\&{then}\6
\&{begin} \37$\\{add\_token\_ref}(\\{pdf\_thread\_id}(\|p))$;\5
$\\{pdf\_thread\_named\_id}(\|p)\K1$;\6
\&{end}\6
\4\&{else} $\\{pdf\_thread\_named\_id}(\|p)\K0$;\2\6
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_thread%
\_margin})$;\5
$\\{append\_bead}(\|p)$;\5
$\\{last\_thread}\K\|p$;\6
\&{end};\6
\4\&{procedure}\1\  \37\\{end\_thread};\2\6
\&{begin} \37\&{if} $\\{pdf\_thread\_level}\I\\{cur\_s}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"\\pdfendthread\ ended\ up\ in\ different\
nesting\ level\ than\ \\pdfstartthread"})$;\2\6
\&{if} $\\{is\_running}(\\{pdf\_thread\_dp})\W(\\{last\_thread}\I\\{null})$ \1%
\&{then}\5
$\\{pdf\_bottom}(\\{last\_thread})\K\\{cur\_v}+\\{pdf\_thread\_margin}$;\2\6
\&{if} $\\{pdf\_last\_thread\_named\_id}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{pdf\_last\_thread\_id})$;\2\6
$\\{last\_thread}\K\\{null}$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{open\_subentries}(\|p:\\{pointer})$: \37\\{integer};\6
\4\&{var} \37$\|k,\39\|c$: \37\\{integer};\5
$\|l,\39\|r$: \37\\{integer};\2\6
\&{begin} \37$\|k\K0$;\6
\&{if} $\\{obj\_outline\_first}(\|p)\I0$ \1\&{then}\6
\&{begin} \37$\|l\K\\{obj\_outline\_first}(\|p)$;\6
\1\&{repeat} \37$\\{incr}(\|k)$;\5
$\|c\K\\{open\_subentries}(\|l)$;\6
\&{if} $\\{obj\_outline\_count}(\|l)>0$ \1\&{then}\5
$\|k\K\|k+\|c$;\2\6
$\\{obj\_outline\_parent}(\|l)\K\|p$;\5
$\|r\K\\{obj\_outline\_next}(\|l)$;\6
\&{if} $\|r=0$ \1\&{then}\5
$\\{obj\_outline\_last}(\|p)\K\|l$;\2\6
$\|l\K\|r$;\6
\4\&{until}\5
$\|l=0$;\2\6
\&{end};\2\6
\&{if} $\\{obj\_outline\_count}(\|p)>0$ \1\&{then}\5
$\\{obj\_outline\_count}(\|p)\K\|k$\6
\4\&{else} $\\{obj\_outline\_count}(\|p)\K-\|k$;\2\6
$\\{open\_subentries}\K\|k$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_dest}(\|p,\39\\{parent\_box}:\\{pointer};\,\35%
\|x,\39\|y:\\{scaled})$;\6
\4\&{var} \37\|k: \37\\{integer};\2\6
\&{begin} \37\&{if} $\R\\{is\_shipping\_page}$ \1\&{then}\5
$\\{pdf\_error}(\.{"ext4"},\39\.{"destinations\ cannot\ be\ inside\ an\
XForm"})$;\2\6
\&{if} $\\{doing\_leaders}$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{pdf\_dest\_objnum}(\|p)=\\{null}$ \1\&{then}\5
$\|k\K\\{get\_obj}(\\{obj\_type\_dest},\39\\{pdf\_dest\_id}(\|p),\39\\{pdf%
\_dest\_named\_id}(\|p))$\6
\4\&{else} $\|k\K\\{get\_obj}(\\{obj\_type\_struct\_dest},\39\\{pdf\_dest\_id}(%
\|p),\39\\{pdf\_dest\_named\_id}(\|p))$;\2\6
\&{if} $\\{obj\_dest\_ptr}(\|k)\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{warn\_dest\_dup}(\\{pdf\_dest\_id}(\|p),\39\\{pdf\_dest\_named%
\_id}(\|p),\39\.{"ext4"},\39\.{"has\ been\ already\ used,\ duplicate\
ignored"})$;\5
\&{return};\6
\&{end};\2\6
$\\{obj\_dest\_ptr}(\|k)\K\|p$;\5
$\\{pdf\_append\_list}(\|k)(\\{pdf\_dest\_list})$;\6
\&{case} $\\{pdf\_dest\_type}(\|p)$ \1\&{of}\6
\4\\{pdf\_dest\_xyz}: \37\&{if} $\\{matrixused}$ \1\&{then}\5
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_dest\_margin})$\6
\4\&{else} \&{begin} \37$\\{pdf\_left}(\|p)\K\\{cur\_h}$;\5
$\\{pdf\_top}(\|p)\K\\{cur\_v}$;\6
\&{end};\2\6
\4$\\{pdf\_dest\_fith},\39\\{pdf\_dest\_fitbh}$: \37\&{if} $\\{matrixused}$ \1%
\&{then}\5
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_dest\_margin})$\6
\4\&{else} $\\{pdf\_top}(\|p)\K\\{cur\_v}$;\2\6
\4$\\{pdf\_dest\_fitv},\39\\{pdf\_dest\_fitbv}$: \37\&{if} $\\{matrixused}$ \1%
\&{then}\5
$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,\39\|y,\39\\{pdf\_width}(%
\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),\39\\{pdf\_dest\_margin})$\6
\4\&{else} $\\{pdf\_left}(\|p)\K\\{cur\_h}$;\2\6
\4$\\{pdf\_dest\_fit},\39\\{pdf\_dest\_fitb}$: \37\\{do\_nothing};\6
\4\\{pdf\_dest\_fitr}: \37$\\{set\_rect\_dimens}(\|p,\39\\{parent\_box},\39\|x,%
\39\|y,\39\\{pdf\_width}(\|p),\39\\{pdf\_height}(\|p),\39\\{pdf\_depth}(\|p),%
\39\\{pdf\_dest\_margin})$;\2\6
\&{endcases};\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{out\_form}(\|p:\\{pointer})$;\2\6
\&{begin} \37\\{pdf\_end\_text};\5
$\\{pdf\_print\_ln}(\.{"q"})$;\6
\&{if} $\\{pdf\_lookup\_list}(\\{pdf\_xform\_list},\39\\{pdf\_xform\_objnum}(%
\|p))=\\{null}$ \1\&{then}\5
$\\{pdf\_append\_list}(\\{pdf\_xform\_objnum}(\|p))(\\{pdf\_xform\_list})$;\2\6
$\\{cur\_v}\K\\{cur\_v}+\\{obj\_xform\_depth}(\\{pdf\_xform\_objnum}(\|p))$;\5
$\\{pdf\_print}(\.{"1\ 0\ 0\ 1\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_x}(\\{cur\_h}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_y}(\\{cur\_v}))$;\5
$\\{pdf\_print\_ln}(\.{"\ cm"})$;\5
$\\{pdf\_print}(\.{"/Fm"})$;\5
$\\{pdf\_print\_int}(\\{obj\_info}(\\{pdf\_xform\_objnum}(\|p)))$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_print\_ln}(\.{"\ Do"})$;\5
$\\{pdf\_print\_ln}(\.{"Q"})$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{out\_image}(\|p:\\{pointer})$;\6
\4\&{var} \37$\\{image},\39\\{groupref}$: \37\\{integer};\5
$\\{img\_w},\39\\{img\_h}$: \37\\{integer};\2\6
\&{begin} \37$\\{image}\K\\{obj\_ximage\_data}(\\{pdf\_ximage\_objnum}(\|p))$;\6
\&{if} $(\\{image\_rotate}(\\{image})=90)\V(\\{image\_rotate}(\\{image})=270)$ %
\1\&{then}\6
\&{begin} \37$\\{img\_h}\K\\{image\_width}(\\{image})$;\5
$\\{img\_w}\K\\{image\_height}(\\{image})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{img\_w}\K\\{image\_width}(\\{image})$;\5
$\\{img\_h}\K\\{image\_height}(\\{image})$;\6
\&{end};\2\6
\\{pdf\_end\_text};\5
$\\{pdf\_print\_ln}(\.{"q"})$;\6
\&{if} $\\{pdf\_lookup\_list}(\\{pdf\_ximage\_list},\39\\{pdf\_ximage\_objnum}(%
\|p))=\\{null}$ \1\&{then}\5
$\\{pdf\_append\_list}(\\{pdf\_ximage\_objnum}(\|p))(\\{pdf\_ximage\_list})$;\2%
\6
\&{if} $\R\\{is\_pdf\_image}(\\{image})$ \1\&{then}\6
\&{begin} \37\&{if} $\\{is\_png\_image}(\\{image})$ \1\&{then}\6
\&{begin} \37$\\{groupref}\K\\{get\_image\_group\_ref}(\\{image})$;\6
\&{if} $(\\{groupref}>0)\W(\\{pdf\_page\_group\_val}=0)$ \1\&{then}\5
$\\{pdf\_page\_group\_val}\K\\{groupref}$;\2\6
\&{end};\2\6
$\\{pdf\_print\_real}(\\{ext\_xn\_over\_d}(\\{pdf\_width}(\|p),\39\\{ten%
\_pow}[6],\39\\{one\_hundred\_bp}),\394)$;\5
$\\{pdf\_print}(\.{"\ 0\ 0\ "})$;\5
$\\{pdf\_print\_real}(\\{ext\_xn\_over\_d}(\\{pdf\_height}(\|p)+\\{pdf\_depth}(%
\|p),\39\\{ten\_pow}[6],\39\\{one\_hundred\_bp}),\394)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_x}(\\{cur\_h}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_y}(\\{cur\_v}))$;\6
\&{end}\6
\4\&{else} \&{begin} \37\C{for pdf images we generate the page group object
number here}\6
$\\{groupref}\K\\{get\_image\_group\_ref}(\\{image})$;\C{0: no group, -1: to be
generated; >0: already written}\6
\&{if} $(\\{groupref}\I0)\W(\\{pdf\_page\_group\_val}=0)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{groupref}=-1$ \1\&{then}\6
\&{begin} \37$\\{pdf\_page\_group\_val}\K\\{pdf\_new\_objnum}$;\5
$\\{set\_image\_group\_ref}(\\{image},\39\\{pdf\_page\_group\_val})$;\6
\&{end}\6
\4\&{else} \C{ groupref > 0 }\2\6
$\\{pdf\_page\_group\_val}\K\\{groupref}$;\6
\&{end};\2\6
$\\{pdf\_print\_real}(\\{ext\_xn\_over\_d}(\\{pdf\_width}(\|p),\39\\{ten%
\_pow}[6],\39\\{img\_w}),\396)$;\5
$\\{pdf\_print}(\.{"\ 0\ 0\ "})$;\5
$\\{pdf\_print\_real}(\\{ext\_xn\_over\_d}(\\{pdf\_height}(\|p)+\\{pdf\_depth}(%
\|p),\39\\{ten\_pow}[6],\39\\{img\_h}),\396)$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_x}(\\{cur\_h})-\\{ext\_xn\_over\_d}(\\{pdf\_width}(%
\|p),\39\\{epdf\_orig\_x}(\\{image}),\39\\{img\_w}))$;\5
$\\{pdf\_out}(\.{"\ "})$;\5
$\\{pdf\_print\_bp}(\\{pdf\_y}(\\{cur\_v})-\\{ext\_xn\_over\_d}(\\{pdf%
\_height}(\|p)+\\{pdf\_depth}(\|p),\39\\{epdf\_orig\_y}(\\{image}),\39\\{img%
\_h}))$;\6
\&{end};\2\6
$\\{pdf\_print\_ln}(\.{"\ cm"})$;\5
$\\{pdf\_print}(\.{"/Im"})$;\5
$\\{pdf\_print\_int}(\\{obj\_info}(\\{pdf\_ximage\_objnum}(\|p)))$;\5
\\{pdf\_print\_resname\_prefix};\5
$\\{pdf\_print\_ln}(\.{"\ Do"})$;\5
$\\{pdf\_print\_ln}(\.{"Q"})$;\6
\&{end};\6
\4\&{function}\1\  \37$\\{gap\_amount}(\|p:\\{pointer};\,\35\\{cur\_pos}:%
\\{scaled})$: \37\\{scaled};\C{find the gap between the position of the current
snap node \|p and the nearest point on the grid}\6
\4\&{var} \37$\\{snap\_unit},\39\\{stretch\_amount},\39\\{shrink\_amount}$: \37%
\\{scaled};\5
$\\{last\_pos},\39\\{next\_pos},\39\|g,\39\\{g2}$: \37\\{scaled};\2\6
\&{begin} \37$\\{snap\_unit}\K\\{width}(\\{snap\_glue\_ptr}(\|p))$;\6
\&{if} $\\{stretch\_order}(\\{snap\_glue\_ptr}(\|p))>\\{normal}$ \1\&{then}\5
$\\{stretch\_amount}\K\\{max\_dimen}$\6
\4\&{else} $\\{stretch\_amount}\K\\{stretch}(\\{snap\_glue\_ptr}(\|p))$;\2\6
\&{if} $\\{shrink\_order}(\\{snap\_glue\_ptr}(\|p))>\\{normal}$ \1\&{then}\5
$\\{shrink\_amount}\K\\{max\_dimen}$\6
\4\&{else} $\\{shrink\_amount}\K\\{shrink}(\\{snap\_glue\_ptr}(\|p))$;\2\6
\&{if} $\\{subtype}(\|p)=\\{pdf\_snapy\_node}$ \1\&{then}\5
$\\{last\_pos}\K\\{pdf\_snapy\_refpos}+\\{snap\_unit}\ast((\\{cur\_pos}-\\{pdf%
\_snapy\_refpos})\mathbin{\&{div}}\\{snap\_unit})$\6
\4\&{else} $\\{pdf\_error}(\.{"snapping"},\39\.{"invalid\ parameter\ value\ for%
\ gap\_amount"})$;\2\6
$\\{next\_pos}\K\\{last\_pos}+\\{snap\_unit}$;\5
$\B\\{print\_nl}(\.{"snap\ ref\ pos\ =\ "})$;\5
$\\{print\_scaled}(\\{pdf\_snapy\_refpos})$;\5
$\\{print\_nl}(\.{"snap\ glue\ =\ "})$;\5
$\\{print\_spec}(\\{snap\_glue\_ptr}(\|p),\390)$;\5
$\\{print\_nl}(\.{"gap\ amount\ =\ "})$;\5
$\\{print\_scaled}(\\{snap\_unit})$;\5
$\\{print\_nl}(\.{"stretch\ amount\ =\ "})$;\5
$\\{print\_scaled}(\\{stretch\_amount})$;\5
$\\{print\_nl}(\.{"shrink\ amount\ =\ "})$;\5
$\\{print\_scaled}(\\{shrink\_amount})$;\5
$\\{print\_nl}(\.{"last\ point\ =\ "})$;\5
$\\{print\_scaled}(\\{last\_pos})$;\5
$\\{print\_nl}(\.{"cur\ point\ =\ "})$;\5
$\\{print\_scaled}(\\{cur\_pos})$;\5
$\\{print\_nl}(\.{"next\ point\ =\ "})$;\5
$\\{print\_scaled}(\\{next\_pos})$;\5
$\T\|g\K\\{max\_dimen}$;\5
$\\{g2}\K\\{max\_dimen}$;\5
$\\{gap\_amount}\K0$;\6
\&{if} $\\{cur\_pos}-\\{last\_pos}<\\{shrink\_amount}$ \1\&{then}\5
$\|g\K\\{cur\_pos}-\\{last\_pos}$;\2\6
\&{if} $(\\{next\_pos}-\\{cur\_pos}<\\{stretch\_amount})$ \1\&{then}\5
$\\{g2}\K\\{next\_pos}-\\{cur\_pos}$;\2\6
\&{if} $(\|g=\\{max\_dimen})\W(\\{g2}=\\{max\_dimen})$ \1\&{then}\5
\&{return};\C{unable to snap}\2\6
\&{if} $\\{g2}\L\|g$ \1\&{then}\5
$\\{gap\_amount}\K\\{g2}$\C{skip forward}\6
\4\&{else} $\\{gap\_amount}\K-\|g$;\C{skip backward}\2\6
\&{end};\6
\4\&{function}\1\  \37$\\{get\_vpos}(\|p,\39\|q,\39\|b:\\{pointer})$: \37%
\\{pointer};\C{find the vertical position of node \|q in the output PDF page;
this functions is called when the current node is \|p and current position is %
\\{cur\_v} (global variable); \|b is the parent box;}\6
\4\&{var} \37\\{tmp\_v}: \37\\{scaled};\5
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
\\{cur\_glue}: \37\\{real};\C{glue seen so far}\6
\\{cur\_g}: \37\\{scaled};\C{rounded equivalent of \\{cur\_glue} times the glue
ratio}\6
\\{this\_box}: \37\\{pointer};\C{pointer to containing box}\2\6
\&{begin} \37$\\{tmp\_v}\K\\{cur\_v}$;\5
$\\{this\_box}\K\|b$;\5
$\\{cur\_g}\K0$;\5
$\\{cur\_glue}\K\\{float\_constant}(0)$;\5
$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\6
\&{while} $(\|p\I\|q)\W(\|p\I\\{null})$ \1\&{do}\6
\&{begin} \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\\{confusion}(\.{"get\_vpos"})$\6
\4\&{else} \&{begin} \37\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node}$: \37$\\{tmp\_v}\K%
\\{tmp\_v}+\\{height}(\|p)+\\{depth}(\|p)$;\6
\4\\{whatsit\_node}: \37\&{if} $(\\{subtype}(\|p)=\\{pdf\_refxform\_node})\V(%
\\{subtype}(\|p)=\\{pdf\_refximage\_node})$ \1\&{then}\5
$\\{tmp\_v}\K\\{tmp\_v}+\\{pdf\_height}(\|p)+\\{pdf\_depth}(\|p)$;\2\6
\4\\{glue\_node}: \37\&{begin} \37\X1638:Move down without outputting leaders%
\X;\6
$\\{tmp\_v}\K\\{tmp\_v}+\\{rule\_ht}$;\6
\&{end};\6
\4\\{kern\_node}: \37$\\{tmp\_v}\K\\{tmp\_v}+\\{width}(\|p)$;\6
\4\&{othercases} \37\\{do\_nothing};\2\6
\&{endcases};\6
\&{end};\2\6
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{get\_vpos}\K\\{tmp\_v}$;\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_snapy\_comp}(\|p,\39\|b:\\{pointer})$;\C{do
snapping compensation in vertical direction; search for the next snap node and
do the compensation if found}\6
\4\&{var} \37\|q: \37\\{pointer};\5
$\\{tmp\_v},\39\|g,\39\\{g2}$: \37\\{scaled};\2\6
\&{begin} \37\&{if} $\R(\R\\{is\_char\_node}(\|p)\W(\\{type}(\|p)=\\{whatsit%
\_node})\W(\\{subtype}(\|p)=\\{pdf\_snapy\_comp\_node}))$ \1\&{then}\5
$\\{pdf\_error}(\.{"snapping"},\39\.{"invalid\ parameter\ value\ for\ do\_snapy%
\_comp"})$;\2\6
$\|q\K\|p$;\6
\&{while} $(\|q\I\\{null})$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\|q)\W(\\{type}(\|q)=\\{whatsit%
\_node})\W(\\{subtype}(\|q)=\\{pdf\_snapy\_node})$ \1\&{then}\6
\&{begin} \37$\\{tmp\_v}\K\\{get\_vpos}(\|p,\39\|q,\39\|b)$;\C{get the position
of \|q}\6
$\|g\K\\{gap\_amount}(\|q,\39\\{tmp\_v})$;\C{get the gap to the grid}\6
$\\{g2}\K\\{round\_xn\_over\_d}(\|g,\39\\{snapy\_comp\_ratio}(\|p),\391000)$;%
\C{adjustment for \|p}\6
$\B\\{print\_nl}(\.{"do\_snapy\_comp:\ tmp\_v\ =\ "})$;\5
$\\{print\_scaled}(\\{tmp\_v})$;\5
$\\{print\_nl}(\.{"do\_snapy\_comp:\ cur\_v\ =\ "})$;\5
$\\{print\_scaled}(\\{cur\_v})$;\5
$\\{print\_nl}(\.{"do\_snapy\_comp:\ g\ =\ "})$;\5
$\\{print\_scaled}(\|g)$;\5
$\\{print\_nl}(\.{"do\_snapy\_comp:\ g2\ =\ "})$;\5
$\\{print\_scaled}(\\{g2})$;\5
$\T\\{cur\_v}\K\\{cur\_v}+\\{g2}$;\5
$\\{final\_skip}(\|q)\K\|g-\\{g2}$;\C{adjustment for \|q}\6
\&{if} $\\{final\_skip}(\|q)=0$ \1\&{then}\5
$\\{final\_skip}(\|q)\K1$;\C{use 1\\{sp} as the magic value to record
                           that \\{final\_skip} has been set here}\2\6
\&{return};\6
\&{end};\2\6
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\6
\&{end};\6
\4\&{procedure}\1\  \37$\\{do\_snapy}(\|p:\\{pointer})$;\2\6
\&{begin} \37$\\{incr}(\\{count\_do\_snapy})$;\5
$\B\\{print\_nl}(\.{"do\_snapy:\ count\ =\ "})$;\5
$\\{print\_int}(\\{count\_do\_snapy})$;\5
$\\{print\_nl}(\.{"do\_snapy:\ cur\_v\ =\ "})$;\5
$\\{print\_scaled}(\\{cur\_v})$;\5
$\\{print\_nl}(\.{"do\_snapy:\ final\ skip\ =\ "})$;\5
$\\{print\_scaled}(\\{final\_skip}(\|p))$;\5
$\T$\1\6
\&{if} $\\{final\_skip}(\|p)\I0$ \1\&{then}\5
$\\{cur\_v}\K\\{cur\_v}+\\{final\_skip}(\|p)$\6
\4\&{else} $\\{cur\_v}\K\\{cur\_v}+\\{gap\_amount}(\|p,\39\\{cur\_v})$;\2\2\6
$\B\\{print\_nl}(\.{"do\_snapy:\ cur\_v\ after\ snap\ =\ "})$;\5
$\\{print\_scaled}(\\{cur\_v})$;\5
$\T$\6
\&{end};\par
\fi

\M1638. \P$\X1638:Move down without outputting leaders\X\S$\6
\&{begin} \37$\|g\K\\{glue\_ptr}(\|p)$;\5
$\\{rule\_ht}\K\\{width}(\|g)-\\{cur\_g}$;\6
\&{if} $\\{g\_sign}\I\\{normal}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{g\_sign}=\\{stretching}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{stretch\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}+\\{stretch}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{shrink\_order}(\|g)=\\{g\_order}$ \1\&{then}\6
\&{begin} \37$\\{cur\_glue}\K\\{cur\_glue}-\\{shrink}(\|g)$;\5
$\\{vet\_glue}(\\{float}(\\{glue\_set}(\\{this\_box}))\ast\\{cur\_glue})$;\5
$\\{cur\_g}\K\\{round}(\\{glue\_temp})$;\6
\&{end};\2\2\6
\&{end};\2\6
$\\{rule\_ht}\K\\{rule\_ht}+\\{cur\_g}$;\6
\&{end}\par
\U1637.\fi

\M1639. \P$\X1639:Output the whatsit node \|p in \\{pdf\_vlist\_out}\X\S$\6
\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4$\\{pdf\_literal\_node},\39\\{pdf\_lateliteral\_node}$: \37$\\{pdf\_out%
\_literal}(\|p)$;\6
\4\\{pdf\_colorstack\_node}: \37$\\{pdf\_out\_colorstack}(\|p)$;\6
\4\\{pdf\_setmatrix\_node}: \37$\\{pdf\_out\_setmatrix}(\|p)$;\6
\4\\{pdf\_save\_node}: \37$\\{pdf\_out\_save}(\|p)$;\6
\4\\{pdf\_restore\_node}: \37$\\{pdf\_out\_restore}(\|p)$;\6
\4\\{pdf\_refobj\_node}: \37$\\{pdf\_append\_list}(\\{pdf\_obj\_objnum}(\|p))(%
\\{pdf\_obj\_list})$;\6
\4\\{pdf\_refxform\_node}: \37\X1644:Output a Form node in a vlist\X;\6
\4\\{pdf\_refximage\_node}: \37\X1643:Output a Image node in a vlist\X;\6
\4\\{pdf\_annot\_node}: \37$\\{do\_annot}(\|p,\39\\{this\_box},\39\\{left%
\_edge},\39\\{top\_edge}+\\{height}(\\{this\_box}))$;\6
\4\\{pdf\_start\_link\_node}: \37$\\{pdf\_error}(\.{"ext4"},\39\.{"%
\\pdfstartlink\ ended\ up\ in\ vlist"})$;\6
\4\\{pdf\_end\_link\_node}: \37$\\{pdf\_error}(\.{"ext4"},\39\.{"\\pdfendlink\
ended\ up\ in\ vlist"})$;\6
\4\\{pdf\_dest\_node}: \37$\\{do\_dest}(\|p,\39\\{this\_box},\39\\{left\_edge},%
\39\\{top\_edge}+\\{height}(\\{this\_box}))$;\6
\4$\\{pdf\_thread\_node},\39\\{pdf\_start\_thread\_node}$: \37$\\{do\_thread}(%
\|p,\39\\{this\_box},\39\\{left\_edge},\39\\{top\_edge}+\\{height}(\\{this%
\_box}))$;\6
\4\\{pdf\_end\_thread\_node}: \37\\{end\_thread};\6
\4\\{pdf\_save\_pos\_node}: \37\X1641:Save current position to \\{pdf\_last\_x%
\_pos}, \\{pdf\_last\_y\_pos}\X;\6
\4$\\{special\_node},\39\\{latespecial\_node}$: \37$\\{pdf\_special}(\|p)$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37\X1642:Save current position to \\{pdf%
\_snapx\_refpos}, \\{pdf\_snapy\_refpos}\X;\6
\4\\{pdf\_snapy\_comp\_node}: \37$\\{do\_snapy\_comp}(\|p,\39\\{this\_box})$;\6
\4\\{pdf\_snapy\_node}: \37$\\{do\_snapy}(\|p)$;\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\\{gen\_faked\_interword\_space}\K%
\\{true}$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\\{gen\_faked\_interword\_space}\K%
\\{false}$;\6
\4\\{pdf\_fake\_space\_node}: \37\\{pdf\_insert\_fake\_space};\6
\4\\{pdf\_running\_link\_off\_node}: \37$\\{gen\_running\_link}\K\\{false}$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\\{gen\_running\_link}\K\\{true}$;\6
\4\&{othercases} \37$\\{out\_what}(\|p)$;\2\6
\&{endcases}\par
\U741.\fi

\M1640. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{is\_shipping\_page}: \37\\{boolean};\C{set to \\{shipping\_page} when %
\\{pdf\_ship\_out} starts}\par
\fi

\M1641. \P$\X1641:Save current position to \\{pdf\_last\_x\_pos}, \\{pdf\_last%
\_y\_pos}\X\S$\6
\&{begin} \37$\\{pdf\_last\_x\_pos}\K\\{cur\_h}$;\6
\&{if} $\\{is\_shipping\_page}$ \1\&{then}\5
$\\{pdf\_last\_y\_pos}\K\\{cur\_page\_height}-\\{cur\_v}$\6
\4\&{else} $\\{pdf\_last\_y\_pos}\K\\{pdf\_xform\_height}+\\{pdf\_xform%
\_depth}-\\{cur\_v}$;\2\6
\&{end}\par
\Us1639\ET1645.\fi

\M1642. \P$\X1642:Save current position to \\{pdf\_snapx\_refpos}, \\{pdf%
\_snapy\_refpos}\X\S$\6
\&{begin} \37$\\{pdf\_snapx\_refpos}\K\\{cur\_h}$;\5
$\\{pdf\_snapy\_refpos}\K\\{cur\_v}$;\6
\&{end}\par
\Us1639\ET1645.\fi

\M1643. \P$\X1643:Output a Image node in a vlist\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{cur\_v}+\\{pdf\_height}(\|p)+\\{pdf\_depth}(\|p)$;%
\5
$\\{save\_v}\K\\{cur\_v}$;\5
$\\{cur\_h}\K\\{left\_edge}$;\5
$\\{out\_image}(\|p)$;\5
$\\{cur\_v}\K\\{save\_v}$;\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end}\par
\U1639.\fi

\M1644. \P$\X1644:Output a Form node in a vlist\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{cur\_v}+\\{pdf\_height}(\|p)$;\5
$\\{save\_v}\K\\{cur\_v}$;\5
$\\{cur\_h}\K\\{left\_edge}$;\5
$\\{out\_form}(\|p)$;\5
$\\{cur\_v}\K\\{save\_v}+\\{pdf\_depth}(\|p)$;\5
$\\{cur\_h}\K\\{left\_edge}$;\6
\&{end}\par
\U1639.\fi

\M1645. \P$\X1645:Output the whatsit node \|p in \\{pdf\_hlist\_out}\X\S$\6
\&{case} $\\{subtype}(\|p)$ \1\&{of}\6
\4$\\{pdf\_literal\_node},\39\\{pdf\_lateliteral\_node}$: \37$\\{pdf\_out%
\_literal}(\|p)$;\6
\4\\{pdf\_colorstack\_node}: \37$\\{pdf\_out\_colorstack}(\|p)$;\6
\4\\{pdf\_setmatrix\_node}: \37$\\{pdf\_out\_setmatrix}(\|p)$;\6
\4\\{pdf\_save\_node}: \37$\\{pdf\_out\_save}(\|p)$;\6
\4\\{pdf\_restore\_node}: \37$\\{pdf\_out\_restore}(\|p)$;\6
\4\\{pdf\_refobj\_node}: \37$\\{pdf\_append\_list}(\\{pdf\_obj\_objnum}(\|p))(%
\\{pdf\_obj\_list})$;\6
\4\\{pdf\_refxform\_node}: \37\X1647:Output a Form node in a hlist\X;\6
\4\\{pdf\_refximage\_node}: \37\X1646:Output a Image node in a hlist\X;\6
\4\\{pdf\_annot\_node}: \37$\\{do\_annot}(\|p,\39\\{this\_box},\39\\{left%
\_edge},\39\\{base\_line})$;\6
\4\\{pdf\_start\_link\_node}: \37$\\{do\_link}(\|p,\39\\{this\_box},\39\\{left%
\_edge},\39\\{base\_line})$;\6
\4\\{pdf\_end\_link\_node}: \37\\{end\_link};\6
\4\\{pdf\_dest\_node}: \37$\\{do\_dest}(\|p,\39\\{this\_box},\39\\{left\_edge},%
\39\\{base\_line})$;\6
\4\\{pdf\_thread\_node}: \37$\\{do\_thread}(\|p,\39\\{this\_box},\39\\{left%
\_edge},\39\\{base\_line})$;\6
\4\\{pdf\_start\_thread\_node}: \37$\\{pdf\_error}(\.{"ext4"},\39\.{"%
\\pdfstartthread\ ended\ up\ in\ hlist"})$;\6
\4\\{pdf\_end\_thread\_node}: \37$\\{pdf\_error}(\.{"ext4"},\39\.{"%
\\pdfendthread\ ended\ up\ in\ hlist"})$;\6
\4\\{pdf\_save\_pos\_node}: \37\X1641:Save current position to \\{pdf\_last\_x%
\_pos}, \\{pdf\_last\_y\_pos}\X;\6
\4$\\{special\_node},\39\\{latespecial\_node}$: \37$\\{pdf\_special}(\|p)$;\6
\4\\{pdf\_snap\_ref\_point\_node}: \37\X1642:Save current position to \\{pdf%
\_snapx\_refpos}, \\{pdf\_snapy\_refpos}\X;\6
\4$\\{pdf\_snapy\_comp\_node},\39\\{pdf\_snapy\_node}$: \37\\{do\_nothing};%
\C{snapy nodes do nothing in hlist}\6
\4\\{pdf\_interword\_space\_on\_node}: \37$\\{gen\_faked\_interword\_space}\K%
\\{true}$;\6
\4\\{pdf\_interword\_space\_off\_node}: \37$\\{gen\_faked\_interword\_space}\K%
\\{false}$;\6
\4\\{pdf\_fake\_space\_node}: \37\\{pdf\_insert\_fake\_space};\6
\4\\{pdf\_running\_link\_off\_node}: \37$\\{gen\_running\_link}\K\\{false}$;\6
\4\\{pdf\_running\_link\_on\_node}: \37$\\{gen\_running\_link}\K\\{true}$;\6
\4\&{othercases} \37$\\{out\_what}(\|p)$;\2\6
\&{endcases}\par
\U732.\fi

\M1646. \P$\X1646:Output a Image node in a hlist\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{base\_line}+\\{pdf\_depth}(\|p)$;\5
$\\{edge}\K\\{cur\_h}$;\5
$\\{out\_image}(\|p)$;\5
$\\{cur\_h}\K\\{edge}+\\{pdf\_width}(\|p)$;\5
$\\{cur\_v}\K\\{base\_line}$;\6
\&{end}\par
\U1645.\fi

\M1647. \P$\X1647:Output a Form node in a hlist\X\S$\6
\&{begin} \37$\\{cur\_v}\K\\{base\_line}$;\5
$\\{edge}\K\\{cur\_h}$;\5
$\\{out\_form}(\|p)$;\5
$\\{cur\_h}\K\\{edge}+\\{pdf\_width}(\|p)$;\5
$\\{cur\_v}\K\\{base\_line}$;\6
\&{end}\par
\U1645.\fi

\N1648.  \[53a] The extended features of \eTeX.
The program has two modes of operation:  (1)~In \TeX\ compatibility mode
it fully deserves the name \TeX\ and there are neither extended features
nor additional primitive commands.  There are, however, a few
modifications that would be legitimate in any implementation of \TeX\
such as, e.g., preventing inadequate results of the glue to \.{DVI}
unit conversion during \\{ship\_out}.  (2)~In extended mode there are
additional primitive commands and the extended features of \eTeX\ are
available.

The distinction between these two modes of operation initially takes
place when a `virgin' \.{eINITEX} starts without reading a format file.
Later on the values of all \eTeX\ state variables are inherited when
\.{eVIRTEX} (or \.{eINITEX}) reads a format file.

The code below is designed to work for cases where `$ \&{init} \ldots  \&{tini}
$'
is a run-time switch.

\Y\P$\4\X1648:Enable \eTeX, if requested\X\S$\6
\&{init} \37\&{if} $(\\{buffer}[\\{loc}]=\.{"*"})\W(\\{format\_ident}=\.{"\
(INITEX)"})$ \1\&{then}\6
\&{begin} \37$\\{no\_new\_control\_sequence}\K\\{false}$;\5
\X1649:Generate all \eTeX\ primitives\X\6
$\\{incr}(\\{loc})$;\5
$\\{eTeX\_mode}\K1$;\C{enter extended mode}\6
\X1813:Initialize variables for \eTeX\ extended mode\X\6
\&{end};\2\6
\&{tini}\6
\&{if} $\R\\{no\_new\_control\_sequence}$ \1\&{then}\C{just entered extended
mode ?}\6
$\\{no\_new\_control\_sequence}\K\\{true}$\ \&{else} \2\par
\U1517.\fi

\M1649. The \eTeX\ features available in extended mode are grouped into two
categories:  (1)~Some of them are permanently enabled and have no
semantic effect as long as none of the additional primitives are
executed.  (2)~The remaining \eTeX\ features are optional and can be
individually enabled and disabled.  For each optional feature there is
an \eTeX\ state variable named \.{\\...state}; the feature is enabled,
resp.\ disabled by assigning a positive, resp.\ non-positive value to
that integer.

\Y\P\D \37$\\{eTeX\_state\_base}=\\{int\_base}+\\{eTeX\_state\_code}$\par
\P\D \37$\\{eTeX\_state}(\#)\S\\{eqtb}[\\{eTeX\_state\_base}+\#].\\{int}$\C{an %
\eTeX\ state variable}\Y\par
\P\D \37$\\{eTeX\_version\_code}=\\{eTeX\_int}$\C{code for \.{\\eTeXversion}}%
\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\S$\6
$\\{primitive}(\.{"lastnodetype"},\39\\{last\_item},\39\\{last\_node\_type%
\_code})$;\5
$\\{primitive}(\.{"eTeXversion"},\39\\{last\_item},\39\\{eTeX\_version%
\_code})$;\5
$\\{primitive}(\.{"eTeXrevision"},\39\\{convert},\39\\{eTeX\_revision\_code})$;%
\par
\As1657, 1663, 1666, 1669, 1672, 1675, 1684, 1686, 1689, 1692, 1697, 1701,
1747, 1759, 1762, 1770, 1778, 1801, 1805, 1809, 1861\ETs1864.
\U1648.\fi

\M1650. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\S$\6
\4\\{last\_node\_type\_code}: \37$\\{print\_esc}(\.{"lastnodetype"})$;\6
\4\\{eTeX\_version\_code}: \37$\\{print\_esc}(\.{"eTeXversion"})$;\par
\As1664, 1667, 1670, 1673, 1779, 1802\ETs1806.
\U443.\fi

\M1651. \P$\X1651:Cases for fetching an integer value\X\S$\6
\4\\{eTeX\_version\_code}: \37$\\{cur\_val}\K\\{eTeX\_version}$;\par
\As1665, 1668\ETs1803.
\U450.\fi

\M1652. \P\D \37$\\{eTeX\_ex}\S(\\{eTeX\_mode}=1)$\C{is this extended mode?}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{eTeX\_mode}: \37$0\to1$;\C{identifies compatibility and extended mode}\par
\fi

\M1653. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X%
\mathrel{+}\S$\6
$\\{eTeX\_mode}\K0$;\C{initially we are in compatibility mode}\6
\X1812:Initialize variables for \eTeX\ compatibility mode\X\par
\fi

\M1654. \P$\X1654:Dump the \eTeX\ state\X\S$\6
$\\{dump\_int}(\\{eTeX\_mode})$;\6
\&{for} $\|j\K0\mathrel{\&{to}}\\{eTeX\_states}-1$ \1\&{do}\5
$\\{eTeX\_state}(\|j)\K0$;\C{disable all enhancements}\2\par
\A1758.
\U1485.\fi

\M1655. \P$\X1655:Undump the \eTeX\ state\X\S$\6
$\\{undump}(0)(1)(\\{eTeX\_mode})$;\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37\X1813:Initialize variables for \eTeX\ extended mode\X\6
\&{end}\6
\4\&{else} \&{begin} \37\X1812:Initialize variables for \eTeX\ compatibility
mode\X\6
\&{end};\2\par
\U1486.\fi

\M1656. The \\{eTeX\_enabled} function simply returns its first argument as
result.  This argument is \\{true} if an optional \eTeX\ feature is
currently enabled; otherwise, if the argument is \\{false}, the function
gives an error message.

\Y\P$\4\X1656:Declare \eTeX\ procedures for use by \\{main\_control}\X\S$\6
\4\&{function}\1\  \37$\\{eTeX\_enabled}(\|b:\\{boolean};\,\35\|j:%
\\{quarterword};\,\35\|k:\\{halfword})$: \37\\{boolean};\2\6
\&{begin} \37\&{if} $\R\|b$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Improper\ "})$;\5
$\\{print\_cmd\_chr}(\|j,\39\|k)$;\5
$\\{help1}(\.{"Sorry,\ this\ optional\ e-TeX\ feature\ has\ been\
disabled."})$;\5
\\{error};\6
\&{end};\2\6
$\\{eTeX\_enabled}\K\|b$;\6
\&{end};\par
\As1679\ET1695.
\U991.\fi

\M1657. First we implement the additional \eTeX\ parameters in the table of
equivalents.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"everyeof"},\39\\{assign\_toks},\39\\{every\_eof\_loc})$;\5
$\\{primitive}(\.{"tracingassigns"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_assigns\_code})$;\6
$\\{primitive}(\.{"tracinggroups"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_groups\_code})$;\6
$\\{primitive}(\.{"tracingifs"},\39\\{assign\_int},\39\\{int\_base}+\\{tracing%
\_ifs\_code})$;\6
$\\{primitive}(\.{"tracingscantokens"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_scan\_tokens\_code})$;\6
$\\{primitive}(\.{"tracingnesting"},\39\\{assign\_int},\39\\{int\_base}+%
\\{tracing\_nesting\_code})$;\6
$\\{primitive}(\.{"predisplaydirection"},\39\\{assign\_int},\39\\{int\_base}+%
\\{pre\_display\_direction\_code})$;\6
$\\{primitive}(\.{"lastlinefit"},\39\\{assign\_int},\39\\{int\_base}+\\{last%
\_line\_fit\_code})$;\6
$\\{primitive}(\.{"savingvdiscards"},\39\\{assign\_int},\39\\{int\_base}+%
\\{saving\_vdiscards\_code})$;\6
$\\{primitive}(\.{"savinghyphcodes"},\39\\{assign\_int},\39\\{int\_base}+%
\\{saving\_hyph\_codes\_code})$;\par
\fi

\M1658. \P\D \37$\\{every\_eof}\S\\{equiv}(\\{every\_eof\_loc})$\par
\Y\P$\4\X1658:Cases of \\{assign\_toks} for \\{print\_cmd\_chr}\X\S$\6
\4\\{every\_eof\_loc}: \37$\\{print\_esc}(\.{"everyeof"})$;\par
\U249.\fi

\M1659. \P$\X1659:Cases for \\{print\_param}\X\S$\6
\4\\{tracing\_assigns\_code}: \37$\\{print\_esc}(\.{"tracingassigns"})$;\6
\4\\{tracing\_groups\_code}: \37$\\{print\_esc}(\.{"tracinggroups"})$;\6
\4\\{tracing\_ifs\_code}: \37$\\{print\_esc}(\.{"tracingifs"})$;\6
\4\\{tracing\_scan\_tokens\_code}: \37$\\{print\_esc}(%
\.{"tracingscantokens"})$;\6
\4\\{tracing\_nesting\_code}: \37$\\{print\_esc}(\.{"tracingnesting"})$;\6
\4\\{pre\_display\_direction\_code}: \37$\\{print\_esc}(%
\.{"predisplaydirection"})$;\6
\4\\{last\_line\_fit\_code}: \37$\\{print\_esc}(\.{"lastlinefit"})$;\6
\4\\{saving\_vdiscards\_code}: \37$\\{print\_esc}(\.{"savingvdiscards"})$;\6
\4\\{saving\_hyph\_codes\_code}: \37$\\{print\_esc}(\.{"savinghyphcodes"})$;\par
\A1700.
\U255.\fi

\M1660. In order to handle \.{\\everyeof} we need an array \\{eof\_seen} of
boolean variables.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{eof\_seen}: \37\&{array} $[1\to\\{max\_in\_open}]$ \1\&{of}\5
\\{boolean};\C{has eof been seen?}\2\par
\fi

\M1661. The \\{print\_group} procedure prints the current level of grouping and
the name corresponding to \\{cur\_group}.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_group}(\|e:\\{boolean})$;\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\&{case} $\\{cur\_group}$ \1\&{of}\6
\4\\{bottom\_level}: \37\&{begin} \37$\\{print}(\.{"bottom\ level"})$;\5
\&{return};\6
\&{end};\6
\4$\\{simple\_group},\39\\{semi\_simple\_group}$: \37\&{begin} \37\&{if} $%
\\{cur\_group}=\\{semi\_simple\_group}$ \1\&{then}\5
$\\{print}(\.{"semi\ "})$;\2\6
$\\{print}(\.{"simple"})$;\6
\&{end};\6
\4$\\{hbox\_group},\39\\{adjusted\_hbox\_group}$: \37\&{begin} \37\&{if} $%
\\{cur\_group}=\\{adjusted\_hbox\_group}$ \1\&{then}\5
$\\{print}(\.{"adjusted\ "})$;\2\6
$\\{print}(\.{"hbox"})$;\6
\&{end};\6
\4\\{vbox\_group}: \37$\\{print}(\.{"vbox"})$;\6
\4\\{vtop\_group}: \37$\\{print}(\.{"vtop"})$;\6
\4$\\{align\_group},\39\\{no\_align\_group}$: \37\&{begin} \37\&{if} $\\{cur%
\_group}=\\{no\_align\_group}$ \1\&{then}\5
$\\{print}(\.{"no\ "})$;\2\6
$\\{print}(\.{"align"})$;\6
\&{end};\6
\4\\{output\_group}: \37$\\{print}(\.{"output"})$;\6
\4\\{disc\_group}: \37$\\{print}(\.{"disc"})$;\6
\4\\{insert\_group}: \37$\\{print}(\.{"insert"})$;\6
\4\\{vcenter\_group}: \37$\\{print}(\.{"vcenter"})$;\6
\4$\\{math\_group},\39\\{math\_choice\_group},\39\\{math\_shift\_group},\39%
\\{math\_left\_group}$: \37\&{begin} \37$\\{print}(\.{"math"})$;\6
\&{if} $\\{cur\_group}=\\{math\_choice\_group}$ \1\&{then}\5
$\\{print}(\.{"\ choice"})$\6
\4\&{else} \&{if} $\\{cur\_group}=\\{math\_shift\_group}$ \1\&{then}\5
$\\{print}(\.{"\ shift"})$\6
\4\&{else} \&{if} $\\{cur\_group}=\\{math\_left\_group}$ \1\&{then}\5
$\\{print}(\.{"\ left"})$;\2\2\2\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
$\\{print}(\.{"\ group\ (level\ "})$;\5
$\\{print\_int}(\\{qo}(\\{cur\_level}))$;\5
$\\{print\_char}(\.{")"})$;\6
\&{if} $\\{saved}(-1)\I0$ \1\&{then}\6
\&{begin} \37\&{if} $\|e$ \1\&{then}\5
$\\{print}(\.{"\ entered\ at\ line\ "})$\6
\4\&{else} $\\{print}(\.{"\ at\ line\ "})$;\2\6
$\\{print\_int}(\\{saved}(-1))$;\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1662. The \\{group\_trace} procedure is called when a new level of grouping
begins ($\|e=\\{false}$) or ends ($\|e=\\{true}$) with $\\{saved}(-1)$
containing the
line number.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\&{stat} \37\&{procedure}\1\  \37$\\{group\_trace}(\|e:\\{boolean})$;\2\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_char}(\.{"\{"})$;\6
\&{if} $\|e$ \1\&{then}\5
$\\{print}(\.{"leaving\ "})$\6
\4\&{else} $\\{print}(\.{"entering\ "})$;\2\6
$\\{print\_group}(\|e)$;\5
$\\{print\_char}(\.{"\}"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\6
\&{tats}\par
\fi

\M1663. The \.{\\currentgrouplevel} and \.{\\currentgrouptype} commands return
the current level of grouping and the type of the current group
respectively.

\Y\P\D \37$\\{current\_group\_level\_code}=\\{eTeX\_int}+1$\C{code for \.{%
\\currentgrouplevel}}\par
\P\D \37$\\{current\_group\_type\_code}=\\{eTeX\_int}+2$\C{code for \.{%
\\currentgrouptype}}\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"currentgrouplevel"},\39\\{last\_item},\39\\{current\_group%
\_level\_code})$;\5
$\\{primitive}(\.{"currentgrouptype"},\39\\{last\_item},\39\\{current\_group%
\_type\_code})$;\par
\fi

\M1664. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{current\_group\_level\_code}: \37$\\{print\_esc}(%
\.{"currentgrouplevel"})$;\6
\4\\{current\_group\_type\_code}: \37$\\{print\_esc}(\.{"currentgrouptype"})$;%
\par
\fi

\M1665. \P$\X1651:Cases for fetching an integer value\X\mathrel{+}\S$\6
\4\\{current\_group\_level\_code}: \37$\\{cur\_val}\K\\{cur\_level}-\\{level%
\_one}$;\6
\4\\{current\_group\_type\_code}: \37$\\{cur\_val}\K\\{cur\_group}$;\par
\fi

\M1666. The \.{\\currentiflevel}, \.{\\currentiftype}, and
\.{\\currentifbranch} commands return the current level of conditionals
and the type and branch of the current conditional.

\Y\P\D \37$\\{current\_if\_level\_code}=\\{eTeX\_int}+3$\C{code for \.{%
\\currentiflevel}}\par
\P\D \37$\\{current\_if\_type\_code}=\\{eTeX\_int}+4$\C{code for \.{%
\\currentiftype}}\par
\P\D \37$\\{current\_if\_branch\_code}=\\{eTeX\_int}+5$\C{code for \.{%
\\currentifbranch}}\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"currentiflevel"},\39\\{last\_item},\39\\{current\_if\_level%
\_code})$;\5
$\\{primitive}(\.{"currentiftype"},\39\\{last\_item},\39\\{current\_if\_type%
\_code})$;\5
$\\{primitive}(\.{"currentifbranch"},\39\\{last\_item},\39\\{current\_if%
\_branch\_code})$;\par
\fi

\M1667. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{current\_if\_level\_code}: \37$\\{print\_esc}(\.{"currentiflevel"})$;\6
\4\\{current\_if\_type\_code}: \37$\\{print\_esc}(\.{"currentiftype"})$;\6
\4\\{current\_if\_branch\_code}: \37$\\{print\_esc}(\.{"currentifbranch"})$;\par
\fi

\M1668. \P$\X1651:Cases for fetching an integer value\X\mathrel{+}\S$\6
\4\\{current\_if\_level\_code}: \37\&{begin} \37$\|q\K\\{cond\_ptr}$;\5
$\\{cur\_val}\K0$;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{incr}(\\{cur\_val})$;\5
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\6
\&{end};\6
\4\\{current\_if\_type\_code}: \37\&{if} $\\{cond\_ptr}=\\{null}$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} \&{if} $\\{cur\_if}<\\{unless\_code}$ \1\&{then}\5
$\\{cur\_val}\K\\{cur\_if}+1$\6
\4\&{else} $\\{cur\_val}\K-(\\{cur\_if}-\\{unless\_code}+1)$;\2\2\6
\4\\{current\_if\_branch\_code}: \37\&{if} $(\\{if\_limit}=\\{or\_code})\V(%
\\{if\_limit}=\\{else\_code})$ \1\&{then}\5
$\\{cur\_val}\K1$\6
\4\&{else} \&{if} $\\{if\_limit}=\\{fi\_code}$ \1\&{then}\5
$\\{cur\_val}\K-1$\6
\4\&{else} $\\{cur\_val}\K0$;\2\2\par
\fi

\M1669. The \.{\\fontcharwd}, \.{\\fontcharht}, \.{\\fontchardp}, and
\.{\\fontcharic} commands return information about a character in a
font.

\Y\P\D \37$\\{font\_char\_wd\_code}=\\{eTeX\_dim}$\C{code for \.{\\fontcharwd}}%
\par
\P\D \37$\\{font\_char\_ht\_code}=\\{eTeX\_dim}+1$\C{code for \.{\\fontcharht}}%
\par
\P\D \37$\\{font\_char\_dp\_code}=\\{eTeX\_dim}+2$\C{code for \.{\\fontchardp}}%
\par
\P\D \37$\\{font\_char\_ic\_code}=\\{eTeX\_dim}+3$\C{code for \.{\\fontcharic}}%
\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"fontcharwd"},\39\\{last\_item},\39\\{font\_char\_wd%
\_code})$;\5
$\\{primitive}(\.{"fontcharht"},\39\\{last\_item},\39\\{font\_char\_ht%
\_code})$;\5
$\\{primitive}(\.{"fontchardp"},\39\\{last\_item},\39\\{font\_char\_dp%
\_code})$;\5
$\\{primitive}(\.{"fontcharic"},\39\\{last\_item},\39\\{font\_char\_ic%
\_code})$;\par
\fi

\M1670. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{font\_char\_wd\_code}: \37$\\{print\_esc}(\.{"fontcharwd"})$;\6
\4\\{font\_char\_ht\_code}: \37$\\{print\_esc}(\.{"fontcharht"})$;\6
\4\\{font\_char\_dp\_code}: \37$\\{print\_esc}(\.{"fontchardp"})$;\6
\4\\{font\_char\_ic\_code}: \37$\\{print\_esc}(\.{"fontcharic"})$;\par
\fi

\M1671. \P$\X1671:Cases for fetching a dimension value\X\S$\6
\4$\\{font\_char\_wd\_code},\39\\{font\_char\_ht\_code},\39\\{font\_char\_dp%
\_code},\39\\{font\_char\_ic\_code}$: \37\&{begin} \37\\{scan\_font\_ident};\5
$\|q\K\\{cur\_val}$;\5
\\{scan\_char\_num};\6
\&{if} $(\\{font\_bc}[\|q]\L\\{cur\_val})\W(\\{font\_ec}[\|q]\G\\{cur\_val})$ %
\1\&{then}\6
\&{begin} \37$\|i\K\\{char\_info}(\|q)(\\{qi}(\\{cur\_val}))$;\6
\&{case} $\|m$ \1\&{of}\6
\4\\{font\_char\_wd\_code}: \37$\\{cur\_val}\K\\{char\_width}(\|q)(\|i)$;\6
\4\\{font\_char\_ht\_code}: \37$\\{cur\_val}\K\\{char\_height}(\|q)(\\{height%
\_depth}(\|i))$;\6
\4\\{font\_char\_dp\_code}: \37$\\{cur\_val}\K\\{char\_depth}(\|q)(\\{height%
\_depth}(\|i))$;\6
\4\\{font\_char\_ic\_code}: \37$\\{cur\_val}\K\\{char\_italic}(\|q)(\|i)$;\2\6
\&{end};\C{there are no other cases}\6
\&{end}\6
\4\&{else} $\\{cur\_val}\K0$;\2\6
\&{end};\par
\As1674\ET1804.
\U450.\fi

\M1672. The \.{\\parshapedimen}, \.{\\parshapeindent}, and \.{\\parshapelength}
commands return the indent and length parameters of the current
\.{\\parshape} specification.

\Y\P\D \37$\\{par\_shape\_length\_code}=\\{eTeX\_dim}+4$\C{code for \.{%
\\parshapelength}}\par
\P\D \37$\\{par\_shape\_indent\_code}=\\{eTeX\_dim}+5$\C{code for \.{%
\\parshapeindent}}\par
\P\D \37$\\{par\_shape\_dimen\_code}=\\{eTeX\_dim}+6$\C{code for \.{%
\\parshapedimen}}\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"parshapelength"},\39\\{last\_item},\39\\{par\_shape\_length%
\_code})$;\5
$\\{primitive}(\.{"parshapeindent"},\39\\{last\_item},\39\\{par\_shape\_indent%
\_code})$;\5
$\\{primitive}(\.{"parshapedimen"},\39\\{last\_item},\39\\{par\_shape\_dimen%
\_code})$;\par
\fi

\M1673. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{par\_shape\_length\_code}: \37$\\{print\_esc}(\.{"parshapelength"})$;\6
\4\\{par\_shape\_indent\_code}: \37$\\{print\_esc}(\.{"parshapeindent"})$;\6
\4\\{par\_shape\_dimen\_code}: \37$\\{print\_esc}(\.{"parshapedimen"})$;\par
\fi

\M1674. \P$\X1671:Cases for fetching a dimension value\X\mathrel{+}\S$\6
\4$\\{par\_shape\_length\_code},\39\\{par\_shape\_indent\_code},\39\\{par%
\_shape\_dimen\_code}$: \37\&{begin} \37$\|q\K\\{cur\_chr}-\\{par\_shape%
\_length\_code}$;\5
\\{scan\_int};\6
\&{if} $(\\{par\_shape\_ptr}=\\{null})\V(\\{cur\_val}\L0)$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} \&{begin} \37\&{if} $\|q=2$ \1\&{then}\6
\&{begin} \37$\|q\K\\{cur\_val}\mathbin{\&{mod}}2$;\5
$\\{cur\_val}\K(\\{cur\_val}+\|q)\mathbin{\&{div}}2$;\6
\&{end};\2\6
\&{if} $\\{cur\_val}>\\{info}(\\{par\_shape\_ptr})$ \1\&{then}\5
$\\{cur\_val}\K\\{info}(\\{par\_shape\_ptr})$;\2\6
$\\{cur\_val}\K\\{mem}[\\{par\_shape\_ptr}+2\ast\\{cur\_val}-\|q].\\{sc}$;\6
\&{end};\2\6
$\\{cur\_val\_level}\K\\{dimen\_val}$;\6
\&{end};\par
\fi

\M1675. The \.{\\showgroups} command displays all currently active grouping
levels.

\Y\P\D \37$\\{show\_groups}=4$\C{ \.{\\showgroups} }\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"showgroups"},\39\\{xray},\39\\{show\_groups})$;\par
\fi

\M1676. \P$\X1676:Cases of \\{xray} for \\{print\_cmd\_chr}\X\S$\6
\4\\{show\_groups}: \37$\\{print\_esc}(\.{"showgroups"})$;\par
\As1685\ET1690.
\U1470.\fi

\M1677. \P$\X1677:Cases for \\{show\_whatever}\X\S$\6
\4\\{show\_groups}: \37\&{begin} \37\\{begin\_diagnostic};\5
\\{show\_save\_groups};\6
\&{end};\par
\A1691.
\U1471.\fi

\M1678. \P$\X18:Types in the outer block\X\mathrel{+}\S$\6
$\\{save\_pointer}=0\to\\{save\_size}$;\C{index into \\{save\_stack}}\par
\fi

\M1679. The modifications of \TeX\ required for the display produced by the
\\{show\_save\_groups} procedure were first discussed by Donald~E. Knuth in
{\sl TUGboat\/} {\bf 11}, 165--170 and 499--511, 1990.

In order to understand a group type we also have to know its mode.
Since unrestricted horizontal modes are not associated with grouping,
they are skipped when traversing the semantic nest.

\Y\P$\4\X1656:Declare \eTeX\ procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{show\_save\_groups};\6
\4\&{label} \37$\\{found1},\39\\{found2},\39\\{found},\39\\{done}$;\6
\4\&{var} \37\|p: \37$0\to\\{nest\_size}$;\C{index into \\{nest}}\6
\|m: \37$-\\{mmode}\to\\{mmode}$;\C{mode}\6
\|v: \37\\{save\_pointer};\C{saved value of \\{save\_ptr}}\6
\|l: \37\\{quarterword};\C{saved value of \\{cur\_level}}\6
\|c: \37\\{group\_code};\C{saved value of \\{cur\_group}}\6
\|a: \37$-1\to1$;\C{to keep track of alignments}\6
\|i: \37\\{integer};\5
\|j: \37\\{quarterword};\5
\|s: \37\\{str\_number};\2\6
\&{begin} \37$\|p\K\\{nest\_ptr}$;\5
$\\{nest}[\|p]\K\\{cur\_list}$;\C{put the top level into the array}\6
$\|v\K\\{save\_ptr}$;\5
$\|l\K\\{cur\_level}$;\5
$\|c\K\\{cur\_group}$;\5
$\\{save\_ptr}\K\\{cur\_boundary}$;\5
$\\{decr}(\\{cur\_level})$;\6
$\|a\K1$;\5
$\\{print\_nl}(\.{""})$;\5
\\{print\_ln};\6
\~ \1\&{loop}\ \&{begin} \37$\\{print\_nl}(\.{"\#\#\#\ "})$;\5
$\\{print\_group}(\\{true})$;\6
\&{if} $\\{cur\_group}=\\{bottom\_level}$ \1\&{then}\5
\&{goto} \37\\{done};\2\6
\1\&{repeat} \37$\|m\K\\{nest}[\|p].\\{mode\_field}$;\6
\&{if} $\|p>0$ \1\&{then}\5
$\\{decr}(\|p)$\6
\4\&{else} $\|m\K\\{vmode}$;\2\6
\4\&{until}\5
$\|m\I\\{hmode}$;\2\6
$\\{print}(\.{"\ ("})$;\6
\&{case} $\\{cur\_group}$ \1\&{of}\6
\4\\{simple\_group}: \37\&{begin} \37$\\{incr}(\|p)$;\5
\&{goto} \37\\{found2};\6
\&{end};\6
\4$\\{hbox\_group},\39\\{adjusted\_hbox\_group}$: \37$\|s\K\.{"hbox"}$;\6
\4\\{vbox\_group}: \37$\|s\K\.{"vbox"}$;\6
\4\\{vtop\_group}: \37$\|s\K\.{"vtop"}$;\6
\4\\{align\_group}: \37\&{if} $\|a=0$ \1\&{then}\6
\&{begin} \37\&{if} $\|m=-\\{vmode}$ \1\&{then}\5
$\|s\K\.{"halign"}$\6
\4\&{else} $\|s\K\.{"valign"}$;\2\6
$\|a\K1$;\5
\&{goto} \37\\{found1};\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\|a=1$ \1\&{then}\5
$\\{print}(\.{"align\ entry"})$\6
\4\&{else} $\\{print\_esc}(\.{"cr"})$;\2\6
\&{if} $\|p\G\|a$ \1\&{then}\5
$\|p\K\|p-\|a$;\2\6
$\|a\K0$;\5
\&{goto} \37\\{found};\6
\&{end};\2\6
\4\\{no\_align\_group}: \37\&{begin} \37$\\{incr}(\|p)$;\5
$\|a\K-1$;\5
$\\{print\_esc}(\.{"noalign"})$;\5
\&{goto} \37\\{found2};\6
\&{end};\6
\4\\{output\_group}: \37\&{begin} \37$\\{print\_esc}(\.{"output"})$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4\\{math\_group}: \37\&{goto} \37\\{found2};\6
\4$\\{disc\_group},\39\\{math\_choice\_group}$: \37\&{begin} \37\&{if} $\\{cur%
\_group}=\\{disc\_group}$ \1\&{then}\5
$\\{print\_esc}(\.{"discretionary"})$\6
\4\&{else} $\\{print\_esc}(\.{"mathchoice"})$;\2\6
\&{for} $\|i\K1\mathrel{\&{to}}3$ \1\&{do}\6
\&{if} $\|i\L\\{saved}(-2)$ \1\&{then}\5
$\\{print}(\.{"\{\}"})$;\2\2\6
\&{goto} \37\\{found2};\6
\&{end};\6
\4\\{insert\_group}: \37\&{begin} \37\&{if} $\\{saved}(-2)=255$ \1\&{then}\5
$\\{print\_esc}(\.{"vadjust"})$\6
\4\&{else} \&{begin} \37$\\{print\_esc}(\.{"insert"})$;\5
$\\{print\_int}(\\{saved}(-2))$;\6
\&{end};\2\6
\&{goto} \37\\{found2};\6
\&{end};\6
\4\\{vcenter\_group}: \37\&{begin} \37$\|s\K\.{"vcenter"}$;\5
\&{goto} \37\\{found1};\6
\&{end};\6
\4\\{semi\_simple\_group}: \37\&{begin} \37$\\{incr}(\|p)$;\5
$\\{print\_esc}(\.{"begingroup"})$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4\\{math\_shift\_group}: \37\&{begin} \37\&{if} $\|m=\\{mmode}$ \1\&{then}\5
$\\{print\_char}(\.{"\$"})$\6
\4\&{else} \&{if} $\\{nest}[\|p].\\{mode\_field}=\\{mmode}$ \1\&{then}\6
\&{begin} \37$\\{print\_cmd\_chr}(\\{eq\_no},\39\\{saved}(-2))$;\5
\&{goto} \37\\{found};\6
\&{end};\2\2\6
$\\{print\_char}(\.{"\$"})$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4\\{math\_left\_group}: \37\&{begin} \37\&{if} $\\{type}(\\{nest}[\|p+1].%
\\{eTeX\_aux\_field})=\\{left\_noad}$ \1\&{then}\5
$\\{print\_esc}(\.{"left"})$\6
\4\&{else} $\\{print\_esc}(\.{"middle"})$;\2\6
\&{goto} \37\\{found};\6
\&{end};\2\6
\&{end};\C{there are no other cases}\6
\X1681:Show the box context\X;\6
\4\\{found1}: \37$\\{print\_esc}(\|s)$;\5
\X1680:Show the box packaging info\X;\6
\4\\{found2}: \37$\\{print\_char}(\.{"\{"})$;\6
\4\\{found}: \37$\\{print\_char}(\.{")"})$;\5
$\\{decr}(\\{cur\_level})$;\5
$\\{cur\_group}\K\\{save\_level}(\\{save\_ptr})$;\5
$\\{save\_ptr}\K\\{save\_index}(\\{save\_ptr})$\6
\&{end};\2\6
\4\\{done}: \37$\\{save\_ptr}\K\|v$;\5
$\\{cur\_level}\K\|l$;\5
$\\{cur\_group}\K\|c$;\6
\&{end};\par
\fi

\M1680. \P$\X1680:Show the box packaging info\X\S$\6
\&{if} $\\{saved}(-2)\I0$ \1\&{then}\6
\&{begin} \37$\\{print\_char}(\.{"\ "})$;\6
\&{if} $\\{saved}(-3)=\\{exactly}$ \1\&{then}\5
$\\{print}(\.{"to"})$\6
\4\&{else} $\\{print}(\.{"spread"})$;\2\6
$\\{print\_scaled}(\\{saved}(-2))$;\5
$\\{print}(\.{"pt"})$;\6
\&{end}\2\par
\U1679.\fi

\M1681. \P$\X1681:Show the box context\X\S$\6
$\|i\K\\{saved}(-4)$;\6
\&{if} $\|i\I0$ \1\&{then}\6
\&{if} $\|i<\\{box\_flag}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{abs}(\\{nest}[\|p].\\{mode\_field})=\\{vmode}$ \1%
\&{then}\5
$\|j\K\\{hmove}$\6
\4\&{else} $\|j\K\\{vmove}$;\2\6
\&{if} $\|i>0$ \1\&{then}\5
$\\{print\_cmd\_chr}(\|j,\390)$\6
\4\&{else} $\\{print\_cmd\_chr}(\|j,\391)$;\2\6
$\\{print\_scaled}(\\{abs}(\|i))$;\5
$\\{print}(\.{"pt"})$;\6
\&{end}\6
\4\&{else} \&{if} $\|i<\\{ship\_out\_flag}$ \1\&{then}\6
\&{begin} \37\&{if} $\|i\G\\{global\_box\_flag}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"global"})$;\5
$\|i\K\|i-(\\{global\_box\_flag}-\\{box\_flag})$;\6
\&{end};\2\6
$\\{print\_esc}(\.{"setbox"})$;\5
$\\{print\_int}(\|i-\\{box\_flag})$;\5
$\\{print\_char}(\.{"="})$;\6
\&{end}\6
\4\&{else} $\\{print\_cmd\_chr}(\\{leader\_ship},\39\|i-(\\{leader\_flag}-\\{a%
\_leaders}))$\2\2\2\par
\U1679.\fi

\M1682. The \\{scan\_general\_text} procedure is much like $\\{scan\_toks}(%
\\{false},\\{false})$,
but will be invoked via \\{expand}, i.e., recursively.

\Y\P$\4\X1682:Declare \eTeX\ procedures for scanning\X\S$\6
\4\&{procedure}\1\  \37\\{scan\_general\_text};\5
\\{forward};\5
\hbox{\2}\par
\As1772, 1781\ETs1786.
\U435.\fi

\M1683. The token list (balanced text) created by \\{scan\_general\_text}
begins
at $\\{link}(\\{temp\_head})$ and ends at \\{cur\_val}.  (If $\\{cur\_val}=%
\\{temp\_head}$,
the list is empty.)

\Y\P$\4\X1683:Declare \eTeX\ procedures for token lists\X\S$\6
\4\&{procedure}\1\  \37\\{scan\_general\_text};\6
\4\&{label} \37\\{found};\6
\4\&{var} \37\|s: \37$\\{normal}\to\\{absorbing}$;\C{to save \\{scanner%
\_status}}\6
\|w: \37\\{pointer};\C{to save \\{warning\_index}}\6
\|d: \37\\{pointer};\C{to save \\{def\_ref}}\6
\|p: \37\\{pointer};\C{tail of the token list being built}\6
\|q: \37\\{pointer};\C{new node being added to the token list via \\{store\_new%
\_token}}\6
\\{unbalance}: \37\\{halfword};\C{number of unmatched left braces}\2\6
\&{begin} \37$\|s\K\\{scanner\_status}$;\5
$\|w\K\\{warning\_index}$;\5
$\|d\K\\{def\_ref}$;\5
$\\{scanner\_status}\K\\{absorbing}$;\5
$\\{warning\_index}\K\\{cur\_cs}$;\5
$\\{def\_ref}\K\\{get\_avail}$;\5
$\\{token\_ref\_count}(\\{def\_ref})\K\\{null}$;\5
$\|p\K\\{def\_ref}$;\5
\\{scan\_left\_brace};\C{remove the compulsory left brace}\6
$\\{unbalance}\K1$;\6
\~ \1\&{loop}\ \&{begin} \37\\{get\_token};\6
\&{if} $\\{cur\_tok}<\\{right\_brace\_limit}$ \1\&{then}\6
\&{if} $\\{cur\_cmd}<\\{right\_brace}$ \1\&{then}\5
$\\{incr}(\\{unbalance})$\6
\4\&{else} \&{begin} \37$\\{decr}(\\{unbalance})$;\6
\&{if} $\\{unbalance}=0$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{end};\2\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end};\2\6
\4\\{found}: \37$\|q\K\\{link}(\\{def\_ref})$;\5
$\\{free\_avail}(\\{def\_ref})$;\C{discard reference count}\6
\&{if} $\|q=\\{null}$ \1\&{then}\5
$\\{cur\_val}\K\\{temp\_head}$\ \&{else} $\\{cur\_val}\K\|p$;\2\6
$\\{link}(\\{temp\_head})\K\|q$;\5
$\\{scanner\_status}\K\|s$;\5
$\\{warning\_index}\K\|w$;\5
$\\{def\_ref}\K\|d$;\6
\&{end};\par
\A1753.
\U490.\fi

\M1684. The \.{\\showtokens} command displays a token list.

\Y\P\D \37$\\{show\_tokens}=5$\C{ \.{\\showtokens} , must be odd! }\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"showtokens"},\39\\{xray},\39\\{show\_tokens})$;\par
\fi

\M1685. \P$\X1676:Cases of \\{xray} for \\{print\_cmd\_chr}\X\mathrel{+}\S$\6
\4\\{show\_tokens}: \37$\\{print\_esc}(\.{"showtokens"})$;\par
\fi

\M1686. The \.{\\unexpanded} primitive prevents expansion of tokens much as
the result from \.{\\the} applied to a token variable.  The
\.{\\detokenize} primitive converts a token list into a list of
character tokens much as if the token list were written to a file.  We
use the fact that the command modifiers for \.{\\unexpanded} and
\.{\\detokenize} are odd whereas those for \.{\\the} and \.{\\showthe}
are even.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"unexpanded"},\39\\{the},\391)$;\6
$\\{primitive}(\.{"detokenize"},\39\\{the},\39\\{show\_tokens})$;\par
\fi

\M1687. \P$\X1687:Cases of \\{the} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=1$ \1\&{then}\5
$\\{print\_esc}(\.{"unexpanded"})$\6
\4\&{else} $\\{print\_esc}(\.{"detokenize"})$\2\par
\U288.\fi

\M1688. \P$\X1688:Handle \.{\\unexpanded} or \.{\\detokenize} and \&{return}\X%
\S$\6
\&{if} $\\{odd}(\\{cur\_chr})$ \1\&{then}\6
\&{begin} \37$\|c\K\\{cur\_chr}$;\5
\\{scan\_general\_text};\6
\&{if} $\|c=1$ \1\&{then}\5
$\\{the\_toks}\K\\{cur\_val}$\6
\4\&{else} \&{begin} \37$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\|b\K\\{pool\_ptr}$;\5
$\|p\K\\{get\_avail}$;\5
$\\{link}(\|p)\K\\{link}(\\{temp\_head})$;\5
$\\{token\_show}(\|p)$;\5
$\\{flush\_list}(\|p)$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{the\_toks}\K\\{str\_toks}(\|b)$;\6
\&{end};\2\6
\&{return};\6
\&{end}\2\par
\U491.\fi

\M1689. The \.{\\showifs} command displays all currently active conditionals.

\Y\P\D \37$\\{show\_ifs}=6$\C{ \.{\\showifs} }\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"showifs"},\39\\{xray},\39\\{show\_ifs})$;\par
\fi

\M1690. \P$\X1676:Cases of \\{xray} for \\{print\_cmd\_chr}\X\mathrel{+}\S$\6
\4\\{show\_ifs}: \37$\\{print\_esc}(\.{"showifs"})$;\par
\fi

\M1691.
\Y\P\D \37$\\{print\_if\_line}(\#)\S$\1\6
\&{if} $\#\I0$ \1\&{then}\6
\&{begin} \37$\\{print}(\.{"\ entered\ on\ line\ "})$;\5
$\\{print\_int}(\#)$;\6
\&{end}\2\2\par
\Y\P$\4\X1677:Cases for \\{show\_whatever}\X\mathrel{+}\S$\6
\4\\{show\_ifs}: \37\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_nl}(\.{""})$;\5
\\{print\_ln};\6
\&{if} $\\{cond\_ptr}=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"\#\#\#\ "})$;\5
$\\{print}(\.{"no\ active\ conditionals"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{cond\_ptr}$;\5
$\|n\K0$;\6
\1\&{repeat} \37$\\{incr}(\|n)$;\5
$\|p\K\\{link}(\|p)$;\ \&{until}\5
$\|p=\\{null}$;\2\6
$\|p\K\\{cond\_ptr}$;\5
$\|t\K\\{cur\_if}$;\5
$\|l\K\\{if\_line}$;\5
$\|m\K\\{if\_limit}$;\6
\1\&{repeat} \37$\\{print\_nl}(\.{"\#\#\#\ level\ "})$;\5
$\\{print\_int}(\|n)$;\5
$\\{print}(\.{":\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\|t)$;\6
\&{if} $\|m=\\{fi\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"else"})$;\2\6
$\\{print\_if\_line}(\|l)$;\5
$\\{decr}(\|n)$;\5
$\|t\K\\{subtype}(\|p)$;\5
$\|l\K\\{if\_line\_field}(\|p)$;\5
$\|m\K\\{type}(\|p)$;\5
$\|p\K\\{link}(\|p)$;\6
\4\&{until}\5
$\|p=\\{null}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1692. The \.{\\interactionmode} primitive allows to query and set the
interaction mode.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"interactionmode"},\39\\{set\_page\_int},\392)$;\par
\fi

\M1693. \P$\X1693:Cases of \\{set\_page\_int} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=2$ \1\&{then}\5
$\\{print\_esc}(\.{"interactionmode"})$\2\par
\U443.\fi

\M1694. \P$\X1694:Cases for `Fetch the \\{dead\_cycles} or the \\{insert%
\_penalties}'\X\S$\6
\4\&{else} \37\&{if} $\|m=2$ \1\&{then}\5
$\\{cur\_val}\K\\{interaction}$\2\par
\U445.\fi

\M1695. \P$\X1656:Declare \eTeX\ procedures for use by \\{main\_control}\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{new\_interaction};\5
\\{forward};\5
\hbox{\2}\par
\fi

\M1696. \P$\X1696:Cases for \\{alter\_integer}\X\S$\6
\4\&{else} \37\&{if} $\|c=2$ \1\&{then}\6
\&{begin} \37\&{if} $(\\{cur\_val}<\\{batch\_mode})\V(\\{cur\_val}>\\{error%
\_stop\_mode})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ interaction\ mode"})$;\5
$\\{help2}(\.{"Modes\ are\ 0=batch,\ 1=nonstop,\ 2=scroll,\ and"})$\6
$(\.{"3=errorstop.\ Proceed,\ and\ I\'ll\ ignore\ this\ case."})$;\5
$\\{int\_error}(\\{cur\_val})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_chr}\K\\{cur\_val}$;\5
\\{new\_interaction};\6
\&{end};\2\6
\&{end}\2\par
\U1424.\fi

\M1697. The \\{middle} feature of \eTeX\ allows one ore several \.{\\middle}
delimiters to appear between \.{\\left} and \.{\\right}.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"middle"},\39\\{left\_right},\39\\{middle\_noad})$;\par
\fi

\M1698. \P$\X1698:Cases of \\{left\_right} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=\\{middle\_noad}$ \1\&{then}\5
$\\{print\_esc}(\.{"middle"})$\2\par
\U1367.\fi

\M1699. In constructions such as
$$\vbox{\halign{\.{#}\hfil\cr
{}\\hbox to \\hsize\{\cr
\hskip 25pt \\hskip 0pt plus 0.0001fil\cr
\hskip 25pt ...\cr
\hskip 25pt \\hfil\\penalty-200\\hfilneg\cr
\hskip 25pt ...\}\cr}}$$
the stretch components of \.{\\hfil} and \.{\\hfilneg} compensate; they may,
however, get modified in order to prevent arithmetic overflow during
\\{hlist\_out} when each of them is multiplied by a large \\{glue\_set} value.

Since this ``glue rounding'' depends on state variables \\{cur\_g} and
\\{cur\_glue} and \TeXXeT\ is supposed to emulate the behavior of \TeXeT\
(plus a suitable postprocessor) as close as possible the glue rounding
cannot be postponed until (segments of) an hlist has been reversed.

The code below is invoked after the effective width, \\{rule\_wd}, of a glue
node has been computed. The glue node is either converted into a kern node
or, for leaders, the glue specification is replaced by an equivalent rigid
one; the subtype of the glue node remains unchanged.

\Y\P$\4\X1699:Handle a glue node for mixed direction typesetting\X\S$\6
\&{if} $(((\\{g\_sign}=\\{stretching})\W(\\{stretch\_order}(\|g)=\\{g\_order}))%
\V((\\{g\_sign}=\\{shrinking})\W(\\{shrink\_order}(\|g)=\\{g\_order})))$ \1%
\&{then}\6
\&{begin} \37$\\{fast\_delete\_glue\_ref}(\|g)$;\6
\&{if} $\\{subtype}(\|p)<\\{a\_leaders}$ \1\&{then}\6
\&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{width}(\|p)\K\\{rule\_wd}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|g\K\\{get\_node}(\\{glue\_spec\_size})$;\6
$\\{stretch\_order}(\|g)\K\\{filll}+1$;\5
$\\{shrink\_order}(\|g)\K\\{filll}+1$;\C{will never match}\6
$\\{width}(\|g)\K\\{rule\_wd}$;\5
$\\{stretch}(\|g)\K0$;\5
$\\{shrink}(\|g)\K0$;\5
$\\{glue\_ptr}(\|p)\K\|g$;\6
\&{end};\2\6
\&{end}\2\par
\Us653, 735\ETs1726.\fi

\M1700. The optional \\{TeXXeT} feature of \eTeX\ contains the code for mixed
left-to-right and right-to-left typesetting.  This code is inspired by
but different from \TeXeT\ as presented by Donald~E. Knuth and Pierre
MacKay in {\sl TUGboat\/} {\bf 8}, 14--25, 1987.

In order to avoid confusion with \TeXeT\ the present implementation of
mixed direction typesetting is called \TeXXeT.  It differs from \TeXeT\
in several important aspects:  (1)~Right-to-left text is reversed
explicitly by the \\{ship\_out} routine and is written to a normal \.{DVI}
file without any \\{begin\_reflect} or \\{end\_reflect} commands; (2)~a
\\{math\_node} is (ab)used instead of a \\{whatsit\_node} to record the
\.{\\beginL}, \.{\\endL}, \.{\\beginR}, and \.{\\endR} text direction
primitives in order to keep the influence on the line breaking algorithm
for pure left-to-right text as small as possible; (3)~right-to-left text
interrupted by a displayed equation is automatically resumed after that
equation; and (4)~the \\{valign} command code with a non-zero command
modifier is (ab)used for the text direction primitives.

Nevertheless there is a subtle difference between \TeX\ and \TeXXeT\
that may influence the line breaking algorithm for pure left-to-right
text.  When a paragraph containing math mode material is broken into
lines \TeX\ may generate lines where math mode material is not enclosed
by properly nested \.{\\mathon} and \.{\\mathoff} nodes.  Unboxing such
lines as part of a new paragraph may have the effect that hyphenation is
attempted for `words' originating from math mode or that hyphenation is
inhibited for words originating from horizontal mode.

In \TeXXeT\ additional \.{\\beginM}, resp.\ \.{\\endM} math nodes are
supplied at the start, resp.\ end of lines such that math mode material
inside a horizontal list always starts with either \.{\\mathon} or
\.{\\beginM} and ends with \.{\\mathoff} or \.{\\endM}.  These
additional nodes are transparent to operations such as \.{\\unskip},
\.{\\lastpenalty}, or \.{\\lastbox} but they do have the effect that
hyphenation is never attempted for `words' originating from math mode
and is never inhibited for words originating from horizontal mode.

\Y\P\D \37$\\{TeXXeT\_state}\S\\{eTeX\_state}(\\{TeXXeT\_code})$\par
\P\D \37$\\{TeXXeT\_en}\S(\\{TeXXeT\_state}>0)$\C{is \TeXXeT\ enabled?}\par
\Y\P$\4\X1659:Cases for \\{print\_param}\X\mathrel{+}\S$\6
\4$\\{eTeX\_state\_code}+\\{TeXXeT\_code}$: \37$\\{print\_esc}(%
\.{"TeXXeTstate"})$;\par
\fi

\M1701. \P$\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"TeXXeTstate"},\39\\{assign\_int},\39\\{eTeX\_state\_base}+%
\\{TeXXeT\_code})$;\5
$\\{primitive}(\.{"beginL"},\39\\{valign},\39\\{begin\_L\_code})$;\5
$\\{primitive}(\.{"endL"},\39\\{valign},\39\\{end\_L\_code})$;\5
$\\{primitive}(\.{"beginR"},\39\\{valign},\39\\{begin\_R\_code})$;\5
$\\{primitive}(\.{"endR"},\39\\{valign},\39\\{end\_R\_code})$;\par
\fi

\M1702. \P$\X1702:Cases of \\{valign} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{case} $\\{chr\_code}$ \1\&{of}\6
\4\\{begin\_L\_code}: \37$\\{print\_esc}(\.{"beginL"})$;\6
\4\\{end\_L\_code}: \37$\\{print\_esc}(\.{"endL"})$;\6
\4\\{begin\_R\_code}: \37$\\{print\_esc}(\.{"beginR"})$;\6
\4\&{othercases} \37$\\{print\_esc}(\.{"endR"})$\2\6
\&{endcases}\par
\U288.\fi

\M1703. \P$\X1703:Cases of \\{main\_control} for $\\{hmode}+\\{valign}$\X\S$\6
\&{if} $\\{cur\_chr}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{eTeX\_enabled}(\\{TeXXeT\_en},\39\\{cur\_cmd},\39\\{cur%
\_chr})$ \1\&{then}\5
$\\{tail\_append}(\\{new\_math}(0,\39\\{cur\_chr}))$;\2\6
\&{end}\6
\4\&{else} \2\par
\U1308.\fi

\M1704. An hbox with subtype dlist will never be reversed, even when embedded
in right-to-left text.

\Y\P$\4\X1704:Display if this box is never to be reversed\X\S$\6
\&{if} $(\\{type}(\|p)=\\{hlist\_node})\W(\\{box\_lr}(\|p)=\\{dlist})$ \1%
\&{then}\5
$\\{print}(\.{",\ display"})$\2\par
\U202.\fi

\M1705. A number of routines are based on a stack of one-word nodes whose
\\{info} fields contain \\{end\_M\_code}, \\{end\_L\_code}, or \\{end\_R%
\_code}.  The
top of the stack is pointed to by \\{LR\_ptr}.

When the stack manipulation macros of this section are used below,
variable \\{LR\_ptr} might be the global variable declared here for \\{hpack}
and \\{ship\_out}, or might be local to \\{post\_line\_break}.

\Y\P\D \37$\\{put\_LR}(\#)\S$\1\6
\&{begin} \37$\\{temp\_ptr}\K\\{get\_avail}$;\5
$\\{info}(\\{temp\_ptr})\K\#$;\5
$\\{link}(\\{temp\_ptr})\K\\{LR\_ptr}$;\5
$\\{LR\_ptr}\K\\{temp\_ptr}$;\6
\&{end}\2\par
\P\D \37$\\{push\_LR}(\#)\S\\{put\_LR}(\\{end\_LR\_type}(\#))$\Y\par
\P\D \37$\\{pop\_LR}\S$\1\6
\&{begin} \37$\\{temp\_ptr}\K\\{LR\_ptr}$;\5
$\\{LR\_ptr}\K\\{link}(\\{temp\_ptr})$;\5
$\\{free\_avail}(\\{temp\_ptr})$;\6
\&{end}\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{LR\_ptr}: \37\\{pointer};\C{stack of LR codes for \\{hpack}, \\{ship%
\_out}, and \\{init\_math}}\6
\4\\{LR\_problems}: \37\\{integer};\C{counts missing begins and ends}\6
\4\\{cur\_dir}: \37\\{small\_number};\C{current text direction}\par
\fi

\M1706. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{LR\_ptr}\K\\{null}$;\5
$\\{LR\_problems}\K0$;\5
$\\{cur\_dir}\K\\{left\_to\_right}$;\par
\fi

\M1707. \P$\X1707:Insert LR nodes at the beginning of the current line and
adjust the LR stack based on LR nodes in this line\X\S$\6
\&{begin} \37$\|q\K\\{link}(\\{temp\_head})$;\6
\&{if} $\\{LR\_ptr}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{temp\_ptr}\K\\{LR\_ptr}$;\5
$\|r\K\|q$;\6
\1\&{repeat} \37$\|s\K\\{new\_math}(0,\39\\{begin\_LR\_type}(\\{info}(\\{temp%
\_ptr})))$;\5
$\\{link}(\|s)\K\|r$;\5
$\|r\K\|s$;\5
$\\{temp\_ptr}\K\\{link}(\\{temp\_ptr})$;\6
\4\&{until}\5
$\\{temp\_ptr}=\\{null}$;\2\6
$\\{link}(\\{temp\_head})\K\|r$;\6
\&{end};\2\6
\&{while} $\|q\I\\{cur\_break}(\\{cur\_p})$ \1\&{do}\6
\&{begin} \37\&{if} $\R\\{is\_char\_node}(\|q)$ \1\&{then}\6
\&{if} $\\{type}(\|q)=\\{math\_node}$ \1\&{then}\5
\X1708:Adjust \(t)the LR stack for the \\{post\_line\_break} routine\X;\2\2\6
$\|q\K\\{link}(\|q)$;\6
\&{end};\2\6
\&{end}\par
\U1056.\fi

\M1708. \P$\X1708:Adjust \(t)the LR stack for the \\{post\_line\_break} routine%
\X\S$\6
\&{if} $\\{end\_LR}(\|q)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{LR\_ptr}\I\\{null}$ \1\&{then}\6
\&{if} $\\{info}(\\{LR\_ptr})=\\{end\_LR\_type}(\|q)$ \1\&{then}\5
\\{pop\_LR};\2\2\6
\&{end}\6
\4\&{else} $\\{push\_LR}(\|q)$\2\par
\Us1055, 1057\ETs1707.\fi

\M1709. We use the fact that \|q now points to the node with \.{\\rightskip}
glue.

\Y\P$\4\X1709:Insert LR nodes at the end of the current line\X\S$\6
\&{if} $\\{LR\_ptr}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|s\K\\{temp\_head}$;\5
$\|r\K\\{link}(\|s)$;\6
\&{while} $\|r\I\|q$ \1\&{do}\6
\&{begin} \37$\|s\K\|r$;\5
$\|r\K\\{link}(\|s)$;\6
\&{end};\2\6
$\|r\K\\{LR\_ptr}$;\6
\&{while} $\|r\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{temp\_ptr}\K\\{new\_math}(0,\39\\{info}(\|r))$;\5
$\\{link}(\|s)\K\\{temp\_ptr}$;\5
$\|s\K\\{temp\_ptr}$;\5
$\|r\K\\{link}(\|r)$;\6
\&{end};\2\6
$\\{link}(\|s)\K\|q$;\6
\&{end}\2\par
\U1056.\fi

\M1710. \P$\X1710:Initialize the LR stack\X\S$\6
$\\{put\_LR}(\\{before})$\C{this will never match}\par
\Us823, 1714\ETs1734.\fi

\M1711. \P$\X1711:Adjust \(t)the LR stack for the \\{hpack} routine\X\S$\6
\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\6
\&{if} $\\{info}(\\{LR\_ptr})=\\{end\_LR\_type}(\|p)$ \1\&{then}\5
\\{pop\_LR}\6
\4\&{else} \&{begin} \37$\\{incr}(\\{LR\_problems})$;\5
$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{subtype}(\|p)\K\\{explicit}$;\6
\&{end}\2\6
\4\&{else} $\\{push\_LR}(\|p)$\2\par
\U825.\fi

\M1712. \P$\X1712:Check for LR anomalies at the end of \\{hpack}\X\S$\6
\&{begin} \37\&{if} $\\{info}(\\{LR\_ptr})\I\\{before}$ \1\&{then}\6
\&{begin} \37\&{while} $\\{link}(\|q)\I\\{null}$ \1\&{do}\5
$\|q\K\\{link}(\|q)$;\2\6
\1\&{repeat} \37$\\{temp\_ptr}\K\|q$;\5
$\|q\K\\{new\_math}(0,\39\\{info}(\\{LR\_ptr}))$;\5
$\\{link}(\\{temp\_ptr})\K\|q$;\5
$\\{LR\_problems}\K\\{LR\_problems}+10000$;\5
\\{pop\_LR};\6
\4\&{until}\5
$\\{info}(\\{LR\_ptr})=\\{before}$;\2\6
\&{end};\2\6
\&{if} $\\{LR\_problems}>0$ \1\&{then}\6
\&{begin} \37\X1713:Report LR problems\X;\6
\&{goto} \37\\{common\_ending};\6
\&{end};\2\6
\\{pop\_LR};\6
\&{if} $\\{LR\_ptr}\I\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"LR1"})$;\2\6
\&{end}\par
\U823.\fi

\M1713. \P$\X1713:Report LR problems\X\S$\6
\&{begin} \37\\{print\_ln};\5
$\\{print\_nl}(\.{"\\endL\ or\ \\endR\ problem\ ("})$;\6
$\\{print\_int}(\\{LR\_problems}\mathbin{\&{div}}10000)$;\5
$\\{print}(\.{"\ missing,\ "})$;\6
$\\{print\_int}(\\{LR\_problems}\mathbin{\&{mod}}10000)$;\5
$\\{print}(\.{"\ extra"})$;\6
$\\{LR\_problems}\K0$;\6
\&{end}\par
\Us1712\ET1730.\fi

\M1714. \P$\X1714:Initialize \\{hlist\_out} for mixed direction typesetting\X%
\S$\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37\X1710:Initialize the LR stack\X;\6
\&{if} $\\{box\_lr}(\\{this\_box})=\\{dlist}$ \1\&{then}\6
\&{if} $\\{cur\_dir}=\\{right\_to\_left}$ \1\&{then}\6
\&{begin} \37$\\{cur\_dir}\K\\{left\_to\_right}$;\5
$\\{cur\_h}\K\\{cur\_h}-\\{width}(\\{this\_box})$;\6
\&{end}\6
\4\&{else} $\\{set\_box\_lr}(\\{this\_box})(0)$;\2\2\6
\&{if} $(\\{cur\_dir}=\\{right\_to\_left})\W(\\{box\_lr}(\\{this\_box})\I%
\\{reversed})$ \1\&{then}\5
\X1721:Reverse the complete hlist and set the subtype to \\{reversed}\X;\2\6
\&{end}\2\par
\Us647\ET729.\fi

\M1715. \P$\X1715:Finish \\{hlist\_out} for mixed direction typesetting\X\S$\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\6
\&{begin} \37\X1718:Check for LR anomalies at the end of \\{hlist\_out}\X;\6
\&{if} $\\{box\_lr}(\\{this\_box})=\\{dlist}$ \1\&{then}\5
$\\{cur\_dir}\K\\{right\_to\_left}$;\2\6
\&{end}\2\par
\Us647\ET729.\fi

\M1716. \P$\X1716:Handle a math node in \\{hlist\_out}\X\S$\6
\&{begin} \37\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1717:Adjust \(t)the LR stack for the \\{hlist\_out} routine; if necessary
reverse an hlist segment and \&{goto} \\{reswitch}\X;\2\6
$\\{cur\_h}\K\\{cur\_h}+\\{width}(\|p)$;\6
\&{end}\par
\Us650\ET732.\fi

\M1717. Breaking a paragraph into lines while \TeXXeT\ is disabled may result
in lines with unpaired math nodes.  Such hlists are silently accepted
in the absence of text direction directives.

\Y\P\D \37$\\{LR\_dir}(\#)\S(\\{subtype}(\#)\mathbin{\&{div}}\\{R\_code})$%
\C{text direction of a `math node'}\par
\Y\P$\4\X1717:Adjust \(t)the LR stack for the \\{hlist\_out} routine; if
necessary reverse an hlist segment and \&{goto} \\{reswitch}\X\S$\6
\&{begin} \37\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\6
\&{if} $\\{info}(\\{LR\_ptr})=\\{end\_LR\_type}(\|p)$ \1\&{then}\5
\\{pop\_LR}\6
\4\&{else} \&{begin} \37\&{if} $\\{subtype}(\|p)>\\{L\_code}$ \1\&{then}\5
$\\{incr}(\\{LR\_problems})$;\2\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\\{push\_LR}(\|p)$;\6
\&{if} $\\{LR\_dir}(\|p)\I\\{cur\_dir}$ \1\&{then}\5
\X1722:Reverse an hlist segment and \&{goto} \\{reswitch}\X;\2\6
\&{end};\2\6
$\\{type}(\|p)\K\\{kern\_node}$;\6
\&{end}\par
\U1716.\fi

\M1718. \P$\X1718:Check for LR anomalies at the end of \\{hlist\_out}\X\S$\6
\&{begin} \37\&{while} $\\{info}(\\{LR\_ptr})\I\\{before}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{info}(\\{LR\_ptr})>\\{L\_code}$ \1\&{then}\5
$\\{LR\_problems}\K\\{LR\_problems}+10000$;\2\6
\\{pop\_LR};\6
\&{end};\2\6
\\{pop\_LR};\6
\&{end}\par
\U1715.\fi

\M1719. \P\D \37$\\{edge\_node}=\\{style\_node}$\C{a \\{style\_node} does not
occur in hlists}\par
\P\D \37$\\{edge\_node\_size}=\\{style\_node\_size}$\C{number of words in an
edge node}\par
\P\D \37$\\{edge\_dist}(\#)\S\\{depth}(\#)$\C{new \\{left\_edge} position
relative to \\{cur\_h}    (after \\{width} has been taken into account)}\par
\Y\P$\4\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{new\_edge}(\|s:\\{small\_number};\,\35\|w:%
\\{scaled})$: \37\\{pointer};\C{create an edge node}\6
\4\&{var} \37\|p: \37\\{pointer};\C{the new node}\2\6
\&{begin} \37$\|p\K\\{get\_node}(\\{edge\_node\_size})$;\5
$\\{type}(\|p)\K\\{edge\_node}$;\5
$\\{subtype}(\|p)\K\|s$;\5
$\\{width}(\|p)\K\|w$;\5
$\\{edge\_dist}(\|p)\K0$;\C{the \\{edge\_dist} field will be set later}\6
$\\{new\_edge}\K\|p$;\6
\&{end};\par
\fi

\M1720. \P$\X1720:Cases of \\{hlist\_out} that arise in mixed direction text
only\X\S$\6
\4\\{edge\_node}: \37\&{begin} \37$\\{cur\_h}\K\\{cur\_h}+\\{width}(\|p)$;\5
$\\{left\_edge}\K\\{cur\_h}+\\{edge\_dist}(\|p)$;\5
$\\{cur\_dir}\K\\{subtype}(\|p)$;\6
\&{end};\par
\Us650\ET732.\fi

\M1721. We detach the hlist, start a new one consisting of just one kern node,
append the reversed list, and set the width of the kern node.

\Y\P$\4\X1721:Reverse the complete hlist and set the subtype to \\{reversed}\X%
\S$\6
\&{begin} \37$\\{save\_h}\K\\{cur\_h}$;\5
$\\{temp\_ptr}\K\|p$;\5
$\|p\K\\{new\_kern}(0)$;\5
$\\{link}(\\{prev\_p})\K\|p$;\5
$\\{cur\_h}\K0$;\5
$\\{link}(\|p)\K\\{reverse}(\\{this\_box},\39\\{null},\39\\{cur\_g},\39\\{cur%
\_glue})$;\5
$\\{width}(\|p)\K-\\{cur\_h}$;\5
$\\{cur\_h}\K\\{save\_h}$;\5
$\\{set\_box\_lr}(\\{this\_box})(\\{reversed})$;\6
\&{end}\par
\U1714.\fi

\M1722. We detach the remainder of the hlist, replace the math node by
an edge node, and append the reversed hlist segment to it; the tail of
the reversed segment is another edge node and the remainder of the
original list is attached to it.

\Y\P$\4\X1722:Reverse an hlist segment and \&{goto} \\{reswitch}\X\S$\6
\&{begin} \37$\\{save\_h}\K\\{cur\_h}$;\5
$\\{temp\_ptr}\K\\{link}(\|p)$;\5
$\\{rule\_wd}\K\\{width}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\5
$\\{cur\_dir}\K\\{reflected}$;\5
$\|p\K\\{new\_edge}(\\{cur\_dir},\39\\{rule\_wd})$;\5
$\\{link}(\\{prev\_p})\K\|p$;\5
$\\{cur\_h}\K\\{cur\_h}-\\{left\_edge}+\\{rule\_wd}$;\5
$\\{link}(\|p)\K\\{reverse}(\\{this\_box},\39\\{new\_edge}(\\{reflected},\390),%
\39\\{cur\_g},\39\\{cur\_glue})$;\5
$\\{edge\_dist}(\|p)\K\\{cur\_h}$;\5
$\\{cur\_dir}\K\\{reflected}$;\5
$\\{cur\_h}\K\\{save\_h}$;\5
\&{goto} \37\\{reswitch};\6
\&{end}\par
\U1717.\fi

\M1723. The \\{reverse} function defined here is responsible to reverse the
nodes of an hlist (segment). The first parameter \\{this\_box} is the enclosing
hlist node, the second parameter \|t is to become the tail of the reversed
list, and the global variable \\{temp\_ptr} is the head of the list to be
reversed. Finally \\{cur\_g} and \\{cur\_glue} are the current glue rounding
state
variables, to be updated by this function. We remove nodes from the original
list and add them to the head of the new one.

\Y\P$\4\X1615:Declare procedures needed in \\{hlist\_out}, \\{vlist\_out}\X%
\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{reverse}(\\{this\_box},\39\|t:\\{pointer};\,\35%
\mathop{\&{var}}\\{cur\_g}:\\{scaled};\,\35\mathop{\&{var}}\\{cur\_glue}:%
\\{real})$: \37\\{pointer};\6
\4\&{label} \37$\\{reswitch},\39\\{next\_p},\39\\{done}$;\6
\4\&{var} \37\|l: \37\\{pointer};\C{the new list}\6
\|p: \37\\{pointer};\C{the current node}\6
\|q: \37\\{pointer};\C{the next node}\6
\\{g\_order}: \37\\{glue\_ord};\C{applicable order of infinity for glue}\6
\\{g\_sign}: \37$\\{normal}\to\\{shrinking}$;\C{selects type of glue}\6
\\{glue\_temp}: \37\\{real};\C{glue value before rounding}\6
$\|m,\39\|n$: \37\\{halfword};\C{count of unmatched math nodes}\2\6
\&{begin} \37$\\{g\_order}\K\\{glue\_order}(\\{this\_box})$;\5
$\\{g\_sign}\K\\{glue\_sign}(\\{this\_box})$;\5
$\|l\K\|t$;\5
$\|p\K\\{temp\_ptr}$;\5
$\|m\K\\{min\_halfword}$;\5
$\|n\K\\{min\_halfword}$;\6
\~ \1\&{loop}\ \&{begin} \37\&{while} $\|p\I\\{null}$ \1\&{do}\5
\X1724:Move node \|p to the new list and go to the next node; or \&{goto} %
\\{done} if the end of the reflected segment has been reached\X;\2\6
\&{if} $(\|t=\\{null})\W(\|m=\\{min\_halfword})\W(\|n=\\{min\_halfword})$ \1%
\&{then}\5
\&{goto} \37\\{done};\2\6
$\|p\K\\{new\_math}(0,\39\\{info}(\\{LR\_ptr}))$;\5
$\\{LR\_problems}\K\\{LR\_problems}+10000$;\C{manufacture one missing math
node}\6
\&{end};\2\6
\4\\{done}: \37$\\{reverse}\K\|l$;\6
\&{end};\par
\fi

\M1724. \P$\X1724:Move node \|p to the new list and go to the next node; or %
\&{goto} \\{done} if the end of the reflected segment has been reached\X\S$\6
\4\\{reswitch}: \37\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\6
\1\&{repeat} \37$\|f\K\\{font}(\|p)$;\5
$\|c\K\\{character}(\|p)$;\5
$\\{cur\_h}\K\\{cur\_h}+\\{char\_width}(\|f)(\\{char\_info}(\|f)(\|c))$;\5
$\|q\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\|l$;\5
$\|l\K\|p$;\5
$\|p\K\|q$;\6
\4\&{until}\5
$\R\\{is\_char\_node}(\|p)$\2\6
\4\&{else} \X1725:Move the non-\\{char\_node} \|p to the new list\X\2\par
\U1723.\fi

\M1725. \P$\X1725:Move the non-\\{char\_node} \|p to the new list\X\S$\6
\&{begin} \37$\|q\K\\{link}(\|p)$;\6
\&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node},\39\\{rule\_node},\39\\{kern\_node}$: %
\37$\\{rule\_wd}\K\\{width}(\|p)$;\6
\hbox{\4}\X1726:Cases of \\{reverse} that need special treatment\X\6
\4\\{edge\_node}: \37$\\{confusion}(\.{"LR2"})$;\6
\4\&{othercases} \37\&{goto} \37\\{next\_p}\2\6
\&{endcases};\6
$\\{cur\_h}\K\\{cur\_h}+\\{rule\_wd}$;\6
\4\\{next\_p}: \37$\\{link}(\|p)\K\|l$;\6
\&{if} $\\{type}(\|p)=\\{kern\_node}$ \1\&{then}\6
\&{if} $(\\{rule\_wd}=0)\V(\|l=\\{null})$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\5
$\|p\K\|l$;\6
\&{end};\2\2\6
$\|l\K\|p$;\5
$\|p\K\|q$;\6
\&{end}\par
\U1724.\fi

\M1726. Here we compute the effective width of a glue node as in \\{hlist%
\_out}.

\Y\P$\4\X1726:Cases of \\{reverse} that need special treatment\X\S$\6
\4\\{glue\_node}: \37\&{begin} \37\\{round\_glue};\5
\X1699:Handle a glue node for mixed direction typesetting\X;\6
\&{end};\par
\As1727\ET1728.
\U1725.\fi

\M1727. A ligature node is replaced by a char node.

\Y\P$\4\X1726:Cases of \\{reverse} that need special treatment\X\mathrel{+}\S$\6
\4\\{ligature\_node}: \37\&{begin} \37$\\{flush\_node\_list}(\\{lig\_ptr}(%
\|p))$;\5
$\\{temp\_ptr}\K\|p$;\5
$\|p\K\\{get\_avail}$;\5
$\\{mem}[\|p]\K\\{mem}[\\{lig\_char}(\\{temp\_ptr})]$;\5
$\\{link}(\|p)\K\|q$;\5
$\\{free\_node}(\\{temp\_ptr},\39\\{small\_node\_size})$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\par
\fi

\M1728. Math nodes in an inner reflected segment are modified, those at the
outer level are changed into kern nodes.

\Y\P$\4\X1726:Cases of \\{reverse} that need special treatment\X\mathrel{+}\S$\6
\4\\{math\_node}: \37\&{begin} \37$\\{rule\_wd}\K\\{width}(\|p)$;\6
\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\6
\&{if} $\\{info}(\\{LR\_ptr})\I\\{end\_LR\_type}(\|p)$ \1\&{then}\6
\&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{incr}(\\{LR\_problems})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\\{pop\_LR};\6
\&{if} $\|n>\\{min\_halfword}$ \1\&{then}\6
\&{begin} \37$\\{decr}(\|n)$;\5
$\\{decr}(\\{subtype}(\|p))$;\C{change \\{after} into \\{before}}\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\6
\&{if} $\|m>\\{min\_halfword}$ \1\&{then}\5
$\\{decr}(\|m)$\6
\4\&{else} \X1729:Finish the reversed hlist segment and \&{goto} \\{done}\X;\2\6
\&{end};\2\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\\{push\_LR}(\|p)$;\6
\&{if} $(\|n>\\{min\_halfword})\V(\\{LR\_dir}(\|p)\I\\{cur\_dir})$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|n)$;\5
$\\{incr}(\\{subtype}(\|p))$;\C{change \\{before} into \\{after}}\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{incr}(\|m)$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1729. Finally we have found the end of the hlist segment to be reversed; the
final math node is released and the remaining list attached to the
edge node terminating the reversed segment.

\Y\P$\4\X1729:Finish the reversed hlist segment and \&{goto} \\{done}\X\S$\6
\&{begin} \37$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\5
$\\{link}(\|t)\K\|q$;\5
$\\{width}(\|t)\K\\{rule\_wd}$;\5
$\\{edge\_dist}(\|t)\K-\\{cur\_h}-\\{rule\_wd}$;\5
\&{goto} \37\\{done};\6
\&{end}\par
\U1728.\fi

\M1730. \P$\X1730:Check for LR anomalies at the end of \\{ship\_out}\X\S$\6
\&{begin} \37\&{if} $\\{LR\_problems}>0$ \1\&{then}\6
\&{begin} \37\X1713:Report LR problems\X;\6
$\\{print\_char}(\.{")"})$;\5
\\{print\_ln};\6
\&{end};\2\6
\&{if} $(\\{LR\_ptr}\I\\{null})\V(\\{cur\_dir}\I\\{left\_to\_right})$ \1%
\&{then}\5
$\\{confusion}(\.{"LR3"})$;\2\6
\&{end}\par
\Us666\ET750.\fi

\M1731. Some special actions are required for displayed equation in paragraphs
with mixed direction texts.  First of all we have to set the text
direction preceding the display.

\Y\P$\4\X1731:Set the value of \|x to the text direction before the display\X%
\S$\6
\&{if} $\\{LR\_save}=\\{null}$ \1\&{then}\5
$\|x\K0$\6
\4\&{else} \&{if} $\\{info}(\\{LR\_save})\G\\{R\_code}$ \1\&{then}\5
$\|x\K-1$\ \&{else} $\|x\K1$\2\2\par
\Us1732\ET1734.\fi

\M1732. \P$\X1732:Prepare for display after an empty paragraph\X\S$\6
\&{begin} \37\\{pop\_nest};\5
\X1731:Set the value of \|x to the text direction before the display\X;\6
\&{end}\par
\U1323.\fi

\M1733. When calculating the natural width, \|w, of the final line preceding
the display, we may have to copy all or part of its hlist.  We copy,
however, only those parts of the original list that are relevant for the
computation of \\{pre\_display\_size}.

\Y\P$\4\X1733:Declare subprocedures for \\{init\_math}\X\S$\6
\4\&{procedure}\1\  \37$\\{just\_copy}(\|p,\39\|h,\39\|t:\\{pointer})$;\6
\4\&{label} \37$\\{found},\39\\{not\_found}$;\6
\4\&{var} \37\|r: \37\\{pointer};\C{current node being fabricated for new list}%
\6
\\{words}: \37$0\to5$;\C{number of words remaining to be copied}\2\6
\&{begin} \37\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37$\\{words}\K1$;\C{this setting occurs in more branches than any
other}\6
\&{if} $\\{is\_char\_node}(\|p)$ \1\&{then}\5
$\|r\K\\{get\_avail}$\6
\4\&{else} \&{case} $\\{type}(\|p)$ \1\&{of}\6
\4$\\{hlist\_node},\39\\{vlist\_node}$: \37\&{begin} \37$\|r\K\\{get\_node}(%
\\{box\_node\_size})$;\5
$\\{mem}[\|r+6]\K\\{mem}[\|p+6]$;\5
$\\{mem}[\|r+5]\K\\{mem}[\|p+5]$;\C{copy the last two words}\6
$\\{words}\K5$;\5
$\\{list\_ptr}(\|r)\K\\{null}$;\C{this affects $\\{mem}[\|r+5]$}\6
\&{end};\6
\4\\{rule\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{rule\_node\_size})$;\5
$\\{words}\K\\{rule\_node\_size}$;\6
\&{end};\6
\4\\{ligature\_node}: \37\&{begin} \37$\|r\K\\{get\_avail}$;\C{only \\{font}
and \\{character} are needed}\6
$\\{mem}[\|r]\K\\{mem}[\\{lig\_char}(\|p)]$;\5
\&{goto} \37\\{found};\6
\&{end};\6
\4$\\{kern\_node},\39\\{math\_node}$: \37\&{begin} \37$\|r\K\\{get\_node}(%
\\{small\_node\_size})$;\5
$\\{words}\K\\{small\_node\_size}$;\6
\&{end};\6
\4\\{glue\_node}: \37\&{begin} \37$\|r\K\\{get\_node}(\\{small\_node\_size})$;\5
$\\{add\_glue\_ref}(\\{glue\_ptr}(\|p))$;\5
$\\{glue\_ptr}(\|r)\K\\{glue\_ptr}(\|p)$;\5
$\\{leader\_ptr}(\|r)\K\\{null}$;\6
\&{end};\6
\4\\{whatsit\_node}: \37\X1604:Make a partial copy of the whatsit node \|p and
make \|r point to it; set \\{words} to the number of initial words not yet
copied\X;\6
\4\&{othercases} \37\&{goto} \37\\{not\_found}\2\6
\&{endcases};\2\6
\&{while} $\\{words}>0$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{words})$;\5
$\\{mem}[\|r+\\{words}]\K\\{mem}[\|p+\\{words}]$;\6
\&{end};\2\6
\4\\{found}: \37$\\{link}(\|h)\K\|r$;\5
$\|h\K\|r$;\6
\4\\{not\_found}: \37$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
$\\{link}(\|h)\K\|t$;\6
\&{end};\par
\A1738.
\U1316.\fi

\M1734. When the final line ends with R-text, the value \|w refers to the line
reflected with respect to the left edge of the enclosing vertical list.

\Y\P$\4\X1734:Prepare for display after a non-empty paragraph\X\S$\6
\&{if} $\\{eTeX\_ex}$ \1\&{then}\5
\X1740:Let \|j be the prototype box for the display\X;\2\6
$\|v\K\\{shift\_amount}(\\{just\_box})$;\5
\X1731:Set the value of \|x to the text direction before the display\X;\6
\&{if} $\|x\G0$ \1\&{then}\6
\&{begin} \37$\|p\K\\{list\_ptr}(\\{just\_box})$;\5
$\\{link}(\\{temp\_head})\K\\{null}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|v\K-\|v-\\{width}(\\{just\_box})$;\5
$\|p\K\\{new\_math}(0,\39\\{begin\_L\_code})$;\5
$\\{link}(\\{temp\_head})\K\|p$;\5
$\\{just\_copy}(\\{list\_ptr}(\\{just\_box}),\39\|p,\39\\{new\_math}(0,\39%
\\{end\_L\_code}))$;\5
$\\{cur\_dir}\K\\{right\_to\_left}$;\6
\&{end};\2\6
$\|v\K\|v+2\ast\\{quad}(\\{cur\_font})$;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1710:Initialize the LR stack\X\2\par
\U1324.\fi

\M1735. \P$\X1735:Finish the natural width computation\X\S$\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\6
\&{begin} \37\&{while} $\\{LR\_ptr}\I\\{null}$ \1\&{do}\5
\\{pop\_LR};\2\6
\&{if} $\\{LR\_problems}\I0$ \1\&{then}\6
\&{begin} \37$\|w\K\\{max\_dimen}$;\5
$\\{LR\_problems}\K0$;\6
\&{end};\2\6
\&{end};\2\6
$\\{cur\_dir}\K\\{left\_to\_right}$;\5
$\\{flush\_node\_list}(\\{link}(\\{temp\_head}))$\par
\U1324.\fi

\M1736. In the presence of text direction directives we assume that any LR
problems have been fixed by the \\{hpack} routine.  If the final line
contains, however, text direction directives while \TeXXeT\ is disabled,
then we set $\|w\K\\{max\_dimen}$.

\Y\P$\4\X1736:Cases of `Let \|d be the natural width' that need special
treatment\X\S$\6
\4\\{math\_node}: \37\&{begin} \37$\|d\K\\{width}(\|p)$;\6
\&{if} $\\{TeXXeT\_en}$ \1\&{then}\5
\X1737:Adjust \(t)the LR stack for the \\{init\_math} routine\X\6
\4\&{else} \&{if} $\\{subtype}(\|p)\G\\{L\_code}$ \1\&{then}\6
\&{begin} \37$\|w\K\\{max\_dimen}$;\5
\&{goto} \37\\{done};\6
\&{end};\2\2\6
\&{end};\6
\4\\{edge\_node}: \37\&{begin} \37$\|d\K\\{width}(\|p)$;\5
$\\{cur\_dir}\K\\{subtype}(\|p)$;\6
\&{end};\par
\U1325.\fi

\M1737. \P$\X1737:Adjust \(t)the LR stack for the \\{init\_math} routine\X\S$\6
\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\6
\&{begin} \37\&{if} $\\{info}(\\{LR\_ptr})=\\{end\_LR\_type}(\|p)$ \1\&{then}\5
\\{pop\_LR}\6
\4\&{else} \&{if} $\\{subtype}(\|p)>\\{L\_code}$ \1\&{then}\6
\&{begin} \37$\|w\K\\{max\_dimen}$;\5
\&{goto} \37\\{done};\6
\&{end}\2\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{push\_LR}(\|p)$;\6
\&{if} $\\{LR\_dir}(\|p)\I\\{cur\_dir}$ \1\&{then}\6
\&{begin} \37$\\{just\_reverse}(\|p)$;\5
$\|p\K\\{temp\_head}$;\6
\&{end};\2\6
\&{end}\2\par
\U1736.\fi

\M1738. \P$\X1733:Declare subprocedures for \\{init\_math}\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{just\_reverse}(\|p:\\{pointer})$;\6
\4\&{label} \37$\\{found},\39\\{done}$;\6
\4\&{var} \37\|l: \37\\{pointer};\C{the new list}\6
\|t: \37\\{pointer};\C{tail of reversed segment}\6
\|q: \37\\{pointer};\C{the next node}\6
$\|m,\39\|n$: \37\\{halfword};\C{count of unmatched math nodes}\2\6
\&{begin} \37$\|m\K\\{min\_halfword}$;\5
$\|n\K\\{min\_halfword}$;\6
\&{if} $\\{link}(\\{temp\_head})=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{just\_copy}(\\{link}(\|p),\39\\{temp\_head},\39\\{null})$;\5
$\|q\K\\{link}(\\{temp\_head})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{null}$;\5
$\\{flush\_node\_list}(\\{link}(\\{temp\_head}))$;\6
\&{end};\2\6
$\|t\K\\{new\_edge}(\\{cur\_dir},\390)$;\5
$\|l\K\|t$;\5
$\\{cur\_dir}\K\\{reflected}$;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{if} $\\{is\_char\_node}(\|q)$ \1\&{then}\6
\1\&{repeat} \37$\|p\K\|q$;\5
$\|q\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\|l$;\5
$\|l\K\|p$;\6
\4\&{until}\5
$\R\\{is\_char\_node}(\|q)$\2\6
\4\&{else} \&{begin} \37$\|p\K\|q$;\5
$\|q\K\\{link}(\|p)$;\6
\&{if} $\\{type}(\|p)=\\{math\_node}$ \1\&{then}\5
\X1739:Adjust \(t)the LR stack for the \\{just\_reverse} routine\X;\2\6
$\\{link}(\|p)\K\|l$;\5
$\|l\K\|p$;\6
\&{end};\2\2\6
\&{goto} \37\\{done};\6
\4\\{found}: \37$\\{width}(\|t)\K\\{width}(\|p)$;\5
$\\{link}(\|t)\K\|q$;\5
$\\{free\_node}(\|p,\39\\{small\_node\_size})$;\6
\4\\{done}: \37$\\{link}(\\{temp\_head})\K\|l$;\6
\&{end};\par
\fi

\M1739. \P$\X1739:Adjust \(t)the LR stack for the \\{just\_reverse} routine\X%
\S$\6
\&{if} $\\{end\_LR}(\|p)$ \1\&{then}\6
\&{if} $\\{info}(\\{LR\_ptr})\I\\{end\_LR\_type}(\|p)$ \1\&{then}\6
\&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{incr}(\\{LR\_problems})$;\6
\&{end}\6
\4\&{else} \&{begin} \37\\{pop\_LR};\6
\&{if} $\|n>\\{min\_halfword}$ \1\&{then}\6
\&{begin} \37$\\{decr}(\|n)$;\5
$\\{decr}(\\{subtype}(\|p))$;\C{change \\{after} into \\{before}}\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\|m>\\{min\_halfword}$ \1\&{then}\5
$\\{decr}(\|m)$\ \&{else} \&{goto} \37\\{found};\2\6
$\\{type}(\|p)\K\\{kern\_node}$;\6
\&{end};\2\6
\&{end}\2\6
\4\&{else} \&{begin} \37$\\{push\_LR}(\|p)$;\6
\&{if} $(\|n>\\{min\_halfword})\V(\\{LR\_dir}(\|p)\I\\{cur\_dir})$ \1\&{then}\6
\&{begin} \37$\\{incr}(\|n)$;\5
$\\{incr}(\\{subtype}(\|p))$;\C{change \\{before} into \\{after}}\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{type}(\|p)\K\\{kern\_node}$;\5
$\\{incr}(\|m)$;\6
\&{end};\2\6
\&{end}\2\par
\U1738.\fi

\M1740. The prototype box is an hlist node with the width, glue set, and shift
amount of \\{just\_box}, i.e., the last line preceding the display.  Its
hlist reflects the current \.{\\leftskip} and \.{\\rightskip}.

\Y\P$\4\X1740:Let \|j be the prototype box for the display\X\S$\6
\&{begin} \37\&{if} $\\{right\_skip}=\\{zero\_glue}$ \1\&{then}\5
$\|j\K\\{new\_kern}(0)$\6
\4\&{else} $\|j\K\\{new\_param\_glue}(\\{right\_skip\_code})$;\2\6
\&{if} $\\{left\_skip}=\\{zero\_glue}$ \1\&{then}\5
$\|p\K\\{new\_kern}(0)$\6
\4\&{else} $\|p\K\\{new\_param\_glue}(\\{left\_skip\_code})$;\2\6
$\\{link}(\|p)\K\|j$;\5
$\|j\K\\{new\_null\_box}$;\5
$\\{width}(\|j)\K\\{width}(\\{just\_box})$;\5
$\\{shift\_amount}(\|j)\K\\{shift\_amount}(\\{just\_box})$;\5
$\\{list\_ptr}(\|j)\K\|p$;\5
$\\{glue\_order}(\|j)\K\\{glue\_order}(\\{just\_box})$;\5
$\\{glue\_sign}(\|j)\K\\{glue\_sign}(\\{just\_box})$;\5
$\\{glue\_set}(\|j)\K\\{glue\_set}(\\{just\_box})$;\6
\&{end}\par
\U1734.\fi

\M1741. At the end of a displayed equation we retrieve the prototype box.

\Y\P$\4\X1376:Local variables for finishing a displayed formula\X\mathrel{+}\S$%
\6
\4\|j: \37\\{pointer};\C{prototype box}\par
\fi

\M1742. \P$\X1742:Retrieve the prototype box\X\S$\6
\&{if} $\\{mode}=\\{mmode}$ \1\&{then}\5
$\|j\K\\{LR\_box}$\2\par
\Us1372\ET1372.\fi

\M1743. \P$\X1743:Flush the prototype box\X\S$\6
$\\{flush\_node\_list}(\|j)$\par
\U1377.\fi

\M1744. The \\{app\_display} procedure used to append the displayed equation
and\slash or equation number to the current vertical list has three
parameters:  the prototype box, the hbox to be appended, and the
displacement of the hbox in the display line.

\Y\P$\4\X1744:Declare subprocedures for \\{after\_math}\X\S$\6
\4\&{procedure}\1\  \37$\\{app\_display}(\|j,\39\|b:\\{pointer};\,\35\|d:%
\\{scaled})$;\6
\4\&{var} \37\|z: \37\\{scaled};\C{width of the line}\6
\|s: \37\\{scaled};\C{move the line right this much}\6
\|e: \37\\{scaled};\C{distance from right edge of box to end of line}\6
\|x: \37\\{integer};\C{\\{pre\_display\_direction}}\6
$\|p,\39\|q,\39\|r,\39\|t,\39\|u$: \37\\{pointer};\C{for list manipulation}\2\6
\&{begin} \37$\|s\K\\{display\_indent}$;\5
$\|x\K\\{pre\_display\_direction}$;\6
\&{if} $\|x=0$ \1\&{then}\5
$\\{shift\_amount}(\|b)\K\|s+\|d$\6
\4\&{else} \&{begin} \37$\|z\K\\{display\_width}$;\5
$\|p\K\|b$;\5
\X1745:Set up the hlist for the display line\X;\6
\X1746:Package the display line\X;\6
\&{end};\2\6
$\\{append\_to\_vlist}(\|b)$;\6
\&{end};\par
\U1372.\fi

\M1745. Here we construct the hlist for the display, starting with node \|p
and ending with node \|q. We also set \|d and \|e to the amount of
kerning to be added before and after the hlist (adjusted for the
prototype box).

\Y\P$\4\X1745:Set up the hlist for the display line\X\S$\6
\&{if} $\|x>0$ \1\&{then}\5
$\|e\K\|z-\|d-\\{width}(\|p)$\6
\4\&{else} \&{begin} \37$\|e\K\|d$;\5
$\|d\K\|z-\|e-\\{width}(\|p)$;\6
\&{end};\2\6
\&{if} $\|j\I\\{null}$ \1\&{then}\6
\&{begin} \37$\|b\K\\{copy\_node\_list}(\|j)$;\5
$\\{height}(\|b)\K\\{height}(\|p)$;\5
$\\{depth}(\|b)\K\\{depth}(\|p)$;\5
$\|s\K\|s-\\{shift\_amount}(\|b)$;\5
$\|d\K\|d+\|s$;\5
$\|e\K\|e+\\{width}(\|b)-\|z-\|s$;\6
\&{end};\2\6
\&{if} $\\{box\_lr}(\|p)=\\{dlist}$ \1\&{then}\5
$\|q\K\|p$\C{display or equation number}\6
\4\&{else} \&{begin} \37\C{display and equation number}\6
$\|r\K\\{list\_ptr}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{box\_node\_size})$;\6
\&{if} $\|r=\\{null}$ \1\&{then}\5
$\\{confusion}(\.{"LR4"})$;\2\6
\&{if} $\|x>0$ \1\&{then}\6
\&{begin} \37$\|p\K\|r$;\6
\1\&{repeat} \37$\|q\K\|r$;\5
$\|r\K\\{link}(\|r)$;\C{find tail of list}\6
\4\&{until}\5
$\|r=\\{null}$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{null}$;\5
$\|q\K\|r$;\6
\1\&{repeat} \37$\|t\K\\{link}(\|r)$;\5
$\\{link}(\|r)\K\|p$;\5
$\|p\K\|r$;\5
$\|r\K\|t$;\C{reverse list}\6
\4\&{until}\5
$\|r=\\{null}$;\2\6
\&{end};\2\6
\&{end}\2\par
\U1744.\fi

\M1746. In the presence of a prototype box we use its shift amount and width
to adjust the values of kerning and add these values to the glue nodes
inserted to cancel the \.{\\leftskip} and \.{\\rightskip}.  If there is
no prototype box (because the display is preceded by an empty
paragraph), or if the skip parameters are zero, we just add kerns.

The \\{cancel\_glue} macro creates and links a glue node that is, together
with another glue node, equivalent to a given amount of kerning.  We can
use \|j as temporary pointer, since all we need is $\|j\I\\{null}$.

\Y\P\D \37$\\{cancel\_glue}(\#)\S\|j\K\\{new\_skip\_param}(\#)$;\5
\\{cancel\_glue\_cont}\par
\P\D \37$\\{cancel\_glue\_cont}(\#)\S\\{link}(\#)\K\|j$;\5
\\{cancel\_glue\_cont\_cont}\par
\P\D \37$\\{cancel\_glue\_cont\_cont}(\#)\S\\{link}(\|j)\K\#$;\5
\\{cancel\_glue\_end}\par
\P\D \37$\\{cancel\_glue\_end}(\#)\S\|j\K\\{glue\_ptr}(\#)$;\5
\\{cancel\_glue\_end\_end}\par
\P\D \37$\\{cancel\_glue\_end\_end}(\#)\S\\{stretch\_order}(\\{temp\_ptr})\K%
\\{stretch\_order}(\|j)$;\5
$\\{shrink\_order}(\\{temp\_ptr})\K\\{shrink\_order}(\|j)$;\5
$\\{width}(\\{temp\_ptr})\K\#-\\{width}(\|j)$;\5
$\\{stretch}(\\{temp\_ptr})\K-\\{stretch}(\|j)$;\5
$\\{shrink}(\\{temp\_ptr})\K-\\{shrink}(\|j)$\par
\Y\P$\4\X1746:Package the display line\X\S$\6
\&{if} $\|j=\\{null}$ \1\&{then}\6
\&{begin} \37$\|r\K\\{new\_kern}(0)$;\5
$\|t\K\\{new\_kern}(0)$;\C{the widths will be set later}\6
\&{end}\6
\4\&{else} \&{begin} \37$\|r\K\\{list\_ptr}(\|b)$;\5
$\|t\K\\{link}(\|r)$;\6
\&{end};\2\6
$\|u\K\\{new\_math}(0,\39\\{end\_M\_code})$;\6
\&{if} $\\{type}(\|t)=\\{glue\_node}$ \1\&{then}\C{\|t is \.{\\rightskip} glue}%
\6
\&{begin} \37$\\{cancel\_glue}(\\{right\_skip\_code})(\|q)(\|u)(\|t)(\|e)$;\5
$\\{link}(\|u)\K\|t$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{width}(\|t)\K\|e$;\5
$\\{link}(\|t)\K\|u$;\5
$\\{link}(\|q)\K\|t$;\6
\&{end};\2\6
$\|u\K\\{new\_math}(0,\39\\{begin\_M\_code})$;\6
\&{if} $\\{type}(\|r)=\\{glue\_node}$ \1\&{then}\C{\|r is \.{\\leftskip} glue}\6
\&{begin} \37$\\{cancel\_glue}(\\{left\_skip\_code})(\|u)(\|p)(\|r)(\|d)$;\5
$\\{link}(\|r)\K\|u$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{width}(\|r)\K\|d$;\5
$\\{link}(\|r)\K\|p$;\5
$\\{link}(\|u)\K\|r$;\6
\&{if} $\|j=\\{null}$ \1\&{then}\6
\&{begin} \37$\|b\K\\{hpack}(\|u,\39\\{natural})$;\5
$\\{shift\_amount}(\|b)\K\|s$;\6
\&{end}\6
\4\&{else} $\\{list\_ptr}(\|b)\K\|u$;\2\6
\&{end}\2\par
\U1744.\fi

\M1747. The \\{scan\_tokens} feature of \eTeX\ defines the \.{\\scantokens}
primitive.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"scantokens"},\39\\{input},\392)$;\par
\fi

\M1748. \P$\X1748:Cases of \\{input} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=2$ \1\&{then}\5
$\\{print\_esc}(\.{"scantokens"})$\2\par
\U403.\fi

\M1749. \P$\X1749:Cases for \\{input}\X\S$\6
\4\&{else} \37\&{if} $\\{cur\_chr}=2$ \1\&{then}\5
\\{pseudo\_start}\2\par
\U404.\fi

\M1750. The global variable \\{pseudo\_files} is used to maintain a stack of
pseudo files.  The \\{info} field of each pseudo file points to a linked
list of variable size nodes representing lines not yet processed: the
\\{info} field of the first word contains the size of this node, all the
following words contain ASCII codes.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{pseudo\_files}: \37\\{pointer};\C{stack of pseudo files}\par
\fi

\M1751. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{pseudo\_files}\K\\{null}$;\par
\fi

\M1752. The \\{pseudo\_start} procedure initiates reading from a pseudo file.

\Y\P$\4\X1752:Declare \eTeX\ procedures for expanding\X\S$\6
\4\&{procedure}\1\  \37\\{pseudo\_start};\5
\\{forward};\5
\hbox{\2}\par
\As1810, 1815\ETs1819.
\U388.\fi

\M1753. \P$\X1683:Declare \eTeX\ procedures for token lists\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{pseudo\_start};\6
\4\&{var} \37\\{old\_setting}: \37$0\to\\{max\_selector}$;\C{holds \\{selector}
setting}\6
\|s: \37\\{str\_number};\C{string to be converted into a pseudo file}\6
$\|l,\39\|m$: \37\\{pool\_pointer};\C{indices into \\{str\_pool}}\6
$\|p,\39\|q,\39\|r$: \37\\{pointer};\C{for list construction}\6
\|w: \37\\{four\_quarters};\C{four ASCII codes}\6
$\\{nl},\39\\{sz}$: \37\\{integer};\2\6
\&{begin} \37\\{scan\_general\_text};\5
$\\{old\_setting}\K\\{selector}$;\5
$\\{selector}\K\\{new\_string}$;\5
$\\{token\_show}(\\{temp\_head})$;\5
$\\{selector}\K\\{old\_setting}$;\5
$\\{flush\_list}(\\{link}(\\{temp\_head}))$;\5
$\\{str\_room}(1)$;\5
$\|s\K\\{make\_string}$;\5
\X1754:Convert string \|s into a new pseudo file\X;\6
\\{flush\_string};\5
\X1755:Initiate input from new pseudo file\X;\6
\&{end};\par
\fi

\M1754. \P$\X1754:Convert string \|s into a new pseudo file\X\S$\6
$\\{str\_pool}[\\{pool\_ptr}]\K\\{si}(\.{"\ "})$;\5
$\|l\K\\{str\_start}[\|s]$;\5
$\\{nl}\K\\{si}(\\{new\_line\_char})$;\5
$\|p\K\\{get\_avail}$;\5
$\|q\K\|p$;\6
\&{while} $\|l<\\{pool\_ptr}$ \1\&{do}\6
\&{begin} \37$\|m\K\|l$;\6
\&{while} $(\|l<\\{pool\_ptr})\W(\\{str\_pool}[\|l]\I\\{nl})$ \1\&{do}\5
$\\{incr}(\|l)$;\2\6
$\\{sz}\K(\|l-\|m+7)\mathbin{\&{div}}4$;\6
\&{if} $\\{sz}=1$ \1\&{then}\5
$\\{sz}\K2$;\2\6
$\|r\K\\{get\_node}(\\{sz})$;\5
$\\{link}(\|q)\K\|r$;\5
$\|q\K\|r$;\5
$\\{info}(\|q)\K\\{hi}(\\{sz})$;\6
\&{while} $\\{sz}>2$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{sz})$;\5
$\\{incr}(\|r)$;\5
$\|w.\\{b0}\K\\{qi}(\\{so}(\\{str\_pool}[\|m]))$;\5
$\|w.\\{b1}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+1]))$;\5
$\|w.\\{b2}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+2]))$;\5
$\|w.\\{b3}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+3]))$;\5
$\\{mem}[\|r].\\{qqqq}\K\|w$;\5
$\|m\K\|m+4$;\6
\&{end};\2\6
$\|w.\\{b0}\K\\{qi}(\.{"\ "})$;\5
$\|w.\\{b1}\K\\{qi}(\.{"\ "})$;\5
$\|w.\\{b2}\K\\{qi}(\.{"\ "})$;\5
$\|w.\\{b3}\K\\{qi}(\.{"\ "})$;\6
\&{if} $\|l>\|m$ \1\&{then}\6
\&{begin} \37$\|w.\\{b0}\K\\{qi}(\\{so}(\\{str\_pool}[\|m]))$;\6
\&{if} $\|l>\|m+1$ \1\&{then}\6
\&{begin} \37$\|w.\\{b1}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+1]))$;\6
\&{if} $\|l>\|m+2$ \1\&{then}\6
\&{begin} \37$\|w.\\{b2}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+2]))$;\6
\&{if} $\|l>\|m+3$ \1\&{then}\5
$\|w.\\{b3}\K\\{qi}(\\{so}(\\{str\_pool}[\|m+3]))$;\2\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
$\\{mem}[\|r+1].\\{qqqq}\K\|w$;\6
\&{if} $\\{str\_pool}[\|l]=\\{nl}$ \1\&{then}\5
$\\{incr}(\|l)$;\2\6
\&{end};\2\6
$\\{info}(\|p)\K\\{link}(\|p)$;\5
$\\{link}(\|p)\K\\{pseudo\_files}$;\5
$\\{pseudo\_files}\K\|p$\par
\U1753.\fi

\M1755. \P$\X1755:Initiate input from new pseudo file\X\S$\6
\\{begin\_file\_reading};\C{set up \\{cur\_file} and new level of input}\6
$\\{line}\K0$;\5
$\\{limit}\K\\{start}$;\5
$\\{loc}\K\\{limit}+1$;\C{force line read}\6
\&{if} $\\{tracing\_scan\_tokens}>0$ \1\&{then}\6
\&{begin} \37\&{if} $\\{term\_offset}>\\{max\_print\_line}-3$ \1\&{then}\5
\\{print\_ln}\6
\4\&{else} \&{if} $(\\{term\_offset}>0)\V(\\{file\_offset}>0)$ \1\&{then}\5
$\\{print\_char}(\.{"\ "})$;\2\2\6
$\\{name}\K19$;\5
$\\{print}(\.{"(\ "})$;\5
$\\{incr}(\\{open\_parens})$;\5
\\{update\_terminal};\6
\&{end}\6
\4\&{else} $\\{name}\K18$\2\par
\U1753.\fi

\M1756. Here we read a line from the current pseudo file into \\{buffer}.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{function}\1\  \37\\{pseudo\_input}: \37\\{boolean};\C{inputs the next line
or returns \\{false}}\6
\4\&{var} \37\|p: \37\\{pointer};\C{current line from pseudo file}\6
\\{sz}: \37\\{integer};\C{size of node \|p}\6
\|w: \37\\{four\_quarters};\C{four ASCII codes}\6
\|r: \37\\{pointer};\C{loop index}\2\6
\&{begin} \37$\\{last}\K\\{first}$;\C{cf.\ Matthew 19\thinspace:\thinspace30}\6
$\|p\K\\{info}(\\{pseudo\_files})$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{pseudo\_input}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{info}(\\{pseudo\_files})\K\\{link}(\|p)$;\5
$\\{sz}\K\\{ho}(\\{info}(\|p))$;\6
\&{if} $4\ast\\{sz}-3\G\\{buf\_size}-\\{last}$ \1\&{then}\5
\X35:Report overflow of the input buffer, and abort\X;\2\6
$\\{last}\K\\{first}$;\6
\&{for} $\|r\K\|p+1\mathrel{\&{to}}\|p+\\{sz}-1$ \1\&{do}\6
\&{begin} \37$\|w\K\\{mem}[\|r].\\{qqqq}$;\5
$\\{buffer}[\\{last}]\K\|w.\\{b0}$;\5
$\\{buffer}[\\{last}+1]\K\|w.\\{b1}$;\5
$\\{buffer}[\\{last}+2]\K\|w.\\{b2}$;\5
$\\{buffer}[\\{last}+3]\K\|w.\\{b3}$;\5
$\\{last}\K\\{last}+4$;\6
\&{end};\2\6
\&{if} $\\{last}\G\\{max\_buf\_stack}$ \1\&{then}\5
$\\{max\_buf\_stack}\K\\{last}+1$;\2\6
\&{while} $(\\{last}>\\{first})\W(\\{buffer}[\\{last}-1]=\.{"\ "})$ \1\&{do}\5
$\\{decr}(\\{last})$;\2\6
$\\{free\_node}(\|p,\39\\{sz})$;\5
$\\{pseudo\_input}\K\\{true}$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1757. When we are done with a pseudo file we `close' it.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{pseudo\_close};\C{close the top level pseudo file}\6
\4\&{var} \37$\|p,\39\|q$: \37\\{pointer};\2\6
\&{begin} \37$\|p\K\\{link}(\\{pseudo\_files})$;\5
$\|q\K\\{info}(\\{pseudo\_files})$;\5
$\\{free\_avail}(\\{pseudo\_files})$;\5
$\\{pseudo\_files}\K\|p$;\6
\&{while} $\|q\I\\{null}$ \1\&{do}\6
\&{begin} \37$\|p\K\|q$;\5
$\|q\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\\{ho}(\\{info}(\|p)))$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1758. \P$\X1654:Dump the \eTeX\ state\X\mathrel{+}\S$\6
\&{while} $\\{pseudo\_files}\I\\{null}$ \1\&{do}\5
\\{pseudo\_close};\C{flush pseudo files}\2\par
\fi

\M1759. \P$\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"readline"},\39\\{read\_to\_cs},\391)$;\par
\fi

\M1760. \P$\X1760:Cases of \\{read} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37$\\{print\_esc}(\.{"readline"})$\par
\U288.\fi

\M1761. \P$\X1761:Handle \.{\\readline} and \&{goto} \\{done}\X\S$\6
\&{if} $\|j=1$ \1\&{then}\6
\&{begin} \37\&{while} $\\{loc}\L\\{limit}$ \1\&{do}\C{current line not yet
finished}\6
\&{begin} \37$\\{cur\_chr}\K\\{buffer}[\\{loc}]$;\5
$\\{incr}(\\{loc})$;\6
\&{if} $\\{cur\_chr}=\.{"\ "}$ \1\&{then}\5
$\\{cur\_tok}\K\\{space\_token}$\ \&{else} $\\{cur\_tok}\K\\{cur\_chr}+\\{other%
\_token}$;\2\6
$\\{store\_new\_token}(\\{cur\_tok})$;\6
\&{end};\2\6
\&{goto} \37\\{done};\6
\&{end}\2\par
\U509.\fi

\M1762. Here we define the additional conditionals of \eTeX\ as well as the
\.{\\unless} prefix.

\Y\P\D \37$\\{if\_def\_code}=17$\C{ `\.{\\ifdefined}' }\par
\P\D \37$\\{if\_cs\_code}=18$\C{ `\.{\\ifcsname}' }\par
\P\D \37$\\{if\_font\_char\_code}=19$\C{ `\.{\\iffontchar}' }\par
\P\D \37$\\{if\_in\_csname\_code}=20$\C{ `\.{\\ifincsname}' }\par
\P\D \37$\\{if\_pdfabs\_num\_code}=22$\C{ `\.{\\ifpdfabsnum}' }\6
\C{ 21 = \\{if\_pdfprimitive}}\par
\P\D \37$\\{if\_pdfabs\_dim\_code}=23$\C{ `\.{\\ifpdfabsdim}' }\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"unless"},\39\\{expand\_after},\391)$;\6
$\\{primitive}(\.{"ifdefined"},\39\\{if\_test},\39\\{if\_def\_code})$;\5
$\\{primitive}(\.{"ifcsname"},\39\\{if\_test},\39\\{if\_cs\_code})$;\5
$\\{primitive}(\.{"iffontchar"},\39\\{if\_test},\39\\{if\_font\_char\_code})$;\5
$\\{primitive}(\.{"ifincsname"},\39\\{if\_test},\39\\{if\_in\_csname\_code})$;\5
$\\{primitive}(\.{"ifpdfabsnum"},\39\\{if\_test},\39\\{if\_pdfabs\_num%
\_code})$;\5
$\\{primitive}(\.{"ifpdfabsdim"},\39\\{if\_test},\39\\{if\_pdfabs\_dim%
\_code})$;\par
\fi

\M1763. \P$\X1763:Cases of \\{expandafter} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37$\\{print\_esc}(\.{"unless"})$\par
\U288.\fi

\M1764. \P$\X1764:Cases of \\{if\_test} for \\{print\_cmd\_chr}\X\S$\6
\4\\{if\_def\_code}: \37$\\{print\_esc}(\.{"ifdefined"})$;\6
\4\\{if\_cs\_code}: \37$\\{print\_esc}(\.{"ifcsname"})$;\6
\4\\{if\_font\_char\_code}: \37$\\{print\_esc}(\.{"iffontchar"})$;\6
\4\\{if\_in\_csname\_code}: \37$\\{print\_esc}(\.{"ifincsname"})$;\6
\4\\{if\_pdfabs\_num\_code}: \37$\\{print\_esc}(\.{"ifpdfabsnum"})$;\6
\4\\{if\_pdfabs\_dim\_code}: \37$\\{print\_esc}(\.{"ifpdfabsdim"})$;\par
\U514.\fi

\M1765. The result of a boolean condition is reversed when the conditional is
preceded by \.{\\unless}.

\Y\P$\4\X1765:Negate a boolean conditional and \&{goto} \\{reswitch}\X\S$\6
\&{begin} \37\\{get\_token};\6
\&{if} $(\\{cur\_cmd}=\\{if\_test})\W(\\{cur\_chr}\I\\{if\_case\_code})$ \1%
\&{then}\6
\&{begin} \37$\\{cur\_chr}\K\\{cur\_chr}+\\{unless\_code}$;\5
\&{goto} \37\\{reswitch};\6
\&{end};\2\6
$\\{print\_err}(\.{"You\ can\'t\ use\ \`"})$;\5
$\\{print\_esc}(\.{"unless"})$;\5
$\\{print}(\.{"\'\ before\ \`"})$;\5
$\\{print\_cmd\_chr}(\\{cur\_cmd},\39\\{cur\_chr})$;\5
$\\{print\_char}(\.{"\'"})$;\5
$\\{help1}(\.{"Continue,\ and\ I\'ll\ forget\ that\ it\ ever\ happened."})$;\5
\\{back\_error};\6
\&{end}\par
\U391.\fi

\M1766. The conditional \.{\\ifdefined} tests if a control sequence is
defined.

We need to reset \\{scanner\_status}, since \.{\\outer} control sequences
are allowed, but we might be scanning a macro definition or preamble.

\Y\P$\4\X1766:Cases for \\{conditional}\X\S$\6
\4\\{if\_def\_code}: \37\&{begin} \37$\\{save\_scanner\_status}\K\\{scanner%
\_status}$;\5
$\\{scanner\_status}\K\\{normal}$;\5
\\{get\_next};\5
$\|b\K(\\{cur\_cmd}\I\\{undefined\_cs})$;\5
$\\{scanner\_status}\K\\{save\_scanner\_status}$;\6
\&{end};\par
\As1767\ET1769.
\U527.\fi

\M1767. The conditional \.{\\ifcsname} is equivalent to \.{\{\\expandafter}
\.{\}\\expandafter} \.{\\ifdefined} \.{\\csname}, except that no new
control sequence will be entered into the hash table (once all tokens
preceding the mandatory \.{\\endcsname} have been expanded).

\Y\P$\4\X1766:Cases for \\{conditional}\X\mathrel{+}\S$\6
\4\\{if\_cs\_code}: \37\&{begin} \37$\|n\K\\{get\_avail}$;\5
$\|p\K\|n$;\C{head of the list of characters}\6
$\|e\K\\{is\_in\_csname}$;\5
$\\{is\_in\_csname}\K\\{true}$;\6
\1\&{repeat} \37\\{get\_x\_token};\6
\&{if} $\\{cur\_cs}=0$ \1\&{then}\5
$\\{store\_new\_token}(\\{cur\_tok})$;\2\6
\4\&{until}\5
$\\{cur\_cs}\I0$;\2\6
\&{if} $\\{cur\_cmd}\I\\{end\_cs\_name}$ \1\&{then}\5
\X399:Complain about missing \.{\\endcsname}\X;\2\6
\X1768:Look up the characters of list \|n in the hash table, and set \\{cur%
\_cs}\X;\6
$\\{flush\_list}(\|n)$;\5
$\|b\K(\\{eq\_type}(\\{cur\_cs})\I\\{undefined\_cs})$;\5
$\\{is\_in\_csname}\K\|e$;\6
\&{end};\par
\fi

\M1768. \P$\X1768:Look up the characters of list \|n in the hash table, and set
\\{cur\_cs}\X\S$\6
$\|m\K\\{first}$;\5
$\|p\K\\{link}(\|n)$;\6
\&{while} $\|p\I\\{null}$ \1\&{do}\6
\&{begin} \37\&{if} $\|m\G\\{max\_buf\_stack}$ \1\&{then}\6
\&{begin} \37$\\{max\_buf\_stack}\K\|m+1$;\6
\&{if} $\\{max\_buf\_stack}=\\{buf\_size}$ \1\&{then}\5
$\\{overflow}(\.{"buffer\ size"},\39\\{buf\_size})$;\2\6
\&{end};\2\6
$\\{buffer}[\|m]\K\\{info}(\|p)\mathbin{\&{mod}}\O{400}$;\5
$\\{incr}(\|m)$;\5
$\|p\K\\{link}(\|p)$;\6
\&{end};\2\6
\&{if} $\|m>\\{first}+1$ \1\&{then}\5
$\\{cur\_cs}\K\\{id\_lookup}(\\{first},\39\|m-\\{first})$\C{\\{no\_new\_control%
\_sequence} is \\{true}}\6
\4\&{else} \&{if} $\|m=\\{first}$ \1\&{then}\5
$\\{cur\_cs}\K\\{null\_cs}$\C{the list is empty}\6
\4\&{else} $\\{cur\_cs}\K\\{single\_base}+\\{buffer}[\\{first}]$\C{the list has
length one}\2\2\par
\U1767.\fi

\M1769. The conditional \.{\\iffontchar} tests the existence of a character in
a font.

\Y\P$\4\X1766:Cases for \\{conditional}\X\mathrel{+}\S$\6
\4\\{if\_in\_csname\_code}: \37$\|b\K\\{is\_in\_csname}$;\6
\4$\\{if\_pdfabs\_dim\_code},\39\\{if\_pdfabs\_num\_code}$: \37\&{begin} \37%
\&{if} $\\{this\_if}=\\{if\_pdfabs\_num\_code}$ \1\&{then}\5
\\{scan\_int}\ \&{else} \\{scan\_normal\_dimen};\2\6
$\|n\K\\{cur\_val}$;\6
\&{if} $\|n<0$ \1\&{then}\5
$\\{negate}(\|n)$;\2\6
\X432:Get the next non-blank non-call token\X;\6
\&{if} $(\\{cur\_tok}\G\\{other\_token}+\.{"<"})\W(\\{cur\_tok}\L\\{other%
\_token}+\.{">"})$ \1\&{then}\5
$\|r\K\\{cur\_tok}-\\{other\_token}$\6
\4\&{else} \&{begin} \37$\\{print\_err}(\.{"Missing\ =\ inserted\ for\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{this\_if})$;\5
$\\{help1}(\.{"I\ was\ expecting\ to\ see\ \`<\',\ \`=\',\ or\ \`>\'.\ Didn%
\'t."})$;\5
\\{back\_error};\5
$\|r\K\.{"="}$;\6
\&{end};\2\6
\&{if} $\\{this\_if}=\\{if\_pdfabs\_num\_code}$ \1\&{then}\5
\\{scan\_int}\ \&{else} \\{scan\_normal\_dimen};\2\6
\&{if} $\\{cur\_val}<0$ \1\&{then}\5
$\\{negate}(\\{cur\_val})$;\2\6
\&{case} $\|r$ \1\&{of}\6
\4\.{"<"}: \37$\|b\K(\|n<\\{cur\_val})$;\6
\4\.{"="}: \37$\|b\K(\|n=\\{cur\_val})$;\6
\4\.{">"}: \37$\|b\K(\|n>\\{cur\_val})$;\2\6
\&{end};\6
\&{end};\6
\4\\{if\_font\_char\_code}: \37\&{begin} \37\\{scan\_font\_ident};\5
$\|n\K\\{cur\_val}$;\5
\\{scan\_char\_num};\6
\&{if} $(\\{font\_bc}[\|n]\L\\{cur\_val})\W(\\{font\_ec}[\|n]\G\\{cur\_val})$ %
\1\&{then}\5
$\|b\K\\{char\_exists}(\\{char\_info}(\|n)(\\{qi}(\\{cur\_val})))$\6
\4\&{else} $\|b\K\\{false}$;\2\6
\&{end};\par
\fi

\M1770. The \\{protected} feature of \eTeX\ defines the \.{\\protected} prefix
command for macro definitions.  Such macros are protected against
expansions when lists of expanded tokens are built, e.g., for \.{\\edef}
or during \.{\\write}.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"protected"},\39\\{prefix},\398)$;\par
\fi

\M1771. \P$\X1771:Cases of \\{prefix} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=8$ \1\&{then}\5
$\\{print\_esc}(\.{"protected"})$\2\par
\U1387.\fi

\M1772. The \\{get\_x\_or\_protected} procedure is like \\{get\_x\_token}
except that
protected macros are not expanded.

\Y\P$\4\X1682:Declare \eTeX\ procedures for scanning\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{get\_x\_or\_protected};\C{sets \\{cur\_cmd}, \\{cur%
\_chr}, \\{cur\_tok},   and expands non-protected macros}\6
\4\&{label} \37\\{exit};\2\6
\&{begin} \37\~ \1\&{loop}\ \&{begin} \37\\{get\_token};\6
\&{if} $\\{cur\_cmd}\L\\{max\_command}$ \1\&{then}\5
\&{return};\2\6
\&{if} $(\\{cur\_cmd}\G\\{call})\W(\\{cur\_cmd}<\\{end\_template})$ \1\&{then}\6
\&{if} $\\{info}(\\{link}(\\{cur\_chr}))=\\{protected\_token}$ \1\&{then}\5
\&{return};\2\2\6
\\{expand};\6
\&{end};\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1773. A group entered (or a conditional started) in one file may end in a
different file.  Such slight anomalies, although perfectly legitimate,
may cause errors that are difficult to locate.  In order to be able to
give a warning message when such anomalies occur, \eTeX\ uses the
\\{grp\_stack} and \\{if\_stack} arrays to record the initial \\{cur\_boundary}
and \\{cond\_ptr} values for each input file.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{grp\_stack}: \37\&{array} $[0\to\\{max\_in\_open}]$ \1\&{of}\5
\\{save\_pointer};\C{initial \\{cur\_boundary}}\2\6
\4\\{if\_stack}: \37\&{array} $[0\to\\{max\_in\_open}]$ \1\&{of}\5
\\{pointer};\C{initial \\{cond\_ptr}}\2\par
\fi

\M1774. When a group ends that was apparently entered in a different input
file, the \\{group\_warning} procedure is invoked in order to update the
\\{grp\_stack}.  If moreover \.{\\tracingnesting} is positive we want to
give a warning message.  The situation is, however, somewhat complicated
by two facts:  (1)~There may be \\{grp\_stack} elements without a
corresponding \.{\\input} file or \.{\\scantokens} pseudo file (e.g.,
error insertions from the terminal); and (2)~the relevant information is
recorded in the \\{name\_field} of the \\{input\_stack} only loosely
synchronized with the \\{in\_open} variable indexing \\{grp\_stack}.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{group\_warning};\6
\4\&{var} \37\|i: \37$0\to\\{max\_in\_open}$;\C{index into \\{grp\_stack}}\6
\|w: \37\\{boolean};\C{do we need a warning?}\2\6
\&{begin} \37$\\{base\_ptr}\K\\{input\_ptr}$;\5
$\\{input\_stack}[\\{base\_ptr}]\K\\{cur\_input}$;\C{store current state}\6
$\|i\K\\{in\_open}$;\5
$\|w\K\\{false}$;\6
\&{while} $(\\{grp\_stack}[\|i]=\\{cur\_boundary})\W(\|i>0)$ \1\&{do}\6
\&{begin} \37\X1775:Set variable \|w to indicate if this case should be
reported\X;\6
$\\{grp\_stack}[\|i]\K\\{save\_index}(\\{save\_ptr})$;\5
$\\{decr}(\|i)$;\6
\&{end};\2\6
\&{if} $\|w$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Warning:\ end\ of\ "})$;\5
$\\{print\_group}(\\{true})$;\5
$\\{print}(\.{"\ of\ a\ different\ file"})$;\5
\\{print\_ln};\6
\&{if} $\\{tracing\_nesting}>1$ \1\&{then}\5
\\{show\_context};\2\6
\&{if} $\\{history}=\\{spotless}$ \1\&{then}\5
$\\{history}\K\\{warning\_issued}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1775. This code scans the input stack in order to determine the type of the
current input file.

\Y\P$\4\X1775:Set variable \|w to indicate if this case should be reported\X\S$%
\6
\&{if} $\\{tracing\_nesting}>0$ \1\&{then}\6
\&{begin} \37\&{while} $(\\{input\_stack}[\\{base\_ptr}].\\{state\_field}=%
\\{token\_list})\V\30(\\{input\_stack}[\\{base\_ptr}].\\{index\_field}>\|i)$ \1%
\&{do}\5
$\\{decr}(\\{base\_ptr})$;\2\6
\&{if} $\\{input\_stack}[\\{base\_ptr}].\\{name\_field}>17$ \1\&{then}\5
$\|w\K\\{true}$;\2\6
\&{end}\2\par
\Us1774\ET1776.\fi

\M1776. When a conditional ends that was apparently started in a different
input file, the \\{if\_warning} procedure is invoked in order to update the
\\{if\_stack}.  If moreover \.{\\tracingnesting} is positive we want to
give a warning message (with the same complications as above).

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{if\_warning};\6
\4\&{var} \37\|i: \37$0\to\\{max\_in\_open}$;\C{index into \\{if\_stack}}\6
\|w: \37\\{boolean};\C{do we need a warning?}\2\6
\&{begin} \37$\\{base\_ptr}\K\\{input\_ptr}$;\5
$\\{input\_stack}[\\{base\_ptr}]\K\\{cur\_input}$;\C{store current state}\6
$\|i\K\\{in\_open}$;\5
$\|w\K\\{false}$;\6
\&{while} $\\{if\_stack}[\|i]=\\{cond\_ptr}$ \1\&{do}\6
\&{begin} \37\X1775:Set variable \|w to indicate if this case should be
reported\X;\6
$\\{if\_stack}[\|i]\K\\{link}(\\{cond\_ptr})$;\5
$\\{decr}(\|i)$;\6
\&{end};\2\6
\&{if} $\|w$ \1\&{then}\6
\&{begin} \37$\\{print\_nl}(\.{"Warning:\ end\ of\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{cur\_if})$;\5
$\\{print\_if\_line}(\\{if\_line})$;\5
$\\{print}(\.{"\ of\ a\ different\ file"})$;\5
\\{print\_ln};\6
\&{if} $\\{tracing\_nesting}>1$ \1\&{then}\5
\\{show\_context};\2\6
\&{if} $\\{history}=\\{spotless}$ \1\&{then}\5
$\\{history}\K\\{warning\_issued}$;\2\6
\&{end};\2\6
\&{end};\par
\fi

\M1777. Conversely, the \\{file\_warning} procedure is invoked when a file ends
and some groups entered or conditionals started while reading from that
file are still incomplete.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{file\_warning};\6
\4\&{var} \37\|p: \37\\{pointer};\C{saved value of \\{save\_ptr} or \\{cond%
\_ptr}}\6
\|l: \37\\{quarterword};\C{saved value of \\{cur\_level} or \\{if\_limit}}\6
\|c: \37\\{quarterword};\C{saved value of \\{cur\_group} or \\{cur\_if}}\6
\|i: \37\\{integer};\C{saved value of \\{if\_line}}\2\6
\&{begin} \37$\|p\K\\{save\_ptr}$;\5
$\|l\K\\{cur\_level}$;\5
$\|c\K\\{cur\_group}$;\5
$\\{save\_ptr}\K\\{cur\_boundary}$;\6
\&{while} $\\{grp\_stack}[\\{in\_open}]\I\\{save\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{decr}(\\{cur\_level})$;\5
$\\{print\_nl}(\.{"Warning:\ end\ of\ file\ when\ "})$;\5
$\\{print\_group}(\\{true})$;\5
$\\{print}(\.{"\ is\ incomplete"})$;\6
$\\{cur\_group}\K\\{save\_level}(\\{save\_ptr})$;\5
$\\{save\_ptr}\K\\{save\_index}(\\{save\_ptr})$\6
\&{end};\2\6
$\\{save\_ptr}\K\|p$;\5
$\\{cur\_level}\K\|l$;\5
$\\{cur\_group}\K\|c$;\C{restore old values}\6
$\|p\K\\{cond\_ptr}$;\5
$\|l\K\\{if\_limit}$;\5
$\|c\K\\{cur\_if}$;\5
$\|i\K\\{if\_line}$;\6
\&{while} $\\{if\_stack}[\\{in\_open}]\I\\{cond\_ptr}$ \1\&{do}\6
\&{begin} \37$\\{print\_nl}(\.{"Warning:\ end\ of\ file\ when\ "})$;\5
$\\{print\_cmd\_chr}(\\{if\_test},\39\\{cur\_if})$;\6
\&{if} $\\{if\_limit}=\\{fi\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"else"})$;\2\6
$\\{print\_if\_line}(\\{if\_line})$;\5
$\\{print}(\.{"\ is\ incomplete"})$;\6
$\\{if\_line}\K\\{if\_line\_field}(\\{cond\_ptr})$;\5
$\\{cur\_if}\K\\{subtype}(\\{cond\_ptr})$;\5
$\\{if\_limit}\K\\{type}(\\{cond\_ptr})$;\5
$\\{cond\_ptr}\K\\{link}(\\{cond\_ptr})$;\6
\&{end};\2\6
$\\{cond\_ptr}\K\|p$;\5
$\\{if\_limit}\K\|l$;\5
$\\{cur\_if}\K\|c$;\5
$\\{if\_line}\K\|i$;\C{restore old values}\6
\\{print\_ln};\6
\&{if} $\\{tracing\_nesting}>1$ \1\&{then}\5
\\{show\_context};\2\6
\&{if} $\\{history}=\\{spotless}$ \1\&{then}\5
$\\{history}\K\\{warning\_issued}$;\2\6
\&{end};\par
\fi

\M1778. Here are the additional \eTeX\ primitives for expressions.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"numexpr"},\39\\{last\_item},\39\\{eTeX\_expr}-\\{int\_val}+%
\\{int\_val})$;\5
$\\{primitive}(\.{"dimexpr"},\39\\{last\_item},\39\\{eTeX\_expr}-\\{int\_val}+%
\\{dimen\_val})$;\5
$\\{primitive}(\.{"glueexpr"},\39\\{last\_item},\39\\{eTeX\_expr}-\\{int\_val}+%
\\{glue\_val})$;\5
$\\{primitive}(\.{"muexpr"},\39\\{last\_item},\39\\{eTeX\_expr}-\\{int\_val}+%
\\{mu\_val})$;\par
\fi

\M1779. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4$\\{eTeX\_expr}-\\{int\_val}+\\{int\_val}$: \37$\\{print\_esc}(%
\.{"numexpr"})$;\6
\4$\\{eTeX\_expr}-\\{int\_val}+\\{dimen\_val}$: \37$\\{print\_esc}(%
\.{"dimexpr"})$;\6
\4$\\{eTeX\_expr}-\\{int\_val}+\\{glue\_val}$: \37$\\{print\_esc}(%
\.{"glueexpr"})$;\6
\4$\\{eTeX\_expr}-\\{int\_val}+\\{mu\_val}$: \37$\\{print\_esc}(\.{"muexpr"})$;%
\par
\fi

\M1780. This code for reducing \\{cur\_val\_level} and\slash or negating the
result is similar to the one for all the other cases of
\\{scan\_something\_internal}, with the difference that \\{scan\_expr} has
already increased the reference count of a glue specification.

\Y\P$\4\X1780:Process an expression and \&{return}\X\S$\6
\&{begin} \37\&{if} $\|m<\\{eTeX\_mu}$ \1\&{then}\6
\&{begin} \37\&{case} $\|m$ \1\&{of}\6
\X1807:Cases for fetching a glue value\X\2\6
\&{end};\C{there are no other cases}\6
$\\{cur\_val\_level}\K\\{glue\_val}$;\6
\&{end}\6
\4\&{else} \&{if} $\|m<\\{eTeX\_expr}$ \1\&{then}\6
\&{begin} \37\&{case} $\|m$ \1\&{of}\6
\X1808:Cases for fetching a mu value\X\2\6
\&{end};\C{there are no other cases}\6
$\\{cur\_val\_level}\K\\{mu\_val}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_val\_level}\K\|m-\\{eTeX\_expr}+\\{int\_val}$;%
\5
\\{scan\_expr};\6
\&{end};\2\2\6
\&{while} $\\{cur\_val\_level}>\\{level}$ \1\&{do}\6
\&{begin} \37\&{if} $\\{cur\_val\_level}=\\{glue\_val}$ \1\&{then}\6
\&{begin} \37$\|m\K\\{cur\_val}$;\5
$\\{cur\_val}\K\\{width}(\|m)$;\5
$\\{delete\_glue\_ref}(\|m)$;\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_val\_level}=\\{mu\_val}$ \1\&{then}\5
\\{mu\_error};\2\2\6
$\\{decr}(\\{cur\_val\_level})$;\6
\&{end};\2\6
\&{if} $\\{negative}$ \1\&{then}\6
\&{if} $\\{cur\_val\_level}\G\\{glue\_val}$ \1\&{then}\6
\&{begin} \37$\|m\K\\{cur\_val}$;\5
$\\{cur\_val}\K\\{new\_spec}(\|m)$;\5
$\\{delete\_glue\_ref}(\|m)$;\5
\X457:Negate all three glue components of \\{cur\_val}\X;\6
\&{end}\6
\4\&{else} $\\{negate}(\\{cur\_val})$;\2\2\6
\&{return};\6
\&{end}\par
\U450.\fi

\M1781. \P$\X1682:Declare \eTeX\ procedures for scanning\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_expr};\5
\\{forward};\5
\hbox{\2}\par
\fi

\M1782. The \\{scan\_expr} procedure scans and evaluates an expression.

\Y\P$\4\X1782:Declare procedures needed for expressions\X\S$\6
\hbox{\4}\X1793:Declare subprocedures for \\{scan\_expr}\X \6
\4\&{procedure}\1\  \37\\{scan\_expr};\C{scans and evaluates an expression}\6
\4\&{label} \37$\\{restart},\39\\{continue},\39\\{found}$;\6
\4\&{var} \37$\|a,\39\|b$: \37\\{boolean};\C{saved values of \\{arith\_error}}\6
\|l: \37\\{small\_number};\C{type of expression}\6
\|r: \37\\{small\_number};\C{state of expression so far}\6
\|s: \37\\{small\_number};\C{state of term so far}\6
\|o: \37\\{small\_number};\C{next operation or type of next factor}\6
\|e: \37\\{integer};\C{expression so far}\6
\|t: \37\\{integer};\C{term so far}\6
\|f: \37\\{integer};\C{current factor}\6
\|n: \37\\{integer};\C{numerator of combined multiplication and division}\6
\|p: \37\\{pointer};\C{top of expression stack}\6
\|q: \37\\{pointer};\C{for stack manipulations}\2\6
\&{begin} \37$\|l\K\\{cur\_val\_level}$;\5
$\|a\K\\{arith\_error}$;\5
$\|b\K\\{false}$;\5
$\|p\K\\{null}$;\5
$\\{incr}(\\{expand\_depth\_count})$;\6
\&{if} $\\{expand\_depth\_count}\G\\{expand\_depth}$ \1\&{then}\5
$\\{overflow}(\.{"expansion\ depth"},\39\\{expand\_depth})$;\2\6
\X1783:Scan and evaluate an expression \|e of type \|l\X;\6
$\\{decr}(\\{expand\_depth\_count})$;\6
\&{if} $\|b$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Arithmetic\ overflow"})$;\5
$\\{help2}(\.{"I\ can\'t\ evaluate\ this\ expression,"})$\6
$(\.{"since\ the\ result\ is\ out\ of\ range."})$;\5
\\{error};\6
\&{if} $\|l\G\\{glue\_val}$ \1\&{then}\6
\&{begin} \37$\\{delete\_glue\_ref}(\|e)$;\5
$\|e\K\\{zero\_glue}$;\5
$\\{add\_glue\_ref}(\|e)$;\6
\&{end}\6
\4\&{else} $\|e\K0$;\2\6
\&{end};\2\6
$\\{arith\_error}\K\|a$;\5
$\\{cur\_val}\K\|e$;\5
$\\{cur\_val\_level}\K\|l$;\6
\&{end};\par
\A1787.
\U487.\fi

\M1783. Evaluating an expression is a recursive process:  When the left
parenthesis of a subexpression is scanned we descend to the next level
of recursion; the previous level is resumed with the matching right
parenthesis.

\Y\P\D \37$\\{expr\_none}=0$\C{\.( seen, or \.( $\langle\it expr\rangle$ \.)
seen}\par
\P\D \37$\\{expr\_add}=1$\C{\.( $\langle\it expr\rangle$ \.+ seen}\par
\P\D \37$\\{expr\_sub}=2$\C{\.( $\langle\it expr\rangle$ \.- seen}\par
\P\D \37$\\{expr\_mult}=3$\C{$\langle\it term\rangle$ \.* seen}\par
\P\D \37$\\{expr\_div}=4$\C{$\langle\it term\rangle$ \./ seen}\par
\P\D \37$\\{expr\_scale}=5$\C{$\langle\it term\rangle$ \.*   $\langle\it factor%
\rangle$ \./ seen}\par
\Y\P$\4\X1783:Scan and evaluate an expression \|e of type \|l\X\S$\6
\4\\{restart}: \37$\|r\K\\{expr\_none}$;\5
$\|e\K0$;\5
$\|s\K\\{expr\_none}$;\5
$\|t\K0$;\5
$\|n\K0$;\6
\4\\{continue}: \37\&{if} $\|s=\\{expr\_none}$ \1\&{then}\5
$\|o\K\|l$\ \&{else} $\|o\K\\{int\_val}$;\2\6
\X1785:Scan a factor \|f of type \|o or start a subexpression\X;\6
\4\\{found}: \37\X1784:Scan the next operator and set \|o\X;\6
$\\{arith\_error}\K\|b$;\5
\X1790:Make sure that \|f is in the proper range\X;\6
\&{case} $\|s$ \1\&{of}\6
\X1791:Cases for evaluation of the current term\X\2\6
\&{end};\C{there are no other cases}\6
\&{if} $\|o>\\{expr\_sub}$ \1\&{then}\5
$\|s\K\|o$\ \&{else} \X1792:Evaluate the current expression\X;\2\6
$\|b\K\\{arith\_error}$;\6
\&{if} $\|o\I\\{expr\_none}$ \1\&{then}\5
\&{goto} \37\\{continue};\2\6
\&{if} $\|p\I\\{null}$ \1\&{then}\5
\X1789:Pop the expression stack and \&{goto} \\{found}\X\2\par
\U1782.\fi

\M1784. \P$\X1784:Scan the next operator and set \|o\X\S$\6
\X432:Get the next non-blank non-call token\X;\6
\&{if} $\\{cur\_tok}=\\{other\_token}+\.{"+"}$ \1\&{then}\5
$\|o\K\\{expr\_add}$\6
\4\&{else} \&{if} $\\{cur\_tok}=\\{other\_token}+\.{"-"}$ \1\&{then}\5
$\|o\K\\{expr\_sub}$\6
\4\&{else} \&{if} $\\{cur\_tok}=\\{other\_token}+\.{"*"}$ \1\&{then}\5
$\|o\K\\{expr\_mult}$\6
\4\&{else} \&{if} $\\{cur\_tok}=\\{other\_token}+\.{"/"}$ \1\&{then}\5
$\|o\K\\{expr\_div}$\6
\4\&{else} \&{begin} \37$\|o\K\\{expr\_none}$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{cur\_cmd}\I\\{relax}$ \1\&{then}\5
\\{back\_input};\2\6
\&{end}\6
\4\&{else} \&{if} $\\{cur\_tok}\I\\{other\_token}+\.{")"}$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Missing\ )\ inserted\ for\ expression"})$;\5
$\\{help1}(\.{"I\ was\ expecting\ to\ see\ \`+\',\ \`-\',\ \`*\',\ \`/\',\ or\ %
\`)\'.\ Didn\'t."})$;\5
\\{back\_error};\6
\&{end};\2\2\6
\&{end}\2\2\2\2\par
\U1783.\fi

\M1785. \P$\X1785:Scan a factor \|f of type \|o or start a subexpression\X\S$\6
\X432:Get the next non-blank non-call token\X;\6
\&{if} $\\{cur\_tok}=\\{other\_token}+\.{"("}$ \1\&{then}\5
\X1788:Push the expression stack and \&{goto} \\{restart}\X;\2\6
\\{back\_input};\6
\&{if} $\|o=\\{int\_val}$ \1\&{then}\5
\\{scan\_int}\6
\4\&{else} \&{if} $\|o=\\{dimen\_val}$ \1\&{then}\5
\\{scan\_normal\_dimen}\6
\4\&{else} \&{if} $\|o=\\{glue\_val}$ \1\&{then}\5
\\{scan\_normal\_glue}\6
\4\&{else} \\{scan\_mu\_glue};\2\2\2\6
$\|f\K\\{cur\_val}$\par
\U1783.\fi

\M1786. \P$\X1682:Declare \eTeX\ procedures for scanning\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_normal\_glue};\5
\\{forward};\5
\hbox{\2}\6
\4\&{procedure}\1\  \37\\{scan\_mu\_glue};\5
\\{forward};\5
\hbox{\2}\par
\fi

\M1787. Here we declare two trivial procedures in order to avoid mutually
recursive procedures with parameters.

\Y\P$\4\X1782:Declare procedures needed for expressions\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_normal\_glue};\2\6
\&{begin} \37$\\{scan\_glue}(\\{glue\_val})$;\6
\&{end};\7
\4\&{procedure}\1\  \37\\{scan\_mu\_glue};\2\6
\&{begin} \37$\\{scan\_glue}(\\{mu\_val})$;\6
\&{end};\par
\fi

\M1788. Parenthesized subexpressions can be inside expressions, and this
nesting has a stack.  Seven local variables represent the top of the
expression stack:  \|p points to pushed-down entries, if any; \|l
specifies the type of expression currently being evaluated; \|e is the
expression so far and \|r is the state of its evaluation; \|t is the
term so far and \|s is the state of its evaluation; finally \|n is the
numerator for a combined multiplication and division, if any.

\Y\P\D \37$\\{expr\_node\_size}=4$\C{number of words in stack entry for
subexpressions}\par
\P\D \37$\\{expr\_e\_field}(\#)\S\\{mem}[\#+1].\\{int}$\C{saved expression so
far}\par
\P\D \37$\\{expr\_t\_field}(\#)\S\\{mem}[\#+2].\\{int}$\C{saved term so far}\par
\P\D \37$\\{expr\_n\_field}(\#)\S\\{mem}[\#+3].\\{int}$\C{saved numerator}\par
\Y\P$\4\X1788:Push the expression stack and \&{goto} \\{restart}\X\S$\6
\&{begin} \37$\|q\K\\{get\_node}(\\{expr\_node\_size})$;\5
$\\{link}(\|q)\K\|p$;\5
$\\{type}(\|q)\K\|l$;\5
$\\{subtype}(\|q)\K4\ast\|s+\|r$;\5
$\\{expr\_e\_field}(\|q)\K\|e$;\5
$\\{expr\_t\_field}(\|q)\K\|t$;\5
$\\{expr\_n\_field}(\|q)\K\|n$;\5
$\|p\K\|q$;\5
$\|l\K\|o$;\5
\&{goto} \37\\{restart};\6
\&{end}\par
\U1785.\fi

\M1789. \P$\X1789:Pop the expression stack and \&{goto} \\{found}\X\S$\6
\&{begin} \37$\|f\K\|e$;\5
$\|q\K\|p$;\5
$\|e\K\\{expr\_e\_field}(\|q)$;\5
$\|t\K\\{expr\_t\_field}(\|q)$;\5
$\|n\K\\{expr\_n\_field}(\|q)$;\5
$\|s\K\\{subtype}(\|q)\mathbin{\&{div}}4$;\5
$\|r\K\\{subtype}(\|q)\mathbin{\&{mod}}4$;\5
$\|l\K\\{type}(\|q)$;\5
$\|p\K\\{link}(\|q)$;\5
$\\{free\_node}(\|q,\39\\{expr\_node\_size})$;\5
\&{goto} \37\\{found};\6
\&{end}\par
\U1783.\fi

\M1790. We want to make sure that each term and (intermediate) result is in
the proper range.  Integer values must not exceed \\{infinity}
($2^{31}-1$) in absolute value, dimensions must not exceed \\{max\_dimen}
($2^{30}-1$).  We avoid the absolute value of an integer, because this
might fail for the value $-2^{31}$ using 32-bit arithmetic.

\Y\P\D \37$\\{num\_error}(\#)\S$\C{clear a number or dimension and set \\{arith%
\_error}}\6
\&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\#\K0$;\6
\&{end}\par
\P\D \37$\\{glue\_error}(\#)\S$\C{clear a glue spec and set \\{arith\_error}}\6
\&{begin} \37$\\{arith\_error}\K\\{true}$;\5
$\\{delete\_glue\_ref}(\#)$;\5
$\#\K\\{new\_spec}(\\{zero\_glue})$;\6
\&{end}\par
\Y\P$\4\X1790:Make sure that \|f is in the proper range\X\S$\6
\&{if} $(\|l=\\{int\_val})\V(\|s>\\{expr\_sub})$ \1\&{then}\6
\&{begin} \37\&{if} $(\|f>\\{infinity})\V(\|f<-\\{infinity})$ \1\&{then}\5
$\\{num\_error}(\|f)$;\2\6
\&{end}\6
\4\&{else} \&{if} $\|l=\\{dimen\_val}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{abs}(\|f)>\\{max\_dimen}$ \1\&{then}\5
$\\{num\_error}(\|f)$;\2\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $(\\{abs}(\\{width}(\|f))>\\{max\_dimen})\V\30(%
\\{abs}(\\{stretch}(\|f))>\\{max\_dimen})\V\30(\\{abs}(\\{shrink}(\|f))>\\{max%
\_dimen})$ \1\&{then}\5
$\\{glue\_error}(\|f)$;\2\6
\&{end}\2\2\par
\U1783.\fi

\M1791. Applying the factor \|f to the partial term \|t (with the operator
\|s) is delayed until the next operator \|o has been scanned.  Here we
handle the first factor of a partial term.  A glue spec has to be copied
unless the next operator is a right parenthesis; this allows us later on
to simply modify the glue components.

\Y\P\D \37$\\{normalize\_glue}(\#)\S$\1\6
\&{if} $\\{stretch}(\#)=0$ \1\&{then}\5
$\\{stretch\_order}(\#)\K\\{normal}$;\2\2\6
\&{if} $\\{shrink}(\#)=0$ \1\&{then}\5
$\\{shrink\_order}(\#)\K\\{normal}$\2\par
\Y\P$\4\X1791:Cases for evaluation of the current term\X\S$\6
\4\\{expr\_none}: \37\&{if} $(\|l\G\\{glue\_val})\W(\|o\I\\{expr\_none})$ \1%
\&{then}\6
\&{begin} \37$\|t\K\\{new\_spec}(\|f)$;\5
$\\{delete\_glue\_ref}(\|f)$;\5
$\\{normalize\_glue}(\|t)$;\6
\&{end}\6
\4\&{else} $\|t\K\|f$;\2\par
\As1795, 1796\ETs1798.
\U1783.\fi

\M1792. When a term \|t has been completed it is copied to, added to, or
subtracted from the expression \|e.

\Y\P\D \37$\\{expr\_add\_sub}(\#)\S\\{add\_or\_sub}(\#,\39\|r=\\{expr\_sub})$%
\par
\P\D \37$\\{expr\_a}(\#)\S\\{expr\_add\_sub}(\#,\39\\{max\_dimen})$\par
\Y\P$\4\X1792:Evaluate the current expression\X\S$\6
\&{begin} \37$\|s\K\\{expr\_none}$;\6
\&{if} $\|r=\\{expr\_none}$ \1\&{then}\5
$\|e\K\|t$\6
\4\&{else} \&{if} $\|l=\\{int\_val}$ \1\&{then}\5
$\|e\K\\{expr\_add\_sub}(\|e,\39\|t,\39\\{infinity})$\6
\4\&{else} \&{if} $\|l=\\{dimen\_val}$ \1\&{then}\5
$\|e\K\\{expr\_a}(\|e,\39\|t)$\6
\4\&{else} \X1794:Compute the sum or difference of two glue specs\X;\2\2\2\6
$\|r\K\|o$;\6
\&{end}\par
\U1783.\fi

\M1793. The function $\\{add\_or\_sub}(\|x,\|y,\\{max\_answer},\\{negative})$
computes the sum
(for $\\{negative}=\\{false}$) or difference (for $\\{negative}=\\{true}$) of %
\|x and
\|y, provided the absolute value of the result does not exceed
\\{max\_answer}.

\Y\P$\4\X1793:Declare subprocedures for \\{scan\_expr}\X\S$\6
\4\&{function}\1\  \37$\\{add\_or\_sub}(\|x,\39\|y,\39\\{max\_answer}:%
\\{integer};\,\35\\{negative}:\\{boolean})$: \37\\{integer};\6
\4\&{var} \37\|a: \37\\{integer};\C{the answer}\2\6
\&{begin} \37\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\|y)$;\2\6
\&{if} $\|x\G0$ \1\&{then}\6
\&{if} $\|y\L\\{max\_answer}-\|x$ \1\&{then}\5
$\|a\K\|x+\|y$\ \&{else} $\\{num\_error}(\|a)$\2\6
\4\&{else} \&{if} $\|y\G-\\{max\_answer}-\|x$ \1\&{then}\5
$\|a\K\|x+\|y$\ \&{else} $\\{num\_error}(\|a)$;\2\2\6
$\\{add\_or\_sub}\K\|a$;\6
\&{end};\par
\As1797\ET1799.
\U1782.\fi

\M1794. We know that $\\{stretch\_order}(\|e)>\\{normal}$ implies $\\{stretch}(%
\|e)\I0$ and
$\\{shrink\_order}(\|e)>\\{normal}$ implies $\\{shrink}(\|e)\I0$.

\Y\P$\4\X1794:Compute the sum or difference of two glue specs\X\S$\6
\&{begin} \37$\\{width}(\|e)\K\\{expr\_a}(\\{width}(\|e),\39\\{width}(\|t))$;\6
\&{if} $\\{stretch\_order}(\|e)=\\{stretch\_order}(\|t)$ \1\&{then}\5
$\\{stretch}(\|e)\K\\{expr\_a}(\\{stretch}(\|e),\39\\{stretch}(\|t))$\6
\4\&{else} \&{if} $(\\{stretch\_order}(\|e)<\\{stretch\_order}(\|t))\W(%
\\{stretch}(\|t)\I0)$ \1\&{then}\6
\&{begin} \37$\\{stretch}(\|e)\K\\{stretch}(\|t)$;\5
$\\{stretch\_order}(\|e)\K\\{stretch\_order}(\|t)$;\6
\&{end};\2\2\6
\&{if} $\\{shrink\_order}(\|e)=\\{shrink\_order}(\|t)$ \1\&{then}\5
$\\{shrink}(\|e)\K\\{expr\_a}(\\{shrink}(\|e),\39\\{shrink}(\|t))$\6
\4\&{else} \&{if} $(\\{shrink\_order}(\|e)<\\{shrink\_order}(\|t))\W(%
\\{shrink}(\|t)\I0)$ \1\&{then}\6
\&{begin} \37$\\{shrink}(\|e)\K\\{shrink}(\|t)$;\5
$\\{shrink\_order}(\|e)\K\\{shrink\_order}(\|t)$;\6
\&{end};\2\2\6
$\\{delete\_glue\_ref}(\|t)$;\5
$\\{normalize\_glue}(\|e)$;\6
\&{end}\par
\U1792.\fi

\M1795. If a multiplication is followed by a division, the two operations are
combined into a `scaling' operation.  Otherwise the term \|t is
multiplied by the factor \|f.

\Y\P\D \37$\\{expr\_m}(\#)\S\#\K\\{nx\_plus\_y}(\#,\39\|f,\390)$\par
\Y\P$\4\X1791:Cases for evaluation of the current term\X\mathrel{+}\S$\6
\4\\{expr\_mult}: \37\&{if} $\|o=\\{expr\_div}$ \1\&{then}\6
\&{begin} \37$\|n\K\|f$;\5
$\|o\K\\{expr\_scale}$;\6
\&{end}\6
\4\&{else} \&{if} $\|l=\\{int\_val}$ \1\&{then}\5
$\|t\K\\{mult\_integers}(\|t,\39\|f)$\6
\4\&{else} \&{if} $\|l=\\{dimen\_val}$ \1\&{then}\5
$\\{expr\_m}(\|t)$\6
\4\&{else} \&{begin} \37$\\{expr\_m}(\\{width}(\|t))$;\5
$\\{expr\_m}(\\{stretch}(\|t))$;\5
$\\{expr\_m}(\\{shrink}(\|t))$;\6
\&{end};\2\2\2\par
\fi

\M1796. Here we divide the term \|t by the factor \|f.

\Y\P\D \37$\\{expr\_d}(\#)\S\#\K\\{quotient}(\#,\39\|f)$\par
\Y\P$\4\X1791:Cases for evaluation of the current term\X\mathrel{+}\S$\6
\4\\{expr\_div}: \37\&{if} $\|l<\\{glue\_val}$ \1\&{then}\5
$\\{expr\_d}(\|t)$\6
\4\&{else} \&{begin} \37$\\{expr\_d}(\\{width}(\|t))$;\5
$\\{expr\_d}(\\{stretch}(\|t))$;\5
$\\{expr\_d}(\\{shrink}(\|t))$;\6
\&{end};\2\par
\fi

\M1797. The function $\\{quotient}(\|n,\|d)$ computes the rounded quotient
$q=\lfloor n/d+{1\over2}\rfloor$, when $n$ and $d$ are positive.

\Y\P$\4\X1793:Declare subprocedures for \\{scan\_expr}\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{quotient}(\|n,\39\|d:\\{integer})$: \37\\{integer};\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should the answer be negated?}\6
\|a: \37\\{integer};\C{the answer}\2\6
\&{begin} \37\&{if} $\|d=0$ \1\&{then}\5
$\\{num\_error}(\|a)$\6
\4\&{else} \&{begin} \37\&{if} $\|d>0$ \1\&{then}\5
$\\{negative}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|d)$;\5
$\\{negative}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|n)$;\5
$\\{negative}\K\R\\{negative}$;\6
\&{end};\2\6
$\|a\K\|n\mathbin{\&{div}}\|d$;\5
$\|n\K\|n-\|a\ast\|d$;\5
$\|d\K\|n-\|d$;\C{avoid certain compiler optimizations!}\6
\&{if} $\|d+\|n\G0$ \1\&{then}\5
$\\{incr}(\|a)$;\2\6
\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\|a)$;\2\6
\&{end};\2\6
$\\{quotient}\K\|a$;\6
\&{end};\par
\fi

\M1798. Here the term \|t is multiplied by the quotient $n/f$.

\Y\P\D \37$\\{expr\_s}(\#)\S\#\K\\{fract}(\#,\39\|n,\39\|f,\39\\{max\_dimen})$%
\par
\Y\P$\4\X1791:Cases for evaluation of the current term\X\mathrel{+}\S$\6
\4\\{expr\_scale}: \37\&{if} $\|l=\\{int\_val}$ \1\&{then}\5
$\|t\K\\{fract}(\|t,\39\|n,\39\|f,\39\\{infinity})$\6
\4\&{else} \&{if} $\|l=\\{dimen\_val}$ \1\&{then}\5
$\\{expr\_s}(\|t)$\6
\4\&{else} \&{begin} \37$\\{expr\_s}(\\{width}(\|t))$;\5
$\\{expr\_s}(\\{stretch}(\|t))$;\5
$\\{expr\_s}(\\{shrink}(\|t))$;\6
\&{end};\2\2\par
\fi

\M1799. Finally, the function $\\{fract}(\|x,\|n,\|d,\\{max\_answer})$ computes
the integer
$q=\lfloor xn/d+{1\over2}\rfloor$, when $x$, $n$, and $d$ are positive
and the result does not exceed \\{max\_answer}.  We can't use floating
point arithmetic since the routine must produce identical results in all
cases; and it would be too dangerous to multiply by~\|n and then divide
by~\|d, in separate operations, since overflow might well occur.  Hence
this subroutine simulates double precision arithmetic, somewhat
analogous to \MF's \\{make\_fraction} and \\{take\_fraction} routines.

\Y\P\D \37$\\{too\_big}=88$\C{go here when the result is too big}\par
\Y\P$\4\X1793:Declare subprocedures for \\{scan\_expr}\X\mathrel{+}\S$\6
\4\&{function}\1\  \37$\\{fract}(\|x,\39\|n,\39\|d,\39\\{max\_answer}:%
\\{integer})$: \37\\{integer};\6
\4\&{label} \37$\\{found},\39\\{found1},\39\\{too\_big},\39\\{done}$;\6
\4\&{var} \37\\{negative}: \37\\{boolean};\C{should the answer be negated?}\6
\|a: \37\\{integer};\C{the answer}\6
\|f: \37\\{integer};\C{a proper fraction}\6
\|h: \37\\{integer};\C{smallest integer such that $2\ast\|h\G\|d$}\6
\|r: \37\\{integer};\C{intermediate remainder}\6
\|t: \37\\{integer};\C{temp variable}\2\6
\&{begin} \37\&{if} $\|d=0$ \1\&{then}\5
\&{goto} \37\\{too\_big};\2\6
$\|a\K0$;\6
\&{if} $\|d>0$ \1\&{then}\5
$\\{negative}\K\\{false}$\6
\4\&{else} \&{begin} \37$\\{negate}(\|d)$;\5
$\\{negative}\K\\{true}$;\6
\&{end};\2\6
\&{if} $\|x<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|x)$;\5
$\\{negative}\K\R\\{negative}$;\6
\&{end}\6
\4\&{else} \&{if} $\|x=0$ \1\&{then}\5
\&{goto} \37\\{done};\2\2\6
\&{if} $\|n<0$ \1\&{then}\6
\&{begin} \37$\\{negate}(\|n)$;\5
$\\{negative}\K\R\\{negative}$;\6
\&{end};\2\6
$\|t\K\|n\mathbin{\&{div}}\|d$;\6
\&{if} $\|t>\\{max\_answer}\mathbin{\&{div}}\|x$ \1\&{then}\5
\&{goto} \37\\{too\_big};\2\6
$\|a\K\|t\ast\|x$;\5
$\|n\K\|n-\|t\ast\|d$;\6
\&{if} $\|n=0$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
$\|t\K\|x\mathbin{\&{div}}\|d$;\6
\&{if} $\|t>(\\{max\_answer}-\|a)\mathbin{\&{div}}\|n$ \1\&{then}\5
\&{goto} \37\\{too\_big};\2\6
$\|a\K\|a+\|t\ast\|n$;\5
$\|x\K\|x-\|t\ast\|d$;\6
\&{if} $\|x=0$ \1\&{then}\5
\&{goto} \37\\{found};\2\6
\&{if} $\|x<\|n$ \1\&{then}\6
\&{begin} \37$\|t\K\|x$;\5
$\|x\K\|n$;\5
$\|n\K\|t$;\6
\&{end};\C{now $0<\|n\L\|x<\|d$}\2\6
\X1800:Compute \(f)$f=\lfloor xn/d+{1\over2}\rfloor$\X\6
\&{if} $\|f>(\\{max\_answer}-\|a)$ \1\&{then}\5
\&{goto} \37\\{too\_big};\2\6
$\|a\K\|a+\|f$;\6
\4\\{found}: \37\&{if} $\\{negative}$ \1\&{then}\5
$\\{negate}(\|a)$;\2\6
\&{goto} \37\\{done};\6
\4\\{too\_big}: \37$\\{num\_error}(\|a)$;\6
\4\\{done}: \37$\\{fract}\K\|a$;\6
\&{end};\par
\fi

\M1800. The loop here preserves the following invariant relations
between \|f, \|x, \|n, and~\|r:
(i)~$f+\lfloor(xn+(r+d))/d\rfloor=\lfloor x_0n_0/d+{1\over2}\rfloor$;
(ii)~$-\|d\L\|r<0<\|n\L\|x<\|d$, where $x_0$, $n_0$ are the original values
of~$x$
and $n$.

Notice that the computation specifies $(\|x-\|d)+\|x$ instead of $(\|x+\|x)-%
\|d$,
because the latter could overflow.

\Y\P$\4\X1800:Compute \(f)$f=\lfloor xn/d+{1\over2}\rfloor$\X\S$\6
$\|f\K0$;\5
$\|r\K(\|d\mathbin{\&{div}}2)-\|d$;\5
$\|h\K-\|r$;\6
\~ \1\&{loop}\ \&{begin} \37\&{if} $\\{odd}(\|n)$ \1\&{then}\6
\&{begin} \37$\|r\K\|r+\|x$;\6
\&{if} $\|r\G0$ \1\&{then}\6
\&{begin} \37$\|r\K\|r-\|d$;\5
$\\{incr}(\|f)$;\6
\&{end};\2\6
\&{end};\2\6
$\|n\K\|n\mathbin{\&{div}}2$;\6
\&{if} $\|n=0$ \1\&{then}\5
\&{goto} \37\\{found1};\2\6
\&{if} $\|x<\|h$ \1\&{then}\5
$\|x\K\|x+\|x$\6
\4\&{else} \&{begin} \37$\|t\K\|x-\|d$;\5
$\|x\K\|t+\|x$;\5
$\|f\K\|f+\|n$;\6
\&{if} $\|x<\|n$ \1\&{then}\6
\&{begin} \37\&{if} $\|x=0$ \1\&{then}\5
\&{goto} \37\\{found1};\2\6
$\|t\K\|x$;\5
$\|x\K\|n$;\5
$\|n\K\|t$;\6
\&{end};\2\6
\&{end};\2\6
\&{end};\2\6
\4\\{found1}: \37\par
\U1799.\fi

\M1801. The \.{\\gluestretch}, \.{\\glueshrink}, \.{\\gluestretchorder}, and
\.{\\glueshrinkorder} commands return the stretch and shrink components
and their orders of ``infinity'' of a glue specification.

\Y\P\D \37$\\{glue\_stretch\_order\_code}=\\{eTeX\_int}+6$\C{code for \.{%
\\gluestretchorder}}\par
\P\D \37$\\{glue\_shrink\_order\_code}=\\{eTeX\_int}+7$\C{code for \.{%
\\glueshrinkorder}}\par
\P\D \37$\\{glue\_stretch\_code}=\\{eTeX\_dim}+7$\C{code for \.{\\gluestretch}}%
\par
\P\D \37$\\{glue\_shrink\_code}=\\{eTeX\_dim}+8$\C{code for \.{\\glueshrink}}%
\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"gluestretchorder"},\39\\{last\_item},\39\\{glue\_stretch%
\_order\_code})$;\5
$\\{primitive}(\.{"glueshrinkorder"},\39\\{last\_item},\39\\{glue\_shrink%
\_order\_code})$;\5
$\\{primitive}(\.{"gluestretch"},\39\\{last\_item},\39\\{glue\_stretch%
\_code})$;\5
$\\{primitive}(\.{"glueshrink"},\39\\{last\_item},\39\\{glue\_shrink\_code})$;%
\par
\fi

\M1802. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{glue\_stretch\_order\_code}: \37$\\{print\_esc}(\.{"gluestretchorder"})$;\6
\4\\{glue\_shrink\_order\_code}: \37$\\{print\_esc}(\.{"glueshrinkorder"})$;\6
\4\\{glue\_stretch\_code}: \37$\\{print\_esc}(\.{"gluestretch"})$;\6
\4\\{glue\_shrink\_code}: \37$\\{print\_esc}(\.{"glueshrink"})$;\par
\fi

\M1803. \P$\X1651:Cases for fetching an integer value\X\mathrel{+}\S$\6
\4$\\{glue\_stretch\_order\_code},\39\\{glue\_shrink\_order\_code}$: \37%
\&{begin} \37\\{scan\_normal\_glue};\5
$\|q\K\\{cur\_val}$;\6
\&{if} $\|m=\\{glue\_stretch\_order\_code}$ \1\&{then}\5
$\\{cur\_val}\K\\{stretch\_order}(\|q)$\6
\4\&{else} $\\{cur\_val}\K\\{shrink\_order}(\|q)$;\2\6
$\\{delete\_glue\_ref}(\|q)$;\6
\&{end};\par
\fi

\M1804. \P$\X1671:Cases for fetching a dimension value\X\mathrel{+}\S$\6
\4$\\{glue\_stretch\_code},\39\\{glue\_shrink\_code}$: \37\&{begin} \37\\{scan%
\_normal\_glue};\5
$\|q\K\\{cur\_val}$;\6
\&{if} $\|m=\\{glue\_stretch\_code}$ \1\&{then}\5
$\\{cur\_val}\K\\{stretch}(\|q)$\6
\4\&{else} $\\{cur\_val}\K\\{shrink}(\|q)$;\2\6
$\\{delete\_glue\_ref}(\|q)$;\6
\&{end};\par
\fi

\M1805. The \.{\\mutoglue} and \.{\\gluetomu} commands convert ``math'' glue
into normal glue and vice versa; they allow to manipulate math glue with
\.{\\gluestretch} etc.

\Y\P\D \37$\\{mu\_to\_glue\_code}=\\{eTeX\_glue}$\C{code for \.{\\mutoglue}}\par
\P\D \37$\\{glue\_to\_mu\_code}=\\{eTeX\_mu}$\C{code for \.{\\gluetomu}}\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"mutoglue"},\39\\{last\_item},\39\\{mu\_to\_glue\_code})$;\5
$\\{primitive}(\.{"gluetomu"},\39\\{last\_item},\39\\{glue\_to\_mu\_code})$;\par
\fi

\M1806. \P$\X1650:Cases of \\{last\_item} for \\{print\_cmd\_chr}\X\mathrel{+}%
\S$\6
\4\\{mu\_to\_glue\_code}: \37$\\{print\_esc}(\.{"mutoglue"})$;\6
\4\\{glue\_to\_mu\_code}: \37$\\{print\_esc}(\.{"gluetomu"})$;\par
\fi

\M1807. \P$\X1807:Cases for fetching a glue value\X\S$\6
\4\\{mu\_to\_glue\_code}: \37\\{scan\_mu\_glue};\par
\U1780.\fi

\M1808. \P$\X1808:Cases for fetching a mu value\X\S$\6
\4\\{glue\_to\_mu\_code}: \37\\{scan\_normal\_glue};\par
\U1780.\fi

\M1809. \eTeX\ (in extended mode) supports 32768 (i.e., $2^{15}$) count,
dimen, skip, muskip, box, and token registers.  As in \TeX\ the first
256 registers of each kind are realized as arrays in the table of
equivalents; the additional registers are realized as tree structures
built from variable-size nodes with individual registers existing only
when needed.  Default values are used for nonexistent registers:  zero
for count and dimen values, \\{zero\_glue} for glue (skip and muskip)
values, void for boxes, and \\{null} for token lists (and current marks
discussed below).

Similarly there are 32768 mark classes; the command \.{\\marks}\|n
creates a mark node for a given mark class $0\L\|n\L32767$ (where
\.{\\marks0} is synonymous to \.{\\mark}).  The page builder (actually
the \\{fire\_up} routine) and the \\{vsplit} routine maintain the current
values of \\{top\_mark}, \\{first\_mark}, \\{bot\_mark}, \\{split\_first%
\_mark}, and
\\{split\_bot\_mark} for each mark class.  They are accessed as
\.{\\topmarks}\|n etc., and \.{\\topmarks0} is again synonymous to
\.{\\topmark}.  As in \TeX\ the five current marks for mark class zero
are realized as \\{cur\_mark} array.  The additional current marks are
again realized as tree structure with individual mark classes existing
only when needed.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"marks"},\39\\{mark},\39\\{marks\_code})$;\5
$\\{primitive}(\.{"topmarks"},\39\\{top\_bot\_mark},\39\\{top\_mark\_code}+%
\\{marks\_code})$;\5
$\\{primitive}(\.{"firstmarks"},\39\\{top\_bot\_mark},\39\\{first\_mark\_code}+%
\\{marks\_code})$;\5
$\\{primitive}(\.{"botmarks"},\39\\{top\_bot\_mark},\39\\{bot\_mark\_code}+%
\\{marks\_code})$;\5
$\\{primitive}(\.{"splitfirstmarks"},\39\\{top\_bot\_mark},\39\\{split\_first%
\_mark\_code}+\\{marks\_code})$;\5
$\\{primitive}(\.{"splitbotmarks"},\39\\{top\_bot\_mark},\39\\{split\_bot\_mark%
\_code}+\\{marks\_code})$;\par
\fi

\M1810. The \\{scan\_register\_num} procedure scans a register number that must
not exceed 255 in compatibility mode resp.\ 32767 in extended mode.

\Y\P$\4\X1752:Declare \eTeX\ procedures for expanding\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_register\_num};\5
\\{forward};\5
\hbox{\2}\par
\fi

\M1811. \P$\X459:Declare procedures that scan restricted classes of integers\X%
\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{scan\_register\_num};\2\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{cur\_val}<0)\V(\\{cur\_val}>\\{max\_reg\_num})$ \1\&{then}\6
\&{begin} \37$\\{print\_err}(\.{"Bad\ register\ code"})$;\5
$\\{help2}(\\{max\_reg\_help\_line})(\.{"I\ changed\ this\ one\ to\ zero."})$;\5
$\\{int\_error}(\\{cur\_val})$;\5
$\\{cur\_val}\K0$;\6
\&{end};\2\6
\&{end};\par
\fi

\M1812. \P$\X1812:Initialize variables for \eTeX\ compatibility mode\X\S$\6
$\\{max\_reg\_num}\K255$;\5
$\\{max\_reg\_help\_line}\K\.{"A\ register\ number\ must\ be\ between\ 0\ and\
255."}$;\par
\Us1653\ET1655.\fi

\M1813. \P$\X1813:Initialize variables for \eTeX\ extended mode\X\S$\6
$\\{max\_reg\_num}\K32767$;\5
$\\{max\_reg\_help\_line}\K\.{"A\ register\ number\ must\ be\ between\ 0\ and\
32767."}$;\par
\Us1648\ET1655.\fi

\M1814. \P$\X13:Global variables\X\mathrel{+}\S$\6
\4\\{max\_reg\_num}: \37\\{halfword};\C{largest allowed register number}\6
\4\\{max\_reg\_help\_line}: \37\\{str\_number};\C{first line of help message}%
\par
\fi

\M1815. There are seven almost identical doubly linked trees, one for the
sparse array of the up to 32512 additional registers of each kind and
one for the sparse array of the up to 32767 additional mark classes.
The root of each such tree, if it exists, is an index node containing 16
pointers to subtrees for 4096 consecutive array elements.  Similar index
nodes are the starting points for all nonempty subtrees for 4096, 256,
and 16 consecutive array elements.  These four levels of index nodes are
followed by a fifth level with nodes for the individual array elements.

Each index node is nine words long.  The pointers to the 16 possible
subtrees or are kept in the \\{info} and \\{link} fields of the last eight
words.  (It would be both elegant and efficient to declare them as
array, unfortunately \PASCAL\ doesn't allow this.)

The fields in the first word of each index node and in the nodes for the
array elements are closely related.  The \\{link} field points to the next
lower index node and the \\{sa\_index} field contains four bits (one
hexadecimal digit) of the register number or mark class.  For the lowest
index node the \\{link} field is \\{null} and the \\{sa\_index} field indicates
the type of quantity (\\{int\_val}, \\{dimen\_val}, \\{glue\_val}, \\{mu\_val},
\\{box\_val}, \\{tok\_val}, or \\{mark\_val}).  The \\{sa\_used} field in the
index
nodes counts how many of the 16 pointers are non-null.

The \\{sa\_index} field in the nodes for array elements contains the four
bits plus 16 times the type.  Therefore such a node represents a count
or dimen register if and only if $\\{sa\_index}<\\{dimen\_val\_limit}$; it
represents a skip or muskip register if and only if
$\\{dimen\_val\_limit}\L\\{sa\_index}<\\{mu\_val\_limit}$; it represents a box
register
if and only if $\\{mu\_val\_limit}\L\\{sa\_index}<\\{box\_val\_limit}$; it
represents a
token list register if and only if
$\\{box\_val\_limit}\L\\{sa\_index}<\\{tok\_val\_limit}$; finally it represents
a mark
class if and only if $\\{tok\_val\_limit}\L\\{sa\_index}$.

The \\{new\_index} procedure creates an index node (returned in \\{cur\_ptr})
having given contents of the \\{sa\_index} and \\{link} fields.

\Y\P\D \37$\\{box\_val}\S4$\C{the additional box registers}\par
\P\D \37$\\{mark\_val}=6$\C{the additional mark classes}\Y\par
\P\D \37$\\{dimen\_val\_limit}=\H{20}$\C{$2^4\cdot(\\{dimen\_val}+1)$}\par
\P\D \37$\\{mu\_val\_limit}=\H{40}$\C{$2^4\cdot(\\{mu\_val}+1)$}\par
\P\D \37$\\{box\_val\_limit}=\H{50}$\C{$2^4\cdot(\\{box\_val}+1)$}\par
\P\D \37$\\{tok\_val\_limit}=\H{60}$\C{$2^4\cdot(\\{tok\_val}+1)$}\Y\par
\P\D \37$\\{index\_node\_size}=9$\C{size of an index node}\par
\P\D \37$\\{sa\_index}\S\\{type}$\C{a four-bit address or a type or both}\par
\P\D \37$\\{sa\_used}\S\\{subtype}$\C{count of non-null pointers}\par
\Y\P$\4\X1752:Declare \eTeX\ procedures for expanding\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{new\_index}(\|i:\\{quarterword};\,\35\|q:%
\\{pointer})$;\6
\4\&{var} \37\|k: \37\\{small\_number};\C{loop index}\2\6
\&{begin} \37$\\{cur\_ptr}\K\\{get\_node}(\\{index\_node\_size})$;\5
$\\{sa\_index}(\\{cur\_ptr})\K\|i$;\5
$\\{sa\_used}(\\{cur\_ptr})\K0$;\5
$\\{link}(\\{cur\_ptr})\K\|q$;\6
\&{for} $\|k\K1\mathrel{\&{to}}\\{index\_node\_size}-1$ \1\&{do}\C{clear all 16
pointers}\6
$\\{mem}[\\{cur\_ptr}+\|k]\K\\{sa\_null}$;\2\6
\&{end};\par
\fi

\M1816. The roots of the seven trees for the additional registers and mark
classes are kept in the \\{sa\_root} array.  The first six locations must
be dumped and undumped; the last one is also known as \\{sa\_mark}.

\Y\P\D \37$\\{sa\_mark}\S\\{sa\_root}[\\{mark\_val}]$\C{root for mark classes}%
\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{sa\_root}: \37\&{array} $[\\{int\_val}\to\\{mark\_val}]$ \1\&{of}\5
\\{pointer};\C{roots of sparse arrays}\2\6
\4\\{cur\_ptr}: \37\\{pointer};\C{value returned by \\{new\_index} and \\{find%
\_sa\_element}}\6
\4\\{sa\_null}: \37\\{memory\_word};\C{two \\{null} pointers}\par
\fi

\M1817. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{sa\_mark}\K\\{null}$;\5
$\\{sa\_null}.\\{hh}.\\{lh}\K\\{null}$;\5
$\\{sa\_null}.\\{hh}.\\{rh}\K\\{null}$;\par
\fi

\M1818. \P$\X182:Initialize table entries (done by \.{INITEX} only)\X%
\mathrel{+}\S$\6
\&{for} $\|i\K\\{int\_val}\mathrel{\&{to}}\\{tok\_val}$ \1\&{do}\5
$\\{sa\_root}[\|i]\K\\{null}$;\2\par
\fi

\M1819. Given a type \|t and a sixteen-bit number \|n, the \\{find\_sa%
\_element}
procedure returns (in \\{cur\_ptr}) a pointer to the node for the
corresponding array element, or \\{null} when no such element exists.  The
third parameter \|w is set \\{true} if the element must exist, e.g.,
because it is about to be modified.  The procedure has two main
branches:  one follows the existing tree structure, the other (only used
when \|w is \\{true}) creates the missing nodes.

We use macros to extract the four-bit pieces from a sixteen-bit register
number or mark class and to fetch or store one of the 16 pointers from
an index node.

\Y\P\D \37$\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}(\#)\S$\C{some
tree element is missing}\6
\&{begin} \37\&{if} $\\{cur\_ptr}=\\{null}$ \1\&{then}\6
\&{if} $\|w$ \1\&{then}\5
\&{goto} \37$\#$\ \&{else} \&{return};\2\2\6
\&{end}\Y\par
\P\D \37$\\{hex\_dig1}(\#)\S\#\mathbin{\&{div}}4096$\C{the fourth lowest
hexadecimal digit}\par
\P\D \37$\\{hex\_dig2}(\#)\S(\#\mathbin{\&{div}}256)\mathbin{\&{mod}}16$\C{the
third lowest hexadecimal digit}\par
\P\D \37$\\{hex\_dig3}(\#)\S(\#\mathbin{\&{div}}16)\mathbin{\&{mod}}16$\C{the
second lowest hexadecimal digit}\par
\P\D \37$\\{hex\_dig4}(\#)\S\#\mathbin{\&{mod}}16$\C{the lowest hexadecimal
digit}\Y\par
\P\D \37$\\{get\_sa\_ptr}\S$\1\6
\&{if} $\\{odd}(\|i)$ \1\&{then}\5
$\\{cur\_ptr}\K\\{link}(\|q+(\|i\mathbin{\&{div}}2)+1)$\6
\4\&{else} $\\{cur\_ptr}\K\\{info}(\|q+(\|i\mathbin{\&{div}}2)+1)$\C{set \\{cur%
\_ptr} to the pointer indexed by \|i from index node \|q}\2\2\par
\P\D \37$\\{put\_sa\_ptr}(\#)\S$\1\6
\&{if} $\\{odd}(\|i)$ \1\&{then}\5
$\\{link}(\|q+(\|i\mathbin{\&{div}}2)+1)\K\#$\6
\4\&{else} $\\{info}(\|q+(\|i\mathbin{\&{div}}2)+1)\K\#$\C{store the pointer
indexed by \|i in index node \|q}\2\2\par
\P\D \37$\\{add\_sa\_ptr}\S$\1\6
\&{begin} \37$\\{put\_sa\_ptr}(\\{cur\_ptr})$;\5
$\\{incr}(\\{sa\_used}(\|q))$;\6
\&{end}\C{add \\{cur\_ptr} as the pointer indexed by \|i in index node \|q}\2%
\par
\P\D \37$\\{delete\_sa\_ptr}\S$\1\6
\&{begin} \37$\\{put\_sa\_ptr}(\\{null})$;\5
$\\{decr}(\\{sa\_used}(\|q))$;\6
\&{end}\C{delete the pointer indexed by \|i in index node \|q}\2\par
\Y\P$\4\X1752:Declare \eTeX\ procedures for expanding\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{find\_sa\_element}(\|t:\\{small\_number};\,\35\|n:%
\\{halfword};\,\35\|w:\\{boolean})$;\C{sets \\{cur\_val} to sparse array
element location or \\{null}}\6
\4\&{label} \37$\\{not\_found},\39\\{not\_found1},\39\\{not\_found2},\39\\{not%
\_found3},\39\\{not\_found4},\39\\{exit}$;\6
\4\&{var} \37\|q: \37\\{pointer};\C{for list manipulations}\6
\|i: \37\\{small\_number};\C{a four bit index}\2\6
\&{begin} \37$\\{cur\_ptr}\K\\{sa\_root}[\|t]$;\5
$\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}(\\{not\_found})$;\6
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig1}(\|n)$;\5
\\{get\_sa\_ptr};\5
$\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}(\\{not\_found1})$;\6
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig2}(\|n)$;\5
\\{get\_sa\_ptr};\5
$\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}(\\{not\_found2})$;\6
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig3}(\|n)$;\5
\\{get\_sa\_ptr};\5
$\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}(\\{not\_found3})$;\6
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig4}(\|n)$;\5
\\{get\_sa\_ptr};\6
\&{if} $(\\{cur\_ptr}=\\{null})\W\|w$ \1\&{then}\5
\&{goto} \37\\{not\_found4};\2\6
\&{return};\6
\4\\{not\_found}: \37$\\{new\_index}(\|t,\39\\{null})$;\C{create first level
index node}\6
$\\{sa\_root}[\|t]\K\\{cur\_ptr}$;\5
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig1}(\|n)$;\6
\4\\{not\_found1}: \37$\\{new\_index}(\|i,\39\|q)$;\C{create second level index
node}\6
\\{add\_sa\_ptr};\5
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig2}(\|n)$;\6
\4\\{not\_found2}: \37$\\{new\_index}(\|i,\39\|q)$;\C{create third level index
node}\6
\\{add\_sa\_ptr};\5
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig3}(\|n)$;\6
\4\\{not\_found3}: \37$\\{new\_index}(\|i,\39\|q)$;\C{create fourth level index
node}\6
\\{add\_sa\_ptr};\5
$\|q\K\\{cur\_ptr}$;\5
$\|i\K\\{hex\_dig4}(\|n)$;\6
\4\\{not\_found4}: \37\X1820:Create a new array element of type \|t with index %
\|i\X;\6
$\\{link}(\\{cur\_ptr})\K\|q$;\5
\\{add\_sa\_ptr};\6
\4\\{exit}: \37\&{end};\par
\fi

\M1820. The array elements for registers are subject to grouping and have an
\\{sa\_lev} field (quite analogous to \\{eq\_level}) instead of \\{sa\_used}.
Since saved values as well as shorthand definitions (created by e.g.,
\.{\\countdef}) refer to the location of the respective array element,
we need a reference count that is kept in the \\{sa\_ref} field.  An array
element can be deleted (together with all references to it) when its
\\{sa\_ref} value is \\{null} and its value is the default value.

Skip, muskip, box, and token registers use two word nodes, their values
are stored in the \\{sa\_ptr} field.
Count and dimen registers use three word nodes, their
values are stored in the \\{sa\_int} resp.\ \\{sa\_dim} field in the third
word; the \\{sa\_ptr} field is used under the name \\{sa\_num} to store
the register number.  Mark classes use four word nodes.  The last three
words contain the five types of current marks

\Y\P\D \37$\\{sa\_lev}\S\\{sa\_used}$\C{grouping level for the current value}%
\par
\P\D \37$\\{pointer\_node\_size}=2$\C{size of an element with a pointer value}%
\par
\P\D \37$\\{sa\_type}(\#)\S(\\{sa\_index}(\#)\mathbin{\&{div}}16)$\C{type part
of combined type/index}\par
\P\D \37$\\{sa\_ref}(\#)\S\\{info}(\#+1)$\C{reference count of a sparse array
element}\par
\P\D \37$\\{sa\_ptr}(\#)\S\\{link}(\#+1)$\C{a pointer value}\Y\par
\P\D \37$\\{word\_node\_size}=3$\C{size of an element with a word value}\par
\P\D \37$\\{sa\_num}\S\\{sa\_ptr}$\C{the register number}\par
\P\D \37$\\{sa\_int}(\#)\S\\{mem}[\#+2].\\{int}$\C{an integer}\par
\P\D \37$\\{sa\_dim}(\#)\S\\{mem}[\#+2].\\{sc}$\C{a dimension (a somewhat
esoteric distinction)}\Y\par
\P\D \37$\\{mark\_class\_node\_size}=4$\C{size of an element for a mark class}%
\Y\par
\P\D \37$\\{fetch\_box}(\#)\S$\C{fetch $\\{box}(\\{cur\_val})$}\6
\&{if} $\\{cur\_val}<256$ \1\&{then}\5
$\#\K\\{box}(\\{cur\_val})$\6
\4\&{else} \&{begin} \37$\\{find\_sa\_element}(\\{box\_val},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}=\\{null}$ \1\&{then}\5
$\#\K\\{null}$\ \&{else} $\#\K\\{sa\_ptr}(\\{cur\_ptr})$;\2\6
\&{end}\2\par
\Y\P$\4\X1820:Create a new array element of type \|t with index \|i\X\S$\6
\&{if} $\|t=\\{mark\_val}$ \1\&{then}\C{a mark class}\6
\&{begin} \37$\\{cur\_ptr}\K\\{get\_node}(\\{mark\_class\_node\_size})$;\5
$\\{mem}[\\{cur\_ptr}+1]\K\\{sa\_null}$;\5
$\\{mem}[\\{cur\_ptr}+2]\K\\{sa\_null}$;\5
$\\{mem}[\\{cur\_ptr}+3]\K\\{sa\_null}$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\|t\L\\{dimen\_val}$ \1\&{then}\C{a count or
dimen register}\6
\&{begin} \37$\\{cur\_ptr}\K\\{get\_node}(\\{word\_node\_size})$;\5
$\\{sa\_int}(\\{cur\_ptr})\K0$;\5
$\\{sa\_num}(\\{cur\_ptr})\K\|n$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\\{cur\_ptr}\K\\{get\_node}(\\{pointer\_node\_size})$;%
\6
\&{if} $\|t\L\\{mu\_val}$ \1\&{then}\C{a skip or muskip register}\6
\&{begin} \37$\\{sa\_ptr}(\\{cur\_ptr})\K\\{zero\_glue}$;\5
$\\{add\_glue\_ref}(\\{zero\_glue})$;\6
\&{end}\6
\4\&{else} $\\{sa\_ptr}(\\{cur\_ptr})\K\\{null}$;\C{a box or token list
register}\2\6
\&{end};\2\6
$\\{sa\_ref}(\\{cur\_ptr})\K\\{null}$;\C{all registers have a reference count}\6
\&{end};\2\6
$\\{sa\_index}(\\{cur\_ptr})\K16\ast\|t+\|i$;\5
$\\{sa\_lev}(\\{cur\_ptr})\K\\{level\_one}$\par
\U1819.\fi

\M1821. The \\{delete\_sa\_ref} procedure is called when a pointer to an array
element representing a register is being removed; this means that the
reference count should be decreased by one.  If the reduced reference
count is \\{null} and the register has been (globally) assigned its
default value the array element should disappear, possibly together with
some index nodes.  This procedure will never be used for mark class
nodes.

\Y\P\D \37$\\{add\_sa\_ref}(\#)\S\\{incr}(\\{sa\_ref}(\#))$\C{increase
reference count}\Y\par
\P\D \37$\\{change\_box}(\#)\S$\C{change $\\{box}(\\{cur\_val})$, the \\{eq%
\_level} stays the same}\6
\&{if} $\\{cur\_val}<256$ \1\&{then}\5
$\\{box}(\\{cur\_val})\K\#$\ \&{else} $\\{set\_sa\_box}(\#)$\2\par
\P\D \37$\\{set\_sa\_box}(\#)\S$\1\6
\&{begin} \37$\\{find\_sa\_element}(\\{box\_val},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{sa\_ptr}(\\{cur\_ptr})\K\#$;\5
$\\{add\_sa\_ref}(\\{cur\_ptr})$;\5
$\\{delete\_sa\_ref}(\\{cur\_ptr})$;\6
\&{end};\2\6
\&{end}\2\par
\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{delete\_sa\_ref}(\|q:\\{pointer})$;\C{reduce
reference count}\6
\4\&{label} \37\\{exit};\6
\4\&{var} \37\|p: \37\\{pointer};\C{for list manipulations}\6
\|i: \37\\{small\_number};\C{a four bit index}\6
\|s: \37\\{small\_number};\C{size of a node}\2\6
\&{begin} \37$\\{decr}(\\{sa\_ref}(\|q))$;\6
\&{if} $\\{sa\_ref}(\|q)\I\\{null}$ \1\&{then}\5
\&{return};\2\6
\&{if} $\\{sa\_index}(\|q)<\\{dimen\_val\_limit}$ \1\&{then}\6
\&{if} $\\{sa\_int}(\|q)=0$ \1\&{then}\5
$\|s\K\\{word\_node\_size}$\6
\4\&{else} \&{return}\2\6
\4\&{else} \&{begin} \37\&{if} $\\{sa\_index}(\|q)<\\{mu\_val\_limit}$ \1%
\&{then}\6
\&{if} $\\{sa\_ptr}(\|q)=\\{zero\_glue}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{zero\_glue})$\6
\4\&{else} \&{return}\2\6
\4\&{else} \&{if} $\\{sa\_ptr}(\|q)\I\\{null}$ \1\&{then}\5
\&{return};\2\2\6
$\|s\K\\{pointer\_node\_size}$;\6
\&{end};\2\6
\1\&{repeat} \37$\|i\K\\{hex\_dig4}(\\{sa\_index}(\|q))$;\5
$\|p\K\|q$;\5
$\|q\K\\{link}(\|p)$;\5
$\\{free\_node}(\|p,\39\|s)$;\6
\&{if} $\|q=\\{null}$ \1\&{then}\C{the whole tree has been freed}\6
\&{begin} \37$\\{sa\_root}[\|i]\K\\{null}$;\5
\&{return};\6
\&{end};\2\6
\\{delete\_sa\_ptr};\5
$\|s\K\\{index\_node\_size}$;\C{node \|q is an index node}\6
\4\&{until}\5
$\\{sa\_used}(\|q)>0$;\2\6
\4\\{exit}: \37\&{end};\par
\fi

\M1822. The \\{print\_sa\_num} procedure prints the register number
corresponding
to an array element.

\Y\P$\4\X57:Basic printing procedures\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{print\_sa\_num}(\|q:\\{pointer})$;\C{print register
number}\6
\4\&{var} \37\|n: \37\\{halfword};\C{the register number}\2\6
\&{begin} \37\&{if} $\\{sa\_index}(\|q)<\\{dimen\_val\_limit}$ \1\&{then}\5
$\|n\K\\{sa\_num}(\|q)$\C{the easy case}\6
\4\&{else} \&{begin} \37$\|n\K\\{hex\_dig4}(\\{sa\_index}(\|q))$;\5
$\|q\K\\{link}(\|q)$;\5
$\|n\K\|n+16\ast\\{sa\_index}(\|q)$;\5
$\|q\K\\{link}(\|q)$;\5
$\|n\K\|n+256\ast(\\{sa\_index}(\|q)+16\ast\\{sa\_index}(\\{link}(\|q)))$;\6
\&{end};\2\6
$\\{print\_int}(\|n)$;\6
\&{end};\par
\fi

\M1823. Here is a procedure that displays the contents of an array element
symbolically.  It is used under similar circumstances as is
\\{restore\_trace} (together with \\{show\_eqtb}) for the quantities kept in
the \\{eqtb} array.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\&{stat} \37\&{procedure}\1\  \37$\\{show\_sa}(\|p:\\{pointer};\,\35\|s:\\{str%
\_number})$;\6
\4\&{var} \37\|t: \37\\{small\_number};\C{the type of element}\2\6
\&{begin} \37\\{begin\_diagnostic};\5
$\\{print\_char}(\.{"\{"})$;\5
$\\{print}(\|s)$;\5
$\\{print\_char}(\.{"\ "})$;\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{print\_char}(\.{"?"})$\C{this can't happen}\6
\4\&{else} \&{begin} \37$\|t\K\\{sa\_type}(\|p)$;\6
\&{if} $\|t<\\{box\_val}$ \1\&{then}\5
$\\{print\_cmd\_chr}(\\{register},\39\|p)$\6
\4\&{else} \&{if} $\|t=\\{box\_val}$ \1\&{then}\6
\&{begin} \37$\\{print\_esc}(\.{"box"})$;\5
$\\{print\_sa\_num}(\|p)$;\6
\&{end}\6
\4\&{else} \&{if} $\|t=\\{tok\_val}$ \1\&{then}\5
$\\{print\_cmd\_chr}(\\{toks\_register},\39\|p)$\6
\4\&{else} $\\{print\_char}(\.{"?"})$;\C{this can't happen either}\2\2\2\6
$\\{print\_char}(\.{"="})$;\6
\&{if} $\|t=\\{int\_val}$ \1\&{then}\5
$\\{print\_int}(\\{sa\_int}(\|p))$\6
\4\&{else} \&{if} $\|t=\\{dimen\_val}$ \1\&{then}\6
\&{begin} \37$\\{print\_scaled}(\\{sa\_dim}(\|p))$;\5
$\\{print}(\.{"pt"})$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|p\K\\{sa\_ptr}(\|p)$;\6
\&{if} $\|t=\\{glue\_val}$ \1\&{then}\5
$\\{print\_spec}(\|p,\39\.{"pt"})$\6
\4\&{else} \&{if} $\|t=\\{mu\_val}$ \1\&{then}\5
$\\{print\_spec}(\|p,\39\.{"mu"})$\6
\4\&{else} \&{if} $\|t=\\{box\_val}$ \1\&{then}\6
\&{if} $\|p=\\{null}$ \1\&{then}\5
$\\{print}(\.{"void"})$\6
\4\&{else} \&{begin} \37$\\{depth\_threshold}\K0$;\5
$\\{breadth\_max}\K1$;\5
$\\{show\_node\_list}(\|p)$;\6
\&{end}\2\6
\4\&{else} \&{if} $\|t=\\{tok\_val}$ \1\&{then}\6
\&{begin} \37\&{if} $\|p\I\\{null}$ \1\&{then}\5
$\\{show\_token\_list}(\\{link}(\|p),\39\\{null},\3932)$;\2\6
\&{end}\6
\4\&{else} $\\{print\_char}(\.{"?"})$;\C{this can't happen either}\2\2\2\2\6
\&{end};\2\2\6
\&{end};\2\6
$\\{print\_char}(\.{"\}"})$;\5
$\\{end\_diagnostic}(\\{false})$;\6
\&{end};\6
\&{tats}\par
\fi

\M1824. Here we compute the pointer to the current mark of type \|t and mark
class \\{cur\_val}.

\Y\P$\4\X1824:Compute the mark pointer for mark type \|t and class \\{cur\_val}%
\X\S$\6
\&{begin} \37$\\{find\_sa\_element}(\\{mark\_val},\39\\{cur\_val},\39%
\\{false})$;\6
\&{if} $\\{cur\_ptr}\I\\{null}$ \1\&{then}\6
\&{if} $\\{odd}(\|t)$ \1\&{then}\5
$\\{cur\_ptr}\K\\{link}(\\{cur\_ptr}+(\|t\mathbin{\&{div}}2)+1)$\6
\4\&{else} $\\{cur\_ptr}\K\\{info}(\\{cur\_ptr}+(\|t\mathbin{\&{div}}2)+1)$;\2%
\2\6
\&{end}\par
\U412.\fi

\M1825. The current marks for all mark classes are maintained by the \\{vsplit}
and \\{fire\_up} routines and are finally destroyed (for \.{INITEX} only)
by the \\{final\_cleanup} routine.  Apart from updating the current marks
when mark nodes are encountered, these routines perform certain actions
on all existing mark classes.  The recursive \\{do\_marks} procedure walks
through the whole tree or a subtree of existing mark class nodes and
preforms certain actions indicted by its first parameter \|a, the action
code.  The second parameter \|l indicates the level of recursion (at
most four); the third parameter points to a nonempty tree or subtree.
The result is \\{true} if the complete tree or subtree has been deleted.

\Y\P\D \37$\\{vsplit\_init}\S0$\C{action code for \\{vsplit} initialization}\par
\P\D \37$\\{fire\_up\_init}\S1$\C{action code for \\{fire\_up} initialization}%
\par
\P\D \37$\\{fire\_up\_done}\S2$\C{action code for \\{fire\_up} completion}\par
\P\D \37$\\{destroy\_marks}\S3$\C{action code for \\{final\_cleanup}}\Y\par
\P\D \37$\\{sa\_top\_mark}(\#)\S\\{info}(\#+1)$\C{\.{\\topmarks}\|n}\par
\P\D \37$\\{sa\_first\_mark}(\#)\S\\{link}(\#+1)$\C{\.{\\firstmarks}\|n}\par
\P\D \37$\\{sa\_bot\_mark}(\#)\S\\{info}(\#+2)$\C{\.{\\botmarks}\|n}\par
\P\D \37$\\{sa\_split\_first\_mark}(\#)\S\\{link}(\#+2)$\C{\.{%
\\splitfirstmarks}\|n}\par
\P\D \37$\\{sa\_split\_bot\_mark}(\#)\S\\{info}(\#+3)$\C{\.{\\splitbotmarks}%
\|n}\par
\Y\P$\4\X1825:Declare the function called \\{do\_marks}\X\S$\6
\4\&{function}\1\  \37$\\{do\_marks}(\|a,\39\|l:\\{small\_number};\,\35\|q:%
\\{pointer})$: \37\\{boolean};\6
\4\&{var} \37\|i: \37\\{small\_number};\C{a four bit index}\2\6
\&{begin} \37\&{if} $\|l<4$ \1\&{then}\C{\|q is an index node}\6
\&{begin} \37\&{for} $\|i\K0\mathrel{\&{to}}15$ \1\&{do}\6
\&{begin} \37\\{get\_sa\_ptr};\6
\&{if} $\\{cur\_ptr}\I\\{null}$ \1\&{then}\6
\&{if} $\\{do\_marks}(\|a,\39\|l+1,\39\\{cur\_ptr})$ \1\&{then}\5
\\{delete\_sa\_ptr};\2\2\6
\&{end};\2\6
\&{if} $\\{sa\_used}(\|q)=0$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|q,\39\\{index\_node\_size})$;\5
$\|q\K\\{null}$;\6
\&{end};\2\6
\&{end}\6
\4\&{else} \C{\|q is the node for a mark class}\2\6
\&{begin} \37\&{case} $\|a$ \1\&{of}\6
\X1826:Cases for \\{do\_marks}\X\2\6
\&{end};\C{there are no other cases}\6
\&{if} $\\{sa\_bot\_mark}(\|q)=\\{null}$ \1\&{then}\6
\&{if} $\\{sa\_split\_bot\_mark}(\|q)=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{free\_node}(\|q,\39\\{mark\_class\_node\_size})$;\5
$\|q\K\\{null}$;\6
\&{end};\2\2\6
\&{end};\5
$\\{do\_marks}\K(\|q=\\{null})$;\6
\&{end};\par
\U1154.\fi

\M1826. At the start of the \\{vsplit} routine the existing \\{split\_fist%
\_mark}
and \\{split\_bot\_mark} are discarded.

\Y\P$\4\X1826:Cases for \\{do\_marks}\X\S$\6
\4\\{vsplit\_init}: \37\&{if} $\\{sa\_split\_first\_mark}(\|q)\I\\{null}$ \1%
\&{then}\6
\&{begin} \37$\\{delete\_token\_ref}(\\{sa\_split\_first\_mark}(\|q))$;\5
$\\{sa\_split\_first\_mark}(\|q)\K\\{null}$;\5
$\\{delete\_token\_ref}(\\{sa\_split\_bot\_mark}(\|q))$;\5
$\\{sa\_split\_bot\_mark}(\|q)\K\\{null}$;\6
\&{end};\2\par
\As1828, 1829\ETs1831.
\U1825.\fi

\M1827. We use again the fact that $\\{split\_first\_mark}=\\{null}$ if and
only if
$\\{split\_bot\_mark}=\\{null}$.

\Y\P$\4\X1827:Update the current marks for \\{vsplit}\X\S$\6
\&{begin} \37$\\{find\_sa\_element}(\\{mark\_val},\39\\{mark\_class}(\|p),\39%
\\{true})$;\6
\&{if} $\\{sa\_split\_first\_mark}(\\{cur\_ptr})=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{sa\_split\_first\_mark}(\\{cur\_ptr})\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{mark\_ptr}(\|p))$;\6
\&{end}\6
\4\&{else} $\\{delete\_token\_ref}(\\{sa\_split\_bot\_mark}(\\{cur\_ptr}))$;\2\6
$\\{sa\_split\_bot\_mark}(\\{cur\_ptr})\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{mark\_ptr}(\|p))$;\6
\&{end}\par
\U1156.\fi

\M1828. At the start of the \\{fire\_up} routine the old \\{top\_mark} and
\\{first\_mark} are discarded, whereas the old \\{bot\_mark} becomes the new
\\{top\_mark}.  An empty new \\{top\_mark} token list is, however, discarded
as well in order that mark class nodes can eventually be released.  We
use again the fact that $\\{bot\_mark}\I\\{null}$ implies $\\{first\_mark}\I%
\\{null}$; it
also knows that $\\{bot\_mark}=\\{null}$ implies $\\{top\_mark}=\\{first%
\_mark}=\\{null}$.

\Y\P$\4\X1826:Cases for \\{do\_marks}\X\mathrel{+}\S$\6
\4\\{fire\_up\_init}: \37\&{if} $\\{sa\_bot\_mark}(\|q)\I\\{null}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{sa\_top\_mark}(\|q)\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{sa\_top\_mark}(\|q))$;\2\6
$\\{delete\_token\_ref}(\\{sa\_first\_mark}(\|q))$;\5
$\\{sa\_first\_mark}(\|q)\K\\{null}$;\6
\&{if} $\\{link}(\\{sa\_bot\_mark}(\|q))=\\{null}$ \1\&{then}\C{an empty token
list}\6
\&{begin} \37$\\{delete\_token\_ref}(\\{sa\_bot\_mark}(\|q))$;\5
$\\{sa\_bot\_mark}(\|q)\K\\{null}$;\6
\&{end}\6
\4\&{else} $\\{add\_token\_ref}(\\{sa\_bot\_mark}(\|q))$;\2\6
$\\{sa\_top\_mark}(\|q)\K\\{sa\_bot\_mark}(\|q)$;\6
\&{end};\2\par
\fi

\M1829. \P$\X1826:Cases for \\{do\_marks}\X\mathrel{+}\S$\6
\4\\{fire\_up\_done}: \37\&{if} $(\\{sa\_top\_mark}(\|q)\I\\{null})\W(\\{sa%
\_first\_mark}(\|q)=\\{null})$ \1\&{then}\6
\&{begin} \37$\\{sa\_first\_mark}(\|q)\K\\{sa\_top\_mark}(\|q)$;\5
$\\{add\_token\_ref}(\\{sa\_top\_mark}(\|q))$;\6
\&{end};\2\par
\fi

\M1830. \P$\X1830:Update the current marks for \\{fire\_up}\X\S$\6
\&{begin} \37$\\{find\_sa\_element}(\\{mark\_val},\39\\{mark\_class}(\|p),\39%
\\{true})$;\6
\&{if} $\\{sa\_first\_mark}(\\{cur\_ptr})=\\{null}$ \1\&{then}\6
\&{begin} \37$\\{sa\_first\_mark}(\\{cur\_ptr})\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{mark\_ptr}(\|p))$;\6
\&{end};\2\6
\&{if} $\\{sa\_bot\_mark}(\\{cur\_ptr})\I\\{null}$ \1\&{then}\5
$\\{delete\_token\_ref}(\\{sa\_bot\_mark}(\\{cur\_ptr}))$;\2\6
$\\{sa\_bot\_mark}(\\{cur\_ptr})\K\\{mark\_ptr}(\|p)$;\5
$\\{add\_token\_ref}(\\{mark\_ptr}(\|p))$;\6
\&{end}\par
\U1191.\fi

\M1831. Here we use the fact that the five current mark pointers in a mark
class node occupy the same locations as the the first five pointers of
an index node.  For systems using a run-time switch to distinguish
between \.{VIRTEX} and \.{INITEX}, the codewords `$ \&{init} \ldots  \&{tini}
$'
surrounding the following piece of code should be removed.

\Y\P$\4\X1826:Cases for \\{do\_marks}\X\mathrel{+}\S$\6
\&{init} \37\\{destroy\_marks}: \37\&{for} $\|i\K\\{top\_mark\_code}\mathrel{%
\&{to}}\\{split\_bot\_mark\_code}$ \1\&{do}\6
\&{begin} \37\\{get\_sa\_ptr};\6
\&{if} $\\{cur\_ptr}\I\\{null}$ \1\&{then}\6
\&{begin} \37$\\{delete\_token\_ref}(\\{cur\_ptr})$;\5
$\\{put\_sa\_ptr}(\\{null})$;\6
\&{end};\2\6
\&{end};\2\6
\&{tini}\par
\fi

\M1832. The command code \\{register} is used for `\.{\\count}', `\.{\\dimen}',
etc., as well as for references to sparse array elements defined by
`\.{\\countdef}', etc.

\Y\P$\4\X1832:Cases of \\{register} for \\{print\_cmd\_chr}\X\S$\6
\&{begin} \37\&{if} $(\\{chr\_code}<\\{mem\_bot})\V(\\{chr\_code}>\\{lo\_mem%
\_stat\_max})$ \1\&{then}\5
$\\{cmd}\K\\{sa\_type}(\\{chr\_code})$\6
\4\&{else} \&{begin} \37$\\{cmd}\K\\{chr\_code}-\\{mem\_bot}$;\5
$\\{chr\_code}\K\\{null}$;\6
\&{end};\2\6
\&{if} $\\{cmd}=\\{int\_val}$ \1\&{then}\5
$\\{print\_esc}(\.{"count"})$\6
\4\&{else} \&{if} $\\{cmd}=\\{dimen\_val}$ \1\&{then}\5
$\\{print\_esc}(\.{"dimen"})$\6
\4\&{else} \&{if} $\\{cmd}=\\{glue\_val}$ \1\&{then}\5
$\\{print\_esc}(\.{"skip"})$\6
\4\&{else} $\\{print\_esc}(\.{"muskip"})$;\2\2\2\6
\&{if} $\\{chr\_code}\I\\{null}$ \1\&{then}\5
$\\{print\_sa\_num}(\\{chr\_code})$;\2\6
\&{end}\par
\U438.\fi

\M1833. Similarly the command code \\{toks\_register} is used for `\.{\\toks}'
as
well as for references to sparse array elements defined by
`\.{\\toksdef}'.

\Y\P$\4\X1833:Cases of \\{toks\_register} for \\{print\_cmd\_chr}\X\S$\6
\&{begin} \37$\\{print\_esc}(\.{"toks"})$;\6
\&{if} $\\{chr\_code}\I\\{mem\_bot}$ \1\&{then}\5
$\\{print\_sa\_num}(\\{chr\_code})$;\2\6
\&{end}\par
\U288.\fi

\M1834. When a shorthand definition for an element of one of the sparse arrays
is destroyed, we must reduce the reference count.

\Y\P$\4\X1834:Cases for \\{eq\_destroy}\X\S$\6
\4$\\{toks\_register},\39\\{register}$: \37\&{if} $(\\{equiv\_field}(\|w)<%
\\{mem\_bot})\V(\\{equiv\_field}(\|w)>\\{lo\_mem\_stat\_max})$ \1\&{then}\5
$\\{delete\_sa\_ref}(\\{equiv\_field}(\|w))$;\2\par
\U297.\fi

\M1835. The task to maintain (change, save, and restore) register values is
essentially the same when the register is realized as sparse array
element or entry in \\{eqtb}.  The global variable \\{sa\_chain} is the head
of a linked list of entries saved at the topmost level \\{sa\_level}; the
lists for lower levels are kept in special save stack entries.

\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{sa\_chain}: \37\\{pointer};\C{chain of saved sparse array entries}\6
\4\\{sa\_level}: \37\\{quarterword};\C{group level for \\{sa\_chain}}\par
\fi

\M1836. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{sa\_chain}\K\\{null}$;\5
$\\{sa\_level}\K\\{level\_zero}$;\par
\fi

\M1837. The individual saved items are kept in pointer or word nodes similar
to those used for the array elements: a word node with value zero is,
however, saved as pointer node with the otherwise impossible \\{sa\_index}
value \\{tok\_val\_limit}.

\Y\P\D \37$\\{sa\_loc}\S\\{sa\_ref}$\C{location of saved item}\par
\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{sa\_save}(\|p:\\{pointer})$;\C{saves value of \|p}\6
\4\&{var} \37\|q: \37\\{pointer};\C{the new save node}\6
\|i: \37\\{quarterword};\C{index field of node}\2\6
\&{begin} \37\&{if} $\\{cur\_level}\I\\{sa\_level}$ \1\&{then}\6
\&{begin} \37\\{check\_full\_save\_stack};\5
$\\{save\_type}(\\{save\_ptr})\K\\{restore\_sa}$;\5
$\\{save\_level}(\\{save\_ptr})\K\\{sa\_level}$;\5
$\\{save\_index}(\\{save\_ptr})\K\\{sa\_chain}$;\5
$\\{incr}(\\{save\_ptr})$;\5
$\\{sa\_chain}\K\\{null}$;\5
$\\{sa\_level}\K\\{cur\_level}$;\6
\&{end};\2\6
$\|i\K\\{sa\_index}(\|p)$;\6
\&{if} $\|i<\\{dimen\_val\_limit}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{sa\_int}(\|p)=0$ \1\&{then}\6
\&{begin} \37$\|q\K\\{get\_node}(\\{pointer\_node\_size})$;\5
$\|i\K\\{tok\_val\_limit}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{get\_node}(\\{word\_node\_size})$;\5
$\\{sa\_int}(\|q)\K\\{sa\_int}(\|p)$;\6
\&{end};\2\6
$\\{sa\_ptr}(\|q)\K\\{null}$;\6
\&{end}\6
\4\&{else} \&{begin} \37$\|q\K\\{get\_node}(\\{pointer\_node\_size})$;\5
$\\{sa\_ptr}(\|q)\K\\{sa\_ptr}(\|p)$;\6
\&{end};\2\6
$\\{sa\_loc}(\|q)\K\|p$;\5
$\\{sa\_index}(\|q)\K\|i$;\5
$\\{sa\_lev}(\|q)\K\\{sa\_lev}(\|p)$;\5
$\\{link}(\|q)\K\\{sa\_chain}$;\5
$\\{sa\_chain}\K\|q$;\5
$\\{add\_sa\_ref}(\|p)$;\6
\&{end};\par
\fi

\M1838. \P$\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}%
\S$\6
\4\&{procedure}\1\  \37$\\{sa\_destroy}(\|p:\\{pointer})$;\C{destroy value of %
\|p}\2\6
\&{begin} \37\&{if} $\\{sa\_index}(\|p)<\\{mu\_val\_limit}$ \1\&{then}\5
$\\{delete\_glue\_ref}(\\{sa\_ptr}(\|p))$\6
\4\&{else} \&{if} $\\{sa\_ptr}(\|p)\I\\{null}$ \1\&{then}\6
\&{if} $\\{sa\_index}(\|p)<\\{box\_val\_limit}$ \1\&{then}\5
$\\{flush\_node\_list}(\\{sa\_ptr}(\|p))$\6
\4\&{else} $\\{delete\_token\_ref}(\\{sa\_ptr}(\|p))$;\2\2\2\6
\&{end};\par
\fi

\M1839. The procedure \\{sa\_def} assigns a new value to sparse array elements,
and saves the former value if appropriate.  This procedure is used only
for skip, muskip, box, and token list registers.  The counterpart of
\\{sa\_def} for count and dimen registers is called \\{sa\_w\_def}.

\Y\P\D \37$\\{sa\_define}(\#)\S$\1\6
\&{if} $\|e$ \1\&{then}\6
\&{if} $\\{global}$ \1\&{then}\5
$\\{gsa\_def}(\#)$\ \&{else} $\\{sa\_def}(\#)$\2\6
\4\&{else} \\{define}\2\2\par
\P\D \37$\\{sa\_def\_box}\S$\C{assign \\{cur\_box} to $\\{box}(\\{cur\_val})$}\6
\&{begin} \37$\\{find\_sa\_element}(\\{box\_val},\39\\{cur\_val},\39\\{true})$;%
\6
\&{if} $\\{global}$ \1\&{then}\5
$\\{gsa\_def}(\\{cur\_ptr},\39\\{cur\_box})$\ \&{else} $\\{sa\_def}(\\{cur%
\_ptr},\39\\{cur\_box})$;\2\6
\&{end}\Y\par
\P\D \37$\\{sa\_word\_define}(\#)\S$\1\6
\&{if} $\|e$ \1\&{then}\6
\&{if} $\\{global}$ \1\&{then}\5
$\\{gsa\_w\_def}(\#)$\ \&{else} $\\{sa\_w\_def}(\#)$\2\6
\4\&{else} $\\{word\_define}(\#)$\2\2\par
\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{sa\_def}(\|p:\\{pointer};\,\35\|e:\\{halfword})$;%
\C{new data for sparse array elements}\2\6
\&{begin} \37$\\{add\_sa\_ref}(\|p)$;\6
\&{if} $\\{sa\_ptr}(\|p)=\|e$ \1\&{then}\6
\&{begin} \37\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"reassigning"})$;\ \2\6
\&{tats}\6
$\\{sa\_destroy}(\|p)$;\6
\&{end}\6
\4\&{else} \&{begin} \37\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"changing"})$;\ \2\6
\&{tats}\6
\&{if} $\\{sa\_lev}(\|p)=\\{cur\_level}$ \1\&{then}\5
$\\{sa\_destroy}(\|p)$\ \&{else} $\\{sa\_save}(\|p)$;\2\6
$\\{sa\_lev}(\|p)\K\\{cur\_level}$;\5
$\\{sa\_ptr}(\|p)\K\|e$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"into"})$;\ \2\6
\&{tats}\6
\&{end};\2\6
$\\{delete\_sa\_ref}(\|p)$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{sa\_w\_def}(\|p:\\{pointer};\,\35\|w:\\{integer})$;%
\2\6
\&{begin} \37$\\{add\_sa\_ref}(\|p)$;\6
\&{if} $\\{sa\_int}(\|p)=\|w$ \1\&{then}\6
\&{begin} \37\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"reassigning"})$;\ \2\6
\&{tats}\6
\&{end}\6
\4\&{else} \&{begin} \37\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"changing"})$;\ \2\6
\&{tats}\6
\&{if} $\\{sa\_lev}(\|p)\I\\{cur\_level}$ \1\&{then}\5
$\\{sa\_save}(\|p)$;\2\6
$\\{sa\_lev}(\|p)\K\\{cur\_level}$;\5
$\\{sa\_int}(\|p)\K\|w$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"into"})$;\ \2\6
\&{tats}\6
\&{end};\2\6
$\\{delete\_sa\_ref}(\|p)$;\6
\&{end};\par
\fi

\M1840. The \\{sa\_def} and \\{sa\_w\_def} routines take care of local
definitions.
Global definitions are done in almost the same way, but there is no need
to save old values, and the new value is associated with \\{level\_one}.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37$\\{gsa\_def}(\|p:\\{pointer};\,\35\|e:\\{halfword})$;%
\C{global \\{sa\_def}}\2\6
\&{begin} \37$\\{add\_sa\_ref}(\|p)$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"globally\ changing"})$;\ \2\6
\&{tats}\6
$\\{sa\_destroy}(\|p)$;\5
$\\{sa\_lev}(\|p)\K\\{level\_one}$;\5
$\\{sa\_ptr}(\|p)\K\|e$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"into"})$;\ \2\6
\&{tats}\6
$\\{delete\_sa\_ref}(\|p)$;\6
\&{end};\7
\4\&{procedure}\1\  \37$\\{gsa\_w\_def}(\|p:\\{pointer};\,\35\|w:\\{integer})$;%
\C{global \\{sa\_w\_def}}\2\6
\&{begin} \37$\\{add\_sa\_ref}(\|p)$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"globally\ changing"})$;\ \2\6
\&{tats}\6
$\\{sa\_lev}(\|p)\K\\{level\_one}$;\5
$\\{sa\_int}(\|p)\K\|w$;\6
\&{stat} \37\&{if} $\\{tracing\_assigns}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"into"})$;\ \2\6
\&{tats}\6
$\\{delete\_sa\_ref}(\|p)$;\6
\&{end};\par
\fi

\M1841. The \\{sa\_restore} procedure restores the sparse array entries pointed
at by \\{sa\_chain}.

\Y\P$\4\X306:Declare \eTeX\ procedures for tracing and input\X\mathrel{+}\S$\6
\4\&{procedure}\1\  \37\\{sa\_restore};\6
\4\&{var} \37\|p: \37\\{pointer};\C{sparse array element}\2\6
\&{begin} \37\1\&{repeat} \37$\|p\K\\{sa\_loc}(\\{sa\_chain})$;\6
\&{if} $\\{sa\_lev}(\|p)=\\{level\_one}$ \1\&{then}\6
\&{begin} \37\&{if} $\\{sa\_index}(\|p)\G\\{dimen\_val\_limit}$ \1\&{then}\5
$\\{sa\_destroy}(\\{sa\_chain})$;\2\6
\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"retaining"})$;\ \2\6
\&{tats}\6
\&{end}\6
\4\&{else} \&{begin} \37\&{if} $\\{sa\_index}(\|p)<\\{dimen\_val\_limit}$ \1%
\&{then}\6
\&{if} $\\{sa\_index}(\\{sa\_chain})<\\{dimen\_val\_limit}$ \1\&{then}\5
$\\{sa\_int}(\|p)\K\\{sa\_int}(\\{sa\_chain})$\6
\4\&{else} $\\{sa\_int}(\|p)\K0$\2\6
\4\&{else} \&{begin} \37$\\{sa\_destroy}(\|p)$;\5
$\\{sa\_ptr}(\|p)\K\\{sa\_ptr}(\\{sa\_chain})$;\6
\&{end};\2\6
$\\{sa\_lev}(\|p)\K\\{sa\_lev}(\\{sa\_chain})$;\6
\&{stat} \37\&{if} $\\{tracing\_restores}>0$ \1\&{then}\5
$\\{show\_sa}(\|p,\39\.{"restoring"})$;\ \2\6
\&{tats}\6
\&{end};\2\6
$\\{delete\_sa\_ref}(\|p)$;\5
$\|p\K\\{sa\_chain}$;\5
$\\{sa\_chain}\K\\{link}(\|p)$;\6
\&{if} $\\{sa\_index}(\|p)<\\{dimen\_val\_limit}$ \1\&{then}\5
$\\{free\_node}(\|p,\39\\{word\_node\_size})$\6
\4\&{else} $\\{free\_node}(\|p,\39\\{pointer\_node\_size})$;\2\6
\4\&{until}\5
$\\{sa\_chain}=\\{null}$;\2\6
\&{end};\par
\fi

\M1842. When the value of \\{last\_line\_fit} is positive, the last line of a
(partial) paragraph is treated in a special way and we need additional
fields in the active nodes.

\Y\P\D \37$\\{active\_node\_size\_extended}=5$\C{number of words in extended
active nodes}\par
\P\D \37$\\{active\_short}(\#)\S\\{mem}[\#+3].\\{sc}$\C{\\{shortfall} of this
line}\par
\P\D \37$\\{active\_glue}(\#)\S\\{mem}[\#+4].\\{sc}$\C{corresponding glue
stretch or shrink}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{last\_line\_fill}: \37\\{pointer};\C{the \\{par\_fill\_skip} glue node of
the new paragraph}\6
\4\\{do\_last\_line\_fit}: \37\\{boolean};\C{special algorithm for last line of
paragraph?}\6
\4\\{active\_node\_size}: \37\\{small\_number};\C{number of words in active
nodes}\6
\4\\{fill\_width}: \37\&{array} $[0\to2]$ \1\&{of}\5
\\{scaled};\C{infinite stretch components of   \\{par\_fill\_skip}}\2\6
\4\\{best\_pl\_short}: \37\&{array} $[\\{very\_loose\_fit}\to\\{tight\_fit}]$ %
\1\&{of}\5
\\{scaled};\C{\\{shortfall}   corresponding to \\{minimal\_demerits}}\2\6
\4\\{best\_pl\_glue}: \37\&{array} $[\\{very\_loose\_fit}\to\\{tight\_fit}]$ \1%
\&{of}\5
\\{scaled};\C{corresponding   glue stretch or shrink}\2\par
\fi

\M1843. The new algorithm for the last line requires that the stretchability of
\\{par\_fill\_skip} is infinite and the stretchability of \\{left\_skip} plus
\\{right\_skip} is finite.

\Y\P$\4\X1843:Check for special treatment of last line of paragraph\X\S$\6
$\\{do\_last\_line\_fit}\K\\{false}$;\5
$\\{active\_node\_size}\K\\{active\_node\_size\_normal}$;\C{just in case}\6
\&{if} $\\{last\_line\_fit}>0$ \1\&{then}\6
\&{begin} \37$\|q\K\\{glue\_ptr}(\\{last\_line\_fill})$;\6
\&{if} $(\\{stretch}(\|q)>0)\W(\\{stretch\_order}(\|q)>\\{normal})$ \1\&{then}\6
\&{if} $(\\{background}[3]=0)\W(\\{background}[4]=0)\W(\\{background}[5]=0)$ \1%
\&{then}\6
\&{begin} \37$\\{do\_last\_line\_fit}\K\\{true}$;\5
$\\{active\_node\_size}\K\\{active\_node\_size\_extended}$;\5
$\\{fill\_width}[0]\K0$;\5
$\\{fill\_width}[1]\K0$;\5
$\\{fill\_width}[2]\K0$;\5
$\\{fill\_width}[\\{stretch\_order}(\|q)-1]\K\\{stretch}(\|q)$;\6
\&{end};\2\2\6
\&{end}\2\par
\U1003.\fi

\M1844. \P$\X1006:Other local variables for \\{try\_break}\X\mathrel{+}\S$\6
\4\|g: \37\\{scaled};\C{glue stretch or shrink of test line, adjustment for
last line}\par
\fi

\M1845. Here we initialize the additional fields of the first active node
representing the beginning of the paragraph.

\Y\P$\4\X1845:Initialize additional fields of the first active node\X\S$\6
\&{begin} \37$\\{active\_short}(\|q)\K0$;\5
$\\{active\_glue}(\|q)\K0$;\6
\&{end}\par
\U1040.\fi

\M1846. Here we compute the adjustment \|g and badness \|b for a line from \|r
to the end of the paragraph.  When any of the criteria for adjustment is
violated we fall through to the normal algorithm.

The last line must be too short, and have infinite stretch entirely due
to \\{par\_fill\_skip}.

\Y\P$\4\X1846:Perform computations for last line and \&{goto} \\{found}\X\S$\6
\&{begin} \37\&{if} $(\\{active\_short}(\|r)=0)\V(\\{active\_glue}(\|r)\L0)$ \1%
\&{then}\5
\&{goto} \37\\{not\_found};\C{previous line was neither stretched nor shrunk,
or was infinitely bad}\2\6
\&{if} $(\\{cur\_active\_width}[3]\I\\{fill\_width}[0])\V\30(\\{cur\_active%
\_width}[4]\I\\{fill\_width}[1])\V\30(\\{cur\_active\_width}[5]\I\\{fill%
\_width}[2])$ \1\&{then}\5
\&{goto} \37\\{not\_found};\C{infinite stretch of this line not entirely due to
\\{par\_fill\_skip}}\2\6
\&{if} $\\{active\_short}(\|r)>0$ \1\&{then}\5
$\|g\K\\{cur\_active\_width}[2]$\6
\4\&{else} $\|g\K\\{cur\_active\_width}[6]$;\2\6
\&{if} $\|g\L0$ \1\&{then}\5
\&{goto} \37\\{not\_found};\C{no finite stretch resp.\ no shrink}\2\6
$\\{arith\_error}\K\\{false}$;\5
$\|g\K\\{fract}(\|g,\39\\{active\_short}(\|r),\39\\{active\_glue}(\|r),\39%
\\{max\_dimen})$;\6
\&{if} $\\{last\_line\_fit}<1000$ \1\&{then}\5
$\|g\K\\{fract}(\|g,\39\\{last\_line\_fit},\391000,\39\\{max\_dimen})$;\2\6
\&{if} $\\{arith\_error}$ \1\&{then}\6
\&{if} $\\{active\_short}(\|r)>0$ \1\&{then}\5
$\|g\K\\{max\_dimen}$\ \&{else} $\|g\K-\\{max\_dimen}$;\2\2\6
\&{if} $\|g>0$ \1\&{then}\5
\X1847:Set the value of \|b to the badness of the last line for stretching,
compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X\6
\4\&{else} \&{if} $\|g<0$ \1\&{then}\5
\X1848:Set the value of \|b to the badness of the last line for shrinking,
compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X;\2\2\6
\4\\{not\_found}: \37\&{end}\par
\U1028.\fi

\M1847. These badness computations are rather similar to those of the standard
algorithm, with the adjustment amount \|g replacing the \\{shortfall}.

\Y\P$\4\X1847:Set the value of \|b to the badness of the last line for
stretching, compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X%
\S$\6
\&{begin} \37\&{if} $\|g>\\{shortfall}$ \1\&{then}\5
$\|g\K\\{shortfall}$;\2\6
\&{if} $\|g>7230584$ \1\&{then}\6
\&{if} $\\{cur\_active\_width}[2]<1663497$ \1\&{then}\6
\&{begin} \37$\|b\K\\{inf\_bad}$;\5
$\\{fit\_class}\K\\{very\_loose\_fit}$;\5
\&{goto} \37\\{found};\6
\&{end};\2\2\6
$\|b\K\\{badness}(\|g,\39\\{cur\_active\_width}[2])$;\6
\&{if} $\|b>12$ \1\&{then}\6
\&{if} $\|b>99$ \1\&{then}\5
$\\{fit\_class}\K\\{very\_loose\_fit}$\6
\4\&{else} $\\{fit\_class}\K\\{loose\_fit}$\2\6
\4\&{else} $\\{fit\_class}\K\\{decent\_fit}$;\2\6
\&{goto} \37\\{found};\6
\&{end}\par
\U1846.\fi

\M1848. \P$\X1848:Set the value of \|b to the badness of the last line for
shrinking, compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X%
\S$\6
\&{begin} \37\&{if} $-\|g>\\{cur\_active\_width}[6]$ \1\&{then}\5
$\|g\K-\\{cur\_active\_width}[6]$;\2\6
$\|b\K\\{badness}(-\|g,\39\\{cur\_active\_width}[6])$;\6
\&{if} $\|b>12$ \1\&{then}\5
$\\{fit\_class}\K\\{tight\_fit}$\ \&{else} $\\{fit\_class}\K\\{decent\_fit}$;\2%
\6
\&{goto} \37\\{found};\6
\&{end}\par
\U1846.\fi

\M1849. Vanishing values of \\{shortfall} and \|g indicate that the last line
is
not adjusted.

\Y\P$\4\X1849:Adjust \(t)the additional data for last line\X\S$\6
\&{begin} \37\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\5
$\\{shortfall}\K0$;\2\6
\&{if} $\\{shortfall}>0$ \1\&{then}\5
$\|g\K\\{cur\_active\_width}[2]$\6
\4\&{else} \&{if} $\\{shortfall}<0$ \1\&{then}\5
$\|g\K\\{cur\_active\_width}[6]$\6
\4\&{else} $\|g\K0$;\2\2\6
\&{end}\par
\U1027.\fi

\M1850. For each feasible break we record the shortfall and glue stretch or
shrink (or adjustment).

\Y\P$\4\X1850:Store \(a)additional data for this feasible break\X\S$\6
\&{begin} \37$\\{best\_pl\_short}[\\{fit\_class}]\K\\{shortfall}$;\5
$\\{best\_pl\_glue}[\\{fit\_class}]\K\|g$;\6
\&{end}\par
\U1031.\fi

\M1851. Here we save these data in the active node representing a potential
line break.

\Y\P$\4\X1851:Store \(a)additional data in the new active node\X\S$\6
\&{begin} \37$\\{active\_short}(\|q)\K\\{best\_pl\_short}[\\{fit\_class}]$;\5
$\\{active\_glue}(\|q)\K\\{best\_pl\_glue}[\\{fit\_class}]$;\6
\&{end}\par
\U1021.\fi

\M1852. \P$\X1852:Print additional data in the new active node\X\S$\6
\&{begin} \37$\\{print}(\.{"\ s="})$;\5
$\\{print\_scaled}(\\{active\_short}(\|q))$;\6
\&{if} $\\{cur\_p}=\\{null}$ \1\&{then}\5
$\\{print}(\.{"\ a="})$\ \&{else} $\\{print}(\.{"\ g="})$;\2\6
$\\{print\_scaled}(\\{active\_glue}(\|q))$;\6
\&{end}\par
\U1022.\fi

\M1853. Here we either reset \\{do\_last\_line\_fit} or adjust the \\{par\_fill%
\_skip}
glue.

\Y\P$\4\X1853:Adjust \(t)the final line of the paragraph\X\S$\6
\&{if} $\\{active\_short}(\\{best\_bet})=0$ \1\&{then}\5
$\\{do\_last\_line\_fit}\K\\{false}$\6
\4\&{else} \&{begin} \37$\|q\K\\{new\_spec}(\\{glue\_ptr}(\\{last\_line%
\_fill}))$;\5
$\\{delete\_glue\_ref}(\\{glue\_ptr}(\\{last\_line\_fill}))$;\5
$\\{width}(\|q)\K\\{width}(\|q)+\\{active\_short}(\\{best\_bet})-\\{active%
\_glue}(\\{best\_bet})$;\5
$\\{stretch}(\|q)\K0$;\5
$\\{glue\_ptr}(\\{last\_line\_fill})\K\|q$;\6
\&{end}\2\par
\U1039.\fi

\M1854. When reading \.{\\patterns} while \.{\\savinghyphcodes} is positive
the current \\{lc\_code} values are stored together with the hyphenation
patterns for the current language.  They will later be used instead of
the \\{lc\_code} values for hyphenation purposes.

The \\{lc\_code} values are stored in the linked trie analogous to patterns
$p_1$ of length~1, with $\\{hyph\_root}=\\{trie\_r}[0]$ replacing \\{trie%
\_root} and
$\\{lc\_code}(\\{p\_1})$ replacing the \\{trie\_op} code.  This allows to
compress
and pack them together with the patterns with minimal changes to the
existing code.

\Y\P\D \37$\\{hyph\_root}\S\\{trie\_r}[0]$\C{root of the linked trie for %
\\{hyph\_codes}}\par
\Y\P$\4\X182:Initialize table entries (done by \.{INITEX} only)\X\mathrel{+}\S$%
\6
$\\{hyph\_root}\K0$;\5
$\\{hyph\_start}\K0$;\par
\fi

\M1855. \P$\X1855:Store hyphenation codes for current language\X\S$\6
\&{begin} \37$\|c\K\\{cur\_lang}$;\5
$\\{first\_child}\K\\{false}$;\5
$\|p\K0$;\6
\1\&{repeat} \37$\|q\K\|p$;\5
$\|p\K\\{trie\_r}[\|q]$;\6
\4\&{until}\5
$(\|p=0)\V(\|c\L\\{so}(\\{trie\_c}[\|p]))$;\2\6
\&{if} $(\|p=0)\V(\|c<\\{so}(\\{trie\_c}[\|p]))$ \1\&{then}\5
\X1141:Insert a new trie node between \|q and \|p, and make \|p point to it\X;%
\2\6
$\|q\K\|p$;\C{now node \|q represents \\{cur\_lang}}\6
\X1856:Store all current \\{lc\_code} values\X;\6
\&{end}\par
\U1137.\fi

\M1856. We store all nonzero \\{lc\_code} values, overwriting any previously
stored values (and possibly wasting a few trie nodes that were used
previously and are not needed now).  We always store at least one
\\{lc\_code} value such that \\{hyph\_index} (defined below) will not be zero.

\Y\P$\4\X1856:Store all current \\{lc\_code} values\X\S$\6
$\|p\K\\{trie\_l}[\|q]$;\5
$\\{first\_child}\K\\{true}$;\6
\&{for} $\|c\K0\mathrel{\&{to}}255$ \1\&{do}\6
\&{if} $(\\{lc\_code}(\|c)>0)\V((\|c=255)\W\\{first\_child})$ \1\&{then}\6
\&{begin} \37\&{if} $\|p=0$ \1\&{then}\5
\X1141:Insert a new trie node between \|q and \|p, and make \|p point to it\X\6
\4\&{else} $\\{trie\_c}[\|p]\K\\{si}(\|c)$;\2\6
$\\{trie\_o}[\|p]\K\\{qi}(\\{lc\_code}(\|c))$;\5
$\|q\K\|p$;\5
$\|p\K\\{trie\_r}[\|q]$;\5
$\\{first\_child}\K\\{false}$;\6
\&{end};\2\2\6
\&{if} $\\{first\_child}$ \1\&{then}\5
$\\{trie\_l}[\|q]\K0$\ \&{else} $\\{trie\_r}[\|q]\K0$\2\par
\U1855.\fi

\M1857. We must avoid to ``take'' location~1, in order to distinguish between
\\{lc\_code} values and patterns.

\Y\P$\4\X1857:Pack all stored \\{hyph\_codes}\X\S$\6
\&{begin} \37\&{if} $\\{trie\_root}=0$ \1\&{then}\6
\&{for} $\|p\K0\mathrel{\&{to}}255$ \1\&{do}\5
$\\{trie\_min}[\|p]\K\|p+2$;\2\2\6
$\\{first\_fit}(\\{hyph\_root})$;\5
$\\{trie\_pack}(\\{hyph\_root})$;\5
$\\{hyph\_start}\K\\{trie\_ref}[\\{hyph\_root}]$;\6
\&{end}\par
\U1143.\fi

\M1858. The global variable \\{hyph\_index} will point to the hyphenation codes
for the current language.

\Y\P\D \37$\\{set\_hyph\_index}\S$\C{set \\{hyph\_index} for current language}\6
\&{if} $\\{trie\_char}(\\{hyph\_start}+\\{cur\_lang})\I\\{qi}(\\{cur\_lang})$ %
\1\&{then}\5
$\\{hyph\_index}\K0$\C{no hyphenation codes for \\{cur\_lang}}\6
\4\&{else} $\\{hyph\_index}\K\\{trie\_link}(\\{hyph\_start}+\\{cur\_lang})$\2%
\par
\P\D \37$\\{set\_lc\_code}(\#)\S$\C{set $\\{hc}[0]$ to hyphenation or lc code
for $\#$}\6
\&{if} $\\{hyph\_index}=0$ \1\&{then}\5
$\\{hc}[0]\K\\{lc\_code}(\#)$\6
\4\&{else} \&{if} $\\{trie\_char}(\\{hyph\_index}+\#)\I\\{qi}(\#)$ \1\&{then}\5
$\\{hc}[0]\K0$\6
\4\&{else} $\\{hc}[0]\K\\{qo}(\\{trie\_op}(\\{hyph\_index}+\#))$\2\2\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{hyph\_start}: \37\\{trie\_pointer};\C{root of the packed trie for \\{hyph%
\_codes}}\6
\4\\{hyph\_index}: \37\\{trie\_pointer};\C{pointer to hyphenation codes for %
\\{cur\_lang}}\par
\fi

\M1859. When \\{saving\_vdiscards} is positive then the glue, kern, and penalty
nodes removed by the page builder or by \.{\\vsplit} from the top of a
vertical list are saved in special lists instead of being discarded.

\Y\P\D \37$\\{tail\_page\_disc}\S\\{disc\_ptr}[\\{copy\_code}]$\C{last item
removed by page builder}\par
\P\D \37$\\{page\_disc}\S\\{disc\_ptr}[\\{last\_box\_code}]$\C{first item
removed by page builder}\par
\P\D \37$\\{split\_disc}\S\\{disc\_ptr}[\\{vsplit\_code}]$\C{first item removed
by \.{\\vsplit}}\par
\Y\P$\4\X13:Global variables\X\mathrel{+}\S$\6
\4\\{disc\_ptr}: \37\&{array} $[\\{copy\_code}\to\\{vsplit\_code}]$ \1\&{of}\5
\\{pointer};\C{list pointers}\2\par
\fi

\M1860. \P$\X21:Set initial values of key variables\X\mathrel{+}\S$\6
$\\{page\_disc}\K\\{null}$;\5
$\\{split\_disc}\K\\{null}$;\par
\fi

\M1861. The \.{\\pagediscards} and \.{\\splitdiscards} commands share the
command code \\{un\_vbox} with \.{\\unvbox} and \.{\\unvcopy}, they are
distinguished by their \\{chr\_code} values \\{last\_box\_code} and
\\{vsplit\_code}.  These \\{chr\_code} values are larger than \\{box\_code} and
\\{copy\_code}.

\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"pagediscards"},\39\\{un\_vbox},\39\\{last\_box\_code})$;\6
$\\{primitive}(\.{"splitdiscards"},\39\\{un\_vbox},\39\\{vsplit\_code})$;\par
\fi

\M1862. \P$\X1862:Cases of \\{un\_vbox} for \\{print\_cmd\_chr}\X\S$\6
\4\&{else} \37\&{if} $\\{chr\_code}=\\{last\_box\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"pagediscards"})$\6
\4\&{else} \&{if} $\\{chr\_code}=\\{vsplit\_code}$ \1\&{then}\5
$\\{print\_esc}(\.{"splitdiscards"})$\2\2\par
\U1286.\fi

\M1863. \P$\X1863:Handle saved items and \&{goto} \\{done}\X\S$\6
\&{begin} \37$\\{link}(\\{tail})\K\\{disc\_ptr}[\\{cur\_chr}]$;\5
$\\{disc\_ptr}[\\{cur\_chr}]\K\\{null}$;\5
\&{goto} \37\\{done};\6
\&{end}\par
\U1288.\fi

\M1864. The \.{\\interlinepenalties}, \.{\\clubpenalties}, \.{%
\\widowpenalties},
and \.{\\displaywidowpenalties} commands allow to define arrays of
penalty values to be used instead of the corresponding single values.

\Y\P\D \37$\\{inter\_line\_penalties\_ptr}\S\\{equiv}(\\{inter\_line\_penalties%
\_loc})$\par
\P\D \37$\\{club\_penalties\_ptr}\S\\{equiv}(\\{club\_penalties\_loc})$\par
\P\D \37$\\{widow\_penalties\_ptr}\S\\{equiv}(\\{widow\_penalties\_loc})$\par
\P\D \37$\\{display\_widow\_penalties\_ptr}\S\\{equiv}(\\{display\_widow%
\_penalties\_loc})$\par
\Y\P$\4\X1649:Generate all \eTeX\ primitives\X\mathrel{+}\S$\6
$\\{primitive}(\.{"interlinepenalties"},\39\\{set\_shape},\39\\{inter\_line%
\_penalties\_loc})$;\6
$\\{primitive}(\.{"clubpenalties"},\39\\{set\_shape},\39\\{club\_penalties%
\_loc})$;\6
$\\{primitive}(\.{"widowpenalties"},\39\\{set\_shape},\39\\{widow\_penalties%
\_loc})$;\6
$\\{primitive}(\.{"displaywidowpenalties"},\39\\{set\_shape},\39\\{display%
\_widow\_penalties\_loc})$;\par
\fi

\M1865. \P$\X1865:Cases of \\{set\_shape} for \\{print\_cmd\_chr}\X\S$\6
\4\\{inter\_line\_penalties\_loc}: \37$\\{print\_esc}(%
\.{"interlinepenalties"})$;\6
\4\\{club\_penalties\_loc}: \37$\\{print\_esc}(\.{"clubpenalties"})$;\6
\4\\{widow\_penalties\_loc}: \37$\\{print\_esc}(\.{"widowpenalties"})$;\6
\4\\{display\_widow\_penalties\_loc}: \37$\\{print\_esc}(%
\.{"displaywidowpenalties"})$;\par
\U288.\fi

\M1866. \P$\X1866:Fetch a penalties array element\X\S$\6
\&{begin} \37\\{scan\_int};\6
\&{if} $(\\{equiv}(\|m)=\\{null})\V(\\{cur\_val}<0)$ \1\&{then}\5
$\\{cur\_val}\K0$\6
\4\&{else} \&{begin} \37\&{if} $\\{cur\_val}>\\{penalty}(\\{equiv}(\|m))$ \1%
\&{then}\5
$\\{cur\_val}\K\\{penalty}(\\{equiv}(\|m))$;\2\6
$\\{cur\_val}\K\\{penalty}(\\{equiv}(\|m)+\\{cur\_val})$;\6
\&{end};\2\6
\&{end}\par
\U449.\fi

\N1867.  \[54] System-dependent changes.
This section should be replaced, if necessary, by any special
modifications of the program
that are necessary to make \TeX\ work at a particular installation.
It is usually best to design your change file so that all changes to
previous sections preserve the section numbering; then everybody's version
will be consistent with the published program. More extensive changes,
which introduce new sections, can be inserted here; then only the index
itself will get a new section number.

\fi

\N1868.  \[55] Index.
Here is where you can find all uses of each identifier in the program,
with underlined entries pointing to where the identifier was defined.
If the identifier is only one letter long, however, you get to see only
the underlined entries. {\sl All references are to section numbers instead of
page numbers.}

This index also lists error messages and other aspects of the program
that you might want to look up some day. For example, the entry
for ``system dependencies'' lists all sections that should receive
special attention from people who are installing \TeX\ in a new
operating environment. A list of various things that can't happen appears
under ``this can't happen''. Approximately 40 sections are listed under
``inner loop''; these account for about 60\pct! of \TeX's running time,
exclusive of input and output.
\fi


\inx
\:\.{**}, 37, 560.
\:\.{*\relax}, 192, 194, 196, 335, 382, 674, 1032, 1183, 1602.
\:\.{->}, 316.
\:\.{=>}, 385.
\:\.{???}, 59.
\:\.{?\relax}, 83.
\:\.{\AT!}, 1032.
\:\.{\AT!\AT!}, 1022.
\:\|{a}, \[47], \[102], \[122], \[236], \[303], \[544], \[545], \[549], \[586],
\[597], \[624], \[678], \[686], \[698], \[867], \[898], \[914], \[928], %
\[1253], \[1301], \[1372], \[1389], \[1414], \[1435], \[1513], \[1600], %
\[1637], \[1679], \[1782], \[1793], \[1797], \[1799], \[1825].
\:\.{A <box> was supposed to...}, 1262.
\:\\{a\_close}, \[28], 51, 351, 511, 512, 1453, 1513, 1622, 1626.
\:\\{a\_leaders}, \[167], 207, 653, 655, 662, 664, 735, 744, 832, 847, 1249,
1250, 1251, 1256, 1326, 1681, 1699.
\:\\{a\_make\_name\_string}, \[551], 560, 563.
\:\\{a\_open\_in}, \[27], 51, 563, 1453.
\:\\{a\_open\_out}, \[27], 560, 1622.
\:\\{A\_token}, \[471].
\:\\{ab\_vs\_cd}, \[122], 127.
\:\\{abort}, \[586], 589, 590, 591, 594, 595, 596, 597, 598, 600, 602.
\:\\{above}, \[226], 1224, 1356, 1357, 1358.
\:\9{above\_}{\.{\\above} primitive}, \[1356].
\:\\{above\_code}, \[1356], 1357, 1360, 1361.
\:\\{above\_display\_short\_skip}, \[242], 990.
\:\9{above\_display\_short\_skip\_}{\.{\\abovedisplayshortskip} primitive}, %
\[244].
\:\\{above\_display\_short\_skip\_code}, \[242], 243, 244, 1381.
\:\\{above\_display\_skip}, \[242], 990.
\:\9{above\_display\_skip\_}{\.{\\abovedisplayskip} primitive}, \[244].
\:\\{above\_display\_skip\_code}, \[242], 243, 244, 1381, 1384.
\:\9{above\_with\_delims\_}{\.{\\abovewithdelims} primitive}, \[1356].
\:\\{abs}, 66, 125, 126, 127, 204, 229, 236, 237, 444, 448, 474, 527, 637, 686,
690, 692, 693, 705, 706, 839, 851, 894, 913, 933, 934, 935, 1007, 1012, 1025,
1035, 1121, 1125, 1206, 1207, 1234, 1254, 1256, 1258, 1261, 1271, 1288, 1298,
1305, 1327, 1421, 1422, 1560, 1561, 1563, 1625, 1681, 1790.
\:\\{absorbing}, \[327], 328, 361, 499, 1683.
\:\\{acc\_kern}, \[173], 209, 1303.
\:\\{accent}, \[226], 287, 288, 1268, 1300, 1342, 1343.
\:\9{accent\_}{\.{\\accent} primitive}, \[287].
\:\\{accent\_chr}, \[863], 872, 914, 1343.
\:\\{accent\_noad}, \[863], 866, 872, 874, 909, 937, 1343, 1364.
\:\\{accent\_noad\_size}, \[863], 874, 937, 1343.
\:\\{act\_width}, \[1042], 1043, 1044, 1047, 1609.
\:{action procedure}, \[1206].
\:\\{active}, \[180], 995, 1005, 1019, 1030, 1036, 1037, 1039, 1040, 1041,
1049, 1050, 1051.
\:\\{active\_base}, 238, \[240], 270, 271, 273, 284, 285, 375, 468, 532, 706,
1330, 1435, 1467, 1493, 1495.
\:\\{active\_char}, \[225], 366, 532.
\:\\{active\_glue}, \[1842], 1845, 1846, 1851, 1852, 1853.
\:\\{active\_height}, \[1147], 1152, 1153.
\:\\{active\_node\_size}, 1021, 1036, 1040, 1041, \[1842], 1843.
\:\\{active\_node\_size\_extended}, \[1842], 1843.
\:\\{active\_node\_size\_normal}, \[995], 1843.
\:\\{active\_short}, \[1842], 1845, 1846, 1851, 1852, 1853.
\:\\{active\_width}, \[999], 1000, 1005, 1015, 1019, 1037, 1040, 1042, 1043,
1044, 1047, 1147.
\:\\{actual\_looseness}, \[1048], 1049, 1051.
\:\\{add\_action\_ref}, \[1536], 1604.
\:\\{add\_char\_shrink}, 828, \[1015], 1018, 1042, 1043, 1046, 1047.
\:\\{add\_char\_shrink\_end}, \[1015].
\:\\{add\_char\_stretch}, 828, \[1015], 1018, 1042, 1043, 1046, 1047.
\:\\{add\_char\_stretch\_end}, \[1015].
\:\\{add\_delims\_to}, \[369].
\:\\{add\_disc\_width\_to\_active\_width}, \[1015], 1045.
\:\\{add\_disc\_width\_to\_break\_width}, \[1015], 1016.
\:\\{add\_glue\_ref}, \[221], 224, 456, 978, 1057, 1173, 1278, 1407, 1604,
1733, 1782, 1820.
\:\\{add\_kern\_shrink}, \[1015], 1018, 1042, 1046, 1047.
\:\\{add\_kern\_shrink\_end}, \[1015].
\:\\{add\_kern\_stretch}, \[1015], 1018, 1042, 1046, 1047.
\:\\{add\_kern\_stretch\_end}, \[1015].
\:\\{add\_or\_sub}, 1792, \[1793].
\:\\{add\_sa\_ptr}, \[1819].
\:\\{add\_sa\_ref}, 1399, 1402, \[1821], 1837, 1839, 1840.
\:\\{add\_token\_ref}, \[221], 224, 345, 1156, 1189, 1193, 1399, 1405, 1604,
1637, 1827, 1828, 1829, 1830.
\:\\{additional}, \[816], 817, 833, 848.
\:\\{adj\_demerits}, \[254], 1012, 1035.
\:\9{adj\_demerits\_}{\.{\\adjdemerits} primitive}, \[256].
\:\\{adj\_demerits\_code}, \[254], 255, 256.
\:\\{adjust}, \[603].
\:\\{adjust\_head}, \[180], 1065, 1066, 1254, 1263, 1377, 1383.
\:\\{adjust\_interword\_glue}, \[705], 1219.
\:\\{adjust\_node}, \[160], 166, 193, 201, 220, 224, 819, 825, 831, 906, 937,
1005, 1042, 1076, 1278.
\:\\{adjust\_pre}, \[160], 215, 831, 1278.
\:\\{adjust\_ptr}, \[160], 215, 220, 224, 831, 1278.
\:\\{adjust\_space\_factor}, \[1211], 1215.
\:\\{adjust\_tail}, \[819], 820, 823, 825, 831, 972, 1065, 1066, 1254, 1263,
1377.
\:\\{adjusted\_hbox\_group}, \[291], 1240, 1261, 1263, 1661, 1679.
\:\\{adv\_char\_width}, 687, \[690], 693, 726.
\:\\{adv\_char\_width\_s}, \[687], 690, 693.
\:\\{adv\_char\_width\_s\_out}, \[687], 690, 693.
\:\\{adv\_past}, \[1609].
\:\\{advance}, \[227], 287, 288, 1388, 1413, 1414, 1416.
\:\9{advance\_}{\.{\\advance} primitive}, \[287].
\:\\{advance\_major\_tail}, \[1091], 1094.
\:\\{after}, \[165], 210, 1374, 1728, 1739.
\:\\{after\_assignment}, \[226], 287, 288, 1446.
\:\9{after\_assignment\_}{\.{\\afterassignment} primitive}, \[287].
\:\\{after\_group}, \[226], 287, 288, 1449.
\:\9{after\_group\_}{\.{\\aftergroup} primitive}, \[287].
\:\\{after\_math}, 1371, \[1372].
\:\\{after\_token}, \[1444], 1445, 1446, 1447.
\:\\{aire}, \[586], 587, 589, 603.
\:\\{align\_error}, 1304, \[1305].
\:\\{align\_group}, \[291], 944, 950, 967, 976, 1309, 1310, 1661, 1679.
\:\\{align\_head}, \[180], 946, 953.
\:\\{align\_peek}, 949, 950, \[961], 975, 1226, 1311.
\:\\{align\_ptr}, \[946], 947, 948.
\:\\{align\_stack\_node\_size}, \[946], 948.
\:\\{align\_state}, 88, \[331], 346, 347, 348, 353, 361, 364, 369, 379, 420,
421, 422, 429, 468, 501, 508, 509, 512, 946, 947, 948, 950, 953, 959, 960, 961,
964, 965, 967, 1247, 1272, 1304, 1305.
\:\\{aligning}, \[327], 328, 361, 953, 965.
\:{alignment of rules with characters}, 616.
\:\\{allocvffnts}, 706, 715, 720.
\:\\{alpha}, \[586], 597, 599.
\:\\{alpha\_file}, \[25], 27, 28, 31, 32, 50, 54, 326, 506, 551, 1522.
\:\\{alpha\_token}, \[464], 466.
\:\\{alt\_rule}, \[1550], 1551, 1552, 1556, 1565.
\:\\{alter\_aux}, 1420, \[1421].
\:\\{alter\_box\_dimen}, 1420, \[1425].
\:\\{alter\_integer}, 1420, \[1424].
\:\\{alter\_page\_so\_far}, 1420, \[1423].
\:\\{alter\_prev\_graf}, 1420, \[1422].
\:\.{Ambiguous...}, 1361.
\:{Amble, Ole}, 1102.
\:\.{AmSTeX}, 1511.
\:\\{any\_mode}, \[1223], 1226, 1235, 1241, 1245, 1251, 1275, 1280, 1282, 1304,
1312, 1388, 1446, 1449, 1452, 1454, 1463, 1468, 1527.
\:\\{any\_state\_plus}, \[366], 367, 369.
\:\\{app\_display}, 1381, 1382, 1383, \[1744].
\:\\{app\_kern}, 1295.
\:\\{app\_lc\_hex}, \[48].
\:\\{app\_space}, 1207, \[1221].
\:\\{append\_bead}, \[1637].
\:\\{append\_char}, \[42], 48, 52, 58, 198, 213, 279, 542, 551, 706, 712, 717,
719, 726, 727, 868, 871, 1116.
\:\\{append\_charnode\_to\_t}, \[1085], 1088.
\:\\{append\_choices}, 1349, \[1350].
\:\\{append\_dest\_name}, \[698].
\:\\{append\_discretionary}, 1294, \[1295].
\:\\{append\_glue}, 1235, \[1238], 1256.
\:\\{append\_italic\_correction}, 1290, \[1291].
\:\\{append\_kern}, 1235, \[1239].
\:\\{append\_link}, 730, 783, 1632, 1635, \[1636].
\:\\{append\_list}, \[160], 975, 1065, 1254.
\:\\{append\_list\_end}, \[160].
\:\\{append\_nl}, 686.
\:\\{append\_normal\_space}, \[1207].
\:\\{append\_penalty}, 1280, \[1281].
\:\\{append\_ptr}, 698, \[700].
\:\\{append\_thread}, 739, \[1637].
\:\\{append\_to\_name}, \[545], 549.
\:\\{append\_to\_vlist}, \[855], 975, 1065, 1254, 1744.
\:\\{area\_delimiter}, \[539], 541, 542, 543.
\:\.{Argument of \\x has...}, 421.
\:\\{arith\_error}, \[104], 105, 106, 107, 112, 114, 474, 479, 486, 689, 1414,
1782, 1783, 1790, 1846.
\:\.{Arithmetic overflow}, 1414, 1782.
\:\\{artificial\_demerits}, \[1006], 1027, 1030, 1031, 1032.
\:{ASCII code}, 17, 529.
\:\\{ASCII\_code}, \[18], 19, 20, 29, 30, 31, 38, 42, 54, 58, 60, 82, 314, 363,
415, 542, 545, 549, 868, 1069, 1089, 1098, 1120, 1127, 1130, 1136, 1137, 1624.
\:\\{assign\_dimen}, \[227], 266, 267, 439, 1388, 1402, 1406.
\:\\{assign\_font\_dimen}, \[227], 287, 288, 439, 1388, 1431.
\:\\{assign\_font\_int}, \[227], 439, 1388, 1431, 1432, 1433.
\:\\{assign\_glue}, \[227], 244, 245, 439, 958, 1388, 1402, 1406.
\:\\{assign\_int}, \[227], 256, 257, 439, 1388, 1400, 1402, 1406, 1415, 1657,
1701.
\:\\{assign\_mu\_glue}, \[227], 244, 245, 439, 1388, 1400, 1402, 1406, 1415.
\:\\{assign\_toks}, \[227], 248, 249, 251, 345, 439, 441, 1388, 1402, 1404,
1405, 1657.
\:\\{assign\_trace}, \[299], 300, 301.
\:\.{at}, 1436.
\:\9{atop\_}{\.{\\atop} primitive}, \[1356].
\:\\{atop\_code}, \[1356], 1357, 1360.
\:\9{atop\_with\_delims\_}{\.{\\atopwithdelims} primitive}, \[1356].
\:\\{attach\_fraction}, \[474], 479, 480, 482.
\:\\{attach\_sign}, \[474], 475, 481.
\:\\{auto\_breaking}, \[999], 1038, 1039, 1042, 1044.
\:\\{auto\_expand}, 705.
\:\\{auto\_expand\_font}, \[705], 720.
\:\\{auto\_expand\_vf}, 712, \[720].
\:\\{auto\_kern}, \[173], 209, 705, 1005.
\:\\{aux}, 230, \[231], 234, 976, 988.
\:\\{aux\_field}, \[230], 231, 236, 951.
\:\\{aux\_save}, \[976], 988, 1384.
\:\\{avail}, \[136], 138, 139, 140, 141, 182, 186, 1489, 1490.
\:\.{AVAIL list clobbered...}, 186.
\:\\{avl\_find\_obj}, 1555.
\:\\{avl\_put\_obj}, 698.
\:\\{awful\_bad}, \[1009], 1010, 1011, 1012, 1030, 1050, 1147, 1151, 1152,
1164, 1182, 1183, 1184.
\:\\{axis\_height}, \[876], 882, 912, 922, 923, 925, 938.
\:\|{b}, \[388], \[490], \[491], \[496], \[524], \[549], \[586], \[624], %
\[855], \[881], \[882], \[885], \[887], \[891], \[1006], \[1147], \[1171], %
\[1376], \[1425], \[1466], \[1656], \[1744], \[1782].
\:\\{b\_close}, \[28], 586, 670, 712, 772, 794.
\:\\{b\_make\_name\_string}, \[551], 558, 684.
\:\\{b\_open\_in}, \[27], 589.
\:\\{b\_open\_out}, \[27], 558, 684.
\:\\{back\_error}, \[349], 399, 422, 429, 441, 468, 472, 502, 505, 529, 604,
959, 1256, 1262, 1339, 1375, 1385, 1390, 1765, 1769, 1784.
\:\\{back\_input}, 286, 303, \[347], 348, 349, 392, 393, 394, 398, 401, 405,
421, 431, 433, 441, 469, 470, 474, 478, 481, 487, 552, 964, 1208, 1225, 1232,
1242, 1268, 1273, 1302, 1305, 1310, 1316, 1328, 1330, 1331, 1393, 1399, 1404,
1447, 1623, 1784, 1785.
\:\\{back\_list}, \[345], 347, 359, 433, 1466.
\:\\{backed\_up}, \[329], 333, 334, 336, 345, 346, 347, 1203.
\:\\{background}, \[999], 1000, 1003, 1013, 1039, 1040, 1843.
\:\\{backup\_backup}, \[388].
\:\\{backup\_head}, \[180], 388, 433.
\:\.{BAD}, 315, 316.
\:\\{bad}, \[13], 14, 129, 312, 548, 1427, 1512.
\:\.{Bad \\patterns}, 1138.
\:\.{Bad \\prevgraf}, 1422.
\:\.{Bad character code}, 460.
\:\.{Bad delimiter code}, 463.
\:\.{Bad dump length}, 497.
\:\.{Bad file offset}, 497.
\:\.{Bad flag...}, 188.
\:\.{Bad interaction mode}, 1696.
\:\.{Bad link...}, 200.
\:\.{Bad match number}, 497.
\:\.{Bad mathchar}, 462.
\:\.{Bad number}, 461.
\:\.{Bad register code}, 459, 1811.
\:\.{Bad space factor}, 1421.
\:\\{bad\_fmt}, \[1481], 1484, 1486, 1490, 1495, 1507.
\:\\{bad\_pool}, \[51], 52, 53.
\:\\{bad\_tfm}, \[586].
\:\\{bad\_vf}, \[710], 712, 714, 717, 719, 725.
\:\\{badness}, \[108], 836, 843, 850, 854, 1004, 1028, 1029, 1152, 1184, 1847,
1848.
\:\9{badness\_}{\.{\\badness} primitive}, \[442].
\:\\{badness\_code}, \[442], 450.
\:\\{banner}, \[2], 61, 562, 1477.
\:\\{base\_line}, \[647], 651, 652, 656, \[729], 730, 733, 734, 737, 1645,
1646, 1647.
\:\\{base\_ptr}, 84, 85, \[332], 333, 334, 335, 1309, 1774, 1775, 1776.
\:\\{baseline\_skip}, \[242], 265, 855.
\:\9{baseline\_skip\_}{\.{\\baselineskip} primitive}, \[244].
\:\\{baseline\_skip\_code}, 167, \[242], 243, 244, 855.
\:\\{batch\_mode}, \[73], 75, 86, 90, 92, 93, 561, 1440, 1441, 1507, 1508, 1696.
\:\9{batch\_mode\_}{\.{\\batchmode} primitive}, \[1440].
\:\\{bc}, 566, 567, 569, 571, \[586], 591, 592, 596, 603, 706.
\:\\{bch\_label}, \[586], 600, 603.
\:\\{bchar}, \[586], 600, 603, \[1078], 1080, 1082, \[1083], 1085, 1088, 1090,
1093, 1094, \[1209], 1211, 1214, 1215, 1218.
\:\\{bchar\_label}, \[575], 578, 603, 705, 706, 1086, 1093, 1211, 1218, 1500,
1501.
\:\\{be\_careful}, \[112], 113, \[114].
\:\\{before}, \[165], 210, 1374, 1710, 1712, 1718, 1728, 1739.
\:\\{before\_rejected\_cur\_p}, \[999], 1039.
\:\&{begin}, 7, 8.
\:\\{begin\_box}, 1251, \[1257], 1262.
\:\\{begin\_diagnostic}, 76, \[263], 306, 321, 345, 426, 427, 528, 535, 608,
666, 669, 750, 839, 851, 1002, 1039, 1164, 1169, 1183, 1188, 1299, 1471, 1474,
1662, 1677, 1691, 1823.
\:\\{begin\_file\_reading}, 78, 87, \[350], 509, 563, 1755.
\:\\{begin\_group}, \[226], 287, 288, 1241.
\:\9{begin\_group\_}{\.{\\begingroup} primitive}, \[287].
\:\\{begin\_insert\_or\_adjust}, 1275, \[1277].
\:\\{begin\_L\_code}, \[165], 1701, 1702, 1734.
\:\\{begin\_LR\_type}, \[165], 1707.
\:\\{begin\_M}, 1258.
\:\\{begin\_M\_code}, \[165], 1258, 1746.
\:\\{begin\_name}, 538, \[541], 552, 553, 557.
\:\\{begin\_pseudoprint}, \[338], 340, 341.
\:\\{begin\_R\_code}, \[165], 1701, 1702.
\:\\{begin\_reflect}, 1700.
\:\\{begin\_token\_list}, \[345], 381, 384, 412, 416, 950, 964, 965, 975, 1202,
1207, 1261, 1269, 1317, 1323, 1345, 1618.
\:\9{beginL\_}{\.{\\beginL} primitive}, \[1701].
\:\.{Beginning to dump...}, 1508.
\:\9{beginR\_}{\.{\\beginR} primitive}, \[1701].
\:\\{below\_display\_short\_skip}, \[242].
\:\9{below\_display\_short\_skip\_}{\.{\\belowdisplayshortskip} primitive}, %
\[244].
\:\\{below\_display\_short\_skip\_code}, \[242], 243, 244, 1381.
\:\\{below\_display\_skip}, \[242].
\:\9{below\_display\_skip\_}{\.{\\belowdisplayskip} primitive}, \[244].
\:\\{below\_display\_skip\_code}, \[242], 243, 244, 1381, 1384.
\:\\{best\_bet}, \[1048], 1050, 1051, 1053, 1054, 1853.
\:\\{best\_height\_plus\_depth}, \[1148], 1151, 1187, 1188.
\:\\{best\_ins\_ptr}, \[1158], 1182, 1186, 1195, 1197, 1198.
\:\\{best\_line}, \[1048], 1050, 1051, 1053, 1065, 1067.
\:\\{best\_page\_break}, \[1157], 1182, 1190, 1191.
\:\\{best\_pl\_glue}, \[1842], 1850, 1851.
\:\\{best\_pl\_line}, \[1009], 1021, 1031.
\:\\{best\_pl\_short}, \[1842], 1850, 1851.
\:\\{best\_place}, \[1009], 1021, 1031, \[1147], 1151, 1157.
\:\\{best\_size}, \[1157], 1182, 1194.
\:\\{beta}, \[586], 597, 599.
\:\\{bf}, \[720].
\:\\{big\_op\_spacing1}, \[877], 927.
\:\\{big\_op\_spacing2}, \[877], 927.
\:\\{big\_op\_spacing3}, \[877], 927.
\:\\{big\_op\_spacing4}, \[877], 927.
\:\\{big\_op\_spacing5}, \[877], 927.
\:\\{big\_switch}, 227, 254, 1171, 1206, \[1207], 1208, 1213, 1219.
\:{BigEndian order}, \[566].
\:\\{biggest\_char}, \[275], 281.
\:\\{billion}, \[653].
\:\\{bin\_noad}, \[858], 866, 872, 874, 904, 905, 937, 1334, 1335.
\:\\{bin\_op\_penalty}, \[254], 937.
\:\9{bin\_op\_penalty\_}{\.{\\binoppenalty} primitive}, \[256].
\:\\{bin\_op\_penalty\_code}, \[254], 255, 256.
\:\\{blank\_line}, \[263].
\:\\{bool}, \[496], 497.
\:\\{boolean}, 27, 31, 37, 45, 46, 47, 76, 79, 96, 104, 106, 107, 112, 114,
183, 185, 263, 274, 303, 333, 383, 388, 389, 433, 439, 466, 474, 487, 496, 499,
524, 542, 550, 553, 575, 586, 605, 619, 647, 657, 673, 680, 686, 687, 689, 691,
693, 696, 698, 701, 702, 704, 705, 706, 720, 725, 729, 738, 749, 750, 793, 807,
817, 821, 823, 882, 895, 902, 967, 991, 999, 1001, 1004, 1005, 1006, 1053,
1077, 1084, 1127, 1137, 1145, 1166, 1189, 1209, 1229, 1232, 1257, 1269, 1283,
1338, 1372, 1389, 1414, 1459, 1481, 1513, 1522, 1537, 1550, 1555, 1628, 1640,
1656, 1660, 1661, 1662, 1756, 1774, 1776, 1782, 1793, 1797, 1799, 1819, 1825,
1842.
\:\\{bop}, 610, 612, \[613], 615, 617, 619, 666, 668.
\:{Bosshard, Hans Rudolf}, 484.
\:\\{bot}, \[572].
\:\\{bot\_mark}, \[408], 409, 1189, 1193, 1809, 1828.
\:\9{bot\_mark\_}{\.{\\botmark} primitive}, \[410].
\:\\{bot\_mark\_code}, \[408], 410, 411, 1809.
\:\9{bot\_marks\_}{\.{\\botmarks} primitive}, \[1809].
\:\\{bottom}, 693.
\:\\{bottom\_level}, \[291], 294, 303, 1242, 1246, 1661, 1679.
\:\\{bottom\_line}, \[333].
\:{bowels}, 619.
\:\\{box}, \[248], 250, 1169, 1170, 1186, 1192, 1194, 1195, 1198, 1200, 1205,
1820, 1821, 1839.
\:\9{box\_}{\.{\\box} primitive}, \[1249].
\:\\{box\_base}, \[248], 250, 251, 273, 1255.
\:\\{box\_code}, \[1249], 1250, 1257, 1285, 1288, 1861.
\:\\{box\_context}, \[1253], 1254, 1255, 1256, \[1257], 1261, \[1262].
\:\\{box\_end}, \[1253], 1257, 1262, 1264.
\:\\{box\_error}, \[1169], 1170, 1192, 1205.
\:\\{box\_flag}, \[1249], 1253, 1255, 1261, 1419, 1681.
\:\\{box\_lr}, 153, \[643], 1704, 1714, 1715, 1745.
\:\\{box\_max\_depth}, \[265], 1264.
\:\9{box\_max\_depth\_}{\.{\\boxmaxdepth} primitive}, \[266].
\:\\{box\_max\_depth\_code}, \[265], 266.
\:\\{box\_node\_size}, \[153], 154, 220, 224, 823, 844, 891, 903, 927, 932,
1154, 1198, 1278, 1288, 1379, 1733, 1745.
\:\\{box\_ref}, \[228], 250, 297, 1255.
\:\\{box\_there}, \[1157], 1164, 1177, 1178.
\:\\{box\_val}, 1402, \[1815], 1820, 1821, 1823, 1839.
\:\\{box\_val\_limit}, \[1815], 1838.
\:\9{box255}{\.{\\box255 is not void}}, 1192.
\:\.{bp}, 484.
\:\\{bp}, 690.
\:{brain}, 1206.
\:\\{breadth\_max}, \[199], 200, 216, 251, 254, 1005, 1519, 1823.
\:\\{break}, 34.
\:\\{break\_in}, 34.
\:\\{break\_node}, \[995], 1005, 1021, 1027, 1031, 1032, 1039, 1040, 1053, 1054.
\:\\{break\_penalty}, \[226], 287, 288, 1280.
\:\\{break\_type}, \[1005], 1013, 1021, 1022, 1035.
\:\\{break\_width}, \[999], 1000, 1013, 1014, 1015, 1017, 1018, 1019, 1020,
1055.
\:\\{breakpoint}, \[1518].
\:\\{broken\_ins}, \[1158], 1163, 1187, 1198.
\:\\{broken\_penalty}, \[254], 1067.
\:\9{broken\_penalty\_}{\.{\\brokenpenalty} primitive}, \[256].
\:\\{broken\_penalty\_code}, \[254], 255, 256.
\:\\{broken\_ptr}, \[1158], 1187, 1198.
\:\\{buf\_size}, \[11], 30, 31, 35, 71, 129, 286, 337, 350, 353, 363, 385, 388,
400, 550, 556, 560, 1514, 1756, 1768.
\:\\{buffer}, \[30], 31, 36, 37, 45, 71, 83, 87, 88, 278, 279, 280, 286, 324,
325, 337, 340, 353, 363, 365, 374, 376, 377, 378, 382, 384, 385, 388, 400, 509,
510, 549, 550, 556, 557, 560, 564, 1517, 1519, 1648, 1756, 1761, 1768.
\:\.{Buffer size exceeded}, 35.
\:\\{build\_choices}, 1351, \[1352].
\:\\{build\_discretionary}, 1296, \[1297].
\:\\{build\_page}, 976, 988, 1165, \[1171], 1203, 1232, 1238, 1254, 1269, 1272,
1278, 1281, 1323, 1378.
\:\.{by}, 1414.
\:\\{byname}, 1555, 1564.
\:\\{bypass\_eoln}, \[31].
\:\\{byte}, 702.
\:\\{byte\_file}, \[25], 27, 28, 551, 558, 565, 680, 710, 772.
\:\\{b0}, 128, \[131], 132, 151, 239, 275, 290, 571, 572, 576, 580, 582, 590,
629, 710, 712, 714, 859, 861, 1098, 1135, 1487, 1488, 1754, 1756.
\:\\{b1}, 128, \[131], 132, 151, 239, 275, 290, 571, 572, 580, 582, 590, 629,
710, 712, 714, 859, 861, 1098, 1135, 1487, 1488, 1754, 1756.
\:\\{b2}, 128, \[131], 132, 571, 572, 580, 582, 590, 629, 710, 712, 714, 859,
861, 1487, 1488, 1754, 1756.
\:\\{b3}, 128, \[131], 132, 571, 572, 582, 590, 629, 710, 712, 714, 859, 861,
1487, 1488, 1754, 1756.
\:\|{c}, \[47], \[63], \[82], \[162], \[286], \[296], \[314], \[363], \[491], %
\[496], \[542], \[545], \[549], \[586], \[604], \[608], \[609], \[619], \[705],
\[817], \[868], \[870], \[882], \[885], \[887], \[888], \[914], \[925], %
\[1070], \[1089], \[1130], \[1136], \[1137], \[1171], \[1189], \[1264], %
\[1279], \[1288], \[1295], \[1314], \[1329], \[1333], \[1359], \[1421], %
\[1423], \[1424], \[1425], \[1453], \[1457], \[1466], \[1515], \[1679], \[1777].
\:\\{c\_leaders}, \[167], 208, 655, 664, 1249, 1250.
\:\9{c\_leaders\_}{\.{\\cleaders} primitive}, \[1249].
\:\\{c\_loc}, \[1089], 1093.
\:\\{c\_node}, 1295.
\:\\{cal\_expand\_ratio}, \[823], 825, 828, 834, 840, 1066.
\:\\{cal\_margin\_kern\_var}, \[822].
\:\\{call}, \[228], 241, 297, 318, 388, 406, 413, 421, 422, 504, 533, 1396,
1399, 1403, 1404, 1405, 1473, 1772.
\:\\{call\_func}, \[687], 692, 712, 714, 1537.
\:\\{cancel\_boundary}, 1207, \[1209], 1210, 1211.
\:\\{cancel\_glue}, \[1746].
\:\\{cancel\_glue\_cont}, \[1746].
\:\\{cancel\_glue\_cont\_cont}, \[1746].
\:\\{cancel\_glue\_end}, \[1746].
\:\\{cancel\_glue\_end\_end}, \[1746].
\:\.{cannot \\read}, 510.
\:\\{car\_ret}, \[225], 250, 364, 369, 953, 956, 957, 959, 960, 961, 964, 1304.
\:\\{carriage\_return}, \[22], 49, 225, 250, 258, 385.
\:\\{case\_shift}, \[226], 1463, 1464, 1465.
\:\\{cat}, \[363], 376, 377, 378.
\:\\{cat\_code}, \[248], 250, 254, 284, 363, 365, 376, 377, 378, 1517.
\:\9{cat\_code\_}{\.{\\catcode} primitive}, \[1408].
\:\\{cat\_code\_base}, \[248], 250, 251, 253, 1408, 1409, 1411.
\:\\{cc}, \[363], 374, 377, 712, 717, 718.
\:\.{cc}, 484.
\:\\{change\_box}, 1154, 1257, 1288, 1548, \[1821].
\:\\{change\_if\_limit}, \[523], 524, 535.
\:\\{char}, 19, 26, 546, 560.
\:\9{char\_}{\.{\\char} primitive}, \[287].
\:\\{char\_base}, \[576], 578, 580, 592, 596, 603, 705, 706, 1500, 1501.
\:\\{char\_box}, \[885], 886, 887, 914.
\:\9{char\_def\_}{\.{\\chardef} primitive}, \[1400].
\:\\{char\_def\_code}, \[1400], 1401, 1402.
\:\\{char\_depth}, \[580], 673, 828, 884, 885, 888, 1671.
\:\\{char\_depth\_end}, \[580].
\:\\{char\_exists}, \[580], 600, 603, 604, 609, 673, 705, 884, 898, 914, 916,
925, 931, 1213, 1769.
\:\\{char\_given}, \[226], 439, 1112, 1207, 1215, 1268, 1302, 1329, 1332, 1400,
1401, 1402.
\:\\{char\_height}, \[580], 673, 828, 884, 885, 888, 1303, 1671.
\:\\{char\_height\_end}, \[580].
\:\\{char\_info}, 569, 576, \[580], 581, 583, 596, 600, 603, 604, 609, 648,
673, 690, 705, 717, 726, 731, 823, 828, 884, 885, 888, 890, 891, 898, 900, 914,
916, 925, 1017, 1018, 1042, 1043, 1046, 1047, 1086, 1213, 1214, 1216, 1218,
1291, 1301, 1303, 1325, 1671, 1724, 1769.
\:\\{char\_info\_end}, \[580].
\:\\{char\_info\_word}, 567, \[569], 570.
\:\\{char\_italic}, \[580], 885, 890, 925, 931, 1291, 1671.
\:\\{char\_italic\_end}, \[580].
\:\\{char\_kern}, \[583], 823, 917, 929, 1086, 1218.
\:\\{char\_kern\_end}, \[583].
\:\\{char\_map\_array}, 707.
\:\\{char\_move}, 725, 726.
\:\\{char\_node}, \[152], 161, 163, 180, 194, 574, 619, 648, 823, 928, 1057,
1084, 1206, 1291, 1316.
\:\\{char\_num}, \[226], 287, 288, 1112, 1207, 1215, 1268, 1302, 1329, 1332.
\:\\{char\_pw}, \[823], 825.
\:\\{char\_shrink}, \[823], 1015.
\:\\{char\_stretch}, \[823], 1015.
\:\\{char\_tag}, \[580], 596, 604, 705, 823, 884, 886, 916, 917, 925, 928,
1086, 1216.
\:\\{char\_used\_array}, 707, 708.
\:\\{char\_warning}, \[608], 609, 726, 731, 898, 1213.
\:\\{char\_width}, \[580], 648, 673, 690, 717, 726, 731, 823, 828, 885, 890,
891, 916, 1017, 1018, 1042, 1043, 1046, 1047, 1301, 1303, 1325, 1671, 1724.
\:\\{char\_width\_end}, \[580].
\:\\{character}, \[152], 161, 162, 192, 194, 224, 609, 648, 674, 705, 731, 822,
823, 825, 828, 857, 858, 859, 863, 867, 885, 891, 898, 900, 925, 928, 929,
1017, 1018, 1042, 1043, 1046, 1047, 1073, 1074, 1075, 1080, 1084, 1085, 1087,
1088, 1209, 1211, 1212, 1213, 1214, 1215, 1218, 1291, 1301, 1303, 1325, 1329,
1333, 1343, 1724, 1733.
\:{character set dependencies}, 23, 49.
\:{check sum}, 53, 568, 615.
\:\\{check\_byte\_range}, \[596], 600.
\:\\{check\_dimensions}, \[902], 903, 909, 930.
\:\\{check\_effective\_tail}, \[1258], 1283.
\:\\{check\_existence}, \[600], 601.
\:\\{check\_expand\_pars}, \[823], 1017, 1018, 1042, 1043, 1046, 1047.
\:\\{check\_full\_save\_stack}, \[295], 296, 298, 302, 1837.
\:\\{check\_image\_b}, 768.
\:\\{check\_image\_c}, 768.
\:\\{check\_image\_i}, 768.
\:\\{check\_interrupt}, \[96], 346, 365, 929, 1088, 1208, 1218.
\:\\{check\_mem}, 183, \[185], 1208, 1519.
\:\\{check\_outer\_validity}, \[358], 373, 375, 376, 379, 384, 401.
\:\\{check\_pdfoutput}, \[1537], 1538, 1539, 1540, 1541, 1542, 1544, 1546,
1548, 1549, 1553, 1554, 1558, 1560, 1561, 1563, 1565, 1567, 1568, 1569, 1572,
1574, 1575, 1578, 1579, 1580, 1581, 1582, 1588, 1589, 1590, 1591, 1593, 1594,
1595, 1596, 1597, 1598, 1599.
\:\\{check\_pdfversion}, \[683], 698, 792, 1553.
\:\\{check\_shrinkage}, \[1001], 1003, 1044.
\:\\{checkpdfrestore}, 727.
\:\\{checkpdfsave}, 727.
\:{Chinese characters}, 152, 612.
\:\\{choice\_node}, 864, \[865], 866, 874, 906.
\:\\{choose\_mlist}, \[907].
\:\\{chr}, 19, 20, 23, 24, 1400.
\:\\{chr\_cmd}, \[320], 957.
\:\\{chr\_code}, 245, 249, 257, 267, 288, \[320], 403, 411, 437, 439, 443, 495,
514, 518, 957, 1161, 1231, 1237, 1249, 1250, 1267, 1286, 1293, 1321, 1335,
1348, 1357, 1367, 1387, 1398, 1401, 1409, 1429, 1433, 1439, 1441, 1451, 1456,
1465, 1467, 1470, 1473, 1526, 1687, 1693, 1698, 1702, 1748, 1771, 1832, 1833,
1861, 1862.
\:\\{clang}, 230, \[231], 988, 1211, 1269, 1378, 1624, 1625.
\:\\{clean\_box}, \[896], 910, 911, 913, 914, 918, 920, 925, 926, 933, 934, 935.
\:\\{clear\_for\_error\_prompt}, 78, 83, \[352], 368.
\:\\{clear\_terminal}, \[34], 352, 556, 1518.
\:\\{clobbered}, \[185], 186, 187.
\:\.{CLOBBERED}, 315.
\:\\{close}, 28.
\:\\{close\_files\_and\_terminate}, 78, 81, 1512, \[1513].
\:\9{close\_in\_}{\.{\\closein} primitive}, \[1450].
\:\\{close\_noad}, \[858], 866, 872, 874, 904, 937, 938, 1334, 1335.
\:\\{close\_node}, \[1521], 1524, 1526, 1528, 1603, 1604, 1605, 1620, 1622,
1623.
\:\9{close\_out\_}{\.{\\closeout} primitive}, \[1524].
\:\\{closed}, \[506], 507, 509, 511, 512, 527, 1453.
\:\\{clr}, \[913], \[919], 921, 922, \[932], 933, 934, 935.
\:\9{club\_penalties\_}{\.{\\clubpenalties} primitive}, \[1864].
\:\\{club\_penalties\_loc}, \[248], 1864, 1865.
\:\\{club\_penalties\_ptr}, 1067, \[1864].
\:\\{club\_penalty}, \[254], 1067.
\:\9{club\_penalty\_}{\.{\\clubpenalty} primitive}, \[256].
\:\\{club\_penalty\_code}, \[254], 255, 256.
\:\.{cm}, 484.
\:\\{cmd}, \[320], \[712], 715, 717, 719, 725, 726, 727, 1400, 1467, 1473, 1832.
\:\\{cmd\_length}, 712, 714, 717, 719.
\:\\{co\_backup}, \[388].
\:\\{code}, 673.
\:\.{Color stack action is missing}, 1539.
\:\\{colorspace}, 1552.
\:\\{colorstack\_current}, \[695], 727, 1539, 1603.
\:\\{colorstack\_data}, \[695], 1539, 1603, 1604, 1605.
\:\\{colorstack\_pop}, \[695], 727, 1539, 1603.
\:\\{colorstack\_push}, \[695], 727, 1539, 1603.
\:\\{colorstack\_set}, \[695], 727, 1539, 1603.
\:\\{colorstackcurrent}, 727.
\:\\{colorstackpop}, 727.
\:\\{colorstackpush}, 727.
\:\\{colorstackset}, 727.
\:\\{colorstackskippagestart}, 727.
\:\\{colorstackused}, 727, 1539.
\:\\{combine\_two\_deltas}, \[1036].
\:\\{comment}, \[225], 250, 369.
\:\\{common\_ending}, \[15], 524, 526, 535, 823, 836, 842, 843, 844, 850, 853,
854, 1072, 1080, 1435, 1438, 1471, 1472, 1475, 1712.
\:\\{compare\_strings}, 497, \[1537].
\:\.{Completed box...}, 666, 750.
\:\\{compress\_trie}, \[1126], 1129.
\:\\{concat\_tokens}, \[1577], 1578, 1579, 1580, 1581, 1582.
\:\\{cond\_math\_glue}, \[167], 207, 908, 1349.
\:\\{cond\_ptr}, 321, 350, 384, \[515], 516, 521, 522, 523, 524, 526, 535,
1515, 1668, 1691, 1773, 1776, 1777.
\:\\{conditional}, 388, 391, \[524].
\:\\{confusion}, \[95], 112, 220, 224, 303, 523, 658, 693, 727, 740, 831, 845,
904, 912, 930, 937, 942, 967, 974, 976, 1017, 1018, 1042, 1046, 1047, 1053,
1145, 1150, 1177, 1246, 1258, 1363, 1378, 1389, 1528, 1603, 1604, 1605, 1620,
1637, 1712, 1725, 1730, 1745.
\:\\{continental\_point\_token}, \[464], 474.
\:\\{continue}, \[15], 82, 83, 84, 88, 89, 415, 418, 419, 420, 421, 423, 499,
500, 502, 725, 726, 749, 823, 882, 884, 950, 960, 991, 1005, 1008, 1027, 1073,
1083, 1086, 1087, 1088, 1171, 1178, 1782, 1783.
\:\\{contrib\_head}, \[180], 233, 236, 1165, 1171, 1172, 1175, 1176, 1178,
1194, 1200, 1203.
\:\\{contrib\_tail}, \[1172], 1194, 1200, 1203.
\:\\{contribute}, \[1171], 1174, 1177, 1179, 1185, 1611.
\:\\{conv\_toks}, 388, 391, \[496].
\:{conventions for representing stacks}, 322.
\:\\{convert}, \[228], 388, 391, 494, 495, 496, 1649.
\:\\{convert\_to\_break\_width}, \[1019].
\:\9{copy\_}{\.{\\copy} primitive}, \[1249].
\:\\{copy\_code}, \[1249], 1250, 1257, 1285, 1286, 1288, 1859, 1861.
\:\\{copy\_expand\_params}, \[705], 720.
\:\\{copy\_font\_info}, \[706].
\:\\{copy\_node\_list}, 179, 221, \[222], 224, 1257, 1288, 1635, 1636, 1745.
\:\\{copy\_to\_cur\_active}, \[1005], 1037.
\:\\{count}, \[254], 453, 666, 668, 750, 1163, 1185, 1186, 1187.
\:\9{count\_}{\.{\\count} primitive}, \[437].
\:\\{count\_base}, \[254], 257, 260, 1402, 1415.
\:\9{count\_def\_}{\.{\\countdef} primitive}, \[1400].
\:\\{count\_def\_code}, \[1400], 1401, 1402.
\:\\{count\_do\_snapy}, \[1570], 1571, 1637.
\:\\{cp}, 822, 1005.
\:\\{cp\_skipable}, 498, \[1005].
\:\9{cr\_}{\.{\\cr} primitive}, \[956].
\:\\{cr\_code}, \[956], 957, 965, 967, 968.
\:\9{cr\_cr\_}{\.{\\crcr} primitive}, \[956].
\:\\{cr\_cr\_code}, \[956], 961, 965.
\:\\{cramped}, \[864], 878.
\:\\{cramped\_style}, \[878], 910, 913, 914.
\:\\{creationdate\_given}, 807.
\:\\{Creator}, 807.
\:\\{creator\_given}, 807.
\:\\{cs}, 712.
\:\\{cs\_count}, \[274], 277, 279, 1496, 1497, 1514.
\:\\{cs\_error}, 1312, \[1313].
\:\\{cs\_name}, \[228], 287, 288, 388, 391.
\:\9{cs\_name\_}{\.{\\csname} primitive}, \[287].
\:\\{cs\_token\_flag}, 286, \[311], 312, 315, 356, 358, 359, 361, 379, 380,
387, 393, 394, 395, 398, 401, 405, 406, 407, 466, 468, 492, 532, 956, 1223,
1243, 1310, 1393, 1467, 1492, 1618.
\:\\{cur\_active\_width}, \[999], 1000, 1005, 1008, 1013, 1019, 1020, 1027,
1028, 1029, 1036, 1846, 1847, 1848, 1849.
\:\\{cur\_align}, \[946], 947, 948, 953, 954, 955, 959, 962, 964, 965, 967,
968, 971, 972, 974.
\:\\{cur\_area}, \[538], 543, 555, 556, 563, 772, 1435, 1438, 1531, 1622.
\:\\{cur\_boundary}, 292, \[293], 294, 296, 304, 350, 384, 1679, 1773, 1774,
1777.
\:\\{cur\_box}, \[1252], 1253, 1254, 1255, 1256, 1257, 1258, 1259, 1260, 1262,
1264, 1265, 1839.
\:\\{cur\_break}, \[997], 1005, 1021, 1027, 1055, 1056, 1057, 1707.
\:\\{cur\_c}, 898, 899, \[900], 914, 925, 928, 929, 931.
\:\\{cur\_chr}, 88, 286, 318, \[319], 321, 354, 359, 363, 365, 370, 371, 373,
374, 375, 376, 377, 378, 379, 380, 381, 382, 386, 387, 391, 394, 395, 404, 406,
407, 412, 413, 415, 429, 433, 439, 450, 454, 468, 491, 496, 498, 500, 502, 504,
505, 509, 520, 521, 524, 526, 527, 532, 533, 534, 535, 536, 552, 604, 958, 961,
965, 1112, 1114, 1139, 1207, 1211, 1213, 1215, 1223, 1227, 1236, 1238, 1239,
1244, 1251, 1257, 1261, 1268, 1270, 1271, 1279, 1283, 1284, 1288, 1295, 1302,
1306, 1318, 1320, 1329, 1330, 1332, 1333, 1336, 1337, 1338, 1349, 1359, 1369,
1389, 1390, 1391, 1395, 1396, 1399, 1402, 1403, 1404, 1405, 1406, 1410, 1411,
1412, 1415, 1421, 1423, 1424, 1425, 1426, 1430, 1431, 1443, 1453, 1457, 1466,
1471, 1515, 1528, 1530, 1623, 1674, 1688, 1696, 1703, 1749, 1761, 1765, 1772,
1863.
\:\\{cur\_cmd}, 88, 229, 286, 318, \[319], 321, 354, 359, 363, 364, 365, 366,
370, 371, 373, 375, 376, 379, 380, 382, 386, 387, 388, 391, 392, 394, 395, 398,
406, 407, 412, 413, 429, 430, 432, 433, 439, 441, 454, 466, 468, 469, 470, 474,
478, 481, 487, 489, 500, 503, 504, 505, 509, 520, 527, 532, 533, 552, 604, 953,
958, 959, 960, 961, 964, 965, 967, 1112, 1138, 1206, 1207, 1215, 1223, 1227,
1244, 1256, 1257, 1262, 1273, 1277, 1302, 1306, 1316, 1329, 1330, 1338, 1343,
1354, 1355, 1375, 1384, 1389, 1390, 1391, 1399, 1404, 1405, 1406, 1414, 1415,
1430, 1448, 1623, 1683, 1703, 1765, 1766, 1767, 1772, 1784.
\:\\{cur\_cs}, \[319], 354, 355, 358, 359, 360, 363, 373, 375, 376, 378, 379,
380, 387, 394, 395, 398, 400, 405, 406, 407, 415, 417, 433, 498, 499, 527, 533,
706, 950, 1223, 1330, 1393, 1396, 1399, 1402, 1403, 1404, 1435, 1472, 1532,
1537, 1618, 1683, 1767, 1768.
\:\\{cur\_delta\_h}, \[691].
\:\\{cur\_dir}, 643, 651, 654, 656, 660, 661, 665, 733, 736, 737, 742, 743,
746, \[1705], 1706, 1714, 1715, 1717, 1720, 1722, 1728, 1730, 1734, 1735, 1736,
1737, 1738, 1739.
\:\\{cur\_ext}, \[538], 543, 555, 556, 563, 772, 1453, 1531, 1622.
\:\\{cur\_f}, 898, \[900], 914, 917, 925, 928, 929, 931.
\:\\{cur\_fam}, \[254], 1329, 1333, 1343.
\:\\{cur\_fam\_code}, \[254], 255, 256, 1317, 1323.
\:\\{cur\_file}, \[326], 351, 384, 563, 564, 1755.
\:\\{cur\_font}, \[248], 250, 584, 585, 604, 1209, 1211, 1220, 1222, 1295,
1301, 1302, 1734.
\:\\{cur\_font\_loc}, \[248], 250, 251, 252, 1395.
\:\\{cur\_font\_step}, 823, \[999], 1003, 1027.
\:\\{cur\_g}, \[647], 653, \[657], 662, \[729], 735, \[738], 744, 1637, 1638,
1699, 1721, 1722, \[1723].
\:\\{cur\_glue}, \[647], 653, \[657], 662, \[729], 735, \[738], 744, 1637,
1638, 1699, 1721, 1722, \[1723].
\:\\{cur\_group}, 292, \[293], 294, 296, 303, 304, 976, 1240, 1241, 1242, 1243,
1245, 1246, 1247, 1308, 1309, 1318, 1320, 1369, 1370, 1371, 1372, 1378, 1661,
1665, 1679, 1777.
\:\\{cur\_h}, \[643], 645, 646, 647, 648, 650, 651, 654, 655, 656, 657, 660,
661, 665, 691, 692, 693, 725, 726, 727, 729, 731, 732, 733, 734, 736, 737, 738,
742, 743, 746, 752, 1621, 1630, 1635, 1637, 1641, 1642, 1643, 1644, 1646, 1647,
1714, 1716, 1719, 1720, 1721, 1722, 1724, 1725, 1729.
\:\\{cur\_h\_offset}, 644, 752, 755, \[1628].
\:\\{cur\_head}, \[946], 947, 948, 962, 975.
\:\\{cur\_height}, \[1147], 1149, 1150, 1151, 1152, 1153, 1612.
\:\\{cur\_i}, 898, 899, \[900], 914, 917, 925, 928, 929, 931.
\:\\{cur\_if}, 321, 358, \[515], 516, 521, 522, 1515, 1668, 1691, 1776, 1777.
\:\\{cur\_indent}, \[1053], 1066.
\:\\{cur\_input}, 35, 36, 87, \[323], 324, 333, 343, 344, 560, 1309, 1774, 1776.
\:\\{cur\_l}, \[1084], 1085, 1086, 1087, 1088, 1209, 1211, 1212, 1213, 1214,
1216, 1218.
\:\\{cur\_lang}, 1068, \[1069], 1100, 1101, 1107, 1111, 1116, 1121, 1140, 1269,
1378, 1609, 1610, 1855, 1858.
\:\\{cur\_length}, \[41], 198, 200, 279, 281, 542, 551, 645, 727, 868, 1615.
\:\\{cur\_level}, 292, \[293], 294, 296, 299, 300, 302, 303, 1482, 1515, 1661,
1665, 1679, 1777, 1837, 1839.
\:\\{cur\_line}, \[1053], 1065, 1066, 1067.
\:\\{cur\_list}, \[231], 234, 235, 236, 448, 1422, 1679.
\:\\{cur\_loop}, \[946], 947, 948, 953, 959, 968, 969, 970.
\:\\{cur\_mark}, 318, \[408], 412, 1515, 1809.
\:\\{cur\_mlist}, \[895], 896, 902, 930, 1372, 1374, 1377.
\:\\{cur\_mu}, 879, \[895], 906, 908, 942.
\:\\{cur\_name}, \[538], 543, 555, 556, 563, 772, 1435, 1436, 1438, 1531, 1622.
\:\\{cur\_order}, 388, 465, \[473], 474, 480, 488.
\:\\{cur\_p}, 999, \[1004], 1005, 1006, 1009, 1013, 1015, 1016, 1021, 1027,
1028, 1029, 1031, 1032, 1033, 1034, 1035, 1036, 1038, 1039, 1041, 1042, 1043,
1044, 1045, 1048, 1053, 1054, 1055, 1056, 1057, 1071, 1080, 1609, 1707, 1849,
1852.
\:\\{cur\_page\_height}, 644, 693, 727, 752, 755, 769, 780, 1621, \[1628],
1630, 1635, 1641.
\:\\{cur\_page\_width}, 644, 755, 769, \[1628].
\:\\{cur\_pos}, 1637.
\:\\{cur\_pre\_head}, \[946], 947, 948, 962, 975.
\:\\{cur\_pre\_tail}, \[946], 947, 948, 962, 972, 975.
\:\\{cur\_ptr}, 412, 441, 453, 1402, 1404, 1405, 1415, 1815, \[1816], 1819,
1820, 1821, 1824, 1825, 1827, 1830, 1831, 1839.
\:\\{cur\_q}, \[1084], 1085, 1087, 1088, 1211, 1212, 1213, 1214, 1218.
\:\\{cur\_r}, \[1084], 1085, 1086, 1087, 1088, 1209, 1211, 1214, 1215, 1216,
1218.
\:\\{cur\_rh}, \[1083], 1085, 1086, 1087.
\:\\{cur\_s}, 620, \[643], 647, 657, 668, 670, 729, 730, 738, 739, 751, 1635,
1637.
\:\\{cur\_size}, 876, 877, 879, \[895], 898, 899, 908, 912, 913, 920, 922, 923,
924, 925, 933, 934, 935, 938.
\:\\{cur\_span}, \[946], 947, 948, 963, 972, 974.
\:\\{cur\_style}, 879, \[895], 896, 902, 903, 906, 907, 910, 911, 913, 914,
918, 920, 921, 922, 924, 925, 926, 930, 932, 933, 934, 935, 936, 938, 939, 942,
1372, 1374, 1377.
\:\\{cur\_tail}, \[946], 947, 948, 962, 972, 975.
\:\\{cur\_tok}, 88, 286, 303, \[319], 347, 348, 349, 358, 386, 387, 388, 392,
393, 394, 395, 398, 401, 405, 406, 407, 418, 419, 420, 421, 423, 425, 429, 431,
433, 466, 467, 468, 470, 471, 474, 478, 500, 502, 503, 505, 509, 520, 529, 532,
959, 960, 1215, 1223, 1225, 1273, 1305, 1306, 1310, 1393, 1399, 1446, 1447,
1449, 1618, 1619, 1683, 1761, 1767, 1769, 1772, 1784, 1785.
\:\\{cur\_v}, \[643], 646, 647, 651, 652, 656, 657, 659, 660, 661, 663, 664,
665, 668, 692, 693, 725, 726, 727, 729, 733, 734, 737, 738, 741, 742, 743, 745,
746, 752, 1621, 1630, 1637, 1641, 1642, 1643, 1644, 1646, 1647.
\:\\{cur\_v\_offset}, 644, 752, 755, \[1628].
\:\\{cur\_val}, 286, 287, 356, 388, 412, \[436], 439, 440, 441, 445, 446, 447,
449, 450, 451, 452, 453, 455, 456, 457, 459, 460, 461, 462, 463, 464, 465, 466,
468, 470, 471, 473, 474, 476, 477, 479, 481, 483, 484, 486, 487, 488, 489, 491,
492, 497, 498, 508, 517, 527, 529, 530, 535, 579, 604, 605, 606, 607, 693, 705,
706, 720, 817, 956, 958, 1112, 1154, 1207, 1215, 1238, 1239, 1251, 1255, 1260,
1277, 1279, 1281, 1301, 1302, 1329, 1332, 1338, 1339, 1343, 1360, 1366, 1402,
1403, 1404, 1405, 1406, 1407, 1410, 1412, 1414, 1415, 1416, 1417, 1418, 1419,
1421, 1422, 1423, 1424, 1425, 1426, 1431, 1436, 1437, 1453, 1474, 1524, 1530,
1537, 1539, 1544, 1546, 1549, 1552, 1554, 1556, 1558, 1563, 1565, 1566, 1573,
1575, 1585, 1587, 1589, 1593, 1625, 1651, 1665, 1668, 1671, 1674, 1683, 1688,
1694, 1696, 1769, 1780, 1782, 1785, 1803, 1804, 1811, 1819, 1820, 1821, 1824,
1839, 1866.
\:\\{cur\_val\_level}, 388, \[436], 439, 441, 445, 446, 447, 449, 450, 453,
455, 456, 465, 475, 477, 481, 487, 491, 492, 497, 1537, 1674, 1780, 1782.
\:\\{cur\_width}, \[1053], 1066.
\:{current page}, 1157.
\:\\{current\_character\_being\_worked\_on}, \[596].
\:\9{current\_group\_level\_}{\.{\\currentgrouplevel} primitive}, \[1663].
\:\\{current\_group\_level\_code}, \[1663], 1664, 1665.
\:\9{current\_group\_type\_}{\.{\\currentgrouptype} primitive}, \[1663].
\:\\{current\_group\_type\_code}, \[1663], 1664, 1665.
\:\9{current\_if\_branch\_}{\.{\\currentifbranch} primitive}, \[1666].
\:\\{current\_if\_branch\_code}, \[1666], 1667, 1668.
\:\9{current\_if\_level\_}{\.{\\currentiflevel} primitive}, \[1666].
\:\\{current\_if\_level\_code}, \[1666], 1667, 1668.
\:\9{current\_if\_type\_}{\.{\\currentiftype} primitive}, \[1666].
\:\\{current\_if\_type\_code}, \[1666], 1667, 1668.
\:\\{cv\_backup}, \[388].
\:\\{cvl\_backup}, \[388].
\:\\{c1}, 793.
\:\\{c2}, 793.
\:\|{d}, \[107], \[194], \[195], \[278], \[363], \[466], \[586], \[689], %
\[823], \[844], \[855], \[882], \[991], \[1006], \[1053], \[1121], \[1147], %
\[1246], \[1264], \[1316], \[1376], \[1683], \[1744], \[1797], \[1799].
\:\\{d\_fixed}, \[635], 636.
\:\\{danger}, \[1372], 1373, 1377.
\:\\{data}, \[228], 250, 1395, 1410, 1412.
\:{data structure assumptions}, \[179], 182, 222, \[643], 992, 1145, 1158,
1467, 1733.
\:\\{day}, \[254], 259, 645, 792, 1508.
\:\9{day\_}{\.{\\day} primitive}, \[256].
\:\\{day\_code}, \[254], 255, 256.
\:\.{dd}, 484.
\:\\{dd}, 689, 690.
\:\\{deactivate}, \[1005], 1027, 1030.
\:\\{dead\_cycles}, 445, \[619], 620, 666, 750, 1189, 1201, 1202, 1232, 1420,
1424.
\:\9{dead\_cycles\_}{\.{\\deadcycles} primitive}, \[442].
\:\&{debug}, \[7], \[9], \[78], \[84], \[93], \[132], \[183], \[184], \[185], %
\[190], \[1208], \[1518].
\:\.{debug \#}, 1518.
\:\\{debug\_help}, 78, 84, 93, \[1518].
\:{debugging}, 7, 84, 96, 132, 183, 200, 1208, 1518.
\:\\{decent\_fit}, \[993], 1010, 1028, 1029, 1040, 1847, 1848.
\:\\{decr}, \[16], 42, 44, 64, 71, 86, 88, 89, 90, 92, 102, 124, 138, 139, 141,
193, 195, 218, 219, 223, 235, 263, 279, 282, 303, 304, 333, 344, 346, 347, 348,
351, 353, 369, 378, 379, 382, 384, 420, 425, 448, 455, 468, 496, 503, 509, 520,
535, 560, 564, 594, 603, 628, 647, 657, 666, 670, 671, 674, 686, 690, 698, 702,
712, 717, 719, 725, 726, 729, 738, 750, 793, 892, 893, 979, 984, 1005, 1016,
1034, 1045, 1059, 1092, 1093, 1107, 1108, 1117, 1121, 1125, 1142, 1238, 1298,
1305, 1309, 1352, 1364, 1372, 1422, 1471, 1489, 1515, 1517, 1536, 1635, 1679,
1683, 1691, 1728, 1733, 1739, 1754, 1756, 1774, 1775, 1776, 1777, 1780, 1782,
1819, 1821.
\:\\{def}, \[227], 1386, 1387, 1388, 1391, 1396.
\:\9{def\_}{\.{\\def} primitive}, \[1386].
\:\\{def\_code}, \[227], 439, 1388, 1408, 1409, 1410.
\:\\{def\_family}, \[227], 439, 604, 1388, 1408, 1409, 1412.
\:\\{def\_font}, \[227], 287, 288, 439, 604, 1388, 1434.
\:\\{def\_ref}, \[327], 328, 496, 497, 499, 508, 727, 1137, 1279, 1396, 1404,
1457, 1466, 1532, 1534, 1537, 1538, 1539, 1540, 1544, 1548, 1552, 1556, 1558,
1563, 1565, 1566, 1578, 1579, 1580, 1581, 1582, 1587, 1589, 1590, 1591, 1599,
1615, 1617, 1683.
\:\\{def\_tounicode}, 1587.
\:\\{default\_code}, \[859], 873, 919, 1360.
\:\\{default\_hyphen\_char}, \[254], 603.
\:\9{default\_hyphen\_char\_}{\.{\\defaulthyphenchar} primitive}, \[256].
\:\\{default\_hyphen\_char\_code}, \[254], 255, 256.
\:\\{default\_res}, 1552.
\:\\{default\_rule}, \[489].
\:\\{default\_rule\_thickness}, 859, \[877], 910, 911, 913, 919, 921, 935.
\:\\{default\_skew\_char}, \[254], 603.
\:\9{default\_skew\_char\_}{\.{\\defaultskewchar} primitive}, \[256].
\:\\{default\_skew\_char\_code}, \[254], 255, 256.
\:{defecation}, 624.
\:\\{define}, 706, 1255, \[1392], 1395, 1396, 1399, 1402, 1403, 1406, 1410,
1412, 1426, 1435, 1839.
\:\\{defining}, \[327], 328, 361, 499, 508.
\:\\{del\_code}, \[254], 258, 1338.
\:\9{del\_code\_}{\.{\\delcode} primitive}, \[1408].
\:\\{del\_code\_base}, \[254], 258, 260, 1408, 1410, 1411.
\:\\{delete\_action\_ref}, \[1536], 1563, 1579, 1605.
\:\\{delete\_glue\_ref}, \[219], 220, 297, 477, 491, 605, 705, 908, 978, 992,
1002, 1057, 1153, 1173, 1181, 1194, 1199, 1278, 1407, 1414, 1417, 1515, 1605,
1780, 1782, 1790, 1791, 1794, 1803, 1804, 1821, 1838, 1853.
\:\\{delete\_image}, 778.
\:\\{delete\_last}, 1282, \[1283].
\:\\{delete\_q}, \[902], 936, 939.
\:\\{delete\_sa\_ptr}, \[1819], 1821, 1825.
\:\\{delete\_sa\_ref}, \[1821], 1834, 1839, 1840, 1841.
\:\\{delete\_token\_ref}, \[218], 220, 297, 346, 497, 764, 1154, 1156, 1189,
1193, 1515, 1536, 1537, 1552, 1563, 1587, 1590, 1591, 1599, 1605, 1637, 1826,
1827, 1828, 1830, 1831, 1838.
\:\\{delete\_toks}, 756, 763, \[764], 772, 778, 789, 804, 806, 807, 814, 815.
\:\\{deletions\_allowed}, \[76], 77, 84, 85, 98, 358, 368.
\:\\{delim\_num}, \[225], 287, 288, 1224, 1329, 1332, 1338.
\:\\{delim\_ptr}, 230, \[231], 1363, 1369.
\:\\{delimited\_code}, \[1356], 1357, 1360, 1361.
\:\\{delimiter}, \[863], 872, 938, 1369.
\:\9{delimiter\_}{\.{\\delimiter} primitive}, \[287].
\:\\{delimiter\_factor}, \[254], 938.
\:\9{delimiter\_factor\_}{\.{\\delimiterfactor} primitive}, \[256].
\:\\{delimiter\_factor\_code}, \[254], 255, 256.
\:\\{delimiter\_shortfall}, \[265], 938.
\:\9{delimiter\_shortfall\_}{\.{\\delimitershortfall} primitive}, \[266].
\:\\{delimiter\_shortfall\_code}, \[265], 266.
\:\\{delim1}, \[876], 924.
\:\\{delim2}, \[876], 924.
\:\\{delta}, \[103], \[902], 904, 909, \[911], \[912], \[913], \[914], 918, %
\[919], 921, 922, 923, 924, \[925], 926, 930, 931, \[932], 935, \[938], %
\[1171], 1185, 1187, \[1301], 1303.
\:\\{delta\_node}, \[998], 1006, 1008, 1019, 1020, 1036, 1037, 1041, 1050, 1051.
\:\\{delta\_node\_size}, \[998], 1019, 1020, 1036, 1037, 1041.
\:\\{delta1}, \[919], 922, \[938].
\:\\{delta2}, \[919], 922, \[938].
\:\\{den}, 612, \[614], 617.
\:\\{denom}, \[476], 484.
\:\\{denom\_style}, \[878], 920.
\:\\{denominator}, \[859], 866, 873, 874, 920, 1359, 1363.
\:\\{denom1}, \[876], 920.
\:\\{denom2}, \[876], 920.
\:\\{deplorable}, \[1151], 1182.
\:\.{depth}, 489.
\:\\{depth}, \[153], 154, 156, 157, 158, 202, 205, 206, 489, 580, 644, 650,
652, 654, 659, 660, 663, 669, 732, 734, 736, 741, 742, 745, 752, 755, 823, 827,
832, 844, 846, 855, 864, 880, 882, 885, 889, 903, 906, 907, 911, 912, 913, 921,
922, 923, 925, 926, 927, 932, 934, 935, 944, 945, 977, 982, 986, 1005, 1065,
1150, 1179, 1186, 1187, 1198, 1265, 1278, 1548, 1552, 1556, 1565, 1630, 1637,
1719, 1745.
\:\\{depth\_base}, \[576], 578, 580, 592, 598, 705, 706, 1500, 1501.
\:\\{depth\_index}, \[569], 580.
\:\\{depth\_offset}, \[153], 442, 945, 1425.
\:\\{depth\_threshold}, \[199], 200, 216, 251, 254, 868, 1005, 1519, 1823.
\:\\{dest\_name\_entry}, 698, 793, 1627, 1628.
\:\\{dest\_names}, 697, 698, 793, 804, 805, \[1628].
\:\\{dest\_names\_size}, 697, 698, 1513, \[1628].
\:\\{destroy\_marks}, 1515, \[1825], 1831.
\:\\{dests}, 804, 1513.
\:\\{destxyz}, 695.
\:\9{detokenize\_}{\.{\\detokenize} primitive}, \[1686].
\:\\{dig}, \[54], 64, 65, 67, 102, 478, 686, 702.
\:\\{digit\_sensed}, \[1137], 1138, 1139.
\:\9{dim\_expr\_}{\.{\\dimexpr} primitive}, \[1778].
\:\\{dimen}, \[265], 453, 1185, 1187.
\:\9{dimen\_}{\.{\\dimen} primitive}, \[437].
\:\\{dimen\_base}, 238, \[254], 265, 266, 267, 268, 269, 270, 1248, 1323.
\:\9{dimen\_def\_}{\.{\\dimendef} primitive}, \[1400].
\:\\{dimen\_def\_code}, \[1400], 1401, 1402.
\:\\{dimen\_par}, \[265], 673.
\:\\{dimen\_pars}, \[265].
\:\\{dimen\_val}, \[436], 437, 439, 441, 442, 443, 444, 446, 447, 450, 451,
453, 454, 455, 475, 481, 491, 1415, 1674, 1778, 1779, 1785, 1790, 1792, 1795,
1798, 1815, 1820, 1823, 1832.
\:\\{dimen\_val\_limit}, \[1815], 1821, 1822, 1837, 1841.
\:\.{Dimension too large}, 486.
\:\\{direct\_always}, 497, 693, \[695], 1538, 1603.
\:\\{direct\_page}, 497, 693, \[695], 1538, 1603.
\:{dirty \PASCAL}, \[3], 132, 190, 200, 204, 307, 988, 1511.
\:\\{disc\_break}, \[1053], 1056, 1057, 1058, 1067.
\:\\{disc\_group}, \[291], 1295, 1296, 1297, 1661, 1679.
\:\\{disc\_node}, \[163], 166, 193, 201, 220, 224, 674, 823, 825, 906, 937,
993, 995, 1005, 1032, 1034, 1042, 1057, 1091, 1217, 1258.
\:\\{disc\_ptr}, 1515, \[1859], 1863.
\:\\{disc\_width}, \[1015], 1046.
\:\\{discard\_or\_move}, \[1145].
\:\\{discretionary}, \[226], 1268, 1292, 1293, 1294.
\:\.{Discretionary list is too long}, 1298.
\:\9{discretionary\_}{\.{\\discretionary} primitive}, \[1292].
\:\.{Display math...with \$\$}, 1375.
\:\\{display\_indent}, \[265], 976, 1316, 1323, 1377, 1744.
\:\9{display\_indent\_}{\.{\\displayindent} primitive}, \[266].
\:\\{display\_indent\_code}, \[265], 266, 1323.
\:\9{display\_limits\_}{\.{\\displaylimits} primitive}, \[1334].
\:\\{display\_mlist}, \[865], 871, 874, 907, 1352.
\:\\{display\_style}, \[864], 870, 907, 1347, 1377.
\:\9{display\_style\_}{\.{\\displaystyle} primitive}, \[1347].
\:\9{display\_widow\_penalties\_}{\.{\\displaywidowpenalties} primitive}, %
\[1864].
\:\\{display\_widow\_penalties\_loc}, \[248], 1864, 1865.
\:\\{display\_widow\_penalties\_ptr}, 1067, \[1864].
\:\\{display\_widow\_penalty}, \[254], 990, 1067.
\:\9{display\_widow\_penalty\_}{\.{\\displaywidowpenalty} primitive}, \[256].
\:\\{display\_widow\_penalty\_code}, \[254], 255, 256.
\:\\{display\_width}, \[265], 1316, 1323, 1377, 1744.
\:\9{display\_width\_}{\.{\\displaywidth} primitive}, \[266].
\:\\{display\_width\_code}, \[265], 266, 1323.
\:\&{div}, \[100], \[655], \[664].
\:\\{divide}, \[227], 287, 288, 1388, 1413, 1414.
\:\9{divide\_}{\.{\\divide} primitive}, \[287].
\:\\{divide\_scaled}, 687, \[689], 690, 692, 693, 792, 834, 840.
\:\\{dlist}, \[643], 983, 1372, 1380, 1704, 1714, 1715, 1745.
\:\\{do\_all\_eight}, \[999], 1005, 1008, 1013, 1019, 1020, 1036, 1037, 1040.
\:\\{do\_all\_six}, \[999], 1147, 1164.
\:\\{do\_annot}, \[1630], 1639, 1645.
\:\\{do\_assignments}, 976, 1301, 1384, \[1448].
\:\\{do\_char}, \[710], 725, 726.
\:\\{do\_dest}, \[1637], 1639, 1645.
\:\\{do\_endv}, 1308, \[1309].
\:\\{do\_extension}, 1527, \[1528], 1623.
\:\\{do\_last\_line\_fit}, 1021, 1022, 1027, 1028, 1031, 1039, 1040, \[1842],
1843, 1853.
\:\\{do\_link}, 1560, \[1635], 1645.
\:\\{do\_marks}, 1154, 1189, 1515, \[1825].
\:\\{do\_nothing}, \[16], 34, 57, 58, 84, 193, 220, 297, 366, 379, 497, 564,
595, 636, 638, 639, 650, 659, 687, 732, 741, 793, 825, 845, 868, 904, 909, 937,
1013, 1042, 1076, 1223, 1414, 1552, 1603, 1620, 1637, 1645.
\:\\{do\_one\_seven\_eight}, \[999], 1016, 1045.
\:\\{do\_pdf\_font}, 801.
\:\\{do\_register\_command}, 1413, \[1414].
\:\\{do\_seven\_eight}, \[999].
\:\\{do\_snapy}, \[1637], 1639.
\:\\{do\_snapy\_comp}, \[1637], 1639.
\:\\{do\_subst\_font}, 822, \[823], 825, 828.
\:\\{do\_thread}, \[1637], 1639, 1645.
\:\\{do\_vf}, \[712], 720, 726.
\:\\{do\_vf\_packet}, 721, \[725], 726.
\:\\{doing\_leaders}, \[619], 620, 656, 665, 737, 746, 1622, 1630, 1637.
\:\\{done}, \[15], 47, 53, 220, 303, 304, 333, 406, 415, 423, 466, 471, 474,
479, 484, 499, 500, 502, 508, 509, 520, 552, 556, 557, 563, 586, 593, 603, 642,
666, 668, 669, 698, 702, 706, 750, 751, 802, 874, 902, 914, 916, 936, 937, 950,
953, 991, 1005, 1013, 1039, 1049, 1053, 1057, 1072, 1083, 1086, 1088, 1108,
1137, 1138, 1147, 1151, 1154, 1156, 1171, 1174, 1175, 1182, 1257, 1258, 1259,
1288, 1297, 1299, 1316, 1324, 1389, 1405, 1430, 1513, 1537, 1605, 1679, 1723,
1729, 1736, 1737, 1738, 1761, 1799, 1863.
\:\\{done\_with\_noad}, \[902], 903, 904, 909, 930.
\:\\{done\_with\_node}, \[902], 903, 906, 907, 930.
\:\\{done1}, \[15], 185, 186, 415, 425, 474, 478, 499, 500, 750, 804, 914, 917,
950, 959, 991, 1005, 1028, 1053, 1055, 1071, 1073, 1076, 1137, 1142, 1171,
1174, 1177, 1480, 1493, 1513.
\:\\{done2}, \[15], 185, 187, 474, 484, 485, 499, 504, 950, 960, 991, 1073,
1480, 1494.
\:\\{done3}, \[15], 991, 1074, 1075.
\:\\{done4}, \[15], 991, 1076.
\:\\{done5}, \[15], 991, 1042, 1045.
\:\\{done6}, \[15].
\:\\{dont\_expand}, \[228], 277, 379, 393.
\:\\{double}, \[111], 113, 119.
\:\.{Double subscript}, 1355.
\:\.{Double superscript}, 1355.
\:\\{double\_hyphen\_demerits}, \[254], 1035.
\:\9{double\_hyphen\_demerits\_}{\.{\\doublehyphendemerits} primitive}, \[256].
\:\\{double\_hyphen\_demerits\_code}, \[254], 255, 256.
\:\.{Doubly free location...}, 187.
\:\\{down\_ptr}, \[632], 633, 634, 642.
\:\\{downdate\_width}, \[1036].
\:\\{down1}, 612, \[613], 634, 636, 637, 640, 641, 643, 719, 726.
\:\\{down2}, \[612], 621, 637.
\:\\{down3}, \[612], 637.
\:\\{down4}, \[612], 637.
\:\9{dp\_}{\.{\\dp} primitive}, \[442].
\:{dry rot}, 95.
\:\\{ds}, 712.
\:\9{dump\_}{\.{\\dump...only by INITEX}}, 1515.
\:\9{dump\_}{\.{\\dump} primitive}, \[1230].
\:\\{dump\_four\_ASCII}, \[1487].
\:\\{dump\_hh}, \[1483], 1496, 1502.
\:\\{dump\_int}, \[1483], 1485, 1487, 1489, 1491, 1493, 1494, 1496, 1498, 1500,
1502, 1504, 1506, 1654.
\:\\{dump\_qqqq}, \[1483], 1487, 1500.
\:\\{dump\_wd}, \[1483], 1489, 1493, 1494, 1498.
\:\\{dumpimagemeta}, 1504.
\:\\{dumptounicode}, 1504.
\:\.{Duplicate pattern}, 1140.
\:\\{dvi\_buf}, 621, \[622], 624, 625, 634, 640, 641.
\:\\{dvi\_buf\_size}, \[11], 14, 621, 622, 623, 625, 626, 634, 640, 641, 670.
\:\\{dvi\_f}, \[643], 645, 648, 649.
\:\\{dvi\_file}, \[558], 619, 622, 624, 670.
\:\9{DVI\_files}{\.{DVI} files}, 610.
\:\\{dvi\_font\_def}, \[629], 649, 671.
\:\\{dvi\_four}, \[627], 629, 637, 645, 652, 661, 668, 670, 1615.
\:\\{dvi\_gone}, 621, \[622], 623, 625, 639.
\:\\{dvi\_h}, \[643], 645, 647, 648, 651, 652, 656, 657, 660, 665.
\:\\{dvi\_index}, \[621], 622, 624.
\:\\{dvi\_limit}, 621, \[622], 623, 625, 626.
\:\\{dvi\_offset}, 621, \[622], 623, 625, 628, 632, 634, 640, 641, 647, 657,
668, 670.
\:\\{dvi\_out}, \[625], 627, 628, 629, 630, 636, 637, 645, 647, 648, 649, 652,
657, 661, 668, 670, 1615.
\:\\{dvi\_pop}, \[628], 647, 657.
\:\\{dvi\_ptr}, 621, \[622], 623, 625, 626, 628, 634, 647, 657, 668, 670.
\:\\{dvi\_ship\_out}, \[666], 791.
\:\\{dvi\_swap}, \[625].
\:\\{dvi\_v}, \[643], 645, 647, 651, 656, 657, 660, 665.
\:\\{dvi\_x}, \[691].
\:\\{dvi\_y}, \[691].
\:\\{dw}, 823.
\:\\{dyn\_used}, \[135], 138, 139, 140, 141, 182, 667, 1489, 1490.
\:\|{e}, \[299], \[301], \[524], \[544], \[545], \[556], \[1376], \[1389], %
\[1414], \[1661], \[1662], \[1744], \[1782], \[1839], \[1840].
\:\\{easy\_line}, 995, 1011, \[1023], 1024, 1026.
\:\\{ec}, 566, 567, 569, 571, \[586], 591, 592, 596, 603, 706.
\:\9{edef\_}{\.{\\edef} primitive}, \[1386].
\:\\{edge}, \[647], 651, 654, \[657], 663, \[729], 733, 736, \[738], 745, 1646,
1647.
\:\\{edge\_dist}, \[1719], 1720, 1722, 1729.
\:\\{edge\_node}, 643, \[1719], 1720, 1725, 1736.
\:\\{edge\_node\_size}, \[1719].
\:\\{ef}, 823.
\:\9{ef\_code\_}{\.{\\efcode} primitive}, \[1432].
\:\\{ef\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\\{eight\_bits}, \[25], 64, 130, 319, 575, 586, 597, 604, 608, 609, 622, 634,
673, 680, 686, 690, 696, 704, 705, 707, 712, 725, 823, 882, 885, 888, 1169,
1170, 1466.
\:\\{eject\_penalty}, \[175], 1005, 1007, 1027, 1035, 1049, 1147, 1149, 1151,
1182, 1187, 1188.
\:\\{el\_gordo}, \[111], 112, 114.
\:\9{elapsed\_time\_}{\.{\\pdfelapsedtime} primitive}, \[442].
\:\\{elapsed\_time\_code}, \[442], 443, 450.
\:\&{else}, 10.
\:\9{else\_}{\.{\\else} primitive}, \[517].
\:\\{else\_code}, \[515], 517, 524, 1668.
\:\.{em}, 481.
\:\.{Emergency stop}, 93.
\:\\{emergency\_stretch}, \[265], 1004, 1039.
\:\9{emergency\_stretch\_}{\.{\\emergencystretch} primitive}, \[266].
\:\\{emergency\_stretch\_code}, \[265], 266.
\:\\{empty}, \[16], 447, 857, 861, 863, 868, 898, 899, 914, 925, 927, 928, 930,
931, 932, 1157, 1163, 1164, 1168, 1178, 1185, 1354, 1355, 1364.
\:{empty line at end of file}, 512, 564.
\:\\{empty\_field}, \[860], 861, 862, 918, 1341, 1343, 1359.
\:\\{empty\_flag}, \[142], 144, 148, 168, 182, 1490.
\:\&{end}, 7, 8, 10.
\:\.{End of file on the terminal}, 37, 71.
\:\9{end\_}{\.{(\\end occurred...)}}, 1515.
\:\9{end\_}{\.{\\end} primitive}, \[1230].
\:\\{end\_cs\_name}, \[226], 287, 288, 398, 1312, 1767.
\:\9{end\_cs\_name\_}{\.{\\endcsname} primitive}, \[287].
\:\\{end\_diagnostic}, \[263], 306, 321, 345, 426, 427, 528, 535, 608, 666,
669, 750, 839, 851, 1002, 1039, 1164, 1169, 1183, 1188, 1299, 1476, 1662, 1823.
\:\\{end\_file\_reading}, \[351], 352, 382, 384, 509, 563, 1515.
\:\\{end\_graf}, 1203, 1263, 1272, \[1274], 1278, 1309, 1311, 1346.
\:\\{end\_group}, \[226], 287, 288, 1241.
\:\9{end\_group\_}{\.{\\endgroup} primitive}, \[287].
\:\9{end\_input\_}{\.{\\endinput} primitive}, \[402].
\:\\{end\_L\_code}, \[165], 1701, 1702, 1705, 1734.
\:\\{end\_line\_char}, 87, \[254], 258, 325, 340, 354, 382, 384, 509, 560, 564,
1517.
\:\9{end\_line\_char\_}{\.{\\endlinechar} primitive}, \[256].
\:\\{end\_line\_char\_code}, \[254], 255, 256.
\:\\{end\_line\_char\_inactive}, \[382], 384, 509, 564, 1517.
\:\\{end\_link}, \[1635], 1645.
\:\\{end\_LR}, \[165], 210, 1708, 1711, 1717, 1728, 1737, 1739.
\:\\{end\_LR\_type}, \[165], 1705, 1708, 1711, 1717, 1728, 1737, 1739.
\:\\{end\_M}, 1258.
\:\\{end\_M\_code}, \[165], 450, 1705, 1746.
\:\\{end\_match}, \[225], 311, 313, 316, 417, 418, 420.
\:\\{end\_match\_token}, \[311], 415, 417, 418, 419, 420, 500, 502, 508.
\:\\{end\_name}, 538, \[543], 552, 557.
\:\\{end\_of\_TEX}, \[6], 81, 1512.
\:\\{end\_R\_code}, \[165], 1701, 1705.
\:\\{end\_reflect}, 1700.
\:\\{end\_span}, \[180], 944, 955, 969, 973, 977, 979.
\:\\{end\_template}, \[228], 388, 401, 406, 956, 1473, 1772.
\:\\{end\_template\_token}, \[956], 960, 966.
\:\\{end\_thread}, \[1637], 1639.
\:\\{end\_token\_list}, \[346], 347, 379, 416, 1203, 1515, 1618.
\:\\{end\_write}, \[240], 1616, 1618.
\:\9{end\_write\_}{\.{\\endwrite}}, 1616.
\:\\{end\_write\_token}, \[1618], 1619.
\:\&{endcases}, \[10].
\:\9{endL\_}{\.{\\endL} primitive}, \[1701].
\:\9{endR\_}{\.{\\endR} primitive}, \[1701].
\:\.{endtemplate}, 956.
\:\\{endv}, \[225], 320, 401, 406, 944, 956, 958, 967, 1224, 1308, 1309.
\:\\{ensure\_dvi\_open}, \[558], 645.
\:\\{ensure\_pdf\_open}, 683, \[684].
\:\\{ensure\_vbox}, \[1170], 1186, 1195.
\:\\{eof}, 26, 31, 52, 590, 602, 772, 1507.
\:\\{eof\_seen}, 350, 384, \[1660].
\:\\{eoln}, 31, 52.
\:\\{eop}, 610, 612, \[613], 615, 668, 670.
\:\\{epdf\_orig\_x}, 498, 1637.
\:\\{epdf\_orig\_y}, 498, 1637.
\:\\{epochseconds}, \[680], 1517, 1555, 1584, 1586.
\:\\{eq\_define}, \[299], 300, 301, 398, 958, 1248, 1392.
\:\\{eq\_destroy}, \[297], 299, 301, 305.
\:\\{eq\_level}, \[239], 240, 246, 250, 254, 271, 277, 286, 299, 301, 305, 956,
1154, 1493, 1616, 1820, 1821.
\:\\{eq\_level\_field}, \[239].
\:\\{eq\_no}, \[226], 1318, 1319, 1321, 1322, 1679.
\:\9{eq\_no\_}{\.{\\eqno} primitive}, \[1319].
\:\\{eq\_save}, \[298], 299, 300.
\:\\{eq\_type}, 228, \[239], 240, 241, 246, 250, 271, 277, 286, 287, 289, 299,
301, 373, 375, 376, 379, 380, 398, 415, 417, 956, 1330, 1493, 1616, 1767.
\:\\{eq\_type\_field}, \[239], 297.
\:\\{eq\_word\_define}, \[300], 301, 1248, 1317, 1323, 1392.
\:\\{eqtb}, 2, 133, 181, 238, 239, 240, 241, 242, 246, 248, 250, 254, 258, 260,
265, 268, 269, 270, \[271], 273, 275, 284, 286, 287, 288, 289, 290, 292, 294,
296, 297, 298, 299, 300, 301, 303, 304, 305, 306, 307, 308, 311, 313, 319, 320,
327, 329, 354, 355, 376, 415, 439, 440, 499, 517, 574, 579, 706, 956, 990,
1366, 1386, 1400, 1415, 1431, 1435, 1493, 1494, 1495, 1519, 1525, 1649, 1823,
1835.
\:\\{eqtb\_size}, 238, \[265], 268, 270, 271, 272, 1485, 1486, 1494, 1495.
\:\\{equiv}, \[239], 240, 241, 242, 246, 247, 248, 250, 251, 252, 253, 271,
273, 277, 286, 287, 289, 297, 299, 301, 373, 375, 376, 379, 380, 439, 440, 441,
534, 604, 706, 956, 1330, 1405, 1415, 1467, 1493, 1616, 1658, 1864, 1866.
\:\\{equiv\_field}, \[239], 297, 307, 1834.
\:\\{err\_help}, 79, \[248], 1461, 1462.
\:\9{err\_help\_}{\.{\\errhelp} primitive}, \[248].
\:\\{err\_help\_loc}, \[248].
\:\9{err\_message\_}{\.{\\errmessage} primitive}, \[1455].
\:\\{error}, 72, 75, 76, 78, 79, \[82], 88, 91, 93, 98, 121, 349, 360, 368,
396, 424, 434, 444, 454, 471, 480, 482, 485, 486, 497, 501, 502, 512, 526, 536,
549, 561, 587, 593, 606, 669, 899, 952, 960, 968, 1002, 1113, 1114, 1137, 1138,
1139, 1140, 1153, 1155, 1169, 1181, 1186, 1201, 1204, 1228, 1242, 1244, 1246,
1247, 1258, 1260, 1273, 1277, 1284, 1288, 1298, 1299, 1306, 1307, 1313, 1337,
1344, 1355, 1361, 1370, 1373, 1391, 1403, 1410, 1414, 1415, 1419, 1430, 1437,
1461, 1462, 1471, 1539, 1619, 1656, 1782.
\:\\{error\_context\_lines}, \[254], 333.
\:\9{error\_context\_lines\_}{\.{\\errorcontextlines} primitive}, \[256].
\:\\{error\_context\_lines\_code}, \[254], 255, 256.
\:\\{error\_count}, \[76], 77, 82, 86, 1274, 1471.
\:\\{error\_line}, \[11], 14, 54, 58, 328, 333, 337, 338, 339.
\:\\{error\_message\_issued}, \[76], 82, 95.
\:\\{error\_stop\_mode}, 72, \[73], 74, 82, 83, 93, 98, 686, 1440, 1461, 1471,
1472, 1475, 1507, 1515, 1696.
\:\9{error\_stop\_mode\_}{\.{\\errorstopmode} primitive}, \[1440].
\:\\{erstat}, \[27].
\:\\{escape}, \[225], 250, 366, 1517.
\:\\{escape\_char}, \[254], 258, 261.
\:\9{escape\_char\_}{\.{\\escapechar} primitive}, \[256].
\:\\{escape\_char\_code}, \[254], 255, 256.
\:\\{escapehex}, 497.
\:\\{escapename}, 497.
\:\\{escapestring}, 497.
\:\.{ETC}, 314.
\:\.{etc}, 200.
\:\\{eTeX\_aux}, 230, \[231], 233, 234.
\:\\{eTeX\_aux\_field}, \[230], 231, 1679.
\:\\{eTeX\_banner}, \[2].
\:\\{etex\_convert\_base}, \[494].
\:\\{etex\_convert\_codes}, \[494].
\:\\{eTeX\_dim}, \[442], 450, 1669, 1672, 1801.
\:\\{eTeX\_enabled}, \[1656], 1703.
\:\\{eTeX\_ex}, 202, 296, 299, 300, 304, 348, 562, 608, 653, 666, 735, 750,
1323, 1389, 1390, 1391, 1489, 1490, 1515, 1517, \[1652], 1655, 1714, 1715,
1716, 1734.
\:\\{eTeX\_expr}, \[442], 1778, 1779, 1780.
\:\\{eTeX\_glue}, \[442], 450, 1805.
\:\\{eTeX\_int}, \[442], 1649, 1663, 1666, 1801.
\:\\{etex\_int\_base}, \[254].
\:\\{etex\_int\_pars}, \[254].
\:\\{eTeX\_mode}, 1648, \[1652], 1653, 1654, 1655.
\:\\{eTeX\_mu}, \[442], 1780, 1805.
\:\\{etex\_pen\_base}, \[248], 250, 251.
\:\\{etex\_pens}, \[248], 250, 251.
\:\\{eTeX\_revision}, \[2], 498.
\:\9{eTeX\_revision\_}{\.{\\eTeXrevision} primitive}, \[1649].
\:\\{eTeX\_revision\_code}, \[494], 495, 497, 498, 1649.
\:\\{eTeX\_state}, \[1649], 1654, 1700.
\:\\{eTeX\_state\_base}, \[1649], 1701.
\:\\{eTeX\_state\_code}, \[254], 1649, 1700.
\:\\{eTeX\_states}, \[2], 254, 1654.
\:\\{eTeX\_text\_offset}, \[329].
\:\\{etex\_toks}, \[248].
\:\\{etex\_toks\_base}, \[248].
\:\\{eTeX\_version}, \[2], 1651.
\:\9{eTeX\_version\_}{\.{\\eTeXversion} primitive}, \[1649].
\:\\{eTeX\_version\_code}, 442, \[1649], 1650, 1651.
\:\\{eTeX\_version\_string}, \[2].
\:\\{every\_cr}, \[248], 950, 975.
\:\9{every\_cr\_}{\.{\\everycr} primitive}, \[248].
\:\\{every\_cr\_loc}, \[248], 249.
\:\\{every\_cr\_text}, \[329], 336, 950, 975.
\:\\{every\_display}, \[248], 1323.
\:\9{every\_display\_}{\.{\\everydisplay} primitive}, \[248].
\:\\{every\_display\_loc}, \[248], 249.
\:\\{every\_display\_text}, \[329], 336, 1323.
\:\\{every\_eof}, 384, \[1658].
\:\9{every\_eof\_}{\.{\\everyeof} primitive}, \[1657].
\:\\{every\_eof\_loc}, \[248], 329, 1657, 1658.
\:\\{every\_eof\_text}, \[329], 336, 384.
\:\\{every\_hbox}, \[248], 1261.
\:\9{every\_hbox\_}{\.{\\everyhbox} primitive}, \[248].
\:\\{every\_hbox\_loc}, \[248], 249.
\:\\{every\_hbox\_text}, \[329], 336, 1261.
\:\\{every\_job}, \[248], 1207.
\:\9{every\_job\_}{\.{\\everyjob} primitive}, \[248].
\:\\{every\_job\_loc}, \[248], 249.
\:\\{every\_job\_text}, \[329], 336, 1207.
\:\\{every\_math}, \[248], 1317.
\:\9{every\_math\_}{\.{\\everymath} primitive}, \[248].
\:\\{every\_math\_loc}, \[248], 249.
\:\\{every\_math\_text}, \[329], 336, 1317.
\:\\{every\_par}, \[248], 1269.
\:\9{every\_par\_}{\.{\\everypar} primitive}, \[248].
\:\\{every\_par\_loc}, \[248], 249, 329, 1404.
\:\\{every\_par\_text}, \[329], 336, 1269.
\:\\{every\_vbox}, \[248], 1261, 1345.
\:\9{every\_vbox\_}{\.{\\everyvbox} primitive}, \[248].
\:\\{every\_vbox\_loc}, \[248], 249.
\:\\{every\_vbox\_text}, \[329], 336, 1261, 1345.
\:\.{ex}, 481.
\:\\{ex\_hyphen\_penalty}, 163, \[254], 1045.
\:\9{ex\_hyphen\_penalty\_}{\.{\\exhyphenpenalty} primitive}, \[256].
\:\\{ex\_hyphen\_penalty\_code}, \[254], 255, 256.
\:\\{ex\_ratio}, 823.
\:\\{ex\_space}, \[226], 287, 288, 1207, 1268.
\:\\{exactly}, \[816], 817, 891, 1066, 1154, 1194, 1240, 1379, 1680.
\:\\{exit}, \[15], 16, 37, 47, 58, 59, 69, 82, 122, 143, 200, 299, 300, 314,
363, 415, 433, 439, 487, 491, 496, 523, 524, 550, 604, 609, 634, 642, 749, 793,
823, 844, 928, 967, 1005, 1072, 1111, 1121, 1125, 1154, 1171, 1189, 1207, 1232,
1257, 1283, 1288, 1291, 1297, 1329, 1337, 1352, 1389, 1414, 1448, 1481, 1515,
1518, 1661, 1772, 1819, 1821.
\:\\{expand}, 380, \[388], 392, 394, 397, 406, 407, 465, 493, 504, 524, 536,
958, 1682, 1772.
\:\\{expand\_after}, \[228], 287, 288, 388, 391, 1762.
\:\9{expand\_after\_}{\.{\\expandafter} primitive}, \[287].
\:\\{expand\_depth}, 1782.
\:\\{expand\_depth\_count}, 1782.
\:\\{expand\_font}, \[705], 823.
\:\\{expand\_font\_name}, \[705].
\:\\{expand\_ratio}, 705.
\:\9{expanded\_}{\.{\\expanded} primitive}, \[494].
\:\\{expanded\_code}, \[494], 495, 497.
\:\\{explicit}, \[173], 674, 893, 1013, 1042, 1044, 1055, 1236, 1291, 1711.
\:\\{expr\_a}, \[1792], 1794.
\:\\{expr\_add}, \[1783], 1784.
\:\\{expr\_add\_sub}, \[1792].
\:\\{expr\_d}, \[1796].
\:\\{expr\_div}, \[1783], 1784, 1795, 1796.
\:\\{expr\_e\_field}, \[1788], 1789.
\:\\{expr\_m}, \[1795].
\:\\{expr\_mult}, \[1783], 1784, 1795.
\:\\{expr\_n\_field}, \[1788], 1789.
\:\\{expr\_node\_size}, \[1788], 1789.
\:\\{expr\_none}, \[1783], 1784, 1791, 1792.
\:\\{expr\_s}, \[1798].
\:\\{expr\_scale}, \[1783], 1795, 1798.
\:\\{expr\_sub}, \[1783], 1784, 1790, 1792.
\:\\{expr\_t\_field}, \[1788], 1789.
\:\\{ext\_bot}, \[572], 889, 890.
\:\\{ext\_delimiter}, \[539], 541, 542, 543.
\:\\{ext\_mid}, \[572], 889, 890.
\:\\{ext\_rep}, \[572], 889, 890.
\:\\{ext\_tag}, \[570], 595, 604, 705, 884, 886.
\:\\{ext\_top}, \[572], 889, 890.
\:\\{ext\_xn\_over\_d}, 823, 1552, 1637.
\:\\{exten}, \[570].
\:\\{exten\_base}, \[576], 578, 592, 600, 601, 603, 705, 706, 889, 1500, 1501.
\:\\{extensible\_recipe}, 567, \[572].
\:\\{extension}, \[226], 1524, 1526, 1527, 1623.
\:{extensions to \TeX}, 2, 164, 1520.
\:\.{Extra \\else}, 536.
\:\.{Extra \\endcsname}, 1313.
\:\.{Extra \\fi}, 536.
\:\.{Extra \\middle.}, 1370.
\:\.{Extra \\or}, 526, 536.
\:\.{Extra \\right.}, 1370.
\:\.{Extra \}, or forgotten x}, 1247.
\:\.{Extra alignment tab...}, 968.
\:\.{Extra x}, 1244.
\:\\{extra\_info}, \[945], 964, 965, 967, 968.
\:\\{extra\_right\_brace}, 1246, \[1247].
\:\\{extra\_space}, 573, \[584], 1222.
\:\\{extra\_space\_code}, \[573], 584.
\:{eyes and mouth}, 354.
\:\\{e1}, 793.
\:\\{e2}, 793.
\:\|{f}, \[27], \[28], \[31], \[112], \[114], \[162], \[474], \[551], \[586], %
\[604], \[605], \[608], \[609], \[619], \[629], \[706], \[720], \[725], \[823],
\[882], \[885], \[887], \[888], \[891], \[892], \[893], \[914], \[1006], %
\[1038], \[1246], \[1291], \[1301], \[1316], \[1389], \[1435], \[1782], \[1799].
\:\\{false}, 27, 31, 37, 45, 46, 47, 51, 76, 80, 88, 89, 98, 106, 107, 112,
115, 184, 185, 186, 187, 286, 296, 303, 306, 321, 333, 345, 349, 350, 353, 358,
368, 383, 384, 387, 390, 400, 426, 427, 433, 441, 451, 453, 466, 467, 471, 473,
474, 475, 481, 486, 487, 488, 491, 498, 511, 527, 528, 531, 533, 535, 538, 542,
550, 552, 554, 564, 577, 589, 608, 620, 681, 683, 685, 686, 688, 689, 692, 693,
698, 702, 705, 706, 720, 726, 727, 749, 753, 769, 775, 793, 794, 795, 797, 799,
801, 802, 804, 805, 807, 823, 882, 896, 898, 930, 950, 967, 1002, 1004, 1005,
1013, 1027, 1030, 1039, 1057, 1063, 1080, 1083, 1087, 1088, 1128, 1131, 1137,
1138, 1139, 1140, 1143, 1145, 1164, 1167, 1183, 1188, 1197, 1198, 1203, 1208,
1210, 1211, 1212, 1218, 1229, 1232, 1239, 1258, 1274, 1279, 1345, 1360, 1361,
1369, 1370, 1372, 1377, 1404, 1405, 1414, 1436, 1448, 1457, 1460, 1461, 1466,
1481, 1503, 1516, 1522, 1523, 1532, 1534, 1537, 1552, 1555, 1564, 1565, 1578,
1579, 1581, 1582, 1600, 1618, 1622, 1623, 1629, 1630, 1639, 1645, 1648, 1656,
1662, 1682, 1756, 1769, 1774, 1776, 1782, 1793, 1797, 1799, 1820, 1821, 1823,
1824, 1843, 1846, 1853, 1855, 1856.
\:\\{false\_bchar}, \[1209], 1211, 1215.
\:\\{fam}, \[857], 858, 859, 863, 867, 898, 899, 928, 929, 1329, 1333, 1343.
\:\9{fam\_}{\.{\\fam} primitive}, \[256].
\:\\{fam\_fnt}, \[248], 876, 877, 883, 898, 1373.
\:\\{fam\_in\_range}, \[1329], 1333, 1343.
\:\\{fast\_delete\_glue\_ref}, \[219], 220, 1699.
\:\\{fast\_get\_avail}, \[140], 224, 397, 700, 822, 823, 1211, 1215.
\:\\{fast\_store\_new\_token}, \[397], 425, 490, 492.
\:\.{Fatal format file error}, 1481.
\:\\{fatal\_error}, 71, \[93], 346, 382, 510, 556, 561, 958, 965, 967, 1309.
\:\\{fatal\_error\_stop}, \[76], 77, 82, 93, 1512, 1513.
\:\\{fbyte}, \[590], 594, 597, 602.
\:{Ferguson, Michael John}, 2.
\:\\{fetch}, \[898], 900, 914, 917, 925, 928, 931.
\:\\{fetch\_box}, 446, 497, 531, 1154, 1257, 1288, 1425, 1474, 1548, \[1820].
\:\\{fetch\_effective\_tail}, \[1258], 1259, 1283.
\:\\{fetch\_effective\_tail\_eTeX}, \[1258].
\:\\{fewest\_demerits}, \[1048], 1050, 1051.
\:\\{ff}, 498, 693, \[696], 698, 766.
\:\\{fget}, \[590], 591, 594, 597, 602.
\:\9{fi\_}{\.{\\fi} primitive}, \[517].
\:\\{fi\_code}, \[515], 517, 518, 520, 524, 526, 535, 536, 1668, 1691, 1777.
\:\\{fi\_or\_else}, \[228], 321, 388, 391, 515, 517, 518, 520, 536, 1471.
\:\.{fil}, 480.
\:\\{fil}, 153, \[168], 182, 195, 480, 824, 835, 841, 1379.
\:\\{fil\_code}, \[1236], 1237, 1238.
\:\\{fil\_glue}, \[180], 182, 1238.
\:\\{fil\_neg\_code}, \[1236], 1238.
\:\\{fil\_neg\_glue}, \[180], 182, 1238.
\:\.{File ended while scanning...}, 360.
\:\.{File ended within \\read}, 512.
\:\\{file\_name\_size}, \[11], 26, 545, 548, 549, 551.
\:\\{file\_offset}, \[54], 55, 57, 58, 62, 563, 666, 750, 1458, 1755.
\:\\{file\_opened}, \[586], 587, 589.
\:\\{file\_warning}, 384, \[1777].
\:\\{filename}, 712.
\:\\{fill}, 153, \[168], 182, 824, 835, 841, 1379.
\:\\{fill\_code}, \[1236], 1237, 1238.
\:\\{fill\_glue}, \[180], 182, 1232, 1238.
\:\\{fill\_width}, \[1842], 1843, 1846.
\:\\{filll}, 153, \[168], 195, 480, 824, 835, 841, 1379, 1699.
\:\\{fin\_align}, 949, 961, \[976], 1309.
\:\\{fin\_col}, 949, \[967], 1309.
\:\\{fin\_mlist}, 1352, \[1362], 1364, 1369, 1372.
\:\\{fin\_row}, 949, \[975], 1309.
\:\\{fin\_rule}, \[647], 650, 654, 657, 659, 663, 729, 732, 736, 738, 741, 745.
\:\\{final\_cleanup}, 1512, 1513, \[1515], 1825.
\:\\{final\_end}, \[6], 35, 353, 1512, 1517.
\:\\{final\_hyphen\_demerits}, \[254], 1035.
\:\9{final\_hyphen\_demerits\_}{\.{\\finalhyphendemerits} primitive}, \[256].
\:\\{final\_hyphen\_demerits\_code}, \[254], 255, 256.
\:\\{final\_pass}, \[1004], 1030, 1039, 1049.
\:\\{final\_skip}, \[695], 1573, 1603, 1637.
\:\\{find\_effective\_tail}, \[450].
\:\\{find\_effective\_tail\_eTeX}, \[450], 1258.
\:\\{find\_font\_dimen}, 451, \[605], 1220, 1431.
\:\\{find\_obj}, \[1555], 1565.
\:\\{find\_protchar\_left}, 821, \[1005], 1063.
\:\\{find\_protchar\_right}, 821, \[1005], 1057.
\:\\{find\_sa\_element}, 441, 453, 1402, 1404, 1405, 1415, 1816, \[1819], 1820,
1821, 1824, 1827, 1830, 1839.
\:{fingers}, 537.
\:\\{finite\_shrink}, 1001, \[1002].
\:\\{fire\_up}, 1182, \[1189], 1809, 1825, 1828.
\:\\{fire\_up\_done}, 1189, \[1825], 1829.
\:\\{fire\_up\_init}, 1189, \[1825], 1828.
\:\\{firm\_up\_the\_line}, 362, 384, \[385], 564.
\:\\{first}, \[30], 31, 35, 36, 37, 71, 83, 87, 88, 286, 350, 351, 353, 377,
382, 384, 385, 400, 509, 557, 564, 1516, 1756, 1768.
\:\\{first\_child}, \[1137], 1140, 1141, 1855, 1856.
\:\\{first\_count}, \[54], 337, 338, 339.
\:\\{first\_fit}, \[1130], 1134, 1143, 1857.
\:\\{first\_indent}, \[1023], 1025, 1066.
\:\\{first\_mark}, \[408], 409, 1189, 1193, 1809, 1828.
\:\9{first\_mark\_}{\.{\\firstmark} primitive}, \[410].
\:\\{first\_mark\_code}, \[408], 410, 411, 1809.
\:\9{first\_marks\_}{\.{\\firstmarks} primitive}, \[1809].
\:\\{first\_p}, \[999], 1005, 1039.
\:\\{first\_text\_char}, \[19], 24.
\:\\{first\_width}, \[1023], 1025, 1026, 1066.
\:\\{fit\_class}, \[1006], 1012, 1021, 1022, 1028, 1029, 1031, 1035, 1847,
1848, 1850, 1851.
\:\\{fitness}, \[995], 1021, 1035, 1040.
\:\\{fix\_date\_and\_time}, \[259], 1512, 1517.
\:\\{fix\_expand\_value}, \[705].
\:\\{fix\_int}, \[682], 683, 705, 706, 792, 823, 1552, 1575.
\:\\{fix\_language}, 1211, \[1624].
\:\\{fix\_pdf\_draftmode}, 747, \[748].
\:\\{fix\_pdfoutput}, 683, \[747], 752, 791, 1513.
\:\\{fix\_word}, \[567], 568, 573, 574, 597.
\:\\{fixed\_decimal\_digits}, 690, \[691], 692, 693, 792.
\:\\{fixed\_gamma}, \[680], 683.
\:\\{fixed\_gen\_tounicode}, \[691], 801.
\:\\{fixed\_image\_apply\_gamma}, \[680], 683.
\:\\{fixed\_image\_gamma}, \[680], 683.
\:\\{fixed\_image\_hicolor}, \[680], 683.
\:\\{fixed\_inclusion\_copy\_font}, 683, \[691].
\:\\{fixed\_pdf\_draftmode}, \[680], 683, 684, 685, 748, 778, 794.
\:\\{fixed\_pdf\_draftmode\_set}, \[680], 681, 748.
\:\\{fixed\_pdf\_major\_version}, \[680], 683.
\:\\{fixed\_pdf\_minor\_version}, \[680], 683.
\:\\{fixed\_pdf\_objcompresslevel}, \[680], 683, 698, 748.
\:\\{fixed\_pdfoutput}, \[680], 747, 1513.
\:\\{fixed\_pdfoutput\_set}, \[680], 681, 747, 1513.
\:\\{fixed\_pk\_resolution}, \[691], 792.
\:\\{fixedi}, \[705].
\:\\{float}, \[109], 132, 204, 653, 662, 735, 744, 985, 1638.
\:\\{float\_constant}, \[109], 204, 647, 653, 657, 729, 738, 1301, 1303, 1637.
\:\\{float\_cost}, \[158], 206, 1185, 1278.
\:\\{floating\_penalty}, 158, \[254], 1246, 1278.
\:\9{floating\_penalty\_}{\.{\\floatingpenalty} primitive}, \[256].
\:\\{floating\_penalty\_code}, \[254], 255, 256.
\:\\{flush\_char}, \[42], 198, 213, 868, 871.
\:\\{flush\_jbig2\_page0\_objects}, 794.
\:\\{flush\_list}, \[141], 218, 346, 398, 422, 433, 727, 764, 765, 977, 1080,
1137, 1274, 1457, 1475, 1615, 1617, 1688, 1753, 1767.
\:\\{flush\_math}, \[894], 952, 1373.
\:\\{flush\_node\_list}, 217, \[220], 297, 667, 772, 874, 894, 907, 908, 918,
976, 992, 1055, 1059, 1080, 1095, 1145, 1154, 1169, 1176, 1200, 1203, 1256,
1258, 1283, 1298, 1299, 1384, 1515, 1565, 1623, 1635, 1636, 1727, 1735, 1738,
1743, 1838.
\:\\{flush\_str}, 497, 705, 706, 718, 726, 727, 769, 772, 807, 1537, 1552, %
\[1555], 1563, 1565, 1587, 1630.
\:\\{flush\_string}, \[44], 286, 563, 792, 1438, 1457, 1508, 1555, 1753.
\:\\{flush\_whatsit\_node}, \[772], 783, 786.
\:\\{flushable}, \[673], 1555.
\:\\{flushable\_string}, \[1435], 1438.
\:\\{fm}, \[1257], 1258, \[1283].
\:\\{fm\_entry\_ptr}, 707, 708.
\:\\{fmem\_ptr}, 451, \[575], 578, 592, 595, 596, 603, 605, 606, 607, 705, 706,
1498, 1499, 1501, 1514.
\:\\{fmt\_file}, 550, \[1483], 1484, 1486, 1507, 1508, 1509, 1517.
\:\\{fnt\_def1}, 612, \[613], 629, 715.
\:\\{fnt\_def2}, \[612].
\:\\{fnt\_def3}, \[612].
\:\\{fnt\_def4}, \[612].
\:\\{fnt\_num\_0}, 612, \[613], 649, 719, 726.
\:\\{fnt1}, 612, \[613], 649, 719, 726.
\:\\{fnt2}, \[612].
\:\\{fnt3}, \[612].
\:\\{fnt4}, \[612].
\:\\{font}, \[152], 161, 162, 192, 194, 211, 224, 574, 609, 648, 674, 705, 731,
822, 823, 825, 828, 857, 885, 891, 900, 1017, 1018, 1042, 1043, 1046, 1047,
1073, 1074, 1075, 1080, 1085, 1088, 1211, 1215, 1291, 1325, 1724, 1733.
\:{font metric files}, 565.
\:{font parameters}, 876, 877.
\:\.{Font x has only...}, 606.
\:\.{Font x=xx not loadable...}, 587.
\:\.{Font x=xx not loaded...}, 593.
\:\9{font\_}{\.{\\font} primitive}, \[287].
\:\\{font\_area}, \[575], 578, 603, 629, 630, 705, 706, 1438, 1500, 1501.
\:\\{font\_base}, 11, \[12], 129, 152, 192, 194, 240, 250, 574, 577, 629, 649,
671, 673, 674, 705, 801, 1438, 1498, 1499, 1514.
\:\\{font\_bc}, \[575], 578, 603, 604, 609, 673, 705, 706, 884, 898, 1213,
1500, 1501, 1671, 1769.
\:\\{font\_bchar}, \[575], 578, 603, 705, 706, 1074, 1075, 1092, 1209, 1211,
1500, 1501.
\:\9{font\_char\_dp\_}{\.{\\fontchardp} primitive}, \[1669].
\:\\{font\_char\_dp\_code}, \[1669], 1670, 1671.
\:\9{font\_char\_ht\_}{\.{\\fontcharht} primitive}, \[1669].
\:\\{font\_char\_ht\_code}, \[1669], 1670, 1671.
\:\9{font\_char\_ic\_}{\.{\\fontcharic} primitive}, \[1669].
\:\\{font\_char\_ic\_code}, \[1669], 1670, 1671.
\:\9{font\_char\_wd\_}{\.{\\fontcharwd} primitive}, \[1669].
\:\\{font\_char\_wd\_code}, \[1669], 1670, 1671.
\:\\{font\_check}, \[575], 594, 629, 712, 714, 1500, 1501.
\:\9{font\_dimen\_}{\.{\\fontdimen} primitive}, \[287].
\:\\{font\_dsize}, 192, 498, \[575], 578, 594, 629, 705, 706, 712, 714, 1438,
1439, 1500, 1501.
\:\\{font\_ec}, \[575], 578, 603, 604, 609, 673, 705, 706, 884, 898, 1213,
1500, 1501, 1671, 1769.
\:\\{font\_expand\_ratio}, \[821], 823, 825, 828, 834, 840.
\:\\{font\_false\_bchar}, \[575], 578, 603, 705, 706, 1209, 1211, 1500, 1501.
\:\\{font\_glue}, \[575], 578, 603, 605, 705, 706, 1220, 1500, 1501.
\:\\{font\_id\_base}, \[240], 252, 274, 441, 574, 706, 1435.
\:\\{font\_id\_text}, 192, 252, \[274], 606, 705, 706, 1435, 1500.
\:\\{font\_in\_short\_display}, \[191], 192, 211, 674, 839, 1040, 1519.
\:\\{font\_index}, \[574], 575, 586, 823, 1083, 1209, 1389.
\:\\{font\_info}, 11, 451, 574, \[575], 576, 578, 580, 583, 584, 586, 592, 595,
598, 600, 601, 602, 605, 607, 705, 706, 823, 876, 877, 889, 917, 928, 1086,
1209, 1216, 1220, 1389, 1431, 1498, 1499, 1519.
\:\\{font\_max}, \[11], 129, 192, 194, 574, 577, 592, 674, 705, 706, 1499, 1514.
\:\\{font\_mem\_size}, \[11], 574, 592, 607, 705, 706, 1499, 1514.
\:\\{font\_name}, 192, 498, \[575], 578, 603, 608, 629, 630, 693, 705, 706,
710, 712, 713, 714, 717, 1438, 1439, 1500, 1501.
\:\9{font\_name\_}{\.{\\fontname} primitive}, \[494].
\:\\{font\_name\_code}, \[494], 495, 497, 498.
\:\\{font\_params}, \[575], 578, 603, 605, 606, 607, 705, 706, 1373, 1500, 1501.
\:\\{font\_ptr}, \[575], 578, 592, 603, 605, 671, 705, 706, 801, 1438, 1498,
1499, 1514.
\:\\{font\_shrink}, 823, 825, 828, 840.
\:\\{font\_size}, 192, 498, \[575], 578, 594, 629, 692, 693, 705, 706, 712,
717, 726, 1438, 1439, 1500, 1501.
\:\\{font\_step}, 705.
\:\\{font\_stretch}, 823, 825, 828, 834.
\:\\{font\_used}, 497, \[575], 577, 649, 671, 692, 693, 801, 1587.
\:\\{fontnum}, 692.
\:\.{FONTx}, 706, 1435.
\:\.{for accent}, 209.
\:\.{Forbidden control sequence...}, 360.
\:\\{force\_eof}, 353, \[383], 384, 404.
\:\\{format\_area\_length}, \[546], 550.
\:\\{format\_default\_length}, \[546], 548, 549, 550.
\:\\{format\_ext\_length}, \[546], 549, 550.
\:\\{format\_extension}, \[546], 555, 1508.
\:\\{format\_ident}, 35, 61, 562, \[1477], 1478, 1479, 1506, 1507, 1508, 1517,
1648.
\:\\{forward}, 78, 236, 303, 362, 388, 435, 646, 703, 728, 868, 869, 896, 950,
976, 1682, 1695, 1752, 1781, 1786, 1810.
\:\\{found}, \[15], 143, 146, 147, 278, 281, 363, 376, 378, 415, 418, 420, 474,
481, 499, 501, 503, 550, 634, 636, 639, 640, 641, 693, 705, 817, 882, 884, 896,
1005, 1027, 1072, 1100, 1108, 1111, 1118, 1130, 1132, 1316, 1324, 1325, 1326,
1414, 1415, 1679, 1683, 1733, 1738, 1739, 1782, 1783, 1789, 1799, 1847, 1848.
\:\\{found1}, \[15], 693, 1072, 1079, 1480, 1493, 1679, 1799, 1800.
\:\\{found2}, \[15], 1072, 1080, 1480, 1494, 1679.
\:\\{four\_cases}, \[710], 719, 726.
\:\\{four\_choices}, \[131].
\:\\{four\_quarters}, \[131], 439, 574, 575, 580, 581, 586, 712, 823, 859, 860,
882, 885, 888, 900, 914, 925, 1083, 1209, 1301, 1480, 1481, 1753, 1756.
\:\\{fract}, 1798, \[1799], 1846.
\:\\{fraction}, 110, 112.
\:\\{fraction\_four}, 110, \[111], 116, 119, 120.
\:\\{fraction\_half}, \[111], 116, 127.
\:\\{fraction\_noad}, 110, \[859], 863, 866, 874, 909, 937, 1356, 1359.
\:\\{fraction\_noad\_size}, \[859], 874, 937, 1359.
\:\\{fraction\_one}, 110, \[111], 112, 113, 114, 124, 125.
\:\\{fraction\_rule}, \[880], 881, 911, 923.
\:\\{free}, \[183], 185, 186, 187, 188, 189.
\:\\{free\_avail}, \[139], 220, 222, 235, 426, 478, 497, 822, 948, 1092, 1213,
1288, 1404, 1466, 1577, 1683, 1705, 1757.
\:\\{free\_node}, \[148], 219, 220, 297, 522, 642, 823, 831, 874, 891, 897,
903, 927, 929, 932, 936, 948, 979, 1036, 1037, 1041, 1080, 1087, 1154, 1196,
1198, 1199, 1214, 1278, 1288, 1364, 1365, 1379, 1515, 1536, 1605, 1722, 1725,
1727, 1729, 1738, 1745, 1756, 1757, 1789, 1821, 1825, 1841.
\:\\{freeze\_page\_specs}, \[1164], 1178, 1185.
\:\\{frozen\_control\_sequence}, \[240], 277, 1393, 1492, 1496, 1497.
\:\\{frozen\_cr}, \[240], 361, 956, 1310.
\:\\{frozen\_dont\_expand}, \[240], 277, 393.
\:\\{frozen\_end\_group}, \[240], 287, 1243.
\:\\{frozen\_end\_template}, \[240], 401, 956.
\:\\{frozen\_endv}, \[240], 401, 406, 956.
\:\\{frozen\_fi}, \[240], 358, 517.
\:\\{frozen\_null\_font}, \[240], 284, 285, 579.
\:\\{frozen\_primitive}, \[240], 277, 394, 466.
\:\\{frozen\_protection}, \[240], 1393, 1394.
\:\\{frozen\_relax}, \[240], 287, 395, 405.
\:\\{frozen\_right}, \[240], 1243, 1366.
\:\\{fs}, 705, 712, 725.
\:{Fuchs, David Raymond}, 2, 610, 618.
\:\9{future\_let\_}{\.{\\futurelet} primitive}, \[1397].
\:\|{g}, \[47], \[200], \[586], \[619], \[823], \[844], \[882], \[892], \[1844].
\:\\{g\_order}, \[647], 653, \[657], 662, \[729], 735, \[738], 744, 1637, 1638,
1699, \[1723].
\:\\{g\_sign}, \[647], 653, \[657], 662, \[729], 735, \[738], 744, 1637, 1638,
1699, \[1723].
\:\\{gap\_amount}, \[1637].
\:\\{garbage}, \[180], 493, 496, 497, 1137, 1361, 1370, 1457.
\:\\{garbage\_warning}, 794.
\:\9{gdef\_}{\.{\\gdef} primitive}, \[1386].
\:\\{gen\_faked\_interword\_space}, 693, \[1628], 1629, 1639, 1645.
\:\\{gen\_running\_link}, 730, \[1628], 1629, 1639, 1645.
\:\\{geq\_define}, \[301], 958, 1392.
\:\\{geq\_word\_define}, \[301], 310, 1190, 1392.
\:\\{get}, 26, 29, 31, 33, 511, 564, 590, 1484.
\:\\{get\_auto\_kern}, 173, \[705], 1211, 1212, 1216, 1295.
\:\\{get\_avail}, \[138], 140, 222, 223, 234, 347, 348, 359, 361, 393, 394,
397, 398, 478, 499, 508, 609, 885, 948, 959, 960, 970, 1085, 1088, 1115, 1242,
1243, 1396, 1404, 1618, 1683, 1688, 1705, 1727, 1733, 1754, 1767.
\:\\{get\_chardepth}, \[673].
\:\\{get\_charheight}, \[673].
\:\\{get\_charwidth}, \[673].
\:\\{get\_ef\_code}, 452, 823.
\:\\{get\_expand\_font}, \[705].
\:\\{get\_fontbase}, \[673].
\:\\{get\_image\_group\_ref}, 1637.
\:\\{get\_kern}, \[823], 825.
\:\\{get\_kn\_ac\_code}, 452, 705.
\:\\{get\_kn\_bc\_code}, 452, 705.
\:\\{get\_kn\_bs\_code}, 452, 705.
\:\\{get\_lp\_code}, 452, 823.
\:\\{get\_microinterval}, 450, \[1555].
\:\\{get\_next}, 76, 319, 354, 358, 362, \[363], 379, 382, 386, 387, 388, 393,
406, 407, 413, 415, 504, 520, 527, 533, 816, 1215, 1223, 1304, 1766.
\:\\{get\_next\_char}, \[793].
\:\\{get\_node}, \[143], 149, 154, 157, 162, 163, 165, 169, 170, 171, 174, 176,
224, 521, 634, 823, 844, 862, 864, 865, 892, 948, 974, 1019, 1020, 1021, 1040,
1091, 1186, 1278, 1279, 1341, 1343, 1359, 1426, 1427, 1529, 1556, 1573, 1604,
1637, 1699, 1719, 1733, 1754, 1788, 1815, 1820, 1837.
\:\\{get\_nullcs}, \[673].
\:\\{get\_nullfont}, \[673].
\:\\{get\_nullptr}, \[673].
\:\\{get\_obj}, 498, 752, \[1555], 1630, 1637.
\:\\{get\_pdf\_compress\_level}, \[673].
\:\\{get\_pdf\_omit\_charset}, \[673].
\:\\{get\_pdf\_suppress\_ptex\_info}, \[673].
\:\\{get\_pdf\_suppress\_warning\_dup\_map}, \[673].
\:\\{get\_pdf\_suppress\_warning\_page\_group}, \[673].
\:\\{get\_pk\_char\_width}, 690.
\:\\{get\_preamble\_token}, \[958], 959, 960.
\:\\{get\_ptex\_use\_underscore}, \[673], 807.
\:\\{get\_quad}, \[673].
\:\\{get\_r\_token}, 706, \[1393], 1396, 1399, 1402, 1403, 1435.
\:\\{get\_resname\_prefix}, 792.
\:\\{get\_rp\_code}, 452, 823.
\:\\{get\_sa\_ptr}, \[1819], 1825, 1831.
\:\\{get\_sh\_bs\_code}, 452, 705.
\:\\{get\_slant}, \[673].
\:\\{get\_st\_bs\_code}, 452, 705.
\:\\{get\_strings\_started}, \[47], 51, 1512.
\:\\{get\_tag\_code}, 452, \[604].
\:\\{get\_tex\_dimen}, \[673].
\:\\{get\_tex\_int}, \[673].
\:\\{get\_token}, 76, 78, 88, 386, \[387], 392, 393, 394, 395, 418, 425, 468,
478, 497, 499, 500, 502, 503, 505, 509, 958, 1204, 1316, 1393, 1399, 1430,
1446, 1449, 1472, 1618, 1619, 1683, 1765, 1772.
\:\\{get\_vpos}, \[1637].
\:\\{get\_x\_height}, \[673].
\:\\{get\_x\_or\_protected}, 961, 967, \[1772].
\:\\{get\_x\_token}, 386, 388, 398, \[406], 407, 428, 430, 432, 433, 469, 470,
471, 478, 491, 505, 532, 552, 956, 1112, 1138, 1206, 1207, 1316, 1375, 1415,
1623, 1767, 1772.
\:\\{get\_x\_token\_or\_active\_char}, \[532].
\:\\{getc}, 712, 772.
\:\\{getcreationdate}, 497.
\:\\{getfiledump}, 497.
\:\\{getfilemoddate}, 497.
\:\\{getfilesize}, 497.
\:\\{getllx}, 1630, 1635.
\:\\{getlly}, 1630, 1635.
\:\\{getmatch}, 497.
\:\\{getmd5sum}, 497.
\:\\{geturx}, 1630, 1635.
\:\\{getury}, 1630, 1635.
\:\\{give\_err\_help}, 78, 89, 90, \[1462].
\:\\{global}, \[1392], 1396, 1419, 1839.
\:{global definitions}, 239, 301, 305, 1840.
\:\9{global\_}{\.{\\global} primitive}, \[1386].
\:\\{global\_box\_flag}, \[1249], 1255, 1419, 1681.
\:\\{global\_defs}, \[254], 958, 1392, 1396.
\:\9{global\_defs\_}{\.{\\globaldefs} primitive}, \[256].
\:\\{global\_defs\_code}, \[254], 255, 256.
\:\\{glue\_base}, 238, \[240], 242, 244, 245, 246, 247, 270, 958.
\:\\{glue\_break}, 1053, 1057.
\:\\{glue\_error}, \[1790].
\:\9{glue\_expr\_}{\.{\\glueexpr} primitive}, \[1778].
\:\\{glue\_node}, \[167], 170, 171, 193, 201, 220, 224, 450, 498, 650, 659,
674, 705, 732, 741, 825, 845, 906, 908, 937, 992, 993, 1005, 1013, 1032, 1038,
1042, 1055, 1057, 1076, 1080, 1145, 1149, 1150, 1165, 1173, 1174, 1177, 1284,
1285, 1286, 1325, 1380, 1637, 1726, 1733, 1746.
\:\\{glue\_offset}, \[153], 177, 204.
\:\\{glue\_ord}, \[168], 473, 647, 657, 729, 738, 818, 823, 844, 967, 1637,
1723.
\:\\{glue\_order}, \[153], 154, 177, 203, 204, 647, 657, 729, 738, 833, 834,
840, 848, 849, 852, 945, 972, 977, 983, 985, 986, 987, 1326, 1637, 1723, 1740.
\:\\{glue\_par}, \[242], 942.
\:\\{glue\_pars}, \[242].
\:\\{glue\_ptr}, \[167], 170, 171, 193, 207, 208, 220, 224, 450, 653, 662, 705,
735, 744, 832, 847, 855, 908, 962, 969, 971, 978, 979, 985, 992, 1005, 1014,
1044, 1057, 1146, 1153, 1173, 1178, 1181, 1326, 1638, 1699, 1733, 1746, 1843,
1853.
\:\\{glue\_ratio}, \[109], 128, 131, 153, 204.
\:\\{glue\_ref}, \[228], 246, 297, 958, 1406, 1414.
\:\\{glue\_ref\_count}, \[168], 169, 170, 171, 172, 182, 219, 221, 246, 942,
1221, 1238.
\:\\{glue\_set}, \[153], 154, 177, 204, 653, 662, 735, 744, 833, 834, 840, 848,
849, 852, 983, 985, 986, 987, 1326, 1638, 1699, 1740.
\:\\{glue\_shrink}, \[177], 203, 972, 975, 977, 986, 987.
\:\9{glue\_shrink\_}{\.{\\glueshrink} primitive}, \[1801].
\:\\{glue\_shrink\_code}, \[1801], 1802, 1804.
\:\9{glue\_shrink\_order\_}{\.{\\glueshrinkorder} primitive}, \[1801].
\:\\{glue\_shrink\_order\_code}, \[1801], 1802, 1803.
\:\\{glue\_sign}, \[153], 154, 177, 203, 204, 647, 657, 729, 738, 833, 834,
840, 848, 849, 852, 945, 972, 977, 983, 985, 986, 987, 1326, 1637, 1723, 1740.
\:\\{glue\_spec\_size}, \[168], 169, 180, 182, 219, 892, 1699.
\:\\{glue\_stretch}, \[177], 203, 972, 975, 977, 986, 987.
\:\9{glue\_stretch\_}{\.{\\gluestretch} primitive}, \[1801].
\:\\{glue\_stretch\_code}, \[1801], 1802, 1804.
\:\9{glue\_stretch\_order\_}{\.{\\gluestretchorder} primitive}, \[1801].
\:\\{glue\_stretch\_order\_code}, \[1801], 1802, 1803.
\:\\{glue\_temp}, \[647], 653, \[657], 662, \[729], 735, \[738], 744, 1637,
1638, \[1723].
\:\9{glue\_to\_mu\_}{\.{\\gluetomu} primitive}, \[1805].
\:\\{glue\_to\_mu\_code}, \[1805], 1806, 1808.
\:\\{glue\_val}, \[436], 437, 439, 442, 443, 450, 453, 455, 456, 477, 487, 491,
958, 1238, 1406, 1414, 1415, 1416, 1418, 1573, 1778, 1779, 1780, 1782, 1785,
1787, 1791, 1796, 1815, 1823, 1832.
\:\\{glyph\_to\_unicode}, \[1587], 1592.
\:\.{goal height}, 1163, 1164.
\:\&{goto}, \[35], \[81].
\:\\{gr}, 128, \[131], 132, 153.
\:\\{group\_code}, \[291], 293, 296, 817, 1314, 1679.
\:\\{group\_trace}, 296, 304, \[1662].
\:\\{group\_warning}, 304, \[1774].
\:\\{groupref}, 1637.
\:\\{grp\_stack}, 304, 350, 353, 384, \[1773], 1774, 1777.
\:\\{gsa\_def}, 1839, \[1840].
\:\\{gsa\_w\_def}, 1839, \[1840].
\:\&{gubed}, \[7].
\:{Guibas, Leonidas Ioannis}, 2.
\:\\{g1}, \[1376], 1381.
\:\\{g2}, \[1376], 1381, 1383, 1637.
\:\|{h}, \[222], \[278], \[281], \[823], \[844], \[914], \[1106], \[1111], %
\[1121], \[1125], \[1130], \[1143], \[1147], \[1154], \[1171], \[1264], %
\[1269], \[1301], \[1615], \[1733], \[1799].
\:\\{h\_offset}, \[265], 644, 645, 669, 755.
\:\9{h\_offset\_}{\.{\\hoffset} primitive}, \[266].
\:\\{h\_offset\_code}, \[265], 266.
\:\\{ha}, \[1069], 1073, 1077, 1080, 1089.
\:\\{half}, \[100], 882, 912, 913, 914, 921, 922, 925, 926, 1380.
\:\\{half\_buf}, 621, \[622], 623, 625, 626.
\:\\{half\_error\_line}, \[11], 14, 333, 337, 338, 339.
\:\\{halfp}, \[111], 116, 120, 125.
\:\\{halfword}, 108, 128, \[131], 133, 148, 286, 299, 301, 302, 303, 319, 320,
322, 355, 363, 388, 415, 439, 490, 499, 508, 575, 586, 604, 705, 706, 727, 857,
967, 976, 997, 1005, 1006, 1009, 1023, 1048, 1053, 1069, 1078, 1083, 1084,
1154, 1209, 1257, 1279, 1389, 1421, 1444, 1466, 1615, 1628, 1656, 1683, 1723,
1738, 1814, 1819, 1822, 1839, 1840.
\:\\{halign}, \[226], 287, 288, 1272, 1308.
\:\9{halign\_}{\.{\\halign} primitive}, \[287].
\:\\{handle\_right\_brace}, 1245, \[1246].
\:\\{hang\_after}, \[254], 258, 1023, 1025, 1248, 1327.
\:\9{hang\_after\_}{\.{\\hangafter} primitive}, \[256].
\:\\{hang\_after\_code}, \[254], 255, 256, 1248.
\:\\{hang\_indent}, \[265], 1023, 1024, 1025, 1248, 1327.
\:\9{hang\_indent\_}{\.{\\hangindent} primitive}, \[266].
\:\\{hang\_indent\_code}, \[265], 266, 1248.
\:{hanging indentation}, 1023.
\:\\{hasfmentry}, 801.
\:\\{hash}, 252, \[274], 276, 278, 279, 281, 1496, 1497.
\:\\{hash\_base}, 238, \[240], 274, 276, 278, 284, 285, 394, 395, 527, 706,
1223, 1435, 1492, 1496, 1497.
\:\\{hash\_brace}, \[499], 502.
\:\\{hash\_is\_full}, \[274], 279.
\:\\{hash\_prime}, \[12], 14, 278, 280, 1485, 1486.
\:\\{hash\_size}, \[12], 14, 240, 279, 280, 1514.
\:\\{hash\_used}, \[274], 277, 279, 1496, 1497.
\:\\{hasspacechar}, 693.
\:\\{hb}, \[1069], 1074, 1075, 1077, 1080.
\:\\{hbadness}, \[254], 836, 842, 843.
\:\9{hbadness\_}{\.{\\hbadness} primitive}, \[256].
\:\\{hbadness\_code}, \[254], 255, 256.
\:\9{hbox\_}{\.{\\hbox} primitive}, \[1249].
\:\\{hbox\_group}, \[291], 296, 1261, 1263, 1661, 1679.
\:\\{hc}, \[1069], 1070, 1073, 1074, 1075, 1077, 1078, 1096, 1097, 1100, 1107,
1108, 1111, 1114, 1116, 1137, 1139, 1140, 1142, 1858.
\:\\{hchar}, 1082, \[1083], 1085, 1086.
\:\\{hd}, \[823], 828, \[882], 884, \[885], \[888].
\:\\{head}, 230, \[231], 233, 234, 235, 450, 894, 952, 972, 975, 981, 988, 990,
992, 1203, 1232, 1258, 1264, 1269, 1274, 1278, 1283, 1291, 1297, 1299, 1323,
1337, 1346, 1354, 1359, 1362, 1363, 1365, 1369.
\:\\{head\_field}, \[230], 231, 236.
\:\\{head\_for\_vmode}, 1272, \[1273].
\:\\{head\_tab}, 693, 695, \[696], 697, 698, 789, 790, 795, 796, 797, 798, 799,
800, 801, 802, 803, 1504, 1505, 1545, 1600.
\:\\{head\_tab\_max}, \[695], 696, 697.
\:\\{header}, 568.
\:{Hedrick, Charles Locke}, 3.
\:\\{height}, \[153], 154, 156, 157, 158, 202, 205, 206, 489, 498, 580, 644,
650, 652, 654, 657, 659, 660, 663, 665, 668, 669, 732, 734, 736, 738, 739, 741,
742, 745, 746, 752, 755, 823, 827, 832, 846, 848, 855, 880, 882, 885, 887, 889,
903, 906, 911, 912, 913, 914, 915, 918, 921, 922, 923, 925, 926, 927, 932, 933,
935, 944, 945, 972, 977, 980, 982, 983, 985, 986, 987, 1005, 1065, 1146, 1150, %
\[1158], 1163, 1178, 1179, 1185, 1186, 1187, 1198, 1265, 1278, 1548, 1552,
1556, 1565, 1630, 1637, 1639, 1745.
\:\.{height}, 489.
\:\\{height\_base}, \[576], 578, 580, 592, 598, 705, 706, 1500, 1501.
\:\\{height\_depth}, \[580], 673, 828, 884, 885, 888, 1303, 1671.
\:\\{height\_index}, \[569], 580.
\:\\{height\_offset}, \[153], 442, 443, 945, 1425.
\:\\{height\_plus\_depth}, \[888], 890.
\:\.{held over for next output}, 1163.
\:\\{help\_line}, \[79], 89, 90, 358, 1284, 1390, 1391.
\:\\{help\_ptr}, \[79], 80, 89, 90.
\:\\{help0}, \[79], 1430, 1471.
\:\\{help1}, \[79], 93, 95, 310, 434, 454, 480, 512, 526, 529, 536, 1137, 1138,
1139, 1140, 1244, 1258, 1277, 1299, 1310, 1313, 1337, 1355, 1370, 1390, 1391,
1410, 1415, 1421, 1422, 1436, 1461, 1482, 1656, 1765, 1769, 1784.
\:\\{help2}, 72, \[79], 88, 89, 94, 95, 121, 310, 368, 399, 459, 460, 461, 462,
463, 468, 471, 486, 497, 501, 502, 604, 606, 669, 683, 1113, 1114, 1155, 1192,
1204, 1225, 1246, 1258, 1260, 1273, 1284, 1298, 1307, 1344, 1375, 1385, 1403,
1414, 1419, 1437, 1539, 1619, 1696, 1782, 1811.
\:\\{help3}, 72, \[79], 98, 358, 422, 441, 472, 505, 952, 959, 960, 968, 1170,
1186, 1201, 1205, 1256, 1262, 1288, 1305, 1361, 1373, 1471, 1539.
\:\\{help4}, \[79], 89, 360, 424, 429, 444, 482, 593, 899, 1153, 1181, 1228,
1461.
\:\\{help5}, \[79], 396, 587, 1002, 1242, 1247, 1306, 1393, 1471.
\:\\{help6}, \[79], 421, 485, 1306, 1339.
\:\.{Here is how much...}, 1514.
\:\\{hex\_dig1}, \[1819].
\:\\{hex\_dig2}, \[1819].
\:\\{hex\_dig3}, \[1819].
\:\\{hex\_dig4}, \[1819], 1821, 1822.
\:\\{hex\_to\_cur\_chr}, \[374], 377.
\:\\{hex\_token}, \[464], 470.
\:\\{hf}, \[1069], 1073, 1074, 1075, 1080, 1085, 1086, 1087, 1088, 1092, 1093.
\:\9{hfil\_}{\.{\\hfil} primitive}, \[1236].
\:\9{hfil\_neg\_}{\.{\\hfilneg} primitive}, \[1236].
\:\9{hfill\_}{\.{\\hfill} primitive}, \[1236].
\:\\{hfuzz}, \[265], 842.
\:\9{hfuzz\_}{\.{\\hfuzz} primitive}, \[266].
\:\\{hfuzz\_code}, \[265], 266.
\:\\{hh}, 128, \[131], 132, 136, 151, 200, 231, 237, 239, 275, 290, 862, 918,
1341, 1343, 1359, 1364, 1483, 1484, 1817.
\:\\{hi}, \[130], 250, 1410, 1754.
\:\\{hi\_mem\_min}, \[134], 136, 138, 143, 144, 152, 182, 183, 185, 186, 189,
190, 194, 315, 667, 1489, 1490, 1514.
\:\\{hi\_mem\_stat\_min}, \[180], 182, 1490.
\:\\{hi\_mem\_stat\_usage}, \[180], 182.
\:\\{history}, \[76], 77, 82, 93, 95, 263, 686, 1512, 1513, 1515, 1774, 1776,
1777.
\:\\{hlist\_node}, \[153], 154, 155, 156, 166, 177, 193, 201, 202, 220, 224,
497, 531, 643, 646, 647, 650, 659, 729, 732, 741, 816, 823, 825, 845, 857, 983,
986, 990, 1005, 1017, 1018, 1042, 1046, 1047, 1145, 1150, 1170, 1177, 1252,
1258, 1265, 1288, 1325, 1381, 1635, 1636, 1637, 1704, 1725, 1733.
\:\\{hlist\_out}, 619, 642, 643, 646, \[647], 648, 651, 656, 657, 660, 665,
666, 668, 727, 729, 869, 1620, 1699, 1726.
\:\\{hlist\_stack}, 173, \[821], 1005.
\:\\{hlist\_stack\_level}, \[821], 1005.
\:\\{hlp1}, \[79].
\:\\{hlp2}, \[79].
\:\\{hlp3}, \[79].
\:\\{hlp4}, \[79].
\:\\{hlp5}, \[79].
\:\\{hlp6}, \[79].
\:\\{hmode}, \[229], 236, 442, 527, 962, 963, 972, 975, 1207, 1223, 1224, 1226,
1234, 1235, 1249, 1251, 1254, 1257, 1261, 1264, 1269, 1270, 1271, 1272, 1274,
1275, 1287, 1288, 1290, 1294, 1295, 1297, 1300, 1308, 1315, 1378, 1421, 1625,
1679.
\:\\{hmove}, \[226], 1226, 1249, 1250, 1251, 1681.
\:\\{hn}, \[1069], 1074, 1075, 1076, 1079, 1089, 1090, 1092, 1093, 1094, 1096,
1100, 1107, 1108.
\:\\{ho}, \[130], 253, 440, 1329, 1332, 1756, 1757.
\:\\{hold\_head}, \[180], 328, 955, 959, 960, 970, 984, 1082, 1083, 1090, 1091,
1092, 1093, 1094, 1191, 1194.
\:\\{holding\_inserts}, \[254], 1191.
\:\9{holding\_inserts\_}{\.{\\holdinginserts} primitive}, \[256].
\:\\{holding\_inserts\_code}, \[254], 255, 256.
\:\\{hpack}, 180, 254, 816, 817, 818, 819, \[823], 834, 837, 885, 891, 896,
903, 913, 924, 930, 932, 972, 975, 980, 982, 1066, 1240, 1264, 1303, 1372,
1377, 1379, 1382, 1705, 1736, 1746.
\:\\{hrule}, \[226], 287, 288, 489, 1224, 1234, 1262, 1272, 1273.
\:\9{hrule\_}{\.{\\hrule} primitive}, \[287].
\:\\{hsize}, \[265], 1023, 1024, 1025, 1232, 1327.
\:\9{hsize\_}{\.{\\hsize} primitive}, \[266].
\:\\{hsize\_code}, \[265], 266.
\:\\{hskip}, \[226], 1235, 1236, 1237, 1256, 1268.
\:\9{hskip\_}{\.{\\hskip} primitive}, \[1236].
\:\9{hss\_}{\.{\\hss} primitive}, \[1236].
\:\9{ht\_}{\.{\\ht} primitive}, \[442].
\:\\{hu}, \[1069], 1070, 1074, 1075, 1078, 1080, 1082, 1084, 1085, 1087, 1088,
1089, 1092, 1093.
\:\.{Huge page...}, 669.
\:\\{hyf}, \[1077], 1079, 1082, 1085, 1086, 1090, 1091, 1096, 1097, 1100, 1101,
1109, 1137, 1138, 1139, 1140, 1142.
\:\\{hyf\_bchar}, \[1069], 1074, 1075, 1080.
\:\\{hyf\_char}, \[1069], 1073, 1090, 1092.
\:\\{hyf\_distance}, 1097, \[1098], 1099, 1101, 1120, 1121, 1122, 1502, 1503.
\:\\{hyf\_next}, 1097, \[1098], 1101, 1120, 1121, 1122, 1502, 1503.
\:\\{hyf\_node}, \[1089], 1092.
\:\\{hyf\_num}, 1097, \[1098], 1101, 1120, 1121, 1122, 1502, 1503.
\:\\{hyph\_codes}, 1854, 1858.
\:\\{hyph\_count}, \[1103], 1105, 1117, 1502, 1503, 1514.
\:\\{hyph\_data}, \[227], 1388, 1428, 1429, 1430.
\:\\{hyph\_index}, 1111, 1856, \[1858].
\:\\{hyph\_list}, \[1103], 1105, 1106, 1109, 1110, 1111, 1117, 1118, 1502, 1503.
\:\\{hyph\_pointer}, \[1102], 1103, 1104, 1106, 1111.
\:\\{hyph\_root}, 1129, 1135, 1143, \[1854], 1857.
\:\\{hyph\_size}, \[12], 1102, 1105, 1107, 1110, 1116, 1117, 1485, 1486, 1502,
1503, 1514.
\:\\{hyph\_start}, 1502, 1503, 1854, 1857, \[1858].
\:\\{hyph\_word}, \[1103], 1105, 1106, 1108, 1111, 1117, 1118, 1502, 1503.
\:\\{hyphen\_char}, 173, 452, \[575], 578, 603, 705, 706, 1068, 1073, 1212,
1295, 1431, 1500, 1501.
\:\9{hyphen\_char\_}{\.{\\hyphenchar} primitive}, \[1432].
\:\\{hyphen\_passed}, \[1082], 1083, 1086, 1090, 1091.
\:\\{hyphen\_penalty}, 163, \[254], 1045.
\:\9{hyphen\_penalty\_}{\.{\\hyphenpenalty} primitive}, \[256].
\:\\{hyphen\_penalty\_code}, \[254], 255, 256.
\:\\{hyphenate}, 1071, \[1072].
\:\\{hyphenated}, \[995], 996, 1005, 1022, 1035, 1045, 1049.
\:\.{Hyphenation trie...}, 1502.
\:\9{hyphenation\_}{\.{\\hyphenation} primitive}, \[1428].
\:\|{i}, \[19], \[125], \[337], \[439], \[496], \[604], \[614], \[699], \[702],
\[705], \[706], \[712], \[725], \[727], \[729], \[750], \[793], \[823], \[914],
\[925], \[1078], \[1301], \[1528], \[1679], \[1774], \[1776], \[1777], \[1815],
\[1819], \[1821], \[1825], \[1837].
\:\.{I can't find file x}, 556.
\:\.{I can't find PLAIN...}, 550.
\:\.{I can't go on...}, 95.
\:\.{I can't read TEX.POOL}, 51.
\:\.{I can't write on file x}, 556.
\:\\{id}, 1564.
\:\\{id\_byte}, \[614], 645, 670.
\:\\{id\_lookup}, \[278], 286, 378, 400, 1768.
\:\\{ident\_val}, \[436], 441, 491, 492.
\:\9{if\_case\_}{\.{\\ifcase} primitive}, \[513].
\:\\{if\_case\_code}, \[513], 514, 527, 1765.
\:\\{if\_cat\_code}, \[513], 514, 527.
\:\9{if\_cat\_code\_}{\.{\\ifcat} primitive}, \[513].
\:\9{if\_char\_}{\.{\\if} primitive}, \[513].
\:\\{if\_char\_code}, \[513], 527, 532.
\:\\{if\_code}, \[515], 521, 536.
\:\\{if\_cs\_code}, \[1762], 1764, 1767.
\:\9{if\_cs\_name\_}{\.{\\ifcsname} primitive}, \[1762].
\:\\{if\_cur\_ptr\_is\_null\_then\_return\_or\_goto}, \[1819].
\:\\{if\_def\_code}, \[1762], 1764, 1766.
\:\9{if\_defined\_}{\.{\\ifdefined} primitive}, \[1762].
\:\9{if\_dim\_}{\.{\\ifdim} primitive}, \[513].
\:\\{if\_dim\_code}, \[513], 514, 527.
\:\9{if\_eof\_}{\.{\\ifeof} primitive}, \[513].
\:\\{if\_eof\_code}, \[513], 514, 527.
\:\9{if\_false\_}{\.{\\iffalse} primitive}, \[513].
\:\\{if\_false\_code}, \[513], 514, 527.
\:\9{if\_font\_char\_}{\.{\\iffontchar} primitive}, \[1762].
\:\\{if\_font\_char\_code}, \[1762], 1764, 1769.
\:\9{if\_hbox\_}{\.{\\ifhbox} primitive}, \[513].
\:\\{if\_hbox\_code}, \[513], 514, 527, 531.
\:\9{if\_hmode\_}{\.{\\ifhmode} primitive}, \[513].
\:\\{if\_hmode\_code}, \[513], 514, 527.
\:\9{if\_in\_csname\_}{\.{\\ifincsname} primitive}, \[1762].
\:\\{if\_in\_csname\_code}, \[1762], 1764, 1769.
\:\9{if\_inner\_}{\.{\\ifinner} primitive}, \[513].
\:\\{if\_inner\_code}, \[513], 514, 527.
\:\9{if\_int\_}{\.{\\ifnum} primitive}, \[513].
\:\\{if\_int\_code}, \[513], 514, 527, 529.
\:\\{if\_limit}, \[515], 516, 521, 522, 523, 524, 536, 1668, 1691, 1777.
\:\\{if\_line}, 321, \[515], 516, 521, 522, 1515, 1691, 1776, 1777.
\:\\{if\_line\_field}, \[515], 521, 522, 1515, 1691, 1777.
\:\9{if\_mmode\_}{\.{\\ifmmode} primitive}, \[513].
\:\\{if\_mmode\_code}, \[513], 514, 527.
\:\\{if\_node\_size}, \[515], 521, 522, 1515.
\:\9{if\_odd\_}{\.{\\ifodd} primitive}, \[513].
\:\\{if\_odd\_code}, \[513], 514, 527.
\:\9{if\_pdfabs\_dim\_}{\.{\\ifpdfabsdim} primitive}, \[1762].
\:\\{if\_pdfabs\_dim\_code}, \[1762], 1764, 1769.
\:\9{if\_pdfabs\_num\_}{\.{\\ifpdfabsnum} primitive}, \[1762].
\:\\{if\_pdfabs\_num\_code}, \[1762], 1764, 1769.
\:\\{if\_pdfprimitive}, 1762.
\:\9{if\_pdfprimitive\_}{\.{\\ifpdfprimitive} primitive}, \[513].
\:\\{if\_pdfprimitive\_code}, \[513], 514, 527.
\:\\{if\_stack}, 350, 353, 384, 522, \[1773], 1776, 1777.
\:\\{if\_test}, \[228], 321, 358, 388, 391, 513, 514, 520, 524, 529, 1515,
1691, 1762, 1765, 1769, 1776, 1777.
\:\9{if\_true\_}{\.{\\iftrue} primitive}, \[513].
\:\\{if\_true\_code}, \[513], 514, 527.
\:\9{if\_vbox\_}{\.{\\ifvbox} primitive}, \[513].
\:\\{if\_vbox\_code}, \[513], 514, 527.
\:\9{if\_vmode\_}{\.{\\ifvmode} primitive}, \[513].
\:\\{if\_vmode\_code}, \[513], 514, 527.
\:\9{if\_void\_}{\.{\\ifvoid} primitive}, \[513].
\:\\{if\_void\_code}, \[513], 514, 527, 531.
\:\\{if\_warning}, 522, \[1776].
\:\9{ifx\_}{\.{\\ifx} primitive}, \[513].
\:\\{ifx\_code}, \[513], 514, 527.
\:\\{ignore}, \[225], 250, 354, 367.
\:\\{ignore\_depth}, \[230], 233, 1064.
\:\\{ignore\_spaces}, \[226], 277, 287, 288, 394, 439, 1223.
\:\9{ignore\_spaces\_}{\.{\\ignorespaces} primitive}, \[287].
\:\.{Illegal magnification...}, 310, 1436.
\:\.{Illegal math \\disc...}, 1298.
\:\.{Illegal parameter number...}, 505.
\:\.{Illegal unit of measure}, 480, 482, 485.
\:\\{image}, 1552, \[1637].
\:\\{image\_colordepth}, 1552.
\:\\{image\_height}, 498, 1552, 1637.
\:\\{image\_orig\_x}, \[1628].
\:\\{image\_orig\_y}, 1628.
\:\\{image\_pages}, 1552.
\:\\{image\_rotate}, 1552, 1637.
\:\\{image\_width}, 498, 1552, 1637.
\:\\{image\_x\_res}, 1552.
\:\\{image\_y\_res}, 1552.
\:\\{img\_h}, 1637.
\:\\{img\_w}, 1637.
\:\9{immediate\_}{\.{\\immediate} primitive}, \[1524].
\:\\{immediate\_code}, \[1524], 1526, 1528.
\:\.{IMPOSSIBLE}, 284.
\:\.{Improper \\beginL}, 1703.
\:\.{Improper \\beginR}, 1703.
\:\.{Improper \\endL}, 1703.
\:\.{Improper \\endR}, 1703.
\:\.{Improper \\halign...}, 952.
\:\.{Improper \\hyphenation...}, 1113.
\:\.{Improper \\prevdepth}, 444.
\:\.{Improper \\setbox}, 1419.
\:\.{Improper \\spacefactor}, 444.
\:\.{Improper `at' size...}, 1437.
\:\.{Improper alphabetic constant}, 468.
\:\.{Improper discretionary list}, 1299.
\:\.{in}, 484.
\:\\{in\_open}, 304, \[326], 335, 350, 351, 353, 384, 522, 1774, 1776, 1777.
\:\\{in\_state\_record}, \[322], 323.
\:\\{in\_stream}, \[226], 1450, 1451, 1452.
\:\.{inaccessible}, 1394.
\:\.{Incompatible glue units}, 434.
\:\.{Incompatible list...}, 1288.
\:\.{Incompatible magnification}, 310.
\:\\{incompleat\_noad}, 230, \[231], 894, 952, 1314, 1356, 1359, 1360, 1362,
1363.
\:\.{Incomplete \\if...}, 358.
\:\\{incr}, \[16], 31, 37, 42, 43, 45, 46, 53, 58, 59, 60, 65, 67, 70, 71, 82,
90, 98, 113, 138, 140, 170, 171, 188, 200, 221, 234, 279, 296, 298, 302, 316,
321, 333, 334, 343, 347, 348, 350, 365, 369, 374, 376, 377, 378, 379, 382, 384,
400, 418, 421, 423, 425, 426, 429, 433, 468, 478, 480, 490, 501, 502, 503, 520,
543, 545, 550, 557, 563, 607, 625, 647, 657, 668, 670, 674, 680, 686, 689, 693,
698, 699, 702, 705, 706, 715, 719, 720, 725, 726, 727, 729, 738, 749, 751, 788,
793, 802, 803, 805, 817, 823, 890, 974, 1021, 1053, 1074, 1075, 1087, 1088,
1091, 1092, 1100, 1107, 1108, 1114, 1116, 1117, 1118, 1121, 1131, 1133, 1139,
1140, 1141, 1163, 1199, 1202, 1212, 1216, 1247, 1295, 1297, 1299, 1305, 1320,
1331, 1350, 1352, 1493, 1494, 1496, 1517, 1536, 1537, 1544, 1548, 1552, 1562,
1587, 1635, 1637, 1648, 1668, 1679, 1683, 1691, 1711, 1717, 1728, 1739, 1754,
1755, 1761, 1768, 1782, 1797, 1800, 1819, 1821, 1837.
\:\9{indent\_}{\.{\\indent} primitive}, \[1266].
\:\\{indent\_in\_hmode}, 1266, 1270, \[1271].
\:\\{indented}, \[1269].
\:\\{index}, 322, \[324], 325, 326, 329, 335, 350, 351, 353, 384.
\:\\{index\_field}, \[322], 324, 1309, 1775.
\:\\{index\_node\_size}, \[1815], 1821, 1825.
\:\\{inf}, 473, \[474], 479.
\:\\{inf\_bad}, \[108], 175, 1027, 1028, 1029, 1032, 1039, 1151, 1182, 1194,
1847.
\:\\{inf\_dest\_names\_size}, \[695], 697.
\:\\{inf\_obj\_tab\_size}, \[695], 697.
\:\\{inf\_pdf\_mem\_size}, \[675], 677.
\:\\{inf\_pdf\_os\_buf\_size}, \[679], 681.
\:\\{inf\_penalty}, \[175], 937, 943, 992, 1005, 1007, 1151, 1182, 1190, 1381,
1383.
\:\\{inf\_pk\_dpi}, \[695].
\:\.{Infinite glue shrinkage...}, 1002, 1153, 1181, 1186.
\:\\{infinity}, \[471], 1790, 1792, 1798.
\:\\{info}, \[136], 142, 144, 158, 159, 173, 182, 190, 218, 251, 297, 313, 315,
347, 348, 359, 361, 379, 380, 393, 394, 397, 400, 415, 417, 418, 419, 420, 423,
426, 449, 478, 492, 504, 534, 632, 635, 636, 637, 638, 639, 640, 641, 642, 693,
695, 700, 766, 767, 771, 773, 775, 779, 781, 782, 783, 784, 786, 857, 865, 868,
869, 874, 896, 910, 911, 912, 913, 914, 918, 925, 930, 944, 945, 948, 955, 959,
960, 966, 969, 970, 973, 974, 977, 979, 997, 1023, 1024, 1102, 1109, 1115,
1158, 1243, 1254, 1271, 1327, 1329, 1346, 1359, 1363, 1364, 1369, 1396, 1404,
1426, 1427, 1467, 1473, 1490, 1519, 1521, 1618, 1636, 1637, 1674, 1705, 1707,
1708, 1709, 1711, 1712, 1717, 1718, 1723, 1728, 1731, 1737, 1739, 1750, 1754,
1756, 1757, 1768, 1772, 1815, 1819, 1820, 1824, 1825.
\:\&{init}, \[8], \[47], \[50], \[149], \[286], \[1068], \[1111], \[1119], %
\[1120], \[1124], \[1127], \[1430], \[1480], \[1503], \[1512], \[1515], %
\[1516], \[1648], \[1831].
\:\\{init\_align}, 949, \[950], 1308.
\:\\{init\_col}, 949, 961, \[964], 967.
\:\\{init\_cur\_lang}, 992, 1068, \[1069].
\:\\{init\_font\_base}, \[705].
\:\\{init\_l\_hyf}, 992, 1068, \[1069].
\:\\{init\_lft}, \[1077], 1080, 1082, 1085.
\:\\{init\_lig}, \[1077], 1080, 1082, 1085.
\:\\{init\_list}, \[1077], 1080, 1082, 1085.
\:\\{init\_math}, 1315, \[1316], 1705.
\:\\{init\_pdf\_output}, \[687], 688, 750.
\:\\{init\_pool\_ptr}, \[39], 42, 1488, 1512, 1514.
\:\\{init\_prim}, 1512, \[1516].
\:\\{init\_r\_hyf}, 992, 1068, \[1069].
\:\\{init\_randoms}, \[125], 1517, 1585.
\:\\{init\_row}, 949, 961, \[962].
\:\\{init\_span}, 949, 962, \[963], 967.
\:\\{init\_start\_time}, 1584.
\:\\{init\_str\_ptr}, \[39], 43, 543, 1488, 1512, 1514.
\:\\{init\_terminal}, \[37], 353.
\:\\{init\_trie}, 1068, \[1143], 1502.
\:\.{INITEX}, 8, 11, 12, 47, 50, 134, 1477, 1511, 1825, 1831.
\:\\{initialize}, \[4], 1512, 1517.
\:{inner loop}, 31, 112, 113, 116, 130, 138, 139, 140, 141, 143, 145, 146, 148,
220, 346, 347, 363, 364, 365, 379, 387, 406, 425, 433, 580, 624, 638, 648, 825,
828, 829, 1008, 1011, 1027, 1028, 1043, 1207, 1211, 1212, 1213, 1216, 1219.
\:\\{inner\_noad}, \[858], 859, 866, 872, 874, 909, 937, 940, 1334, 1335, 1369.
\:\\{input}, \[228], 388, 391, 402, 403, 1747.
\:\9{input\_}{\.{\\input} primitive}, \[402].
\:\\{input\_file}, \[326].
\:\9{input\_line\_no\_}{\.{\\inputlineno} primitive}, \[442].
\:\\{input\_line\_no\_code}, \[442], 443, 450.
\:\\{input\_ln}, 30, \[31], 37, 58, 71, 384, 511, 512, 564.
\:\\{input\_ptr}, \[323], 333, 334, 343, 344, 352, 353, 382, 560, 1309, 1515,
1774, 1776.
\:\\{input\_stack}, 84, 85, \[323], 333, 343, 344, 560, 1309, 1774, 1775, 1776.
\:\\{ins\_disc}, \[1209], 1210, 1212.
\:\\{ins\_error}, \[349], 358, 421, 1225, 1305, 1310, 1393.
\:\\{ins\_list}, \[345], 361, 493, 496, 497, 1242, 1618.
\:\\{ins\_node}, \[158], 166, 193, 201, 220, 224, 819, 825, 906, 937, 1005,
1042, 1076, 1145, 1150, 1158, 1163, 1177, 1191, 1278.
\:\\{ins\_node\_size}, \[158], 220, 224, 1199, 1278.
\:\\{ins\_ptr}, \[158], 206, 220, 224, 1187, 1197, 1198, 1278.
\:\\{ins\_the\_toks}, 388, 391, \[493].
\:\\{insert}, \[226], 287, 288, 1275.
\:\.{insert>}, 87.
\:\9{insert\_}{\.{\\insert} primitive}, \[287].
\:\\{insert\_before\_tail}, \[232], 1217.
\:\\{insert\_dollar\_sign}, 1223, \[1225].
\:\\{insert\_group}, \[291], 1246, 1277, 1278, 1661, 1679.
\:\\{insert\_penalties}, 445, \[1159], 1167, 1182, 1185, 1187, 1191, 1199,
1203, 1420, 1424.
\:\9{insert\_penalties\_}{\.{\\insertpenalties} primitive}, \[442].
\:\\{insert\_relax}, 404, \[405], 536.
\:\\{insert\_token}, \[290], 302, 304.
\:\\{inserted}, \[329], 336, 345, 346, 349, 405, 1273.
\:\\{inserting}, \[1158], 1186.
\:\.{Insertions can only...}, 1170.
\:\\{inserts\_only}, \[1157], 1164, 1185.
\:\\{int}, 128, \[131], 132, 158, 160, 175, 204, 231, 237, 254, 258, 260, 296,
300, 301, 439, 440, 515, 632, 695, 710, 901, 945, 948, 995, 1415, 1426, 1483,
1484, 1486, 1494, 1649, 1788, 1820.
\:\\{int\_base}, 238, \[248], 250, 254, 256, 257, 258, 260, 270, 271, 272, 290,
305, 310, 1190, 1248, 1317, 1323, 1493, 1649, 1657.
\:\\{int\_error}, \[91], 310, 459, 460, 461, 462, 463, 497, 683, 1421, 1422,
1436, 1696, 1811.
\:\\{int\_par}, \[254], 673.
\:\\{int\_pars}, \[254].
\:\\{int\_val}, \[436], 437, 439, 440, 442, 443, 444, 445, 448, 449, 450, 452,
453, 454, 455, 465, 466, 475, 487, 491, 497, 1402, 1414, 1415, 1416, 1418,
1489, 1490, 1537, 1778, 1779, 1780, 1783, 1785, 1790, 1792, 1795, 1798, 1815,
1816, 1818, 1823, 1832.
\:\\{integer}, 3, 13, 19, 45, 47, 54, 59, 60, 63, 66, 67, 69, 82, 91, 94, 96,
100, 101, 102, 105, 106, 107, 108, 109, 110, 112, 114, 117, 119, 122, 124, 125,
126, 127, 128, 131, 135, 143, 176, 181, 190, 191, 192, 194, 195, 196, 199, 200,
229, 230, 236, 243, 255, 264, 265, 274, 278, 281, 284, 286, 300, 301, 308, 314,
320, 321, 326, 330, 331, 333, 337, 388, 436, 439, 466, 474, 476, 496, 508, 515,
519, 520, 524, 544, 545, 549, 575, 576, 586, 597, 604, 605, 608, 619, 622, 627,
628, 634, 642, 643, 647, 657, 666, 673, 674, 676, 678, 680, 682, 686, 687, 689,
690, 691, 692, 693, 694, 696, 698, 700, 701, 702, 705, 706, 707, 708, 710, 712,
720, 725, 727, 750, 772, 774, 778, 793, 795, 797, 817, 818, 821, 823, 837, 867,
870, 875, 882, 892, 893, 902, 914, 928, 940, 999, 1004, 1005, 1006, 1009, 1048,
1053, 1069, 1089, 1099, 1143, 1147, 1157, 1159, 1171, 1189, 1207, 1209, 1246,
1253, 1257, 1262, 1269, 1295, 1297, 1316, 1329, 1333, 1372, 1389, 1414, 1471,
1480, 1481, 1505, 1511, 1513, 1518, 1528, 1543, 1545, 1547, 1550, 1552, 1555,
1556, 1557, 1559, 1562, 1564, 1570, 1583, 1600, 1615, 1617, 1627, 1628, 1630,
1632, 1637, 1679, 1705, 1744, 1753, 1756, 1777, 1782, 1793, 1797, 1799, 1839,
1840.
\:\9{inter\_line\_penalties\_}{\.{\\interlinepenalties} primitive}, \[1864].
\:\\{inter\_line\_penalties\_loc}, \[248], 1248, 1864, 1865.
\:\\{inter\_line\_penalties\_ptr}, 1067, 1248, \[1864].
\:\\{inter\_line\_penalty}, \[254], 1067.
\:\9{inter\_line\_penalty\_}{\.{\\interlinepenalty} primitive}, \[256].
\:\\{inter\_line\_penalty\_code}, \[254], 255, 256.
\:\\{interaction}, 71, 72, \[73], 74, 75, 82, 83, 84, 86, 90, 92, 93, 98, 382,
385, 510, 556, 686, 1443, 1461, 1471, 1472, 1475, 1506, 1507, 1508, 1515, 1694.
\:\9{interaction\_mode\_}{\.{\\interactionmode} primitive}, \[1692].
\:\\{internal\_font\_number}, 192, \[574], 575, 576, 586, 604, 605, 608, 609,
629, 643, 673, 686, 690, 691, 692, 693, 705, 706, 710, 712, 720, 725, 821, 823,
882, 885, 887, 888, 891, 900, 914, 1006, 1038, 1069, 1209, 1291, 1301, 1316,
1389, 1435, 1587.
\:\\{interrupt}, \[96], 97, 98, 1208.
\:\.{Interruption}, 98.
\:\.{interwoven alignment preambles...}, 346, 958, 965, 967, 1309.
\:\\{int0}, 694, 695, 1504, 1505.
\:\\{int1}, 694, 695, 1504, 1505.
\:\\{int2}, 694, 695, 1505.
\:\\{int3}, 694, 695, 1504, 1505.
\:\\{int4}, 694, 695, 1504, 1505.
\:\.{Invalid code}, 1410.
\:\.{Invalid negative color stack number}, 1539.
\:\\{invalid\_char}, \[225], 250, 366.
\:\\{invalid\_code}, \[22], 24, 250.
\:\\{is\_char\_node}, \[152], 192, 201, 220, 223, 450, 498, 648, 658, 674, 705,
731, 740, 823, 825, 845, 891, 896, 897, 932, 981, 992, 1005, 1013, 1017, 1018,
1042, 1043, 1044, 1046, 1047, 1055, 1057, 1073, 1074, 1076, 1080, 1213, 1217,
1218, 1258, 1283, 1288, 1291, 1299, 1325, 1380, 1637, 1707, 1724, 1733, 1738.
\:\\{is\_empty}, \[142], 145, 187, 188.
\:\\{is\_error}, 1537.
\:\\{is\_hex}, \[374], 377.
\:\\{is\_hex\_char}, \[702].
\:\\{is\_hex\_string}, 702.
\:\\{is\_in\_csname}, \[389], 390, 398, 1767, 1769.
\:\\{is\_letterspaced\_font}, \[706].
\:\\{is\_names}, 804, 805, 1513.
\:\\{is\_obj\_scheduled}, \[695], 1630, 1635.
\:\\{is\_obj\_written}, \[695], 773, 775, 779, 784, 812, 813, 814.
\:\\{is\_pdf\_image}, 498, 1552, 1637.
\:\\{is\_png\_image}, 1637.
\:\\{is\_root}, 802, 803, 1513.
\:\\{is\_running}, \[156], 194, 652, 661, 730, 734, 739, 743, 982, 1552, 1630,
1635, 1637.
\:\\{is\_shipping\_page}, 750, 1630, 1635, 1637, \[1640], 1641.
\:\\{is\_unless}, \[524].
\:\\{is\_valid\_char}, 604, \[673], 705, 717, 726, 731.
\:\\{isscalable}, 690, 693.
\:\\{issue\_message}, 1454, \[1457].
\:\\{ital\_corr}, \[226], 287, 288, 1289, 1290.
\:{italic correction}, \[569].
\:\\{italic\_base}, \[576], 578, 580, 592, 598, 705, 706, 1500, 1501.
\:\\{italic\_index}, \[569].
\:\\{its\_all\_over}, 1223, \[1232], 1515.
\:\\{i1}, 1537.
\:\\{i2}, 1537.
\:\|{j}, \[45], \[46], \[59], \[60], \[69], \[70], \[125], \[278], \[281], %
\[286], \[337], \[388], \[496], \[508], \[545], \[549], \[550], \[666], \[686],
\[693], \[749], \[1070], \[1078], \[1083], \[1111], \[1143], \[1316], \[1389], %
\[1480], \[1481], \[1528], \[1617], \[1620], \[1656], \[1679], \[1741], \[1744].
\:\\{j\_random}, \[110], 124, 126, 127.
\:{Japanese characters}, 152, 612.
\:{Jensen, Kathleen}, 10.
\:\\{jj}, \[125].
\:\.{job aborted}, 382.
\:\.{job aborted, file error...}, 556.
\:\\{job\_name}, 92, 497, 498, \[553], 554, 555, 558, 560, 563, 684, 1435,
1508, 1515.
\:\9{job\_name\_}{\.{\\jobname} primitive}, \[494].
\:\\{job\_name\_code}, \[494], 496, 497, 498.
\:\\{jump\_out}, \[81], 82, 84, 93.
\:\\{just\_box}, \[990], 1065, 1066, 1326, 1734, 1740.
\:\\{just\_copy}, \[1733], 1734, 1738.
\:\\{just\_open}, \[506], 509, 1453.
\:\\{just\_reverse}, 1737, \[1738].
\:\\{j1}, \[793], 1537.
\:\\{j2}, 793, 1537.
\:\|{k}, \[45], \[46], \[47], \[64], \[65], \[67], \[69], \[71], \[102], %
\[119], \[124], \[125], \[181], \[278], \[281], \[286], \[363], \[385], \[433],
\[476], \[490], \[545], \[549], \[551], \[556], \[560], \[586], \[614], \[624],
\[629], \[634], \[666], \[686], \[693], \[702], \[705], \[706], \[712], \[823],
\[881], \[1083], \[1106], \[1111], \[1137], \[1143], \[1257], \[1389], \[1480],
\[1481], \[1518], \[1528], \[1545], \[1552], \[1562], \[1615], \[1637], %
\[1656], \[1815].
\:\\{kern}, \[226], 571, 1235, 1236, 1237.
\:\9{kern\_}{\.{\\kern} primitive}, \[1236].
\:\\{kern\_base}, \[576], 578, 583, 592, 600, 603, 705, 706, 1500, 1501.
\:\\{kern\_base\_offset}, \[583], 592, 600, 705.
\:\\{kern\_break}, \[1042].
\:\\{kern\_flag}, \[571], 823, 917, 929, 1086, 1218.
\:\\{kern\_node}, \[173], 174, 201, 220, 224, 450, 650, 659, 674, 705, 732,
741, 825, 845, 897, 906, 908, 937, 1005, 1013, 1017, 1018, 1032, 1042, 1044,
1046, 1047, 1055, 1057, 1073, 1074, 1076, 1145, 1149, 1150, 1153, 1173, 1174,
1177, 1181, 1284, 1285, 1286, 1299, 1325, 1637, 1699, 1711, 1717, 1725, 1728,
1733, 1739.
\:\\{kern\_shrink}, \[823], 825, 1015.
\:\\{kern\_stretch}, \[823], 825, 1015.
\:\\{kk}, \[476], 478, 749.
\:\\{kn}, \[705].
\:\9{kn\_ac\_code\_}{\.{\\knaccode} primitive}, \[1432].
\:\\{kn\_ac\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\9{kn\_bc\_code\_}{\.{\\knbccode} primitive}, \[1432].
\:\\{kn\_bc\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\9{kn\_bs\_code\_}{\.{\\knbscode} primitive}, \[1432].
\:\\{kn\_bs\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:{Knuth, Donald Ervin}, 2, 86, 869, 989, 1068, 1102, 1174, 1332, 1618, 1679,
1700.
\:\\{kpse\_init\_prog}, 792.
\:\\{kpse\_pk\_format}, 792.
\:\\{kpse\_set\_program\_enabled}, 792.
\:\\{kpse\_src\_compile}, 792.
\:\|{l}, \[47], \[127], \[278], \[281], \[286], \[298], \[303], \[314], \[321],
\[337], \[520], \[523], \[560], \[628], \[642], \[823], \[844], \[1005], %
\[1006], \[1078], \[1121], \[1130], \[1137], \[1316], \[1372], \[1414], %
\[1471], \[1480], \[1518], \[1624], \[1679], \[1723], \[1738], \[1753], %
\[1777], \[1782], \[1825].
\:\\{L\_code}, \[165], 193, 210, 1042, 1073, 1076, 1717, 1718, 1736, 1737.
\:\\{l\_hyf}, 1068, \[1069], 1071, 1076, 1079, 1100, 1609, 1610.
\:\\{language}, \[254], 1111, 1211, 1624.
\:\9{language\_}{\.{\\language} primitive}, \[256].
\:\\{language\_code}, \[254], 255, 256.
\:\\{language\_node}, \[1521], 1603, 1604, 1605, 1609, 1610, 1620, 1624, 1625.
\:\\{large\_attempt}, \[882].
\:\\{large\_char}, \[859], 867, 873, 882, 1338.
\:\\{large\_fam}, \[859], 867, 873, 882, 1338.
\:\\{last}, \[30], 31, 35, 36, 37, 71, 83, 87, 88, 353, 382, 385, 509, 550,
557, 1756.
\:\\{last\_active}, \[995], 996, 1008, 1011, 1020, 1030, 1036, 1037, 1039,
1040, 1041, 1049, 1050, 1051.
\:\\{last\_attr}, 1600.
\:\\{last\_badness}, 450, \[818], 820, 823, 836, 840, 843, 844, 850, 852, 854.
\:\\{last\_bop}, \[619], 620, 668, 670.
\:\9{last\_box\_}{\.{\\lastbox} primitive}, \[1249].
\:\\{last\_box\_code}, \[1249], 1250, 1257, 1515, 1859, 1861, 1862.
\:\\{last\_glue}, 450, \[1159], 1168, 1173, 1194, 1284, 1515.
\:\\{last\_ins\_ptr}, \[1158], 1182, 1185, 1195, 1197.
\:\\{last\_item}, \[226], 439, 442, 443, 1226, 1649, 1663, 1666, 1669, 1672,
1778, 1801, 1805.
\:\\{last\_kern}, 450, \[1159], 1168, 1173.
\:\9{last\_kern\_}{\.{\\lastkern} primitive}, \[442].
\:\\{last\_leftmost\_char}, \[821], 822, 823, 1063.
\:\\{last\_line\_fill}, 992, \[1842], 1843, 1853.
\:\\{last\_line\_fit}, \[254], 1842, 1843, 1846.
\:\9{last\_line\_fit\_}{\.{\\lastlinefit} primitive}, \[1657].
\:\\{last\_line\_fit\_code}, \[254], 1657, 1659.
\:\\{last\_node\_type}, 450, \[1159], 1168, 1173.
\:\9{last\_node\_type\_}{\.{\\lastnodetype} primitive}, \[1649].
\:\\{last\_node\_type\_code}, \[442], 450, 1649, 1650.
\:\\{last\_nonblank}, \[31].
\:\\{last\_penalty}, 450, \[1159], 1168, 1173.
\:\9{last\_penalty\_}{\.{\\lastpenalty} primitive}, \[442].
\:\\{last\_pos}, 1637.
\:\\{last\_rightmost\_char}, \[821], 822, 823, 1057.
\:\9{last\_skip\_}{\.{\\lastskip} primitive}, \[442].
\:\\{last\_special\_line}, \[1023], 1024, 1025, 1026, 1066.
\:\\{last\_text\_char}, \[19], 24.
\:\\{last\_thread}, 739, 754, \[1628], 1637.
\:\\{last\_tokens\_string}, 686, \[708], 709, 1563, 1630.
\:\\{latespecial\_node}, 727, \[1521], 1534, 1603, 1604, 1605, 1615, 1620,
1639, 1645.
\:\\{lc}, 823.
\:\\{lc\_code}, \[248], 250, 1068, 1139, 1854, 1856, 1857, 1858.
\:\9{lc\_code\_}{\.{\\lccode} primitive}, \[1408].
\:\\{lc\_code\_base}, \[248], 253, 1408, 1409, 1464, 1465, 1466.
\:\\{leader\_box}, \[647], 654, 656, \[657], 663, 665, \[729], 736, 737, %
\[738], 745, 746.
\:\\{leader\_flag}, \[1249], 1251, 1256, 1262, 1681.
\:\\{leader\_ht}, \[657], 663, 664, 665, \[738], 745, 746.
\:\\{leader\_ptr}, \[167], 170, 171, 208, 220, 224, 654, 663, 736, 745, 832,
847, 992, 1256, 1733.
\:\\{leader\_ship}, \[226], 1249, 1250, 1251, 1681.
\:\\{leader\_wd}, \[647], 654, 655, 656, \[729], 736, 737.
\:{leaders}, 1622.
\:\.{Leaders not followed by...}, 1256.
\:\9{leaders\_}{\.{\\leaders} primitive}, \[1249].
\:\\{least\_cost}, \[1147], 1151, 1157.
\:\\{least\_page\_cost}, \[1157], 1164, 1182, 1183.
\:\\{left}, 693.
\:\9{left\_}{\.{\\left} primitive}, \[1366].
\:\\{left\_brace}, \[225], 311, 316, 320, 369, 379, 429, 499, 953, 1241, 1328,
1404.
\:\\{left\_brace\_limit}, \[311], 347, 348, 418, 420, 425, 502.
\:\\{left\_brace\_token}, \[311], 429, 1305, 1404, 1618.
\:\\{left\_delimiter}, \[859], 872, 873, 913, 924, 1341, 1359, 1360.
\:\\{left\_edge}, \[647], 655, \[657], 660, 661, 665, \[729], 730, \[738], 739,
742, 743, 746, 1639, 1643, 1644, 1645, 1719, 1720, 1722.
\:\\{left\_hyphen\_min}, \[254], 1269, 1378, 1624, 1625.
\:\9{left\_hyphen\_min\_}{\.{\\lefthyphenmin} primitive}, \[256].
\:\\{left\_hyphen\_min\_code}, \[254], 255, 256.
\:\9{left\_margin\_kern\_}{\.{\\leftmarginkern} primitive}, \[494].
\:\\{left\_margin\_kern\_code}, \[494], 495, 497, 498.
\:\\{left\_noad}, 230, \[863], 866, 872, 874, 901, 903, 904, 909, 936, 937,
938, 1363, 1366, 1367, 1369, 1679.
\:\\{left\_pw}, 822, \[823], 1005, 1063.
\:\\{left\_right}, \[226], 1224, 1366, 1367, 1368, 1697.
\:\\{left\_side}, \[173], 201, 498, 823, 1063.
\:\\{left\_skip}, \[242], 1003, 1056, 1063, 1740, 1843.
\:\9{left\_skip\_}{\.{\\leftskip} primitive}, \[244].
\:\\{left\_skip\_code}, \[242], 243, 244, 498, 1063, 1740, 1746.
\:\\{left\_to\_right}, \[643], 1706, 1714, 1730, 1735.
\:\\{len}, 693.
\:\\{length}, \[40], 46, 278, 281, 563, 629, 686, 693, 702, 706, 712, 727, 749,
793, 801, 807, 1108, 1118, 1458, 1630.
\:{length of lines}, 1023.
\:\9{leq\_no\_}{\.{\\leqno} primitive}, \[1319].
\:\\{let}, \[227], 1388, 1397, 1398, 1399.
\:\9{let\_}{\.{\\let} primitive}, \[1397].
\:\\{letter}, \[225], 250, 284, 311, 313, 316, 320, 369, 376, 378, 1112, 1138,
1206, 1207, 1215, 1268, 1302, 1329, 1332, 1338.
\:\\{letter\_space\_font}, \[706].
\:\\{letter\_token}, \[311], 471.
\:\\{letterspace\_font}, \[227], 287, 288, 439, 604, 1388, 1434.
\:\9{letterspace\_font\_}{\.{\\letterspacefont} primitive}, \[287].
\:\\{level}, 436, \[439], 441, 444, 454, \[487], 1780.
\:\\{level\_boundary}, \[290], 292, 296, 304.
\:\\{level\_one}, \[239], 246, 250, 272, 277, 286, 294, 299, 300, 301, 302,
303, 305, 956, 1482, 1515, 1616, 1665, 1820, 1840, 1841.
\:\\{level\_zero}, \[239], 240, 294, 298, 302, 1836.
\:\\{lf}, 566, \[586], 591, 592, 602, 603, \[705], \[706], 720.
\:\\{lft\_hit}, 1083, \[1084], 1085, 1087, 1088, 1210, 1212, 1218.
\:\\{lh}, 128, \[131], 132, 136, 231, 237, 274, 275, 566, 567, \[586], 591,
592, 594, 861, 1127, 1817.
\:{Liang, Franklin Mark}, 2, 1096.
\:\\{libpdffinish}, 794.
\:\\{lig\_char}, \[161], 162, 211, 224, 705, 823, 825, 826, 1017, 1018, 1042,
1046, 1047, 1075, 1080, 1291, 1727, 1733.
\:\\{lig\_kern}, 570, 571, 575.
\:\\{lig\_kern\_base}, \[576], 578, 583, 592, 598, 600, 603, 705, 706, 1500,
1501.
\:\\{lig\_kern\_command}, 567, \[571].
\:\\{lig\_kern\_restart}, \[583], 823, 917, 928, 1086, 1216.
\:\\{lig\_kern\_restart\_end}, \[583].
\:\\{lig\_kern\_start}, \[583], 823, 917, 928, 1086, 1216.
\:\\{lig\_ptr}, \[161], 162, 193, 211, 220, 224, 823, 1073, 1075, 1080, 1084,
1087, 1088, 1214, 1218, 1727.
\:\\{lig\_stack}, \[1084], 1085, 1087, 1088, 1209, 1211, 1212, 1213, 1214,
1215, 1218.
\:\\{lig\_tag}, \[570], 595, 604, 705, 823, 917, 928, 1086, 1216.
\:\\{lig\_trick}, \[180], 648, 731, 826.
\:\\{ligature\_node}, \[161], 162, 166, 193, 201, 220, 224, 650, 705, 732, 823,
825, 928, 1017, 1018, 1042, 1046, 1047, 1073, 1074, 1076, 1080, 1291, 1299,
1325, 1727, 1733.
\:\\{ligature\_present}, 1083, \[1084], 1085, 1087, 1088, 1210, 1212, 1214,
1218.
\:\\{limit}, 322, \[324], 325, 329, 340, 350, 352, 353, 365, 370, 372, 373,
374, 376, 377, 378, 382, 384, 385, 509, 512, 563, 564, 1517, 1755, 1761.
\:\.{Limit controls must follow...}, 1337.
\:\\{limit\_field}, 35, 87, \[322], 324, 560.
\:\\{limit\_switch}, \[226], 1224, 1334, 1335, 1336.
\:\\{limits}, \[858], 872, 909, 925, 1334, 1335.
\:\9{limits\_}{\.{\\limits} primitive}, \[1334].
\:\\{line}, 84, 234, 296, 321, \[326], 335, 350, 351, 353, 384, 450, 520, 521,
564, 839, 851, 1202, 1755.
\:\\{line\_break}, 180, 990, \[991], 999, 1004, 1015, 1024, 1038, 1039, 1042,
1052, 1071, 1111, 1144, 1147, 1159, 1274, 1323.
\:\\{line\_diff}, \[1048], 1051.
\:\\{line\_number}, \[995], 996, 1009, 1011, 1021, 1022, 1026, 1040, 1048,
1050, 1051.
\:\\{line\_penalty}, \[254], 1035.
\:\9{line\_penalty\_}{\.{\\linepenalty} primitive}, \[256].
\:\\{line\_penalty\_code}, \[254], 255, 256.
\:\\{line\_skip}, \[242], 265.
\:\9{line\_skip\_}{\.{\\lineskip} primitive}, \[244].
\:\\{line\_skip\_code}, 167, 170, \[242], 243, 244, 855.
\:\\{line\_skip\_limit}, \[265], 855.
\:\9{line\_skip\_limit\_}{\.{\\lineskiplimit} primitive}, \[266].
\:\\{line\_skip\_limit\_code}, \[265], 266.
\:\\{line\_stack}, \[326], 335, 350, 351.
\:\\{line\_width}, \[1006], 1026, 1027.
\:\\{link}, \[136], 138, 139, 140, 141, 142, 143, 144, 148, 151, 152, 153, 158,
159, 160, 161, 168, 182, 186, 190, 192, 193, 194, 200, 220, 222, 230, 232, 236,
241, 251, 314, 317, 321, 328, 341, 345, 348, 361, 379, 380, 388, 393, 394, 397,
400, 415, 416, 417, 420, 422, 423, 426, 433, 450, 478, 490, 492, 493, 496, 497,
498, 504, 515, 521, 522, 523, 534, 632, 634, 636, 638, 642, 648, 650, 658, 674,
686, 693, 695, 700, 705, 727, 731, 732, 740, 766, 767, 771, 772, 773, 775, 779,
781, 782, 783, 784, 786, 823, 825, 826, 828, 831, 842, 845, 855, 857, 865, 881,
887, 891, 894, 895, 896, 897, 903, 907, 908, 911, 913, 914, 915, 923, 924, 927,
928, 929, 930, 931, 932, 935, 936, 937, 942, 943, 946, 948, 954, 955, 959, 960,
962, 966, 967, 969, 970, 971, 972, 973, 974, 975, 977, 978, 979, 980, 981, 982,
983, 984, 985, 988, 990, 992, 995, 997, 998, 1005, 1006, 1013, 1016, 1019,
1020, 1021, 1030, 1033, 1034, 1036, 1037, 1038, 1039, 1040, 1041, 1042, 1043,
1045, 1049, 1050, 1051, 1053, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062,
1063, 1067, 1071, 1073, 1074, 1075, 1076, 1080, 1082, 1083, 1084, 1085, 1087,
1088, 1090, 1091, 1092, 1093, 1094, 1095, 1109, 1115, 1137, 1145, 1146, 1147,
1150, 1156, 1157, 1158, 1163, 1165, 1168, 1171, 1175, 1176, 1177, 1178, 1182,
1185, 1186, 1191, 1194, 1195, 1196, 1197, 1198, 1199, 1200, 1203, 1212, 1213,
1214, 1217, 1218, 1219, 1221, 1242, 1243, 1254, 1258, 1264, 1269, 1278, 1279,
1288, 1295, 1297, 1298, 1299, 1301, 1303, 1324, 1333, 1346, 1359, 1362, 1363,
1364, 1365, 1369, 1372, 1374, 1377, 1382, 1383, 1384, 1396, 1404, 1457, 1466,
1473, 1475, 1489, 1490, 1515, 1519, 1521, 1529, 1545, 1565, 1573, 1577, 1615,
1618, 1623, 1636, 1637, 1668, 1683, 1688, 1691, 1705, 1707, 1709, 1712, 1721,
1722, 1724, 1725, 1727, 1729, 1733, 1734, 1735, 1738, 1740, 1745, 1746, 1753,
1754, 1756, 1757, 1768, 1772, 1776, 1777, 1788, 1789, 1815, 1819, 1820, 1821,
1822, 1823, 1824, 1825, 1828, 1837, 1841, 1863.
\:\\{link\_node}, 730, 1632, 1635, 1636.
\:\\{list\_offset}, \[153], 647, 729, 823, 945, 1195.
\:\\{list\_ptr}, \[153], 154, 202, 220, 224, 498, 647, 651, 657, 660, 729, 733,
738, 742, 823, 834, 839, 840, 844, 849, 852, 885, 887, 891, 897, 915, 923, 927,
983, 1005, 1154, 1156, 1198, 1265, 1278, 1288, 1377, 1733, 1734, 1740, 1745,
1746.
\:\\{list\_state\_record}, \[230], 231.
\:\\{list\_tag}, \[570], 595, 596, 604, 705, 884, 916, 925.
\:\\{literal}, \[693], 726, 727.
\:\\{literal\_mode}, 693, 727.
\:\\{ll}, \[1130], 1133.
\:\\{llink}, \[142], 144, 145, 147, 148, 149, 163, 167, 182, 187, 948, 995,
997, 1490.
\:\\{ln}, 686.
\:\\{lo\_mem\_max}, \[134], 138, 143, 144, 182, 183, 185, 187, 188, 189, 190,
196, 667, 1489, 1490, 1501, 1514.
\:\\{lo\_mem\_stat\_max}, \[180], 182, 453, 1399, 1415, 1490, 1832, 1834.
\:\\{load\_expand\_font}, \[705].
\:\\{load\_fmt\_file}, \[1481], 1517.
\:\\{loc}, \[36], 37, 87, 322, 324, 325, 329, 334, 336, 340, 341, 345, 347,
348, 350, 352, 353, 365, 370, 372, 373, 374, 376, 378, 379, 380, 382, 384, 393,
394, 416, 509, 550, 563, 564, 1203, 1204, 1517, 1648, 1755, 1761.
\:\\{loc\_field}, 35, 36, \[322], 324, 1309.
\:\\{local\_base}, 238, \[242], 246, 248, 270.
\:\\{location}, \[632], 634, 639, 640, 641, 642.
\:\\{log\_file}, \[54], 56, 75, 560, 1513.
\:\\{log\_name}, \[558], 560, 1513.
\:\\{log\_only}, \[54], 57, 58, 62, 75, 98, 382, 560, 1508, 1617.
\:\\{log\_opened}, 92, 93, \[553], 554, 560, 561, 1443, 1513, 1514.
\:\.{Logarithm...replaced by 0}, 121.
\:\9{long\_}{\.{\\long} primitive}, \[1386].
\:\\{long\_call}, \[228], 297, 388, 413, 415, 418, 425, 1473.
\:\\{long\_char}, \[710], 712, 717.
\:\\{long\_help\_seen}, \[1459], 1460, 1461.
\:\\{long\_outer\_call}, \[228], 297, 388, 413, 415, 1473.
\:\\{long\_state}, 361, \[413], 417, 418, 421, 422, 425.
\:\\{longinteger}, 65, 680, 685, 686, 694, 696, 702.
\:\&{loop}, 15, \[16].
\:\.{Loose \\hbox...}, 836.
\:\.{Loose \\vbox...}, 850.
\:\\{loose\_fit}, \[993], 1010, 1028, 1847.
\:\\{looseness}, \[254], 1024, 1049, 1051, 1248.
\:\9{looseness\_}{\.{\\looseness} primitive}, \[256].
\:\\{looseness\_code}, \[254], 255, 256, 1248.
\:\9{lower\_}{\.{\\lower} primitive}, \[1249].
\:\9{lowercase\_}{\.{\\lowercase} primitive}, \[1464].
\:\\{lp}, 822, \[1005].
\:\9{lp\_code\_}{\.{\\lpcode} primitive}, \[1432].
\:\\{lp\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\\{lq}, \[619], 655, 664.
\:\\{lr}, \[619], 655, 664.
\:\\{LR\_box}, 230, \[231], 1323, 1384, 1742.
\:\\{LR\_dir}, \[1717], 1728, 1737, 1739.
\:\\{LR\_problems}, \[1705], 1706, 1711, 1712, 1713, 1717, 1718, 1723, 1728,
1730, 1735, 1739.
\:\\{LR\_ptr}, \[1053], \[1705], 1706, 1707, 1708, 1709, 1711, 1712, 1717,
1718, 1723, 1728, 1730, 1735, 1737, 1739.
\:\\{LR\_save}, 230, \[231], 1053, 1274, 1731.
\:\\{lx}, \[647], 654, 655, 656, \[657], 663, 664, 665, \[729], 736, 737, %
\[738], 745, 746.
\:\|{m}, \[47], \[65], \[176], \[229], \[236], \[314], \[337], \[415], \[439], %
\[466], \[508], \[524], \[604], \[823], \[844], \[882], \[892], \[893], %
\[1257], \[1283], \[1372], \[1471], \[1518], \[1555], \[1679], \[1723], %
\[1738], \[1753].
\:\\{M\_code}, \[165].
\:\\{m\_exp}, 110.
\:\\{m\_log}, 110, \[119], 121, 127.
\:\\{mac\_param}, \[225], 313, 316, 320, 369, 500, 503, 505, 959, 960, 1223.
\:{MacKay, Pierre}, 1700.
\:\\{macro}, \[329], 336, 341, 345, 346, 416.
\:\\{macro\_call}, 313, 388, 406, 408, 413, 414, \[415], 417.
\:\\{macro\_def}, \[499], 503.
\:\\{mag}, \[254], 258, 310, 483, 612, \[614], 615, 617, 645, 670, 690, 758.
\:\9{mag\_}{\.{\\mag} primitive}, \[256].
\:\\{mag\_code}, \[254], 255, 256, 310.
\:\\{mag\_set}, \[308], 309, 310.
\:\\{magic\_offset}, \[940], 941, 942.
\:\\{main\_control}, 286, 1206, \[1207], 1209, 1218, 1219, 1230, 1232, 1233,
1234, 1235, 1304, 1312, 1386, 1468, 1512, 1517, 1524, 1527.
\:\\{main\_f}, \[1209], 1211, 1212, 1213, 1214, 1215, 1216, 1218.
\:\\{main\_i}, \[1209], 1213, 1214, 1216, 1218.
\:\\{main\_j}, \[1209], 1216, 1218.
\:\\{main\_k}, \[1209], 1211, 1216, 1218, 1220.
\:\\{main\_lig\_loop}, \[1207], 1211, 1214, 1215, 1216, 1218.
\:\\{main\_loop}, \[1207].
\:\\{main\_loop\_lookahead}, \[1207], 1211, 1213, 1214, 1215.
\:\\{main\_loop\_move}, \[1207], 1211, 1213, 1217, 1218.
\:\\{main\_loop\_move\_lig}, \[1207], 1211, 1213, 1214.
\:\\{main\_loop\_wrapup}, \[1207], 1211, 1216, 1218.
\:\\{main\_p}, \[1209], 1212, 1214, 1218, 1219, 1220, 1221, 1222.
\:\\{main\_s}, \[1209], 1211.
\:\\{major\_tail}, \[1089], 1091, 1094, 1095.
\:\\{make\_accent}, 1300, \[1301].
\:\\{make\_box}, \[226], 1249, 1250, 1251, 1257, 1262.
\:\\{make\_cstring}, 792.
\:\\{make\_font\_copy}, \[706], 1434.
\:\\{make\_frac}, 110, \[112], 127.
\:\\{make\_fraction}, 110, 909, 910, \[919], 1799.
\:\\{make\_left\_right}, 937, \[938].
\:\\{make\_mark}, 1275, \[1279].
\:\\{make\_math\_accent}, 909, \[914].
\:\\{make\_name\_string}, \[551].
\:\\{make\_op}, 909, \[925].
\:\\{make\_ord}, 909, \[928].
\:\\{make\_over}, 909, \[910].
\:\\{make\_radical}, 909, 910, \[913].
\:\\{make\_scripts}, 930, \[932].
\:\\{make\_string}, \[43], 48, 52, 279, 496, 543, 551, 686, 705, 706, 712, 718,
726, 727, 1116, 1435, 1457, 1508, 1513, 1753.
\:\\{make\_under}, 909, \[911].
\:\\{make\_vcenter}, 909, \[912].
\:\\{margin}, 1630.
\:\\{margin\_char}, \[173], 220, 224, 823, 825, 1288.
\:\\{margin\_kern\_node}, \[173], 201, 220, 224, 498, 650, 732, 823, 825, 1288,
1325.
\:\\{margin\_kern\_node\_size}, \[173], 220, 224, 823, 1288.
\:\\{margin\_kern\_shrink}, 822, \[1005], 1027.
\:\\{margin\_kern\_stretch}, 822, \[1005], 1027.
\:\\{mark}, \[226], 287, 288, 1275, 1809.
\:\9{mark\_}{\.{\\mark} primitive}, \[287].
\:\\{mark\_class}, \[159], 214, 1156, 1191, 1279, 1827, 1830.
\:\\{mark\_class\_node\_size}, \[1820], 1825.
\:\\{mark\_node}, \[159], 166, 193, 201, 220, 224, 819, 825, 906, 937, 1005,
1042, 1076, 1145, 1150, 1156, 1177, 1191, 1279.
\:\\{mark\_ptr}, \[159], 214, 220, 224, 1156, 1193, 1279, 1827, 1830.
\:\\{mark\_text}, \[329], 336, 345, 412.
\:\\{mark\_val}, \[1815], 1816, 1820, 1824, 1827, 1830.
\:\9{marks\_}{\.{\\marks} primitive}, \[1809].
\:\\{marks\_code}, 318, \[408], 411, 412, 1809.
\:{mastication}, 363.
\:\\{match}, \[225], 311, 313, 314, 316, 417, 418.
\:\\{match\_chr}, \[314], 316, \[415], 417, 426.
\:\\{match\_token}, \[311], 417, 418, 419, 420, 502.
\:\\{matching}, \[327], 328, 361, 417.
\:\\{matchstrings}, 497.
\:\.{Math formula deleted...}, 1373.
\:\\{math\_ac}, 1342, \[1343].
\:\\{math\_accent}, \[226], 287, 288, 1224, 1342.
\:\9{math\_accent\_}{\.{\\mathaccent} primitive}, \[287].
\:\9{math\_bin\_}{\.{\\mathbin} primitive}, \[1334].
\:\\{math\_char}, \[857], 868, 896, 898, 900, 914, 917, 925, 928, 929, 930,
1329, 1333, 1343.
\:\9{math\_char\_}{\.{\\mathchar} primitive}, \[287].
\:\9{math\_char\_def\_}{\.{\\mathchardef} primitive}, \[1400].
\:\\{math\_char\_def\_code}, \[1400], 1401, 1402.
\:\\{math\_char\_num}, \[226], 287, 288, 1224, 1329, 1332.
\:\\{math\_choice}, \[226], 287, 288, 1224, 1349.
\:\9{math\_choice\_}{\.{\\mathchoice} primitive}, \[287].
\:\\{math\_choice\_group}, \[291], 1350, 1351, 1352, 1661, 1679.
\:\9{math\_close\_}{\.{\\mathclose} primitive}, \[1334].
\:\\{math\_code}, \[248], 250, 254, 440, 1329, 1332.
\:\9{math\_code\_}{\.{\\mathcode} primitive}, \[1408].
\:\\{math\_code\_base}, \[248], 253, 440, 1408, 1409, 1410, 1411.
\:\\{math\_comp}, \[226], 1224, 1334, 1335, 1336.
\:\\{math\_font\_base}, \[248], 250, 252, 1408, 1409.
\:\\{math\_fraction}, 1358, \[1359].
\:\\{math\_given}, \[226], 439, 1224, 1329, 1332, 1400, 1401, 1402.
\:\\{math\_glue}, \[892], 908, 942.
\:\\{math\_group}, \[291], 1314, 1328, 1331, 1364, 1661, 1679.
\:\9{math\_inner\_}{\.{\\mathinner} primitive}, \[1334].
\:\\{math\_kern}, \[893], 906.
\:\\{math\_left\_group}, 230, \[291], 1243, 1246, 1247, 1328, 1369, 1661, 1679.
\:\\{math\_left\_right}, 1368, \[1369].
\:\\{math\_limit\_switch}, 1336, \[1337].
\:\\{math\_node}, \[165], 166, 193, 201, 220, 224, 450, 650, 732, 825, 993,
1005, 1013, 1042, 1055, 1057, 1073, 1076, 1258, 1700, 1707, 1728, 1733, 1736,
1738.
\:\9{math\_op\_}{\.{\\mathop} primitive}, \[1334].
\:\9{math\_open\_}{\.{\\mathopen} primitive}, \[1334].
\:\9{math\_ord\_}{\.{\\mathord} primitive}, \[1334].
\:\9{math\_punct\_}{\.{\\mathpunct} primitive}, \[1334].
\:\\{math\_quad}, \[876], 879, 1377.
\:\\{math\_radical}, 1340, \[1341].
\:\9{math\_rel\_}{\.{\\mathrel} primitive}, \[1334].
\:\\{math\_shift}, \[225], 311, 316, 320, 369, 1268, 1315, 1316, 1371, 1375,
1384.
\:\\{math\_shift\_group}, \[291], 1243, 1246, 1247, 1308, 1317, 1318, 1320,
1323, 1370, 1371, 1372, 1378, 1661, 1679.
\:\\{math\_shift\_token}, \[311], 1225, 1243.
\:\\{math\_spacing}, \[940], 941.
\:\\{math\_style}, \[226], 1224, 1347, 1348, 1349.
\:\\{math\_surround}, \[265], 1374.
\:\9{math\_surround\_}{\.{\\mathsurround} primitive}, \[266].
\:\\{math\_surround\_code}, \[265], 266.
\:\\{math\_text\_char}, \[857], 928, 929, 930, 931.
\:\\{math\_type}, \[857], 859, 863, 868, 874, 896, 898, 899, 910, 911, 913,
914, 917, 918, 925, 927, 928, 929, 930, 931, 932, 1254, 1271, 1329, 1333, 1343,
1346, 1354, 1359, 1363, 1364, 1369.
\:\\{math\_x\_height}, \[876], 913, 933, 934, 935.
\:\\{mathex}, \[877].
\:\\{mathsy}, \[876].
\:\\{mathsy\_end}, \[876].
\:\\{matrixrecalculate}, 1635.
\:\\{matrixtransformrect}, 1630.
\:\\{matrixused}, 1630, 1635, 1637.
\:\\{max}, 682, 727.
\:\\{max\_answer}, \[105], \[1793], \[1799].
\:\\{max\_buf\_stack}, \[30], 31, 353, 400, 1514, 1756, 1768.
\:\\{max\_char\_code}, \[225], 325, 363, 366, 1411.
\:\\{max\_command}, \[227], 228, 229, 237, 380, 388, 392, 394, 406, 407, 504,
958, 1772.
\:\\{max\_d}, \[902], 903, 906, 936, 937, \[938].
\:\\{max\_dead\_cycles}, \[254], 258, 1189.
\:\9{max\_dead\_cycles\_}{\.{\\maxdeadcycles} primitive}, \[256].
\:\\{max\_dead\_cycles\_code}, \[254], 255, 256.
\:\\{max\_depth}, \[265], 1157, 1164.
\:\9{max\_depth\_}{\.{\\maxdepth} primitive}, \[266].
\:\\{max\_depth\_code}, \[265], 266.
\:\\{max\_dimen}, \[447], 486, 669, 844, 1187, 1194, 1323, 1324, 1326, 1637,
1735, 1736, 1737, 1790, 1792, 1798, 1846.
\:\\{max\_expand}, 705.
\:\\{max\_group\_code}, \[291].
\:\\{max\_h}, \[619], 620, 669, 670, \[902], 903, 906, 936, 937, \[938].
\:\\{max\_halfword}, 11, 14, \[128], 129, 131, 142, 143, 144, 149, 150, 311,
312, 450, 783, 786, 996, 1024, 1026, 1159, 1168, 1173, 1194, 1284, 1427, 1501,
1503, 1515, 1565, 1566, 1636, 1637.
\:\\{max\_hlist\_stack}, \[173], 821, 1005.
\:\\{max\_in\_open}, \[11], 14, 326, 350, 1660, 1773, 1774, 1776.
\:\\{max\_in\_stack}, \[323], 343, 353, 1514.
\:\\{max\_integer}, \[687], 689, 1555.
\:\\{max\_internal}, \[227], 439, 466, 474, 481, 487.
\:\\{max\_len}, \[693].
\:\\{max\_nest\_stack}, \[231], 233, 234, 1514.
\:\\{max\_non\_prefixed\_command}, \[226], 1389, 1448.
\:\\{max\_param\_stack}, \[330], 353, 416, 1514.
\:\\{max\_print\_line}, \[11], 14, 54, 58, 72, 194, 563, 666, 750, 1458, 1755.
\:\\{max\_push}, \[619], 620, 647, 657, 670.
\:\\{max\_quarterword}, 11, \[128], 129, 131, 173, 296, 973, 974, 1121, 1298,
1503.
\:\\{max\_reg\_help\_line}, 1811, 1812, 1813, \[1814].
\:\\{max\_reg\_num}, 1811, 1812, 1813, \[1814].
\:\\{max\_save\_stack}, \[293], 294, 295, 1514.
\:\\{max\_selector}, \[54], 264, 333, 491, 496, 560, 666, 705, 706, 712, 727,
1435, 1457, 1615, 1617, 1753.
\:\\{max\_shrink\_ratio}, 823, \[999], 1003, 1027.
\:\\{max\_stretch\_ratio}, 823, \[999], 1003, 1027.
\:\\{max\_strings}, \[11], 38, 43, 129, 543, 551, 1488, 1514.
\:\\{max\_v}, \[619], 620, 669, 670.
\:\\{maxdimen}, 110.
\:\9{meaning\_}{\.{\\meaning} primitive}, \[494].
\:\\{meaning\_code}, \[494], 495, 497, 498.
\:\\{med\_mu\_skip}, \[242].
\:\9{med\_mu\_skip\_}{\.{\\medmuskip} primitive}, \[244].
\:\\{med\_mu\_skip\_code}, \[242], 243, 244, 942.
\:\\{mediabox\_given}, 750, 769.
\:\\{mem}, 11, 12, 133, \[134], 136, 142, 144, 149, 151, 152, 153, 158, 160,
168, 169, 175, 177, 180, 181, 182, 183, 185, 190, 200, 204, 221, 223, 224, 239,
242, 297, 313, 413, 446, 515, 632, 695, 826, 856, 857, 859, 862, 863, 896, 901,
918, 929, 945, 946, 948, 973, 992, 994, 995, 998, 999, 1008, 1019, 1020, 1023,
1024, 1026, 1036, 1037, 1066, 1102, 1327, 1329, 1338, 1341, 1343, 1359, 1364,
1425, 1426, 1489, 1490, 1519, 1674, 1727, 1733, 1754, 1756, 1788, 1815, 1820,
1842.
\:\\{mem\_bot}, 11, \[12], 14, 129, 134, 143, 144, 180, 182, 287, 437, 441,
453, 1399, 1404, 1405, 1415, 1485, 1486, 1489, 1490, 1832, 1833, 1834.
\:\\{mem\_end}, 134, \[136], 138, 182, 183, 185, 186, 189, 190, 192, 194, 200,
315, 674, 1489, 1490, 1514.
\:\\{mem\_max}, \[11], 12, 14, 128, 129, 134, 138, 142, 143, 183, 184.
\:\\{mem\_min}, \[11], 12, 129, 134, 138, 143, 183, 184, 185, 187, 188, 189,
190, 192, 196, 200, 674, 1427, 1490, 1514.
\:\\{mem\_top}, 11, \[12], 14, 129, 134, 180, 182, 1427, 1485, 1486, 1490.
\:\.{Memory usage...}, 667.
\:\\{memory\_word}, 128, \[131], 132, 134, 200, 230, 236, 239, 271, 290, 293,
297, 574, 575, 710, 976, 1483, 1816.
\:\\{message}, \[226], 1454, 1455, 1456.
\:\9{message\_}{\.{\\message} primitive}, \[1455].
\:\9{METAFONT}{\MF}, 616.
\:\\{microseconds}, \[680], 1517, 1555, 1584, 1586.
\:\\{mid}, \[572].
\:\\{mid\_line}, 87, \[325], 350, 366, 369, 374, 375, 376.
\:\\{middle}, 1697.
\:\9{middle\_}{\.{\\middle} primitive}, \[1697].
\:\\{middle\_noad}, 230, \[863], 1369, 1370, 1697, 1698.
\:\\{min}, 682.
\:\\{min\_bp\_val}, \[691], 692, 693, 792.
\:\\{min\_font\_val}, \[691].
\:\\{min\_halfword}, 11, \[128], 129, 130, 131, 133, 248, 1204, 1501, 1503,
1534, 1723, 1728, 1738, 1739.
\:\\{min\_internal}, \[226], 439, 466, 474, 481, 487.
\:\\{min\_quarterword}, 12, \[128], 129, 130, 131, 152, 154, 158, 203, 239,
296, 575, 576, 580, 582, 583, 592, 603, 823, 844, 861, 873, 883, 889, 890, 972,
977, 979, 984, 1097, 1100, 1101, 1120, 1121, 1122, 1123, 1135, 1140, 1141,
1142, 1171, 1189, 1501, 1502, 1503.
\:\\{minimal\_demerits}, \[1009], 1010, 1012, 1021, 1031, 1842.
\:\\{minimum\_demerits}, \[1009], 1010, 1011, 1012, 1030, 1031.
\:\\{minor\_tail}, \[1089], 1092, 1093.
\:\.{minus}, 488.
\:\.{Misplaced \&}, 1306.
\:\.{Misplaced \\cr}, 1306.
\:\.{Misplaced \\noalign}, 1307.
\:\.{Misplaced \\omit}, 1307.
\:\.{Misplaced \\span}, 1306.
\:\.{Missing ) inserted}, 1784.
\:\.{Missing = inserted}, 529, 1769.
\:\.{Missing \# inserted...}, 959.
\:\.{Missing \$ inserted}, 1225, 1243.
\:\.{Missing \\cr inserted}, 1310.
\:\.{Missing \\endcsname...}, 399.
\:\.{Missing \\endgroup inserted}, 1243.
\:\.{Missing \\right\hbox{.} inserted}, 1243.
\:\.{Missing \{ inserted}, 429, 501, 1305.
\:\.{Missing \} inserted}, 1243, 1305.
\:\.{Missing `to' inserted}, 1260.
\:\.{Missing `to'...}, 1403.
\:\.{Missing {\$\$} inserted}, 1385.
\:\.{Missing character}, 608.
\:\.{Missing control...}, 1393.
\:\.{Missing delimiter...}, 1339.
\:\.{Missing font identifier}, 604.
\:\.{Missing number...}, 441, 472.
\:\\{mkern}, \[226], 1224, 1235, 1236, 1237.
\:\9{mkern\_}{\.{\\mkern} primitive}, \[1236].
\:\\{ml\_field}, \[230], 231, 236.
\:\\{mlist}, \[902], 936.
\:\\{mlist\_penalties}, \[895], 896, 902, 930, 1372, 1374, 1377.
\:\\{mlist\_to\_hlist}, 869, 895, 896, 901, \[902], 910, 930, 936, 1372, 1374,
1377.
\:\.{mm}, 484.
\:\\{mmode}, \[229], 230, 231, 236, 527, 894, 951, 952, 976, 983, 988, 1207,
1223, 1224, 1226, 1234, 1235, 1251, 1258, 1270, 1275, 1287, 1288, 1290, 1294,
1298, 1308, 1314, 1318, 1323, 1328, 1332, 1336, 1340, 1342, 1345, 1349, 1353,
1358, 1368, 1371, 1372, 1679, 1742.
\:\\{moddate\_given}, 807.
\:\\{mode}, 229, 230, \[231], 233, 234, 321, 444, 448, 450, 527, 727, 894, 951,
952, 961, 962, 963, 972, 975, 980, 983, 984, 985, 988, 1202, 1206, 1207, 1211,
1212, 1227, 1229, 1234, 1254, 1256, 1258, 1261, 1264, 1269, 1271, 1272, 1273,
1274, 1277, 1281, 1283, 1288, 1295, 1297, 1298, 1314, 1316, 1323, 1345, 1372,
1374, 1378, 1421, 1560, 1561, 1615, 1617, 1618, 1625, 1742.
\:\\{mode\_field}, \[230], 231, 236, 448, 976, 983, 1422, 1679, 1681.
\:\\{mode\_line}, 230, \[231], 233, 234, 326, 980, 991, 1202.
\:\\{month}, \[254], 259, 645, 792, 1508.
\:\9{month\_}{\.{\\month} primitive}, \[256].
\:\\{month\_code}, \[254], 255, 256.
\:\\{months}, \[560], 562.
\:\\{more\_name}, 538, \[542], 552, 557.
\:\9{move\_left\_}{\.{\\moveleft} primitive}, \[1249].
\:\\{move\_past}, \[647], 650, 653, 657, 659, 662, 729, 732, 735, 738, 741, 744.
\:\9{move\_right\_}{\.{\\moveright} primitive}, \[1249].
\:\\{movement}, \[634], 636, 643.
\:\\{movement\_node\_size}, \[632], 634, 642.
\:\\{msg}, 712.
\:\\{mskip}, \[226], 1224, 1235, 1236, 1237.
\:\9{mskip\_}{\.{\\mskip} primitive}, \[1236].
\:\\{mskip\_code}, \[1236], 1238.
\:\\{mstate}, \[634], 638, 639.
\:\&{mtype}, \[4].
\:\\{mu}, 473, \[474], 475, 479, 481, \[487], 488.
\:\.{mu}, 482.
\:\\{mu\_error}, \[434], 455, 475, 481, 487, 1780.
\:\9{mu\_expr\_}{\.{\\muexpr} primitive}, \[1778].
\:\\{mu\_glue}, \[167], 173, 209, 450, 893, 908, 1236, 1238, 1239.
\:\\{mu\_mult}, \[892], 893.
\:\\{mu\_skip}, \[242], 453.
\:\9{mu\_skip\_}{\.{\\muskip} primitive}, \[437].
\:\\{mu\_skip\_base}, \[242], 245, 247, 1402, 1415.
\:\9{mu\_skip\_def\_}{\.{\\muskipdef} primitive}, \[1400].
\:\\{mu\_skip\_def\_code}, \[1400], 1401, 1402.
\:\9{mu\_to\_glue\_}{\.{\\mutoglue} primitive}, \[1805].
\:\\{mu\_to\_glue\_code}, \[1805], 1806, 1807.
\:\\{mu\_val}, \[436], 437, 439, 450, 453, 455, 456, 475, 477, 481, 487, 491,
1238, 1402, 1406, 1414, 1415, 1778, 1779, 1780, 1787, 1815, 1820, 1823.
\:\\{mu\_val\_limit}, \[1815], 1821, 1838.
\:\\{mult\_and\_add}, \[105].
\:\\{mult\_integers}, \[105], 1418, 1795.
\:\\{multiply}, \[227], 287, 288, 1388, 1413, 1414, 1418.
\:\9{multiply\_}{\.{\\multiply} primitive}, \[287].
\:\.{Must increase the x}, 1481.
\:\\{must\_end\_string}, 693.
\:\\{must\_insert\_space}, 693.
\:\|{n}, \[47], \[65], \[66], \[67], \[69], \[91], \[94], \[105], \[106], %
\[107], \[112], \[114], \[170], \[172], \[192], \[200], \[243], \[255], \[265],
\[270], \[314], \[320], \[321], \[337], \[415], \[508], \[524], \[544], \[545],
\[549], \[605], \[674], \[689], \[882], \[892], \[893], \[967], \[976], %
\[1083], \[1111], \[1121], \[1154], \[1169], \[1170], \[1171], \[1189], %
\[1257], \[1297], \[1316], \[1389], \[1453], \[1471], \[1518], \[1723], %
\[1738], \[1782], \[1797], \[1799], \[1819], \[1822].
\:\\{name}, 322, \[324], 325, 326, 329, 333, 335, 336, 345, 350, 351, 353, 359,
382, 384, 416, 509, 563, 1755.
\:\\{name\_field}, 84, 85, \[322], 324, 1774, 1775.
\:\\{name\_in\_progress}, 404, 552, \[553], 554, 1436.
\:\\{name\_length}, \[26], 51, 545, 549, 551.
\:\\{name\_of\_file}, \[26], 27, 51, 545, 549, 551, 556.
\:\\{name\_tree\_kids\_max}, \[695], 805.
\:\\{named}, 1552.
\:\\{names\_head}, 804, 805, 1513.
\:\\{names\_tail}, 804, 1513.
\:\\{names\_tree}, 804, 806, 1513.
\:\\{natural}, \[816], 881, 891, 896, 903, 911, 913, 914, 924, 930, 932, 935,
972, 975, 982, 1154, 1198, 1278, 1303, 1372, 1377, 1382, 1746.
\:\.{nc}, 484.
\:\.{nd}, 484.
\:\\{nd}, 566, 567, \[586], 591, 592, 595.
\:\\{ne}, 566, 567, \[586], 591, 592, 595.
\:\\{neg}, 705.
\:\\{negate}, \[16], 65, 103, 105, 106, 107, 112, 115, 123, 456, 457, 466, 474,
487, 686, 689, 951, 1585, 1769, 1780, 1793, 1797, 1799.
\:\\{negative}, \[106], \[112], \[114], 115, \[439], 456, \[466], 467, \[474], %
\[487], 1780, \[1793], \[1797], \[1799].
\:\\{nest}, 230, \[231], 234, 235, 236, 237, 439, 448, 951, 976, 983, 1172,
1422, 1679, 1681.
\:\\{nest\_ptr}, \[231], 233, 234, 235, 236, 448, 951, 976, 983, 1172, 1194,
1200, 1269, 1278, 1323, 1378, 1422, 1679.
\:\\{nest\_size}, \[11], 231, 234, 236, 439, 1422, 1514, 1679.
\:\\{nesting\_level}, 730, 1632, 1635.
\:\\{new\_annot\_whatsit}, \[1556], 1558, 1560, 1567, 1568.
\:\\{new\_character}, \[609], 931, 1092, 1295, 1301, 1302.
\:\\{new\_choice}, \[865], 1350.
\:\\{new\_delta\_from\_break\_width}, \[1020].
\:\\{new\_delta\_to\_break\_width}, \[1019].
\:\\{new\_disc}, \[163], 1212, 1295.
\:\\{new\_edge}, \[1719], 1722, 1738.
\:\\{new\_font}, 706, 1434, \[1435].
\:\\{new\_font\_type}, \[703], 705, 720, 726.
\:\\{new\_glue}, \[171], 172, 891, 942, 962, 969, 971, 985, 1219, 1221, 1232,
1238, 1349.
\:\\{new\_graf}, 1268, \[1269].
\:\\{new\_hlist}, \[901], 903, 919, 924, 925, 926, 930, 932, 938, 943.
\:\\{new\_hyph\_exceptions}, \[1111], 1430.
\:\\{new\_index}, \[1815], 1816, 1819.
\:\\{new\_interaction}, 1442, \[1443], 1695, 1696.
\:\\{new\_kern}, \[174], 705, 881, 891, 911, 914, 915, 923, 927, 929, 931, 935,
1087, 1218, 1239, 1290, 1291, 1303, 1382, 1721, 1740, 1746.
\:\\{new\_letterspaced\_font}, \[706], 1434.
\:\\{new\_lig\_item}, \[162], 1088, 1218.
\:\\{new\_ligature}, \[162], 1087, 1212.
\:\\{new\_line}, \[325], 353, 365, 366, 367, 369, 509, 563.
\:\\{new\_line\_char}, 59, \[254], 262, 1513, 1515, 1754.
\:\9{new\_line\_char\_}{\.{\\newlinechar} primitive}, \[256].
\:\\{new\_line\_char\_code}, \[254], 255, 256.
\:\\{new\_margin\_kern}, \[823], 1057, 1063.
\:\\{new\_math}, \[165], 1374, 1703, 1707, 1709, 1712, 1723, 1734, 1746.
\:\\{new\_noad}, \[862], 896, 918, 929, 1254, 1271, 1328, 1333, 1336, 1346,
1355, 1369.
\:\\{new\_null\_box}, \[154], 882, 885, 889, 896, 923, 926, 955, 969, 985,
1195, 1232, 1269, 1271, 1740.
\:\\{new\_param\_glue}, \[170], 172, 855, 954, 992, 1062, 1063, 1219, 1221,
1269, 1381, 1383, 1384, 1740.
\:\\{new\_patterns}, \[1137], 1430.
\:\\{new\_penalty}, \[176], 943, 992, 1067, 1232, 1281, 1381, 1383, 1384.
\:\\{new\_randoms}, 110, \[124], 125.
\:\\{new\_rule}, \[157], 489, 842, 880, 1552.
\:\\{new\_save\_level}, \[296], 817, 950, 961, 967, 1202, 1241, 1277, 1295,
1297, 1314.
\:\\{new\_skip\_param}, \[172], 855, 1146, 1178, 1746.
\:\\{new\_snap\_node}, \[1573], 1574.
\:\\{new\_spec}, \[169], 172, 456, 488, 705, 1002, 1153, 1181, 1220, 1221,
1417, 1418, 1780, 1790, 1791, 1853.
\:\\{new\_string}, \[54], 57, 58, 491, 496, 645, 686, 705, 706, 712, 727, 1435,
1457, 1508, 1615, 1688, 1753.
\:\\{new\_style}, \[864], 1349.
\:\\{new\_trie\_op}, 1120, \[1121], 1122, 1142.
\:\\{new\_vf\_packet}, 706, 716.
\:\\{new\_whatsit}, \[1529], 1530, 1534, 1538, 1539, 1540, 1541, 1542, 1546,
1549, 1554, 1556, 1561, 1565, 1569, 1572, 1575, 1576, 1594, 1595, 1596, 1597,
1598, 1624, 1625.
\:\\{new\_write\_whatsit}, \[1530], 1531, 1532, 1533.
\:\\{newcolorstack}, 497.
\:\\{next}, \[274], 276, 278, 279.
\:\\{next\_break}, \[1053], 1054.
\:\\{next\_char}, \[571], 823, 917, 929, 1086, 1216.
\:\\{next\_char\_p}, \[999].
\:\\{next\_p}, \[647], 650, 654, 657, 658, 659, 661, 663, 729, 732, 736, 738,
740, 741, 743, 745, 1723, 1725.
\:\\{next\_pos}, 1637.
\:\\{next\_random}, \[124], 126, 127.
\:\\{nh}, 566, 567, \[586], 591, 592, 595.
\:\\{ni}, 566, 567, \[586], 591, 592, 595, 705.
\:\&{nil}, 16.
\:\\{nk}, 566, 567, \[586], 591, 592, 600, 705.
\:\\{nl}, \[59], 566, 567, 571, \[586], 591, 592, 595, 600, 603, \[1753], 1754.
\:\\{nn}, \[333], 334.
\:\.{No pages of output}, 670, 794.
\:\\{no\_align}, \[226], 287, 288, 961, 1304.
\:\9{no\_align\_}{\.{\\noalign} primitive}, \[287].
\:\\{no\_align\_error}, 1304, \[1307].
\:\\{no\_align\_group}, \[291], 944, 961, 1311, 1661, 1679.
\:\\{no\_boundary}, \[226], 287, 288, 1207, 1215, 1223, 1268.
\:\9{no\_boundary\_}{\.{\\noboundary} primitive}, \[287].
\:\\{no\_break\_yet}, \[1005], 1012, 1013.
\:\\{no\_expand}, \[228], 287, 288, 388, 391.
\:\9{no\_expand\_}{\.{\\noexpand} primitive}, \[287].
\:\\{no\_expand\_flag}, \[380], 504, 532.
\:\9{no\_indent\_}{\.{\\noindent} primitive}, \[1266].
\:\\{no\_lig\_code}, \[173], 452, 1431, 1432, 1433.
\:\9{no\_lig\_code\_}{\.{\\pdfnoligatures} primitive}, \[1432].
\:\\{no\_limits}, \[858], 1334, 1335.
\:\9{no\_limits\_}{\.{\\nolimits} primitive}, \[1334].
\:\\{no\_new\_control\_sequence}, \[274], 276, 278, 281, 286, 387, 400, 1516,
1648, 1768.
\:\\{no\_print}, \[54], 57, 58, 75, 98.
\:\\{no\_shrink\_error\_yet}, \[1001], 1002, 1003.
\:\\{no\_tag}, \[570], 595.
\:\\{no\_zip}, \[680], 681, 685.
\:\\{noad\_size}, \[857], 862, 874, 929, 937, 1364, 1365.
\:\\{node\_list\_display}, \[198], 202, 206, 208, 213, 215.
\:\\{node\_r\_stays\_active}, \[1006], 1027, 1030.
\:\\{node\_size}, \[142], 144, 145, 146, 148, 182, 187, 1489, 1490.
\:\\{nom}, \[586], 587, 589, 603.
\:\\{non\_address}, \[575], 578, 603, 1086, 1093, 1211.
\:\\{non\_char}, \[575], 578, 603, 705, 1074, 1075, 1078, 1085, 1086, 1087,
1088, 1092, 1093, 1094, 1209, 1211, 1212, 1215, 1216, 1218, 1295, 1501.
\:\\{non\_discardable}, \[166], 1005, 1055.
\:\\{non\_existent\_path}, \[705], 706.
\:\\{non\_math}, \[1224], 1241, 1322.
\:\\{non\_script}, \[226], 287, 288, 1224, 1349.
\:\9{non\_script\_}{\.{\\nonscript} primitive}, \[287], \[908].
\:\\{none\_seen}, \[638], 639.
\:\.{NONEXISTENT}, 284.
\:\.{Nonletter}, 1139.
\:\\{nonnegative\_integer}, 69, \[101], 107, 689.
\:\\{nonstop\_mode}, \[73], 86, 382, 385, 510, 1440, 1441.
\:\9{nonstop\_mode\_}{\.{\\nonstopmode} primitive}, \[1440].
\:\\{nop}, 610, 612, \[613], 615, 617, 717, 719.
\:\\{norm\_min}, \[1269], 1378, 1624, 1625.
\:\\{norm\_rand}, 110, \[127], 498.
\:\\{normal}, \[153], 154, 167, 168, 171, 173, 174, 182, 195, 204, 207, 209,
327, 353, 358, 393, 394, 465, 474, 497, 499, 506, 508, 511, 515, 516, 527, 533,
647, 653, 657, 662, 729, 735, 738, 744, 824, 825, 833, 834, 835, 836, 840, 841,
842, 843, 848, 849, 850, 852, 853, 854, 858, 862, 872, 892, 908, 925, 953, 977,
986, 987, 1001, 1002, 1005, 1017, 1018, 1042, 1046, 1047, 1073, 1074, 1076,
1153, 1165, 1181, 1186, 1223, 1334, 1341, 1343, 1359, 1379, 1397, 1398, 1399,
1417, 1471, 1637, 1638, 1683, 1723, 1766, 1791, 1794, 1843.
\:\9{normal\_deviate\_}{\.{\\pdfnormaldeviate} primitive}, \[494].
\:\\{normal\_deviate\_code}, \[494], 495, 497, 498.
\:\\{normal\_paragraph}, 950, 961, 963, 1202, \[1248], 1261, 1272, 1274, 1277,
1345.
\:\\{normalize\_glue}, \[1791], 1794.
\:\\{normalize\_selector}, 78, \[92], 93, 94, 95, 686, 1039.
\:\.{Not a letter}, 1114.
\:\\{not\_found}, \[15], 45, 46, 474, 481, 586, 596, 634, 638, 639, 686, 1005,
1072, 1107, 1108, 1111, 1118, 1130, 1132, 1147, 1149, 1150, 1316, 1324, 1612,
1733, 1819, 1846.
\:\\{not\_found1}, \[15], 1111, 1819.
\:\\{not\_found2}, \[15], 1819.
\:\\{not\_found3}, \[15], 1819.
\:\\{not\_found4}, \[15], 1819.
\:\.{notexpanded:}, 277.
\:\\{np}, 566, 567, \[586], 591, 592, 602, 603.
\:\\{nucleus}, \[857], 858, 859, 862, 863, 866, 872, 874, 896, 901, 910, 911,
912, 913, 914, 917, 918, 925, 926, 928, 929, 930, 931, 1254, 1271, 1328, 1329,
1333, 1336, 1341, 1343, 1346, 1364, 1369.
\:\\{null}, \[133], 134, 136, 138, 140, 141, 143, 144, 153, 154, 162, 163, 167,
168, 169, 170, 171, 172, 182, 186, 187, 193, 194, 200, 218, 219, 220, 222, 228,
230, 233, 234, 236, 237, 240, 241, 250, 251, 297, 314, 317, 321, 328, 329, 334,
336, 347, 353, 379, 380, 384, 397, 400, 408, 409, 412, 416, 417, 418, 423, 426,
433, 436, 441, 446, 449, 453, 478, 490, 492, 497, 498, 499, 504, 508, 515, 516,
523, 531, 534, 575, 578, 603, 605, 609, 633, 638, 642, 647, 651, 657, 660, 673,
674, 686, 693, 700, 705, 727, 729, 733, 738, 739, 742, 753, 754, 756, 763, 764,
766, 767, 769, 771, 772, 773, 775, 778, 779, 781, 782, 783, 784, 786, 792, 795,
797, 803, 804, 806, 807, 814, 815, 820, 822, 823, 825, 830, 831, 834, 840, 842,
844, 849, 852, 857, 861, 865, 868, 891, 894, 895, 896, 897, 902, 907, 908, 928,
930, 931, 932, 936, 937, 942, 943, 947, 950, 952, 953, 959, 960, 965, 966, 967,
968, 970, 972, 973, 975, 977, 980, 981, 982, 983, 988, 997, 1003, 1005, 1013,
1016, 1022, 1023, 1024, 1026, 1027, 1028, 1032, 1033, 1034, 1035, 1039, 1040,
1041, 1043, 1045, 1048, 1053, 1054, 1055, 1057, 1058, 1059, 1060, 1061, 1063,
1065, 1066, 1067, 1071, 1073, 1075, 1080, 1083, 1084, 1085, 1087, 1088, 1090,
1091, 1092, 1093, 1094, 1095, 1105, 1109, 1112, 1145, 1146, 1147, 1149, 1150,
1154, 1155, 1156, 1158, 1168, 1169, 1170, 1171, 1175, 1176, 1177, 1186, 1187,
1188, 1189, 1191, 1192, 1193, 1194, 1195, 1197, 1198, 1199, 1200, 1203, 1204,
1205, 1207, 1209, 1211, 1212, 1213, 1214, 1215, 1217, 1218, 1220, 1221, 1248,
1252, 1253, 1254, 1257, 1258, 1261, 1265, 1269, 1274, 1288, 1295, 1299, 1301,
1302, 1309, 1314, 1317, 1323, 1324, 1327, 1345, 1352, 1354, 1359, 1362, 1363,
1364, 1372, 1374, 1377, 1380, 1383, 1384, 1404, 1405, 1425, 1426, 1461, 1466,
1474, 1489, 1490, 1515, 1519, 1533, 1534, 1536, 1544, 1545, 1548, 1551, 1552,
1555, 1556, 1565, 1573, 1577, 1603, 1604, 1605, 1615, 1616, 1623, 1629, 1630,
1636, 1637, 1668, 1674, 1683, 1691, 1706, 1707, 1708, 1709, 1712, 1721, 1723,
1725, 1730, 1731, 1733, 1734, 1735, 1738, 1745, 1746, 1751, 1756, 1757, 1758,
1768, 1782, 1783, 1784, 1809, 1815, 1816, 1817, 1818, 1819, 1820, 1821, 1823,
1824, 1825, 1826, 1827, 1828, 1829, 1830, 1831, 1832, 1836, 1837, 1838, 1841,
1849, 1852, 1860, 1863, 1866.
\:{null delimiter}, 258, 1243.
\:\\{null\_character}, \[581], 582, 898, 899.
\:\\{null\_code}, \[22], 250.
\:\\{null\_cs}, \[240], 284, 285, 376, 400, 673, 693, 705, 706, 712, 1435, 1768.
\:\\{null\_delimiter}, \[860], 861, 1359.
\:\\{null\_delimiter\_space}, \[265], 882.
\:\9{null\_delimiter\_space\_}{\.{\\nulldelimiterspace} primitive}, \[266].
\:\\{null\_delimiter\_space\_code}, \[265], 266.
\:\\{null\_flag}, \[156], 157, 489, 827, 955, 969, 977, 1552.
\:\\{null\_font}, 192, \[250], 497, 578, 579, 586, 604, 645, 673, 674, 693,
697, 705, 706, 712, 720, 823, 839, 882, 883, 898, 1040, 1435, 1498, 1499, 1519,
1587, 1589, 1593.
\:\9{null\_font\_}{\.{\\nullfont} primitive}, \[579].
\:\\{null\_list}, 14, \[180], 406, 956.
\:\\{num}, \[476], 484, 612, \[614], 617.
\:\\{num\_error}, \[1790], 1793, 1797, 1799.
\:\9{num\_expr\_}{\.{\\numexpr} primitive}, \[1778].
\:\\{num\_style}, \[878], 920.
\:\.{Number too big}, 471.
\:\9{number\_}{\.{\\number} primitive}, \[494].
\:\\{number\_code}, \[494], 495, 496, 497, 498.
\:\\{numerator}, \[859], 866, 873, 874, 920, 1359, 1363.
\:\\{num1}, \[876], 920.
\:\\{num2}, \[876], 920.
\:\\{num3}, \[876], 920.
\:\\{nw}, 566, 567, \[586], 591, 592, 595, 705, 706.
\:\\{nx\_plus\_y}, \[105], 481, 892, 1418, 1795.
\:\|{o}, \[286], \[634], \[823], \[844], \[967], \[976], \[1782].
\:\\{obj\_annot\_ptr}, \[695], 781, 782, 783, 1558, 1560, 1630, 1635, 1636.
\:\\{obj\_aux}, \[695], 698, 752, 799, 805.
\:\\{obj\_bead\_attr}, \[695], 1600, 1637.
\:\\{obj\_bead\_data}, \[695], 786, 1637.
\:\\{obj\_bead\_next}, \[695], 1600, 1637.
\:\\{obj\_bead\_page}, \[695], 1600, 1637.
\:\\{obj\_bead\_prev}, \[695], 1600, 1637.
\:\\{obj\_bead\_ptr}, \[695], 1637.
\:\\{obj\_bead\_rect}, \[695], 786, 1600.
\:\\{obj\_data\_ptr}, \[695], 1544, 1548, 1552, 1623.
\:\\{obj\_dest\_ptr}, \[695], 784, 795, 797, 1555, 1565, 1637.
\:\\{obj\_entry}, \[694], 695, 696, 698.
\:\\{obj\_info}, 498, 693, \[695], 698, 767, 794, 795, 797, 799, 801, 802, 803,
804, 805, 1600, 1637.
\:\\{obj\_link}, 693, \[695], 698, 789, 790, 796, 798, 799, 800, 801, 802, 803,
804, 805, 812, 813, 814, 1545.
\:\\{obj\_obj\_data}, \[695], 772, 1544, 1603.
\:\\{obj\_obj\_is\_file}, \[695], 772, 1544, 1603.
\:\\{obj\_obj\_is\_stream}, \[695], 772, 1544, 1603.
\:\\{obj\_obj\_stream\_attr}, \[695], 772, 1544, 1603.
\:\\{obj\_offset}, \[695], 698, 813, 814, 815.
\:\\{obj\_os\_idx}, \[695], 698, 814.
\:\\{obj\_outline\_action\_objnum}, \[695], 789, 1563.
\:\\{obj\_outline\_attr}, \[695], 789, 1563.
\:\\{obj\_outline\_count}, \[695], 788, 789, 1563, 1637.
\:\\{obj\_outline\_first}, \[695], 789, 1563, 1637.
\:\\{obj\_outline\_last}, \[695], 789, 1563, 1637.
\:\\{obj\_outline\_next}, \[695], 788, 789, 1563, 1637.
\:\\{obj\_outline\_parent}, \[695], 788, 789, 1563, 1637.
\:\\{obj\_outline\_prev}, \[695], 789, 1562, 1563.
\:\\{obj\_outline\_ptr}, \[695], 1563.
\:\\{obj\_outline\_title}, \[695], 789, 1563.
\:\\{obj\_ptr}, 693, \[696], 697, 698, 752, 770, 786, 788, 790, 804, 806, 813,
814, 1504, 1505, 1513, 1544, 1548, 1552, 1555, 1558, 1563, 1579, 1600, 1636.
\:\\{obj\_tab}, 694, 695, \[696], 697, 698, 804, 1504, 1505.
\:\\{obj\_tab\_size}, 694, \[696], 697, 698, 1504, 1505, 1513.
\:\\{obj\_thread\_first}, \[695], 1600, 1637.
\:\\{obj\_type\_dest}, \[695], 698, 796, 1555, 1565, 1630, 1637.
\:\\{obj\_type\_font}, 693, \[695], 801.
\:\\{obj\_type\_obj}, \[695], 1504, 1505, 1544, 1546.
\:\\{obj\_type\_others}, \[695], 698, 752, 786, 788, 790, 804, 806, 807, 814,
1563, 1579, 1600, 1636.
\:\\{obj\_type\_outline}, \[695], 789, 1563.
\:\\{obj\_type\_page}, 498, \[695], 698, 752, 795, 797, 799, 800, 802, 1600,
1630.
\:\\{obj\_type\_pages}, \[695], 770, 800, 802, 803.
\:\\{obj\_type\_struct\_dest}, \[695], 798, 1555, 1565, 1630, 1637.
\:\\{obj\_type\_thread}, \[695], 790, 1630, 1637.
\:\\{obj\_type\_xform}, 497, \[695], 1504, 1505, 1548, 1549.
\:\\{obj\_type\_ximage}, 497, \[695], 1504, 1505, 1552, 1554.
\:\\{obj\_xform\_attr}, \[695], 756, 1548.
\:\\{obj\_xform\_box}, \[695], 775, 1548, 1623.
\:\\{obj\_xform\_depth}, \[695], 1548, 1549, 1603, 1637.
\:\\{obj\_xform\_height}, \[695], 1548, 1549, 1603.
\:\\{obj\_xform\_resources}, \[695], 763, 1548.
\:\\{obj\_xform\_width}, \[695], 1548, 1549, 1603.
\:\\{obj\_ximage\_attr}, \[695], 778, 1552.
\:\\{obj\_ximage\_data}, 497, \[695], 767, 778, 1552, 1637.
\:\\{obj\_ximage\_depth}, \[695], 1552, 1554, 1603.
\:\\{obj\_ximage\_height}, \[695], 1552, 1554, 1603.
\:\\{obj\_ximage\_width}, \[695], 1552, 1554, 1603.
\:\\{objname}, 698, 793, 805, 1627.
\:\\{objnum}, 698, 805, 1627.
\:\\{octal\_token}, \[464], 470.
\:\\{odd}, 62, 100, 116, 165, 211, 530, 604, 702, 934, 1042, 1075, 1079, 1085,
1086, 1090, 1091, 1389, 1396, 1426, 1473, 1688, 1800, 1819, 1824.
\:\\{off\_save}, 1241, \[1242], 1272, 1273, 1308, 1309, 1318, 1370, 1371.
\:\.{OK}, 1476.
\:\\{OK\_so\_far}, \[466], 471.
\:\\{OK\_to\_interrupt}, 88, \[96], 97, 98, 349, 1208.
\:\\{old\_l}, \[1005], 1011, 1026.
\:\\{old\_mode}, \[727], \[1615], \[1617], 1618.
\:\\{old\_rover}, \[149].
\:\\{old\_setting}, 263, \[264], \[333], 334, \[491], \[496], \[560], \[608],
645, \[666], 686, \[705], \[706], \[712], \[727], \[1435], \[1457], \[1615], %
\[1617], 1688, \[1753].
\:\\{omit}, \[226], 287, 288, 964, 965, 1304.
\:\9{omit\_}{\.{\\omit} primitive}, \[287].
\:\\{omit\_error}, 1304, \[1307].
\:\\{omit\_template}, \[180], 965, 966.
\:\\{one\_bp}, 672, \[687], 688, 693.
\:\\{one\_hundred\_bp}, \[687], 688, 690, 692, 693, 792, 1637.
\:\\{one\_hundred\_inch}, 672, \[687], 688, 1552.
\:\.{Only one \# is allowed...}, 960.
\:\\{op\_byte}, \[571], 583, 705, 823, 917, 929, 1086, 1088, 1218.
\:\\{op\_noad}, \[858], 866, 872, 874, 902, 904, 909, 925, 937, 1334, 1335,
1337.
\:\\{op\_start}, 1097, \[1098], 1101, 1122, 1503.
\:\\{open\_area}, \[1521], 1531, 1603, 1622.
\:\\{open\_ext}, \[1521], 1531, 1603, 1622.
\:\\{open\_fmt\_file}, \[550], 1517.
\:\9{open\_in\_}{\.{\\openin} primitive}, \[1450].
\:\\{open\_log\_file}, 78, 92, 382, 497, 558, \[560], 561, 563, 684, 1435, 1515.
\:\\{open\_name}, \[1521], 1531, 1603, 1622.
\:\\{open\_noad}, \[858], 866, 872, 874, 904, 909, 936, 937, 938, 1334, 1335.
\:\\{open\_node}, \[1521], 1524, 1526, 1528, 1603, 1604, 1605, 1620.
\:\\{open\_node\_size}, \[1521], 1531, 1604, 1605.
\:\\{open\_or\_close\_in}, 1452, \[1453].
\:\9{open\_out\_}{\.{\\openout} primitive}, \[1524].
\:\\{open\_parens}, \[326], 353, 384, 563, 1515, 1755.
\:\\{open\_subentries}, 788, \[1637].
\:\9{or\_}{\.{\\or} primitive}, \[517].
\:\\{or\_code}, \[515], 517, 518, 526, 535, 1471, 1668.
\:\\{ord}, 20.
\:\\{ord\_noad}, 857, \[858], 862, 863, 866, 872, 874, 904, 905, 909, 928, 929,
937, 940, 941, 1253, 1333, 1334, 1335, 1364.
\:\\{order}, \[195].
\:{oriental characters}, 152, 612.
\:\\{orig\_char\_info}, 604, 705.
\:\\{other\_A\_token}, \[471].
\:\\{other\_char}, \[225], 250, 311, 313, 316, 320, 369, 471, 490, 552, 1112,
1138, 1207, 1215, 1268, 1302, 1329, 1332, 1338.
\:\\{other\_token}, \[311], 431, 464, 467, 471, 490, 529, 1243, 1399, 1761,
1769, 1784, 1785.
\:\&{othercases}, \[10].
\:\\{others}, 10, 1620.
\:\.{Ouch...clobbered}, 1512.
\:\\{out\_form}, \[1637], 1644, 1647.
\:\\{out\_image}, \[1637], 1643, 1646.
\:\\{out\_param}, \[225], 311, 313, 316, 379.
\:\\{out\_param\_token}, \[311], 505.
\:\\{out\_thread}, 790, \[1600].
\:\\{out\_what}, 1613, 1614, \[1620], 1623, 1639, 1645.
\:\9{outer\_}{\.{\\outer} primitive}, \[1386].
\:\\{outer\_call}, \[228], 297, 361, 373, 375, 376, 379, 388, 413, 417, 422,
956, 1330, 1473, 1616.
\:\\{outer\_doing\_leaders}, \[647], 656, \[657], 665, \[729], 737, \[738], 746.
\:\\{outline\_list\_count}, \[1562], 1563.
\:\\{outlines}, 788, 806, 1513.
\:\\{output}, \[4].
\:\.{Output loop...}, 1201.
\:\.{Output routine didn't use...}, 1205.
\:\.{Output written on x}, 670, 794.
\:\9{output\_}{\.{\\output} primitive}, \[248].
\:\\{output\_active}, 447, 839, 851, 1163, \[1166], 1167, 1171, 1182, 1202,
1203.
\:\\{output\_file\_name}, \[558], 559, 670, 684, 794, 814, 815.
\:\\{output\_group}, \[291], 1202, 1278, 1661, 1679.
\:\\{output\_one\_char}, \[726], 731.
\:\\{output\_penalty}, \[254].
\:\9{output\_penalty\_}{\.{\\outputpenalty} primitive}, \[256].
\:\\{output\_penalty\_code}, \[254], 255, 256, 1190.
\:\\{output\_routine}, \[248], 1189, 1202.
\:\\{output\_routine\_loc}, \[248], 249, 250, 329, 345, 1404.
\:\\{output\_text}, \[329], 336, 345, 1202, 1203.
\:\9{over\_}{\.{\\over} primitive}, \[1356].
\:\\{over\_code}, \[1356], 1357, 1360.
\:\\{over\_noad}, \[863], 866, 872, 874, 909, 937, 1334.
\:\9{over\_with\_delims\_}{\.{\\overwithdelims} primitive}, \[1356].
\:\\{overbar}, \[881], 910, 913.
\:\\{overflow}, 35, 42, 43, \[94], 138, 143, 234, 279, 282, 286, 295, 296, 343,
350, 400, 416, 543, 607, 678, 680, 686, 698, 705, 706, 719, 725, 1117, 1121,
1131, 1141, 1513, 1635, 1768, 1782.
\:{overflow in arithmetic}, 9, 104.
\:\.{Overfull \\hbox...}, 842.
\:\.{Overfull \\vbox...}, 853.
\:{overfull boxes}, 1030.
\:\\{overfull\_rule}, \[265], 842, 976, 980.
\:\9{overfull\_rule\_}{\.{\\overfullrule} primitive}, \[266].
\:\\{overfull\_rule\_code}, \[265], 266.
\:\9{overline\_}{\.{\\overline} primitive}, \[1334].
\:\|{p}, \[112], \[114], \[138], \[141], \[143], \[148], \[149], \[154], %
\[157], \[162], \[163], \[165], \[169], \[170], \[171], \[172], \[174], \[176],
\[185], \[190], \[192], \[194], \[196], \[200], \[216], \[218], \[219], \[220],
\[222], \[236], \[278], \[281], \[284], \[285], \[298], \[299], \[300], \[301],
\[303], \[306], \[314], \[317], \[321], \[328], \[337], \[345], \[347], \[358],
\[388], \[415], \[433], \[439], \[476], \[490], \[491], \[499], \[508], \[523],
\[524], \[609], \[634], \[642], \[647], \[657], \[666], \[674], \[693], \[729],
\[738], \[823], \[844], \[855], \[862], \[864], \[865], \[867], \[868], \[880],
\[881], \[885], \[887], \[891], \[892], \[893], \[896], \[902], \[911], \[914],
\[919], \[925], \[928], \[932], \[948], \[950], \[963], \[967], \[975], \[976],
\[1002], \[1083], \[1111], \[1125], \[1126], \[1130], \[1134], \[1136], %
\[1137], \[1143], \[1145], \[1147], \[1170], \[1171], \[1189], \[1242], %
\[1246], \[1253], \[1257], \[1264], \[1271], \[1279], \[1283], \[1288], %
\[1291], \[1297], \[1301], \[1316], \[1329], \[1333], \[1338], \[1352], %
\[1354], \[1362], \[1369], \[1372], \[1389], \[1414], \[1422], \[1466], %
\[1471], \[1480], \[1481], \[1528], \[1529], \[1545], \[1556], \[1573], %
\[1577], \[1602], \[1615], \[1617], \[1620], \[1635], \[1636], \[1637], %
\[1679], \[1683], \[1719], \[1723], \[1733], \[1738], \[1744], \[1753], %
\[1756], \[1757], \[1777], \[1782], \[1821], \[1823], \[1837], \[1838], %
\[1839], \[1840], \[1841].
\:\\{p\_1}, 1854.
\:\\{pack\_begin\_line}, \[837], 838, 839, 851, 980, 991.
\:\\{pack\_buffered\_name}, \[549], 550.
\:\\{pack\_cur\_name}, \[555], 556, 563, 772, 1453, 1622.
\:\\{pack\_file\_name}, \[545], 555, 563, 589, 713.
\:\\{pack\_job\_name}, \[555], 558, 560, 684, 1508.
\:\\{pack\_lig}, \[1212].
\:\\{package}, 1263, \[1264].
\:\\{packed\_ASCII\_code}, \[38], 39, 793, 1124.
\:\\{packet\_byte}, 725, 726.
\:\\{packet\_length}, 712, 717, 719.
\:\\{packet\_read\_signed}, \[725].
\:\\{packet\_read\_unsigned}, \[725], 726.
\:\\{packet\_scaled}, \[725], 726.
\:\\{page}, \[326], 1552.
\:\\{page\_contents}, 447, \[1157], 1163, 1164, 1168, 1177, 1178, 1185.
\:\\{page\_depth}, \[1159], 1164, 1168, 1179, 1180, 1181, 1185, 1187, 1611.
\:\9{page\_depth\_}{\.{\\pagedepth} primitive}, \[1160].
\:\\{page\_disc}, 1176, 1200, 1203, \[1859], 1860.
\:\9{page\_discards\_}{\.{\\pagediscards} primitive}, \[1861].
\:\9{page\_fil\_stretch\_}{\.{\\pagefilstretch} primitive}, \[1160].
\:\9{page\_fill\_stretch\_}{\.{\\pagefillstretch} primitive}, \[1160].
\:\9{page\_filll\_stretch\_}{\.{\\pagefilllstretch} primitive}, \[1160].
\:\\{page\_goal}, 1157, \[1159], 1163, 1164, 1182, 1183, 1184, 1185, 1186, 1187.
\:\9{page\_goal\_}{\.{\\pagegoal} primitive}, \[1160].
\:\\{page\_head}, \[180], 233, 1157, 1163, 1165, 1168, 1191, 1194, 1200, 1203,
1232.
\:\\{page\_ins\_head}, \[180], 498, 1158, 1163, 1182, 1185, 1195, 1196, 1197.
\:\\{page\_ins\_node\_size}, \[1158], 1186, 1196.
\:\\{page\_loc}, \[666], 668.
\:\\{page\_max\_depth}, \[1157], 1159, 1164, 1168, 1180, 1194.
\:\\{page\_shrink}, \[1159], 1162, 1181, 1184, 1185, 1186.
\:\9{page\_shrink\_}{\.{\\pageshrink} primitive}, \[1160].
\:\\{page\_so\_far}, 447, \[1159], 1162, 1164, 1181, 1184, 1186, 1423.
\:\\{page\_stack}, \[326].
\:\9{page\_stretch\_}{\.{\\pagestretch} primitive}, \[1160].
\:\\{page\_tail}, 233, \[1157], 1163, 1168, 1175, 1177, 1194, 1200, 1203, 1232.
\:\\{page\_total}, \[1159], 1162, 1179, 1180, 1181, 1184, 1185, 1187, 1611.
\:\9{page\_total\_}{\.{\\pagetotal} primitive}, \[1160].
\:\\{pagebox}, 1552.
\:\\{pages\_tail}, \[696], 800, 802.
\:\\{pages\_tree\_kids\_max}, \[695], 770, 794, 802, 803.
\:\\{panicking}, \[183], 184, 1208, 1519.
\:\9{par\_}{\.{\\par} primitive}, \[356].
\:\\{par\_end}, \[225], 356, 357, 1224, 1272.
\:\\{par\_fill\_skip}, \[242], 992, 1842, 1843, 1846, 1853.
\:\9{par\_fill\_skip\_}{\.{\\parfillskip} primitive}, \[244].
\:\\{par\_fill\_skip\_code}, \[242], 243, 244, 992.
\:\\{par\_indent}, \[265], 1269, 1271.
\:\9{par\_indent\_}{\.{\\parindent} primitive}, \[266].
\:\\{par\_indent\_code}, \[265], 266.
\:\\{par\_loc}, \[355], 356, 373, 1491, 1492.
\:\9{par\_shape\_}{\.{\\parshape} primitive}, \[287].
\:\9{par\_shape\_dimen\_}{\.{\\parshapedimen} primitive}, \[1672].
\:\\{par\_shape\_dimen\_code}, \[1672], 1673, 1674.
\:\9{par\_shape\_indent\_}{\.{\\parshapeindent} primitive}, \[1672].
\:\\{par\_shape\_indent\_code}, \[1672], 1673, 1674.
\:\9{par\_shape\_length\_}{\.{\\parshapelength} primitive}, \[1672].
\:\\{par\_shape\_length\_code}, \[1672], 1673, 1674.
\:\\{par\_shape\_loc}, \[248], 250, 251, 287, 288, 449, 1248, 1426.
\:\\{par\_shape\_ptr}, \[248], 250, 251, 449, 990, 1023, 1024, 1026, 1066,
1248, 1327, 1427, 1674.
\:\\{par\_skip}, \[242], 1269.
\:\9{par\_skip\_}{\.{\\parskip} primitive}, \[244].
\:\\{par\_skip\_code}, \[242], 243, 244, 1269.
\:\\{par\_token}, \[355], 356, 361, 418, 421, 425, 1273, 1492.
\:\.{Paragraph ended before...}, 422.
\:\\{param}, 568, 573, \[584].
\:\\{param\_base}, \[576], 578, 584, 592, 601, 602, 603, 605, 607, 705, 706,
876, 877, 1220, 1500, 1501.
\:\\{param\_end}, \[584].
\:\\{param\_ptr}, \[330], 345, 346, 353, 416.
\:\\{param\_size}, \[11], 330, 416, 1514.
\:\\{param\_stack}, 329, \[330], 346, 381, 414, 415, 416.
\:\\{param\_start}, \[329], 345, 346, 381.
\:\\{parameter}, \[329], 336, 381.
\:{parameters for symbols}, 876, 877.
\:\.{Parameters...consecutively}, 502.
\:\\{parent\_box}, 1630, 1635, 1636, 1637.
\:\9{PASCAL H}{\ph}, \[3], 4, 9, 10, 27, 28, 33, 34.
\:\9{PASCAL}{\PASCAL}, 1, 10, 869, 940.
\:\\{pass\_number}, \[997], 1021, 1040.
\:\\{pass\_text}, 388, \[520], 526, 535, 536.
\:\\{passive}, \[997], 1021, 1022, 1040, 1041.
\:\\{passive\_node\_size}, \[997], 1021, 1041.
\:\.{Patterns can be...}, 1430.
\:\9{patterns\_}{\.{\\patterns} primitive}, \[1428].
\:\\{pause\_for\_instructions}, 96, \[98].
\:\\{pausing}, \[254], 385.
\:\9{pausing\_}{\.{\\pausing} primitive}, \[256].
\:\\{pausing\_code}, \[254], 255, 256.
\:\.{pc}, 484.
\:\\{pdf\_action\_file}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_goto}, \[695], 1556, 1603, 1630.
\:\\{pdf\_action\_id}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_named\_id}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_new\_window}, \[695], 1556, 1630.
\:\\{pdf\_action\_page}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_page\_tokens}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_refcount}, \[695], 1536, 1556.
\:\\{pdf\_action\_size}, \[695], 1536, 1556.
\:\\{pdf\_action\_struct\_id}, \[695], 1536, 1556, 1630.
\:\\{pdf\_action\_thread}, \[695], 1556, 1603, 1630.
\:\\{pdf\_action\_type}, \[695], 782, 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_user}, \[695], 782, 1536, 1556, 1603, 1630.
\:\\{pdf\_action\_user\_tokens}, \[695], 1536, 1556, 1603, 1630.
\:\\{pdf\_adjust\_interword\_glue}, \[254], 1207, 1219.
\:\9{pdf\_adjust\_interword\_glue\_}{\.{\\pdfadjustinterwordglue} primitive}, %
\[256].
\:\\{pdf\_adjust\_interword\_glue\_code}, \[254], 255, 256.
\:\\{pdf\_adjust\_spacing}, \[254], 999, 1003, 1017, 1018, 1027, 1042, 1043,
1046, 1047, 1066.
\:\9{pdf\_adjust\_spacing\_}{\.{\\pdfadjustspacing} primitive}, \[256].
\:\\{pdf\_adjust\_spacing\_code}, \[254], 255, 256.
\:\9{pdf\_annot\_}{\.{\\pdfannot} primitive}, \[1524].
\:\\{pdf\_annot\_data}, \[695], 781, 1558, 1603, 1604, 1605.
\:\\{pdf\_annot\_list}, 754, 765, 771, 781, \[1628], 1630.
\:\\{pdf\_annot\_node}, 781, \[1524], 1526, 1528, 1558, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_annot\_node\_size}, \[695], 1558, 1560, 1604, 1605.
\:\\{pdf\_annot\_objnum}, \[695], 1558, 1630.
\:\\{pdf\_append\_kern}, \[254], 705.
\:\9{pdf\_append\_kern\_}{\.{\\pdfappendkern} primitive}, \[256].
\:\\{pdf\_append\_kern\_code}, \[254], 255, 256.
\:\\{pdf\_append\_list}, 693, 696, \[698], 1630, 1635, 1636, 1637, 1639, 1645.
\:\\{pdf\_append\_list\_arg}, \[696], 698.
\:\\{pdf\_append\_list\_end}, \[698].
\:\\{pdf\_bead\_list}, 754, 765, 771, 786, \[1628], 1637.
\:\\{pdf\_begin\_dict}, \[698], 699, 752, 762, 769, 772, 778, 781, 782, 784,
789, 803, 805, 1600.
\:\\{pdf\_begin\_obj}, \[698], 772, 784, 795, 797.
\:\\{pdf\_begin\_stream}, \[685], 699, 757, 772, 814.
\:\\{pdf\_begin\_string}, \[693], 726.
\:\\{pdf\_begin\_text}, \[693].
\:\\{pdf\_bottom}, \[695], 781, 782, 785, 1630, 1635, 1637.
\:\\{pdf\_box\_spec\_art}, \[696], 697, 1552.
\:\\{pdf\_box\_spec\_bleed}, \[696], 697, 1552.
\:\\{pdf\_box\_spec\_crop}, \[696], 697, 1552.
\:\\{pdf\_box\_spec\_media}, \[696], 697, 1552.
\:\\{pdf\_box\_spec\_trim}, \[696], 697, 1552.
\:\\{pdf\_buf}, \[680], 681, 685, 686, 698, 699, 772.
\:\\{pdf\_buf\_size}, \[680], 681, 686, 698, 699.
\:\9{pdf\_catalog\_}{\.{\\pdfcatalog} primitive}, \[1524].
\:\\{pdf\_catalog\_code}, \[1524], 1526, 1528.
\:\\{pdf\_catalog\_openaction}, 806, 1579, \[1628], 1629.
\:\\{pdf\_catalog\_toks}, 806, 1579, \[1628], 1629.
\:\\{pdf\_char\_marked}, 801.
\:\\{pdf\_char\_used}, \[708].
\:\\{pdf\_check\_obj}, 497, \[1545], 1546, 1549, 1554.
\:\\{pdf\_check\_vf\_cur\_val}, 497, \[703], \[720], 1587.
\:\9{pdf\_colorstack\_}{\.{\\pdfcolorstack} primitive}, \[1524].
\:\\{pdf\_colorstack\_cmd}, \[695], 727, 1539, 1603, 1604, 1605.
\:\\{pdf\_colorstack\_data}, \[695], 727, 1539, 1603, 1604, 1605.
\:\\{pdf\_colorstack\_getter\_node\_size}, \[695], 1539, 1604, 1605.
\:\9{pdf\_colorstack\_init\_}{\.{\\pdfcolorstackinit} primitive}, \[494].
\:\\{pdf\_colorstack\_init\_code}, \[494], 495, 497, 498.
\:\\{pdf\_colorstack\_node}, \[1524], 1526, 1528, 1539, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_colorstack\_node\_size}, \[695].
\:\\{pdf\_colorstack\_setter\_node\_size}, \[695], 1539, 1604, 1605.
\:\\{pdf\_colorstack\_stack}, \[695], 727, 1539, 1603.
\:\\{pdf\_compress\_level}, \[254], 672, 673, 685, 698, 748.
\:\9{pdf\_compress\_level\_}{\.{\\pdfcompresslevel} primitive}, \[256].
\:\\{pdf\_compress\_level\_code}, \[254], 255, 256.
\:\\{pdf\_copy\_font}, \[227], 287, 288, 439, 604, 1388, 1434.
\:\9{pdf\_copy\_font\_}{\.{\\pdfcopyfont} primitive}, \[287].
\:\\{pdf\_create\_obj}, 693, \[698], 770, 804, 1544, 1548, 1552, 1555, 1563,
1636.
\:\9{pdf\_creation\_date\_}{\.{\\pdfcreationdate} primitive}, \[494].
\:\\{pdf\_creation\_date\_code}, \[494], 495, 497.
\:\\{pdf\_cur\_form}, 752, 756, 763, 775, 1623, \[1628].
\:\\{pdf\_cur\_Tm\_a}, 690, \[691], 692, 693.
\:\\{pdf\_decimal\_digits}, \[254], 672, 792.
\:\9{pdf\_decimal\_digits\_}{\.{\\pdfdecimaldigits} primitive}, \[256].
\:\\{pdf\_decimal\_digits\_code}, \[254], 255, 256.
\:\\{pdf\_delta\_h}, 690, \[691], 692, 693.
\:\\{pdf\_depth}, \[695], 1549, 1554, 1556, 1565, 1601, 1603, 1604, 1606, 1607,
1611, 1612, 1630, 1635, 1636, 1637, 1643, 1644, 1646.
\:\9{pdf\_dest\_}{\.{\\pdfdest} primitive}, \[1524].
\:\\{pdf\_dest\_fit}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fitb}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fitbh}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fitbv}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fith}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fitr}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_fitv}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_id}, \[695], 1565, 1603, 1604, 1605, 1637.
\:\\{pdf\_dest\_list}, 754, 765, 784, \[1628], 1637.
\:\\{pdf\_dest\_margin}, \[265], 1637.
\:\9{pdf\_dest\_margin\_}{\.{\\pdfdestmargin} primitive}, \[266].
\:\\{pdf\_dest\_margin\_code}, \[265], 266.
\:\\{pdf\_dest\_named\_id}, \[695], 784, 1565, 1603, 1604, 1605, 1637.
\:\\{pdf\_dest\_names\_ptr}, 698, 804, 805, 1513, \[1628], 1629.
\:\\{pdf\_dest\_node}, 695, \[1524], 1526, 1528, 1565, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_dest\_node\_size}, \[695], 1565, 1604, 1605.
\:\\{pdf\_dest\_objnum}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_type}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_xyz}, \[695], 784, 1565, 1603, 1637.
\:\\{pdf\_dest\_xyz\_zoom}, \[695], 784, 1565, 1603.
\:\\{pdf\_doing\_string}, \[691], 692, 693.
\:\\{pdf\_doing\_text}, \[691], 693.
\:\\{pdf\_draftmode}, \[254], 672, 683, 748, 1517.
\:\9{pdf\_draftmode\_}{\.{\\pdfdraftmode} primitive}, \[256].
\:\\{pdf\_draftmode\_code}, \[254], 255, 256.
\:\\{pdf\_draftmode\_option}, \[691], 1517.
\:\\{pdf\_draftmode\_value}, \[691], 1517.
\:\\{pdf\_dummy\_font}, \[691], 693, 697.
\:\\{pdf\_each\_line\_depth}, \[265], 1064, 1065.
\:\9{pdf\_each\_line\_depth\_}{\.{\\pdfeachlinedepth} primitive}, \[266].
\:\\{pdf\_each\_line\_depth\_code}, \[265], 266.
\:\\{pdf\_each\_line\_height}, \[265], 1064, 1065.
\:\9{pdf\_each\_line\_height\_}{\.{\\pdfeachlineheight} primitive}, \[266].
\:\\{pdf\_each\_line\_height\_code}, \[265], 266.
\:\\{pdf\_end\_dict}, \[698], 762, 769, 781, 782, 784, 788, 789, 803, 804, 805,
806, 807, 1600.
\:\9{pdf\_end\_link\_}{\.{\\pdfendlink} primitive}, \[1524].
\:\\{pdf\_end\_link\_node}, \[1524], 1526, 1528, 1561, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_end\_obj}, 685, \[698], 772, 784, 786, 790, 795, 797, 1563, 1579.
\:\\{pdf\_end\_stream}, \[685], 699, 760, 772, 814.
\:\\{pdf\_end\_string}, \[692], 693.
\:\\{pdf\_end\_string\_nl}, \[692], 693.
\:\\{pdf\_end\_text}, \[693], 760, 1637.
\:\9{pdf\_end\_thread\_}{\.{\\pdfendthread} primitive}, \[1524].
\:\\{pdf\_end\_thread\_node}, \[1524], 1526, 1528, 1569, 1603, 1604, 1605,
1639, 1645.
\:\\{pdf\_error}, 497, 597, 599, 683, 685, \[686], 689, 693, 705, 706, 712,
720, 726, 727, 747, 748, 772, 784, 823, 1005, 1537, 1545, 1548, 1552, 1556,
1558, 1560, 1561, 1565, 1566, 1573, 1579, 1587, 1589, 1593, 1603, 1620, 1623,
1630, 1635, 1637, 1639, 1645.
\:\9{pdf\_escape\_hex\_}{\.{\\pdfescapehex} primitive}, \[494].
\:\\{pdf\_escape\_hex\_code}, \[494], 495, 497.
\:\9{pdf\_escape\_name\_}{\.{\\pdfescapename} primitive}, \[494].
\:\\{pdf\_escape\_name\_code}, \[494], 495, 497.
\:\9{pdf\_escape\_string\_}{\.{\\pdfescapestring} primitive}, \[494].
\:\\{pdf\_escape\_string\_code}, \[494], 495, 497.
\:\\{pdf\_f}, \[691], 692, 693.
\:\9{pdf\_fake\_space\_}{\.{\\pdffakespace} primitive}, \[1524].
\:\\{pdf\_fake\_space\_node}, \[1524], 1526, 1528, 1596, 1603, 1604, 1605,
1639, 1645.
\:\\{pdf\_file}, \[680], 684, 794.
\:\9{pdf\_file\_dump\_}{\.{\\pdffiledump} primitive}, \[494].
\:\\{pdf\_file\_dump\_code}, \[494], 495, 497.
\:\9{pdf\_file\_mod\_date\_}{\.{\\pdffilemoddate} primitive}, \[494].
\:\\{pdf\_file\_mod\_date\_code}, \[494], 495, 497.
\:\9{pdf\_file\_size\_}{\.{\\pdffilesize} primitive}, \[494].
\:\\{pdf\_file\_size\_code}, \[494], 495, 497.
\:\\{pdf\_first\_line\_height}, \[265], 1064, 1065.
\:\9{pdf\_first\_line\_height\_}{\.{\\pdffirstlineheight} primitive}, \[266].
\:\\{pdf\_first\_line\_height\_code}, \[265], 266.
\:\\{pdf\_first\_outline}, 788, 789, 1563, \[1628], 1629.
\:\\{pdf\_fix\_dest}, \[795], 796.
\:\\{pdf\_fix\_struct\_dest}, \[797], 798.
\:\\{pdf\_fix\_thread}, \[1600].
\:\\{pdf\_flush}, 680, \[685], 794.
\:\\{pdf\_font\_attr}, \[704], 801, 1589.
\:\9{pdf\_font\_attr\_}{\.{\\pdffontattr} primitive}, \[1524].
\:\\{pdf\_font\_attr\_code}, \[1524], 1526, 1528.
\:\\{pdf\_font\_auto\_expand}, 692, 693, 705, 712, 720, \[821].
\:\\{pdf\_font\_blink}, 192, 693, 705, 720, \[821].
\:\\{pdf\_font\_ef\_base}, 705, \[821].
\:\\{pdf\_font\_elink}, 703, 705, \[821].
\:\9{pdf\_font\_expand\_}{\.{\\pdffontexpand} primitive}, \[1524].
\:\\{pdf\_font\_expand\_code}, \[1524], 1526, 1528.
\:\\{pdf\_font\_expand\_ratio}, 192, 692, 705, 706, 712, 720, \[821], 823.
\:\\{pdf\_font\_has\_space\_char}, 693, \[821].
\:\\{pdf\_font\_kn\_ac\_base}, 705, \[821].
\:\\{pdf\_font\_kn\_bc\_base}, 705, \[821].
\:\\{pdf\_font\_kn\_bs\_base}, 705, \[821].
\:\\{pdf\_font\_list}, 693, \[708], 750, 753, 764, 766, 775, 776, 777.
\:\\{pdf\_font\_lp\_base}, 705, \[821].
\:\\{pdf\_font\_map}, 693, \[708].
\:\9{pdf\_font\_name\_}{\.{\\pdffontname} primitive}, \[494].
\:\\{pdf\_font\_name\_code}, \[494], 495, 497, 498.
\:\\{pdf\_font\_nobuiltin\_tounicode}, \[704], 1593.
\:\\{pdf\_font\_num}, 498, 692, 693, 698, \[708], 766, 801.
\:\9{pdf\_font\_objnum\_}{\.{\\pdffontobjnum} primitive}, \[494].
\:\\{pdf\_font\_objnum\_code}, \[494], 495, 497, 498.
\:\\{pdf\_font\_rp\_base}, 705, \[821].
\:\\{pdf\_font\_sh\_bs\_base}, 705, \[821].
\:\\{pdf\_font\_shrink}, 705, 712, \[821], 823.
\:\\{pdf\_font\_size}, 690, 692, 693, \[708].
\:\9{pdf\_font\_size\_}{\.{\\pdffontsize} primitive}, \[494].
\:\\{pdf\_font\_size\_code}, \[494], 495, 497, 498.
\:\\{pdf\_font\_st\_bs\_base}, 705, \[821].
\:\\{pdf\_font\_step}, 705, 706, 712, \[821], 823.
\:\\{pdf\_font\_stretch}, 705, 712, \[821], 823.
\:\\{pdf\_font\_type}, 703, \[704], 705, 706, 712, 720, 726.
\:\\{pdf\_force\_pagebox}, \[254], 1552.
\:\9{pdf\_force\_pagebox\_}{\.{\\pdfforcepagebox} primitive}, \[256].
\:\\{pdf\_force\_pagebox\_code}, \[254], 255, 256.
\:\\{pdf\_gamma}, \[254], 672, 683.
\:\9{pdf\_gamma\_}{\.{\\pdfgamma} primitive}, \[256].
\:\\{pdf\_gamma\_code}, \[254], 255, 256.
\:\\{pdf\_gen\_tounicode}, \[254], 801.
\:\9{pdf\_gen\_tounicode\_}{\.{\\pdfgentounicode} primitive}, \[256].
\:\\{pdf\_gen\_tounicode\_code}, \[254], 255, 256.
\:\\{pdf\_get\_mem}, \[678], 705, 1544, 1548, 1552, 1563, 1637.
\:\9{pdf\_glyph\_to\_unicode\_}{\.{\\pdfglyphtounicode} primitive}, \[1524].
\:\\{pdf\_glyph\_to\_unicode\_code}, \[1524], 1526, 1528.
\:\\{pdf\_gone}, \[680], 681, 685, 794.
\:\\{pdf\_h}, 690, \[691], 692.
\:\\{pdf\_h\_origin}, \[265], 672, 755.
\:\9{pdf\_h\_origin\_}{\.{\\pdfhorigin} primitive}, \[266].
\:\\{pdf\_h\_origin\_code}, \[265], 266.
\:\\{pdf\_height}, \[695], 1549, 1554, 1556, 1565, 1601, 1603, 1604, 1606,
1607, 1611, 1612, 1630, 1635, 1636, 1637, 1643, 1644.
\:\\{pdf\_hlist\_out}, 727, \[729], 733, 737, 738, 742, 746, 751, 1555.
\:\\{pdf\_ignored\_dimen}, 237, \[265], 855, 963, 1064, 1065, 1202, 1234, 1261,
1277, 1345, 1481.
\:\9{pdf\_ignored\_dimen\_}{\.{\\pdfignoreddimen} primitive}, \[266].
\:\\{pdf\_ignored\_dimen\_code}, \[265], 266.
\:\\{pdf\_image\_apply\_gamma}, \[254], 672, 683.
\:\9{pdf\_image\_apply\_gamma\_}{\.{\\pdfimageapplygamma} primitive}, \[256].
\:\\{pdf\_image\_apply\_gamma\_code}, \[254], 255, 256.
\:\\{pdf\_image\_gamma}, \[254], 672, 683.
\:\9{pdf\_image\_gamma\_}{\.{\\pdfimagegamma} primitive}, \[256].
\:\\{pdf\_image\_gamma\_code}, \[254], 255, 256.
\:\\{pdf\_image\_hicolor}, \[254], 672, 683.
\:\9{pdf\_image\_hicolor\_}{\.{\\pdfimagehicolor} primitive}, \[256].
\:\\{pdf\_image\_hicolor\_code}, \[254], 255, 256.
\:\\{pdf\_image\_procset}, \[701], 750, 753, 768, 776, 777.
\:\\{pdf\_image\_resolution}, \[254], 672, 1552.
\:\9{pdf\_image\_resolution\_}{\.{\\pdfimageresolution} primitive}, \[256].
\:\\{pdf\_image\_resolution\_code}, \[254], 255, 256.
\:\\{pdf\_include\_chars}, \[1587], 1588.
\:\9{pdf\_include\_chars\_}{\.{\\pdfincludechars} primitive}, \[1524].
\:\\{pdf\_include\_chars\_code}, \[1524], 1526, 1528.
\:\\{pdf\_inclusion\_copy\_font}, \[254], 683.
\:\9{pdf\_inclusion\_copy\_font\_}{\.{\\pdfinclusioncopyfonts} primitive}, %
\[256].
\:\\{pdf\_inclusion\_copy\_font\_code}, \[254], 255, 256.
\:\\{pdf\_inclusion\_errorlevel}, \[254], 1505, 1552.
\:\9{pdf\_inclusion\_errorlevel\_}{\.{\\pdfinclusionerrorlevel} primitive}, %
\[256].
\:\\{pdf\_inclusion\_errorlevel\_code}, \[254], 255, 256.
\:\\{pdf\_indirect}, \[702], 1630.
\:\\{pdf\_indirect\_ln}, \[702], 756, 769, 770, 788, 789, 803, 804, 806, 814,
815, 1600.
\:\9{pdf\_info\_}{\.{\\pdfinfo} primitive}, \[1524].
\:\\{pdf\_info\_code}, \[1524], 1526, 1528.
\:\\{pdf\_info\_omit\_date}, \[254], 807.
\:\9{pdf\_info\_omit\_date\_}{\.{\\pdfinfoomitdate} primitive}, \[256].
\:\\{pdf\_info\_omit\_date\_code}, \[254], 255, 256.
\:\\{pdf\_info\_toks}, 807, 1578, \[1628], 1629.
\:\\{pdf\_init\_font}, \[693], 1587.
\:\\{pdf\_init\_font\_cur\_val}, 497, \[693], \[703].
\:\\{pdf\_init\_map\_file}, 1517.
\:\\{pdf\_insert\_fake\_space}, \[693], 1639, 1645.
\:\9{pdf\_insert\_ht\_}{\.{\\pdfinsertht} primitive}, \[494].
\:\\{pdf\_insert\_ht\_code}, \[494], 495, 497, 498.
\:\\{pdf\_insert\_interword\_space}, \[693].
\:\\{pdf\_int\_entry}, \[702], 1630.
\:\\{pdf\_int\_entry\_ln}, \[702], 788, 789, 803, 814, 815.
\:\\{pdf\_int\_pars}, \[254].
\:\9{pdf\_interword\_space\_off\_}{\.{\\pdfinterwordspaceoff} primitive}, %
\[1524].
\:\\{pdf\_interword\_space\_off\_node}, \[1524], 1526, 1528, 1595, 1603, 1604,
1605, 1639, 1645.
\:\9{pdf\_interword\_space\_on\_}{\.{\\pdfinterwordspaceon} primitive}, \[1524].
\:\\{pdf\_interword\_space\_on\_node}, \[1524], 1526, 1528, 1594, 1603, 1604,
1605, 1639, 1645.
\:\\{pdf\_last\_annot}, 450, \[1557], 1558.
\:\9{pdf\_last\_annot\_}{\.{\\pdflastannot} primitive}, \[442].
\:\\{pdf\_last\_annot\_code}, \[442], 443, 450.
\:\\{pdf\_last\_byte}, 685, \[696].
\:\\{pdf\_last\_f}, \[691], 693.
\:\\{pdf\_last\_fs}, \[691], 693.
\:\\{pdf\_last\_line\_depth}, \[265], 1064, 1065.
\:\9{pdf\_last\_line\_depth\_}{\.{\\pdflastlinedepth} primitive}, \[266].
\:\\{pdf\_last\_line\_depth\_code}, \[265], 266.
\:\\{pdf\_last\_link}, 450, \[1559], 1560.
\:\9{pdf\_last\_link\_}{\.{\\pdflastlink} primitive}, \[442].
\:\\{pdf\_last\_link\_code}, \[442], 443, 450.
\:\9{pdf\_last\_match\_}{\.{\\pdflastmatch} primitive}, \[494].
\:\\{pdf\_last\_match\_code}, \[494], 495, 497.
\:\\{pdf\_last\_obj}, 450, 1504, 1505, \[1543], 1544, 1623.
\:\9{pdf\_last\_obj\_}{\.{\\pdflastobj} primitive}, \[442].
\:\\{pdf\_last\_obj\_code}, \[442], 443, 450.
\:\\{pdf\_last\_outline}, 788, 789, 1563, 1628, 1629.
\:\\{pdf\_last\_page}, \[696], 752, 769, 784, 1637.
\:\\{pdf\_last\_pages}, \[696], 770, 794, 802, 803, 806, 1513.
\:\\{pdf\_last\_resources}, 750, 752, 756, 762, 769.
\:\\{pdf\_last\_stream}, \[696], 752, 769.
\:\\{pdf\_last\_thread\_id}, \[1628], 1637.
\:\\{pdf\_last\_thread\_named\_id}, \[1628], 1637.
\:\\{pdf\_last\_x\_pos}, 450, \[1570], 1621, 1641.
\:\9{pdf\_last\_x\_pos\_}{\.{\\pdflastxpos} primitive}, \[442].
\:\\{pdf\_last\_x\_pos\_code}, \[442], 443, 450.
\:\\{pdf\_last\_xform}, 450, 1504, 1505, \[1547], 1548, 1623.
\:\9{pdf\_last\_xform\_}{\.{\\pdflastxform} primitive}, \[442].
\:\\{pdf\_last\_xform\_code}, \[442], 443, 450.
\:\\{pdf\_last\_ximage}, 450, 1504, 1505, \[1550], 1552, 1623.
\:\9{pdf\_last\_ximage\_}{\.{\\pdflastximage} primitive}, \[442].
\:\\{pdf\_last\_ximage\_code}, \[442], 443, 450.
\:\\{pdf\_last\_ximage\_colordepth}, 450, \[1550], 1552.
\:\9{pdf\_last\_ximage\_colordepth\_}{\.{\\pdflastximagecolordepth} primitive},
\[442].
\:\\{pdf\_last\_ximage\_colordepth\_code}, \[442], 443, 450.
\:\\{pdf\_last\_ximage\_pages}, 450, \[1550], 1552.
\:\9{pdf\_last\_ximage\_pages\_}{\.{\\pdflastximagepages} primitive}, \[442].
\:\\{pdf\_last\_ximage\_pages\_code}, \[442], 443, 450.
\:\\{pdf\_last\_y\_pos}, 450, \[1570], 1621, 1641.
\:\9{pdf\_last\_y\_pos\_}{\.{\\pdflastypos} primitive}, \[442].
\:\\{pdf\_last\_y\_pos\_code}, \[442], 443, 450.
\:\\{pdf\_lateliteral\_node}, 727, \[1524], 1538, 1603, 1604, 1605, 1639, 1645.
\:\\{pdf\_left}, \[695], 781, 782, 784, 785, 1630, 1635, 1637.
\:\\{pdf\_link\_action}, \[695], 782, 1560, 1603, 1604, 1605.
\:\\{pdf\_link\_attr}, \[695], 782, 1556, 1603, 1604, 1605.
\:\\{pdf\_link\_list}, 754, 765, 771, 782, 783, \[1628], 1635, 1636.
\:\\{pdf\_link\_margin}, \[265], 1635, 1636.
\:\9{pdf\_link\_margin\_}{\.{\\pdflinkmargin} primitive}, \[266].
\:\\{pdf\_link\_margin\_code}, \[265], 266.
\:\\{pdf\_link\_objnum}, \[695], 1560, 1604, 1635.
\:\\{pdf\_link\_stack}, 729, 730, 1631, \[1633], 1636.
\:\\{pdf\_link\_stack\_ptr}, 730, 1631, \[1633], 1634, 1635.
\:\\{pdf\_link\_stack\_record}, \[1632], 1633.
\:\\{pdf\_link\_stack\_top}, \[1631], 1635.
\:\9{pdf\_literal\_}{\.{\\pdfliteral} primitive}, \[1524].
\:\\{pdf\_literal\_data}, \[695], 727, 1538, 1603, 1604, 1605.
\:\\{pdf\_literal\_mode}, \[695], 727, 1538, 1603.
\:\\{pdf\_literal\_node}, \[1524], 1526, 1528, 1538, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_lookup\_list}, \[700], 1637.
\:\\{pdf\_major\_version}, \[254], 672, 673, 683, 768, 1505, 1552.
\:\9{pdf\_major\_version\_}{\.{\\pdfmajorversion} primitive}, \[256].
\:\\{pdf\_major\_version\_code}, \[254], 255, 256.
\:\9{pdf\_map\_file\_}{\.{\\pdfmapfile} primitive}, \[1524].
\:\\{pdf\_map\_file\_code}, \[1524], 1526, 1528.
\:\9{pdf\_map\_line\_}{\.{\\pdfmapline} primitive}, \[1524].
\:\\{pdf\_map\_line\_code}, \[1524], 1526, 1528.
\:\\{pdf\_mark\_char}, 686, 693, 801, 1587.
\:\9{pdf\_match\_}{\.{\\pdfmatch} primitive}, \[494].
\:\\{pdf\_match\_code}, \[494], 495, 497.
\:\\{pdf\_max\_link\_level}, \[1631], 1633, 1635.
\:\9{pdf\_mdfive\_sum\_}{\.{\\pdfmdfivesum} primitive}, \[494].
\:\\{pdf\_mdfive\_sum\_code}, \[494], 495, 497.
\:\\{pdf\_mem}, 675, \[676], 677, 678, 695, 705, 1504, 1505.
\:\\{pdf\_mem\_ptr}, \[676], 677, 678, 1504, 1505, 1513.
\:\\{pdf\_mem\_size}, \[676], 677, 678, 1504, 1505, 1513.
\:\\{pdf\_minor\_version}, \[254], 672, 683, 1505, 1552.
\:\9{pdf\_minor\_version\_}{\.{\\pdfminorversion} primitive}, \[256].
\:\9{pdf\_minor\_version\_}{\.{\\pdfoptionpdfminorversion} primitive}, \[256].
\:\\{pdf\_minor\_version\_code}, \[254], 255, 256.
\:\\{pdf\_move\_chars}, \[254], 692.
\:\9{pdf\_move\_chars\_}{\.{\\pdfmovechars} primitive}, \[256].
\:\\{pdf\_move\_chars\_code}, \[254], 255, 256.
\:\9{pdf\_names\_}{\.{\\pdfnames} primitive}, \[1524].
\:\\{pdf\_names\_code}, \[1524], 1526, 1528.
\:\\{pdf\_names\_toks}, 804, 1580, \[1628], 1629.
\:\\{pdf\_new\_dict}, \[698], 752, 788, 804, 806, 807, 814, 1600.
\:\\{pdf\_new\_line\_char}, 685, \[686], 699.
\:\\{pdf\_new\_obj}, \[698], 786, 790, 1563, 1579.
\:\\{pdf\_new\_objnum}, \[698], 752, 802, 1558, 1560, 1630, 1635, 1637.
\:\\{pdf\_new\_Tm\_a}, \[692].
\:\9{pdf\_nobuiltin\_tounicode\_}{\.{\\pdfnobuiltintounicode} primitive}, %
\[1524].
\:\\{pdf\_nobuiltin\_tounicode\_code}, \[1524], 1526, 1528.
\:\9{pdf\_obj\_}{\.{\\pdfobj} primitive}, \[1524].
\:\\{pdf\_obj\_code}, \[1524], 1526, 1528, 1623.
\:\\{pdf\_obj\_count}, 1504, 1505, 1544, \[1628], 1629.
\:\\{pdf\_obj\_list}, 750, 753, 764, 773, 775, 776, 777, 1543, \[1628], 1639,
1645.
\:\\{pdf\_obj\_objnum}, \[695], 1546, 1603, 1639, 1645.
\:\\{pdf\_objcompresslevel}, \[254], 672, 683.
\:\9{pdf\_objcompresslevel\_}{\.{\\pdfobjcompresslevel} primitive}, \[256].
\:\\{pdf\_objcompresslevel\_code}, \[254], 255, 256.
\:\\{pdf\_objtype\_max}, \[695].
\:\\{pdf\_offset}, \[680], 685, 698, 794, 813.
\:\\{pdf\_omit\_charset}, \[254], 673.
\:\9{pdf\_omit\_charset}{\.{\\pdfomitcharset} primitive}, \[256].
\:\\{pdf\_omit\_charset\_code}, \[254], 255, 256.
\:\\{pdf\_omit\_info\_dict}, \[254], 794, 814, 815.
\:\9{pdf\_omit\_info\_dict}{\.{\\pdfomitinfodict} primitive}, \[256].
\:\\{pdf\_omit\_info\_dict\_code}, \[254], 255, 256.
\:\\{pdf\_omit\_procset}, \[254], 768.
\:\9{pdf\_omit\_procset}{\.{\\pdfomitprocset} primitive}, \[256].
\:\\{pdf\_omit\_procset\_code}, \[254], 255, 256.
\:\\{pdf\_op\_buf}, \[680], 681, 698.
\:\\{pdf\_op\_buf\_size}, \[679], 680, 681, 698.
\:\\{pdf\_op\_ptr}, \[680], 681, 698.
\:\\{pdf\_option\_always\_use\_pdfpagebox}, \[254], 1552.
\:\9{pdf\_option\_always\_use\_pdfpagebox\_}{\.{\\pdfoptionalwaysusepdfpagebox}
primitive}, \[256].
\:\\{pdf\_option\_always\_use\_pdfpagebox\_code}, \[254], 255, 256.
\:\\{pdf\_option\_pdf\_inclusion\_errorlevel}, \[254], 1552.
\:\9{pdf\_option\_pdf\_inclusion\_errorlevel\_}{\.{%
\\pdfoptionpdfinclusionerrorlevel} primitive}, \[256].
\:\\{pdf\_option\_pdf\_inclusion\_errorlevel\_code}, \[254], 255, 256.
\:\\{pdf\_origin\_h}, \[691], 692, 752, 780.
\:\\{pdf\_origin\_v}, \[691], 692, 752, 780.
\:\\{pdf\_os}, 698.
\:\\{pdf\_os\_buf}, \[680], 686, 698, 699.
\:\\{pdf\_os\_buf\_size}, 679, \[680], 681, 686, 698.
\:\\{pdf\_os\_cntr}, \[680], 681, 698, 1513.
\:\\{pdf\_os\_cur\_objnum}, \[680], 681, 698, 699.
\:\\{pdf\_os\_enable}, \[680], 683, 698, 794, 815.
\:\\{pdf\_os\_get\_os\_buf}, 680, \[686].
\:\\{pdf\_os\_level}, 698.
\:\\{pdf\_os\_max\_objs}, \[679], 698, 1513.
\:\\{pdf\_os\_mode}, \[680], 681, 685, 698, 699.
\:\\{pdf\_os\_objidx}, \[680], 698, 699, 1513.
\:\\{pdf\_os\_objnum}, \[680], 698, 699.
\:\\{pdf\_os\_objoff}, \[680], 698, 699.
\:\\{pdf\_os\_prepare\_obj}, \[698].
\:\\{pdf\_os\_ptr}, \[680], 681, 698.
\:\\{pdf\_os\_switch}, \[698], 794.
\:\\{pdf\_os\_write\_objstream}, 698, \[699], 794.
\:\\{pdf\_out}, \[680], 683, 685, 686, 690, 692, 693, 699, 702, 756, 766, 767,
769, 772, 784, 785, 786, 790, 795, 797, 805, 808, 814, 1600, 1630, 1637.
\:\\{pdf\_out\_bytes}, \[702], 814.
\:\\{pdf\_out\_colorstack}, \[727], 1639, 1645.
\:\\{pdf\_out\_colorstack\_startpage}, \[727], 757.
\:\\{pdf\_out\_literal}, \[727], 1639, 1645.
\:\\{pdf\_out\_restore}, \[727], 1639, 1645.
\:\\{pdf\_out\_save}, \[727], 1639, 1645.
\:\\{pdf\_out\_setmatrix}, \[727], 1639, 1645.
\:\9{pdf\_outline\_}{\.{\\pdfoutline} primitive}, \[1524].
\:\\{pdf\_outline\_code}, \[1524], 1526, 1528.
\:\\{pdf\_output}, \[254], 747, 791, 1027, 1517, 1537, 1578, 1579, 1581, 1582.
\:\9{pdf\_output\_}{\.{\\pdfoutput} primitive}, \[256].
\:\\{pdf\_output\_code}, \[254], 255, 256.
\:\\{pdf\_output\_option}, \[691], 1517.
\:\\{pdf\_output\_value}, \[691], 1517.
\:\\{pdf\_page\_attr}, \[248], 769.
\:\9{pdf\_page\_attr\_}{\.{\\pdfpageattr} primitive}, \[248].
\:\\{pdf\_page\_attr\_loc}, \[248], 249.
\:\\{pdf\_page\_group\_val}, \[680], 752, 769, 1637.
\:\\{pdf\_page\_height}, \[265], 644, 755, 1600.
\:\9{pdf\_page\_height\_}{\.{\\pdfpageheight} primitive}, \[266].
\:\\{pdf\_page\_height\_code}, \[265], 266.
\:\9{pdf\_page\_ref\_}{\.{\\pdfpageref} primitive}, \[494].
\:\\{pdf\_page\_ref\_code}, \[494], 495, 497, 498.
\:\\{pdf\_page\_resources}, \[248], 763.
\:\9{pdf\_page\_resources\_}{\.{\\pdfpageresources} primitive}, \[248].
\:\\{pdf\_page\_resources\_loc}, \[248], 249.
\:\\{pdf\_page\_width}, \[265], 644, 755, 1600.
\:\9{pdf\_page\_width\_}{\.{\\pdfpagewidth} primitive}, \[266].
\:\\{pdf\_page\_width\_code}, \[265], 266.
\:\\{pdf\_pagebox}, \[254], 1552.
\:\9{pdf\_pagebox\_}{\.{\\pdfpagebox} primitive}, \[256].
\:\\{pdf\_pagebox\_code}, \[254], 255, 256.
\:\\{pdf\_pages\_attr}, \[248], 803.
\:\9{pdf\_pages\_attr\_}{\.{\\pdfpagesattr} primitive}, \[248].
\:\\{pdf\_pages\_attr\_loc}, \[248], 249.
\:\\{pdf\_parent\_outline}, 789, 1563, 1628, 1629.
\:\\{pdf\_pk\_mode}, \[248], 792.
\:\9{pdf\_pk\_mode\_}{\.{\\pdfpkmode} primitive}, \[248].
\:\\{pdf\_pk\_mode\_loc}, \[248], 249.
\:\\{pdf\_pk\_resolution}, \[254], 792.
\:\9{pdf\_pk\_resolution\_}{\.{\\pdfpkresolution} primitive}, \[256].
\:\\{pdf\_pk\_resolution\_code}, \[254], 255, 256.
\:\\{pdf\_prepend\_kern}, \[254], 705, 1212.
\:\9{pdf\_prepend\_kern\_}{\.{\\pdfprependkern} primitive}, \[256].
\:\\{pdf\_prepend\_kern\_code}, \[254], 255, 256.
\:\\{pdf\_print}, 683, \[686], 692, 693, 698, 699, 702, 727, 756, 758, 766,
767, 768, 769, 771, 772, 782, 784, 790, 803, 805, 808, 813, 814, 815, 1600,
1630, 1637.
\:\\{pdf\_print\_bp}, \[690], 692, 693, 756, 1600, 1637.
\:\\{pdf\_print\_char}, \[686], 726.
\:\\{pdf\_print\_fw\_int}, \[702], 813.
\:\\{pdf\_print\_info}, 749, 794, \[807].
\:\\{pdf\_print\_int}, 683, \[686], 690, 693, 698, 699, 702, 766, 767, 769,
771, 784, 790, 795, 797, 803, 805, 808, 814, 1600, 1630, 1637.
\:\\{pdf\_print\_int\_ln}, 683, \[686], 699, 813, 815.
\:\\{pdf\_print\_ln}, 685, \[686], 692, 693, 698, 699, 727, 756, 758, 766, 767,
768, 769, 771, 772, 781, 782, 784, 786, 788, 790, 795, 797, 803, 805, 806, 807,
808, 813, 814, 815, 1600, 1630, 1637.
\:\\{pdf\_print\_mag\_bp}, \[690], 693, 769, 784, 785.
\:\\{pdf\_print\_nl}, 683, \[686], 693, 702, 814.
\:\\{pdf\_print\_octal}, \[686].
\:\\{pdf\_print\_real}, \[690], 692, 693, 758, 1637.
\:\\{pdf\_print\_rect\_spec}, 784, \[785], 786.
\:\\{pdf\_print\_resname\_prefix}, \[693], 766, 767, 1637.
\:\\{pdf\_print\_str}, \[702], 805, 1630.
\:\\{pdf\_print\_str\_ln}, \[702], 1563.
\:\\{pdf\_print\_toks}, \[727].
\:\\{pdf\_print\_toks\_ln}, \[727], 756, 763, 769, 772, 778, 781, 782, 789,
803, 804, 806, 814, 815, 1630.
\:\\{pdf\_print\_two}, \[686].
\:\\{pdf\_protrude\_chars}, \[254], 1027, 1057, 1063.
\:\9{pdf\_protrude\_chars\_}{\.{\\pdfprotrudechars} primitive}, \[256].
\:\\{pdf\_protrude\_chars\_code}, \[254], 255, 256.
\:\\{pdf\_ptex\_use\_underscore}, \[254], 673.
\:\9{pdf\_ptex\_use\_underscore}{\.{\\pdfptexuseunderscore} primitive}, \[256].
\:\\{pdf\_ptex\_use\_underscore\_code}, \[254], 255, 256.
\:\\{pdf\_ptr}, \[680], 681, 685, 686, 698, 699, 772.
\:\\{pdf\_px\_dimen}, \[265], 481, 672.
\:\9{pdf\_px\_dimen\_}{\.{\\pdfpxdimen} primitive}, \[266].
\:\\{pdf\_px\_dimen\_code}, \[265], 266.
\:\\{pdf\_quick\_out}, \[680], 686, 699, 702.
\:\\{pdf\_read\_dummy\_font}, \[693].
\:\\{pdf\_rectangle}, \[693], 781, 782.
\:\9{pdf\_refobj\_}{\.{\\pdfrefobj} primitive}, \[1524].
\:\\{pdf\_refobj\_node}, \[1524], 1526, 1528, 1546, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_refobj\_node\_size}, \[695], 1546, 1604, 1605.
\:\9{pdf\_refxform\_}{\.{\\pdfrefxform} primitive}, \[1524].
\:\\{pdf\_refxform\_node}, 1005, \[1524], 1526, 1528, 1549, 1603, 1604, 1605,
1606, 1607, 1608, 1609, 1611, 1612, 1637, 1639, 1645.
\:\\{pdf\_refxform\_node\_size}, \[695], 1549, 1604, 1605.
\:\9{pdf\_refximage\_}{\.{\\pdfrefximage} primitive}, \[1524].
\:\\{pdf\_refximage\_node}, 1005, \[1524], 1526, 1528, 1554, 1603, 1604, 1605,
1606, 1607, 1608, 1609, 1611, 1612, 1637, 1639, 1645.
\:\\{pdf\_refximage\_node\_size}, \[695], 1554, 1604, 1605.
\:\\{pdf\_resname\_prefix}, 693, \[708], 709, 792.
\:\9{pdf\_restore\_}{\.{\\pdfrestore} primitive}, \[1524].
\:\\{pdf\_restore\_node}, \[1524], 1526, 1528, 1542, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_restore\_node\_size}, \[695], 1542, 1604, 1605.
\:\\{pdf\_retval}, 450, 1544, \[1583].
\:\9{pdf\_retval\_}{\.{\\pdfretval} primitive}, \[442].
\:\\{pdf\_retval\_code}, \[442], 443, 450.
\:\\{pdf\_right}, \[695], 781, 782, 785, 1630, 1635.
\:\\{pdf\_room}, \[680], 686, 699, 702.
\:\9{pdf\_running\_link\_off\_}{\.{\\pdfrunninglinkoff} primitive}, \[1524].
\:\\{pdf\_running\_link\_off\_node}, \[1524], 1526, 1528, 1597, 1603, 1604,
1605, 1639, 1645.
\:\9{pdf\_running\_link\_on\_}{\.{\\pdfrunninglinkon} primitive}, \[1524].
\:\\{pdf\_running\_link\_on\_node}, \[1524], 1526, 1528, 1598, 1603, 1604,
1605, 1639, 1645.
\:\9{pdf\_save\_}{\.{\\pdfsave} primitive}, \[1524].
\:\\{pdf\_save\_node}, \[1524], 1526, 1528, 1541, 1603, 1604, 1605, 1639, 1645.
\:\\{pdf\_save\_node\_size}, \[695], 1541, 1604, 1605.
\:\\{pdf\_save\_offset}, \[680], 685, 813, 815.
\:\9{pdf\_save\_pos\_}{\.{\\pdfsavepos} primitive}, \[1524].
\:\\{pdf\_save\_pos\_node}, \[1524], 1526, 1528, 1576, 1603, 1604, 1605, 1620,
1639, 1645.
\:\\{pdf\_scan\_ext\_toks}, 496.
\:\\{pdf\_seek\_write\_length}, 681, 685, \[696].
\:\\{pdf\_set\_font}, \[693].
\:\\{pdf\_set\_origin}, \[692], 693.
\:\\{pdf\_set\_origin\_temp}, \[692], 693.
\:\\{pdf\_set\_rule}, \[693], 726, 734, 743.
\:\\{pdf\_set\_textmatrix}, \[692], 693.
\:\9{pdf\_setmatrix\_}{\.{\\pdfsetmatrix} primitive}, \[1524].
\:\\{pdf\_setmatrix\_data}, \[695], 727, 1540, 1603, 1604, 1605.
\:\\{pdf\_setmatrix\_node}, \[1524], 1526, 1528, 1540, 1603, 1604, 1605, 1639,
1645.
\:\\{pdf\_setmatrix\_node\_size}, \[695], 1540, 1604, 1605.
\:\9{pdf\_shell\_escape\_}{\.{\\pdfshellescape} primitive}, \[442].
\:\\{pdf\_shell\_escape\_code}, \[442], 443, 450.
\:\\{pdf\_ship\_out}, 727, 749, \[750], 775, 791, 1555, 1623, 1640.
\:\9{pdf\_snap\_ref\_point\_}{\.{\\pdfsnaprefpoint} primitive}, \[1524].
\:\\{pdf\_snap\_ref\_point\_node}, \[1524], 1526, 1528, 1572, 1603, 1604, 1605,
1639, 1645.
\:\\{pdf\_snapx\_refpos}, \[1570], 1642.
\:\9{pdf\_snapy\_}{\.{\\pdfsnapy} primitive}, \[1524].
\:\9{pdf\_snapy\_comp\_}{\.{\\pdfsnapycomp} primitive}, \[1524].
\:\\{pdf\_snapy\_comp\_node}, 1145, 1177, \[1524], 1526, 1528, 1575, 1603,
1604, 1605, 1637, 1639, 1645.
\:\\{pdf\_snapy\_node}, 1145, 1177, \[1524], 1526, 1528, 1574, 1603, 1604,
1605, 1637, 1639, 1645.
\:\\{pdf\_snapy\_refpos}, \[1570], 1637, 1642.
\:\9{pdf\_space\_font\_}{\.{\\pdfspacefont} primitive}, \[1524].
\:\\{pdf\_space\_font\_code}, \[1524], 1526, 1528.
\:\\{pdf\_space\_font\_name}, 693, 1599, \[1628], 1629.
\:\\{pdf\_special}, \[727], 1639, 1645.
\:\9{pdf\_start\_link\_}{\.{\\pdfstartlink} primitive}, \[1524].
\:\\{pdf\_start\_link\_node}, 783, \[1524], 1526, 1528, 1556, 1560, 1603, 1604,
1605, 1631, 1632, 1635, 1639, 1645.
\:\9{pdf\_start\_thread\_}{\.{\\pdfstartthread} primitive}, \[1524].
\:\\{pdf\_start\_thread\_node}, 786, \[1524], 1526, 1528, 1556, 1568, 1603,
1604, 1605, 1637, 1639, 1645.
\:\\{pdf\_str\_entry}, \[702], 1630.
\:\\{pdf\_str\_entry\_ln}, \[702], 807.
\:\9{pdf\_strcmp\_}{\.{\\pdfstrcmp} primitive}, \[494].
\:\\{pdf\_strcmp\_code}, \[494], 495, 497, 498.
\:\\{pdf\_stream\_length}, 685, \[696].
\:\\{pdf\_stream\_length\_offset}, 685, \[696].
\:\\{pdf\_suppress\_ptex\_info}, \[254], 673, 807.
\:\9{pdf\_suppress\_ptex\_info\_}{\.{\\pdfsuppressptexinfo} primitive}, \[256].
\:\\{pdf\_suppress\_ptex\_info\_code}, \[254], 255, 256.
\:\\{pdf\_suppress\_warning\_dup\_dest}, \[254], 1564.
\:\9{pdf\_suppress\_warning\_dup\_dest\_}{\.{\\pdfsuppresswarningdupdest}
primitive}, \[256].
\:\\{pdf\_suppress\_warning\_dup\_dest\_code}, \[254], 255, 256.
\:\\{pdf\_suppress\_warning\_dup\_map}, \[254], 673.
\:\9{pdf\_suppress\_warning\_dup\_map\_}{\.{\\pdfsuppresswarningdupmap}
primitive}, \[256].
\:\\{pdf\_suppress\_warning\_dup\_map\_code}, \[254], 255, 256.
\:\\{pdf\_suppress\_warning\_page\_group}, \[254], 673.
\:\9{pdf\_suppress\_warning\_page\_group\_}{\.{\\pdfsuppresswarningpagegroup}
primitive}, \[256].
\:\\{pdf\_suppress\_warning\_page\_group\_code}, \[254], 255, 256.
\:\\{pdf\_text\_procset}, \[701], 750, 753, 766, 768, 776, 777.
\:\9{pdf\_thread\_}{\.{\\pdfthread} primitive}, \[1524].
\:\\{pdf\_thread\_attr}, \[695], 1556, 1603, 1604, 1605, 1637.
\:\\{pdf\_thread\_dp}, 739, 1628, 1637.
\:\\{pdf\_thread\_ht}, \[1628], 1637.
\:\\{pdf\_thread\_id}, \[695], 1566, 1603, 1604, 1605, 1637.
\:\\{pdf\_thread\_level}, 739, \[1628], 1637.
\:\\{pdf\_thread\_margin}, \[265], 1637.
\:\9{pdf\_thread\_margin\_}{\.{\\pdfthreadmargin} primitive}, \[266].
\:\\{pdf\_thread\_margin\_code}, \[265], 266.
\:\\{pdf\_thread\_named\_id}, \[695], 1566, 1603, 1604, 1605, 1637.
\:\\{pdf\_thread\_node}, \[1524], 1526, 1528, 1556, 1567, 1603, 1604, 1605,
1639, 1645.
\:\\{pdf\_thread\_node\_size}, \[695], 1567, 1568, 1604, 1605, 1637.
\:\\{pdf\_thread\_wd}, 1628, 1637.
\:\\{pdf\_tj\_start\_h}, \[691], 692, 693.
\:\\{pdf\_toks}, \[248].
\:\\{pdf\_top}, \[695], 781, 782, 784, 785, 1630, 1635, 1637.
\:\\{pdf\_tracing\_fonts}, 192, \[254].
\:\9{pdf\_tracing\_fonts\_}{\.{\\pdftracingfonts} primitive}, \[256].
\:\\{pdf\_tracing\_fonts\_code}, \[254], 255, 256.
\:\9{pdf\_trailer\_}{\.{\\pdftrailer} primitive}, \[1524].
\:\\{pdf\_trailer\_code}, \[1524], 1526, 1528.
\:\9{pdf\_trailer\_id\_}{\.{\\pdftrailerid} primitive}, \[1524].
\:\\{pdf\_trailer\_id\_code}, \[1524], 1526, 1528.
\:\\{pdf\_trailer\_id\_toks}, 814, 815, 1582, \[1628], 1629.
\:\\{pdf\_trailer\_toks}, 814, 815, 1581, \[1628], 1629.
\:\9{pdf\_unescape\_hex\_}{\.{\\pdfunescapehex} primitive}, \[494].
\:\\{pdf\_unescape\_hex\_code}, \[494], 495, 497.
\:\\{pdf\_unique\_resname}, \[254], 792.
\:\9{pdf\_unique\_resname\_}{\.{\\pdfuniqueresname} primitive}, \[256].
\:\\{pdf\_unique\_resname\_code}, \[254], 255, 256.
\:\\{pdf\_use\_font}, \[692], 693.
\:\\{pdf\_v}, \[691], 692, 693.
\:\\{pdf\_v\_origin}, \[265], 672, 755.
\:\9{pdf\_v\_origin\_}{\.{\\pdfvorigin} primitive}, \[266].
\:\\{pdf\_v\_origin\_code}, \[265], 266.
\:\\{pdf\_version\_written}, \[680], 681, 683.
\:\\{pdf\_vlist\_node}, 738.
\:\\{pdf\_vlist\_out}, 727, 728, 733, 737, \[738], 742, 746, 751, 1555.
\:\\{pdf\_warning}, 683, \[686], 692, 705, 706, 794, 795, 797, 799, 801, 1537,
1544, 1552, 1564, 1600, 1635.
\:\\{pdf\_width}, \[695], 730, 1549, 1554, 1556, 1565, 1601, 1603, 1604, 1606,
1607, 1608, 1609, 1630, 1635, 1636, 1637, 1646, 1647.
\:\\{pdf\_write\_image}, \[778], 779, 1623.
\:\\{pdf\_write\_obj}, \[772], 773, 1623.
\:\\{pdf\_x}, \[691], 693, 784, 785, 1637.
\:\9{pdf\_xform\_}{\.{\\pdfxform} primitive}, \[1524].
\:\\{pdf\_xform\_code}, \[1524], 1526, 1528, 1623.
\:\\{pdf\_xform\_count}, 1504, 1505, 1548, \[1628], 1629.
\:\\{pdf\_xform\_depth}, 752, 756, \[1628], 1641.
\:\\{pdf\_xform\_height}, 752, 756, \[1628], 1641.
\:\\{pdf\_xform\_list}, 750, 753, 764, 767, 775, 776, 777, \[1628], 1637.
\:\9{pdf\_xform\_name\_}{\.{\\pdfxformname} primitive}, \[494].
\:\\{pdf\_xform\_name\_code}, \[494], 495, 497, 498.
\:\\{pdf\_xform\_objnum}, \[695], 1549, 1603, 1637.
\:\\{pdf\_xform\_width}, 752, 756, \[1628].
\:\9{pdf\_ximage\_}{\.{\\pdfximage} primitive}, \[1524].
\:\9{pdf\_ximage\_bbox\_}{\.{\\pdfximagebbox} primitive}, \[494].
\:\\{pdf\_ximage\_bbox\_code}, \[494], 495, 497, 498.
\:\\{pdf\_ximage\_code}, \[1524], 1526, 1528, 1623.
\:\\{pdf\_ximage\_count}, 1504, 1505, 1552, \[1628], 1629.
\:\\{pdf\_ximage\_list}, 750, 753, 764, 767, 775, 776, 777, 779, \[1628], 1637.
\:\\{pdf\_ximage\_objnum}, \[695], 1554, 1603, 1637.
\:\\{pdf\_y}, \[691], 693, 784, 785, 1637.
\:\\{pdfassert}, 692, 693, 705, 712, 725, 730, 801, 825, 1635, 1636.
\:\\{pdfdraftmode}, 748.
\:\\{pdfmapfile}, 1590.
\:\\{pdfmapline}, 1591.
\:\\{pdfmaplinesp}, 693.
\:\\{pdfmem\_bead\_size}, \[695], 1637.
\:\\{pdfmem\_obj\_size}, \[695], 1544.
\:\\{pdfmem\_outline\_size}, \[695], 1563.
\:\\{pdfmem\_xform\_size}, \[695], 1548.
\:\\{pdfmem\_ximage\_size}, \[695], 1552.
\:\\{pdfoutput}, 747.
\:\\{pdfpagegroupval}, 761.
\:\9{pdfprimitive\_}{\.{\\pdfprimitive} primitive}, \[287].
\:\9{pdfprimitive\_}{\.{\\pdfprimitive} primitive (internalized)}, \[394].
\:\\{pdfsetmatrix}, 727.
\:\\{pdfshipoutbegin}, 757.
\:\\{pdfshipoutend}, 760.
\:\\{PDFTEX}, 2.
\:\\{pdfTeX\_banner}, \[2].
\:\\{pdftex\_banner}, 498, 807, \[811].
\:\9{pdftex\_banner\_}{\.{\\pdftexbanner} primitive}, \[494].
\:\\{pdftex\_banner\_code}, \[494], 495, 497, 498.
\:\\{pdftex\_convert\_codes}, \[494].
\:\\{pdftex\_first\_dimen\_code}, \[265].
\:\\{pdftex\_first\_expand\_code}, \[494].
\:\\{pdftex\_first\_extension\_code}, \[1524], 1620.
\:\\{pdftex\_first\_integer\_code}, \[254].
\:\\{pdftex\_first\_loc}, \[248].
\:\\{pdftex\_first\_rint\_code}, \[442].
\:\\{pdftex\_last\_dimen\_code}, \[265].
\:\\{pdftex\_last\_extension\_code}, \[1524], 1620.
\:\\{pdftex\_last\_item\_codes}, \[442].
\:\\{pdftex\_revision}, \[2], 498, 808.
\:\9{pdftex\_revision\_}{\.{\\pdftexrevision} primitive}, \[494].
\:\\{pdftex\_revision\_code}, \[494], 495, 497, 498.
\:\\{pdftex\_version}, \[2], 450, 808.
\:\9{pdftex\_version\_}{\.{\\pdftexversion} primitive}, \[442].
\:\\{pdftex\_version\_code}, \[442], 443, 450.
\:\\{pdftex\_version\_string}, \[2].
\:\\{pen}, \[902], 937, 943, \[1053], 1067.
\:{penalties}, 1280.
\:\\{penalties}, \[902], 943.
\:\\{penalty}, \[175], 176, 212, 251, 450, 992, 1042, 1067, 1150, 1173, 1177,
1187, 1188, 1190, 1866.
\:\9{penalty\_}{\.{\\penalty} primitive}, \[287].
\:\\{penalty\_node}, \[175], 176, 201, 220, 224, 450, 674, 906, 937, 943, 992,
993, 1005, 1013, 1032, 1042, 1055, 1076, 1145, 1150, 1173, 1177, 1187, 1188,
1190, 1285.
\:\\{pg\_field}, \[230], 231, 236, 237, 448, 1422.
\:\\{pi}, \[1005], 1007, 1027, 1032, 1035, \[1147], 1149, 1150, 1151, \[1171],
1177, 1182, 1183.
\:\\{pk\_dpi}, 792, \[1628].
\:\\{pk\_scale\_factor}, \[691], 792.
\:\.{plain}, 547, 550, 1511.
\:{Plass, Michael Frederick}, 2, 989.
\:\.{Please type...}, 382, 556.
\:\.{Please use \\mathaccent...}, 1344.
\:\.{PLtoTF}, 587.
\:\.{plus}, 488.
\:\\{point\_token}, \[464], 466, 474, 478.
\:\\{pointer}, \[133], 134, 136, 138, 141, 142, 143, 148, 149, 154, 157, 162,
163, 165, 169, 170, 171, 172, 174, 176, 183, 185, 190, 216, 218, 219, 220, 222,
230, 231, 236, 270, 274, 275, 278, 281, 285, 297, 298, 299, 300, 301, 303, 306,
317, 319, 321, 327, 328, 330, 345, 347, 355, 358, 388, 408, 414, 415, 433, 439,
476, 487, 489, 490, 491, 496, 499, 508, 515, 523, 524, 575, 586, 609, 619, 632,
634, 642, 647, 657, 666, 673, 680, 686, 693, 699, 700, 705, 706, 708, 727, 729,
738, 750, 772, 785, 791, 819, 821, 823, 829, 844, 855, 862, 864, 865, 867, 868,
880, 881, 882, 885, 887, 891, 892, 893, 895, 896, 898, 902, 910, 911, 912, 913,
914, 919, 925, 928, 932, 938, 946, 948, 950, 963, 967, 975, 976, 990, 997, 999,
1002, 1004, 1005, 1006, 1009, 1038, 1048, 1053, 1069, 1077, 1078, 1083, 1084,
1089, 1103, 1111, 1145, 1147, 1154, 1157, 1159, 1170, 1171, 1189, 1207, 1209,
1221, 1242, 1246, 1252, 1253, 1257, 1264, 1271, 1279, 1283, 1288, 1291, 1295,
1297, 1301, 1316, 1329, 1333, 1338, 1352, 1354, 1362, 1369, 1372, 1376, 1389,
1414, 1425, 1435, 1466, 1471, 1480, 1481, 1525, 1528, 1529, 1537, 1545, 1550,
1556, 1562, 1573, 1577, 1600, 1602, 1615, 1617, 1620, 1628, 1630, 1632, 1635,
1636, 1637, 1683, 1705, 1719, 1723, 1733, 1738, 1741, 1744, 1750, 1753, 1756,
1757, 1773, 1777, 1782, 1815, 1816, 1819, 1821, 1822, 1823, 1825, 1835, 1837,
1838, 1839, 1840, 1841, 1842, 1859.
\:\\{pointer\_node\_size}, \[1820], 1821, 1837, 1841.
\:{Poirot, Hercule}, 1461.
\:\\{pool\_file}, 47, \[50], 51, 52, 53.
\:\\{pool\_name}, \[11], 51.
\:\\{pool\_pointer}, \[38], 39, 45, 46, 59, 60, 69, 70, 286, 433, 490, 491,
496, 539, 545, 629, 666, 686, 693, 702, 706, 749, 750, 793, 1106, 1111, 1537,
1587, 1615, 1753.
\:\\{pool\_ptr}, 38, \[39], 41, 42, 43, 44, 47, 52, 58, 70, 216, 279, 490, 491,
496, 497, 542, 551, 645, 686, 727, 1487, 1488, 1512, 1514, 1519, 1615, 1688,
1754.
\:\\{pool\_size}, \[11], 38, 42, 52, 58, 216, 551, 686, 727, 1488, 1514, 1519,
1615.
\:\\{pop}, 611, 612, \[613], 617, 628, 635, 670, 719, 726.
\:\\{pop\_alignment}, \[948], 976.
\:\\{pop\_input}, \[344], 346, 351.
\:\\{pop\_lig\_stack}, \[1087], 1088.
\:\\{pop\_link\_level}, \[1635].
\:\\{pop\_LR}, \[1705], 1708, 1711, 1712, 1717, 1718, 1728, 1735, 1737, 1739.
\:\\{pop\_nest}, \[235], 972, 975, 988, 992, 1203, 1264, 1274, 1278, 1297,
1346, 1362, 1384, 1732.
\:\\{pop\_node}, \[1005].
\:\\{pop\_packet\_state}, 725.
\:\\{positive}, \[107], \[689].
\:\\{post}, 610, 612, \[613], 617, 618, 670, 712.
\:\\{post\_break}, \[163], 193, 213, 220, 224, 674, 823, 1005, 1016, 1034,
1058, 1060, 1093, 1217, 1297.
\:\\{post\_disc\_break}, \[1053], 1057, 1060.
\:\\{post\_display\_penalty}, \[254], 1383, 1384.
\:\9{post\_display\_penalty\_}{\.{\\postdisplaypenalty} primitive}, \[256].
\:\\{post\_display\_penalty\_code}, \[254], 255, 256.
\:\\{post\_line\_break}, 1052, \[1053], 1705.
\:\\{post\_post}, 612, \[613], 617, 618, 670.
\:\\{pre}, 610, 612, \[613], 645, 714.
\:\\{pre\_adjust\_head}, \[180], 1065, 1066, 1254, 1263, 1377, 1383.
\:\\{pre\_adjust\_tail}, 823, 825, \[829], 830, 831, 972, 1065, 1066, 1254,
1263, 1377.
\:\\{pre\_break}, \[163], 193, 213, 220, 224, 674, 823, 1005, 1034, 1045, 1057,
1058, 1061, 1092, 1217, 1295, 1297.
\:\\{pre\_display\_direction}, \[254], 1316, 1377, 1744.
\:\9{pre\_display\_direction\_}{\.{\\predisplaydirection} primitive}, \[1657].
\:\\{pre\_display\_direction\_code}, \[254], 1323, 1657, 1659.
\:\\{pre\_display\_penalty}, \[254], 1381, 1384.
\:\9{pre\_display\_penalty\_}{\.{\\predisplaypenalty} primitive}, \[256].
\:\\{pre\_display\_penalty\_code}, \[254], 255, 256.
\:\\{pre\_display\_size}, \[265], 1316, 1323, 1326, 1381, 1733.
\:\9{pre\_display\_size\_}{\.{\\predisplaysize} primitive}, \[266].
\:\\{pre\_display\_size\_code}, \[265], 266, 1323.
\:\\{pre\_kern}, 1295.
\:\\{pre\_t}, \[1376], 1377, 1383.
\:{preamble}, 944, 950.
\:\\{preamble}, \[946], 947, 948, 953, 962, 977, 980.
\:{preamble of \.{DVI} file}, 645.
\:\\{precedes\_break}, \[166], 1044, 1150, 1177.
\:\\{prefix}, \[227], 1386, 1387, 1388, 1389, 1770.
\:\\{prefixed\_command}, 1388, \[1389], 1448.
\:\\{prepare\_mag}, \[310], 483, 645, 670, 690, 693, 752, 758, 792, 1513.
\:\\{prepend\_nl}, 686.
\:\\{pretolerance}, \[254], 1004, 1039.
\:\9{pretolerance\_}{\.{\\pretolerance} primitive}, \[256].
\:\\{pretolerance\_code}, \[254], 255, 256.
\:\\{prev\_active\_width}, \[999].
\:\\{prev\_auto\_breaking}, \[999].
\:\\{prev\_break}, \[997], 1021, 1022, 1053, 1054.
\:\\{prev\_char\_p}, 823, 825, 828, \[999], 1003, 1017, 1018, 1039, 1042, 1043,
1046, 1047.
\:\\{prev\_depth}, 230, \[231], 233, 444, 855, 951, 962, 963, 1202, 1234, 1261,
1277, 1345, 1384, 1420, 1421, 1481.
\:\9{prev\_depth\_}{\.{\\prevdepth} primitive}, \[442].
\:\\{prev\_dp}, \[1147], 1149, 1150, 1151, 1153, 1612.
\:\\{prev\_graf}, 230, \[231], 233, 234, 448, 990, 992, 1040, 1053, 1065, 1067,
1269, 1327, 1378, 1420.
\:\9{prev\_graf\_}{\.{\\prevgraf} primitive}, \[287].
\:\\{prev\_legal}, \[999], 1039.
\:\\{prev\_p}, \[647], 648, 650, \[729], 731, 732, \[999], 1005, 1038, 1039,
1042, 1043, 1044, 1045, \[1145], 1146, \[1147], 1150, \[1189], 1191, 1194,
1199, 1721, 1722.
\:\\{prev\_prev\_legal}, \[999].
\:\\{prev\_prev\_r}, \[1006], 1008, 1019, 1020, 1036.
\:\\{prev\_r}, \[1005], 1006, 1008, 1019, 1020, 1021, 1027, 1030, 1036.
\:\\{prev\_rightmost}, 498, 1005, 1057, \[1545].
\:\\{prev\_s}, \[1038], 1071, 1073.
\:\\{prev\_tail}, \[231], 232, 1217.
\:\\{prim}, \[275], 276, 282, 1496, 1497.
\:\\{prim\_base}, \[275], 281.
\:\\{prim\_eq\_level}, \[275], 286.
\:\\{prim\_eq\_level\_field}, \[275].
\:\\{prim\_eq\_type}, \[275], 286, 394, 395, 527, 1223.
\:\\{prim\_eq\_type\_field}, \[275].
\:\\{prim\_eqtb}, 286.
\:\\{prim\_eqtb\_base}, \[240], 275, 284, 285, 395, 1223.
\:\\{prim\_equiv}, \[275], 286, 394, 395, 527, 1223.
\:\\{prim\_equiv\_field}, \[275].
\:\\{prim\_is\_full}, \[275], 282.
\:\\{prim\_lookup}, \[281], 286, 394, 395, 527, 1223.
\:\\{prim\_next}, \[275], 276, 281, 282.
\:\\{prim\_prime}, \[275], 281, 283.
\:\\{prim\_size}, \[240], 275, 276, 277, 282, 283, 1496, 1497.
\:\\{prim\_text}, \[275], 276, 281, 282, 284, 285.
\:\\{prim\_used}, \[275], 277, 282.
\:\\{prim\_val}, \[286].
\:\\{primitive}, 244, 248, 256, 266, \[286], 287, 288, 320, 356, 402, 410, 437,
442, 494, 513, 517, 579, 956, 1160, 1230, 1236, 1249, 1266, 1285, 1292, 1319,
1334, 1347, 1356, 1366, 1386, 1397, 1400, 1408, 1428, 1432, 1440, 1450, 1455,
1464, 1469, 1511, 1512, 1524, 1649, 1657, 1663, 1666, 1669, 1672, 1675, 1684,
1686, 1689, 1692, 1697, 1701, 1747, 1759, 1762, 1770, 1778, 1801, 1805, 1809,
1861, 1864.
\:\\{primitive\_size}, 275.
\:\\{print}, 54, \[59], 60, 62, 63, 68, 70, 71, 73, 84, 85, 86, 89, 91, 94, 95,
121, 192, 193, 195, 196, 200, 201, 202, 203, 204, 205, 206, 208, 209, 210, 211,
213, 215, 229, 236, 237, 243, 251, 252, 255, 265, 269, 284, 285, 306, 310, 316,
320, 321, 328, 339, 340, 345, 358, 360, 361, 385, 399, 421, 422, 424, 426, 454,
480, 482, 485, 491, 498, 528, 535, 556, 560, 562, 587, 593, 606, 608, 645, 666,
667, 670, 674, 686, 693, 705, 706, 712, 714, 717, 727, 750, 772, 794, 795, 797,
799, 801, 836, 839, 842, 850, 851, 853, 868, 870, 873, 899, 952, 1005, 1022,
1032, 1113, 1145, 1155, 1162, 1163, 1164, 1177, 1183, 1188, 1192, 1201, 1227,
1242, 1273, 1310, 1344, 1391, 1410, 1415, 1435, 1437, 1439, 1473, 1474, 1476,
1487, 1489, 1496, 1498, 1500, 1502, 1504, 1508, 1514, 1515, 1518, 1519, 1526,
1564, 1600, 1601, 1603, 1661, 1662, 1679, 1680, 1681, 1691, 1704, 1713, 1755,
1765, 1774, 1776, 1777, 1823, 1852.
\:\\{print\_ASCII}, \[68], 192, 194, 320, 608, 674, 867, 899.
\:\\{print\_char}, \[58], 59, 60, 64, 65, 66, 67, 69, 70, 82, 91, 94, 95, 103,
132, 189, 190, 192, 193, 194, 195, 196, 202, 204, 205, 206, 207, 208, 209, 210,
211, 214, 236, 237, 241, 247, 251, 252, 253, 260, 269, 270, 273, 284, 288, 306,
307, 316, 318, 321, 328, 335, 339, 384, 411, 498, 535, 562, 563, 587, 608, 645,
666, 667, 670, 674, 750, 794, 867, 899, 1022, 1032, 1110, 1183, 1188, 1243,
1247, 1390, 1391, 1458, 1472, 1473, 1474, 1489, 1498, 1500, 1502, 1508, 1513,
1515, 1520, 1601, 1602, 1603, 1661, 1662, 1679, 1680, 1681, 1730, 1755, 1765,
1823.
\:\\{print\_cmd\_chr}, 241, 251, 288, 318, \[320], 321, 345, 358, 444, 454,
529, 536, 1227, 1244, 1306, 1390, 1391, 1415, 1515, 1519, 1656, 1679, 1681,
1691, 1765, 1769, 1776, 1777, 1823.
\:\\{print\_creation\_date}, 809.
\:\\{print\_cs}, \[284], 315, 336, 427.
\:\\{print\_current\_string}, \[70], 200, 868.
\:\\{print\_delimiter}, \[867], 872, 873.
\:\\{print\_err}, 72, \[73], 93, 94, 95, 98, 121, 310, 358, 360, 368, 396, 399,
421, 422, 424, 429, 434, 441, 444, 454, 459, 460, 461, 462, 463, 468, 471, 472,
480, 482, 485, 486, 497, 501, 502, 505, 512, 526, 529, 536, 556, 587, 604, 606,
669, 683, 686, 899, 952, 959, 960, 968, 1002, 1113, 1114, 1137, 1138, 1139,
1140, 1153, 1155, 1170, 1181, 1186, 1192, 1201, 1204, 1205, 1225, 1227, 1242,
1244, 1246, 1247, 1256, 1260, 1262, 1273, 1277, 1288, 1298, 1299, 1305, 1306,
1307, 1310, 1313, 1337, 1339, 1344, 1355, 1361, 1370, 1373, 1375, 1385, 1390,
1391, 1393, 1403, 1410, 1414, 1415, 1419, 1421, 1422, 1430, 1436, 1437, 1461,
1476, 1482, 1513, 1539, 1619, 1656, 1696, 1765, 1769, 1782, 1784, 1811.
\:\\{print\_esc}, \[63], 86, 192, 194, 201, 202, 205, 206, 207, 208, 209, 210,
212, 213, 214, 215, 243, 245, 247, 249, 251, 252, 253, 255, 257, 260, 265, 267,
269, 284, 285, 288, 314, 315, 316, 345, 357, 399, 403, 411, 443, 454, 495, 512,
514, 518, 526, 606, 867, 870, 871, 872, 873, 875, 952, 957, 968, 1032, 1113,
1137, 1138, 1155, 1161, 1163, 1186, 1192, 1205, 1231, 1237, 1243, 1247, 1250,
1267, 1273, 1277, 1286, 1293, 1298, 1307, 1310, 1313, 1321, 1335, 1344, 1357,
1367, 1370, 1387, 1391, 1398, 1401, 1409, 1419, 1422, 1429, 1433, 1441, 1451,
1456, 1465, 1470, 1473, 1500, 1515, 1526, 1602, 1603, 1650, 1658, 1659, 1664,
1667, 1670, 1673, 1676, 1679, 1681, 1685, 1687, 1690, 1691, 1693, 1698, 1700,
1702, 1748, 1760, 1763, 1764, 1765, 1771, 1777, 1779, 1802, 1806, 1823, 1832,
1833, 1862, 1865.
\:\\{print\_fam\_and\_char}, \[867], 868, 872.
\:\\{print\_file\_name}, \[544], 556, 587, 794, 1500, 1603.
\:\\{print\_font\_and\_char}, \[194], 201, 211.
\:\\{print\_font\_identifier}, \[192], 194, 674, 801.
\:\\{print\_glue}, \[195], 196, 203, 204.
\:\\{print\_group}, \[1661], 1662, 1679, 1774, 1777.
\:\\{print\_hex}, \[67], 867, 1401.
\:\\{print\_ID}, 814, 815.
\:\\{print\_ID\_alt}, 814, 815.
\:\\{print\_if\_line}, 321, \[1691], 1776, 1777.
\:\\{print\_int}, \[65], 84, 91, 94, 103, 132, 186, 187, 188, 189, 190, 192,
203, 206, 212, 213, 214, 236, 237, 245, 247, 249, 251, 252, 253, 257, 260, 267,
269, 273, 307, 310, 321, 335, 358, 426, 491, 498, 535, 562, 587, 606, 645, 666,
667, 670, 705, 706, 727, 750, 794, 795, 797, 799, 836, 839, 843, 850, 851, 854,
867, 899, 1022, 1032, 1110, 1163, 1183, 1186, 1188, 1201, 1205, 1277, 1410,
1474, 1487, 1489, 1496, 1498, 1502, 1504, 1508, 1515, 1519, 1539, 1564, 1600,
1602, 1603, 1637, 1661, 1679, 1681, 1691, 1713, 1822, 1823.
\:\\{print\_length\_param}, \[265], 267, 269.
\:\\{print\_ln}, \[57], 58, 59, 61, 62, 71, 86, 89, 90, 132, 200, 216, 236,
254, 263, 318, 328, 336, 339, 352, 382, 385, 427, 510, 560, 563, 666, 667, 683,
686, 693, 750, 795, 797, 799, 801, 836, 839, 842, 843, 850, 851, 853, 854, 868,
1005, 1027, 1057, 1145, 1163, 1443, 1458, 1487, 1489, 1496, 1498, 1502, 1504,
1520, 1564, 1600, 1617, 1679, 1691, 1713, 1730, 1755, 1774, 1776, 1777.
\:\\{print\_locs}, \[185].
\:\\{print\_mark}, \[194], 214, 1564, 1603.
\:\\{print\_meaning}, \[318], 498, 1472.
\:\\{print\_mod\_date}, 810.
\:\\{print\_mode}, \[229], 236, 321, 1227.
\:\\{print\_nl}, \[62], 73, 82, 84, 85, 90, 186, 187, 188, 189, 190, 236, 237,
263, 273, 307, 310, 321, 328, 333, 335, 336, 345, 382, 426, 556, 560, 608, 666,
667, 669, 670, 693, 712, 714, 717, 727, 750, 772, 794, 836, 842, 843, 850, 853,
854, 1022, 1032, 1033, 1039, 1110, 1163, 1164, 1169, 1183, 1188, 1299, 1472,
1474, 1475, 1500, 1502, 1508, 1513, 1515, 1518, 1617, 1637, 1679, 1691, 1713,
1774, 1776, 1777.
\:\\{print\_param}, \[255], 257, 260.
\:\\{print\_plus}, \[1162].
\:\\{print\_plus\_end}, \[1162].
\:\\{print\_roman\_int}, \[69], 498.
\:\\{print\_rule\_dimen}, \[194], 205, 1601, 1603.
\:\\{print\_sa\_num}, \[1822], 1823, 1832, 1833.
\:\\{print\_scaled}, \[103], 121, 132, 192, 194, 195, 196, 201, 202, 206, 209,
210, 237, 269, 491, 498, 587, 842, 853, 873, 1162, 1163, 1164, 1183, 1188,
1437, 1439, 1500, 1603, 1637, 1680, 1681, 1823, 1852.
\:\\{print\_size}, \[875], 899, 1409.
\:\\{print\_skip\_param}, 207, \[243], 245, 247.
\:\\{print\_spec}, \[196], 206, 207, 208, 247, 491, 1603, 1637, 1823.
\:\\{print\_style}, 866, \[870], 1348.
\:\\{print\_subsidiary\_data}, \[868], 872, 873.
\:\\{print\_the\_digs}, \[64], 65, 67.
\:\\{print\_totals}, 236, \[1162], 1163, 1183.
\:\\{print\_two}, \[66], 562, 645.
\:\\{print\_word}, \[132], 1519.
\:\\{print\_write\_whatsit}, \[1602], 1603.
\:\\{printed\_node}, \[997], 1032, 1033, 1034, 1040.
\:\\{privileged}, \[1229], 1232, 1308, 1318.
\:\\{Producer}, 807.
\:\\{producer\_given}, 807.
\:\\{prompt\_file\_name}, \[556], 558, 561, 563, 684, 1508, 1622.
\:\\{prompt\_input}, \[71], 83, 87, 382, 385, 510, 556.
\:\\{protected}, 1770.
\:\9{protected\_}{\.{\\protected} primitive}, \[1770].
\:\\{protected\_token}, \[311], 415, 504, 1391, 1473, 1772.
\:\\{prune\_movements}, \[642], 647, 657.
\:\\{prune\_page\_top}, \[1145], 1154, 1198.
\:\\{pseudo}, \[54], 57, 58, 59, 338.
\:\\{pseudo\_close}, 351, \[1757], 1758.
\:\\{pseudo\_files}, \[1750], 1751, 1754, 1756, 1757, 1758.
\:\\{pseudo\_input}, 384, \[1756].
\:\\{pseudo\_start}, 1749, 1752, \[1753].
\:\\{pstack}, \[414], 416, 422, 426.
\:\.{pt}, 479.
\:\\{ptmp}, 1053, 1057.
\:\\{punct\_noad}, \[858], 866, 872, 874, 904, 928, 937, 1334, 1335.
\:\\{push}, 611, 612, \[613], 617, 619, 628, 635, 643, 647, 657, 719, 721, 726.
\:\\{push\_alignment}, \[948], 950.
\:\\{push\_input}, \[343], 345, 347, 350.
\:\\{push\_link\_level}, \[1635].
\:\\{push\_LR}, \[1705], 1708, 1711, 1717, 1728, 1737, 1739.
\:\\{push\_math}, \[1314], 1317, 1323, 1331, 1350, 1352, 1369.
\:\\{push\_nest}, \[234], 950, 962, 963, 1202, 1261, 1269, 1277, 1295, 1297,
1314, 1345, 1378.
\:\\{push\_node}, \[1005].
\:\\{push\_packet\_state}, 725.
\:\\{put}, 26, 29, 1483.
\:\\{put\_LR}, \[1705], 1710.
\:\\{put\_rule}, 612, \[613], 661, 719, 726.
\:\\{put\_sa\_ptr}, \[1819], 1831.
\:\\{put1}, \[612], \[710], 719, 726.
\:\\{put2}, \[612].
\:\\{put3}, \[612].
\:\\{put4}, \[612].
\:\.{px}, 481.
\:\|{q}, \[112], \[114], \[122], \[141], \[143], \[148], \[149], \[162], %
\[169], \[170], \[171], \[185], \[190], \[220], \[222], \[236], \[297], \[314],
\[337], \[358], \[388], \[415], \[433], \[439], \[476], \[487], \[489], \[490],
\[491], \[499], \[508], \[523], \[524], \[634], \[689], \[700], \[727], \[823],
\[881], \[882], \[885], \[888], \[896], \[902], \[910], \[911], \[912], \[913],
\[914], \[919], \[925], \[928], \[932], \[938], \[967], \[976], \[1002], %
\[1006], \[1038], \[1053], \[1078], \[1083], \[1111], \[1125], \[1130], %
\[1134], \[1136], \[1137], \[1145], \[1147], \[1171], \[1189], \[1221], %
\[1246], \[1257], \[1271], \[1283], \[1297], \[1301], \[1316], \[1362], %
\[1369], \[1376], \[1389], \[1414], \[1480], \[1481], \[1528], \[1615], %
\[1617], \[1637], \[1683], \[1723], \[1738], \[1744], \[1753], \[1757], %
\[1782], \[1815], \[1819], \[1821], \[1822], \[1825], \[1837].
\:\\{qi}, \[130], 498, 571, 575, 590, 596, 600, 603, 609, 643, 648, 823, 929,
1084, 1085, 1088, 1090, 1100, 1135, 1136, 1158, 1185, 1186, 1211, 1212, 1215,
1216, 1218, 1278, 1329, 1333, 1338, 1343, 1487, 1503, 1671, 1754, 1769, 1856,
1858.
\:\\{qo}, \[130], 177, 192, 194, 203, 206, 580, 596, 603, 629, 643, 648, 674,
823, 867, 884, 898, 899, 917, 928, 931, 1073, 1074, 1075, 1080, 1086, 1100,
1122, 1158, 1163, 1185, 1195, 1198, 1216, 1488, 1502, 1503, 1661, 1858.
\:\\{qqqq}, 128, \[131], 132, 576, 580, 595, 600, 601, 710, 823, 859, 889, 917,
928, 1086, 1216, 1359, 1483, 1484, 1754, 1756.
\:\\{quad}, 573, \[584], 673, 705, 706, 823, 1734.
\:\\{quad\_code}, \[573], 584.
\:\\{quarterword}, 128, \[131], 162, 271, 286, 293, 298, 299, 301, 303, 320,
322, 345, 619, 857, 882, 885, 887, 888, 900, 914, 925, 1053, 1098, 1120, 1121,
1124, 1137, 1239, 1257, 1283, 1656, 1679, 1777, 1815, 1835, 1837.
\:\9{quit\_vmode\_}{\.{\\quitvmode} primitive}, \[1266].
\:\\{quotient}, 1796, \[1797].
\:\\{qw}, \[586], 590, 596, 600, 603.
\:\|{r}, \[108], \[122], \[141], \[143], \[149], \[222], \[236], \[388], %
\[415], \[439], \[491], \[508], \[524], \[727], \[823], \[844], \[882], \[896],
\[902], \[928], \[967], \[976], \[1005], \[1038], \[1053], \[1078], \[1130], %
\[1143], \[1145], \[1147], \[1171], \[1189], \[1257], \[1283], \[1301], %
\[1338], \[1376], \[1414], \[1528], \[1555], \[1615], \[1617], \[1733], %
\[1744], \[1753], \[1756], \[1782], \[1799].
\:\\{R\_code}, \[165], 210, 1717, 1731.
\:\\{r\_count}, \[1089], 1091, 1095.
\:\\{r\_hyf}, 1068, \[1069], 1071, 1076, 1079, 1100, 1609, 1610.
\:\\{r\_type}, \[902], 903, 904, 905, 936, 942, 943.
\:\\{radical}, \[226], 287, 288, 1224, 1340.
\:\9{radical\_}{\.{\\radical} primitive}, \[287].
\:\\{radical\_noad}, \[859], 866, 872, 874, 909, 937, 1341.
\:\\{radical\_noad\_size}, \[859], 874, 937, 1341.
\:\\{radix}, 388, \[464], 465, 466, 470, 471, 474.
\:\\{radix\_backup}, \[388].
\:\9{raise\_}{\.{\\raise} primitive}, \[1249].
\:{Ramshaw, Lyle Harold}, 565.
\:\\{random\_seed}, \[110], 450, 1517, 1585.
\:\9{random\_seed\_}{\.{\\pdfrandomseed} primitive}, \[442].
\:\\{random\_seed\_code}, \[442], 443, 450.
\:\\{randoms}, \[110], 124, 125, 126, 127.
\:\\{rbrace\_ptr}, \[415], 425, 426.
\:\\{rc}, 823.
\:\\{read}, 52, 53, 1518, 1519.
\:\9{read\_}{\.{\\read} primitive}, \[287].
\:\\{read\_expand\_font}, \[705], 1535.
\:\\{read\_file}, \[506], 511, 512, 1453.
\:\\{read\_font\_info}, \[586], 590, 693, 705, 706, 712, 1218, 1435.
\:\\{read\_image}, 1552.
\:\9{read\_line\_}{\.{\\readline} primitive}, \[1759].
\:\\{read\_ln}, 52.
\:\\{read\_open}, \[506], 507, 509, 511, 512, 527, 1453.
\:\\{read\_sixteen}, \[590], 591, 594.
\:\\{read\_to\_cs}, \[227], 287, 288, 1388, 1403, 1759.
\:\\{read\_toks}, 325, \[508], 1403.
\:\\{ready\_already}, \[1511], 1512.
\:\\{real}, 3, 109, 128, 200, 204, 647, 657, 729, 738, 1301, 1303, 1637, 1723.
\:{real addition}, 1303.
\:{real division}, 834, 840, 849, 852, 986, 987, 1301, 1303.
\:{real multiplication}, 132, 204, 653, 662, 735, 744, 985, 1303, 1638.
\:\\{real\_font\_type}, \[703], 712.
\:\\{rebox}, \[891], 920, 926.
\:\\{reconstitute}, 1082, \[1083], 1090, 1092, 1093, 1094, 1209.
\:{recursion}, 76, 78, 191, 198, 216, 220, 221, 388, 428, 433, 524, 553, 619,
646, 868, 895, 896, 901, 930, 1126, 1134, 1136, 1513, 1623, 1682.
\:\\{ref\_count}, \[415], 416, 427.
\:\\{ref\_link\_node}, 1632, 1635, 1636.
\:{reference counts}, 168, 218, 219, 221, 297, 313, 329, 1820, 1821.
\:\\{reflected}, \[643], 1722, 1738.
\:\\{register}, \[227], 437, 438, 439, 1388, 1399, 1402, 1413, 1414, 1415,
1823, 1832, 1834.
\:\\{rejected\_cur\_p}, \[999], 1039.
\:\\{rel\_noad}, \[858], 866, 872, 874, 904, 937, 943, 1334, 1335.
\:\\{rel\_penalty}, \[254], 858, 937.
\:\9{rel\_penalty\_}{\.{\\relpenalty} primitive}, \[256].
\:\\{rel\_penalty\_code}, \[254], 255, 256.
\:\\{relax}, \[225], 287, 288, 380, 395, 398, 430, 504, 532, 1223, 1402, 1784.
\:\9{relax\_}{\.{\\relax} primitive}, \[287].
\:\\{rem\_byte}, \[571], 580, 583, 596, 884, 889, 916, 925, 929, 1088, 1218.
\:\\{remainder}, \[104], 106, 107, 483, 484, \[569], 570, 571, 892, 893.
\:\\{remove\_item}, \[226], 1282, 1285, 1286.
\:\\{remove\_last\_space}, \[686], 790, 803, 805.
\:\\{remove\_pdffile}, 1513.
\:\\{rep}, \[572].
\:\\{replace\_count}, \[163], 193, 213, 674, 1005, 1016, 1034, 1045, 1058,
1059, 1095, 1217, 1258, 1298.
\:\\{report\_illegal\_case}, 1223, \[1228], 1229, 1421, 1625.
\:\\{reset}, 26, 27, 33.
\:\\{reset\_disc\_width}, \[1015], 1045.
\:\\{reset\_OK}, \[27].
\:\9{reset\_timer\_}{\.{\\pdfresettimer} primitive}, \[1524].
\:\\{reset\_timer\_code}, \[1524], 1526, 1528.
\:\\{restart}, \[15], 143, 144, 286, 363, 368, 379, 381, 382, 384, 395, 406,
439, 466, 928, 929, 958, 961, 965, 1329, 1393, 1782, 1783, 1788.
\:\\{restore\_active\_width}, \[999].
\:\\{restore\_cur\_string}, \[496], 497.
\:\\{restore\_old\_value}, \[290], 298, 304.
\:\\{restore\_sa}, \[290], 304, 1837.
\:\\{restore\_trace}, 299, 305, \[306], 1823.
\:\\{restore\_zero}, \[290], 298, 300.
\:\\{restrictedshell}, 450.
\:\\{result}, \[45], \[46].
\:\\{resume\_after\_display}, 976, 1377, \[1378], 1384.
\:\\{reswitch}, \[15], 363, 365, 374, 388, 394, 489, 647, 648, 729, 731, 823,
825, 826, 902, 904, 1111, 1112, 1206, 1207, 1213, 1223, 1316, 1325, 1329, 1552,
1722, 1723, 1724, 1727, 1765.
\:\&{return}, 15, \[16].
\:\\{return\_sign}, \[122], 123.
\:\\{reverse}, 3, 1721, 1722, \[1723].
\:\\{reversed}, \[643], 1714, 1721.
\:\\{rewrite}, 26, 27, 33.
\:\\{rewrite\_OK}, \[27].
\:\\{rh}, 128, \[131], 132, 136, 231, 237, 239, 252, 274, 275, 290, 861, 1098,
1135, 1817.
\:\\{right}, 693.
\:\9{right\_}{\.{\\right} primitive}, \[1366].
\:\\{right\_brace}, \[225], 311, 316, 320, 369, 379, 415, 468, 500, 503, 961,
1112, 1138, 1245, 1430, 1683.
\:\\{right\_brace\_limit}, \[311], 347, 348, 418, 425, 426, 500, 503, 1683.
\:\\{right\_brace\_token}, \[311], 361, 1243, 1305, 1404, 1618.
\:\\{right\_delimiter}, \[859], 873, 924, 1359, 1360.
\:\\{right\_hyphen\_min}, \[254], 1269, 1378, 1624, 1625.
\:\9{right\_hyphen\_min\_}{\.{\\righthyphenmin} primitive}, \[256].
\:\\{right\_hyphen\_min\_code}, \[254], 255, 256.
\:\9{right\_margin\_kern\_}{\.{\\rightmarginkern} primitive}, \[494].
\:\\{right\_margin\_kern\_code}, \[494], 495, 497, 498.
\:\\{right\_noad}, \[863], 866, 872, 874, 901, 903, 904, 936, 937, 938, 1362,
1366, 1369.
\:\\{right\_ptr}, \[632], 633, 634, 642.
\:\\{right\_pw}, \[823], 1005, 1057.
\:\\{right\_side}, \[173], 498, 823, 1057.
\:\\{right\_skip}, \[242], 1003, 1056, 1057, 1740, 1843.
\:\9{right\_skip\_}{\.{\\rightskip} primitive}, \[244].
\:\\{right\_skip\_code}, \[242], 243, 244, 498, 1057, 1062, 1740, 1746.
\:\\{right\_to\_left}, \[643], 651, 654, 656, 660, 661, 665, 733, 736, 737,
742, 743, 746, 1714, 1715, 1734.
\:\\{rightskip}, 1057.
\:\\{right1}, 612, \[613], 634, 637, 643, 706, 719, 726.
\:\\{right2}, \[612], 637.
\:\\{right3}, \[612], 637.
\:\\{right4}, \[612], 637.
\:\\{rlink}, \[142], 143, 144, 145, 147, 148, 149, 150, 163, 167, 182, 187,
948, 995, 997, 1489, 1490.
\:\9{roman\_numeral\_}{\.{\\romannumeral} primitive}, \[494].
\:\\{roman\_numeral\_code}, \[494], 495, 497, 498.
\:\\{root}, 806, 814, 815, 1513.
\:\\{round}, 3, 132, 204, 653, 662, 735, 744, 985, 1303, 1638.
\:\\{round\_decimals}, \[102], 103, 478.
\:\\{round\_glue}, \[653], 1726.
\:\\{round\_xn\_over\_d}, \[689], 690, 693, 705, 706, 823, 1637.
\:\\{rover}, \[142], 143, 144, 145, 146, 147, 148, 149, 150, 182, 187, 1489,
1490.
\:\\{rp}, 822, 1005.
\:\9{rp\_code\_}{\.{\\rpcode} primitive}, \[1432].
\:\\{rp\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\\{rt\_hit}, 1083, \[1084], 1087, 1088, 1210, 1212, 1217, 1218.
\:\\{rule}, 1550, 1552, 1556, 1565.
\:\\{rule\_dp}, \[619], 650, 652, 654, 659, 661, 663, 732, 734, 736, 741, 743,
745.
\:\\{rule\_ht}, \[619], 650, 652, 654, 659, 661, 662, 663, 664, 726, 732, 734,
736, 741, 743, 744, 745, 1637, 1638.
\:\\{rule\_node}, \[156], 157, 166, 193, 201, 220, 224, 650, 654, 659, 663,
732, 736, 741, 745, 825, 827, 845, 846, 906, 937, 981, 1017, 1018, 1042, 1046,
1047, 1145, 1150, 1177, 1252, 1265, 1299, 1325, 1550, 1637, 1725, 1733.
\:\\{rule\_node\_size}, \[156], 157, 220, 224, 1733.
\:\\{rule\_save}, \[976], 980.
\:\\{rule\_wd}, \[619], 650, 652, 653, 654, 655, 659, 661, 663, 726, 732, 734,
735, 736, 741, 743, 745, 1699, 1722, 1725, 1728, 1729.
\:{rules aligning with characters}, 616.
\:\\{run}, 1005.
\:\\{runaway}, 138, \[328], 360, 422, 512.
\:\.{Runaway...}, 328.
\:\|{s}, \[45], \[46], \[58], \[59], \[60], \[62], \[63], \[93], \[94], \[95], %
\[103], \[108], \[143], \[148], \[165], \[195], \[196], \[281], \[286], \[306],
\[415], \[433], \[496], \[499], \[508], \[555], \[556], \[586], \[666], \[693],
\[705], \[727], \[772], \[807], \[817], \[823], \[844], \[864], \[875], \[882],
\[896], \[902], \[914], \[967], \[976], \[1006], \[1038], \[1053], \[1078], %
\[1111], \[1143], \[1145], \[1164], \[1189], \[1238], \[1239], \[1301], %
\[1316], \[1376], \[1414], \[1435], \[1457], \[1529], \[1555], \[1587], %
\[1602], \[1630], \[1679], \[1683], \[1719], \[1744], \[1753], \[1782], %
\[1821], \[1823].
\:\\{s\_out}, 690, \[693].
\:\\{sa\_bot\_mark}, \[1825], 1828, 1830.
\:\\{sa\_chain}, 290, 304, \[1835], 1836, 1837, 1841.
\:\\{sa\_def}, \[1839], 1840.
\:\\{sa\_def\_box}, 1255, \[1839].
\:\\{sa\_define}, 1404, 1405, 1414, \[1839].
\:\\{sa\_destroy}, \[1838], 1839, 1840, 1841.
\:\\{sa\_dim}, \[1820], 1823.
\:\\{sa\_first\_mark}, \[1825], 1828, 1829, 1830.
\:\\{sa\_index}, \[1815], 1820, 1821, 1822, 1837, 1838, 1841.
\:\\{sa\_int}, 453, 1415, \[1820], 1821, 1823, 1837, 1839, 1840, 1841.
\:\\{sa\_lev}, \[1820], 1837, 1839, 1840, 1841.
\:\\{sa\_level}, 290, 304, \[1835], 1836, 1837.
\:\\{sa\_loc}, \[1837], 1841.
\:\\{sa\_mark}, 1154, 1189, 1515, \[1816], 1817.
\:\\{sa\_null}, 1815, \[1816], 1817, 1820.
\:\\{sa\_num}, \[1820], 1822.
\:\\{sa\_ptr}, 441, 453, 1405, 1415, \[1820], 1821, 1823, 1837, 1838, 1839,
1840, 1841.
\:\\{sa\_ref}, \[1820], 1821, 1837.
\:\\{sa\_restore}, 304, \[1841].
\:\\{sa\_root}, 1489, 1490, \[1816], 1818, 1819, 1821.
\:\\{sa\_save}, \[1837], 1839.
\:\\{sa\_split\_bot\_mark}, \[1825], 1826, 1827.
\:\\{sa\_split\_first\_mark}, \[1825], 1826, 1827.
\:\\{sa\_top\_mark}, \[1825], 1828, 1829.
\:\\{sa\_type}, 453, 1415, \[1820], 1823, 1832.
\:\\{sa\_used}, \[1815], 1819, 1820, 1821, 1825.
\:\\{sa\_w\_def}, \[1839], 1840.
\:\\{sa\_word\_define}, 1414, \[1839].
\:\\{save\_active\_width}, \[999].
\:\\{save\_cond\_ptr}, \[524], 526, 535.
\:\\{save\_cs\_ptr}, \[950], 953.
\:\\{save\_cur\_cs}, \[433], 1537.
\:\\{save\_cur\_h}, 725.
\:\\{save\_cur\_string}, \[496], 497.
\:\\{save\_cur\_v}, 725.
\:\\{save\_cur\_val}, \[476], 481.
\:\\{save\_def\_ref}, \[496], 497.
\:\\{save\_font\_list}, 750, 776, 777.
\:\\{save\_for\_after}, \[302], 1449.
\:\\{save\_h}, \[647], 651, 655, 656, \[657], 660, 665, \[729], 737, 1721, 1722.
\:\\{save\_image\_procset}, 750, 776, 777.
\:\\{save\_index}, \[290], 296, 298, 302, 304, 1679, 1774, 1777, 1837.
\:\\{save\_level}, \[290], 291, 296, 298, 302, 304, 1679, 1777, 1837.
\:\\{save\_link}, \[1006], 1033.
\:\\{save\_loc}, \[647], \[657].
\:\\{save\_obj\_list}, 750, 776, 777.
\:\\{save\_pdf\_delta\_h}, 693.
\:\\{save\_pointer}, \[1678], 1679, 1773.
\:\\{save\_ptr}, 290, \[293], 294, 295, 296, 298, 302, 304, 305, 307, 817, 980,
1264, 1277, 1278, 1295, 1298, 1320, 1331, 1346, 1350, 1352, 1364, 1372, 1482,
1679, 1774, 1777, 1837.
\:\\{save\_scanner\_status}, \[388], 393, 394, \[415], \[496], 497, \[520], %
\[524], 527, 533, 1766.
\:\\{save\_size}, \[11], 129, 293, 295, 1514, 1678.
\:\\{save\_split\_top\_skip}, \[1189], 1191.
\:\\{save\_stack}, 221, 290, 292, \[293], 295, 296, 297, 298, 299, 303, 304,
305, 307, 322, 398, 515, 817, 944, 1240, 1249, 1309, 1318, 1328, 1331, 1519,
1678.
\:\\{save\_style}, \[896], \[902], 930.
\:\\{save\_tail}, \[231], 233, 705, 1211, 1217.
\:\\{save\_text\_procset}, 750, 776, 777.
\:\\{save\_type}, \[290], 296, 298, 302, 304, 1837.
\:\\{save\_v}, \[647], 651, 656, \[657], 660, 664, 665, \[738], 742, 746, 1643,
1644.
\:\\{save\_vbadness}, \[1189], 1194.
\:\\{save\_vf\_nf}, 712, 715.
\:\\{save\_vfuzz}, \[1189], 1194.
\:\\{save\_warning\_index}, \[415], \[496], 497.
\:\\{save\_xform\_list}, 750, 776, 777.
\:\\{save\_ximage\_list}, 750, 776, 777.
\:\\{saved}, \[296], 817, 980, 1261, 1264, 1277, 1278, 1295, 1297, 1320, 1331,
1346, 1350, 1352, 1364, 1372, 1661, 1662, 1679, 1680, 1681.
\:\\{saved\_pdf\_cur\_form}, \[774], 775.
\:\\{saved\_pdf\_gone}, \[685].
\:\\{saving\_hyph\_codes}, \[254], 1137.
\:\9{saving\_hyph\_codes\_}{\.{\\savinghyphcodes} primitive}, \[1657].
\:\\{saving\_hyph\_codes\_code}, \[254], 1657, 1659.
\:\\{saving\_vdiscards}, \[254], 1154, 1176, 1859.
\:\9{saving\_vdiscards\_}{\.{\\savingvdiscards} primitive}, \[1657].
\:\\{saving\_vdiscards\_code}, \[254], 1657, 1659.
\:\\{sc}, 128, \[131], 132, 153, 168, 177, 182, 231, 237, 265, 268, 269, 439,
446, 451, 576, 578, 580, 583, 584, 598, 600, 602, 607, 695, 705, 706, 876, 877,
951, 998, 999, 1008, 1019, 1020, 1024, 1026, 1036, 1037, 1066, 1220, 1327,
1384, 1425, 1426, 1431, 1674, 1820, 1842.
\:\\{scale\_image}, \[1552].
\:\\{scaled}, \[101], 102, 103, 104, 105, 106, 107, 108, 110, 126, 128, 131,
165, 168, 174, 194, 195, 473, 474, 476, 479, 574, 575, 586, 597, 611, 619, 634,
643, 647, 657, 673, 687, 689, 690, 691, 692, 693, 705, 706, 708, 712, 722, 725,
729, 738, 818, 823, 844, 855, 880, 881, 882, 888, 891, 892, 893, 895, 902, 911,
912, 913, 914, 919, 925, 932, 938, 967, 976, 999, 1005, 1006, 1015, 1023, 1053,
1083, 1147, 1148, 1154, 1157, 1159, 1171, 1189, 1246, 1264, 1301, 1316, 1376,
1435, 1552, 1628, 1630, 1635, 1636, 1637, 1719, 1723, 1744, 1842, 1844.
\:\.{scaled}, 1436.
\:\\{scaled\_base}, \[265], 267, 269, 1402, 1415.
\:\\{scaled\_out}, \[687], 689, 690, 692, 693.
\:\\{scan\_action}, \[1556], 1560, 1563, 1579.
\:\\{scan\_alt\_rule}, \[1552], 1556, 1565.
\:\\{scan\_box}, 1251, \[1262], 1419.
\:\\{scan\_char\_num}, 440, 452, \[460], 1112, 1207, 1215, 1301, 1302, 1329,
1332, 1402, 1410, 1431, 1671, 1769.
\:\\{scan\_delimiter}, \[1338], 1341, 1360, 1361, 1369, 1370.
\:\\{scan\_dimen}, 436, 466, 473, \[474], 487, 488, 1239.
\:\\{scan\_eight\_bit\_int}, \[459], 1277.
\:\\{scan\_expr}, 1780, 1781, \[1782].
\:\\{scan\_fifteen\_bit\_int}, \[462], 1329, 1332, 1343, 1402.
\:\\{scan\_file\_name}, 287, 356, \[552], 553, 563, 1435, 1453, 1531.
\:\\{scan\_font\_ident}, 441, 452, 497, \[604], 605, 705, 706, 1412, 1431,
1587, 1589, 1593, 1671, 1769.
\:\\{scan\_four\_bit\_int}, \[461], 527, 604, 1412, 1453, 1530.
\:\\{scan\_general\_text}, 1682, \[1683], 1688, 1753.
\:\\{scan\_glue}, 436, \[487], 958, 1238, 1406, 1416, 1573, 1787.
\:\\{scan\_image}, \[1552], 1553.
\:\\{scan\_int}, 435, 436, 458, 459, 460, 461, 462, 463, 464, \[466], 473, 474,
487, 497, 529, 530, 535, 605, 705, 706, 1281, 1403, 1406, 1410, 1416, 1418,
1421, 1422, 1424, 1426, 1431, 1436, 1530, 1539, 1544, 1546, 1549, 1552, 1554,
1556, 1558, 1563, 1565, 1566, 1575, 1585, 1625, 1674, 1769, 1785, 1811, 1866.
\:\\{scan\_keyword}, 180, \[433], 479, 480, 481, 482, 484, 488, 489, 497, 705,
706, 817, 1260, 1277, 1403, 1414, 1436, 1534, 1538, 1539, 1544, 1548, 1552,
1556, 1558, 1563, 1565, 1566, 1579.
\:\\{scan\_left\_brace}, \[429], 499, 817, 961, 1111, 1137, 1202, 1277, 1295,
1297, 1331, 1350, 1352, 1683.
\:\\{scan\_math}, 1328, \[1329], 1336, 1341, 1343, 1354.
\:\\{scan\_mu\_glue}, 1785, 1786, \[1787], 1807.
\:\\{scan\_normal\_dimen}, \[474], 489, 529, 817, 1251, 1260, 1360, 1361, 1406,
1416, 1421, 1423, 1425, 1426, 1431, 1437, 1552, 1769, 1785.
\:\\{scan\_normal\_glue}, 1785, 1786, \[1787], 1803, 1804, 1808.
\:\\{scan\_optional\_equals}, \[431], 705, 706, 958, 1402, 1404, 1406, 1410,
1412, 1414, 1419, 1421, 1422, 1423, 1424, 1425, 1426, 1431, 1435, 1453, 1531.
\:\\{scan\_pdf\_box\_spec}, \[1552].
\:\\{scan\_pdf\_ext\_late\_toks}, \[1537], 1538.
\:\\{scan\_pdf\_ext\_toks}, 497, \[703], \[1537], 1538, 1539, 1540, 1544, 1548,
1552, 1556, 1558, 1563, 1565, 1566, 1578, 1579, 1580, 1581, 1582, 1587, 1589,
1590, 1591, 1599.
\:\\{scan\_register\_num}, 412, 441, 446, 453, 497, 531, 1257, 1260, 1279,
1288, 1402, 1404, 1405, 1415, 1419, 1425, 1474, 1548, 1810, \[1811].
\:\\{scan\_rule\_spec}, \[489], 1234, 1262.
\:\\{scan\_something\_internal}, 435, 436, \[439], 458, 466, 475, 477, 481,
487, 491, 1780.
\:\\{scan\_spec}, \[817], 944, 950, 1249, 1261, 1345.
\:\\{scan\_special}, 693, \[695], 726, 727.
\:\\{scan\_thread\_id}, \[1566], 1567, 1568.
\:\\{scan\_tokens}, 1747.
\:\9{scan\_tokens\_}{\.{\\scantokens} primitive}, \[1747].
\:\\{scan\_toks}, 313, 490, \[499], 1137, 1279, 1396, 1404, 1457, 1466, 1532,
1534, 1537, 1618, 1682.
\:\\{scan\_twenty\_seven\_bit\_int}, \[463], 1329, 1332, 1338.
\:\\{scanned\_result}, \[439], 440, 441, 444, 448, 451, 452, 454.
\:\\{scanned\_result\_end}, \[439].
\:\\{scanner\_status}, \[327], 328, 353, 358, 361, 388, 393, 394, 415, 417,
496, 497, 499, 508, 520, 524, 527, 533, 953, 965, 1223, 1683, 1766.
\:\9{script\_font\_}{\.{\\scriptfont} primitive}, \[1408].
\:\\{script\_mlist}, \[865], 871, 874, 907, 1352.
\:\9{script\_script\_font\_}{\.{\\scriptscriptfont} primitive}, \[1408].
\:\\{script\_script\_mlist}, \[865], 871, 874, 907, 1352.
\:\\{script\_script\_size}, \[875], 932, 1373, 1408.
\:\\{script\_script\_style}, \[864], 870, 907, 1347.
\:\9{script\_script\_style\_}{\.{\\scriptscriptstyle} primitive}, \[1347].
\:\\{script\_size}, \[875], 932, 1373, 1408.
\:\\{script\_space}, \[265], 933, 934, 935.
\:\9{script\_space\_}{\.{\\scriptspace} primitive}, \[266].
\:\\{script\_space\_code}, \[265], 266.
\:\\{script\_style}, \[864], 870, 878, 879, 907, 932, 942, 1347.
\:\9{script\_style\_}{\.{\\scriptstyle} primitive}, \[1347].
\:\\{scripts\_allowed}, \[863], 1354.
\:\\{scroll\_mode}, 71, \[73], 84, 86, 93, 556, 1440, 1441, 1459.
\:\9{scroll\_mode\_}{\.{\\scrollmode} primitive}, \[1440].
\:\\{search\_mem}, 183, \[190], 273, 1519.
\:\\{second\_indent}, \[1023], 1024, 1025, 1066.
\:\\{second\_pass}, \[1004], 1039, 1042.
\:\\{second\_width}, \[1023], 1024, 1025, 1026, 1066.
\:\\{seconds\_and\_micros}, 1555, 1584, 1586.
\:{Sedgewick, Robert}, 2.
\:\.{see the transcript file...}, 1515.
\:\\{seed}, \[125].
\:\\{selector}, \[54], 55, 57, 58, 59, 62, 71, 75, 86, 90, 92, 98, 263, 333,
334, 338, 382, 491, 496, 560, 561, 645, 666, 686, 705, 706, 712, 727, 1435,
1443, 1457, 1476, 1508, 1513, 1515, 1615, 1617, 1688, 1753.
\:\\{semi\_simple\_group}, \[291], 1241, 1243, 1246, 1247, 1661, 1679.
\:\\{serial}, \[997], 1021, 1022, 1032.
\:\\{set\_aux}, \[227], 439, 442, 443, 444, 1388, 1420.
\:\\{set\_box}, \[227], 287, 288, 1388, 1419.
\:\9{set\_box\_}{\.{\\setbox} primitive}, \[287].
\:\\{set\_box\_allowed}, \[76], 77, 1419, 1448.
\:\\{set\_box\_dimen}, \[227], 439, 442, 443, 1388, 1420.
\:\\{set\_box\_lr}, \[643], 983, 984, 1372, 1380, 1714, 1721.
\:\\{set\_box\_lr\_end}, \[643].
\:\\{set\_break\_width\_to\_background}, \[1013].
\:\\{set\_char\_and\_font}, \[705].
\:\\{set\_char\_0}, 612, \[613], 648, 719, 726.
\:\\{set\_conversion}, \[484].
\:\\{set\_conversion\_end}, \[484].
\:\\{set\_cur\_lang}, \[1111], 1137, 1269, 1378.
\:\\{set\_cur\_r}, \[1085], 1087, 1088.
\:\\{set\_ef\_code}, \[705], 1431.
\:\\{set\_expand\_params}, \[705], 712.
\:\\{set\_ff}, 498, 693, 696, \[698], 766.
\:\\{set\_font}, \[227], 439, 579, 604, 706, 1388, 1395, 1435, 1439.
\:\\{set\_glue\_ratio\_one}, \[109], 840, 852, 986, 987.
\:\\{set\_glue\_ratio\_zero}, \[109], 154, 833, 834, 840, 848, 849, 852, 986,
987.
\:\\{set\_height\_zero}, \[1147].
\:\\{set\_hyph\_index}, 1068, 1111, 1610, \[1858].
\:\\{set\_image\_group\_ref}, 1637.
\:\\{set\_interaction}, \[227], 1388, 1440, 1441, 1442.
\:\\{set\_job\_id}, 792.
\:\\{set\_kn\_ac\_code}, \[705], 1431.
\:\\{set\_kn\_bc\_code}, \[705], 1431.
\:\\{set\_kn\_bs\_code}, \[705], 1431.
\:\9{set\_language\_}{\.{\\setlanguage} primitive}, \[1524].
\:\\{set\_language\_code}, \[1524], 1526, 1528.
\:\\{set\_lc\_code}, 1073, 1074, 1075, 1114, \[1858].
\:\\{set\_lp\_code}, \[705], 1431.
\:\\{set\_math\_char}, 1332, \[1333].
\:\\{set\_no\_ligatures}, \[705], 706, 1431.
\:\\{set\_obj\_fresh}, \[695], 698, 812.
\:\\{set\_obj\_scheduled}, \[695], 1630, 1635.
\:\\{set\_origin}, 497, 693, \[695], 727, 1538, 1603.
\:\\{set\_page\_dimen}, \[227], 439, 1159, 1160, 1161, 1388, 1420.
\:\\{set\_page\_int}, \[227], 439, 442, 443, 1388, 1420, 1692.
\:\\{set\_page\_so\_far\_zero}, \[1164].
\:\\{set\_prev\_graf}, \[227], 287, 288, 439, 1388, 1420.
\:\\{set\_random\_seed\_code}, \[1524], 1526, 1528.
\:\9{set\_random\_seed\_code}{\.{\\pdfsetrandomseed} primitive}, \[1524].
\:\\{set\_rect\_dimens}, \[1630], 1635, 1636, 1637.
\:\\{set\_rp\_code}, \[705], 1431.
\:\\{set\_rule}, 610, 612, \[613], 652, 719, 726.
\:\\{set\_sa\_box}, \[1821].
\:\\{set\_sh\_bs\_code}, \[705], 1431.
\:\\{set\_shape}, \[227], 251, 287, 288, 439, 1388, 1426, 1864.
\:\\{set\_st\_bs\_code}, \[705], 1431.
\:\\{set\_tag\_code}, \[705], 1431.
\:\\{set\_trick\_count}, \[338], 339, 340, 342.
\:\\{set1}, 612, \[613], 648, 706, 719, 726.
\:\\{set2}, \[612].
\:\\{set3}, \[612].
\:\\{set4}, \[612].
\:\\{sf\_code}, \[248], 250, 1211.
\:\9{sf\_code\_}{\.{\\sfcode} primitive}, \[1408].
\:\\{sf\_code\_base}, \[248], 253, 1408, 1409, 1411.
\:\\{sh}, 705.
\:\9{sh\_bs\_code\_}{\.{\\shbscode} primitive}, \[1432].
\:\\{sh\_bs\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:\\{shape\_ref}, \[228], 250, 297, 1248, 1426.
\:\\{shellenabledp}, 450.
\:\\{shift\_amount}, \[153], 154, 177, 202, 651, 656, 660, 665, 733, 737, 742,
746, 823, 827, 844, 846, 857, 882, 896, 913, 914, 925, 926, 932, 933, 935, 975,
982, 983, 984, 1066, 1254, 1259, 1303, 1734, 1740, 1744, 1745, 1746.
\:\\{shift\_case}, 1463, \[1466].
\:\\{shift\_down}, \[919], 920, 921, 922, 923, \[925], 927, \[932], 933, 935.
\:\\{shift\_up}, \[919], 920, 921, 922, 923, \[925], 927, \[932], 934, 935.
\:\\{ship\_out}, 619, 727, 750, 761, \[791], 816, 983, 984, 1200, 1253, 1648,
1700, 1705.
\:\9{ship\_out\_}{\.{\\shipout} primitive}, \[1249].
\:\\{ship\_out\_flag}, \[1249], 1253, 1681.
\:\\{shipping\_page}, 750, 751, 752, 757, 759, 760, 763, 1640.
\:\\{short\_display}, 191, \[192], 193, 211, 674, 839, 1033, 1519.
\:\\{short\_display\_n}, \[674], 823, 1005, 1027, 1057.
\:\\{short\_real}, 109, 128.
\:\\{shortcut}, 473, \[474].
\:\\{shortfall}, \[1006], 1027, 1028, 1029, 1842, 1847, 1849, 1850.
\:\\{shorthand\_def}, \[227], 1388, 1400, 1401, 1402.
\:\9{show\_}{\.{\\show} primitive}, \[1469].
\:\\{show\_activities}, \[236], 1471.
\:\\{show\_box}, 198, 200, \[216], 236, 237, 254, 666, 669, 750, 839, 851,
1163, 1169, 1299, 1474, 1519.
\:\9{show\_box\_}{\.{\\showbox} primitive}, \[1469].
\:\\{show\_box\_breadth}, \[254], 1519.
\:\9{show\_box\_breadth\_}{\.{\\showboxbreadth} primitive}, \[256].
\:\\{show\_box\_breadth\_code}, \[254], 255, 256.
\:\\{show\_box\_code}, \[1469], 1470, 1471.
\:\\{show\_box\_depth}, \[254], 1519.
\:\9{show\_box\_depth\_}{\.{\\showboxdepth} primitive}, \[256].
\:\\{show\_box\_depth\_code}, \[254], 255, 256.
\:\\{show\_code}, \[1469], 1471.
\:\\{show\_context}, 54, 78, 82, 88, 332, \[333], 340, 556, 561, 563, 1564,
1774, 1776, 1777.
\:\\{show\_cur\_cmd\_chr}, \[321], 391, 520, 524, 536, 1208, 1389.
\:\\{show\_eqtb}, \[270], 306, 1823.
\:\\{show\_groups}, \[1675], 1676, 1677.
\:\9{show\_groups\_}{\.{\\showgroups} primitive}, \[1675].
\:\\{show\_ifs}, \[1689], 1690, 1691.
\:\9{show\_ifs\_}{\.{\\showifs} primitive}, \[1689].
\:\\{show\_info}, 868, \[869].
\:\\{show\_lists\_code}, \[1469], 1470, 1471.
\:\9{show\_lists\_code\_}{\.{\\showlists} primitive}, \[1469].
\:\\{show\_node\_list}, 191, 194, 198, 199, \[200], 213, 216, 251, 866, 868,
869, 871, 1005, 1145, 1519, 1823.
\:\\{show\_sa}, \[1823], 1839, 1840, 1841.
\:\\{show\_save\_groups}, 1515, 1677, \[1679].
\:\9{show\_the\_}{\.{\\showthe} primitive}, \[1469].
\:\\{show\_the\_code}, \[1469], 1470.
\:\\{show\_token\_list}, 194, 241, 251, 286, \[314], 317, 328, 341, 342, 426,
686, 727, 1519, 1615, 1823.
\:\\{show\_tokens}, \[1684], 1685, 1686.
\:\9{show\_tokens\_}{\.{\\showtokens} primitive}, \[1684].
\:\\{show\_whatever}, 1468, \[1471].
\:\\{shown\_mode}, \[231], 233, 321.
\:\\{shrink}, \[168], 169, 182, 196, 457, 488, 653, 662, 705, 735, 744, 832,
847, 892, 985, 1001, 1003, 1014, 1044, 1153, 1181, 1186, 1220, 1222, 1326,
1407, 1417, 1418, 1637, 1638, 1699, 1746, 1790, 1791, 1794, 1795, 1796, 1798,
1804.
\:\\{shrink\_amount}, 1637.
\:\\{shrink\_limit}, \[705].
\:\\{shrink\_order}, \[168], 182, 196, 488, 653, 662, 735, 744, 832, 847, 892,
985, 1001, 1002, 1153, 1181, 1186, 1326, 1417, 1637, 1638, 1699, 1746, 1791,
1794, 1803.
\:\\{shrinking}, \[153], 204, 647, 657, 729, 738, 840, 852, 985, 986, 987,
1326, 1637, 1699, 1723.
\:\\{si}, \[38], 42, 69, 1128, 1141, 1488, 1754, 1856.
\:\\{side}, 823.
\:\\{sign}, 689.
\:\\{simple\_group}, \[291], 1241, 1246, 1661, 1679.
\:{Single-character primitives}, \[289].
\:\9{Single-character primitives -}{\quad\.{\\-}}, \[1292].
\:\9{Single-character primitives /}{\quad\.{\\/}}, \[287].
\:\9{Single-character primitives /}{\quad\.{\\\ }}, \[287].
\:\\{single\_base}, \[240], 284, 285, 286, 376, 394, 395, 400, 468, 527, 706,
1223, 1435, 1467, 1768.
\:\\{skew\_char}, 173, 452, \[575], 578, 603, 705, 706, 917, 1431, 1500, 1501.
\:\9{skew\_char\_}{\.{\\skewchar} primitive}, \[1432].
\:\\{skip}, \[242], 453, 1186.
\:\9{skip\_}{\.{\\skip} primitive}, \[437].
\:\\{skip\_base}, \[242], 245, 247, 1402, 1415.
\:\\{skip\_blanks}, \[325], 366, 367, 369, 371, 376.
\:\\{skip\_byte}, \[571], 583, 823, 917, 928, 929, 1086, 1216.
\:\\{skip\_code}, \[1236], 1237, 1238.
\:\9{skip\_def\_}{\.{\\skipdef} primitive}, \[1400].
\:\\{skip\_def\_code}, \[1400], 1401, 1402.
\:\\{skip\_line}, 358, \[519], 520.
\:\\{skipping}, \[327], 328, 358, 520.
\:\\{slant}, 573, \[584], 602, 673, 1301, 1303.
\:\\{slant\_code}, \[573], 584.
\:\\{slow\_print}, \[60], 61, 63, 84, 544, 562, 563, 608, 670, 1439, 1458,
1461, 1508, 1513, 1519.
\:\\{slow\_print\_substr}, \[693].
\:\\{small\_char}, \[859], 867, 873, 882, 1338.
\:\\{small\_fam}, \[859], 867, 873, 882, 1338.
\:\\{small\_node\_size}, \[159], 162, 163, 165, 170, 171, 174, 176, 220, 224,
831, 897, 1080, 1087, 1091, 1214, 1278, 1279, 1561, 1569, 1572, 1575, 1576,
1594, 1595, 1596, 1597, 1598, 1604, 1605, 1624, 1625, 1722, 1725, 1727, 1729,
1733, 1738.
\:\\{small\_number}, \[101], 102, 165, 170, 172, 286, 388, 415, 439, 464, 466,
476, 487, 491, 496, 508, 515, 520, 523, 524, 549, 604, 634, 706, 729, 772, 823,
844, 864, 882, 895, 896, 902, 932, 938, 1005, 1069, 1070, 1082, 1083, 1098,
1111, 1121, 1137, 1147, 1164, 1238, 1253, 1264, 1269, 1354, 1359, 1369, 1376,
1389, 1414, 1424, 1425, 1435, 1471, 1503, 1515, 1529, 1530, 1556, 1564, 1573,
1617, 1620, 1633, 1636, 1705, 1719, 1782, 1815, 1819, 1821, 1823, 1825, 1842.
\:\\{snap\_glue\_ptr}, \[695], 1573, 1603, 1604, 1605, 1637.
\:\\{snap\_node\_size}, \[695], 1573, 1604, 1605.
\:\\{snap\_unit}, \[1637].
\:\\{snapy\_comp\_ratio}, \[695], 1575, 1603, 1637.
\:\\{so}, \[38], 45, 59, 60, 69, 70, 286, 433, 490, 545, 630, 645, 693, 942,
1108, 1130, 1132, 1133, 1136, 1140, 1487, 1615, 1754, 1855.
\:\.{Sorry, I can't find...}, 550.
\:\\{sort\_avail}, \[149], 1489.
\:\\{sort\_dest\_names}, \[793], 804.
\:{sp}, 104, 614.
\:\.{sp}, 484.
\:\\{sp}, 1637.
\:\\{space}, 573, \[584], 693, 928, 931, 1220.
\:\\{space\_code}, \[573], 584, 605, 1220.
\:\\{space\_factor}, 230, \[231], 444, 962, 963, 975, 1207, 1211, 1221, 1222,
1234, 1254, 1261, 1269, 1271, 1295, 1297, 1301, 1374, 1378, 1420, 1421.
\:\9{space\_factor\_}{\.{\\spacefactor} primitive}, \[442].
\:\\{space\_shrink}, 573, \[584], 693, 1220.
\:\\{space\_shrink\_code}, \[573], 584, 605.
\:\\{space\_skip}, \[242], 1219, 1221.
\:\9{space\_skip\_}{\.{\\spaceskip} primitive}, \[244].
\:\\{space\_skip\_code}, \[242], 243, 244, 1219.
\:\\{space\_stretch}, 573, \[584], 1220.
\:\\{space\_stretch\_code}, \[573], 584.
\:\\{space\_token}, \[311], 419, 490, 1393, 1761.
\:\\{spacer}, \[225], 226, 250, 311, 313, 316, 320, 325, 359, 367, 369, 370,
371, 376, 430, 432, 433, 469, 470, 478, 490, 959, 961, 967, 1112, 1138, 1207,
1223, 1399.
\:\9{span\_}{\.{\\span} primitive}, \[956].
\:\\{span\_code}, \[956], 957, 958, 965, 967.
\:\\{span\_count}, \[177], 203, 972, 977, 984.
\:\\{span\_node\_size}, \[973], 974, 979.
\:\\{spec}, 1550, 1552, 1556, 1565.
\:\\{spec\_code}, \[817].
\:\\{spec\_log}, \[117], 118, 120.
\:\9{special\_}{\.{\\special} primitive}, \[1524].
\:\\{special\_node}, \[1521], 1524, 1526, 1528, 1534, 1603, 1604, 1605, 1620,
1639, 1645.
\:\\{special\_out}, \[1615], 1620.
\:\.{split}, 1188.
\:\\{split\_bot\_mark}, \[408], 409, 1154, 1156, 1809, 1826, 1827.
\:\9{split\_bot\_mark\_}{\.{\\splitbotmark} primitive}, \[410].
\:\\{split\_bot\_mark\_code}, \[408], 410, 411, 1515, 1809, 1831.
\:\9{split\_bot\_marks\_}{\.{\\splitbotmarks} primitive}, \[1809].
\:\\{split\_disc}, 1145, 1154, \[1859], 1860.
\:\9{split\_discards\_}{\.{\\splitdiscards} primitive}, \[1861].
\:\\{split\_first\_mark}, \[408], 409, 1154, 1156, 1809, 1827.
\:\9{split\_first\_mark\_}{\.{\\splitfirstmark} primitive}, \[410].
\:\\{split\_first\_mark\_code}, \[408], 410, 411, 1809.
\:\9{split\_first\_marks\_}{\.{\\splitfirstmarks} primitive}, \[1809].
\:\\{split\_fist\_mark}, 1826.
\:\\{split\_max\_depth}, 158, \[265], 1154, 1246, 1278.
\:\9{split\_max\_depth\_}{\.{\\splitmaxdepth} primitive}, \[266].
\:\\{split\_max\_depth\_code}, \[265], 266.
\:\\{split\_top\_ptr}, \[158], 206, 220, 224, 1198, 1199, 1278.
\:\\{split\_top\_skip}, 158, \[242], 1145, 1154, 1189, 1191, 1198, 1278.
\:\9{split\_top\_skip\_}{\.{\\splittopskip} primitive}, \[244].
\:\\{split\_top\_skip\_code}, \[242], 243, 244, 1146.
\:\\{split\_up}, \[1158], 1163, 1185, 1187, 1197, 1198.
\:\\{spotless}, \[76], 77, 263, 686, 1512, 1515, 1774, 1776, 1777.
\:\.{spread}, 817.
\:\\{sprint\_cs}, 241, \[285], 360, 421, 422, 424, 498, 505, 510, 587, 1472.
\:\\{sq}, 597.
\:{square roots}, 913.
\:\\{ss\_code}, \[1236], 1237, 1238.
\:\\{ss\_glue}, \[180], 182, 891, 1238.
\:\\{st}, 705.
\:\9{st\_bs\_code\_}{\.{\\stbscode} primitive}, \[1432].
\:\\{st\_bs\_code\_base}, \[173], 452, 1431, 1432, 1433.
\:{stack conventions}, 322.
\:\\{stack\_h}, 722, 726.
\:\\{stack\_into\_box}, \[887], 889.
\:\\{stack\_level}, 712, 717, 719.
\:\\{stack\_no}, 727.
\:\\{stack\_size}, \[11], 323, 332, 343, 1514.
\:\\{stack\_v}, 722, 726.
\:\\{stack\_w}, 722, 726.
\:\\{stack\_x}, 722, 726.
\:\\{stack\_y}, 722, 726.
\:\\{stack\_z}, 722, 726.
\:\\{start}, 322, \[324], 325, 329, 340, 341, 345, 346, 347, 348, 350, 351,
353, 382, 384, 385, 393, 394, 509, 564, 1755.
\:\\{start\_cs}, \[363], 376, 377.
\:\\{start\_eq\_no}, 1318, \[1320].
\:\\{start\_field}, \[322], 324.
\:\\{start\_font\_error\_message}, \[587], 593.
\:\\{start\_here}, 5, \[1512].
\:\\{start\_input}, 388, 402, 404, \[563], 1517.
\:\\{start\_of\_TEX}, \[6], 1512.
\:\\{start\_packet}, 725.
\:\\{start\_par}, \[226], 1266, 1267, 1268, 1270.
\:\\{start\_status}, 727.
\:\&{stat}, \[7], \[135], \[138], \[139], \[140], \[141], \[143], \[148], %
\[270], \[279], \[296], \[299], \[304], \[305], \[306], \[667], \[1002], %
\[1005], \[1021], \[1031], \[1039], \[1164], \[1182], \[1187], \[1513], %
\[1662], \[1823], \[1839], \[1840], \[1841].
\:\\{state}, 87, 322, \[324], 325, 329, 333, 334, 345, 347, 350, 352, 353, 359,
363, 365, 366, 368, 369, 371, 374, 375, 376, 416, 509, 563, 1515.
\:\\{state\_field}, \[322], 324, 1309, 1775.
\:\\{step}, \[705].
\:{stomach}, 428.
\:\\{stop}, \[225], 1223, 1224, 1230, 1231, 1232, 1272.
\:\\{stop\_flag}, \[571], 583, 823, 917, 928, 929, 1086, 1216.
\:\\{store\_background}, \[1040].
\:\\{store\_break\_width}, \[1019].
\:\\{store\_fmt\_file}, \[1480], 1515.
\:\\{store\_four\_quarters}, \[590], 594, 595, 600, 601.
\:\\{store\_new\_token}, \[397], 398, 419, 423, 425, 433, 490, 492, 499, 500,
502, 503, 508, 509, 1683, 1761, 1767.
\:\\{store\_scaled}, \[597], 598, 600, 602.
\:\\{store\_scaled\_f}, \[597], 712, 717, 725.
\:\\{storepacket}, 706, 718.
\:\\{str\_eq\_buf}, \[45], 278.
\:\\{str\_eq\_str}, \[46], 281, 693, 705, 801, 1438.
\:\\{str\_in\_str}, \[686], 693.
\:\\{str\_less\_str}, \[793].
\:\\{str\_number}, \[38], 39, 43, 45, 46, 47, 62, 63, 79, 93, 94, 95, 195, 196,
281, 286, 306, 433, 496, 538, 545, 551, 553, 555, 556, 558, 575, 586, 686, 693,
698, 702, 704, 705, 706, 708, 712, 725, 727, 749, 772, 793, 807, 811, 1103,
1106, 1111, 1435, 1457, 1477, 1537, 1552, 1555, 1564, 1587, 1602, 1627, 1628,
1630, 1679, 1753, 1814, 1823.
\:\\{str\_pool}, 38, \[39], 42, 43, 45, 46, 47, 59, 60, 69, 70, 274, 279, 283,
286, 325, 433, 490, 545, 629, 630, 645, 666, 686, 693, 702, 706, 727, 749, 750,
793, 940, 942, 1106, 1108, 1111, 1118, 1487, 1488, 1514, 1537, 1587, 1615,
1630, 1753, 1754.
\:\\{str\_ptr}, 38, \[39], 41, 43, 44, 47, 59, 60, 70, 279, 281, 284, 496, 543,
551, 563, 645, 673, 693, 727, 1438, 1487, 1488, 1501, 1503, 1507, 1512, 1514,
1615.
\:\\{str\_room}, \[42], 198, 279, 490, 542, 551, 706, 712, 717, 726, 727, 1116,
1435, 1457, 1508, 1513, 1615, 1753.
\:\\{str\_start}, 38, \[39], 40, 41, 43, 44, 45, 46, 47, 59, 60, 69, 70, 274,
279, 281, 286, 433, 496, 497, 543, 545, 630, 645, 686, 693, 702, 706, 727, 749,
793, 941, 1106, 1108, 1111, 1118, 1487, 1488, 1537, 1587, 1615, 1630, 1754.
\:\\{str\_toks}, \[490], 491, 496, 497, 1688.
\:\\{stretch}, \[168], 169, 182, 196, 457, 488, 653, 662, 705, 735, 744, 832,
847, 892, 985, 1003, 1014, 1044, 1153, 1181, 1186, 1220, 1222, 1326, 1407,
1417, 1418, 1637, 1638, 1699, 1746, 1790, 1791, 1794, 1795, 1796, 1798, 1804,
1843, 1853.
\:\\{stretch\_amount}, 1637.
\:\\{stretch\_limit}, 705.
\:\\{stretch\_order}, \[168], 182, 196, 488, 653, 662, 735, 744, 832, 847, 892,
985, 1003, 1014, 1044, 1153, 1181, 1186, 1326, 1417, 1637, 1638, 1699, 1746,
1791, 1794, 1803, 1843.
\:\\{stretching}, \[153], 653, 662, 735, 744, 834, 849, 985, 986, 987, 1326,
1638, 1699.
\:{string pool}, 47, 1486.
\:\9{string\_}{\.{\\string} primitive}, \[494].
\:\\{string\_code}, \[494], 495, 497, 498.
\:\\{string\_vacancies}, \[11], 52.
\:\\{style}, \[902], 903, 936, 937, \[938].
\:\\{style\_node}, 178, \[864], 866, 874, 906, 907, 937, 1347, 1719.
\:\\{style\_node\_size}, \[864], 865, 874, 939, 1719.
\:\\{sub\_box}, \[857], 863, 868, 874, 896, 910, 911, 913, 914, 925, 930, 1254,
1271, 1346.
\:\\{sub\_char\_shrink}, \[1015], 1017.
\:\\{sub\_char\_shrink\_end}, \[1015].
\:\\{sub\_char\_stretch}, \[1015], 1017.
\:\\{sub\_char\_stretch\_end}, \[1015].
\:\\{sub\_disc\_width\_from\_active\_width}, \[1015], 1045.
\:\\{sub\_drop}, \[876], 932.
\:\\{sub\_kern\_shrink}, \[1015], 1017.
\:\\{sub\_kern\_shrink\_end}, \[1015].
\:\\{sub\_kern\_stretch}, \[1015], 1017.
\:\\{sub\_kern\_stretch\_end}, \[1015].
\:\\{sub\_mark}, \[225], 316, 320, 369, 1224, 1353.
\:\\{sub\_mlist}, \[857], 859, 868, 896, 918, 930, 1359, 1363, 1364, 1369.
\:\\{sub\_style}, \[878], 926, 933, 935.
\:\\{sub\_sup}, 1353, \[1354].
\:\\{subscr}, \[857], 859, 862, 863, 866, 872, 874, 914, 918, 925, 926, 927,
928, 929, 930, 931, 932, 933, 935, 1329, 1341, 1343, 1353, 1354, 1355, 1364.
\:{subscripts}, 930, 1353.
\:\\{subst\_ex\_font}, \[823], 825, 828.
\:\\{subst\_font\_type}, \[703].
\:\\{substituted}, \[823].
\:\\{substr\_of\_str}, \[749], 769, 807.
\:\\{subtype}, \[151], 152, 153, 154, 157, 158, 160, 161, 162, 163, 164, 165,
167, 168, 170, 171, 172, 173, 174, 176, 177, 193, 201, 206, 207, 208, 209, 210,
211, 450, 498, 515, 521, 522, 643, 653, 655, 662, 664, 674, 695, 705, 727, 735,
744, 772, 823, 825, 832, 844, 847, 857, 858, 862, 863, 864, 865, 866, 872, 893,
906, 907, 908, 909, 925, 939, 942, 944, 962, 969, 971, 985, 995, 996, 998,
1005, 1013, 1017, 1018, 1019, 1020, 1042, 1044, 1046, 1047, 1055, 1057, 1073,
1074, 1075, 1076, 1080, 1087, 1145, 1158, 1163, 1165, 1177, 1185, 1186, 1195,
1197, 1198, 1212, 1238, 1239, 1256, 1258, 1278, 1279, 1291, 1303, 1326, 1337,
1341, 1343, 1349, 1359, 1369, 1515, 1521, 1529, 1573, 1603, 1604, 1605, 1606,
1607, 1608, 1609, 1610, 1611, 1612, 1615, 1620, 1622, 1635, 1637, 1639, 1645,
1691, 1699, 1711, 1717, 1719, 1720, 1728, 1736, 1737, 1739, 1777, 1788, 1789,
1815.
\:\\{sub1}, \[876], 933.
\:\\{sub2}, \[876], 935.
\:\\{succumb}, \[93], 94, 95, 686, 1482.
\:\\{sup\_dest\_names\_size}, \[695], 698, 1513.
\:\\{sup\_drop}, \[876], 932.
\:\\{sup\_mark}, \[225], 316, 320, 366, 377, 1224, 1353, 1354, 1355.
\:\\{sup\_obj\_tab\_size}, \[695], 698, 1513.
\:\\{sup\_pdf\_mem\_size}, \[675], 678, 1513.
\:\\{sup\_pdf\_os\_buf\_size}, \[679], 686.
\:\\{sup\_pk\_dpi}, \[695].
\:\\{sup\_style}, \[878], 926, 934.
\:{superscripts}, 930, 1353.
\:\\{supscr}, \[857], 859, 862, 863, 866, 872, 874, 914, 918, 926, 927, 928,
929, 930, 932, 934, 1329, 1341, 1343, 1353, 1354, 1355, 1364.
\:\\{sup1}, \[876], 934.
\:\\{sup2}, \[876], 934.
\:\\{sup3}, \[876], 934.
\:\\{sw}, \[586], 597, 602.
\:\\{switch}, \[363], 365, 366, 368, 372.
\:\\{synch\_h}, \[643], 648, 652, 656, 661, 665, 1615.
\:\\{synch\_v}, \[643], 648, 652, 656, 660, 661, 665, 1615.
\:\\{sys\_day}, 259, \[264], 562.
\:\\{sys\_month}, 259, \[264], 562.
\:\\{sys\_obj\_ptr}, \[696], 697, 698, 802, 812, 814, 815, 1504, 1505.
\:\\{sys\_time}, 259, \[264], 562.
\:\\{sys\_year}, 259, \[264], 562.
\:{system dependencies}, 2, \[3], 4, 9, 10, 11, 12, 19, 21, 23, 26, 27, 28, 32,
33, 34, 35, 37, 38, 49, 56, 59, 61, 72, 81, 84, 96, 109, 112, 128, 130, 131,
179, 204, 259, 326, 335, 350, 511, 537, 538, 539, 540, 541, 542, 543, 544, 545,
546, 547, 549, 551, 563, 564, 583, 590, 618, 622, 624, 974, 1484, 1511, 1512,
1513, 1518, 1520, 1831, 1867.
\:\\{sz}, \[1753], 1754, \[1756].
\:\\{s1}, \[82], 88, 793, \[1537], 1564, \[1587].
\:\\{s2}, \[82], 88, 793, 1537, 1564, 1587.
\:\\{s3}, \[82], 88.
\:\\{s4}, \[82], 88.
\:\|{t}, \[46], \[107], \[108], \[143], \[236], \[299], \[301], \[302], \[303],
\[345], \[363], \[388], \[415], \[490], \[496], \[499], \[689], \[706], \[880],
\[881], \[902], \[932], \[976], \[1005], \[1006], \[1053], \[1083], \[1111], %
\[1143], \[1147], \[1207], \[1301], \[1354], \[1369], \[1376], \[1435], %
\[1466], \[1471], \[1723], \[1733], \[1738], \[1744], \[1782], \[1799], %
\[1819], \[1823].
\:\\{t\_open\_in}, \[33], 37.
\:\\{t\_open\_out}, \[33], 1512.
\:\\{tab\_mark}, \[225], 311, 316, 364, 369, 956, 957, 958, 959, 960, 964, 1304.
\:\\{tab\_skip}, \[242].
\:\9{tab\_skip\_}{\.{\\tabskip} primitive}, \[244].
\:\\{tab\_skip\_code}, \[242], 243, 244, 954, 958, 962, 969, 971, 985.
\:\\{tab\_token}, \[311], 1306.
\:\\{tag}, \[569], 570, 580.
\:\\{tag\_code}, \[173], 452, 1431, 1432, 1433.
\:\9{tag\_code\_}{\.{\\tagcode} primitive}, \[1432].
\:\\{tail}, 160, 230, \[231], 232, 233, 234, 450, 855, 894, 952, 962, 971, 972,
975, 988, 992, 1067, 1172, 1194, 1200, 1203, 1211, 1212, 1213, 1214, 1217,
1218, 1219, 1221, 1232, 1238, 1239, 1254, 1256, 1258, 1269, 1274, 1278, 1279,
1283, 1288, 1291, 1295, 1297, 1298, 1301, 1303, 1323, 1328, 1333, 1336, 1337,
1341, 1343, 1346, 1349, 1352, 1354, 1355, 1359, 1362, 1364, 1365, 1369, 1374,
1383, 1384, 1529, 1530, 1531, 1532, 1533, 1534, 1538, 1539, 1540, 1546, 1549,
1554, 1556, 1558, 1560, 1565, 1566, 1575, 1623, 1624, 1625, 1863.
\:\\{tail\_append}, 231, \[232], 962, 971, 992, 1212, 1214, 1217, 1218, 1232,
1234, 1238, 1239, 1269, 1271, 1278, 1281, 1290, 1291, 1295, 1328, 1336, 1341,
1343, 1346, 1349, 1350, 1355, 1369, 1374, 1381, 1383, 1384, 1574, 1703.
\:\\{tail\_field}, \[230], 231, 1172.
\:\\{tail\_page\_disc}, 1176, \[1859].
\:\\{take\_frac}, \[114], 126, 127.
\:\\{take\_fraction}, 1799.
\:\\{tally}, \[54], 55, 57, 58, 314, 334, 337, 338, 339.
\:\&{tats}, \[7].
\:\\{temp\_head}, \[180], 328, 417, 422, 426, 490, 492, 493, 496, 497, 504,
895, 896, 930, 936, 992, 1038, 1039, 1040, 1053, 1055, 1056, 1057, 1063, 1145,
1242, 1243, 1372, 1374, 1377, 1475, 1683, 1688, 1707, 1709, 1734, 1735, 1737,
1738, 1753.
\:\\{temp\_ptr}, \[133], 172, 646, 647, 651, 656, 657, 660, 665, 668, 729, 733,
737, 738, 742, 746, 752, 855, 868, 869, 1146, 1178, 1198, 1214, 1219, 1515,
1705, 1707, 1709, 1712, 1721, 1722, 1723, 1727, 1746.
\:\\{ten\_pow}, \[687], 688, 689, 690, 792, 1637.
\:\\{term\_and\_log}, \[54], 57, 58, 71, 75, 92, 263, 560, 1476, 1508, 1515,
1617.
\:\\{term\_in}, \[32], 33, 34, 36, 37, 71, 1518, 1519.
\:\\{term\_input}, \[71], 78.
\:\\{term\_offset}, \[54], 55, 57, 58, 61, 62, 71, 563, 666, 750, 1458, 1755.
\:\\{term\_only}, \[54], 55, 57, 58, 71, 75, 92, 561, 1476, 1513, 1515.
\:\\{term\_out}, \[32], 33, 34, 35, 36, 37, 51, 56.
\:\\{terminal\_input}, \[326], 335, 350, 352, 382.
\:\\{test\_char}, \[1083], 1086.
\:\\{test\_no\_ligatures}, 452, \[604].
\:\\{TEX}, \[2], \[4].
\:\.{TeX capacity exceeded ...}, 94.
\:\9{TeX capacity exceeded buffer size}{\quad buffer size}, 35, 286, 350, 400,
1768.
\:\9{TeX capacity exceeded exception dictionary}{\quad exception dictionary},
1117.
\:\9{TeX capacity exceeded font memory}{\quad font memory}, 607.
\:\9{TeX capacity exceeded grouping levels}{\quad grouping levels}, 296.
\:\9{TeX capacity exceeded hash size}{\quad hash size}, 279.
\:\9{TeX capacity exceeded input stack size}{\quad input stack size}, 343.
\:\9{TeX capacity exceeded main memory size}{\quad main memory size}, 138, 143.
\:\9{TeX capacity exceeded number of strings}{\quad number of strings}, 43, 543.
\:\9{TeX capacity exceeded parameter stack size}{\quad parameter stack size},
416.
\:\9{TeX capacity exceeded pattern memory}{\quad pattern memory}, 1131, 1141.
\:\9{TeX capacity exceeded pool size}{\quad pool size}, 42.
\:\9{TeX capacity exceeded primitive size}{\quad primitive size}, 282.
\:\9{TeX capacity exceeded save size}{\quad save size}, 295.
\:\9{TeX capacity exceeded semantic nest size}{\quad semantic nest size}, 234.
\:\9{TeX capacity exceeded text input levels}{\quad text input levels}, 350.
\:\.{TEX.POOL check sum...}, 53.
\:\.{TEX.POOL doesn't match}, 53.
\:\.{TEX.POOL has no check sum}, 52.
\:\.{TEX.POOL line doesn't...}, 52.
\:\\{TEX\_area}, \[540], 563.
\:\\{tex\_b\_openin}, 772.
\:\\{TeX\_banner}, \[2].
\:\\{TEX\_font\_area}, \[540], 589.
\:\\{TEX\_format\_default}, \[546], 547, 549.
\:\\{tex\_int\_pars}, \[254].
\:\\{tex\_toks}, \[248].
\:\9{TeXbook}{\sl The \TeX book}, 1, 23, 49, 108, 225, 441, 472, 482, 485, 859,
864, 940, 1393, 1511.
\:\.{TeXfonts}, 540.
\:\.{TeXformats}, 11, 547.
\:\.{TeXinputs}, 540.
\:\.{texput}, 35, 560, 1435.
\:\\{text}, \[274], 276, 277, 278, 279, 284, 285, 286, 287, 394, 395, 517, 527,
579, 706, 956, 1223, 1366, 1394, 1435, 1496, 1616.
\:\.{Text line contains...}, 368.
\:\\{text\_char}, \[19], 20, 25, 47.
\:\9{text\_font\_}{\.{\\textfont} primitive}, \[1408].
\:\\{text\_mlist}, \[865], 871, 874, 907, 1352.
\:\\{text\_size}, \[875], 879, 908, 1373, 1377.
\:\\{text\_style}, \[864], 870, 879, 907, 913, 920, 921, 922, 924, 925, 934,
1347, 1372, 1374.
\:\9{text\_style\_}{\.{\\textstyle} primitive}, \[1347].
\:\\{TeXXeT}, 1700.
\:\\{TeXXeT\_code}, \[2], 1700, 1701.
\:\\{TeXXeT\_en}, 823, 825, 1055, 1056, 1057, \[1700], 1703, 1734, 1735, 1736.
\:\\{TeXXeT\_state}, \[1700].
\:\9{TeXXeT\_state\_}{\.{\\TeXXeT\_state} primitive}, \[1701].
\:\9{TeX82}{\TeX82}, \[1], 99.
\:\9{TFM files}{\.{TFM} files}, 565.
\:\\{tfm\_file}, \[565], 586, 589, 590, 602.
\:\\{tfm\_lookup}, \[705], 706, 712.
\:\\{tfm\_width}, 712, 717.
\:\.{TFtoPL}, 587.
\:\.{That makes 100 errors...}, 82.
\:\\{the}, \[228], 287, 288, 388, 391, 504, 1686.
\:\.{The following...deleted}, 669, 1169, 1299.
\:\9{the\_}{\.{\\the} primitive}, \[287].
\:\\{the\_toks}, \[491], 492, 493, 504, 1475, 1688.
\:\\{thick\_mu\_skip}, \[242].
\:\9{thick\_mu\_skip\_}{\.{\\thickmuskip} primitive}, \[244].
\:\\{thick\_mu\_skip\_code}, \[242], 243, 244, 942.
\:\\{thickness}, \[859], 873, 901, 919, 920, 922, 923, 1360.
\:\\{thin\_mu\_skip}, \[242].
\:\9{thin\_mu\_skip\_}{\.{\\thinmuskip} primitive}, \[244].
\:\\{thin\_mu\_skip\_code}, \[242], 243, 244, 247, 942.
\:\.{This can't happen}, 95.
\:\9{this can't happen /}{\quad \./}, 112.
\:\9{this can't happen align}{\quad align}, 976.
\:\9{this can't happen copying}{\quad copying}, 224.
\:\9{this can't happen curlevel}{\quad curlevel}, 303.
\:\9{this can't happen disc1}{\quad disc1}, 1017.
\:\9{this can't happen disc2}{\quad disc2}, 1018.
\:\9{this can't happen disc3}{\quad disc3}, 1046.
\:\9{this can't happen disc4}{\quad disc4}, 1047.
\:\9{this can't happen display}{\quad display}, 1378.
\:\9{this can't happen endv}{\quad endv}, 967.
\:\9{this can't happen ext1}{\quad ext1}, 1528.
\:\9{this can't happen ext2}{\quad ext2}, 1604.
\:\9{this can't happen ext3}{\quad ext3}, 1605.
\:\9{this can't happen ext4}{\quad ext4}, 1620.
\:\9{this can't happen flushing}{\quad flushing}, 220.
\:\9{this can't happen if}{\quad if}, 523.
\:\9{this can't happen line breaking}{\quad line breaking}, 1053.
\:\9{this can't happen LR1}{\quad LR1}, 1712.
\:\9{this can't happen LR2}{\quad LR2}, 1725.
\:\9{this can't happen LR3}{\quad LR3}, 1730.
\:\9{this can't happen mlist1}{\quad mlist1}, 904.
\:\9{this can't happen mlist2}{\quad mlist2}, 930.
\:\9{this can't happen mlist3}{\quad mlist3}, 937.
\:\9{this can't happen mlist4}{\quad mlist4}, 942.
\:\9{this can't happen page}{\quad page}, 1177.
\:\9{this can't happen paragraph}{\quad paragraph}, 1042.
\:\9{this can't happen pdfvlistout}{\quad pdfvlistout}, 740.
\:\9{this can't happen prefix}{\quad prefix}, 1389.
\:\9{this can't happen pruning}{\quad pruning}, 1145.
\:\9{this can't happen right}{\quad right}, 1363.
\:\9{this can't happen rightbrace}{\quad rightbrace}, 1246.
\:\9{this can't happen tail1}{\quad tail1}, 1258.
\:\9{this can't happen vcenter}{\quad vcenter}, 912.
\:\9{this can't happen vertbreak}{\quad vertbreak}, 1150.
\:\9{this can't happen vlistout}{\quad vlistout}, 658.
\:\9{this can't happen vpack}{\quad vpack}, 845.
\:\9{this can't happen 256 spans}{\quad 256 spans}, 974.
\:\\{this\_box}, \[647], 652, 653, \[657], 661, 662, \[729], 730, 734, 735, %
\[738], 739, 743, 744, 1637, 1638, 1639, 1645, 1714, 1715, 1721, 1722, \[1723].
\:\\{this\_if}, \[524], 527, 529, 531, 532, 1769.
\:\\{thread}, 1600.
\:\\{thread\_title}, \[1600].
\:\\{threads}, 790, 806, 1513.
\:\\{three\_codes}, \[817].
\:\\{threshold}, \[1004], 1027, 1030, 1039.
\:\.{Tight \\hbox...}, 843.
\:\.{Tight \\vbox...}, 854.
\:\\{tight\_fit}, \[993], 995, 1006, 1009, 1010, 1012, 1029, 1842, 1848.
\:\\{time}, \[254], 259, 645, 792.
\:\9{time\_}{\.{\\time} primitive}, \[256].
\:\\{time\_code}, \[254], 255, 256.
\:\&{tini}, \[8].
\:\\{tmp\_b0}, 706, \[710], 712, 714.
\:\\{tmp\_b1}, 706, \[710], 712, 714.
\:\\{tmp\_b2}, 706, \[710], 714.
\:\\{tmp\_b3}, 706, \[710], 714.
\:\\{tmp\_int}, \[710], 726.
\:\\{tmp\_k1}, 1207, 1211, 1216, 1217.
\:\\{tmp\_k2}, 1207, 1212.
\:\\{tmp\_v}, \[1637].
\:\\{tmp\_w}, \[705], \[710].
\:\.{to}, 817, 1260, 1403.
\:\\{tok\_val}, \[436], 441, 444, 454, 491, 1402, 1404, 1405, 1489, 1490, 1815,
1818, 1823.
\:\\{tok\_val\_limit}, \[1815], 1837.
\:{token}, 311.
\:\\{token\_list}, \[329], 333, 334, 345, 347, 352, 359, 363, 368, 416, 1309,
1515, 1775.
\:\\{token\_ref\_count}, \[218], 221, 313, 499, 508, 1156, 1683.
\:\\{token\_show}, \[317], 318, 345, 427, 1457, 1462, 1475, 1617, 1688, 1753.
\:\\{token\_type}, \[329], 333, 334, 336, 341, 345, 346, 347, 349, 405, 416,
1203, 1273.
\:\\{tokens\_to\_string}, 497, \[686], 708, 727, 769, 772, 792, 807, 1537,
1552, 1555, 1563, 1565, 1587, 1589, 1599, 1630, 1637.
\:\\{toks}, \[248].
\:\9{toks\_}{\.{\\toks} primitive}, \[287].
\:\\{toks\_base}, \[248], 249, 250, 251, 329, 441, 1402, 1404, 1405.
\:\9{toks\_def\_}{\.{\\toksdef} primitive}, \[1400].
\:\\{toks\_def\_code}, \[1400], 1402.
\:\\{toks\_register}, \[227], 287, 288, 439, 441, 1388, 1399, 1402, 1404, 1405,
1823, 1833, 1834.
\:\\{tolerance}, \[254], 258, 1004, 1039.
\:\9{tolerance\_}{\.{\\tolerance} primitive}, \[256].
\:\\{tolerance\_code}, \[254], 255, 256.
\:\.{Too many \}'s}, 1246.
\:\.{Too many color stacks}, 497.
\:\\{too\_big}, \[1799].
\:\\{too\_small}, \[1481], 1484.
\:\\{top}, \[572], 693.
\:\\{top\_bot\_mark}, \[228], 318, 388, 391, 410, 411, 412, 1809.
\:\\{top\_edge}, \[657], 664, \[738], 739, 1639.
\:\\{top\_mark}, \[408], 409, 1189, 1809, 1828.
\:\9{top\_mark\_}{\.{\\topmark} primitive}, \[410].
\:\\{top\_mark\_code}, \[408], 410, 412, 1515, 1809, 1831.
\:\9{top\_marks\_}{\.{\\topmarks} primitive}, \[1809].
\:\\{top\_skip}, \[242].
\:\9{top\_skip\_}{\.{\\topskip} primitive}, \[244].
\:\\{top\_skip\_code}, \[242], 243, 244, 1178.
\:\\{total\_demerits}, \[995], 1021, 1022, 1031, 1040, 1050, 1051.
\:\\{total\_font\_shrink}, \[999], 1027.
\:\\{total\_font\_stretch}, \[999], 1027.
\:\9{total\_height}{\.{total height}}, 1163.
\:\\{total\_mathex\_params}, \[877], 1373.
\:\\{total\_mathsy\_params}, \[876], 1373.
\:\\{total\_pages}, \[619], 620, 645, 668, 670, 751, 752, 770, 794.
\:\\{total\_pw}, \[1005], 1027.
\:\\{total\_shrink}, \[818], 824, 832, 840, 841, 842, 843, 847, 852, 853, 854,
972, 1379.
\:\\{total\_stretch}, \[818], 824, 832, 834, 835, 836, 847, 849, 850, 972.
\:{Trabb Pardo, Luis Isidoro}, 2.
\:\\{tracing\_assigns}, \[254], 299, 1839, 1840.
\:\9{tracing\_assigns\_}{\.{\\tracingassigns} primitive}, \[1657].
\:\\{tracing\_assigns\_code}, \[254], 1657, 1659.
\:\\{tracing\_commands}, \[254], 391, 524, 535, 536, 1208, 1389.
\:\9{tracing\_commands\_}{\.{\\tracingcommands} primitive}, \[256].
\:\\{tracing\_commands\_code}, \[254], 255, 256.
\:\\{tracing\_groups}, \[254], 296, 304.
\:\9{tracing\_groups\_}{\.{\\tracinggroups} primitive}, \[1657].
\:\\{tracing\_groups\_code}, \[254], 1657, 1659.
\:\\{tracing\_ifs}, \[254], 321, 520, 524, 536.
\:\9{tracing\_ifs\_}{\.{\\tracingifs} primitive}, \[1657].
\:\\{tracing\_ifs\_code}, \[254], 1657, 1659.
\:\\{tracing\_lost\_chars}, \[254], 608.
\:\9{tracing\_lost\_chars\_}{\.{\\tracinglostchars} primitive}, \[256].
\:\\{tracing\_lost\_chars\_code}, \[254], 255, 256.
\:\\{tracing\_macros}, \[254], 345, 415, 426.
\:\9{tracing\_macros\_}{\.{\\tracingmacros} primitive}, \[256].
\:\\{tracing\_macros\_code}, \[254], 255, 256.
\:\\{tracing\_nesting}, \[254], 384, 1774, 1775, 1776, 1777.
\:\9{tracing\_nesting\_}{\.{\\tracingnesting} primitive}, \[1657].
\:\\{tracing\_nesting\_code}, \[254], 1657, 1659.
\:\\{tracing\_online}, \[254], 263, 608, 1471, 1476.
\:\9{tracing\_online\_}{\.{\\tracingonline} primitive}, \[256].
\:\\{tracing\_online\_code}, \[254], 255, 256.
\:\\{tracing\_output}, \[254], 666, 669, 750.
\:\9{tracing\_output\_}{\.{\\tracingoutput} primitive}, \[256].
\:\\{tracing\_output\_code}, \[254], 255, 256.
\:\\{tracing\_pages}, \[254], 1164, 1182, 1187.
\:\9{tracing\_pages\_}{\.{\\tracingpages} primitive}, \[256].
\:\\{tracing\_pages\_code}, \[254], 255, 256.
\:\\{tracing\_paragraphs}, \[254], 1002, 1021, 1031, 1039.
\:\9{tracing\_paragraphs\_}{\.{\\tracingparagraphs} primitive}, \[256].
\:\\{tracing\_paragraphs\_code}, \[254], 255, 256.
\:\\{tracing\_restores}, \[254], 305, 1841.
\:\9{tracing\_restores\_}{\.{\\tracingrestores} primitive}, \[256].
\:\\{tracing\_restores\_code}, \[254], 255, 256.
\:\\{tracing\_scan\_tokens}, \[254], 1755.
\:\9{tracing\_scan\_tokens\_}{\.{\\tracingscantokens} primitive}, \[1657].
\:\\{tracing\_scan\_tokens\_code}, \[254], 1657, 1659.
\:\\{tracing\_stats}, 135, \[254], 667, 1506, 1513.
\:\9{tracing\_stats\_}{\.{\\tracingstats} primitive}, \[256].
\:\\{tracing\_stats\_code}, \[254], 255, 256.
\:\.{Transcript written...}, 1513.
\:\\{trap\_zero\_glue}, 1406, \[1407], 1414.
\:\\{trapped\_given}, 807.
\:\\{trick\_buf}, \[54], 58, 337, 339.
\:\\{trick\_count}, \[54], 58, 337, 338, 339.
\:{Trickey, Howard Wellington}, 2.
\:\\{trie}, 1097, \[1098], 1099, 1127, 1129, 1130, 1131, 1135, 1136, 1143,
1502, 1503.
\:\\{trie\_back}, \[1127], 1131, 1133.
\:\\{trie\_c}, \[1124], 1125, 1128, 1130, 1132, 1133, 1136, 1140, 1141, 1855,
1856.
\:\\{trie\_char}, 1097, \[1098], 1100, 1135, 1136, 1858.
\:\\{trie\_fix}, 1135, \[1136].
\:\\{trie\_hash}, \[1124], 1125, 1126, 1127, 1129.
\:\\{trie\_l}, \[1124], 1125, 1126, 1134, 1136, 1137, 1140, 1141, 1856.
\:\\{trie\_link}, 1097, \[1098], 1100, 1127, 1129, 1130, 1131, 1132, 1133,
1135, 1136, 1858.
\:\\{trie\_max}, \[1127], 1129, 1131, 1135, 1502, 1503.
\:\\{trie\_min}, \[1127], 1129, 1130, 1133, 1857.
\:\\{trie\_node}, \[1125], 1126.
\:\\{trie\_not\_ready}, 1068, 1111, \[1127], 1128, 1137, 1143, 1502, 1503.
\:\\{trie\_o}, \[1124], 1125, 1136, 1140, 1141, 1856.
\:\\{trie\_op}, 1097, \[1098], 1100, 1101, 1120, 1135, 1136, 1854, 1858.
\:\\{trie\_op\_hash}, \[1120], 1121, 1122, 1123, 1125, 1129.
\:\\{trie\_op\_lang}, \[1120], 1121, 1122, 1129.
\:\\{trie\_op\_ptr}, \[1120], 1121, 1122, 1123, 1502, 1503.
\:\\{trie\_op\_size}, \[11], 1098, 1120, 1121, 1123, 1502, 1503.
\:\\{trie\_op\_val}, \[1120], 1121, 1122, 1129.
\:\\{trie\_pack}, \[1134], 1143, 1857.
\:\\{trie\_pointer}, \[1097], 1098, 1099, 1124, 1125, 1126, 1127, 1130, 1134,
1136, 1137, 1143, 1858.
\:\\{trie\_ptr}, \[1124], 1128, 1129, 1141.
\:\\{trie\_r}, \[1124], 1125, 1126, 1132, 1133, 1134, 1136, 1140, 1141, 1854,
1855, 1856.
\:\\{trie\_ref}, \[1127], 1129, 1130, 1133, 1134, 1136, 1857.
\:\\{trie\_root}, \[1124], 1126, 1128, 1129, 1135, 1143, 1854, 1857.
\:\\{trie\_size}, \[11], 1097, 1125, 1127, 1129, 1131, 1141, 1503.
\:\\{trie\_taken}, \[1127], 1129, 1130, 1131, 1133.
\:\\{trie\_used}, \[1120], 1121, 1122, 1123, 1502, 1503.
\:\\{true}, 4, 16, 31, 34, 37, 45, 46, 49, 51, 53, 71, 77, 88, 97, 98, 104,
105, 106, 107, 112, 114, 115, 186, 187, 274, 276, 278, 304, 333, 349, 350, 358,
368, 383, 384, 387, 398, 400, 404, 433, 439, 456, 466, 470, 473, 479, 487, 488,
512, 527, 534, 538, 542, 550, 552, 560, 589, 605, 619, 649, 656, 665, 666, 669,
683, 685, 686, 689, 692, 693, 698, 699, 702, 705, 706, 720, 726, 727, 737, 746,
747, 748, 749, 750, 766, 791, 793, 794, 795, 799, 801, 802, 804, 823, 839, 851,
882, 895, 967, 1002, 1003, 1004, 1005, 1027, 1030, 1039, 1056, 1057, 1058,
1060, 1080, 1082, 1087, 1088, 1128, 1133, 1139, 1140, 1169, 1197, 1198, 1202,
1207, 1212, 1214, 1218, 1229, 1232, 1258, 1261, 1268, 1279, 1299, 1323, 1341,
1372, 1373, 1396, 1402, 1404, 1414, 1415, 1431, 1436, 1448, 1457, 1461, 1476,
1481, 1516, 1522, 1534, 1537, 1538, 1539, 1540, 1541, 1542, 1544, 1546, 1548,
1549, 1551, 1552, 1553, 1554, 1555, 1558, 1560, 1561, 1563, 1564, 1565, 1567,
1568, 1569, 1572, 1574, 1575, 1580, 1588, 1589, 1590, 1591, 1593, 1594, 1595,
1596, 1597, 1598, 1599, 1600, 1618, 1622, 1629, 1635, 1639, 1645, 1648, 1656,
1662, 1679, 1756, 1767, 1768, 1774, 1775, 1777, 1790, 1793, 1797, 1799, 1819,
1825, 1827, 1830, 1839, 1843, 1856.
\:\.{true}, 479.
\:\\{try\_break}, 1004, \[1005], 1015, 1027, 1034, 1038, 1042, 1044, 1045,
1049, 1055.
\:\\{try\_prev\_break}, \[999], 1039.
\:\\{two}, \[101], 102.
\:\\{two\_choices}, \[131].
\:\\{two\_halves}, \[131], 136, 142, 190, 239, 274, 275, 860, 1098, 1143.
\:\\{two\_to\_the}, \[117], 118, 120.
\:\\{tx}, \[439], 450, \[1257], 1258, 1259, \[1283].
\:\\{type}, \[4], \[151], 152, 153, 154, 155, 156, 157, 158, 159, 160, 161,
162, 163, 164, 165, 166, 167, 168, 170, 171, 173, 174, 175, 176, 177, 178, 193,
201, 202, 220, 224, 450, 497, 498, 515, 521, 522, 523, 531, 650, 651, 654, 656,
659, 660, 663, 665, 668, 674, 695, 705, 732, 733, 736, 737, 741, 742, 745, 746,
751, 772, 823, 825, 827, 831, 844, 845, 846, 856, 857, 858, 859, 862, 863, 864,
865, 872, 874, 889, 891, 896, 897, 902, 903, 904, 905, 907, 908, 912, 923, 926,
928, 936, 937, 938, 943, 944, 972, 975, 977, 981, 983, 985, 986, 987, 992, 995,
996, 998, 1005, 1006, 1008, 1013, 1017, 1018, 1019, 1020, 1021, 1032, 1034,
1035, 1036, 1037, 1038, 1040, 1041, 1042, 1044, 1046, 1047, 1050, 1051, 1055,
1057, 1073, 1074, 1076, 1080, 1091, 1145, 1147, 1149, 1150, 1153, 1155, 1156,
1158, 1163, 1165, 1170, 1173, 1174, 1177, 1181, 1185, 1186, 1187, 1188, 1190,
1191, 1198, 1217, 1252, 1258, 1265, 1278, 1279, 1283, 1288, 1291, 1299, 1325,
1333, 1336, 1337, 1341, 1343, 1346, 1359, 1363, 1364, 1369, 1380, 1381, 1521,
1529, 1573, 1635, 1636, 1637, 1679, 1691, 1699, 1704, 1707, 1711, 1717, 1719,
1725, 1728, 1733, 1738, 1739, 1746, 1777, 1788, 1789, 1815.
\:\.{Type <return> to proceed...}, 85.
\:\|{u}, \[69], \[107], \[127], \[415], \[496], \[586], \[689], \[706], \[882],
\[967], \[976], \[1106], \[1111], \[1121], \[1435], \[1744].
\:\\{u\_part}, 944, \[945], 955, 964, 970, 977.
\:\\{u\_template}, \[329], 336, 346, 964.
\:\\{uc\_code}, \[248], 250, 433.
\:\9{uc\_code\_}{\.{\\uccode} primitive}, \[1408].
\:\\{uc\_code\_base}, \[248], 253, 1408, 1409, 1464, 1466.
\:\\{uc\_hyph}, \[254], 1068, 1073.
\:\9{uc\_hyph\_}{\.{\\uchyph} primitive}, \[256].
\:\\{uc\_hyph\_code}, \[254], 255, 256.
\:\\{un\_hbox}, \[226], 1268, 1285, 1286, 1287.
\:\9{un\_hbox\_}{\.{\\unhbox} primitive}, \[1285].
\:\9{un\_hcopy\_}{\.{\\unhcopy} primitive}, \[1285].
\:\9{un\_kern\_}{\.{\\unkern} primitive}, \[1285].
\:\9{un\_penalty\_}{\.{\\unpenalty} primitive}, \[1285].
\:\9{un\_skip\_}{\.{\\unskip} primitive}, \[1285].
\:\\{un\_vbox}, \[226], 1224, 1272, 1285, 1286, 1287, 1861.
\:\9{un\_vbox\_}{\.{\\unvbox} primitive}, \[1285].
\:\9{un\_vcopy\_}{\.{\\unvcopy} primitive}, \[1285].
\:\\{unbalance}, \[415], 417, 422, 425, \[499], 503, \[1683].
\:\.{Unbalanced output routine}, 1204.
\:\.{Unbalanced write...}, 1619.
\:\.{Undefined control sequence}, 396.
\:\\{undefined\_control\_sequence}, \[240], 250, 274, 276, 278, 284, 290, 304,
312, 1496, 1497.
\:\\{undefined\_cs}, \[228], 240, 388, 398, 527, 1404, 1405, 1473, 1766, 1767.
\:\\{undefined\_primitive}, \[275], 281, 394, 395, 527, 1223.
\:\\{under\_noad}, \[863], 866, 872, 874, 909, 937, 1334, 1335.
\:\.{Underfull \\hbox...}, 836.
\:\.{Underfull \\vbox...}, 850.
\:\9{underline\_}{\.{\\underline} primitive}, \[1334].
\:\\{undump}, \[1484], 1488, 1490, 1492, 1497, 1501, 1503, 1507, 1655.
\:\\{undump\_end}, \[1484].
\:\\{undump\_end\_end}, \[1484].
\:\\{undump\_four\_ASCII}, \[1488].
\:\\{undump\_hh}, \[1484], 1497, 1503.
\:\\{undump\_int}, \[1484], 1486, 1490, 1495, 1497, 1501, 1505, 1507.
\:\\{undump\_qqqq}, \[1484], 1488, 1501.
\:\\{undump\_size}, \[1484], 1488, 1499, 1503.
\:\\{undump\_size\_end}, \[1484].
\:\\{undump\_size\_end\_end}, \[1484].
\:\\{undump\_wd}, \[1484], 1490, 1495, 1499.
\:\\{undumpimagemeta}, 1505.
\:\\{undumptounicode}, 1505.
\:\\{unescapehex}, 497.
\:\9{unexpanded\_}{\.{\\unexpanded} primitive}, \[1686].
\:\\{unfloat}, \[109], 834, 840, 849, 852, 986, 987.
\:\\{unhyphenated}, \[995], 1005, 1013, 1040, 1042, 1044.
\:\\{unif\_rand}, \[126], 498.
\:\9{uniform\_deviate\_}{\.{\\pdfuniformdeviate} primitive}, \[494].
\:\\{uniform\_deviate\_code}, \[494], 495, 497, 498.
\:\\{unity}, \[101], 103, 119, 132, 182, 204, 479, 594, 1437.
\:\.{Unknown color stack}, 1539.
\:\9{unless\_}{\.{\\unless} primitive}, \[1762].
\:\\{unless\_code}, \[513], 514, 524, 1668, 1765.
\:\\{unpackage}, 1287, \[1288].
\:\\{unsave}, \[303], 305, 967, 976, 1203, 1241, 1246, 1264, 1278, 1297, 1311,
1346, 1352, 1364, 1369, 1372, 1374, 1378.
\:\\{unset\_node}, \[177], 193, 201, 202, 220, 224, 450, 825, 845, 858, 864,
865, 944, 972, 975, 977, 981.
\:\\{update\_active}, \[1037].
\:\\{update\_adjust\_list}, \[831].
\:\\{update\_heights}, \[1147], 1149, 1150, 1171, 1174, 1177.
\:\\{update\_image\_procset}, 767.
\:\\{update\_terminal}, \[34], 37, 61, 71, 86, 384, 550, 563, 666, 674, 714,
750, 1458, 1518, 1755.
\:\\{update\_width}, \[1008], 1036.
\:\9{uppercase\_}{\.{\\uppercase} primitive}, \[1464].
\:\.{Use of x doesn't match...}, 424.
\:\\{use\_err\_help}, \[79], 80, 89, 90, 1461.
\:\|{v}, \[69], \[107], \[415], \[476], \[689], \[882], \[891], \[912], \[919],
\[925], \[976], \[1006], \[1099], \[1111], \[1121], \[1137], \[1154], \[1316], %
\[1679].
\:\\{v\_offset}, \[265], 644, 668, 669, 755.
\:\9{v\_offset\_}{\.{\\voffset} primitive}, \[266].
\:\\{v\_offset\_code}, \[265], 266.
\:\\{v\_out}, 692, 693.
\:\\{v\_part}, 944, \[945], 955, 965, 970, 977.
\:\\{v\_template}, \[329], 336, 347, 416, 965, 1309.
\:\\{vacuous}, \[466], 470, 471.
\:\\{vadjust}, \[226], 287, 288, 1275, 1276, 1277, 1278.
\:\9{vadjust\_}{\.{\\vadjust} primitive}, \[287].
\:\\{val}, 682.
\:\\{valign}, \[226], 287, 288, 1224, 1268, 1308, 1700, 1701.
\:\9{valign\_}{\.{\\valign} primitive}, \[287].
\:\\{var\_code}, \[250], 1329, 1333, 1343.
\:\\{var\_delimiter}, \[882], 913, 924, 938.
\:\\{var\_used}, \[135], 143, 148, 182, 667, 1489, 1490.
\:\\{vbadness}, \[254], 850, 853, 854, 1189, 1194.
\:\9{vbadness\_}{\.{\\vbadness} primitive}, \[256].
\:\\{vbadness\_code}, \[254], 255, 256.
\:\9{vbox\_}{\.{\\vbox} primitive}, \[1249].
\:\\{vbox\_group}, \[291], 1261, 1263, 1661, 1679.
\:\\{vcenter}, \[226], 287, 288, 1224, 1345.
\:\9{vcenter\_}{\.{\\vcenter} primitive}, \[287].
\:\\{vcenter\_group}, \[291], 1345, 1346, 1661, 1679.
\:\\{vcenter\_noad}, \[863], 866, 872, 874, 909, 937, 1346.
\:\\{vert\_break}, \[1147], 1148, 1153, 1154, 1157, 1159, 1187.
\:\\{very\_loose\_fit}, \[993], 995, 1006, 1009, 1010, 1012, 1028, 1842, 1847.
\:\\{vet\_glue}, \[653], 662, 735, 744, 1638.
\:\\{vf\_alpha}, 706.
\:\\{vf\_b\_open\_in}, 713.
\:\\{vf\_beta}, 706.
\:\\{vf\_byte}, \[712], 714, 715, 717.
\:\\{vf\_cur\_s}, 721, \[723], 724, 725.
\:\\{vf\_def\_font}, \[712], 715.
\:\\{vf\_default\_font}, 705, 706, \[710], 715, 719, 720, 725, 726.
\:\\{vf\_e\_fnts}, 706, \[710], 715, 719, 720, 726.
\:\\{vf\_error}, 710, \[712].
\:\\{vf\_expand\_local\_fonts}, \[705].
\:\\{vf\_f}, 725, 726.
\:\\{vf\_file}, \[710], 712, 713.
\:\\{vf\_i\_fnts}, 705, 706, \[710], 715, 720, 725, 726.
\:\\{vf\_id}, \[710], 714.
\:\\{vf\_local\_font\_num}, 705, 706, \[710], 715, 719, 720, 726.
\:\\{vf\_local\_font\_warning}, \[712].
\:\\{vf\_max\_packet\_length}, \[710], 717, 719.
\:\\{vf\_max\_recursion}, \[721], 723, 725.
\:\\{vf\_nf}, 706, \[710], 711, 715, 720.
\:\\{vf\_packet\_base}, 706, \[710], 716, 720.
\:\\{vf\_packet\_length}, \[710], 725.
\:\\{vf\_read\_signed}, \[712], 714, 717.
\:\\{vf\_read\_unsigned}, \[712], 715, 717, 719.
\:\\{vf\_replace\_z}, \[706].
\:\\{vf\_stack}, \[723], 726.
\:\\{vf\_stack\_index}, 712, \[722], 723.
\:\\{vf\_stack\_ptr}, \[723], 724, 726.
\:\\{vf\_stack\_record}, \[722], 723.
\:\\{vf\_stack\_size}, 719, \[721], 722.
\:\\{vf\_z}, 706.
\:\9{vfil\_}{\.{\\vfil} primitive}, \[1236].
\:\9{vfil\_neg\_}{\.{\\vfilneg} primitive}, \[1236].
\:\9{vfill\_}{\.{\\vfill} primitive}, \[1236].
\:\\{vfuzz}, \[265], 853, 1189, 1194.
\:\9{vfuzz\_}{\.{\\vfuzz} primitive}, \[266].
\:\\{vfuzz\_code}, \[265], 266.
\:\.{VIRTEX}, 1511.
\:{virtual memory}, 144.
\:\\{virtual\_font\_type}, \[703], 705, 706, 712, 720, 726.
\:{Vitter, Jeffrey Scott}, 280.
\:\\{vlist\_node}, \[155], 166, 177, 193, 201, 202, 220, 224, 531, 646, 650,
651, 656, 657, 659, 660, 665, 668, 732, 733, 737, 741, 742, 746, 751, 816, 825,
844, 845, 857, 889, 891, 896, 912, 923, 926, 983, 985, 987, 1017, 1018, 1042,
1046, 1047, 1145, 1150, 1155, 1177, 1252, 1258, 1265, 1288, 1325, 1637, 1725,
1733.
\:\\{vlist\_out}, 619, 642, 643, 646, 647, 651, 656, \[657], 660, 665, 666,
668, 727, 728, 869, 1620.
\:\\{vmode}, \[229], 233, 442, 443, 444, 448, 450, 527, 951, 961, 962, 980,
983, 984, 985, 988, 1202, 1206, 1223, 1224, 1226, 1234, 1235, 1249, 1250, 1251,
1254, 1256, 1257, 1258, 1261, 1268, 1269, 1272, 1276, 1277, 1281, 1283, 1287,
1288, 1289, 1308, 1345, 1421, 1422, 1560, 1561, 1679, 1681.
\:\\{vmove}, \[226], 1226, 1249, 1250, 1251, 1681.
\:\\{vpack}, 254, 816, 817, 818, \[844], 881, 911, 914, 935, 975, 980, 1154,
1198, 1278, 1346.
\:\\{vpackage}, \[844], 972, 1154, 1194, 1264.
\:\\{vrule}, \[226], 287, 288, 489, 1234, 1262, 1268.
\:\9{vrule\_}{\.{\\vrule} primitive}, \[287].
\:\\{vsize}, \[265], 1157, 1164.
\:\9{vsize\_}{\.{\\vsize} primitive}, \[266].
\:\\{vsize\_code}, \[265], 266.
\:\\{vskip}, \[226], 1224, 1235, 1236, 1237, 1256, 1272.
\:\9{vskip\_}{\.{\\vskip} primitive}, \[1236].
\:\\{vsplit}, 1144, \[1154], 1155, 1157, 1260, 1809, 1825, 1826.
\:\9{vsplit\_}{\.{\\vsplit needs a \\vbox}}, 1155.
\:\9{vsplit\_}{\.{\\vsplit} primitive}, \[1249].
\:\\{vsplit\_code}, \[1249], 1250, 1257, 1515, 1859, 1861, 1862.
\:\\{vsplit\_init}, 1154, \[1825], 1826.
\:\9{vss\_}{\.{\\vss} primitive}, \[1236].
\:\9{vtop\_}{\.{\\vtop} primitive}, \[1249].
\:\\{vtop\_code}, \[1249], 1250, 1261, 1263, 1264.
\:\\{vtop\_group}, \[291], 1261, 1263, 1661, 1679.
\:\|{w}, \[132], \[165], \[174], \[297], \[300], \[301], \[634], \[690], %
\[823], \[844], \[882], \[891], \[914], \[967], \[976], \[1083], \[1171], %
\[1301], \[1316], \[1376], \[1414], \[1480], \[1481], \[1529], \[1530], %
\[1683], \[1719], \[1753], \[1756], \[1774], \[1776], \[1819], \[1839], \[1840].
\:\\{w\_close}, \[28], 1509, 1517.
\:\\{w\_make\_name\_string}, \[551], 1508.
\:\\{w\_open\_in}, \[27], 550.
\:\\{w\_open\_out}, \[27], 1508.
\:\\{wait}, \[1189], 1197, 1198, 1199.
\:\\{wake\_up\_terminal}, \[34], 37, 51, 71, 73, 385, 510, 550, 556, 686, 1472,
1475, 1481, 1513, 1518.
\:\\{warn}, 693.
\:\\{warn\_dest\_dup}, \[1564], 1565, 1637.
\:\\{warn\_pdfpagebox}, \[1550], 1551, 1552.
\:\.{Warning: end of file when...}, 1777.
\:\.{Warning: end of...}, 1774, 1776.
\:\\{warning\_index}, \[327], 353, 360, 415, 416, 421, 422, 424, 427, 497, 499,
505, 508, 950, 953, 1683.
\:\\{warning\_issued}, \[76], 263, 686, 1515, 1774, 1776, 1777.
\:\\{was\_free}, \[183], 185, 189.
\:\\{was\_hi\_min}, \[183], 184, 185, 189.
\:\\{was\_lo\_max}, \[183], 184, 185, 189.
\:\\{was\_mem\_end}, \[183], 184, 185, 189.
\:\9{wd\_}{\.{\\wd} primitive}, \[442].
\:\.{WEB}, 1, 4, 38, 40, 50, 1486.
\:\\{what\_lang}, \[1521], 1603, 1609, 1610, 1624, 1625.
\:\\{what\_lhm}, \[1521], 1603, 1609, 1610, 1624, 1625.
\:\\{what\_rhm}, \[1521], 1603, 1609, 1610, 1624, 1625.
\:\\{whatsit\_node}, \[164], 166, 193, 201, 220, 224, 650, 659, 732, 741, 772,
825, 845, 906, 937, 1005, 1042, 1073, 1076, 1145, 1150, 1177, 1325, 1521, 1529,
1573, 1635, 1637, 1700, 1733.
\:\9{widow\_penalties\_}{\.{\\widowpenalties} primitive}, \[1864].
\:\\{widow\_penalties\_loc}, \[248], 1864, 1865.
\:\\{widow\_penalties\_ptr}, 1067, \[1864].
\:\\{widow\_penalty}, \[254], 990, 1067.
\:\9{widow\_penalty\_}{\.{\\widowpenalty} primitive}, \[256].
\:\\{widow\_penalty\_code}, \[254], 255, 256.
\:\.{width}, 489.
\:\\{width}, \[153], 154, 156, 157, 165, 168, 169, 173, 174, 196, 201, 202,
205, 209, 210, 450, 455, 457, 477, 488, 489, 498, 580, 632, 634, 638, 644, 650,
651, 653, 654, 659, 661, 662, 663, 669, 705, 732, 733, 735, 736, 741, 743, 744,
745, 752, 755, 823, 825, 827, 832, 833, 842, 844, 845, 846, 847, 855, 859, 864,
882, 885, 890, 891, 892, 893, 907, 914, 920, 923, 925, 926, 933, 934, 935, 944,
955, 969, 972, 973, 974, 977, 978, 979, 980, 982, 983, 984, 985, 986, 987,
1003, 1005, 1013, 1014, 1017, 1018, 1042, 1044, 1046, 1047, 1057, 1146, 1153,
1173, 1178, 1181, 1186, 1220, 1222, 1232, 1269, 1271, 1325, 1326, 1377, 1379,
1383, 1407, 1417, 1418, 1548, 1552, 1556, 1565, 1573, 1630, 1637, 1638, 1699,
1714, 1716, 1719, 1720, 1721, 1722, 1725, 1728, 1729, 1734, 1736, 1738, 1740,
1745, 1746, 1780, 1790, 1794, 1795, 1796, 1798, 1853.
\:\\{width\_base}, \[576], 578, 580, 592, 595, 598, 603, 705, 706, 1500, 1501.
\:\\{width\_index}, \[569], 576.
\:\\{width\_offset}, \[153], 442, 443, 1425.
\:{Wirth, Niklaus}, 10.
\:\\{wlog}, \[56], 58, 562, 1513, 1514.
\:\\{wlog\_cr}, \[56], 57, 58, 562, 1513.
\:\\{wlog\_ln}, \[56], 1513, 1514.
\:\\{word\_define}, \[1392], 1406, 1410, 1839.
\:\\{word\_file}, 25, 27, 28, \[131], 551, 1483.
\:\\{word\_node\_size}, \[1820], 1821, 1837, 1841.
\:\\{words}, \[222], 223, 224, 1604, \[1733].
\:\\{wrap\_lig}, \[1087], 1088.
\:\\{wrapup}, \[1212], 1217, 1218.
\:\\{write}, 37, 56, 58, 624.
\:\9{write\_}{\.{\\write} primitive}, \[1524].
\:\\{write\_action}, 782, 1563, 1579, \[1630].
\:\\{write\_dvi}, \[624], 625, 626.
\:\\{write\_file}, 57, 58, \[1522], 1622, 1626.
\:\\{write\_fontstuff}, 801.
\:\\{write\_image}, 778.
\:\\{write\_ln}, 35, 37, 51, 56, 57.
\:\\{write\_loc}, 1491, 1492, 1524, \[1525], 1618.
\:\\{write\_node}, \[1521], 1524, 1526, 1528, 1603, 1604, 1605, 1620, 1622.
\:\\{write\_node\_size}, \[1521], 1530, 1532, 1533, 1534, 1538, 1604, 1605.
\:\\{write\_open}, \[1522], 1523, 1617, 1622, 1626.
\:\\{write\_out}, \[1617], 1622.
\:\\{write\_pdf}, 685.
\:\\{write\_stream}, \[1521], 1530, 1534, 1602, 1617, 1622.
\:\\{write\_stream\_length}, 685.
\:\\{write\_text}, \[329], 336, 345, 1520, 1618.
\:\\{write\_tokens}, 727, \[1521], 1532, 1533, 1534, 1603, 1604, 1605, 1615,
1618.
\:\\{write\_zip}, 685.
\:\\{writing}, \[605].
\:\\{wterm}, \[56], 58, 61.
\:\\{wterm\_cr}, \[56], 57, 58.
\:\\{wterm\_ln}, \[56], 61, 550, 1481, 1512, 1517.
\:{Wyatt, Douglas Kirk}, 2.
\:\\{w0}, 612, \[613], 631, 636, 719, 726.
\:\\{w1}, 612, \[613], 634, 719, 726.
\:\\{w2}, \[612].
\:\\{w3}, \[612].
\:\\{w4}, \[612].
\:\|{x}, \[100], \[105], \[106], \[107], \[119], \[124], \[126], \[127], %
\[614], \[627], \[689], \[823], \[844], \[882], \[896], \[902], \[911], \[913],
\[914], \[919], \[925], \[932], \[1301], \[1316], \[1480], \[1481], \[1552], %
\[1744], \[1793], \[1799].
\:\\{x\_height}, 573, \[584], 585, 673, 914, 1301.
\:\\{x\_height\_code}, \[573], 584.
\:\\{x\_leaders}, \[167], 208, 655, 1249, 1250.
\:\9{x\_leaders\_}{\.{\\xleaders} primitive}, \[1249].
\:\\{x\_over\_n}, \[106], 879, 892, 893, 1163, 1185, 1186, 1187, 1418.
\:\\{x\_token}, 386, \[407], 504, 1215, 1330.
\:\\{xchr}, \[20], 21, 23, 24, 38, 49, 58, 545.
\:\&{xclause}, 16.
\:\9{xdef\_}{\.{\\xdef} primitive}, \[1386].
\:\\{xeq\_level}, \[271], 272, 290, 300, 301, 305, 1482.
\:\\{xn\_over\_d}, \[107], 481, 483, 484, 594, 892, 1222, 1438.
\:\\{xord}, \[20], 24, 31, 52, 53, 549, 551.
\:\\{xpand}, \[499], 503, 505.
\:\\{xr}, 1552.
\:\\{xray}, \[226], 1468, 1469, 1470, 1675, 1684, 1689.
\:\\{xrealloc\_array}, 678, 686, 698, 1505.
\:\\{xref\_offset\_width}, 814, 1513.
\:\\{xspace\_skip}, \[242], 1221.
\:\9{xspace\_skip\_}{\.{\\xspaceskip} primitive}, \[244].
\:\\{xspace\_skip\_code}, \[242], 243, 244, 1221.
\:\\{xxx1}, 612, \[613], 719, 726, 1615.
\:\\{xxx2}, \[612].
\:\\{xxx3}, \[612].
\:\\{xxx4}, 612, \[613], 1615.
\:\\{x0}, 612, \[613], 631, 636, 719, 726.
\:\\{x1}, 612, \[613], 634, 719, 726.
\:\\{x2}, \[612].
\:\\{x3}, \[612].
\:\\{x4}, \[612].
\:\|{y}, \[105], \[119], \[126], \[882], \[902], \[911], \[913], \[914], %
\[919], \[925], \[932], \[1793].
\:\\{y\_here}, \[635], 636, 638, 639, 640.
\:\\{y\_OK}, \[635], 636, 639.
\:\\{y\_seen}, \[638], 639.
\:\\{year}, \[254], 259, 645, 792, 1508.
\:\9{year\_}{\.{\\year} primitive}, \[256].
\:\\{year\_code}, \[254], 255, 256.
\:\.{You already have nine...}, 502.
\:\.{You can't \\insert255}, 1277.
\:\.{You can't dump...}, 1482.
\:\.{You can't use \\hrule...}, 1273.
\:\.{You can't use \\long...}, 1391.
\:\.{You can't use \\unless...}, 1765.
\:\.{You can't use a prefix with x}, 1390.
\:\.{You can't use x after ...}, 454, 1415.
\:\.{You can't use x in y mode}, 1227.
\:\.{You have to increase POOLSIZE}, 52.
\:\.{You want to edit file x}, 84.
\:\\{you\_cant}, \[1227], 1228, 1258, 1284.
\:\\{yr}, 1552.
\:\\{yz\_OK}, \[635], 636, 637, 639.
\:\\{y0}, 612, \[613], 621, 631, 636, 719, 726.
\:\\{y1}, 612, \[613], 634, 640, 719, 726.
\:\\{y2}, \[612], 621.
\:\\{y3}, \[612].
\:\\{y4}, \[612].
\:\|{z}, \[119], \[586], \[882], \[902], \[919], \[925], \[932], \[1099], %
\[1104], \[1130], \[1136], \[1376], \[1744].
\:\\{z\_here}, \[635], 636, 638, 639, 641.
\:\\{z\_OK}, \[635], 636, 639.
\:\\{z\_seen}, \[638], 639.
\:{Zabala Salelles, Ignacio Andr\'es}, 2.
\:\\{zero\_glue}, \[180], 193, 242, 246, 450, 453, 488, 908, 978, 1005, 1063,
1219, 1220, 1221, 1349, 1407, 1740, 1782, 1790, 1809, 1820, 1821.
\:\\{zero\_token}, \[471], 478, 499, 502, 505.
\:\\{zip\_finish}, \[680], 685.
\:\\{zip\_write\_state}, 679, \[680], 681, 685.
\:\\{zip\_writing}, \[680], 685.
\:\\{z0}, 612, \[613], 631, 636, 719, 726.
\:\\{z1}, 612, \[613], 634, 641, 719, 726.
\:\\{z2}, \[612].
\:\\{z3}, \[612].
\:\\{z4}, \[612].
\fin
\:\X744:(\pdfTeX) Move down or output leaders\X
\U741.
\:\X735:(\pdfTeX) Move right or output leaders\X
\U732.
\:\X742:(\pdfTeX) Output a box in a vlist\X
\U741.
\:\X733:(\pdfTeX) Output a box in an hlist\X
\U732.
\:\X737:(\pdfTeX) Output a leader box at \\{cur\_h}, then advance \\{cur\_h} by
$\\{leader\_wd}+\\{lx}$\X
\U736.
\:\X746:(\pdfTeX) Output a leader box at \\{cur\_v}, then advance \\{cur\_v} by
$\\{leader\_ht}+\\{lx}$\X
\U745.
\:\X743:(\pdfTeX) Output a rule in a vlist, \&{goto} \\{next\_p}\X
\U741.
\:\X734:(\pdfTeX) Output a rule in an hlist\X
\U732.
\:\X745:(\pdfTeX) Output leaders in a vlist, \&{goto} \\{fin\_rule} if a rule
or to \\{next\_p} if done\X
\U744.
\:\X736:(\pdfTeX) Output leaders in an hlist, \&{goto} \\{fin\_rule} if a rule
or to \\{next\_p} if done\X
\U735.
\:\X751:(\pdfTeX) Ship box \|p out\X
\U750.
\:\X471:Accumulate the constant until \\{cur\_tok} is not a suitable digit\X
\U470.
\:\X1047:Add the width of node \|s to \\{act\_width}\X
\U1045.
\:\X1018:Add the width of node \|s to \\{break\_width}\X
\U1016.
\:\X1046:Add the width of node \|s to \\{disc\_width}\X
\U1045.
\:\X483:Adjust \(f)for the magnification ratio\X
\U479.
\:\X1392:Adjust \(f)for the setting of \.{\\globaldefs}\X
\U1389.
\:\X922:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of a fraction
line\X
\U919.
\:\X921:Adjust \(s)\\{shift\_up} and \\{shift\_down} for the case of no
fraction line\X
\U919.
\:\X1717:Adjust \(t)the LR stack for the \\{hlist\_out} routine; if necessary
reverse an hlist segment and \&{goto} \\{reswitch}\X
\U1716.
\:\X1711:Adjust \(t)the LR stack for the \\{hpack} routine\X
\U825.
\:\X1737:Adjust \(t)the LR stack for the \\{init\_math} routine\X
\U1736.
\:\X1739:Adjust \(t)the LR stack for the \\{just\_reverse} routine\X
\U1738.
\:\X1708:Adjust \(t)the LR stack for the \\{post\_line\_break} routine\X
\Us1055, 1057\ETs1707.
\:\X1849:Adjust \(t)the additional data for last line\X
\U1027.
\:\X1853:Adjust \(t)the final line of the paragraph\X
\U1039.
\:\X758:Adjust transformation matrix for the magnification ratio\X
\U757.
\:\X1043:Advance \(c)\\{cur\_p} to the node following the present string of
characters\X
\U1042.
\:\X1609:Advance \(p)past a whatsit node in the \(l)\\{line\_break} loop\X
\U1042.
\:\X1610:Advance \(p)past a whatsit node in the \(p)pre-hyphenation loop\X
\U1073.
\:\X420:Advance \(r)\|r; \&{goto} \\{found} if the parameter delimiter has been
fully matched, otherwise \&{goto} \\{continue}\X
\U418.
\:\X147:Allocate entire node \|p and \&{goto} \\{found}\X
\U145.
\:\X146:Allocate from the top of node \|p and \&{goto} \\{found}\X
\U145.
\:\X716:Allocate memory for the new virtual font\X
\U712.
\:\X1284:Apologize for inability to do the operation now, unless \.{\\unskip}
follows non-glue\X
\U1283.
\:\X593:Apologize for not loading the font, \&{goto} \\{done}\X
\U592.
\:\X1087:Append a ligature and/or kern to the translation; \&{goto} %
\\{continue} if the stack of inserted ligatures is nonempty\X
\U1083.
\:\X1256:Append a new leader node that uses \\{cur\_box}\X
\U1253.
\:\X1139:Append a new letter or a hyphen level\X
\U1138.
\:\X1114:Append a new letter or hyphen\X
\U1112.
\:\X1219:Append a normal inter-word space to the current list, then \&{goto} %
\\{big\_switch}\X
\U1207.
\:\X1067:Append a penalty node, if a nonzero penalty is appropriate\X
\U1056.
\:\X1185:Append an insertion to the current page and \&{goto} \\{contribute}\X
\U1177.
\:\X943:Append any \\{new\_hlist} entries for \|q, and any appropriate
penalties\X
\U936.
\:\X1254:Append box \\{cur\_box} to the current list, shifted by \\{box%
\_context}\X
\U1253.
\:\X1211:Append character \\{cur\_chr} and the following characters (if~any) to
the current hlist in the current font; \&{goto} \\{reswitch} when a
non-character has been fetched\X
\U1207.
\:\X1094:Append characters of $\\{hu}[\|j\to\,]$ to \\{major\_tail}, advancing~%
\|j\X
\U1093.
\:\X942:Append inter-element spacing based on \\{r\_type} and \|t\X
\U936.
\:\X985:Append tabskip glue and an empty box to list \|u, and update \|s and %
\|t as the prototype nodes are passed\X
\U984.
\:\X1303:Append the accent with appropriate kerns, then set $\|p\K\|q$\X
\U1301.
\:\X954:Append the current tabskip glue to the preamble list\X
\U953.
\:\X1382:Append the display and perhaps also the equation number\X
\U1377.
\:\X1383:Append the glue or equation number following the display\X
\U1377.
\:\X1381:Append the glue or equation number preceding the display\X
\U1377.
\:\X1065:Append the new box to the current vertical list, followed by the list
of special nodes taken out of the box by the packager\X
\U1056.
\:\X1115:Append the value \|n to list \|p\X
\U1114.
\:\X254:Assign the values $\\{depth\_threshold}\K\\{show\_box\_depth}$ and $%
\\{breadth\_max}\K\\{show\_box\_breadth}$\X
\U216.
\:\X1395, 1396, 1399, 1402, 1403, 1404, 1406, 1410, 1412, 1413, 1419, 1420,
1426, 1430, 1431, 1434, 1442:Assignments\X
\U1389.
\:\X1298:Attach list \|p to the current list, and record its length; then
finish up and \&{return}\X
\U1297.
\:\X927:Attach the limits to \|y and adjust $\\{height}(\|v)$, $\\{depth}(\|v)$
to account for their presence\X
\U926.
\:\X359:Back up an outer control sequence so that it can be reread\X
\U358.
\:\X57, 58, 59, 60, 62, 63, 64, 65, 284, 285, 544, 875, 1602, 1822:Basic
printing procedures\X
\U4.
\:\X1194:Break the current page at node \|p, put it in box~255, and put the
remaining nodes on the contribution list\X
\U1191.
\:\X1052:Break the paragraph at the chosen breakpoints, justify the resulting
lines to the correct widths, and append them to the current vertical list\X
\U991.
\:\X717:Build a character packet\X
\U712.
\:\X812:Build a linked list of free objects\X
\Us813\ET814.
\:\X644:Calculate DVI page dimensions and margins\X
\U645.
\:\X755:Calculate page dimensions and margins\X
\U752.
\:\X1327:Calculate the length, \|l, and the shift amount, \|s, of the display
lines\X
\U1323.
\:\X1324:Calculate the natural width, \|w, by which the characters of the final
line extend to the right of the reference point, plus two ems; or set $\|w\K%
\\{max\_dimen}$ if the non-blank information on that line is affected by
stretching or shrinking\X
\U1323.
\:\X822:Calculate variations of marginal kerns\X
\U1027.
\:\X1066:Call the packaging subroutine, setting \\{just\_box} to the justified
box\X
\U1056.
\:\X1042:Call \\{try\_break} if \\{cur\_p} is a legal breakpoint; on the second
pass, also try to hyphenate the next word, if \\{cur\_p} is a glue node; then
advance \\{cur\_p} to the next node of the paragraph that could possibly be a
legal breakpoint\X
\U1039.
\:\X1088:Carry out a ligature replacement, updating the cursor structure and
possibly advancing~\|j; \&{goto} \\{continue} if the cursor doesn't advance,
otherwise \&{goto} \\{done}\X
\U1086.
\:\X224:Case statement to copy different types and set \\{words} to the number
of initial words not yet copied\X
\U223.
\:\X1694:Cases for `Fetch the \\{dead\_cycles} or the \\{insert\_penalties}'\X
\U445.
\:\X1791, 1795, 1796, 1798:Cases for evaluation of the current term\X
\U1783.
\:\X1671, 1674, 1804:Cases for fetching a dimension value\X
\U450.
\:\X1807:Cases for fetching a glue value\X
\U1780.
\:\X1808:Cases for fetching a mu value\X
\U1780.
\:\X1651, 1665, 1668, 1803:Cases for fetching an integer value\X
\U450.
\:\X909:Cases for noads that can follow a \\{bin\_noad}\X
\U904.
\:\X906:Cases for nodes that can appear in an mlist, after which we \&{goto} %
\\{done\_with\_node}\X
\U904.
\:\X1696:Cases for \\{alter\_integer}\X
\U1424.
\:\X1766, 1767, 1769:Cases for \\{conditional}\X
\U527.
\:\X1826, 1828, 1829, 1831:Cases for \\{do\_marks}\X
\U1825.
\:\X1834:Cases for \\{eq\_destroy}\X
\U297.
\:\X1749:Cases for \\{input}\X
\U404.
\:\X1659, 1700:Cases for \\{print\_param}\X
\U255.
\:\X1677, 1691:Cases for \\{show\_whatever}\X
\U1471.
\:\X719:Cases of \.{DVI} commands that can appear in character packet\X
\U717.
\:\X1736:Cases of `Let \|d be the natural width' that need special treatment\X
\U1325.
\:\X1658:Cases of \\{assign\_toks} for \\{print\_cmd\_chr}\X
\U249.
\:\X1763:Cases of \\{expandafter} for \\{print\_cmd\_chr}\X
\U288.
\:\X874:Cases of \\{flush\_node\_list} that arise in mlists only\X
\U220.
\:\X1263, 1278, 1296, 1310, 1311, 1346, 1351, 1364:Cases of \\{handle\_right%
\_brace} where a \\{right\_brace} triggers a delayed action\X
\U1246.
\:\X1720:Cases of \\{hlist\_out} that arise in mixed direction text only\X
\Us650\ET732.
\:\X1764:Cases of \\{if\_test} for \\{print\_cmd\_chr}\X
\U514.
\:\X1748:Cases of \\{input} for \\{print\_cmd\_chr}\X
\U403.
\:\X1650, 1664, 1667, 1670, 1673, 1779, 1802, 1806:Cases of \\{last\_item} for %
\\{print\_cmd\_chr}\X
\U443.
\:\X1698:Cases of \\{left\_right} for \\{print\_cmd\_chr}\X
\U1367.
\:\X1703:Cases of \\{main\_control} for $\\{hmode}+\\{valign}$\X
\U1308.
\:\X1527:Cases of \\{main\_control} that are for extensions to \TeX\X
\U1223.
\:\X1223:Cases of \\{main\_control} that are not part of the inner loop\X
\U1207.
\:\X1234, 1235, 1241, 1245, 1251, 1268, 1270, 1272, 1275, 1280, 1282, 1287,
1290, 1294, 1300, 1304, 1308, 1312, 1315, 1318, 1328, 1332, 1336, 1340, 1342,
1345, 1349, 1353, 1358, 1368, 1371:Cases of \\{main\_control} that build boxes
and lists\X
\U1223.
\:\X1388, 1446, 1449, 1452, 1454, 1463, 1468:Cases of \\{main\_control} that
don't depend on \\{mode}\X
\U1223.
\:\X1771:Cases of \\{prefix} for \\{print\_cmd\_chr}\X
\U1387.
\:\X245, 249, 257, 267, 288, 357, 403, 411, 438, 443, 495, 514, 518, 957, 1161,
1231, 1237, 1250, 1267, 1286, 1293, 1321, 1335, 1348, 1357, 1367, 1387, 1398,
1401, 1409, 1429, 1433, 1439, 1441, 1451, 1456, 1465, 1470, 1473, 1526:Cases of
\\{print\_cmd\_chr} for symbolic printing of primitives\X
\U320.
\:\X1760:Cases of \\{read} for \\{print\_cmd\_chr}\X
\U288.
\:\X1832:Cases of \\{register} for \\{print\_cmd\_chr}\X
\U438.
\:\X1726, 1727, 1728:Cases of \\{reverse} that need special treatment\X
\U1725.
\:\X1693:Cases of \\{set\_page\_int} for \\{print\_cmd\_chr}\X
\U443.
\:\X1865:Cases of \\{set\_shape} for \\{print\_cmd\_chr}\X
\U288.
\:\X866:Cases of \\{show\_node\_list} that arise in mlists only\X
\U201.
\:\X1687:Cases of \\{the} for \\{print\_cmd\_chr}\X
\U288.
\:\X1833:Cases of \\{toks\_register} for \\{print\_cmd\_chr}\X
\U288.
\:\X1862:Cases of \\{un\_vbox} for \\{print\_cmd\_chr}\X
\U1286.
\:\X1702:Cases of \\{valign} for \\{print\_cmd\_chr}\X
\U288.
\:\X1676, 1685, 1690:Cases of \\{xray} for \\{print\_cmd\_chr}\X
\U1470.
\:\X367:Cases where character is ignored\X
\U366.
\:\X640:Change buffered instruction to \|y or \|w and \&{goto} \\{found}\X
\U639.
\:\X641:Change buffered instruction to \|z or \|x and \&{goto} \\{found}\X
\U639.
\:\X951:Change current mode to $-\\{vmode}$ for \.{\\halign}, $-\\{hmode}$ for %
\.{\\valign}\X
\U950.
\:\X1058:Change discretionary to compulsory and set $\\{disc\_break}\K\\{true}$%
\X
\U1057.
\:\X649:Change font \\{dvi\_f} to \|f\X
\U648.
\:\X366:Change state if necessary, and \&{goto} \\{switch} if the current
character should be ignored, or \&{goto} \\{reswitch} if the current character
changes to another\X
\U365.
\:\X1467:Change the case of the token in \|p, if a change is appropriate\X
\U1466.
\:\X939:Change the current style and \&{goto} \\{delete\_q}\X
\U937.
\:\X86:Change the interaction level and \&{return}\X
\U84.
\:\X907:Change this node to a style node followed by the correct choice, then %
\&{goto} \\{done\_with\_node}\X
\U906.
\:\X49:Character \|k cannot be printed\X
\U48.
\:\X262:Character \|s is the current new-line character\X
\Us58\ET59.
\:\X188:Check flags of unavailable nodes\X
\U185.
\:\X1718:Check for LR anomalies at the end of \\{hlist\_out}\X
\U1715.
\:\X1712:Check for LR anomalies at the end of \\{hpack}\X
\U823.
\:\X1730:Check for LR anomalies at the end of \\{ship\_out}\X
\Us666\ET750.
\:\X596:Check for charlist cycle\X
\U595.
\:\X952:Check for improper alignment in displayed math\X
\U950.
\:\X796:Check for non-existing destinations\X
\U794.
\:\X799:Check for non-existing pages\X
\U794.
\:\X798:Check for non-existing structure destinations\X
\U794.
\:\X1843:Check for special treatment of last line of paragraph\X
\U1003.
\:\X1151:Check if node \|p is a new champion breakpoint; then \(go)\&{goto} %
\\{done} if \|p is a forced break or if the page-so-far is already too full\X
\U1149.
\:\X1182:Check if node \|p is a new champion breakpoint; then \(if)if it is
time for a page break, prepare for output, and either fire up the user's output
routine and \&{return} or ship out the page and \&{goto} \\{done}\X
\U1174.
\:\X186:Check single-word \\{avail} list\X
\U185.
\:\X1375:Check that another \.\$ follows\X
\Us1372, 1372\ETs1384.
\:\X1373:Check that the necessary fonts for math symbols are present; if not,
flush the current math lists and set $\\{danger}\K\\{true}$\X
\Us1372\ET1372.
\:\X1076:Check that the nodes following \\{hb} permit hyphenation and that at
least $\\{l\_hyf}+\\{r\_hyf}$ letters have been found, otherwise \&{goto} %
\\{done1}\X
\U1071.
\:\X14, 129, 312, 548, 1427:Check the ``constant'' values for consistency\X
\U1512.
\:\X53:Check the pool check sum\X
\U52.
\:\X187:Check variable-size \\{avail} list\X
\U185.
\:\X1041:Clean up the memory by removing the break nodes\X
\Us991\ET1039.
\:\X824:Clear dimensions to zero\X
\Us823\ET844.
\:\X304:Clear off top level from \\{save\_stack}\X
\U303.
\:\X1509:Close the format file\X
\U1480.
\:\X477:Coerce glue to a dimension\X
\Us475\ET481.
\:\X9:Compiler directives\X
\U4.
\:\X899:Complain about an undefined family and set \\{cur\_i} null\X
\U898.
\:\X396:Complain about an undefined macro\X
\U391.
\:\X399:Complain about missing \.{\\endcsname}\X
\Us398\ET1767.
\:\X485:Complain about unknown unit and \&{goto} \\{done2}\X
\U484.
\:\X454:Complain that \.{\\the} can't do this; give zero result\X
\U439.
\:\X1344:Complain that the user should have said \.{\\mathaccent}\X
\U1343.
\:\X1363:Compleat the incompleat noad\X
\U1362.
\:\X1476:Complete a potentially long \.{\\show} command\X
\U1471.
\:\X113:Compute $f=\lfloor 2^{28}(1+p/q)+{1\over2}\rfloor$\X
\U112.
\:\X116:Compute $p=\lfloor qf/2^{28}+{1\over2}\rfloor-q$\X
\U114.
\:\X1800:Compute \(f)$f=\lfloor xn/d+{1\over2}\rfloor$\X
\U1799.
\:\X1418:Compute result of \\{multiply} or \\{divide}, put it in \\{cur\_val}\X
\U1414.
\:\X1416:Compute result of \\{register} or \\{advance}, put it in \\{cur\_val}\X
\U1414.
\:\X917:Compute the amount of skew\X
\U914.
\:\X1184:Compute the badness, \|b, of the current page, using \\{awful\_bad} if
the box is too full\X
\U1182.
\:\X1152:Compute the badness, \|b, using \\{awful\_bad} if the box is too full\X
\U1151.
\:\X1035:Compute the demerits, \|d, from \|r to \\{cur\_p}\X
\U1031.
\:\X1016:Compute the discretionary \\{break\_width} values\X
\U1013.
\:\X280:Compute the hash code \|h\X
\U278.
\:\X941:Compute the magic offset\X
\U1517.
\:\X1824:Compute the mark pointer for mark type \|t and class \\{cur\_val}\X
\U412.
\:\X890:Compute the minimum suitable height, \|w, and the corresponding number
of extension steps, \|n; also set $\\{width}(\|b)$\X
\U889.
\:\X1026:Compute the new line width\X
\U1011.
\:\X283:Compute the primitive code \|h\X
\U281.
\:\X1415:Compute the register location \|l and its type \|p; but \&{return} if
invalid\X
\U1414.
\:\X1417:Compute the sum of two glue specs\X
\U1416.
\:\X1794:Compute the sum or difference of two glue specs\X
\U1792.
\:\X1142:Compute the trie op code, \|v, and set $\|l\K0$\X
\U1140.
\:\X1013:Compute the values of \\{break\_width}\X
\U1012.
\:\X639:Consider a node with matching width; \&{goto} \\{found} if it's a hit\X
\U638.
\:\X1027:Consider the demerits for a line from \|r to \\{cur\_p}; deactivate
node \|r if it should no longer be active; then \&{goto} \\{continue} if a line
from \|r to \\{cur\_p} is infeasible, otherwise record a new feasible break\X
\U1005.
\:\X11, 675, 679, 695, 721, 1631:Constants in the outer block\X
\U4.
\:\X926:Construct a box with limits above and below it, skewed by \\{delta}\X
\U925.
\:\X935:Construct a sub/superscript combination box \|x, with the superscript
offset by \\{delta}\X
\U932.
\:\X933:Construct a subscript box \|x when there is no superscript\X
\U932.
\:\X934:Construct a superscript box \|x\X
\U932.
\:\X923:Construct a vlist box for the fraction, according to \\{shift\_up} and %
\\{shift\_down}\X
\U919.
\:\X889:Construct an extensible character in a new box \|b, using recipe $%
\\{rem\_byte}(\|q)$ and font \|f\X
\U886.
\:\X425:Contribute an entire group to the current parameter\X
\U418.
\:\X423:Contribute the recently matched tokens to the current parameter, and %
\&{goto} \\{continue} if a partial match is still in effect; but abort if $\|s=%
\\{null}$\X
\U418.
\:\X905:Convert \(a)a final \\{bin\_noad} to an \\{ord\_noad}\X
\Us902\ET904.
\:\X455:Convert \(c)\\{cur\_val} to a lower level\X
\U439.
\:\X908:Convert \(m)math glue to ordinary glue\X
\U906.
\:\X930:Convert \(n)$\\{nucleus}(\|q)$ to an hlist and attach the
sub/superscripts\X
\U904.
\:\X1754:Convert string \|s into a new pseudo file\X
\U1753.
\:\X971:Copy the tabskip glue between columns\X
\U967.
\:\X970:Copy the templates from node \\{cur\_loop} into node \|p\X
\U969.
\:\X492:Copy the token list\X
\U491.
\:\X931:Create a character node \|p for $\\{nucleus}(\|q)$, possibly followed
by a kern node for the italic correction, and set \\{delta} to the italic
correction if a subscript is present\X
\U930.
\:\X1302:Create a character node \|q for the next character, but set $\|q\K%
\\{null}$ if problems arise\X
\U1301.
\:\X1820:Create a new array element of type \|t with index \|i\X
\U1819.
\:\X488:Create a new glue specification whose width is \\{cur\_val}; scan for
its stretch and shrink components\X
\U487.
\:\X1186:Create a page insertion node with $\\{subtype}(\|r)=\\{qi}(\|n)$, and
include the glue correction for box \|n in the current page state\X
\U1185.
\:\X1040:Create an active breakpoint representing the beginning of the
paragraph\X
\U1039.
\:\X1091:Create and append a discretionary node as an alternative to the
unhyphenated word, and continue to develop both branches until they become
equivalent\X
\U1090.
\:\X920:Create equal-width boxes \|x and \|z for the numerator and denominator,
and compute the default amounts \\{shift\_up} and \\{shift\_down} by which they
are displaced from the baseline\X
\U919.
\:\X730:Create link annotations for the current hbox if needed\X
\U729.
\:\X1012:Create new active nodes for the best feasible breaks just found\X
\U1011.
\:\X1508:Create the \\{format\_ident}, open the format file, and inform the
user that dumping has begun\X
\U1480.
\:\X739:Create thread for the current vbox if needed\X
\U738.
\:\X242:Current \\{mem} equivalent of glue parameter number \|n\X
\Us170\ET172.
\:\X1036:Deactivate node \|r\X
\U1027.
\:\X1752, 1810, 1815, 1819:Declare \eTeX\ procedures for expanding\X
\U388.
\:\X1682, 1772, 1781, 1786:Declare \eTeX\ procedures for scanning\X
\U435.
\:\X1683, 1753:Declare \eTeX\ procedures for token lists\X
\U490.
\:\X306, 1661, 1662, 1756, 1757, 1774, 1776, 1777, 1821, 1823, 1837, 1838,
1839, 1840, 1841:Declare \eTeX\ procedures for tracing and input\X
\U290.
\:\X1656, 1679, 1695:Declare \eTeX\ procedures for use by \\{main\_control}\X
\U991.
\:\X1221, 1225, 1227, 1228, 1229, 1232, 1238, 1239, 1242, 1247, 1248, 1253,
1257, 1262, 1264, 1269, 1271, 1273, 1274, 1277, 1279, 1281, 1283, 1288, 1291,
1295, 1297, 1301, 1305, 1307, 1309, 1313, 1314, 1316, 1320, 1329, 1333, 1337,
1338, 1341, 1343, 1350, 1352, 1354, 1359, 1369, 1372, 1378, 1389, 1448, 1453,
1457, 1466, 1471, 1480, 1528, 1624:Declare action procedures for use by \\{main%
\_control}\X
\U1207.
\:\X910, 911, 912, 913, 914, 919, 925, 928, 932, 938:Declare math construction
procedures\X
\U902.
\:\X1121, 1125, 1126, 1130, 1134, 1136, 1137, 1143:Declare procedures for
preprocessing hyphenation patterns\X
\U1119.
\:\X867, 868, 870:Declare procedures needed for displaying the elements of
mlists\X
\U197.
\:\X1782, 1787:Declare procedures needed for expressions\X
\U487.
\:\X1529, 1530, 1537, 1552, 1556, 1562, 1566, 1573, 1577, 1587, 1600:Declare
procedures needed in \\{do\_extension}\X
\U1528.
\:\X1615, 1617, 1620, 1719, 1723:Declare procedures needed in \\{hlist\_out}, %
\\{vlist\_out}\X
\U647.
\:\X727, 772, 778, 785, 1564, 1630, 1635, 1636, 1637:Declare procedures needed
in \\{pdf\_hlist\_out}, \\{pdf\_vlist\_out}\X
\U729.
\:\X686, 689, 698, 699, 700, 703, 1545, 1555:Declare procedures that need to be
declared forward for \pdfTeX\X
\U190.
\:\X604, 605:Declare procedures that scan font-related stuff\X
\U435.
\:\X459, 460, 461, 462, 463, 1811:Declare procedures that scan restricted
classes of integers\X
\U435.
\:\X1744:Declare subprocedures for \\{after\_math}\X
\U1372.
\:\X1733, 1738:Declare subprocedures for \\{init\_math}\X
\U1316.
\:\X1002, 1005, 1053, 1072, 1119:Declare subprocedures for \\{line\_break}\X
\U991.
\:\X1393, 1407, 1414, 1421, 1422, 1423, 1424, 1425, 1435, 1443:Declare
subprocedures for \\{prefixed\_command}\X
\U1389.
\:\X1793, 1797, 1799:Declare subprocedures for \\{scan\_expr}\X
\U1782.
\:\X885, 887, 888:Declare subprocedures for \\{var\_delimiter}\X
\U882.
\:\X1825:Declare the function called \\{do\_marks}\X
\U1154.
\:\X1362:Declare the function called \\{fin\_mlist}\X
\U1352.
\:\X550:Declare the function called \\{open\_fmt\_file}\X
\U1481.
\:\X1083:Declare the function called \\{reconstitute}\X
\U1072.
\:\X961:Declare the procedure called \\{align\_peek}\X
\U976.
\:\X1189:Declare the procedure called \\{fire\_up}\X
\U1171.
\:\X958:Declare the procedure called \\{get\_preamble\_token}\X
\U950.
\:\X1246:Declare the procedure called \\{handle\_right\_brace}\X
\U1207.
\:\X963:Declare the procedure called \\{init\_span}\X
\U962.
\:\X405:Declare the procedure called \\{insert\_relax}\X
\U388.
\:\X415:Declare the procedure called \\{macro\_call}\X
\U388.
\:\X320:Declare the procedure called \\{print\_cmd\_chr}\X
\U270.
\:\X243:Declare the procedure called \\{print\_skip\_param}\X
\U197.
\:\X328:Declare the procedure called \\{runaway}\X
\U137.
\:\X314:Declare the procedure called \\{show\_token\_list}\X
\U137.
\:\X368:Decry the invalid character and \&{goto} \\{restart}\X
\U366.
\:\X88:Delete \(c)$\|c-\.{"0"}$ tokens and \&{goto} \\{continue}\X
\U84.
\:\X1196:Delete \(t)the page-insertion nodes\X
\U1191.
\:\X1059:Destroy the \|t nodes following \|q, and make \|r point to the
following node\X
\U1058.
\:\X840:Determine horizontal glue shrink setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X
\U833.
\:\X834:Determine horizontal glue stretch setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X
\U833.
\:\X1380:Determine the displacement, \|d, of the left edge of the equation,
with respect to the line size \|z, assuming that $\|l=\\{false}$\X
\U1377.
\:\X841:Determine the shrink order\X
\Us840, 852\ETs972.
\:\X835:Determine the stretch order\X
\Us834, 849\ETs972.
\:\X848:Determine the value of $\\{height}(\|r)$ and the appropriate glue
setting; then \&{return} or \&{goto} \\{common\_ending}\X
\U844.
\:\X833:Determine the value of $\\{width}(\|r)$ and the appropriate glue
setting; then \&{return} or \&{goto} \\{common\_ending}\X
\U823.
\:\X852:Determine vertical glue shrink setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X
\U848.
\:\X849:Determine vertical glue stretch setting, then \&{return} or \hbox{%
\&{goto} \\{common\_ending}}\X
\U848.
\:\X1390:Discard erroneous prefixes and \&{return}\X
\U1389.
\:\X1391:Discard the prefixes \.{\\long} and \.{\\outer} if they are irrelevant%
\X
\U1389.
\:\X1155:Dispense with trivial cases of void or bad boxes\X
\U1154.
\:\X1601:Display <rule spec> for whatsit node created by \pdfTeX\X
\Us1603, 1603\ETs1603.
\:\X215:Display adjustment \|p\X
\U201.
\:\X202:Display box \|p\X
\U201.
\:\X871:Display choice node \|p\X
\U866.
\:\X213:Display discretionary \|p\X
\U201.
\:\X873:Display fraction noad \|p\X
\U866.
\:\X207:Display glue \|p\X
\U201.
\:\X1704:Display if this box is never to be reversed\X
\U202.
\:\X206:Display insertion \|p\X
\U201.
\:\X209:Display kern \|p\X
\U201.
\:\X208:Display leaders \|p\X
\U207.
\:\X211:Display ligature \|p\X
\U201.
\:\X214:Display mark \|p\X
\U201.
\:\X210:Display math node \|p\X
\U201.
\:\X201:Display node \|p\X
\U200.
\:\X872:Display normal noad \|p\X
\U866.
\:\X212:Display penalty \|p\X
\U201.
\:\X205:Display rule \|p\X
\U201.
\:\X203:Display special fields of the unset node \|p\X
\U202.
\:\X334:Display the current context\X
\U333.
\:\X1188:Display the insertion split cost\X
\U1187.
\:\X1183:Display the page break cost\X
\U1182.
\:\X316:Display the token $(\|m,\|c)$\X
\U315.
\:\X528:Display the value of \|b\X
\U524.
\:\X204:Display the value of $\\{glue\_set}(\|p)$\X
\U202.
\:\X1603:Display the whatsit node \|p\X
\U201.
\:\X315:Display token \|p, and \&{return} if there are problems\X
\U314.
\:\X904:Do first-pass processing based on $\\{type}(\|q)$; \&{goto} \\{done%
\_with\_noad} if a noad has been fully processed, \&{goto} \\{check%
\_dimensions} if it has been translated into $\\{new\_hlist}(\|q)$, or \&{goto}
\\{done\_with\_node} if a node has been fully processed\X
\U903.
\:\X1218:Do ligature or kern command, returning to \\{main\_lig\_loop} or %
\\{main\_loop\_wrapup} or \\{main\_loop\_move}\X
\U1216.
\:\X342:Do magic computation\X
\U314.
\:\X1622:Do some work that has been queued up for \.{\\write}\X
\U1620.
\:\X726:Do typesetting the \.{DVI} commands in virtual character packet\X
\U725.
\:\X1244:Drop current token and complain that it was unmatched\X
\U1242.
\:\X1506:Dump a couple more things and the closing check word\X
\U1480.
\:\X1485:Dump constants for consistency check\X
\U1480.
\:\X1504:Dump pdftex data\X
\U1480.
\:\X1493:Dump regions 1 to 4 of \\{eqtb}\X
\U1491.
\:\X1494:Dump regions 5 and 6 of \\{eqtb}\X
\U1491.
\:\X1654, 1758:Dump the \eTeX\ state\X
\U1485.
\:\X1500:Dump the array info for internal font number \|k\X
\U1498.
\:\X1489:Dump the dynamic memory\X
\U1480.
\:\X1498:Dump the font information\X
\U1480.
\:\X1496:Dump the hash table\X
\U1491.
\:\X1502:Dump the hyphenation tables\X
\U1480.
\:\X1487:Dump the string pool\X
\U1480.
\:\X1491:Dump the table of equivalents\X
\U1480.
\:\X1199:Either append the insertion node \|p after node \|q, and remove it
from the current page, or delete $\\{node}(\|p)$\X
\U1197.
\:\X1197:Either insert the material specified by node \|p into the appropriate
box, or hold it for the next page; also delete node \|p from the current page\X
\U1191.
\:\X527:Either process \.{\\ifcase} or set \|b to the value of a boolean
condition\X
\U524.
\:\X626:Empty the last bytes out of \\{dvi\_buf}\X
\U670.
\:\X1648:Enable \eTeX, if requested\X
\U1517.
\:\X1205:Ensure that box 255 is empty after output\X
\U1203.
\:\X1192:Ensure that box 255 is empty before output\X
\U1191.
\:\X1131:Ensure that $\\{trie\_max}\G\|h+256$\X
\U1130.
\:\X1116:Enter a hyphenation exception\X
\U1112.
\:\X1138:Enter all of the patterns into a linked trie, until coming to a right
brace\X
\U1137.
\:\X1112:Enter as many hyphenation exceptions as are listed, until coming to a
right brace; then \&{return}\X
\U1111.
\:\X371:Enter \\{skip\_blanks} state, emit a space\X
\U369.
\:\X78, 81, 82, 93, 94, 95:Error handling procedures\X
\U4.
\:\X1792:Evaluate the current expression\X
\U1783.
\:\X825:Examine node \|p in the hlist, taking account of its effect on the
dimensions of the new box, or moving it to the adjustment list; then advance %
\|p to the next node\X
\U823.
\:\X845:Examine node \|p in the vlist, taking account of its effect on the
dimensions of the new box; then advance \|p to the next node\X
\U844.
\:\X391:Expand a nonmacro\X
\U388.
\:\X1618:Expand macros in the token list and make $\\{link}(\\{def\_ref})$
point to the result\X
\Us727, 727, 1615\ETs1617.
\:\X504:Expand the next part of the input\X
\U503.
\:\X392:Expand the token after the next token\X
\U391.
\:\X1201:Explain that too many dead cycles have occurred in a row\X
\U1189.
\:\X472:Express astonishment that no number was here\X
\U470.
\:\X1306:Express consternation over the fact that no alignment is in progress\X
\U1305.
\:\X501:Express shock at the missing left brace; \&{goto} \\{found}\X
\U500.
\:\X416:Feed the macro body and its parameters to the scanner\X
\U415.
\:\X446:Fetch a box dimension\X
\U439.
\:\X440:Fetch a character code from some table\X
\U439.
\:\X451:Fetch a font dimension\X
\U439.
\:\X452:Fetch a font integer\X
\U439.
\:\X1866:Fetch a penalties array element\X
\U449.
\:\X453:Fetch a register\X
\U439.
\:\X441:Fetch a token list or font identifier, provided that $\\{level}=\\{tok%
\_val}$\X
\U439.
\:\X475:Fetch an internal dimension and \&{goto} \\{attach\_sign}, or fetch an
internal integer\X
\U474.
\:\X450:Fetch an item in the current node, if appropriate\X
\U439.
\:\X447:Fetch something on the \\{page\_so\_far}\X
\U439.
\:\X445:Fetch the \\{dead\_cycles} or the \\{insert\_penalties}\X
\U439.
\:\X449:Fetch the \\{par\_shape} size\X
\U439.
\:\X448:Fetch the \\{prev\_graf}\X
\U439.
\:\X444:Fetch the \\{space\_factor} or the \\{prev\_depth}\X
\U439.
\:\X1050:Find an active node with fewest demerits\X
\U1049.
\:\X1100:Find hyphen locations for the word in \\{hc}, or \&{return}\X
\U1072.
\:\X1039:Find optimal breakpoints\X
\U991.
\:\X1051:Find the best active node for the desired looseness\X
\U1049.
\:\X1187:Find the best way to split the insertion, and change $\\{type}(\|r)$
to \\{split\_up}\X
\U1185.
\:\X1220:Find the glue specification, \\{main\_p}, for text spaces in the
current font\X
\Us1219\ET1221.
\:\X1384:Finish an alignment in a display\X
\U988.
\:\X1377:Finish displayed math\X
\U1372.
\:\X839:Finish issuing a diagnostic message for an overfull or underfull hbox\X
\U823.
\:\X851:Finish issuing a diagnostic message for an overfull or underfull vbox\X
\U844.
\:\X373:Finish line, emit a \.{\\par}\X
\U369.
\:\X370:Finish line, emit a space\X
\U369.
\:\X372:Finish line, \&{goto} \\{switch}\X
\U369.
\:\X1374:Finish math in text\X
\U1372.
\:\X759:Finish shipping\X
\U751.
\:\X760:Finish stream of page/form contents\X
\U759.
\:\X794:Finish the PDF file\X
\U1513.
\:\X670:Finish the \.{DVI} file\X
\U1513.
\:\X1626:Finish the extensions\X
\U1513.
\:\X1735:Finish the natural width computation\X
\U1324.
\:\X1729:Finish the reversed hlist segment and \&{goto} \\{done}\X
\U1728.
\:\X1715:Finish \\{hlist\_out} for mixed direction typesetting\X
\Us647\ET729.
\:\X1202:Fire up the user's output routine and \&{return}\X
\U1189.
\:\X456:Fix the reference count, if any, and negate \\{cur\_val} if %
\\{negative}\X
\U439.
\:\X765:Flush PDF mark lists\X
\U759.
\:\X764:Flush resource lists\X
\U759.
\:\X667:Flush the box from memory, showing statistics if requested\X
\Us666\ET750.
\:\X1743:Flush the prototype box\X
\U1377.
\:\X783:Flush \\{pdf\_start\_link\_node}'s created by \\{append\_link}\X
\U782.
\:\X1226, 1276, 1289, 1322:Forbidden cases detected in \\{main\_control}\X
\U1223.
\:\X768:Generate ProcSet if desired\X
\U762.
\:\X767:Generate XObject resources\X
\U762.
\:\X637:Generate a \\{down} or \\{right} command for \|w and \&{return}\X
\U634.
\:\X636:Generate a \\{y0} or \\{z0} command in order to reuse a previous
appearance of~\|w\X
\U634.
\:\X1649, 1657, 1663, 1666, 1669, 1672, 1675, 1684, 1686, 1689, 1692, 1697,
1701, 1747, 1759, 1762, 1770, 1778, 1801, 1805, 1809, 1861, 1864:Generate all %
\eTeX\ primitives\X
\U1648.
\:\X771:Generate array of annotations or beads in page\X
\U769.
\:\X766:Generate font resources\X
\U762.
\:\X770:Generate parent pages object\X
\U769.
\:\X1129:Get ready to compress the trie\X
\U1143.
\:\X992, 1003, 1010, 1024:Get ready to start line breaking\X
\U991.
\:\X1517:Get the first line of input and prepare to start\X
\U1512.
\:\X432:Get the next non-blank non-call token\X
\Us431, 467, 481, 529, 552, 604, 1223, 1769, 1784\ETs1785.
\:\X430:Get the next non-blank non-relax non-call token\X
\Us429, 1256, 1262, 1329, 1338, 1389, 1404\ETs1448.
\:\X467:Get the next non-blank non-sign token; set \\{negative} appropriately\X
\Us466, 474\ETs487.
\:\X380:Get the next token, suppressing expansion\X
\U379.
\:\X83:Get user's advice and \&{return}\X
\U82.
\:\X1208:Give diagnostic information, if requested\X
\U1207.
\:\X1113:Give improper \.{\\hyphenation} error\X
\U1112.
\:\X13, 20, 26, 30, 32, 39, 50, 54, 73, 76, 79, 96, 104, 110, 117, 133, 134,
135, 136, 142, 183, 191, 199, 231, 264, 271, 274, 275, 293, 308, 319, 323, 326,
327, 330, 331, 332, 355, 383, 389, 408, 413, 414, 436, 464, 473, 506, 515, 519,
538, 539, 546, 553, 558, 565, 575, 576, 581, 619, 622, 632, 643, 676, 680, 687,
691, 696, 701, 704, 708, 710, 723, 774, 811, 818, 819, 821, 829, 837, 860, 895,
900, 940, 946, 990, 997, 999, 1001, 1004, 1009, 1015, 1023, 1048, 1069, 1077,
1082, 1084, 1098, 1103, 1120, 1124, 1127, 1148, 1157, 1159, 1166, 1209, 1252,
1444, 1459, 1477, 1483, 1511, 1522, 1525, 1543, 1547, 1550, 1557, 1559, 1570,
1583, 1628, 1633, 1640, 1652, 1660, 1705, 1750, 1773, 1814, 1816, 1835, 1842,
1858, 1859:Global variables\X
\U4.
\:\X1323:Go into display math mode\X
\U1316.
\:\X1317:Go into ordinary math mode\X
\Us1316\ET1320.
\:\X977:Go through the preamble list, determining the column widths and
changing the alignrecords to dummy unset boxes\X
\U976.
\:\X144:Grow more variable-size memory and \&{goto} \\{restart}\X
\U143.
\:\X1761:Handle \.{\\readline} and \&{goto} \\{done}\X
\U509.
\:\X1688:Handle \.{\\unexpanded} or \.{\\detokenize} and \&{return}\X
\U491.
\:\X1699:Handle a glue node for mixed direction typesetting\X
\Us653, 735\ETs1726.
\:\X1716:Handle a math node in \\{hlist\_out}\X
\Us650\ET732.
\:\X121:Handle non-positive logarithm\X
\U119.
\:\X1863:Handle saved items and \&{goto} \\{done}\X
\U1288.
\:\X369:Handle situations involving spaces, braces, changes of state\X
\U366.
\:\X1011:If a line number class has ended, create new active nodes for the best
feasible breaks in that class; then \&{return} if $\|r=\\{last\_active}$,
otherwise compute the new \\{line\_width}\X
\U1005.
\:\X1132:If all characters of the family fit relative to \|h, then \&{goto} %
\\{found},\30\ otherwise \&{goto} \\{not\_found}\X
\U1130.
\:\X364:If an alignment entry has just ended, take appropriate action\X
\U363.
\:\X377:If an expanded code is present, reduce it and \&{goto} \\{start\_cs}\X
\Us376\ET378.
\:\X1482:If dumping is not allowed, abort\X
\U1480.
\:\X929:If instruction \\{cur\_i} is a kern with \\{cur\_c}, attach the kern
after~\|q; or if it is a ligature with \\{cur\_c}, combine noads \|q and~\|p
appropriately; then \&{return} if the cursor has moved past a noad, or \&{goto}
\\{restart}\X
\U928.
\:\X1079:If no hyphens were found, \&{return}\X
\U1072.
\:\X1044:If node \\{cur\_p} is a legal breakpoint, call \\{try\_break}; then
update the active widths by including the glue in $\\{glue\_ptr}(\\{cur\_p})$\X
\U1042.
\:\X1149:If node \|p is a legal breakpoint, check if this break is the best
known, and \&{goto} \\{done} if \|p is null or if the page-so-far is already
too full to accept more stuff\X
\U1147.
\:\X937:If node \|q is a style node, change the style and \&{goto} \\{delete%
\_q}; otherwise if it is not a noad, put it into the hlist, advance \|q, and %
\&{goto} \\{done}; otherwise set \|s to the size of noad \|q, set \|t to the
associated type ($\\{ord\_noad}\to\\{inner\_noad}$), and set \\{pen} to the
associated penalty\X
\U936.
\:\X1008:If node \|r is of type \\{delta\_node}, update \\{cur\_active\_width},
set \\{prev\_r} and \\{prev\_prev\_r}, then \&{goto} \\{continue}\X
\U1005.
\:\X1258:If the current list ends with a box node, delete it from the list and
make \\{cur\_box} point to it; otherwise set $\\{cur\_box}\K\\{null}$\X
\U1257.
\:\X1177:If the current page is empty and node \|p is to be deleted, \&{goto} %
\\{done1}; otherwise use node \|p to update the state of the current page; if
this node is an insertion, \&{goto} \\{contribute}; otherwise if this node is
not a legal breakpoint, \&{goto} \\{contribute} or \\{update\_heights};
otherwise set \\{pi} to the penalty associated with this breakpoint\X
\U1174.
\:\X1213:If the cursor is immediately followed by the right boundary, \&{goto} %
\\{reswitch}; if it's followed by an invalid character, \&{goto} \\{big%
\_switch}; otherwise move the cursor one step to the right and \&{goto} \\{main%
\_lig\_loop}\X
\U1211.
\:\X502:If the next character is a parameter number, make \\{cur\_tok} a %
\\{match} token; but if it is a left brace, store `\\{left\_brace}, \\{end%
\_match}', set \\{hash\_brace}, and \&{goto} \\{done}\X
\U500.
\:\X968:If the preamble list has been traversed, check that the row has ended\X
\U967.
\:\X1405:If the right-hand side is a token parameter or token register, finish
the assignment and \&{goto} \\{done}\X
\U1404.
\:\X1108:If the string $\\{hyph\_word}[\|h]$ is less than \(hc)$\\{hc}[1\to%
\\{hn}]$, \&{goto} \\{not\_found}; but if the two strings are equal, set %
\\{hyf} to the hyphen positions and \&{goto} \\{found}\X
\U1107.
\:\X1118:If the string $\\{hyph\_word}[\|h]$ is less than \(or)or equal to \|s,
interchange $(\\{hyph\_word}[\|h],\\{hyph\_list}[\|h])$ with $(\|s,\|p)$\X
\U1117.
\:\X1086:If there's a ligature or kern at the cursor position, update the data
structures, possibly advancing~\|j; continue until the cursor moves\X
\U1083.
\:\X1216:If there's a ligature/kern command relevant to \\{cur\_l} and \\{cur%
\_r}, adjust the text appropriately; exit to \\{main\_loop\_wrapup}\X
\U1211.
\:\X1438:If this font has already been loaded, set \|f to the internal font
number and \&{goto} \\{common\_ending}\X
\U1435.
\:\X374:If this \\{sup\_mark} starts an expanded character like~\.{\^\^A} or~%
\.{\^\^df}, then \&{goto} \\{reswitch}, otherwise set $\\{state}\K\\{mid%
\_line}$\X
\U366.
\:\X1217:If \\{tmp\_k1} is not null then append that kern\X
\Us1211\ET1216.
\:\X1361:Ignore the fraction operation and complain about this ambiguous case\X
\U1359.
\:\X1533:Implement \.{\\closeout}\X
\U1528.
\:\X1623:Implement \.{\\immediate}\X
\U1528.
\:\X1531:Implement \.{\\openout}\X
\U1528.
\:\X1558:Implement \.{\\pdfannot}\X
\U1528.
\:\X1579:Implement \.{\\pdfcatalog}\X
\U1528.
\:\X1539:Implement \.{\\pdfcolorstack}\X
\U1528.
\:\X1565:Implement \.{\\pdfdest}\X
\U1528.
\:\X1561:Implement \.{\\pdfendlink}\X
\U1528.
\:\X1569:Implement \.{\\pdfendthread}\X
\U1528.
\:\X1596:Implement \.{\\pdffakespace}\X
\U1528.
\:\X1589:Implement \.{\\pdffontattr}\X
\U1528.
\:\X1535:Implement \.{\\pdffontexpand}\X
\U1528.
\:\X1592:Implement \.{\\pdfglyphtounicode}\X
\U1528.
\:\X1588:Implement \.{\\pdfincludechars}\X
\U1528.
\:\X1578:Implement \.{\\pdfinfo}\X
\U1528.
\:\X1595:Implement \.{\\pdfinterwordspaceoff}\X
\U1528.
\:\X1594:Implement \.{\\pdfinterwordspaceon}\X
\U1528.
\:\X1538:Implement \.{\\pdfliteral}\X
\U1528.
\:\X1590:Implement \.{\\pdfmapfile}\X
\U1528.
\:\X1591:Implement \.{\\pdfmapline}\X
\U1528.
\:\X1580:Implement \.{\\pdfnames}\X
\U1528.
\:\X1593:Implement \.{\\pdfnobuiltintounicode}\X
\U1528.
\:\X1544:Implement \.{\\pdfobj}\X
\U1528.
\:\X1563:Implement \.{\\pdfoutline}\X
\U1528.
\:\X394:Implement \.{\\pdfprimitive}\X
\U391.
\:\X1546:Implement \.{\\pdfrefobj}\X
\U1528.
\:\X1549:Implement \.{\\pdfrefxform}\X
\U1528.
\:\X1554:Implement \.{\\pdfrefximage}\X
\U1528.
\:\X1586:Implement \.{\\pdfresettimer}\X
\U1528.
\:\X1542:Implement \.{\\pdfrestore}\X
\U1528.
\:\X1597:Implement \.{\\pdfrunninglinkoff}\X
\U1528.
\:\X1598:Implement \.{\\pdfrunninglinkon}\X
\U1528.
\:\X1576:Implement \.{\\pdfsavepos}\X
\U1528.
\:\X1541:Implement \.{\\pdfsave}\X
\U1528.
\:\X1540:Implement \.{\\pdfsetmatrix}\X
\U1528.
\:\X1585:Implement \.{\\pdfsetrandomseed}\X
\U1528.
\:\X1572:Implement \.{\\pdfsnaprefpoint}\X
\U1528.
\:\X1575:Implement \.{\\pdfsnapycomp}\X
\U1528.
\:\X1574:Implement \.{\\pdfsnapy}\X
\U1528.
\:\X1599:Implement \.{\\pdfspacefont}\X
\U1528.
\:\X1560:Implement \.{\\pdfstartlink}\X
\U1528.
\:\X1568:Implement \.{\\pdfstartthread}\X
\U1528.
\:\X1567:Implement \.{\\pdfthread}\X
\U1528.
\:\X1582:Implement \.{\\pdftrailerid}\X
\U1528.
\:\X1581:Implement \.{\\pdftrailer}\X
\U1528.
\:\X1548:Implement \.{\\pdfxform}\X
\U1528.
\:\X1553:Implement \.{\\pdfximage}\X
\U1528.
\:\X1625:Implement \.{\\setlanguage}\X
\U1528.
\:\X1534:Implement \.{\\special}\X
\U1528.
\:\X1532:Implement \.{\\write}\X
\U1528.
\:\X1606:Incorporate a whatsit node into a vbox\X
\U845.
\:\X1607:Incorporate a whatsit node into an hbox\X
\U825.
\:\X827:Incorporate box dimensions into the dimensions of the hbox that will
contain~it\X
\U825.
\:\X846:Incorporate box dimensions into the dimensions of the vbox that will
contain~it\X
\U845.
\:\X828:Incorporate character dimensions into the dimensions of the hbox that
will contain~it, then move to the next node\X
\U825.
\:\X832:Incorporate glue into the horizontal totals\X
\U825.
\:\X847:Incorporate glue into the vertical totals\X
\U845.
\:\X607:Increase the number of parameters in the last font\X
\U605.
\:\X120:Increase \|k until \|x can be multiplied by a factor of $2^{-k}$, and
adjust $y$ accordingly\X
\U119.
\:\X1845:Initialize additional fields of the first active node\X
\U1040.
\:\X1068:Initialize for hyphenating a paragraph\X
\U1039.
\:\X182, 240, 246, 250, 258, 268, 277, 578, 672, 1064, 1123, 1128, 1394, 1479,
1616, 1653, 1818, 1854:Initialize table entries (done by \.{INITEX} only)\X
\U8.
\:\X1710:Initialize the LR stack\X
\Us823, 1714\ETs1734.
\:\X1178:Initialize the current page, insert the \.{\\topskip} glue ahead of %
\|p, and \&{goto} \\{continue}\X
\U1177.
\:\X353:Initialize the input routines\X
\U1517.
\:\X55, 61, 554, 559:Initialize the output routines\X
\U1512.
\:\X75:Initialize the print \\{selector} based on \\{interaction}\X
\Us1443\ET1517.
\:\X966, 973, 996, 1158, 1165:Initialize the special list heads and constant
nodes\X
\U182.
\:\X752:Initialize variables as \\{pdf\_ship\_out} begins\X
\U751.
\:\X645:Initialize variables as \\{ship\_out} begins\X
\U668.
\:\X792:Initialize variables for \.{PDF} output\X
\U750.
\:\X1812:Initialize variables for \eTeX\ compatibility mode\X
\Us1653\ET1655.
\:\X1813:Initialize variables for \eTeX\ extended mode\X
\Us1648\ET1655.
\:\X8:Initialize whatever \TeX\ might access\X
\U4.
\:\X1714:Initialize \\{hlist\_out} for mixed direction typesetting\X
\Us647\ET729.
\:\X1755:Initiate input from new pseudo file\X
\U1753.
\:\X404:Initiate or terminate input from a file\X
\U391.
\:\X1261:Initiate the construction of an hbox or vbox, then \&{return}\X
\U1257.
\:\X509:Input and store tokens from the next line of the file\X
\U508.
\:\X510:Input for \.{\\read} from the terminal\X
\U509.
\:\X365:Input from external file, \&{goto} \\{restart} if no input found\X
\U363.
\:\X379:Input from token list, \&{goto} \\{restart} if end of list or if a
parameter needs to be expanded\X
\U363.
\:\X511:Input the first line of $\\{read\_file}[\|m]$\X
\U509.
\:\X512:Input the next line of $\\{read\_file}[\|m]$\X
\U509.
\:\X1707:Insert LR nodes at the beginning of the current line and adjust the LR
stack based on LR nodes in this line\X
\U1056.
\:\X1709:Insert LR nodes at the end of the current line\X
\U1056.
\:\X1019:Insert a delta node to prepare for breaks at \\{cur\_p}\X
\U1012.
\:\X1020:Insert a delta node to prepare for the next active node\X
\U1012.
\:\X1355:Insert a dummy noad to be sub/superscripted\X
\U1354.
\:\X1021:Insert a new active node from $\\{best\_place}[\\{fit\_class}]$ to %
\\{cur\_p}\X
\U1012.
\:\X279:Insert a new control sequence after \|p, then make \|p point to it\X
\U278.
\:\X1140:Insert a new pattern into the linked trie\X
\U1138.
\:\X282:Insert a new primitive after \|p, then make \|p point to it\X
\U281.
\:\X1141:Insert a new trie node between \|q and \|p, and make \|p point to it\X
\Us1140, 1855\ETs1856.
\:\X401:Insert a token containing \\{frozen\_endv}\X
\U388.
\:\X1447:Insert a token saved by \.{\\afterassignment}, if any\X
\U1389.
\:\X1146:Insert glue for \\{split\_top\_skip} and set~$\|p\K\\{null}$\X
\U1145.
\:\X1109:Insert hyphens as specified in $\\{hyph\_list}[\|h]$\X
\U1108.
\:\X381:Insert macro parameter and \&{goto} \\{restart}\X
\U379.
\:\X412:Insert the \(a)appropriate mark text into the scanner\X
\U391.
\:\X988:Insert the \(c)current list into its environment\X
\U976.
\:\X1117:Insert the \(p)pair $(\|s,\|p)$ into the exception table\X
\U1116.
\:\X965:Insert the \(v)\<v_j> template and \&{goto} \\{restart}\X
\U364.
\:\X348:Insert token \|p into \TeX's input\X
\U304.
\:\X84:Interpret code \|c and \&{return} if done\X
\U83.
\:\X87:Introduce new material from the terminal and \&{return}\X
\U84.
\:\X606:Issue an error message if $\\{cur\_val}=\\{fmem\_ptr}$\X
\U605.
\:\X1056:Justify the line ending at breakpoint \\{cur\_p}, and append it to the
current vertical list, together with associated penalties and other insertions\X
\U1053.
\:\X6:Labels in the outer block\X
\U4.
\:\X1513, 1515, 1516, 1518:Last-minute procedures\X
\U1510.
\:\X969:Lengthen the preamble periodically\X
\U968.
\:\X655:Let \\{cur\_h} be the position of the first box, and set $\\{leader%
\_wd}+\\{lx}$ to the spacing between corresponding parts of boxes\X
\Us654\ET736.
\:\X664:Let \\{cur\_v} be the position of the first box, and set $\\{leader%
\_ht}+\\{lx}$ to the spacing between corresponding parts of boxes\X
\Us663\ET745.
\:\X1325:Let \|d be the natural width of node \|p; if the node is ``visible,'' %
\&{goto} \\{found}; if the node is glue that stretches or shrinks, set $\|v\K%
\\{max\_dimen}$\X
\U1324.
\:\X1326:Let \|d be the natural width of this glue; if stretching or shrinking,
set $\|v\K\\{max\_dimen}$; \&{goto} \\{found} in the case of leaders\X
\U1325.
\:\X1608:Let \|d be the width of the whatsit \|p\X
\U1325.
\:\X1740:Let \|j be the prototype box for the display\X
\U1734.
\:\X1411:Let \|n be the largest legal code value, based on \\{cur\_chr}\X
\U1410.
\:\X1175:Link node \|p into the current page and \&{goto} \\{done}\X
\U1174.
\:\X476:Local variables for dimension calculations\X
\U474.
\:\X1376, 1741:Local variables for finishing a displayed formula\X
\U1372.
\:\X337:Local variables for formatting calculations\X
\U333.
\:\X1078, 1089, 1099, 1106:Local variables for hyphenation\X
\U1072.
\:\X19, 181, 1104:Local variables for initialization\X
\U4.
\:\X1038, 1070:Local variables for line breaking\X
\U991.
\:\X1215:Look ahead for another character, or leave \\{lig\_stack} empty if
there's none there\X
\U1211.
\:\X1156:Look at all the marks in nodes before the break, and set the final
link to \\{null} at the break\X
\U1154.
\:\X884:Look at the list of characters starting with \|x in font \|g; set \|f
and \|c whenever a better character is found; \&{goto} \\{found} as soon as a
large enough variant is encountered\X
\U883.
\:\X638:Look at the other stack entries until deciding what sort of \.{DVI}
command to generate; \&{goto} \\{found} if node \|p is a ``hit''\X
\U634.
\:\X883:Look at the variants of $(\|z,\|x)$; set \|f and \|c whenever a better
character is found; \&{goto} \\{found} as soon as a large enough variant is
encountered\X
\U882.
\:\X505:Look for parameter number or \.{\#\#}\X
\U503.
\:\X1107:Look for the word $\\{hc}[1\to\\{hn}]$ in the exception table, and %
\&{goto} \\{found} (with \\{hyf} containing the hyphens) if an entry is found\X
\U1100.
\:\X1768:Look up the characters of list \|n in the hash table, and set \\{cur%
\_cs}\X
\U1767.
\:\X400:Look up the characters of list \|r in the hash table, and set \\{cur%
\_cs}\X
\U398.
\:\X223:Make a copy of node \|p in node \|r\X
\U222.
\:\X1212:Make a ligature node, if \\{ligature\_present}; insert a null
discretionary, if appropriate\X
\U1211.
\:\X1604:Make a partial copy of the whatsit node \|p and make \|r point to it;
set \\{words} to the number of initial words not yet copied\X
\Us224\ET1733.
\:\X936:Make a second pass over the mlist, removing all noads and inserting the
proper spacing and penalties\X
\U902.
\:\X603:Make final adjustments and \&{goto} \\{done}\X
\U588.
\:\X826:Make node \|p look like a \\{char\_node} and \&{goto} \\{reswitch}\X
\Us650, 732, 825\ETs1325.
\:\X1790:Make sure that \|f is in the proper range\X
\U1783.
\:\X1180:Make sure that \\{page\_max\_depth} is not exceeded\X
\U1174.
\:\X1007:Make sure that \\{pi} is in the proper range\X
\U1005.
\:\X1172:Make the contribution list empty by setting its tail to \\{contrib%
\_head}\X
\U1171.
\:\X48:Make the first 256 strings\X
\U47.
\:\X915:Make the height of box \|y equal to \|h\X
\U914.
\:\X982:Make the running dimensions in rule \|q extend to the boundaries of the
alignment\X
\U981.
\:\X987:Make the unset node \|r into a \\{vlist\_node} of height \|w, setting
the glue as if the height were \|t\X
\U984.
\:\X986:Make the unset node \|r into an \\{hlist\_node} of width \|w, setting
the glue as if the width were \|t\X
\U984.
\:\X886:Make variable \|b point to a box for $(\|f,\|c)$\X
\U882.
\:\X398:Manufacture a control sequence name\X
\U391.
\:\X1224:Math-only cases in non-math modes, or vice versa\X
\U1223.
\:\X979:Merge the widths in the span nodes of \|q with those of \|p, destroying
the span nodes of \|q\X
\U977.
\:\X1057:Modify the end of the line to reflect the nature of the break and to
include \.{\\rightskip}; also set the proper value of \\{disc\_break}\X
\U1056.
\:\X1222:Modify the glue specification in \\{main\_p} according to the space
factor\X
\U1221.
\:\X662:Move down or output leaders\X
\U659.
\:\X1638:Move down without outputting leaders\X
\U1637.
\:\X1174:Move node \|p to the current page; if it is time for a page break, put
the nodes following the break back onto the contribution list, and \&{return}
to the user's output routine if there is one\X
\U1171.
\:\X1724:Move node \|p to the new list and go to the next node; or \&{goto} %
\\{done} if the end of the reflected segment has been reached\X
\U1723.
\:\X1095:Move pointer \|s to the end of the current list, and set $\\{replace%
\_count}(\|r)$ appropriately\X
\U1091.
\:\X653:Move right or output leaders\X
\U650.
\:\X1075:Move the characters of a ligature node to \\{hu} and \\{hc}; but %
\&{goto} \\{done3} if they are not all letters\X
\U1074.
\:\X1214:Move the cursor past a pseudo-ligature, then \&{goto} \\{main\_loop%
\_lookahead} or \\{main\_lig\_loop}\X
\U1211.
\:\X1135:Move the data into \\{trie}\X
\U1143.
\:\X1725:Move the non-\\{char\_node} \|p to the new list\X
\U1724.
\:\X382:Move to next line of file, or \&{goto} \\{restart} if there is no next
line, or \&{return} if a \.{\\read} line has finished\X
\U365.
\:\X1765:Negate a boolean conditional and \&{goto} \\{reswitch}\X
\U391.
\:\X457:Negate all three glue components of \\{cur\_val}\X
\Us456\ET1780.
\:\X978:Nullify $\\{width}(\|q)$ and the tabskip glue following this column\X
\U977.
\:\X1519:Numbered cases for \\{debug\_help}\X
\U1518.
\:\X589:Open \\{tfm\_file} for input\X
\U588.
\:\X713:Open \\{vf\_file}, return if not found\X
\U712.
\:\X1006, 1844:Other local variables for \\{try\_break}\X
\U1005.
\:\X789:Output PDF outline entries\X
\U788.
\:\X1647:Output a Form node in a hlist\X
\U1645.
\:\X1644:Output a Form node in a vlist\X
\U1639.
\:\X1646:Output a Image node in a hlist\X
\U1645.
\:\X1643:Output a Image node in a vlist\X
\U1639.
\:\X660:Output a box in a vlist\X
\U659.
\:\X651:Output a box in an hlist\X
\U650.
\:\X656:Output a leader box at \\{cur\_h}, then advance \\{cur\_h} by $%
\\{leader\_wd}+\\{lx}$\X
\U654.
\:\X665:Output a leader box at \\{cur\_v}, then advance \\{cur\_v} by $%
\\{leader\_ht}+\\{lx}$\X
\U663.
\:\X661:Output a rule in a vlist, \&{goto} \\{next\_p}\X
\U659.
\:\X652:Output a rule in an hlist\X
\U650.
\:\X790:Output article threads\X
\U794.
\:\X801:Output fonts definition\X
\U794.
\:\X663:Output leaders in a vlist, \&{goto} \\{fin\_rule} if a rule or to %
\\{next\_p} if done\X
\U662.
\:\X654:Output leaders in an hlist, \&{goto} \\{fin\_rule} if a rule or to %
\\{next\_p} if done\X
\U653.
\:\X804:Output name tree\X
\U794.
\:\X648:Output node \|p for \\{hlist\_out} and move to the next node,
maintaining the condition $\\{cur\_v}=\\{base\_line}$\X
\U647.
\:\X731:Output node \|p for \\{pdf\_hlist\_out} and move to the next node,
maintaining the condition $\\{cur\_v}=\\{base\_line}$\X
\U729.
\:\X740:Output node \|p for \\{pdf\_vlist\_out} and move to the next node,
maintaining the condition $\\{cur\_h}=\\{left\_edge}$\X
\U738.
\:\X658:Output node \|p for \\{vlist\_out} and move to the next node,
maintaining the condition $\\{cur\_h}=\\{left\_edge}$\X
\U657.
\:\X788:Output outlines\X
\U794.
\:\X802:Output pages tree\X
\U794.
\:\X1514:Output statistics about this job\X
\U1513.
\:\X806:Output the catalog object\X
\U794.
\:\X814:Output the cross-reference stream dictionary\X
\U794.
\:\X803:Output the current Pages object in this level\X
\U802.
\:\X805:Output the current node in this level\X
\U804.
\:\X671:Output the font definitions for all fonts that were used\X
\U670.
\:\X630:Output the font name whose internal number is \|f\X
\U629.
\:\X650:Output the non-\\{char\_node} \|p for \\{hlist\_out} and move to the
next node\X
\U648.
\:\X732:Output the non-\\{char\_node} \|p for \\{pdf\_hlist\_out} and move to
the next node\X
\U731.
\:\X741:Output the non-\\{char\_node} \|p for \\{pdf\_vlist\_out}\X
\U740.
\:\X659:Output the non-\\{char\_node} \|p for \\{vlist\_out}\X
\U658.
\:\X815:Output the trailer\X
\U794.
\:\X1613:Output the whatsit node \|p in a vlist\X
\U659.
\:\X1614:Output the whatsit node \|p in an hlist\X
\U650.
\:\X1645:Output the whatsit node \|p in \\{pdf\_hlist\_out}\X
\U732.
\:\X1639:Output the whatsit node \|p in \\{pdf\_vlist\_out}\X
\U741.
\:\X813:Output the \\{obj\_tab}\X
\U794.
\:\X1857:Pack all stored \\{hyph\_codes}\X
\U1143.
\:\X1133:Pack the family into \\{trie} relative to \|h\X
\U1130.
\:\X972:Package an unset box for the current column and record its width\X
\U967.
\:\X1746:Package the display line\X
\U1744.
\:\X980:Package the preamble list, to determine the actual tabskip glue
amounts, and let \|p point to this prototype box\X
\U976.
\:\X1846:Perform computations for last line and \&{goto} \\{found}\X
\U1028.
\:\X1200:Perform the default output routine\X
\U1189.
\:\X1385:Pontificate about improper alignment in display\X
\U1384.
\:\X522:Pop the condition stack\X
\Us524, 526, 535\ETs536.
\:\X1789:Pop the expression stack and \&{goto} \\{found}\X
\U1783.
\:\X1195:Prepare all the boxes involved in insertions to act as queues\X
\U1191.
\:\X1734:Prepare for display after a non-empty paragraph\X
\U1324.
\:\X1732:Prepare for display after an empty paragraph\X
\U1323.
\:\X1030:Prepare to deactivate node~\|r, and \&{goto} \\{deactivate} unless
there is a reason to consider lines of text from \|r to \\{cur\_p}\X
\U1027.
\:\X1243:Prepare to insert a token that matches \\{cur\_group}, and print what
it is\X
\U1242.
\:\X1179:Prepare to move a box or rule node to the current page, then \&{goto} %
\\{contribute}\X
\U1177.
\:\X1611:Prepare to move whatsit \|p to the current page, then \&{goto} %
\\{contribute}\X
\U1177.
\:\X193:Print a short indication of the contents of node \|p\X
\Us192\ET674.
\:\X1022:Print a symbolic description of the new break node\X
\U1021.
\:\X1032:Print a symbolic description of this feasible break\X
\U1031.
\:\X1852:Print additional data in the new active node\X
\U1022.
\:\X763:Print additional resources\X
\U762.
\:\X361:Print either `\.{definition}' or `\.{use}' or `\.{preamble}' or `%
\.{text}', and insert tokens that should lead to recovery\X
\U360.
\:\X335:Print location of current line\X
\U334.
\:\X189:Print newly busy locations\X
\U185.
\:\X1461:Print string \|s as an error message\X
\U1457.
\:\X1458:Print string \|s on the terminal\X
\U1457.
\:\X809:Print the CreationDate key\X
\U807.
\:\X810:Print the ModDate key\X
\U807.
\:\X808:Print the Producer key\X
\U807.
\:\X562:Print the banner line, including the date and time\X
\U560.
\:\X89:Print the help information and \&{goto} \\{continue}\X
\U84.
\:\X1033:Print the list between \\{printed\_node} and \\{cur\_p}, then set $%
\\{printed\_node}\K\\{cur\_p}$\X
\U1032.
\:\X85:Print the menu of available options\X
\U84.
\:\X498:Print the result of command \|c\X
\U496.
\:\X339:Print two lines using the tricky pseudoprinted information\X
\U334.
\:\X336:Print type of token list\X
\U334.
\:\X375:Process an active-character control sequence and set $\\{state}\K\\{mid%
\_line}$\X
\U366.
\:\X1780:Process an expression and \&{return}\X
\U450.
\:\X903:Process node-or-noad \|q as much as possible in preparation for the
second pass of \\{mlist\_to\_hlist}, then move to the next item in the mlist\X
\U902.
\:\X715:Process the font definitions\X
\U712.
\:\X714:Process the preamble\X
\U712.
\:\X1612:Process whatsit \|p in \\{vert\_break} loop, \&{goto} \\{not\_found}\X
\U1150.
\:\X1299:Prune the current list, if necessary, until it contains only \\{char%
\_node}, \\{kern\_node}, \\{hlist\_node}, \\{vlist\_node}, \\{rule\_node}, and %
\\{ligature\_node} items; set \|n to the length of the list, and set \|q to the
list's tail\X
\U1297.
\:\X1055:Prune unwanted nodes at the beginning of the next line\X
\U1053.
\:\X340:Pseudoprint the line\X
\U334.
\:\X341:Pseudoprint the token list\X
\U334.
\:\X521:Push the condition stack\X
\U524.
\:\X1788:Push the expression stack and \&{goto} \\{restart}\X
\U1785.
\:\X244, 248, 256, 266, 287, 356, 402, 410, 437, 442, 494, 513, 517, 579, 956,
1160, 1230, 1236, 1249, 1266, 1285, 1292, 1319, 1334, 1347, 1356, 1366, 1386,
1397, 1400, 1408, 1428, 1432, 1440, 1450, 1455, 1464, 1469, 1524:Put each of %
\TeX's primitives into the hash table\X
\U1516.
\:\X90:Put help message on the transcript file\X
\U82.
\:\X1093:Put the \(c)characters $\\{hu}[\|i+1\to\,]$ into $\\{post\_break}(%
\|r)$, appending to this list and to \\{major\_tail} until synchronization has
been achieved\X
\U1091.
\:\X1092:Put the \(c)characters $\\{hu}[\|l\to\|i]$ and a hyphen into $\\{pre%
\_break}(\|r)$\X
\U1091.
\:\X924:Put the \(f)fraction into a box with its delimiters, and make $\\{new%
\_hlist}(\|q)$ point to it\X
\U919.
\:\X1063:Put the \(l)\.{\\leftskip} glue at the left and detach this line\X
\U1056.
\:\X1191:Put the \(o)optimal current page into box 255, update \\{first\_mark}
and \\{bot\_mark}, append insertions to their boxes, and put the remaining
nodes back on the contribution list\X
\U1189.
\:\X1437:Put the \(p)(positive) `at' size into \|s\X
\U1436.
\:\X1062:Put the \(r)\.{\\rightskip} glue after node \|q\X
\U1057.
\:\X588:Read and check the font data; \\{abort} if the \.{TFM} file is
malformed; if there's no room for this font, say so and \&{goto} \\{done};
otherwise $\\{incr}(\\{font\_ptr})$ and \&{goto} \\{done}\X
\U586.
\:\X598:Read box dimensions\X
\U588.
\:\X595:Read character data\X
\U588.
\:\X601:Read extensible character recipes\X
\U588.
\:\X602:Read font parameters\X
\U588.
\:\X600:Read ligature/kern program\X
\U588.
\:\X384:Read next line of file into \\{buffer}, or \&{goto} \\{restart} if the
file has ended\X
\U382.
\:\X52:Read one string, but return \\{false} if the string memory space is
getting too tight for comfort\X
\U51.
\:\X564:Read the first line of the new file\X
\U563.
\:\X51:Read the other strings from the \.{TEX.POOL} file and return \\{true},
or give an error message and return \\{false}\X
\U47.
\:\X594:Read the {\.{TFM}} header\X
\U588.
\:\X591:Read the {\.{TFM}} size fields\X
\U588.
\:\X1265:Readjust the height and depth of \\{cur\_box}, for \.{\\vtop}\X
\U1264.
\:\X1090:Reconstitute nodes for the hyphenated word, inserting discretionary
hyphens\X
\U1080.
\:\X1031:Record a new feasible break\X
\U1027.
\:\X1204:Recover from an unbalanced output routine\X
\U1203.
\:\X1619:Recover from an unbalanced write command\X
\U1618.
\:\X1176:Recycle node \|p\X
\U1174.
\:\X123:Reduce to the case that $\|a,\|c\G0$, $\|b,\|d>0$\X
\U122.
\:\X115:Reduce to the case that $\|f\G0$ and $\|q>0$\X
\U114.
\:\X1259:Remove the last box, unless it's part of a discretionary\X
\U1258.
\:\X1080:Replace nodes $\\{ha}\to\\{hb}$ by a sequence of nodes that includes
the discretionary hyphens\X
\U1072.
\:\X1365:Replace the tail of the list by \|p\X
\U1364.
\:\X599:Replace \|z by $\|z^\prime$ and compute $\alpha,\beta$\X
\U598.
\:\X1713:Report LR problems\X
\Us1712\ET1730.
\:\X422:Report a runaway argument and abort\X
\Us418\ET425.
\:\X843:Report a tight hbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X
\U840.
\:\X854:Report a tight vbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X
\U852.
\:\X421:Report an extra right brace and \&{goto} \\{continue}\X
\U418.
\:\X424:Report an improper use of the macro and abort\X
\U423.
\:\X842:Report an overfull hbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X
\U840.
\:\X853:Report an overfull vbox and \&{goto} \\{common\_ending}, if this box is
sufficiently bad\X
\U852.
\:\X836:Report an underfull hbox and \&{goto} \\{common\_ending}, if this box
is sufficiently bad\X
\U834.
\:\X850:Report an underfull vbox and \&{goto} \\{common\_ending}, if this box
is sufficiently bad\X
\U849.
\:\X35:Report overflow of the input buffer, and abort\X
\Us31\ET1756.
\:\X1339:Report that an invalid delimiter code is being changed to null; set~$%
\\{cur\_val}\K0$\X
\U1338.
\:\X587:Report that the font won't be loaded\X
\U586.
\:\X486:Report that this dimension is out of range\X
\U474.
\:\X754:Reset PDF mark lists\X
\U752.
\:\X753:Reset resource lists\X
\Us752\ET775.
\:\X395:Reset \\{cur\_tok} for unexpandable primitives, goto restart\X
\Us439\ET466.
\:\X777:Restore resource lists\X
\U775.
\:\X1203:Resume the page builder after an output routine has come to an end\X
\U1278.
\:\X1742:Retrieve the prototype box\X
\Us1372\ET1372.
\:\X1722:Reverse an hlist segment and \&{goto} \\{reswitch}\X
\U1717.
\:\X1721:Reverse the complete hlist and set the subtype to \\{reversed}\X
\U1714.
\:\X800:Reverse the linked list of Page and Pages objects\X
\U794.
\:\X1054:Reverse the links of the relevant passive nodes, setting \\{cur\_p} to
the first breakpoint\X
\U1053.
\:\X1621:Save current position in DVI mode\X
\U1620.
\:\X1641:Save current position to \\{pdf\_last\_x\_pos}, \\{pdf\_last\_y\_pos}\X
\Us1639\ET1645.
\:\X1642:Save current position to \\{pdf\_snapx\_refpos}, \\{pdf\_snapy%
\_refpos}\X
\Us1639\ET1645.
\:\X776:Save resource lists\X
\U775.
\:\X376:Scan a control sequence and set $\\{state}\K\\{skip\_blanks}$ or \\{mid%
\_line}\X
\U366.
\:\X1785:Scan a factor \|f of type \|o or start a subexpression\X
\U1783.
\:\X470:Scan a numeric constant\X
\U466.
\:\X418:Scan a parameter until its delimiter string has been found; or, if $%
\|s=\\{null}$, simply scan the delimiter string\X
\U417.
\:\X1331:Scan a subformula enclosed in braces and \&{return}\X
\U1329.
\:\X378:Scan ahead in the buffer until finding a nonletter; if an expanded code
is encountered, reduce it and \&{goto} \\{start\_cs}; otherwise if a
multiletter control sequence is found, adjust \\{cur\_cs} and \\{loc}, and %
\&{goto} \\{found}\X
\U376.
\:\X468:Scan an alphabetic character code into \\{cur\_val}\X
\U466.
\:\X469:Scan an optional space\X
\Us468, 474, 481, 705, 1378, 1544, 1556, 1556, 1558\ETs1565.
\:\X503:Scan and build the body of the token list; \&{goto} \\{found} when
finished\X
\U499.
\:\X500:Scan and build the parameter part of the macro definition\X
\U499.
\:\X1783:Scan and evaluate an expression \|e of type \|l\X
\U1782.
\:\X478:Scan decimal fraction\X
\U474.
\:\X557:Scan file name in the buffer\X
\U556.
\:\X484:Scan for \(a)all other units and adjust \\{cur\_val} and \|f
accordingly; \&{goto} \\{done} in the case of scaled points\X
\U479.
\:\X480:Scan for \(f)\.{fil} units; \&{goto} \\{attach\_fraction} if found\X
\U479.
\:\X482:Scan for \(m)\.{mu} units and \&{goto} \\{attach\_fraction}\X
\U479.
\:\X481:Scan for \(u)units that are internal dimensions; \&{goto} \\{attach%
\_sign} with \\{cur\_val} set if found\X
\U479.
\:\X955:Scan preamble text until \\{cur\_cmd} is \\{tab\_mark} or \\{car\_ret},
looking for changes in the tabskip glue; append an alignrecord to the preamble
list\X
\U953.
\:\X497:Scan the argument for command \|c\X
\U496.
\:\X1436:Scan the font size specification\X
\U1435.
\:\X1784:Scan the next operator and set \|o\X
\U1783.
\:\X417:Scan the parameters and make $\\{link}(\|r)$ point to the macro body;
but \&{return} if an illegal \.{\\par} is detected\X
\U415.
\:\X953:Scan the preamble and record it in the \\{preamble} list\X
\U950.
\:\X959:Scan the template \<u_j>, putting the resulting token list in \\{hold%
\_head}\X
\U955.
\:\X960:Scan the template \<v_j>, putting the resulting token list in \\{hold%
\_head}\X
\U955.
\:\X479:Scan units and set \\{cur\_val} to $x\cdot(\\{cur\_val}+f/2^{16})$,
where there are \|x sp per unit; \&{goto} \\{attach\_sign} if the units are
internal\X
\U474.
\:\X273:Search \\{eqtb} for equivalents equal to \|p\X
\U190.
\:\X1110:Search \\{hyph\_list} for pointers to \|p\X
\U190.
\:\X307:Search \\{save\_stack} for equivalents that point to \|p\X
\U190.
\:\X535:Select the appropriate case and \&{return} or \&{goto} \\{common%
\_ending}\X
\U527.
\:\X21, 23, 24, 74, 77, 80, 97, 118, 184, 233, 272, 276, 294, 309, 390, 409,
465, 507, 516, 547, 577, 582, 620, 623, 633, 677, 681, 688, 697, 709, 711, 724,
820, 830, 838, 861, 947, 1105, 1167, 1210, 1445, 1460, 1478, 1523, 1551, 1571,
1584, 1629, 1634, 1706, 1751, 1817, 1836, 1860:Set initial values of key
variables\X
\U8.
\:\X1025:Set line length parameters in preparation for hanging indentation\X
\U1024.
\:\X981:Set the glue in all the unset boxes of the current list\X
\U976.
\:\X984:Set the glue in node \|r and change it from an unset node\X
\U983.
\:\X983:Set the unset box \|q and the unset boxes in it\X
\U981.
\:\X1029:Set the value of \|b to the badness for shrinking the line, and
compute the corresponding \\{fit\_class}\X
\U1027.
\:\X1028:Set the value of \|b to the badness for stretching the line, and
compute the corresponding \\{fit\_class}\X
\U1027.
\:\X1848:Set the value of \|b to the badness of the last line for shrinking,
compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X
\U1846.
\:\X1847:Set the value of \|b to the badness of the last line for stretching,
compute the corresponding \\{fit\_class}, and \&{goto} \\{found}\X
\U1846.
\:\X1190:Set the value of \\{output\_penalty}\X
\U1189.
\:\X1731:Set the value of \|x to the text direction before the display\X
\Us1732\ET1734.
\:\X1085:Set up data structures with the cursor following position \|j\X
\U1083.
\:\X1745:Set up the hlist for the display line\X
\U1744.
\:\X879:Set up the values of \\{cur\_size} and \\{cur\_mu}, based on \\{cur%
\_style}\X
\Us896, 902, 903, 906, 930, 936, 938\ETs939.
\:\X261:Set variable \|c to the current escape character\X
\U63.
\:\X1775:Set variable \|w to indicate if this case should be reported\X
\Us1774\ET1776.
\:\X668:Ship box \|p out\X
\U666.
\:\X241:Show equivalent \|n, in region 1 or 2\X
\U270.
\:\X247:Show equivalent \|n, in region 3\X
\U270.
\:\X251:Show equivalent \|n, in region 4\X
\U270.
\:\X260:Show equivalent \|n, in region 5\X
\U270.
\:\X269:Show equivalent \|n, in region 6\X
\U270.
\:\X237:Show the auxiliary field, \|a\X
\U236.
\:\X1681:Show the box context\X
\U1679.
\:\X1680:Show the box packaging info\X
\U1679.
\:\X1474:Show the current contents of a box\X
\U1471.
\:\X1472:Show the current meaning of a token, then \&{goto} \\{common\_ending}\X
\U1471.
\:\X1475:Show the current value of some parameter or register, then \&{goto} %
\\{common\_ending}\X
\U1471.
\:\X252:Show the font identifier in $\\{eqtb}[\|n]$\X
\U251.
\:\X253:Show the halfword code in $\\{eqtb}[\|n]$\X
\U251.
\:\X1163:Show the status of the current page\X
\U236.
\:\X427:Show the text of the macro being expanded\X
\U415.
\:\X897:Simplify a trivial box\X
\U896.
\:\X526:Skip to \.{\\else} or \.{\\fi}, then \&{goto} \\{common\_ending}\X
\U524.
\:\X1073:Skip to node \\{ha}, or \&{goto} \\{done1} if no hyphenation should be
attempted\X
\U1071.
\:\X1074:Skip to node \\{hb}, putting letters into \\{hu} and \\{hc}\X
\U1071.
\:\X150:Sort \(p)\|p into the list starting at \\{rover} and advance \|p to $%
\\{rlink}(\|p)$\X
\U149.
\:\X1122:Sort \(t)the hyphenation op tables into proper order\X
\U1129.
\:\X1260:Split off part of a vertical box, make \\{cur\_box} point to it\X
\U1257.
\:\X1379:Squeeze the equation as much as possible; if there is an equation
number that should go on a separate line by itself, set~$\|e\K0$\X
\U1377.
\:\X1168:Start a new current page\X
\Us233\ET1194.
\:\X757:Start stream of page/form contents\X
\U752.
\:\X1850:Store \(a)additional data for this feasible break\X
\U1031.
\:\X1851:Store \(a)additional data in the new active node\X
\U1021.
\:\X1255:Store \(c)\\{cur\_box} in a box register\X
\U1253.
\:\X1101:Store \(m)maximum values in the \\{hyf} table\X
\U1100.
\:\X305:Store \(s)$\\{save\_stack}[\\{save\_ptr}]$ in $\\{eqtb}[\|p]$, unless $%
\\{eqtb}[\|p]$ holds a global value\X
\U304.
\:\X1856:Store all current \\{lc\_code} values\X
\U1855.
\:\X1855:Store hyphenation codes for current language\X
\U1137.
\:\X419:Store the current token, but \&{goto} \\{continue} if it is a blank
space that would become an undelimited parameter\X
\U418.
\:\X718:Store the packet being built\X
\U717.
\:\X1014:Subtract glue from \\{break\_width}\X
\U1013.
\:\X1017:Subtract the width of node \|v from \\{break\_width}\X
\U1016.
\:\X393:Suppress expansion of the next token\X
\U391.
\:\X918:Swap the subscript and superscript into box \|x\X
\U914.
\:\X916:Switch to a larger accent if available and appropriate\X
\U914.
\:\X360:Tell the user what has run away and try to recover\X
\U358.
\:\X536:Terminate the current conditional and skip to \.{\\fi}\X
\U391.
\:\X531:Test box register status\X
\U527.
\:\X530:Test if an integer is odd\X
\U527.
\:\X532:Test if two characters match\X
\U527.
\:\X534:Test if two macro texts match\X
\U533.
\:\X533:Test if two tokens match\X
\U527.
\:\X529:Test relation between integers or dimensions\X
\U527.
\:\X584:The em width for \\{cur\_font}\X
\U481.
\:\X585:The x-height for \\{cur\_font}\X
\U481.
\:\X426:Tidy up the parameter just scanned, and tuck it away\X
\U418.
\:\X831:Transfer node \|p to the adjustment list\X
\U825.
\:\X1060:Transplant the post-break list\X
\U1058.
\:\X1061:Transplant the pre-break list\X
\U1058.
\:\X1330:Treat \\{cur\_chr} as an active character\X
\Us1329\ET1333.
\:\X1049:Try the final line break at the end of the paragraph, and \&{goto} %
\\{done} if the desired breakpoints have been found\X
\U1039.
\:\X145:Try to allocate within node \|p and its physical successors, and %
\&{goto} \\{found} if allocation was possible\X
\U143.
\:\X1045:Try to break after a discretionary fragment, then \&{goto} \\{done5}\X
\U1042.
\:\X561:Try to get a different log file name\X
\U560.
\:\X1071:Try to hyphenate the following word\X
\U1042.
\:\X1370:Try to recover from mismatched \.{\\right}\X
\U1369.
\:\X18, 25, 38, 101, 109, 131, 168, 230, 291, 322, 574, 621, 694, 707, 722,
1097, 1102, 1627, 1632, 1678:Types in the outer block\X
\U4.
\:\X1507:Undump a couple more things and the closing check word\X
\U1481.
\:\X1486:Undump constants for consistency check\X
\U1481.
\:\X1505:Undump pdftex data\X
\U1481.
\:\X1495:Undump regions 1 to 6 of \\{eqtb}\X
\U1492.
\:\X1655:Undump the \eTeX\ state\X
\U1486.
\:\X1501:Undump the array info for internal font number \|k\X
\U1499.
\:\X1490:Undump the dynamic memory\X
\U1481.
\:\X1499:Undump the font information\X
\U1481.
\:\X1497:Undump the hash table\X
\U1492.
\:\X1503:Undump the hyphenation tables\X
\U1481.
\:\X1488:Undump the string pool\X
\U1481.
\:\X1492:Undump the table of equivalents\X
\U1481.
\:\X1037:Update the active widths, since the first active node has been deleted%
\X
\U1036.
\:\X1153:Update the current height and depth measurements with respect to a
glue or kern node~\|p\X
\U1149.
\:\X1830:Update the current marks for \\{fire\_up}\X
\U1191.
\:\X1827:Update the current marks for \\{vsplit}\X
\U1156.
\:\X1181:Update the current page measurements with respect to the glue or kern
specified by node~\|p\X
\U1174.
\:\X1034:Update the value of \\{printed\_node} for symbolic displays\X
\U1005.
\:\X1193:Update the values of \\{first\_mark} and \\{bot\_mark}\X
\U1191.
\:\X1173:Update the values of \\{last\_glue}, \\{last\_penalty}, and \\{last%
\_kern}\X
\U1171.
\:\X669:Update the values of \\{max\_h} and \\{max\_v}; but if the page is too
large, \&{goto} \\{done}\X
\Us668\ET751.
\:\X974:Update width entry for spanned columns\X
\U972.
\:\X1360:Use code \|c to distinguish between generalized fractions\X
\U1359.
\:\X1150:Use node \|p to update the current height and depth measurements; if
this node is not a legal breakpoint, \&{goto} \\{not\_found} or \\{update%
\_heights}, otherwise set \\{pi} to the associated penalty at the break\X
\U1149.
\:\X592:Use size fields to allocate font information\X
\U588.
\:\X1605:Wipe out the whatsit node \|p and \&{goto} \\{done}\X
\U220.
\:\X1198:Wrap up the box specified by node \|r, splitting node \|p if called
for; set $\\{wait}\K\\{true}$ if node \|p holds a remainder after splitting\X
\U1197.
\:\X756:Write out Form stream header\X
\U752.
\:\X781:Write out PDF annotations\X
\U780.
\:\X786:Write out PDF bead rectangle specifications\X
\U780.
\:\X782:Write out PDF link annotations\X
\U780.
\:\X784:Write out PDF mark destinations\X
\U780.
\:\X769:Write out page object\X
\U759.
\:\X780:Write out pending PDF marks\X
\U759.
\:\X775:Write out pending forms\X
\U761.
\:\X779:Write out pending images\X
\U761.
\:\X773:Write out pending raw objects\X
\U761.
\:\X761:Write out resource lists\X
\U759.
\:\X762:Write out resources dictionary\X
\U759.
\con
